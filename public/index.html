<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAMPOST MANKON</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-dark: #1a365d;
            --primary-blue: #2c5282;
            --primary-light: #4299e1;
            --accent-gold: #d69e2e;
            --accent-orange: #ed8936;
            --success-green: #38a169;
            --danger-red: #e53e3e;
            --bg-cream: #faf5eb;
            --bg-white: #ffffff;
            --text-dark: #1a202c;
            --text-gray: #4a5568;
            --border-color: #e2e8f0;
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', sans-serif;
            background: linear-gradient(135deg, var(--bg-cream) 0%, #e8e0d5 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 1.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: var(--accent-gold);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .logo-text h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
        }

        .logo-text p {
            font-size: 0.65rem;
            opacity: 0.8;
        }

        .header-info {
            text-align: right;
            font-size: 0.75rem;
            flex: 1;
        }

        .db-status {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.6rem;
            margin-top: 0.1rem;
        }

        .db-status.connected {
            background: rgba(56, 161, 105, 0.3);
            color: #9ae6b4;
        }

        .db-status.disconnected {
            background: rgba(229, 62, 62, 0.3);
            color: #feb2b2;
        }

        /* User Profile Section */
        .user-profile-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
        }

        .user-profile-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-icon {
            font-size: 1.2rem;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: white;
        }

        .btn-logout {
            background: rgba(229, 62, 62, 0.8);
            color: white;
            border: none;
            padding: 0.35rem 0.7rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: var(--danger-red);
            transform: scale(1.02);
        }

        .nav {
            display: flex;
            padding: 0 0.5rem;
            flex-wrap: wrap;
            overflow-x: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 0.5rem 0.7rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.15);
            border-bottom-color: var(--accent-gold);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .card {
            background: var(--bg-white);
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.75rem 1rem;
            font-family: 'Playfair Display', serif;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .card-header.green {
            background: linear-gradient(135deg, var(--success-green) 0%, #276749 100%);
        }

        .card-header.gold {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%);
        }

        .card-header.red {
            background: linear-gradient(135deg, var(--danger-red) 0%, #c53030 100%);
        }

        .card-body {
            padding: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--bg-white);
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card.blue::before {
            background: var(--primary-blue);
        }

        .stat-card.green::before {
            background: var(--success-green);
        }

        .stat-card.red::before {
            background: var(--danger-red);
        }

        .stat-card.gold::before {
            background: var(--accent-gold);
        }

        .stat-icon {
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.1rem;
        }

        .stat-label {
            color: var(--text-gray);
            font-size: 0.65rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .form-group input:read-only {
            background: #f7fafc;
        }

        .btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green) 0%, #276749 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-red) 0%, #c53030 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--accent-orange) 0%, #c05621 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-blue);
            color: var(--primary-blue);
        }

        .btn-print {
            background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%);
            color: white;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%);
            color: white;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 400px;
        }

        th,
        td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem;
        }

        th {
            background: #f7fafc;
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        tr:hover {
            background: #f7fafc;
        }

        tr.clickable {
            cursor: pointer;
        }

        tr.clickable:hover {
            background: rgba(66, 153, 225, 0.1);
        }

        .badge {
            padding: 0.15rem 0.35rem;
            border-radius: 8px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-income {
            background: rgba(56, 161, 105, 0.15);
            color: var(--success-green);
        }

        .badge-expense {
            background: rgba(229, 62, 62, 0.15);
            color: var(--danger-red);
        }

        .badge-inheritance {
            background: rgba(214, 158, 46, 0.15);
            color: var(--accent-gold);
        }

        .badge-paid {
            background: rgba(56, 161, 105, 0.15);
            color: var(--success-green);
        }

        .badge-partial {
            background: rgba(236, 201, 75, 0.2);
            color: #b7791f;
        }

        .badge-unpaid {
            background: rgba(229, 62, 62, 0.15);
            color: var(--danger-red);
        }

        .badge-new {
            background: rgba(66, 153, 225, 0.15);
            color: var(--primary-blue);
        }

        /* Landing Page Styles */
        .landing-page {
            text-align: center;
            padding: 2rem 1rem;
        }

        .landing-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .landing-subtitle {
            color: var(--text-gray);
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .landing-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto 2rem;
        }

        @media (max-width: 1200px) {
            .landing-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
            }
        }

        @media (max-width: 900px) {
            .landing-cards {
                grid-template-columns: 1fr;
                max-width: 500px;
            }
        }

        .landing-card {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid transparent;
        }

        .landing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .landing-card.campost {
            border-color: var(--primary-blue);
        }

        .landing-card.campost:hover {
            border-color: var(--accent-gold);
        }

        .landing-card-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .landing-card-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .landing-card-desc {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 1rem;
            min-height: 40px;
        }

        .landing-card-stats {
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
            padding: 0.75rem 0;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .landing-stat {
            text-align: center;
        }

        .landing-stat-value {
            font-size: 0.95rem;
            font-weight: 700;
        }

        .landing-stat-label {
            font-size: 0.7rem;
            color: var(--text-gray);
        }

        /* Asset Tab Styles */
        .asset-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: #e2e8f0;
            color: #4a5568;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .asset-tab:hover {
            background: #cbd5e0;
        }

        .asset-tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .asset-tab.manka-tab.active {
            background: var(--success-green);
            color: white;
        }

        .asset-tab-content {
            display: none;
        }

        .asset-tab-content.active {
            display: block;
        }

        .manka-tab-content {
            display: none;
        }

        .manka-tab-content.active {
            display: block;
        }

        .asset-actions {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
        }

        .asset-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .tab-wrapper {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .tab-wrapper:hover .tab-actions {
            opacity: 1;
        }

        .tab-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .btn-tab-action {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: none;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e2e8f0;
        }

        .btn-tab-action:hover {
            background: #cbd5e0;
        }

        .btn-tab-delete {
            background: #fed7d7;
            color: #c53030;
        }

        .btn-tab-delete:hover {
            background: #fc8181;
        }

        .landing-card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .landing-card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .landing-card-desc {
            color: var(--text-gray);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .landing-card-stats {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .landing-stat {
            text-align: center;
        }

        .landing-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .landing-stat-label {
            font-size: 0.7rem;
            color: var(--text-gray);
        }

        .back-btn {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 999;
        }

        .module-header {
            display: none;
        }

        .module-header.active {
            display: block;
        }

        .amount-positive {
            color: var(--success-green);
            font-weight: 600;
        }

        .amount-negative {
            color: var(--danger-red);
            font-weight: 600;
        }

        .amount-gold {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .alert {
            padding: 0.6rem 0.9rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
        }

        .alert-success {
            background: rgba(56, 161, 105, 0.15);
            color: var(--success-green);
            border: 1px solid var(--success-green);
        }

        .alert-error {
            background: rgba(229, 62, 62, 0.15);
            color: var(--danger-red);
            border: 1px solid var(--danger-red);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 10px;
            max-width: 750px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .modal-body {
            padding: 1.25rem;
        }

        /* Login Page Styles */
        .login-container {
            display: none;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%);
        }

        .login-container.active {
            display: flex;
        }

        .login-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            overflow: hidden;
        }

        .login-header {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .login-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            margin-bottom: 0.25rem;
        }

        .login-header p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .login-body {
            padding: 1.5rem;
        }

        .login-body .form-group {
            margin-bottom: 1rem;
        }

        .login-body .form-group label {
            font-size: 0.85rem;
        }

        .login-body .form-group input {
            padding: 0.6rem;
            font-size: 0.9rem;
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .login-footer {
            text-align: center;
            padding: 1rem;
            background: #f7fafc;
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        .login-footer a {
            color: var(--primary-blue);
            cursor: pointer;
            text-decoration: underline;
        }

        .login-error {
            background: rgba(229, 62, 62, 0.15);
            color: var(--danger-red);
            padding: 0.5rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .user-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.65rem;
            margin-left: 0.5rem;
            font-weight: bold;
        }

        .user-badge.admin {
            background: rgba(214, 158, 46, 0.2);
            color: var(--accent-gold);
        }

        .user-badge.user {
            background: rgba(66, 153, 225, 0.2);
            color: var(--primary-blue);
        }

        .user-badge.guest {
            background: rgba(160, 174, 192, 0.2);
            color: #718096;
        }

        /* Role-based access control */
        .admin-only {
            display: none !important;
        }

        body.is-admin .admin-only {
            display: inline-flex !important;
        }

        .admin-only-section {
            display: none !important;
        }

        body.is-admin .admin-only-section {
            display: block !important;
        }

        .admin-only-nav {
            display: none !important;
        }

        body.is-admin .admin-only-nav {
            display: inline-block !important;
        }

        .user-restricted-notice {
            display: none;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        body:not(.is-admin) .user-restricted-notice {
            display: block;
        }

        .guest-restricted-notice {
            display: none;
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        body.is-guest .guest-restricted-notice {
            display: block;
        }

        /* Read-only mode for users */
        body.is-user .btn-success:not(.allow-user),
        body.is-user .btn-danger:not(.allow-user),
        body.is-user .btn-warning:not(.allow-user) {
            opacity: 0.5;
            pointer-events: none;
        }

        body.is-guest .btn {
            opacity: 0.5;
            pointer-events: none;
        }

        body.is-guest .btn.allow-guest {
            opacity: 1;
            pointer-events: auto;
        }

        .heir-group {
            background: #f7fafc;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .heir-group h4 {
            color: var(--primary-blue);
            margin-bottom: 0.3rem;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.3rem 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.8rem;
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: 700;
        }

        .highlight-box {
            background: linear-gradient(135deg, rgba(214, 158, 46, 0.15) 0%, rgba(237, 137, 54, 0.15) 100%);
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .highlight-box h3 {
            color: var(--accent-gold);
            font-size: 1.3rem;
        }

        .highlight-box p {
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        /* Beneficiary Selection Styles */
        .beneficiary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }

        .beneficiary-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            cursor: pointer;
        }

        .beneficiary-item:hover {
            background: #edf2f7;
        }

        .beneficiary-item.selected {
            background: #c6f6d5;
            border-color: #48bb78;
        }

        .beneficiary-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }

        .beneficiary-item label {
            cursor: pointer;
            flex: 1;
            font-size: 0.85rem;
        }

        .beneficiary-item .heir-info {
            font-size: 0.75rem;
            color: #718096;
            margin-left: auto;
        }

        .beneficiary-item .heir-portions {
            background: #4299e1;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media print {
            body {
                background: white !important;
                color: black !important;
                margin: 0;
                padding: 0;
            }

            /* Force all text inside cards to be black */
            .card,
            .card-header,
            .card-body,
            table,
            th,
            td,
            span,
            div,
            p {
                color: black !important;
                background: white !important;
                box-shadow: none !important;
            }

            /* Ensure temp page is visible */
            #print-temp-page {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 20px !important;
            }

            .sidebar,
            .header,
            .nav,
            .btn,
            .modal-overlay {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            .page:not(.printing) {
                display: none !important;
            }

            .page.printing {
                display: block !important;
            }

            .card {
                border: none !important;
                box-shadow: none !important;
                margin-bottom: 20px !important;
            }

            .card-header {
                background: #f8f9fa !important;
                color: black !important;
                border-bottom: 1px solid #ddd !important;
            }

            .table-container {
                overflow: visible !important;
            }

            table {
                font-size: 10pt !important;
                width: 100% !important;
            }

            th,
            td {
                border: 1px solid #eee !important;
            }
        }

        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                text-align: center;
            }

            .main-content {
                padding: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- ==================== MAIN APP ==================== -->
    <div id="mainApp" style="display: none;">
        <header class="header no-print">
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo-icon">NS</div>
                    <div class="logo-text">
                        <h1 id="mainTitle">CAMPOST MANKON</h1>
                        <p id="mainSubtitle">Property & Billing Management System</p>
                    </div>
                </div>
                <div class="header-info">
                    <span>B.P 36 Mankon-Bamenda | 675299868</span>
                </div>
                <!-- User Profile Section -->
                <div class="user-profile-section">
                    <div class="user-profile-info">
                        <span class="user-icon">üë§</span>
                        <span id="loggedInUser" class="user-name">User</span>
                        <span id="userRoleBadge" class="user-badge">USER</span>
                    </div>
                    <button class="btn btn-logout" onclick="doLogout()" title="Logout">
                        üö™ Logout
                    </button>
                </div>
            </div>
            <!-- Main Navigation - shown on landing page -->
            <nav class="nav" id="mainNav">
                <button class="nav-btn active" data-page="landing">üè† Home</button>
                <button class="nav-btn admin-only-nav" data-page="system-settings">‚öôÔ∏è System Settings</button>
            </nav>
            <!-- CAMPOST MANKON Navigation -->
            <nav class="nav module-header" id="campostNav">
                <button class="nav-btn" onclick="goToLanding()">üè† Home</button>
                <button class="nav-btn active" data-page="campost-dashboard">üìä Dashboard</button>
                <button class="nav-btn" data-page="campost-ledger">üìí Ledger</button>
                <button class="nav-btn" data-page="campost-expenses">üí∏ Expenses</button>
                <button class="nav-btn" data-page="campost-bills">üìÑ Bills</button>
                <button class="nav-btn" data-page="campost-payments">üíµ Payments</button>
                <button class="nav-btn" data-page="campost-receipts">üßæ Receipts</button>
                <button class="nav-btn" data-page="campost-inheritance">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Inheritance</button>
                <button class="nav-btn" data-page="campost-export">üì• Export</button>
                <button class="nav-btn" data-page="campost-settings">‚öôÔ∏è Settings</button>
            </nav>

        </header>

        <main class="main-content">
            <!-- ==================== LANDING PAGE ==================== -->
            <div id="landing" class="page active">
                <div class="landing-page">
                    <h1 class="landing-title">üè¢ CAMPOST MANKON</h1>
                    <p class="landing-subtitle">Comprehensive Property & Billing Management System</p>

                    <div class="landing-cards">
                        <!-- CAMPOST MANKON Card -->
                        <div class="landing-card campost" onclick="openModule('campost')">
                            <div class="landing-card-icon">üèõÔ∏è</div>
                            <h2 class="landing-card-title">CAMPOST MANKON</h2>
                            <p class="landing-card-desc">Manage CAMPOST property billing, payments, expenses, and
                                inheritance distribution.</p>
                            <div class="landing-card-stats">
                                <div class="landing-stat">
                                    <div class="landing-stat-value amount-positive" id="landingCampostIncome">0</div>
                                    <div class="landing-stat-label">Total Income</div>
                                </div>
                                <div class="landing-stat">
                                    <div class="landing-stat-value amount-negative" id="landingCampostExpenses">0</div>
                                    <div class="landing-stat-label">Total Expenses</div>
                                </div>
                                <div class="landing-stat">
                                    <div class="landing-stat-value amount-gold" id="landingCampostBalance">0</div>
                                    <div class="landing-stat-label">Balance</div>
                                </div>
                            </div>
                            <div class="btn-group" style="justify-content: center; margin-top: 1rem;">
                                <button class="btn btn-primary btn-lg">Enter CAMPOST MANKON ‚Üí</button>
                            </div>
                        </div>


                    </div>


                </div>
            </div>

            <!-- ==================== MAIN SETTINGS PAGE ==================== -->
            <div id="main-settings" class="page">
                <div class="card">
                    <div class="card-header gold"><span>üë§ My Account</span></div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="myUsername" readonly>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="myEmail" readonly>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <input type="text" id="myRole" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><span>üîê Change My Password</span></div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" id="changeCurrentPwd" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" id="changeNewPwd" placeholder="Enter new password">
                            </div>
                            <div class="form-group">
                                <label>Confirm New Password</label>
                                <input type="password" id="changeConfirmPwd" placeholder="Confirm new password">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="changeMyPassword()">üîê Change Password</button>
                        </div>
                    </div>
                </div>

                <!-- Admin Only: User Management -->
                <div id="adminUserManagement" style="display: none;">
                    <div class="card">
                        <div class="card-header green"><span>‚ûï Create New User</span><span
                                class="badge badge-income">ADMIN ONLY</span></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Username *</label>
                                    <input type="text" id="newUserUsername" placeholder="Enter username">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" id="newUserEmail" placeholder="Enter email address">
                                </div>
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" id="newUserFullName" placeholder="Enter full name">
                                </div>
                                <div class="form-group">
                                    <label>Role *</label>
                                    <select id="newUserRole">
                                        <option value="user">User (View Only)</option>
                                        <option value="guest">Guest (Limited Access)</option>
                                        <option value="admin">Admin (Full Access)</option>
                                    </select>
                                </div>
                            </div>
                            <p
                                style="font-size: 0.8rem; color: #718096; margin: 10px 0; background: #ebf8ff; padding: 8px; border-radius: 6px;">
                                üìå Default password for new users is <strong>1234</strong>. User must change it on first
                                login.
                            </p>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="createNewUser()">üë§ Create User</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span>üë• All Users</span><span class="badge badge-income">ADMIN
                                ONLY</span></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Full Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== SYSTEM SETTINGS PAGE ==================== -->
            <div id="system-settings" class="page">
                <h2
                    style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    ‚öôÔ∏è System Settings
                    <span class="badge badge-inheritance">ADMIN ONLY</span>
                </h2>

                <!-- Access Control Notice for Non-Admins -->
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access system settings. Please contact your system administrator.
                </div>

                <div class="admin-only-section">
                    <!-- User Management Section -->
                    <div class="card">
                        <div class="card-header gold">
                            <span>üë• User Management</span>
                            <button class="btn btn-sm" onclick="loadSystemUsers()"
                                style="background: rgba(255,255,255,0.2);">üîÑ Refresh</button>
                        </div>
                        <div class="card-body">
                            <!-- Create New User -->
                            <div style="background: #f7fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <h4 style="color: var(--primary-blue); margin-bottom: 0.75rem;">‚ûï Create New User</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Username *</label>
                                        <input type="text" id="sysNewUsername" placeholder="Enter username">
                                    </div>
                                    <div class="form-group">
                                        <label>Full Name *</label>
                                        <input type="text" id="sysNewFullName" placeholder="Enter full name">
                                    </div>
                                    <div class="form-group">
                                        <label>Email *</label>
                                        <input type="email" id="sysNewEmail" placeholder="Enter email address">
                                    </div>
                                    <div class="form-group">
                                        <label>Role *</label>
                                        <select id="sysNewRole">
                                            <option value="guest">Guest (Limited Access)</option>
                                            <option value="user" selected>User (View Only)</option>
                                            <option value="admin">Admin (Full Access)</option>
                                        </select>
                                    </div>
                                </div>
                                <div
                                    style="background: #ebf8ff; border: 1px solid #4299e1; border-radius: 6px; padding: 0.75rem; margin: 0.75rem 0;">
                                    <strong>üìå Password Policy:</strong>
                                    <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.85rem;">
                                        <li>Default password for new users: <code
                                                style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 3px;">1234</code>
                                        </li>
                                        <li>Users must change password on first login</li>
                                        <li>Minimum password length: 6 characters</li>
                                    </ul>
                                </div>
                                <button class="btn btn-success" onclick="createSystemUser()">üë§ Create User</button>
                            </div>

                            <!-- Users Table -->
                            <h4 style="color: var(--primary-blue); margin-bottom: 0.75rem;">üìã All Users</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Username</th>
                                            <th>Full Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Password</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="systemUsersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Role Permissions Info -->
                    <div class="card" id="role-permissions-card">
                        <div class="card-header"><span>üîê Role Permissions</span></div>
                        <div class="card-body">
                            <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">

                                <!-- Modals -->
                                <div
                                    style="background: linear-gradient(135deg, rgba(214,158,46,0.1), rgba(237,137,54,0.1)); border: 2px solid var(--accent-gold); border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: var(--accent-gold); margin-bottom: 0.5rem;">üëë ADMIN</h4>
                                    <p style="font-size: 0.8rem; color: #744210; margin-bottom: 0.5rem;"><strong>Full
                                            System Access</strong></p>
                                    <ul style="font-size: 0.75rem; margin-left: 1rem; color: #744210;">
                                        <li>‚úÖ Create, edit, delete all data</li>
                                        <li>‚úÖ Manage users & roles</li>
                                        <li>‚úÖ Access all modules</li>
                                        <li>‚úÖ Export & settings</li>
                                        <li>‚úÖ Inheritance management</li>
                                    </ul>
                                </div>
                                <!-- User -->
                                <div
                                    style="background: linear-gradient(135deg, rgba(66,153,225,0.1), rgba(49,130,206,0.1)); border: 2px solid var(--primary-blue); border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: var(--primary-blue); margin-bottom: 0.5rem;">üë§ USER</h4>
                                    <p style="font-size: 0.8rem; color: #2c5282; margin-bottom: 0.5rem;"><strong>View
                                            Only Access</strong></p>
                                    <ul style="font-size: 0.75rem; margin-left: 1rem; color: #2c5282;">
                                        <li>‚úÖ View all data</li>
                                        <li>‚úÖ View dashboards</li>
                                        <li>‚úÖ View reports</li>
                                        <li>‚ùå Cannot edit data</li>
                                        <li>‚ùå Cannot manage users</li>
                                    </ul>
                                </div>
                                <!-- Guest -->
                                <div
                                    style="background: linear-gradient(135deg, rgba(160,174,192,0.1), rgba(113,128,150,0.1)); border: 2px solid #a0aec0; border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: #718096; margin-bottom: 0.5rem;">üëÅÔ∏è GUEST</h4>
                                    <p style="font-size: 0.8rem; color: #4a5568; margin-bottom: 0.5rem;"><strong>Limited
                                            Access</strong></p>
                                    <ul style="font-size: 0.75rem; margin-left: 1rem; color: #4a5568;">
                                        <li>‚úÖ View dashboards only</li>
                                        <li>‚úÖ View properties</li>
                                        <li>‚ùå Cannot view finances</li>
                                        <li>‚ùå Cannot edit data</li>
                                        <li>‚ùå Cannot access settings</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My Profile Section -->
                    <div class="card">
                        <div class="card-header green"><span>üë§ My Profile</span></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" id="myProfileUsername" readonly style="background: #f7fafc;">
                                </div>
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" id="myProfileFullName" readonly style="background: #f7fafc;">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="text" id="myProfileEmail" readonly style="background: #f7fafc;">
                                </div>
                                <div class="form-group">
                                    <label>Role</label>
                                    <input type="text" id="myProfileRole" readonly style="background: #f7fafc;">
                                </div>
                            </div>

                            <h4 style="color: var(--primary-blue); margin: 1rem 0 0.75rem;">üîë Change My Password</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Current Password</label>
                                    <input type="password" id="myCurrentPassword" placeholder="Enter current password">
                                </div>
                                <div class="form-group">
                                    <label>New Password</label>
                                    <input type="password" id="myNewPassword"
                                        placeholder="Enter new password (min 6 chars)">
                                </div>
                                <div class="form-group">
                                    <label>Confirm New Password</label>
                                    <input type="password" id="myConfirmPassword" placeholder="Confirm new password">
                                </div>
                            </div>
                            <button class="btn btn-warning" onclick="changeMyPassword()">üîê Change Password</button>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="card">
                        <div class="card-header red"><span>üõ°Ô∏è Security Actions</span></div>
                        <div class="card-body">
                            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                                <div
                                    style="background: #fff5f5; border: 1px solid #fc8181; border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: #c53030; margin-bottom: 0.5rem;">üîÑ Force Password Reset</h4>
                                    <p style="font-size: 0.8rem; color: #742a2a; margin-bottom: 0.75rem;">
                                        Reset all non-admin users' passwords to default and force them to change on next
                                        login.
                                    </p>
                                    <button class="btn btn-danger btn-sm" onclick="forceAllPasswordReset()">Reset All
                                        Passwords</button>
                                </div>
                                <div
                                    style="background: #fffff0; border: 1px solid #ecc94b; border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: #744210; margin-bottom: 0.5rem;">üìã Export User List</h4>
                                    <p style="font-size: 0.8rem; color: #744210; margin-bottom: 0.75rem;">
                                        Download a CSV file of all users (passwords excluded for security).
                                    </p>
                                    <button class="btn btn-warning btn-sm" onclick="exportUserList()">Export Users
                                        CSV</button>
                                </div>
                                <div
                                    style="background: #f0fff4; border: 1px solid #68d391; border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: #276749; margin-bottom: 0.5rem;">üìä Login Statistics</h4>
                                    <p style="font-size: 0.8rem; color: #276749; margin-bottom: 0.75rem;">
                                        Total Users: <strong id="statTotalUsers">0</strong> |
                                        Active: <strong id="statActiveUsers">0</strong> |
                                        Admins: <strong id="statAdminUsers">0</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== CAMPOST MANKON MODULE ==================== -->

            <!-- CAMPOST DASHBOARD -->
            <div id="campost-dashboard" class="page">
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" id="dashIncome">0</div>
                        <div class="stat-label">Total Income</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üí∏</div>
                        <div class="stat-value" id="dashExp">0</div>
                        <div class="stat-label">Total Expenses</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üè¶</div>
                        <div class="stat-value" id="dashReserve">0</div>
                        <div class="stat-label">Reserved Funds</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="dashNetBalance">0</div>
                        <div class="stat-label">Net Balance</div>
                    </div>
                    <div class="stat-card gold">
                        <div class="stat-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <div class="stat-value" id="dashInh">0</div>
                        <div class="stat-label">Inheritance Amount</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>üìä Financial Summary</span></div>
                    <div class="card-body">
                        <div class="summary-row"><span>Total Income (Bills Paid):</span><span class="amount-positive"
                                id="dashIncomeSum">0 XAF</span></div>
                        <div class="summary-row"><span>Total Expenses:</span><span class="amount-negative"
                                id="dashExpSum">0 XAF</span></div>
                        <div class="summary-row"><span>Reserved Funds (<span id="dashReservePercent">10</span>% of
                                Income):</span><span class="amount-negative" id="dashReserveSum">0 XAF</span></div>
                        <div class="summary-row"
                            style="font-size: 1rem; background: #fed7d7; padding: 8px; border-radius: 6px;">
                            <span><strong>üìä Net Balance (Income - Expenses - Reserved):</strong></span><span
                                id="dashNetBalanceSum" style="font-weight: bold; color: #c53030;">0 XAF</span>
                        </div>
                        <div class="summary-row"><span>Inheritance Amount (from distributions):</span><span
                                class="amount-gold" id="dashInhSum">0 XAF</span></div>
                    </div>
                </div>
            </div>

            <!-- LEDGER -->
            <div id="campost-ledger" class="page">
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" id="ledgerIncome">0</div>
                        <div class="stat-label">Total Income (from Bills)</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üí∏</div>
                        <div class="stat-value" id="ledgerExpense">0</div>
                        <div class="stat-label">Total Expenses</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üè¶</div>
                        <div class="stat-value" id="ledgerReserved">0</div>
                        <div class="stat-label">Reserved Funds</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="ledgerNetBalance">0</div>
                        <div class="stat-label">Net Balance</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span>üìí Ledger - Income & Expenses (Auto-Generated)</span>
                        <div class="no-print">
                            <button class="btn btn-print btn-sm" onclick="exportPDF('ledger')">üì• Export PDF</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('ledger')">üì• Export CSV</button>
                            <button class="btn btn-print btn-sm" onclick="printPage('ledger')">üñ®Ô∏è Print</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                            üìå <strong>Income</strong> = Bills with status Paid or Partial | <strong>Expenses</strong> =
                            All recorded expenses | <strong>Net Balance</strong> = Income - Expenses - Reserved Funds
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Type</th>
                                        <th style="background: #c6f6d5; color: #276749;">Income (Credit)</th>
                                        <th style="background: #fed7d7; color: #c53030;">Expense (Debit)</th>
                                        <th>Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="ledgerTable"></tbody>
                                <tfoot id="ledgerTotals"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXPENSES -->
            <div id="campost-expenses" class="page">
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access Expenses. Please contact an admin if you need to add or modify
                    expenses.
                </div>
                <div class="admin-only-section">
                    <div class="card no-print">
                        <div class="card-header green"><span>‚ûï Add/Edit Expense</span></div>
                        <div class="card-body">
                            <div id="campostExpenseWarning"
                                style="display: none; background: #fed7d7; border: 1px solid #fc8181; color: #c53030; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                                <strong>‚ö†Ô∏è Expenses Disabled:</strong> Net Balance is zero. You cannot add more expenses
                                until more income is received.
                                <br><small>Net Balance = Total Income - Total Expenses - Reserved Funds</small>
                            </div>
                            <input type="hidden" id="expId">
                            <div class="form-grid">
                                <div class="form-group"><label>Date</label><input type="date" id="expDate"></div>
                                <div class="form-group"><label>Description</label><input type="text" id="expDesc"
                                        placeholder="Description"></div>
                                <div class="form-group"><label>Category</label><select id="expCat"></select></div>
                                <div class="form-group"><label>Amount</label><input type="number" id="expAmt"
                                        placeholder="Amount"></div>
                            </div>
                            <div class="btn-group"><button class="btn btn-success" id="campostSaveExpenseBtn"
                                    onclick="saveExpense()">üíæ Save</button><button class="btn btn-outline"
                                    onclick="clearExpenseForm()">üîÑ Clear</button></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>üí∏ Expenses</span><button class="btn btn-print btn-sm no-print"
                                onclick="printPage('expenses')">üñ®Ô∏è Print</button></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th>Amount</th>
                                            <th class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expTable"></tbody>
                                    <tfoot id="expTotals"></tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BILLS -->
            <div id="campost-bills" class="page">
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access Bills. Please contact an admin if you need to create or modify bills.
                </div>
                <div class="admin-only-section">
                    <div class="card no-print">
                        <div class="card-header green"><span>‚ûï Add/Edit Bill</span></div>
                        <div class="card-body">
                            <input type="hidden" id="billEditMode"><input type="hidden" id="billOldNumber">
                            <div class="form-grid">
                                <div class="form-group"><label>Quarter</label><select id="billQ">
                                        <option value="Q1">Q1</option>
                                        <option value="Q2">Q2</option>
                                        <option value="Q3">Q3</option>
                                        <option value="Q4">Q4</option>
                                    </select></div>
                                <div class="form-group"><label>Year</label><select id="billY"></select></div>
                                <div class="form-group"><label>Period</label><select id="billP">
                                        <option value="January to March">January to March</option>
                                        <option value="April to June">April to June</option>
                                        <option value="July to September">July to September</option>
                                        <option value="October to December">October to December</option>
                                    </select></div>
                                <div class="form-group"><label>Bill Number</label><input type="text" id="billNum"
                                        readonly></div>
                            </div>
                            <div
                                style="background: #ebf8ff; padding: 12px; border-radius: 8px; margin: 10px 0; border: 1px solid #90cdf4;">
                                <div
                                    style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; font-size: 0.85rem;">
                                    <div><span style="color: #4a5568;">Monthly Rate:</span> <strong
                                            id="billShowRate">200,000</strong> XAF</div>
                                    <div><span style="color: #4a5568;">Gross (3 mo):</span> <strong
                                            id="billShowGross">600,000</strong> XAF</div>
                                    <div><span style="color: #4a5568;">Tax (<span
                                                id="billShowTaxPct">15</span>%):</span> <strong id="billShowTax"
                                            style="color: #e53e3e;">-90,000</strong> XAF</div>
                                    <div><span style="color: #4a5568;">Net Due:</span> <strong id="billShowNet"
                                            style="color: #38a169;">510,000</strong> XAF</div>
                                </div>
                                <p style="margin-top: 8px; font-size: 0.7rem; color: #718096;">üí° To change monthly rate
                                    or tax rate, go to <strong>Settings</strong> tab</p>
                            </div>
                            <div class="btn-group"><button class="btn btn-success" onclick="saveBill()">üíæ Save
                                    Bill</button><button class="btn btn-outline" onclick="clearBillForm()">üîÑ
                                    Clear</button></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>üìÑ All Bills (Click to View Invoice)</span><button
                                class="btn btn-print btn-sm no-print" onclick="printPage('bills')">üñ®Ô∏è Print
                                List</button></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Bill #</th>
                                            <th>Period</th>
                                            <th>Due</th>
                                            <th>Paid</th>
                                            <th>Outstanding</th>
                                            <th>Status</th>
                                            <th class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAYMENTS -->
            <div id="campost-payments" class="page">
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access Payments. Please contact an admin if you need to record payments.
                </div>
                <div class="admin-only-section">
                    <div class="card no-print">
                        <div class="card-header green"><span>‚ûï Add/Edit Payment</span></div>
                        <div class="card-body">
                            <input type="hidden" id="payId">
                            <div class="form-grid">
                                <div class="form-group"><label>Select Bill</label><select id="payBill"></select></div>
                                <div class="form-group"><label>Outstanding</label><input type="text" id="payOut"
                                        readonly></div>
                                <div class="form-group"><label>Amount (XAF)</label><input type="number" id="payAmt">
                                </div>
                                <div class="form-group">
                                    <label>Payment Method</label>
                                    <select id="payMethod">
                                        <option value="Cash">Cash</option>
                                        <option value="Mobile Money">Mobile Money</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                    </select>
                                </div>
                                <div class="form-group"><label>Date</label><input type="date" id="payDate"></div>
                                <div class="form-group"><label>Reference</label><input type="text" id="payRef"
                                        placeholder="Receipt #"></div>
                            </div>
                            <div class="btn-group"><button class="btn btn-success" onclick="savePayment()">üíæ
                                    Save</button><button class="btn btn-outline" onclick="clearPaymentForm()">üîÑ
                                    Clear</button></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>üíµ Payments</span><button class="btn btn-print btn-sm no-print"
                                onclick="printPage('payments')">üñ®Ô∏è Print</button></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Bill #</th>
                                            <th>Period</th>
                                            <th>Amount</th>
                                            <th>Reference</th>
                                            <th class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="payTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    </div>

    <!-- RECEIPTS -->
    <div id="campost-receipts" class="page">
        <div class="card">
            <div class="card-header"><span>üßæ Receipts</span></div>
            <div class="card-body">
                <p style="margin-bottom: 1rem; color: #718096; font-size: 0.9rem;">
                    View and print receipts for payments requiring official documentation.
                </p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Receipt #</th>
                                <th>Bill Ref</th>
                                <th>Amount</th>
                                <th>Period</th>
                                <th class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="campostReceiptsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Hidden Receipt Container for Printing -->
        <div id="campostReceiptPrintContainer" style="display:none;"></div>
    </div>

    <!-- INHERITANCE -->
    <div id="campost-inheritance" class="page">
        <div class="highlight-box">
            <p>Amount to Distribute (from Inheritance Share expenses)</p>
            <h3 id="inhAmt">0 XAF</h3>
        </div>
        <div class="stats-grid">
            <div class="stat-card green">
                <div class="stat-icon">üíµ</div>
                <div class="stat-value" id="inhPaid">0</div>
                <div class="stat-label">Bills Paid</div>
            </div>
            <div class="stat-card red">
                <div class="stat-icon">üí∏</div>
                <div class="stat-value" id="inhExp">0</div>
                <div class="stat-label">Expenses</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-icon">üè¶</div>
                <div class="stat-value" id="inhRes">0</div>
                <div class="stat-label">Reserve</div>
            </div>
            <div class="stat-card gold">
                <div class="stat-icon">üìä</div>
                <div class="stat-value" id="inhPer">0</div>
                <div class="stat-label">Base Share</div>
            </div>
        </div>

        <!-- Beneficiary Selection Card -->
        <div class="card admin-only-section no-print">
            <div class="card-header blue"><span>‚úÖ Select Beneficiaries</span>
                <div>
                    <button class="btn btn-outline btn-sm" onclick="selectAllCampostBeneficiaries(true)">Select
                        All</button>
                    <button class="btn btn-outline btn-sm" onclick="selectAllCampostBeneficiaries(false)">Deselect
                        All</button>
                    <button class="btn btn-warning btn-sm" onclick="resetCampostHeirsToDefaults()">üîÑ Reset to
                        Defaults</button>
                </div>
            </div>
            <div class="card-body">
                <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                    ‚úÖ Check the heirs who should receive inheritance. Only selected heirs will be included in
                    the distribution.
                </p>
                <div id="campostBeneficiaryList"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">
                </div>
                <div class="btn-group" style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="saveCampostBeneficiaries()">üíæ Save Selection &
                        Recalculate</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header gold"><span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Heirs (<span id="inhPortions">24</span>
                    ratio)</span>
                <div class="no-print"><button class="btn btn-outline btn-sm admin-only" onclick="openHeirModal()">‚ûï
                        Add</button><button class="btn btn-gold btn-sm" onclick="printAllHeirCertificates()">üñ®Ô∏è Print
                        All Certificates</button></div>
            </div>
            <div class="card-body" id="heirGroups"></div>
        </div>
        <div class="card" id="campost-heir-shares-card">
            <div class="card-header"><span>üìã Heir Shares (Beneficiaries Only)</span><button
                    class="btn btn-print btn-sm no-print" onclick="printElement('campost-heir-shares-card')">üñ®Ô∏è
                    Print
                    Summary</button></div>
            <div class="card-body">
                <div class="highlight-box" style="margin-bottom: 15px;">
                    <p>Amount to Distribute (from Inheritance Share expenses)</p>
                    <h3 id="inhAmtTable">0 XAF</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Relationship</th>
                                <th>Fraction</th>
                                <th>Parts</th>
                                <th>Share (%)</th>
                                <th>Share (XAF)</th>
                                <th class="no-print admin-only">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="heirTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- EXPORT -->
    <div id="campost-export" class="page">
        <div class="card">
            <div class="card-header"><span>üì• Export All Data</span></div>
            <div class="card-body">
                <p style="margin-bottom:1rem;font-size:0.85rem;">Export with CAMPOST MANKON header.</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="exportAllCSV()">üìÑ All CSV</button>
                    <button class="btn btn-print" onclick="exportAllPDF()">üìë All PDF</button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><span>üìä Individual Exports</span></div>
            <div class="card-body">
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('bills')">Bills CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('payments')">Payments CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('expenses')">Expenses CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('ledger')">Ledger CSV</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-print btn-sm" onclick="exportPDF('bills')">Bills PDF</button>
                    <button class="btn btn-print btn-sm" onclick="exportPDF('payments')">Payments PDF</button>
                    <button class="btn btn-print btn-sm" onclick="exportPDF('expenses')">Expenses PDF</button>
                    <button class="btn btn-primary btn-sm" onclick="exportPDF('ledger')">Ledger PDF</button>
                    <button class="btn btn-gold btn-sm" onclick="exportPDF('heirs')">Heirs PDF</button>
                    <button class="btn btn-success btn-sm" onclick="exportREPropertiesPDF()">Properties
                        PDF</button>
                </div>
            </div>
        </div>
    </div>


    </div>



    <!-- Property Modal -->
    <div class="modal-overlay" id="propertyModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="propertyModalTitle">üè† Add Property</h3><button class="modal-close"
                    onclick="closePropertyModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="propId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Property Name *</label>
                        <input type="text" id="propName" placeholder="e.g., Commercial Building A">
                    </div>
                    <div class="form-group">
                        <label>Location *</label>
                        <input type="text" id="propLocation" placeholder="e.g., Bamenda, NW Region">
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="propType">
                            <option value="Residential">Residential</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Land">Land</option>
                            <option value="Industrial">Industrial</option>
                            <option value="Mixed">Mixed Use</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="propStatus" onchange="toggleRentalFields()">
                            <option value="Rented">Rented</option>
                            <option value="Not for Rent">Not for Rent</option>
                            <option value="Sold">Sold</option>
                            <option value="For sale">For Sale</option>
                            <option value="Not to be sold">Not to be Sold</option>
                            <option value="Shared">Shared</option>
                            <option value="Admin issues">Admin Issues</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                </div>

                <!-- Rental Fields (only for Rented status) -->
                <div id="rentalFields" style="background: #ebf8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #2c5282; margin-bottom: 10px;">üí∞ Rental Configuration</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Rent Amount (XAF) *</label>
                            <input type="number" id="propRentAmount" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label>Rental Period *</label>
                            <select id="propRentPeriod">
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tax Rate (%) *</label>
                            <select id="propTaxRate">
                                <option value="0">0%</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="15" selected>15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                            </select>
                        </div>
                    </div>
                    <div style="background: #fff; padding: 10px; border-radius: 6px; margin-top: 10px;">
                        <div class="summary-row"><span>Gross Rent:</span><span id="propGrossRent">0 XAF</span></div>
                        <div class="summary-row"><span>Tax Deduction:</span><span id="propTaxAmount"
                                style="color: #e53e3e;">0 XAF</span></div>
                        <div class="summary-row" style="font-weight: bold;"><span>Net Income:</span><span
                                id="propNetIncome" style="color: #38a169;">0 XAF</span></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Shared per Islamic Inheritance?</label>
                    <select id="propInheritance">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="NA">N/A</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="propNotes" rows="3"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveProperty()">üíæ Save Property</button>
                    <button class="btn btn-outline" onclick="closePropertyModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- RE Heir Modal -->
    <div class="modal-overlay" id="reHeirModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üë§ Add/Edit Heir</h3><button class="modal-close" onclick="closeREHeirModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reHeirId">
                <div class="form-grid">
                    <div class="form-group"><label>Name *</label><input type="text" id="reHeirName"
                            placeholder="Full name"></div>
                    <div class="form-group">
                        <label>Relationship *</label>
                        <select id="reHeirRel" onchange="updateIslamicPortions()">
                            <option value="Father">Father</option>
                            <option value="Mother">Mother</option>
                            <option value="Husband">Husband</option>
                            <option value="Wife">Wife</option>
                            <option value="Son">Son</option>
                            <option value="Daughter">Daughter</option>
                            <option value="Son's Daughter">Son's Daughter</option>
                            <option value="Full Sister">Full Sister</option>
                            <option value="Paternal Sister">Paternal Sister</option>
                            <option value="Maternal Sibling">Maternal Sibling</option>
                            <option value="Paternal Grandfather">Paternal Grandfather</option>
                            <option value="Full Brother">Full Brother</option>
                            <option value="Paternal Brother">Paternal Brother</option>
                            <option value="Son's Son">Son's Son</option>
                            <option value="Maternal Grandfather">Maternal Grandfather</option>
                            <option value="Maternal Grandmother">Maternal Grandmother</option>
                            <option value="Daughter's Children">Daughter's Children</option>
                            <option value="Paternal Aunt">Paternal Aunt</option>
                            <option value="Maternal Aunt">Maternal Aunt</option>
                            <option value="Nephew (Sister's Son)">Nephew (Sister's Son)</option>
                            <option value="Niece (Sister's Daughter)">Niece (Sister's Daughter)</option>
                            <option value="Granddaughter (Daughter's Daughter)">Granddaughter (Daughter's Daughter)
                            </option>
                            <option value="Grandmother">Grandmother</option>
                            <option value="Grandfather">Grandfather</option>
                            <option value="Uterine Sibling">Uterine Sibling</option>
                            <option value="Grandson (Son's Son)">Grandson (Son's Son)</option>
                            <option value="Step-father">Step-father</option>
                            <option value="Step-mother">Step-mother</option>
                            <option value="Adopted Child">Adopted Child</option>
                            <option value="Foster Relations">Foster Relations</option>
                            <option value="Illegitimate Child">Illegitimate Child</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Group (Auto)</label>
                        <select id="reHeirGrp" disabled style="background-color: #e9ecef; cursor: not-allowed;">
                            <option value="Primary Heir">Primary Heir</option>
                            <option value="Residuary Heir">Residuary Heir</option>
                            <option value="Distant Kindred">Distant Kindred</option>
                            <option value="Special Case">Special Case</option>
                            <option value="Excluded">Excluded</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gender *</label>
                        <select id="reHeirGender" onchange="updateIslamicPortions()">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ratio (Auto-Calculated)</label>
                        <input type="number" id="reHeirPor" value="1" min="0" step="0.125" readonly
                            style="background: #f0f0f0;">
                    </div>
                </div>
                <div
                    style="background: #fffbeb; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 0.85rem;">
                    <strong>üìú Islamic Inheritance Rules:</strong><br>
                    ‚Ä¢ Sons get 2x daughters' share<br>
                    ‚Ä¢ Wife gets 1/8 (with children) or 1/4 (no children)<br>
                    ‚Ä¢ Husband gets 1/4 (with children) or 1/2 (no children)<br>
                    ‚Ä¢ Parents each get 1/6 (with children)
                </div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveREHeir()">üíæ Save</button><button
                        class="btn btn-outline" onclick="closeREHeirModal()">Cancel</button></div>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="campost-settings" class="page">
        <div class="user-restricted-notice">
            <strong>üîí Access Restricted</strong><br>
            Only administrators can access Settings. Please contact an admin if you need to modify system settings.
        </div>
        <div class="admin-only-section">
            <div class="card">
                <div class="card-header gold"><span>üåç Currency & Global Settings</span></div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Currency</label>
                            <select id="campostCurrency" onchange="updateCampostCalcDisplays()">
                                <option value="XAF" selected>XAF - Central African CFA Franc</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="USD">USD - US Dollar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reserved Funds (% of Income)</label>
                            <select id="campostReservedPercent" onchange="updateCampostCalcDisplays()">
                                <option value="0">0% - No Reserve</option>
                                <option value="5">5%</option>
                                <option value="10" selected>10%</option>
                                <option value="15">15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                                <option value="30">30%</option>
                            </select>
                        </div>
                    </div>
                    <p
                        style="font-size: 0.8rem; color: #718096; margin: 10px 0; background: #ebf8ff; padding: 10px; border-radius: 6px;">
                        üè¶ <strong>Reserved Funds:</strong> A percentage of total income set aside for maintenance,
                        emergencies, or future investments.<br>
                        üìä <strong>Net Balance</strong> = Total Income - Total Expenses - Reserved Funds
                    </p>
                </div>
            </div>
            <div class="card">
                <div class="card-header gold"><span>üí∞ Rent Configuration</span></div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Monthly Rent</label>
                            <input type="number" id="settingMonthlyRent" value="200000">
                        </div>
                        <div class="form-group">
                            <label>Tax Rate (%)</label>
                            <input type="number" id="settingTaxRate" value="15" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Months per Quarter</label>
                            <input type="number" id="settingMonths" value="3" readonly>
                        </div>
                    </div>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-bottom: 10px; color: #2c5282;">üìä Calculated Amounts</h4>
                        <div class="summary-row"><span>Quarterly Gross:</span><span id="calcGross">600,000 XAF</span>
                        </div>
                        <div class="summary-row"><span>Tax Deduction:</span><span id="calcTax">90,000 XAF</span></div>
                        <div class="summary-row" style="font-weight: bold; color: #38a169;"><span>Net Amount
                                Due:</span><span id="calcNet">510,000 XAF</span></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveSettings()">üíæ Save All Settings</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span>‚öôÔ∏è System Status</span></div>
                <div class="card-body">
                    <div class="alert" id="settingsAlert">Checking...</div>
                    <div class="btn-group">
                        <button class="btn btn-outline" onclick="checkDb()">üîÑ Refresh</button>
                        <button class="btn btn-danger" onclick="resetAll()">üóëÔ∏è Reset All Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>

    <!-- Temp Page for Printing Elements -->
    <div id="print-temp-page" class="page"></div>

    <!-- Bill/Invoice Modal -->
    <div class="modal-overlay" id="billModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üìÑ Rent Invoice</h3><button class="modal-close" onclick="closeBillModal()">√ó</button>
            </div>
            <div class="modal-body" id="billModalBody"></div>
        </div>
    </div>

    <!-- Heir Modal -->
    <div class="modal-overlay" id="heirModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üë§ Heir</h3><button class="modal-close" onclick="closeHeirModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="heirId">
                <div class="form-group"><label>Name</label><input type="text" id="heirName"></div>
                <div class="form-group"><label>Relationship</label><select id="heirRel"
                        onchange="autoSelectGroup('heirRel', 'heirGrp')">
                        <option value="Father">Father</option>
                        <option value="Mother">Mother</option>
                        <option value="Husband">Husband</option>
                        <option value="Wife">Wife</option>
                        <option value="Son">Son</option>
                        <option value="Daughter">Daughter</option>
                        <option value="Son's Daughter">Son's Daughter</option>
                        <option value="Full Sister">Full Sister</option>
                        <option value="Paternal Sister">Paternal Sister</option>
                        <option value="Maternal Sibling">Maternal Sibling</option>
                        <option value="Paternal Grandfather">Paternal Grandfather</option>
                        <option value="Full Brother">Full Brother</option>
                        <option value="Paternal Brother">Paternal Brother</option>
                        <option value="Son's Son">Son's Son</option>
                        <option value="Maternal Grandfather">Maternal Grandfather</option>
                        <option value="Maternal Grandmother">Maternal Grandmother</option>
                        <option value="Daughter's Children">Daughter's Children</option>
                        <option value="Paternal Aunt">Paternal Aunt</option>
                        <option value="Maternal Aunt">Maternal Aunt</option>
                        <option value="Nephew (Sister's Son)">Nephew (Sister's Son)</option>
                        <option value="Niece (Sister's Daughter)">Niece (Sister's Daughter)</option>
                        <option value="Granddaughter (Daughter's Daughter)">Granddaughter (Daughter's Daughter)</option>
                        <option value="Grandmother">Grandmother</option>
                        <option value="Grandfather">Grandfather</option>
                        <option value="Uterine Sibling">Uterine Sibling</option>
                        <option value="Grandson (Son's Son)">Grandson (Son's Son)</option>
                        <option value="Step-father">Step-father</option>
                        <option value="Step-mother">Step-mother</option>
                        <option value="Adopted Child">Adopted Child</option>
                        <option value="Foster Relations">Foster Relations</option>
                        <option value="Illegitimate Child">Illegitimate Child</option>
                    </select></div>
                <div class="form-group"><label>Group (Auto)</label><select id="heirGrp" disabled
                        style="background-color: #e9ecef; cursor: not-allowed;">
                        <option value="Primary Heir">Primary Heir</option>
                        <option value="Residuary Heir">Residuary Heir</option>
                        <option value="Distant Kindred">Distant Kindred</option>
                        <option value="Special Case">Special Case</option>
                        <option value="Excluded">Excluded</option>
                    </select></div>
                <div class="form-group"><label>Ratio</label><input type="number" id="heirPor" value="3" step="0.5">
                </div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveHeir()">üíæ Save</button></div>
            </div>
        </div>
    </div>
    </div> <!-- End mainApp -->

    <!-- ==================== LOGIN CONTAINER ==================== -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üè¢</div>
                <h1>CAMPOST MANKON</h1>
                <p>Property & Billing Management System</p>
            </div>
            <div class="login-body">
                <div id="loginError" class="login-error"></div>
                <div class="form-group">
                    <label>üë§ Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>üîë Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password"
                        autocomplete="current-password" onkeypress="if(event.key==='Enter')doLogin()">
                </div>
                <button class="btn btn-success login-btn" onclick="doLogin()">üîì Login</button>
            </div>
            <div class="login-footer">
                <a onclick="showForgotPassword()">Forgot Password?</a>
                <br><br>
                <span>¬© 2024-2025 CAMPOST MANKON</span>
            </div>
        </div>
    </div>

    <!-- ==================== FORGOT PASSWORD MODAL ==================== -->
    <div id="forgotPasswordModal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h3>üîê Reset Password</h3>
                <button class="modal-close" onclick="closeForgotPassword()" style="color: white;">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 15px;">
                    Enter your username and email address. A temporary password will be sent to your registered email.
                </p>
                <div id="forgotError" class="login-error"></div>
                <div class="form-group">
                    <label>üë§ Username</label>
                    <input type="text" id="forgotUsername" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label>üìß Email Address</label>
                    <input type="email" id="forgotEmail" placeholder="Enter your email address">
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="requestPasswordReset()">üì® Send Temporary Password</button>
                    <button class="btn btn-outline" onclick="closeForgotPassword()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== FORCE PASSWORD CHANGE MODAL ==================== -->
    <div id="forcePasswordModal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white;">
                <h3>‚ö†Ô∏è Password Change Required</h3>
            </div>
            <div class="modal-body">
                <div
                    style="background: #fffaf0; border: 1px solid #ed8936; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="font-size: 0.9rem; color: #744210; margin: 0;">
                        <strong>üîí Security Notice:</strong> You must change your password before continuing. This is
                        required for:
                    </p>
                    <ul style="font-size: 0.85rem; color: #744210; margin: 10px 0 0 20px; padding: 0;">
                        <li>First-time login with default credentials</li>
                        <li>Login after password reset</li>
                    </ul>
                </div>
                <div id="forcePasswordError" class="login-error"></div>
                <div class="form-group">
                    <label>üîë New Password</label>
                    <input type="password" id="forceNewPassword" placeholder="Enter new password (min 6 characters)">
                </div>
                <div class="form-group">
                    <label>üîë Confirm New Password</label>
                    <input type="password" id="forceConfirmPassword" placeholder="Confirm new password"
                        onkeypress="if(event.key==='Enter')forceChangePassword()">
                </div>
                <div class="btn-group">
                    <button class="btn btn-warning" onclick="forceChangePassword()">üîê Change Password &
                        Continue</button>
                </div>
            </div>
        </div>
    </div>

    <div id="alertBox" style="position:fixed;top:60px;right:10px;z-index:3000;max-width:280px;"></div>

    <script>
        // ==================== API CONFIGURATION ====================
        var API = window.location.origin + '/api';

        // ==================== AUTHENTICATION SYSTEM ====================

        // Initialize default admin user if not exists
        function initializeUsers() {
            // Users are now initialized in PostgreSQL
            // No localStorage initialization needed
        }

        // Initialize default heirs - now handled by server
        function initializeDefaultHeirs() {
            // RE heirs are now initialized in PostgreSQL
            // No localStorage initialization needed
        }

        // Current logged in user
        var currentUser = null;

        // Login function
        function doLogin() {
            var username = document.getElementById('loginUsername').value.trim().toLowerCase();
            var password = document.getElementById('loginPassword').value;
            var errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = 'Please enter username and password';
                errorEl.classList.add('show');
                return;
            }

            fetch(API + '/users/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            })
                .then(function (res) { return res.json(); })
                .then(function (result) {
                    if (result.success && result.user) {
                        currentUser = result.user;
                        localStorage.setItem('currentSession', JSON.stringify({ userId: result.user.id, loginTime: new Date().toISOString() }));

                        // Check if password change is required
                        if (result.user.must_change_password) {
                            showForcePasswordChange();
                        } else {
                            enterMainApp();
                        }
                    } else {
                        errorEl.textContent = result.error || 'Invalid username or password';
                        errorEl.classList.add('show');
                    }
                }).catch(function (err) {
                    errorEl.textContent = 'Login failed: ' + (err.error || err.message || 'Connection error');
                    errorEl.classList.add('show');
                });
        }

        // Show force password change modal
        function showForcePasswordChange() {
            document.getElementById('forcePasswordModal').style.display = 'flex';
            document.getElementById('forceNewPassword').value = '';
            document.getElementById('forceConfirmPassword').value = '';
            document.getElementById('forcePasswordError').classList.remove('show');
        }

        // Force password change (for first login or after reset)
        function forceChangePassword() {
            var newPwd = document.getElementById('forceNewPassword').value;
            var confirmPwd = document.getElementById('forceConfirmPassword').value;
            var errorEl = document.getElementById('forcePasswordError');

            if (newPwd.length < 6) {
                errorEl.textContent = 'New password must be at least 6 characters';
                errorEl.classList.add('show');
                return;
            }

            if (newPwd !== confirmPwd) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.add('show');
                return;
            }

            // Check if new password is same as default
            if (newPwd === 'admin' || newPwd === '1234') {
                errorEl.textContent = 'Please choose a different password than the default';
                errorEl.classList.add('show');
                return;
            }

            // Update password via API
            api('/users/force-change-password', {
                method: 'POST',
                body: JSON.stringify({
                    userId: currentUser.id,
                    newPassword: newPwd
                })
            }).then(function (result) {
                if (result.success) {
                    document.getElementById('forcePasswordModal').style.display = 'none';
                    currentUser.must_change_password = false;
                    showAlert('Password changed successfully!');
                    enterMainApp();
                } else {
                    errorEl.textContent = result.error || 'Failed to change password';
                    errorEl.classList.add('show');
                }
            }).catch(function (err) {
                errorEl.textContent = 'Error: ' + (err.message || 'Connection error');
                errorEl.classList.add('show');
            });
        }

        // Forgot password functions
        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'flex';
            document.getElementById('forgotUsername').value = '';
            document.getElementById('forgotEmail').value = '';
            document.getElementById('forgotError').classList.remove('show');
        }

        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
        }

        function requestPasswordReset() {
            var username = document.getElementById('forgotUsername').value.trim();
            var email = document.getElementById('forgotEmail').value.trim();
            var errorEl = document.getElementById('forgotError');

            if (!username || !email) {
                errorEl.textContent = 'Please enter both username and email';
                errorEl.classList.add('show');
                return;
            }

            api('/users/reset-password', {
                method: 'POST',
                body: JSON.stringify({ username: username, email: email })
            }).then(function (result) {
                if (result.success) {
                    closeForgotPassword();
                    // For demo, show the temp password. In production, this would be sent via email
                    if (result.tempPassword) {
                        showAlert('Temporary password: ' + result.tempPassword + '\nPlease use this to login and change your password.', 'success');
                    } else {
                        showAlert('Password reset email sent! Check your inbox.');
                    }
                } else {
                    errorEl.textContent = result.error || 'Reset failed';
                    errorEl.classList.add('show');
                }
            }).catch(function (err) {
                errorEl.textContent = err.error || 'Account not found or connection error';
                errorEl.classList.add('show');
            });
        }

        // Enter main app after successful login
        function enterMainApp() {
            document.getElementById('loginContainer').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';

            // Update UI with user info
            document.getElementById('loggedInUser').textContent = currentUser.full_name || currentUser.username;
            var badge = document.getElementById('userRoleBadge');
            badge.textContent = currentUser.role.toUpperCase();
            badge.className = 'user-badge ' + currentUser.role;

            // Set role classes on body for role-based access control
            document.body.classList.remove('is-admin', 'is-user', 'is-guest');
            document.body.classList.add('is-' + currentUser.role);

            // Show/hide admin user management
            if (currentUser.role === 'admin') {
                document.getElementById('adminUserManagement').style.display = 'block';
            } else {
                document.getElementById('adminUserManagement').style.display = 'none';
            }

            // Apply role-based restrictions
            applyRoleBasedAccess();

            // Initialize app
            checkDb();
            goToLanding();
        }

        // Apply role-based access control
        function applyRoleBasedAccess() {
            var role = currentUser ? currentUser.role : 'guest';

            // Admin-only sections (full access)
            var adminOnlySections = document.querySelectorAll('.admin-only-section');
            adminOnlySections.forEach(function (el) {
                el.style.display = (role === 'admin') ? 'block' : 'none';
            });

            // Admin-only elements (buttons, links)
            var adminOnlyElements = document.querySelectorAll('.admin-only');
            adminOnlyElements.forEach(function (el) {
                el.style.display = (role === 'admin') ? '' : 'none';
            });

            // User restricted notice (shown to non-admins)
            var userNotices = document.querySelectorAll('.user-restricted-notice');
            userNotices.forEach(function (el) {
                el.style.display = (role === 'admin') ? 'none' : 'block';
            });

            // Guest restricted notice (shown to guests only)
            var guestNotices = document.querySelectorAll('.guest-restricted-notice');
            guestNotices.forEach(function (el) {
                el.style.display = (role === 'guest') ? 'block' : 'none';
            });

            // Hide navigation buttons based on role
            applyNavRestrictions();
        }

        // Apply navigation restrictions based on role
        function applyNavRestrictions() {
            var role = currentUser ? currentUser.role : 'guest';

            // Admin-only pages (full write access)
            var adminPages = ['campost-expenses', 'campost-bills', 'campost-payments', 'campost-inheritance', 'campost-export', 'campost-settings'];

            // Guest restricted pages (guests cannot access these)
            var guestRestrictedPages = ['campost-ledger', 'campost-expenses', 'campost-bills', 'campost-payments', 'campost-inheritance', 'campost-export', 'campost-settings'];

            // Apply restrictions
            document.querySelectorAll('.nav-btn[data-page]').forEach(function (btn) {
                var page = btn.getAttribute('data-page');

                if (role === 'guest' && guestRestrictedPages.indexOf(page) !== -1) {
                    btn.style.display = 'none';
                } else if (role === 'user' && adminPages.indexOf(page) !== -1) {
                    // Users can see but have read-only access (handled elsewhere)
                    btn.style.display = '';
                } else {
                    btn.style.display = '';
                }
            });
        }

        // Logout function
        function doLogout() {
            if (!confirm('Are you sure you want to logout?')) return;

            currentUser = null;
            localStorage.removeItem('currentSession');

            // Reset UI
            document.body.classList.remove('is-admin', 'is-user', 'is-guest');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginContainer').classList.add('active');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('adminUserManagement').style.display = 'none';
        }

        // Old force password change (now replaced)
        function oldForceChangePassword() {
            var currentPwd = document.getElementById('forceCurrentPassword').value;
            var newPwd = document.getElementById('forceNewPassword').value;
            var confirmPwd = document.getElementById('forceConfirmPassword').value;

            if (newPwd.length < 4) {
                showAlert('New password must be at least 4 characters', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showAlert('New passwords do not match', 'error');
                return;
            }

            // Update password via API
            api('/users/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    userId: currentUser.id,
                    currentPassword: currentPwd,
                    newPassword: newPwd
                })
            }).then(function (result) {
                if (result.success) {
                    document.getElementById('forcePasswordModal').classList.remove('active');
                    showAlert('Password changed successfully!');
                    enterMainApp();
                } else {
                    showAlert(result.error || 'Failed to change password', 'error');
                }
            }).catch(function (err) {
                showAlert('Current password is incorrect', 'error');
            });
        }

        // Change my password (from settings)
        function changeMyPassword() {
            var currentPwd = document.getElementById('changeCurrentPwd').value;
            var newPwd = document.getElementById('changeNewPwd').value;
            var confirmPwd = document.getElementById('changeConfirmPwd').value;

            if (newPwd.length < 4) {
                showAlert('New password must be at least 4 characters', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showAlert('New passwords do not match', 'error');
                return;
            }

            api('/users/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    userId: currentUser.id,
                    currentPassword: currentPwd,
                    newPassword: newPwd
                })
            }).then(function (result) {
                if (result.success) {
                    document.getElementById('changeCurrentPwd').value = '';
                    document.getElementById('changeNewPwd').value = '';
                    document.getElementById('changeConfirmPwd').value = '';
                    showAlert('Password changed successfully!');
                } else {
                    showAlert(result.error || 'Failed to change password', 'error');
                }
            }).catch(function (err) {
                showAlert('Current password is incorrect', 'error');
            });
        }

        // Create new user (admin only)
        function createNewUser() {
            if (currentUser.role !== 'admin') {
                showAlert('Only admins can create users', 'error');
                return;
            }

            var username = document.getElementById('newUserUsername').value.trim().toLowerCase();
            var email = document.getElementById('newUserEmail').value.trim().toLowerCase();
            var fullName = document.getElementById('newUserFullName').value.trim();
            var role = document.getElementById('newUserRole').value;

            if (!username) {
                showAlert('Username is required', 'error');
                return;
            }

            if (!email) {
                showAlert('Email is required', 'error');
                return;
            }

            api('/users', {
                method: 'POST',
                body: JSON.stringify({
                    username: username,
                    password: '1234',
                    fullName: fullName || username,
                    email: email,
                    role: role,
                    active: true
                })
            }).then(function (result) {
                if (result.error) {
                    showAlert(result.error, 'error');
                } else {
                    document.getElementById('newUserUsername').value = '';
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserFullName').value = '';
                    document.getElementById('newUserRole').value = 'user';
                    showAlert('User created successfully! Default password is 1234. User must change it on first login.');
                    loadUsersTable();
                }
            }).catch(function (err) {
                showAlert('Error creating user: ' + err.message, 'error');
            });
        }

        // Load users table (admin only)
        function loadUsersTable() {
            api('/users').then(function (users) {
                var html = users.map(function (u) {
                    var statusClass = u.active ? 'badge-paid' : 'badge-unpaid';
                    var statusText = u.active ? 'Active' : 'Inactive';
                    var roleClass = u.role === 'admin' ? 'badge-inheritance' : (u.role === 'guest' ? 'badge-expense' : 'badge-new');
                    var pwdStatus = u.must_change_password ? '<span style="color:#ed8936;font-size:0.7rem;">‚ö†Ô∏è Must change</span>' : '';

                    return '<tr>' +
                        '<td><strong>' + u.username + '</strong></td>' +
                        '<td>' + (u.full_name || '-') + '</td>' +
                        '<td>' + (u.email || '-') + '</td>' +
                        '<td><span class="badge ' + roleClass + '">' + u.role.toUpperCase() + '</span></td>' +
                        '<td><span class="badge ' + statusClass + '">' + statusText + '</span> ' + pwdStatus + '</td>' +
                        '<td>' +
                        (u.id !== currentUser.id ?
                            '<button class="btn btn-warning btn-sm" onclick="resetUserPassword(' + u.id + ')">üîë Reset</button> ' +
                            '<button class="btn btn-' + (u.active ? 'danger' : 'success') + ' btn-sm" onclick="toggleUserStatus(' + u.id + ', ' + u.active + ')">' + (u.active ? 'üö´' : '‚úÖ') + '</button> ' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteUser(' + u.id + ')">üóëÔ∏è</button>'
                            : '<span style="color:#718096;font-size:0.75rem;">Current User</span>') +
                        '</td>' +
                        '</tr>';
                }).join('');

                document.getElementById('usersTable').innerHTML = html || '<tr><td colspan="6">No users</td></tr>';
            });
        }

        // ==================== SYSTEM SETTINGS FUNCTIONS ====================

        // Load system users table
        function loadSystemUsers() {
            api('/users').then(function (users) {
                var html = users.map(function (u) {
                    var statusClass = u.active ? 'badge-paid' : 'badge-unpaid';
                    var statusText = u.active ? 'Active' : 'Inactive';
                    var roleClass = u.role === 'admin' ? 'badge-inheritance' : (u.role === 'guest' ? 'badge-expense' : 'badge-new');
                    var pwdStatus = u.must_change_password ?
                        '<span class="badge" style="background:#fed7d7;color:#c53030;">Must Change</span>' :
                        '<span class="badge" style="background:#c6f6d5;color:#276749;">OK</span>';
                    var isCurrentUser = u.id === currentUser.id;

                    return '<tr' + (isCurrentUser ? ' style="background:#ebf8ff;"' : '') + '>' +
                        '<td><strong>#' + u.id + '</strong></td>' +
                        '<td><strong>' + u.username + '</strong>' + (isCurrentUser ? ' <span style="color:#4299e1;font-size:0.7rem;">(You)</span>' : '') + '</td>' +
                        '<td>' + (u.full_name || '-') + '</td>' +
                        '<td>' + (u.email || '-') + '</td>' +
                        '<td><span class="badge ' + roleClass + '">' + u.role.toUpperCase() + '</span></td>' +
                        '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
                        '<td>' + pwdStatus + '</td>' +
                        '<td>' +
                        (isCurrentUser ?
                            '<span style="color:#718096;font-size:0.75rem;">Current User</span>' :
                            '<button class="btn btn-warning btn-sm" onclick="resetUserPassword(' + u.id + ')" title="Reset Password">üîë</button> ' +
                            '<button class="btn btn-primary btn-sm" onclick="editSystemUser(' + u.id + ')" title="Edit User">‚úèÔ∏è</button> ' +
                            '<button class="btn btn-' + (u.active ? 'danger' : 'success') + ' btn-sm" onclick="toggleUserStatus(' + u.id + ', ' + u.active + ')" title="' + (u.active ? 'Disable' : 'Enable') + '">' + (u.active ? 'üö´' : '‚úÖ') + '</button> ' +
                            (u.role !== 'admin' ? '<button class="btn btn-danger btn-sm" onclick="deleteUser(' + u.id + ')" title="Delete">üóëÔ∏è</button>' : '')
                        ) +
                        '</td>' +
                        '</tr>';
                }).join('');

                document.getElementById('systemUsersTable').innerHTML = html || '<tr><td colspan="8">No users found</td></tr>';

                // Update statistics
                document.getElementById('statTotalUsers').textContent = users.length;
                document.getElementById('statActiveUsers').textContent = users.filter(function (u) { return u.active; }).length;
                document.getElementById('statAdminUsers').textContent = users.filter(function (u) { return u.role === 'admin'; }).length;

                // Update my profile section
                updateMyProfile();
            });
        }

        // Create system user
        function createSystemUser() {
            if (currentUser.role !== 'admin') {
                showAlert('Only admins can create users', 'error');
                return;
            }

            var username = document.getElementById('sysNewUsername').value.trim().toLowerCase();
            var fullName = document.getElementById('sysNewFullName').value.trim();
            var email = document.getElementById('sysNewEmail').value.trim().toLowerCase();
            var role = document.getElementById('sysNewRole').value;

            if (!username) {
                showAlert('Username is required', 'error');
                return;
            }

            if (!fullName) {
                showAlert('Full name is required', 'error');
                return;
            }

            if (!email || !email.includes('@')) {
                showAlert('Valid email is required', 'error');
                return;
            }

            api('/users', {
                method: 'POST',
                body: JSON.stringify({
                    username: username,
                    password: '1234',
                    fullName: fullName,
                    email: email,
                    role: role,
                    active: true
                })
            }).then(function (result) {
                if (result.error) {
                    showAlert(result.error, 'error');
                } else {
                    document.getElementById('sysNewUsername').value = '';
                    document.getElementById('sysNewFullName').value = '';
                    document.getElementById('sysNewEmail').value = '';
                    document.getElementById('sysNewRole').value = 'user';
                    showAlert('User "' + username + '" created successfully! Default password: 1234');
                    loadSystemUsers();
                    loadUsersTable(); // Also refresh the other table
                }
            }).catch(function (err) {
                showAlert('Error: ' + (err.error || err.message), 'error');
            });
        }

        // Edit system user
        function editSystemUser(userId) {
            api('/users').then(function (users) {
                var user = users.find(function (u) { return u.id === userId; });
                if (!user) return;

                var newFullName = prompt('Edit Full Name:', user.full_name || '');
                if (newFullName === null) return;

                var newEmail = prompt('Edit Email:', user.email || '');
                if (newEmail === null) return;

                var newRole = prompt('Edit Role (admin/user/guest):', user.role || 'user');
                if (newRole === null) return;

                if (!['admin', 'user', 'guest'].includes(newRole.toLowerCase())) {
                    showAlert('Invalid role. Use: admin, user, or guest', 'error');
                    return;
                }

                api('/users/' + userId, {
                    method: 'PUT',
                    body: JSON.stringify({
                        username: user.username,
                        fullName: newFullName,
                        email: newEmail,
                        role: newRole.toLowerCase(),
                        active: user.active
                    })
                }).then(function () {
                    showAlert('User updated successfully');
                    loadSystemUsers();
                    loadUsersTable();
                });
            });
        }

        // Update my profile display
        function updateMyProfile() {
            if (currentUser) {
                document.getElementById('myProfileUsername').value = currentUser.username || '';
                document.getElementById('myProfileFullName').value = currentUser.full_name || '';
                document.getElementById('myProfileEmail').value = currentUser.email || '';
                document.getElementById('myProfileRole').value = (currentUser.role || 'user').charAt(0).toUpperCase() + (currentUser.role || 'user').slice(1);
            }
        }

        // Change my password
        function changeMyPassword() {
            var currentPwd = document.getElementById('myCurrentPassword').value;
            var newPwd = document.getElementById('myNewPassword').value;
            var confirmPwd = document.getElementById('myConfirmPassword').value;

            if (!currentPwd) {
                showAlert('Please enter your current password', 'error');
                return;
            }

            if (newPwd.length < 6) {
                showAlert('New password must be at least 6 characters', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showAlert('New passwords do not match', 'error');
                return;
            }

            api('/users/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    userId: currentUser.id,
                    currentPassword: currentPwd,
                    newPassword: newPwd
                })
            }).then(function (result) {
                if (result.success) {
                    document.getElementById('myCurrentPassword').value = '';
                    document.getElementById('myNewPassword').value = '';
                    document.getElementById('myConfirmPassword').value = '';
                    showAlert('Password changed successfully!');
                } else {
                    showAlert(result.error || 'Failed to change password', 'error');
                }
            }).catch(function (err) {
                showAlert('Error: ' + (err.error || 'Current password is incorrect'), 'error');
            });
        }

        // Force all users to reset passwords
        function forceAllPasswordReset() {
            if (currentUser.role !== 'admin') return;

            if (!confirm('This will reset ALL non-admin users\' passwords to "1234" and force them to change on next login. Continue?')) return;

            api('/users').then(function (users) {
                var promises = users
                    .filter(function (u) { return u.role !== 'admin'; })
                    .map(function (u) {
                        return api('/users/' + u.id, {
                            method: 'PUT',
                            body: JSON.stringify({ password: '1234', mustChangePassword: true })
                        });
                    });

                Promise.all(promises).then(function () {
                    showAlert('All non-admin passwords reset to 1234');
                    loadSystemUsers();
                });
            });
        }

        // Export user list as CSV
        function exportUserList() {
            api('/users').then(function (users) {
                var csv = 'ID,Username,Full Name,Email,Role,Status,Created At\n';
                users.forEach(function (u) {
                    csv += u.id + ',' +
                        '"' + u.username + '",' +
                        '"' + (u.full_name || '') + '",' +
                        '"' + (u.email || '') + '",' +
                        u.role + ',' +
                        (u.active ? 'Active' : 'Inactive') + ',' +
                        (u.created_at || '') + '\n';
                });

                var blob = new Blob([csv], { type: 'text/csv' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'users_' + new Date().toISOString().split('T')[0] + '.csv';
                a.click();
                URL.revokeObjectURL(url);
                showAlert('User list exported!');
            });
        }

        // ==================== END SYSTEM SETTINGS FUNCTIONS ====================

        // Reset user password (admin only)
        function resetUserPassword(userId) {
            if (currentUser.role !== 'admin') return;
            if (!confirm('Reset this user\'s password to 1234? They will need to change it on next login.')) return;

            api('/users/' + userId, {
                method: 'PUT',
                body: JSON.stringify({ password: '1234', mustChangePassword: true })
            }).then(function () {
                showAlert('Password reset to 1234. User must change it on next login.');
                loadUsersTable();
                loadSystemUsers();
            });
        }

        // Toggle user status (admin only)
        function toggleUserStatus(userId, currentActive) {
            if (currentUser.role !== 'admin') return;

            api('/users/' + userId, {
                method: 'PUT',
                body: JSON.stringify({ active: !currentActive })
            }).then(function () {
                showAlert('User status updated');
                loadUsersTable();
                loadSystemUsers();
            });
        }

        // Delete user
        function deleteUser(userId) {
            if (currentUser.role !== 'admin') return;
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            api('/users/' + userId, { method: 'DELETE' }).then(function () {
                showAlert('User deleted');
                loadUsersTable();
                loadSystemUsers();
            });
        }

        // Forgot password flow - simplified for demo
        function showForgotPassword() {
            showAlert('Please contact an administrator to reset your password.', 'error');
        }

        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
        }

        function resetPasswordWithCode() {
            var email = document.getElementById('forgotEmail').value.trim().toLowerCase();
            var code = document.getElementById('resetCode').value.trim();
            var newPwd = document.getElementById('newResetPassword').value;
            var confirmPwd = document.getElementById('confirmResetPassword').value;

            if (!code || !newPwd || !confirmPwd) {
                showAlert('Please fill all fields', 'error');
                return;
            }

            if (newPwd.length < 4) {
                showAlert('Password must be at least 4 characters', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            var resetCodes = JSON.parse(localStorage.getItem('resetCodes') || '{}');
            var resetData = resetCodes[email];

            if (!resetData || resetData.code !== code) {
                showAlert('Invalid reset code', 'error');
                return;
            }

            if (Date.now() > resetData.expires) {
                showAlert('Reset code has expired. Please request a new one.', 'error');
                return;
            }

            // Update password via API
            api('/users/' + resetData.userId, {
                method: 'PUT',
                body: JSON.stringify({
                    username: resetData.username,
                    password: newPwd,
                    fullName: resetData.fullName || 'User',
                    role: resetData.role || 'user',
                    active: true
                })
            }).then(function () {
                // Remove used code
                delete resetCodes[email];
                localStorage.setItem('resetCodes', JSON.stringify(resetCodes));

                closeForgotPassword();
                showAlert('Password reset successfully! You can now login.');
            }).catch(function (err) {
                showAlert('Error resetting password: ' + err.message, 'error');
            });
        }

        // Load my account info
        function loadMyAccount() {
            if (currentUser) {
                document.getElementById('myUsername').value = currentUser.username;
                document.getElementById('myEmail').value = currentUser.email || '';
                document.getElementById('myRole').value = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            }
        }

        // Check for existing session on page load
        function checkExistingSession() {
            initializeUsers();

            var session = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (session && session.userId) {
                // Verify session with API - fetch user details
                api('/users').then(function (users) {
                    var user = users.find(function (u) { return u.id === session.userId && u.active; });
                    if (user) {
                        currentUser = user;
                        enterMainApp();
                    } else {
                        // Invalid session, clear it
                        localStorage.removeItem('currentSession');
                        document.getElementById('loginContainer').classList.add('active');
                    }
                }).catch(function () {
                    // API error, show login
                    localStorage.removeItem('currentSession');
                    document.getElementById('loginContainer').classList.add('active');
                });
                return;
            }
            // No valid session, show login
            document.getElementById('loginContainer').classList.add('active');
        }

        // ==================== END AUTHENTICATION SYSTEM ====================

        // Configuration - loaded from PostgreSQL API on startup
        var CONFIG = {
            monthlyRate: 200000,
            taxRate: 0.15,
            months: 3,
            accountNo: '12003 14012 10868895015 89'
        };

        // Load config from API on startup
        function initConfigFromAPI() {
            api('/campost/settings').then(function (settings) {
                if (settings.monthlyRate) CONFIG.monthlyRate = parseInt(settings.monthlyRate);
                if (settings.taxRate) CONFIG.taxRate = parseFloat(settings.taxRate);
                campostSettingsCache = {
                    currency: settings.currency || 'XAF',
                    reservedPercent: parseFloat(settings.reservedFundsPercent) || 10,
                    monthlyRate: CONFIG.monthlyRate,
                    taxRate: CONFIG.taxRate
                };
            });
        }

        // Calculate amounts based on config
        function calcAmounts() {
            var gross = CONFIG.monthlyRate * CONFIG.months;
            var tax = Math.round(gross * CONFIG.taxRate);
            var net = gross - tax;
            return { gross: gross, tax: tax, net: net };
        }

        // Update displayed calculations
        function updateCalcDisplays() {
            var calc = calcAmounts();
            var taxPct = Math.round(CONFIG.taxRate * 100);
            // Settings page
            if (document.getElementById('calcGross')) {
                document.getElementById('calcGross').textContent = fmt(calc.gross) + ' XAF';
                document.getElementById('calcTax').textContent = fmt(calc.tax) + ' XAF';
                document.getElementById('calcNet').textContent = fmt(calc.net) + ' XAF';
            }
            // Bills page
            if (document.getElementById('billShowRate')) {
                document.getElementById('billShowRate').textContent = fmt(CONFIG.monthlyRate);
                document.getElementById('billShowGross').textContent = fmt(calc.gross);
                document.getElementById('billShowTax').textContent = '-' + fmt(calc.tax);
                document.getElementById('billShowNet').textContent = fmt(calc.net);
                if (document.getElementById('billShowTaxPct')) {
                    document.getElementById('billShowTaxPct').textContent = taxPct;
                }
            }
        }

        // Save settings to PostgreSQL
        function saveSettings() {
            var rate = parseInt(document.getElementById('settingMonthlyRent').value);
            var tax = parseFloat(document.getElementById('settingTaxRate').value) / 100;
            var currency = document.getElementById('campostCurrency').value;
            var reservedPercent = document.getElementById('campostReservedPercent').value;

            if (rate < 1000) {
                showAlert('Invalid monthly rate', 'error');
                return;
            }
            CONFIG.monthlyRate = rate;
            CONFIG.taxRate = tax;

            // Save all settings to PostgreSQL via API
            Promise.all([
                api('/campost/settings', { method: 'POST', body: JSON.stringify({ key: 'monthlyRate', value: rate.toString() }) }),
                api('/campost/settings', { method: 'POST', body: JSON.stringify({ key: 'taxRate', value: tax.toString() }) }),
                api('/campost/settings', { method: 'POST', body: JSON.stringify({ key: 'currency', value: currency }) }),
                api('/campost/settings', { method: 'POST', body: JSON.stringify({ key: 'reservedFundsPercent', value: reservedPercent }) })
            ]).then(function () {
                campostSettingsCache = { currency: currency, reservedPercent: parseFloat(reservedPercent), monthlyRate: rate, taxRate: tax };
                updateCalcDisplays();
                showAlert('All settings saved! Currency: ' + currency + ', Reserved: ' + reservedPercent + '%');
            }).catch(function (err) {
                showAlert('Error saving settings: ' + err.message, 'error');
            });
        }

        // Load settings from PostgreSQL API
        function loadSettings() {
            api('/campost/settings').then(function (settings) {
                CONFIG.monthlyRate = parseInt(settings.monthlyRate) || 200000;
                CONFIG.taxRate = parseFloat(settings.taxRate) || 0.15;

                document.getElementById('settingMonthlyRent').value = CONFIG.monthlyRate;
                document.getElementById('settingTaxRate').value = Math.round(CONFIG.taxRate * 100);

                // Load currency and reserved percent
                var currency = settings.currency || 'XAF';
                var reservedPercent = settings.reservedFundsPercent || '10';
                document.getElementById('campostCurrency').value = currency;
                document.getElementById('campostReservedPercent').value = reservedPercent;

                campostSettingsCache = { currency: currency, reservedPercent: parseFloat(reservedPercent), monthlyRate: CONFIG.monthlyRate, taxRate: CONFIG.taxRate };
                updateCalcDisplays();
            }).catch(function () {
                // Use defaults
                document.getElementById('settingMonthlyRent').value = CONFIG.monthlyRate;
                document.getElementById('settingTaxRate').value = Math.round(CONFIG.taxRate * 100);
                document.getElementById('campostCurrency').value = 'XAF';
                document.getElementById('campostReservedPercent').value = '10';
                updateCalcDisplays();
            });
        }

        // Update CAMPOST calc displays with currency
        function updateCampostCalcDisplays() {
            var currency = document.getElementById('campostCurrency').value;
            var gross = CONFIG.monthlyRate * CONFIG.months;
            var tax = Math.round(gross * CONFIG.taxRate);
            var net = gross - tax;
            document.getElementById('calcGross').textContent = fmt(gross) + ' ' + currency;
            document.getElementById('calcTax').textContent = fmt(tax) + ' ' + currency;
            document.getElementById('calcNet').textContent = fmt(net) + ' ' + currency;
        }

        // Add event listeners for real-time calculation in settings
        function setupSettingsListeners() {
            var rateInput = document.getElementById('settingMonthlyRent');
            var taxInput = document.getElementById('settingTaxRate');
            var currencySelect = document.getElementById('campostCurrency');

            if (rateInput) {
                rateInput.addEventListener('input', function () {
                    var currency = currencySelect ? currencySelect.value : 'XAF';
                    var tempRate = parseInt(this.value) || 0;
                    var tempTax = parseFloat(taxInput.value) / 100 || 0.15;
                    var gross = tempRate * CONFIG.months;
                    var tax = Math.round(gross * tempTax);
                    var net = gross - tax;
                    document.getElementById('calcGross').textContent = fmt(gross) + ' ' + currency;
                    document.getElementById('calcTax').textContent = fmt(tax) + ' ' + currency;
                    document.getElementById('calcNet').textContent = fmt(net) + ' ' + currency;
                });
            }
            if (taxInput) {
                taxInput.addEventListener('input', function () {
                    var currency = currencySelect ? currencySelect.value : 'XAF';
                    var tempRate = parseInt(rateInput.value) || CONFIG.monthlyRate;
                    var tempTax = parseFloat(this.value) / 100 || 0.15;
                    var gross = tempRate * CONFIG.months;
                    var tax = Math.round(gross * tempTax);
                    var net = gross - tax;
                    document.getElementById('calcGross').textContent = fmt(gross) + ' ' + currency;
                    document.getElementById('calcTax').textContent = fmt(tax) + ' ' + currency;
                    document.getElementById('calcNet').textContent = fmt(net) + ' ' + currency;
                });
            }
        }

        var QUARTERS = {
            'Q1': { period: 'January to March', months: 'Jan-Mar', shortPeriod: 'Q1 (Jan-Mar)' },
            'Q2': { period: 'April to June', months: 'Apr-Jun', shortPeriod: 'Q2 (Apr-Jun)' },
            'Q3': { period: 'July to September', months: 'Jul-Sep', shortPeriod: 'Q3 (Jul-Sep)' },
            'Q4': { period: 'October to December', months: 'Oct-Dec', shortPeriod: 'Q4 (Oct-Dec)' }
        };

        function fmt(n) {
            return n ? Math.abs(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
        }



        function getCurrency() {
            var settings = getCampostSettings();
            return settings.currency || 'XAF';
        }

        function fmtCurrency(n) {
            return fmt(n) + ' ' + getCurrency();
        }

        function fmtDate(d) {
            return new Date(d).toLocaleDateString();
        }

        function formatDateLong(d) {
            var date = new Date(d);
            var day = date.getDate();
            var suffix = (day === 1 || day === 21 || day === 31) ? 'st' : (day === 2 || day === 22) ? 'nd' : (day === 3 || day === 23) ? 'rd' : 'th';
            var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return day + suffix + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
        }

        function today() {
            return new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function calculateFaraidJS(netEstate, heirs) {
            var results = { heirs: [], baseNumber: 24, totalFixedParts: 0, residueParts: 0, notes: [] };
            if (!heirs || heirs.length === 0) return results;

            // Normalize relationships based on group/gender
            var normalizedHeirs = heirs.map(function (h) {
                var rel = h.relationship;
                if (rel === 'Child' || rel === 'Children') {
                    if (h.heir_group === 'Sons') rel = 'Son';
                    else if (h.heir_group === 'Daughters') rel = 'Daughter';
                } else if (rel === 'Spouse') {
                    if (h.heir_group === 'Wives' || h.gender === 'Female') rel = 'Wife';
                    else if (h.gender === 'Male') rel = 'Husband';
                }
                return Object.assign({}, h, { relationship: rel });
            });

            var countRel = function (rel) { return normalizedHeirs.filter(function (h) { return h.relationship === rel; }).length; };
            var findHeir = function (rel) { return normalizedHeirs.find(function (h) { return h.relationship === rel; }); };

            var hasSons = countRel('Son') > 0;
            var hasDaughters = countRel('Daughter') > 0;
            var hasGrandSons = countRel('Grandson') > 0;
            var hasGrandDaughters = countRel('Granddaughter') > 0;
            var hasDescendants = hasSons || hasDaughters || hasGrandSons || hasGrandDaughters;

            var hasFather = !!findHeir('Father');
            var hasMother = !!findHeir('Mother');
            var hasGrandfather = !!findHeir('Grandfather');

            var siblingCount = normalizedHeirs.filter(function (h) {
                return ['Full Brother', 'Full Sister', 'Consanguine Brother', 'Consanguine Sister', 'Uterine Brother', 'Uterine Sister', 'Brother', 'Sister'].includes(h.relationship);
            }).length;

            var excludedIds = new Set();
            normalizedHeirs.forEach(function (h) {
                if (hasSons && ['Grandson', 'Granddaughter', 'Brother', 'Sister', 'Full Brother', 'Full Sister', 'Consanguine Brother', 'Consanguine Sister', 'Uterine Brother', 'Uterine Sister'].includes(h.relationship)) excludedIds.add(h.id);
                if (hasFather && ['Grandfather', 'Brother', 'Sister', 'Full Brother', 'Full Sister', 'Consanguine Brother', 'Consanguine Sister', 'Uterine Brother', 'Uterine Sister'].includes(h.relationship)) excludedIds.add(h.id);
                if ((hasDescendants || hasFather || hasGrandfather) && ['Uterine Brother', 'Uterine Sister'].includes(h.relationship)) excludedIds.add(h.id);
            });

            var activeHeirs = normalizedHeirs.filter(function (h) { return !excludedIds.has(h.id); });
            var lcd = 24;
            var partsMap = {};
            var shareLabels = {};

            activeHeirs.forEach(function (h) {
                var parts = 0;
                var label = '';
                if (h.relationship === 'Wife') {
                    parts = (hasDescendants ? 3 : 6) / countRel('Wife');
                    label = hasDescendants ? '1/8 (Shared)' : '1/4 (Shared)';
                } else if (h.relationship === 'Husband') {
                    parts = hasDescendants ? 6 : 12;
                    label = hasDescendants ? '1/4' : '1/2';
                } else if (h.relationship === 'Mother') {
                    parts = (hasDescendants || siblingCount >= 2) ? 4 : 8;
                    label = (hasDescendants || siblingCount >= 2) ? '1/6' : '1/3';
                } else if (h.relationship === 'Father' && hasDescendants) {
                    parts = 4;
                    label = '1/6 (Fixed)';
                } else if (h.relationship === 'Daughter' && !hasSons) {
                    var dCount = countRel('Daughter');
                    parts = (dCount === 1 ? 12 : 16) / dCount;
                    label = dCount === 1 ? '1/2' : '2/3 (Shared)';
                }

                if (parts > 0) {
                    partsMap[h.id] = parts;
                    shareLabels[h.id] = label;
                }
            });

            var totalFixedParts = 0;
            for (var id in partsMap) totalFixedParts += partsMap[id];

            var residueParts = Math.max(0, lcd - totalFixedParts);
            var residuaries = activeHeirs.filter(function (h) {
                if (h.relationship === 'Son') return true;
                if (h.relationship === 'Daughter' && hasSons) return true;
                if (h.relationship === 'Father' && !hasSons && !hasGrandSons) return true;
                if (h.relationship === 'Full Brother') return true;
                return false;
            });

            if (residueParts > 0 && residuaries.length > 0) {
                var totalUnits = 0;
                residuaries.forEach(function (r) {
                    var weight = (r.relationship === 'Son' || r.relationship === 'Father' || r.relationship === 'Full Brother') ? 2 : 1;
                    r.asabahWeight = weight;
                    totalUnits += weight;
                });
                residuaries.forEach(function (r) {
                    var rShare = (r.asabahWeight / totalUnits) * residueParts;
                    partsMap[r.id] = (partsMap[r.id] || 0) + rShare;
                    var existingLabel = shareLabels[r.id];
                    shareLabels[r.id] = existingLabel ? existingLabel + ' + Residue' : 'Residue (' + r.asabahWeight + '/' + totalUnits + ')';
                });
            }

            if (totalFixedParts > lcd) {
                lcd = totalFixedParts;
            } else if (totalFixedParts < lcd && residuaries.length === 0) {
                var raddHeirs = activeHeirs.filter(function (h) { return h.relationship !== 'Wife' && h.relationship !== 'Husband'; });
                if (raddHeirs.length > 0) {
                    var raddTotalParts = 0;
                    raddHeirs.forEach(function (h) { raddTotalParts += (partsMap[h.id] || 0); });
                    var remaining = lcd - totalFixedParts;
                    raddHeirs.forEach(function (h) {
                        var add = (partsMap[h.id] / raddTotalParts) * remaining;
                        partsMap[h.id] = (partsMap[h.id] || 0) + add;
                    });
                }
            }

            results.baseNumber = lcd;
            activeHeirs.forEach(function (h) {
                var parts = partsMap[h.id] || 0;
                results.heirs.push({
                    name: h.name,
                    relationship: h.relationship,
                    fraction: shareLabels[h.id] || 'Excluded',
                    parts: Math.round(parts * 100) / 100,
                    sharePercentage: Math.round((parts / lcd) * 100 * 100) / 100,
                    shareAmount: (parts / lcd) * netEstate
                });
            });
            return results;
        }

        function numberToWords(n) {
            var ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            var tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            if (n < 20) return ones[n];
            if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
            if (n < 1000) return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' and ' + numberToWords(n % 100) : '');
            if (n < 1000000) return numberToWords(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 ? ' ' + numberToWords(n % 1000) : '');
            return numberToWords(Math.floor(n / 1000000)) + ' Million' + (n % 1000000 ? ' ' + numberToWords(n % 1000000) : '');
        }

        function showAlert(msg, type) {
            type = type || 'success';
            var el = document.createElement('div');
            el.className = 'alert alert-' + type;
            el.innerHTML = msg;
            document.getElementById('alertBox').appendChild(el);
            setTimeout(function () { el.remove(); }, 2500);
        }

        function api(url, opts) {
            opts = opts || {};
            return fetch(API + url, {
                headers: { 'Content-Type': 'application/json' },
                method: opts.method || 'GET',
                body: opts.body
            }).then(function (res) {
                return res.json().then(function (data) {
                    if (!res.ok) {
                        return Promise.reject(data);
                    }
                    return data;
                });
            });
        }

        // Tabs
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(function (t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-btn').forEach(function (b) { b.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        // Current active module
        var currentModule = 'landing';

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                var page = this.dataset.page;
                if (!page) return; // Skip buttons without data-page (like Home buttons with onclick)

                // Update active states within current nav
                var currentNav = this.closest('.nav');
                currentNav.querySelectorAll('.nav-btn').forEach(function (b) { b.classList.remove('active'); });
                this.classList.add('active');

                // Hide all pages and show selected
                document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });
                document.getElementById(page).classList.add('active');

                loadPage(page);
            });
        });

        // Open a module (CAMPOST)
        function openModule(module) {
            currentModule = module;

            // Hide all navs and pages
            document.querySelectorAll('.nav').forEach(function (n) { n.style.display = 'none'; });
            document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });

            if (module === 'campost') {
                // Show CAMPOST nav and dashboard
                document.getElementById('campostNav').style.display = 'flex';
                document.getElementById('campost-dashboard').classList.add('active');
                document.getElementById('mainTitle').textContent = 'CAMPOST MANKON';
                document.getElementById('mainSubtitle').textContent = 'Property & Billing Management';
                document.querySelector('.logo-icon').textContent = 'CP';
                loadDashboard();
            }
        }

        // Go back to landing page
        function goToLanding() {
            currentModule = 'landing';

            // Hide all navs
            document.querySelectorAll('.nav').forEach(function (n) { n.style.display = 'none'; });

            // Show main nav and landing page
            document.getElementById('mainNav').style.display = 'flex';
            document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });
            document.getElementById('landing').classList.add('active');

            // Reset header
            document.getElementById('mainTitle').textContent = 'CAMPOST MANKON';
            document.getElementById('mainSubtitle').textContent = 'Property & Billing Management System';
            document.querySelector('.logo-icon').textContent = 'CP';

            // Load landing page stats
            loadLandingStats();
        }

        // Load landing page statistics
        function loadLandingStats() {
            // CAMPOST stats
            api('/bills').then(function (bills) {
                var campostIncome = 0;
                bills.forEach(function (b) { if (b.paidAmount > 0) campostIncome += b.paidAmount; });
                document.getElementById('landingCampostIncome').textContent = fmt(campostIncome);

                api('/expenses').then(function (expenses) {
                    var campostExpenses = 0;
                    expenses.forEach(function (e) { campostExpenses += e.amount; });
                    document.getElementById('landingCampostExpenses').textContent = fmt(campostExpenses);
                    document.getElementById('landingCampostBalance').textContent = fmt(campostIncome - campostExpenses);

                });
            });
        }

        function loadPage(p) {
            // CAMPOST pages
            if (p === 'campost-dashboard') loadDashboard();
            else if (p === 'campost-ledger') loadLedger();
            else if (p === 'campost-expenses') loadExpenses();
            else if (p === 'campost-bills') { loadBills(); updateCalcDisplays(); }
            else if (p === 'campost-payments') loadPayments();
            else if (p === 'campost-receipts') loadCampostReceipts();
            else if (p === 'campost-inheritance') loadInheritance();
            else if (p === 'campost-settings') { loadSettings(); setupSettingsListeners(); checkDb(); }
            // System Settings (login management)
            else if (p === 'system-settings') { loadSystemUsers(); updateMyProfile(); }
            // Main settings (user management)
            else if (p === 'main-settings') { loadMyAccount(); loadUsersTable(); }
            // Landing
            else if (p === 'landing') loadLandingStats();
        }

        // Dashboard
        // Get CAMPOST settings - cached in memory, loaded from API
        var campostSettingsCache = null;
        function getCampostSettings() {
            if (campostSettingsCache) return campostSettingsCache;
            return {
                currency: 'XAF',
                reservedPercent: 10
            };
        }

        function loadCampostSettingsFromAPI() {
            return api('/campost/settings').then(function (settings) {
                campostSettingsCache = {
                    currency: settings.currency || 'XAF',
                    reservedPercent: parseFloat(settings.reservedFundsPercent) || 10,
                    monthlyRate: parseInt(settings.monthlyRate) || 200000,
                    taxRate: parseFloat(settings.taxRate) || 0.15
                };
                CONFIG.monthlyRate = campostSettingsCache.monthlyRate;
                CONFIG.taxRate = campostSettingsCache.taxRate;
                return campostSettingsCache;
            }).catch(function () {
                campostSettingsCache = { currency: 'XAF', reservedPercent: 10 };
                return campostSettingsCache;
            });
        }

        function loadDashboard() {
            var settings = getCampostSettings();
            var currency = settings.currency;
            var reservedPercent = settings.reservedPercent;

            // Get total income from bills (paid amounts from bills with paid or partial status)
            api('/bills').then(function (bills) {
                var totalIncome = 0;
                bills.forEach(function (b) {
                    // Include paid amount from bills that have any payment (paid or partial)
                    if (b.paidAmount > 0) {
                        totalIncome += b.paidAmount;
                    }
                });
                document.getElementById('dashIncome').textContent = fmt(totalIncome);
                document.getElementById('dashIncomeSum').textContent = fmt(totalIncome) + ' ' + currency;

                // Get expenses
                api('/expenses').then(function (expenses) {
                    var totalExpenses = 0;
                    expenses.forEach(function (e) {
                        totalExpenses += e.amount;
                    });
                    document.getElementById('dashExp').textContent = fmt(totalExpenses);
                    document.getElementById('dashExpSum').textContent = fmt(totalExpenses) + ' ' + currency;

                    // Calculate reserved funds = percentage of income
                    var reservedFunds = Math.round(totalIncome * reservedPercent / 100);
                    document.getElementById('dashReserve').textContent = fmt(reservedFunds);
                    document.getElementById('dashReserveSum').textContent = fmt(reservedFunds) + ' ' + currency;
                    document.getElementById('dashReservePercent').textContent = reservedPercent;

                    // Calculate net balance = Income - Expenses - Reserved (minimum 0)
                    var netBalance = Math.max(0, totalIncome - totalExpenses - reservedFunds);
                    document.getElementById('dashNetBalance').textContent = fmt(netBalance);
                    document.getElementById('dashNetBalanceSum').textContent = fmt(netBalance) + ' ' + currency;

                    // Update expense form state
                    updateCampostExpenseFormState(netBalance);
                });
            });

            // Get inheritance amount
            api('/inheritance/calculate').then(function (d) {
                document.getElementById('dashInh').textContent = fmt(d.inheritanceAmount);
                document.getElementById('dashInhSum').textContent = fmt(d.inheritanceAmount) + ' ' + currency;
            });
        }

        // Enable/Disable CAMPOST expense form based on net balance
        function updateCampostExpenseFormState(netBalance) {
            var expenseFields = ['expDate', 'expDesc', 'expCat', 'expAmt'];
            var saveBtn = document.getElementById('campostSaveExpenseBtn');
            var warningEl = document.getElementById('campostExpenseWarning');

            if (netBalance <= 0) {
                // Disable all expense input fields
                expenseFields.forEach(function (id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.disabled = true;
                        el.style.backgroundColor = '#f0f0f0';
                        el.style.cursor = 'not-allowed';
                    }
                });

                // Disable save button
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.5';
                    saveBtn.style.cursor = 'not-allowed';
                }

                // Show warning message
                if (warningEl) {
                    warningEl.style.display = 'block';
                }
            } else {
                // Enable all expense input fields
                expenseFields.forEach(function (id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.disabled = false;
                        el.style.backgroundColor = '';
                        el.style.cursor = '';
                    }
                });

                // Enable save button
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = '';
                }

                // Hide warning message
                if (warningEl) {
                    warningEl.style.display = 'none';
                }
            }
        }

        // Ledger - combines income (from bills paid/partial) and expenses
        function loadLedger() {
            Promise.all([api('/bills'), api('/expenses')]).then(function (results) {
                var bills = results[0];
                var expenses = results[1];

                // Combine into ledger entries
                var ledgerEntries = [];

                // Add bills with payments as income (paid or partial status)
                bills.forEach(function (b) {
                    if (b.paidAmount > 0) {
                        var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                        ledgerEntries.push({
                            date: b.createdAt || new Date().toISOString(),
                            description: 'Bill ' + b.billNumber + ' - ' + b.period + ' ' + b.year + ' (' + status + ')',
                            type: 'Income',
                            income: b.paidAmount,
                            expense: 0,
                            status: status
                        });
                    }
                });

                // Add expenses
                expenses.forEach(function (e) {
                    ledgerEntries.push({
                        date: e.date,
                        description: e.description,
                        type: e.categoryName,
                        income: 0,
                        expense: e.amount,
                        category: e.categoryName
                    });
                });

                // Sort by date
                ledgerEntries.sort(function (a, b) {
                    return new Date(a.date) - new Date(b.date);
                });

                // Calculate running balance and totals
                var runningBalance = 0;
                var totalIncome = 0;
                var totalExpense = 0;

                var tableHtml = '';
                ledgerEntries.forEach(function (entry) {
                    if (entry.income > 0) {
                        runningBalance += entry.income;
                        totalIncome += entry.income;
                    }
                    if (entry.expense > 0) {
                        runningBalance -= entry.expense;
                        totalExpense += entry.expense;
                    }

                    var isInheritance = entry.type === 'Inheritance Share';
                    var isIncome = entry.income > 0;
                    tableHtml += '<tr>' +
                        '<td>' + fmtDate(entry.date) + '</td>' +
                        '<td>' + entry.description + '</td>' +
                        '<td><span class="badge ' + (isIncome ? 'badge-income' : isInheritance ? 'badge-inheritance' : 'badge-expense') + '">' + entry.type + (entry.status ? ' (' + entry.status + ')' : '') + '</span></td>' +
                        '<td class="amount-positive">' + (entry.income > 0 ? fmt(entry.income) : '-') + '</td>' +
                        '<td class="' + (isInheritance ? 'amount-gold' : 'amount-negative') + '">' + (entry.expense > 0 ? fmt(entry.expense) : '-') + '</td>' +
                        '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(runningBalance) + '</td>' +
                        '</tr>';
                });

                document.getElementById('ledgerTable').innerHTML = tableHtml || '<tr><td colspan="6">No transactions</td></tr>';

                // Calculate reserved funds and net balance
                var settings = getCampostSettings();
                var currency = settings.currency;
                var reservedPercent = settings.reservedPercent;
                var reservedFunds = Math.round(totalIncome * reservedPercent / 100);
                var netBalance = Math.max(0, runningBalance - reservedFunds);

                // Totals footer with 3 rows
                document.getElementById('ledgerTotals').innerHTML =
                    '<tr style="background: #f7fafc; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right;">SUBTOTAL (' + currency + '):</td>' +
                    '<td class="amount-positive">' + fmt(totalIncome) + '</td>' +
                    '<td class="amount-negative">' + fmt(totalExpense) + '</td>' +
                    '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(runningBalance) + '</td>' +
                    '</tr>' +
                    '<tr style="background: #fed7d7; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right; color: #c53030;">üè¶ Reserved Funds (' + reservedPercent + '% of Income):</td>' +
                    '<td></td>' +
                    '<td style="color: #c53030;">-' + fmt(reservedFunds) + '</td>' +
                    '<td></td>' +
                    '</tr>' +
                    '<tr style="background: #fc8181; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right; color: #742a2a;">üìä NET BALANCE:</td>' +
                    '<td></td>' +
                    '<td></td>' +
                    '<td style="color: #742a2a;">' + fmt(netBalance) + '</td>' +
                    '</tr>';

                // Update stats
                document.getElementById('ledgerIncome').textContent = fmt(totalIncome);
                document.getElementById('ledgerExpense').textContent = fmt(totalExpense);
                document.getElementById('ledgerReserved').textContent = fmt(reservedFunds);
                document.getElementById('ledgerNetBalance').textContent = fmt(netBalance);
            });
        }

        // Expenses
        function loadExpenses() {
            var settings = getCampostSettings();
            var currency = settings.currency;

            api('/categories').then(function (cats) {
                document.getElementById('expCat').innerHTML = cats.map(function (c) {
                    return '<option value="' + c.id + '">' + c.name + '</option>';
                }).join('');
            });
            if (!document.getElementById('expDate').value) {
                document.getElementById('expDate').valueAsDate = new Date();
            }
            api('/expenses').then(function (expenses) {
                var totalExp = 0;
                var html = expenses.map(function (e) {
                    var isInh = e.categoryName === 'Inheritance Share';
                    totalExp += e.amount;
                    return '<tr><td>' + fmtDate(e.date) + '</td><td>' + e.description + '</td><td>' + e.categoryName + '</td><td class="' + (isInh ? 'amount-gold' : 'amount-negative') + '">-' + fmt(e.amount) + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editExpense(' + e.id + ')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteExpense(' + e.id + ')">üóëÔ∏è</button></td></tr>';
                }).join('') || '<tr><td colspan="5">No expenses</td></tr>';

                document.getElementById('expTable').innerHTML = html;

                // Add totals row
                var totalsEl = document.getElementById('expTotals');
                if (totalsEl) {
                    totalsEl.innerHTML = '<tr style="background: #f7fafc; font-weight: bold;">' +
                        '<td colspan="3" style="text-align: right;">TOTAL (' + currency + '):</td>' +
                        '<td class="amount-negative">' + fmt(totalExp) + '</td>' +
                        '<td></td></tr>';
                }
            });
        }

        function editExpense(id) {
            api('/expenses').then(function (expenses) {
                var e = expenses.find(function (x) { return x.id === id; });
                if (e) {
                    document.getElementById('expId').value = id;
                    document.getElementById('expDate').value = e.date.split('T')[0];
                    document.getElementById('expDesc').value = e.description;
                    document.getElementById('expCat').value = e.categoryId;
                    document.getElementById('expAmt').value = e.amount;
                }
            });
        }

        function saveExpense() {
            var id = document.getElementById('expId').value;
            var data = {
                date: document.getElementById('expDate').value,
                description: document.getElementById('expDesc').value,
                categoryId: document.getElementById('expCat').value,
                amount: parseInt(document.getElementById('expAmt').value)
            };
            if (!data.date || !data.description || !data.amount) {
                showAlert('Fill all fields', 'error');
                return;
            }

            // Check net balance before saving (only for new expenses)
            if (!id) {
                var settings = getCampostSettings();
                var reservedPercent = settings.reservedPercent;

                // Get current totals
                Promise.all([api('/bills'), api('/expenses')]).then(function (results) {
                    var bills = results[0];
                    var expenses = results[1];

                    var totalIncome = 0;
                    bills.forEach(function (b) { if (b.paidAmount > 0) totalIncome += b.paidAmount; });

                    var totalExpenses = 0;
                    expenses.forEach(function (e) { totalExpenses += e.amount; });

                    var reservedFunds = Math.round(totalIncome * reservedPercent / 100);
                    var currentNetBalance = totalIncome - totalExpenses - reservedFunds;

                    if (currentNetBalance <= 0) {
                        showAlert('Cannot add expense: Net Balance is zero. Add more income first.', 'error');
                        return;
                    }

                    if (data.amount > currentNetBalance) {
                        showAlert('Cannot add expense: Amount (' + fmt(data.amount) + ') exceeds available Net Balance (' + fmt(currentNetBalance) + ')', 'error');
                        return;
                    }

                    // Proceed with save
                    doSaveExpense(null, data);
                });
            } else {
                // Editing existing expense - just save
                doSaveExpense(id, data);
            }
        }

        function doSaveExpense(id, data) {
            var url = id ? '/expenses/' + id : '/expenses';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function () {
                showAlert(id ? 'Updated!' : 'Saved!');
                clearExpenseForm();
                loadExpenses();
                loadDashboard();
            });
        }

        function deleteExpense(id) {
            if (!confirm('Delete?')) return;
            api('/expenses/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Deleted');
                loadExpenses();
            });
        }

        function clearExpenseForm() {
            document.getElementById('expId').value = '';
            document.getElementById('expDesc').value = '';
            document.getElementById('expAmt').value = '';
        }

        // Bills
        function loadBills() {
            var yearSel = document.getElementById('billY');
            if (yearSel.options.length === 0) {
                for (var y = 2022; y <= 2035; y++) {
                    yearSel.innerHTML += '<option value="' + y + '">' + y + '</option>';
                }
                yearSel.value = new Date().getFullYear();
            }
            updateBillNumber();
            api('/bills').then(function (bills) {
                document.getElementById('billTable').innerHTML = bills.map(function (b) {
                    return '<tr class="clickable" onclick="viewBill(\'' + b.billNumber + '\')"><td><strong>' + b.billNumber + '</strong>' + (b.isNew ? ' <span class="badge badge-new">NEW</span>' : '') + '</td><td>' + b.period + ' ' + b.year + '</td><td>' + fmt(b.amountDue) + '</td><td class="amount-positive">' + fmt(b.paidAmount) + '</td><td class="' + (b.outstanding > 0 ? 'amount-negative' : '') + '">' + fmt(b.outstanding) + '</td><td><span class="badge badge-' + (b.outstanding === 0 ? 'paid' : b.paidAmount > 0 ? 'partial' : 'unpaid') + '">' + (b.outstanding === 0 ? 'Paid' : b.paidAmount > 0 ? 'Partial' : 'Unpaid') + '</span></td><td class="no-print" onclick="event.stopPropagation()"><button class="btn btn-warning btn-sm" onclick="editBill(\'' + b.billNumber + '\')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteBill(\'' + b.billNumber + '\')">üóëÔ∏è</button></td></tr>';
                }).join('');
            });
        }

        function updateBillNumber() {
            var q = document.getElementById('billQ').value;
            var y = document.getElementById('billY').value;
            var n = q === 'Q1' ? 1 : q === 'Q2' ? 2 : q === 'Q3' ? 3 : 4;
            document.getElementById('billNum').value = q + '-' + y + '-00' + n;
        }

        document.getElementById('billQ').addEventListener('change', updateBillNumber);
        document.getElementById('billY').addEventListener('change', updateBillNumber);

        function editBill(bn) {
            api('/bills').then(function (bills) {
                var b = bills.find(function (x) { return x.billNumber === bn; });
                if (b) {
                    document.getElementById('billEditMode').value = 'edit';
                    document.getElementById('billOldNumber').value = bn;
                    document.getElementById('billQ').value = b.quarter;
                    document.getElementById('billY').value = b.year;
                    document.getElementById('billP').value = b.period;
                    updateBillNumber();
                    updateCalcDisplays();
                }
            });
        }

        function saveBill() {
            var em = document.getElementById('billEditMode').value;
            var old = document.getElementById('billOldNumber').value;
            var q = document.getElementById('billQ').value;
            var y = parseInt(document.getElementById('billY').value);
            var p = document.getElementById('billP').value;
            var calc = calcAmounts();
            var amountDue = calc.net; // Use calculated net amount from CONFIG
            var bn = document.getElementById('billNum').value;

            if (em === 'edit') {
                api('/bills/' + old, { method: 'PUT', body: JSON.stringify({ quarter: q, year: y, period: p, amountDue: amountDue }) }).then(function () {
                    showAlert('Updated!');
                    clearBillForm();
                    loadBills();
                    loadDashboard();
                });
            } else {
                api('/bills', { method: 'POST', body: JSON.stringify({ billNumber: bn, quarter: q, year: y, period: p, amountDue: amountDue, paidAmount: 0, outstanding: amountDue, isNew: true }) }).then(function () {
                    showAlert('Created!');
                    clearBillForm();
                    loadBills();
                    loadDashboard();
                });
            }
        }

        function deleteBill(bn) {
            if (!confirm('Delete ' + bn + '?')) return;
            api('/bills/' + bn, { method: 'DELETE' }).then(function () {
                showAlert('Deleted');
                loadBills();
                loadDashboard();
            });
        }

        function clearBillForm() {
            document.getElementById('billEditMode').value = '';
            document.getElementById('billOldNumber').value = '';
            document.getElementById('billY').value = new Date().getFullYear();
            updateBillNumber();
            updateCalcDisplays();
        }

        // View Bill as Invoice
        function viewBill(bn) {
            api('/bills/' + bn).then(function (b) {
                var rate = CONFIG.monthlyRate; // Monthly rate from settings
                var grossAmount = rate * CONFIG.months; // Quarterly gross
                var taxPercent = Math.round(CONFIG.taxRate * 100); // Tax percentage for display
                var taxAmount = Math.round(grossAmount * CONFIG.taxRate); // Tax amount
                var netAmount = grossAmount - taxAmount; // Net amount due per quarter
                var advancePayment = b.paidAmount;
                var totalDue = netAmount - advancePayment; // Outstanding after payments
                var qInfo = QUARTERS[b.quarter] || { months: b.period };
                var paymentNum = b.quarter === 'Q1' ? 1 : b.quarter === 'Q2' ? 2 : b.quarter === 'Q3' ? 3 : 4;
                var billDate = b.createdAt ? formatDateLong(b.createdAt) : formatDateLong(new Date());

                var invoiceHtml = '<div id="invoicePrint" style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto;">' +
                    '<div style="text-align: center; background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0;">' +
                    '<h1 style="margin: 0; font-size: 24px;">GHOUENZEN Soulemanou</h1>' +
                    '<p style="margin: 5px 0 0; font-size: 14px;">B.P 36 Mankon-Bamenda</p>' +
                    '<p style="margin: 3px 0 0; font-size: 14px;">Tel: 675299868</p>' +
                    '<p style="margin: 3px 0 0; font-size: 12px;">Account No. ' + CONFIG.accountNo + '</p>' +
                    '</div>' +
                    '<div style="border: 1px solid #ddd; border-top: none; padding: 20px;">' +
                    '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                    '<tr style="background: #2c5282; color: white;"><td colspan="4" style="padding: 8px; text-align: center; font-weight: bold;">BILLING PERIOD SELECTION</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 25%;">Billing Period:</td><td colspan="3" style="padding: 8px; border: 1px solid #ddd;">' + b.period + '</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Year:</td><td style="padding: 8px; border: 1px solid #ddd;">' + b.year + '</td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Quarter:</td><td style="padding: 8px; border: 1px solid #ddd; background: #2c5282; color: white; text-align: center;">' + b.quarter + '</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Payment Number:</td><td style="padding: 8px; border: 1px solid #ddd;">' + paymentNum + '</td><td colspan="2"></td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Bill Date:</td><td colspan="3" style="padding: 8px; border: 1px solid #ddd;">' + billDate + '</td></tr>' +
                    '</table>' +
                    '<div style="background: #38a169; color: white; text-align: center; padding: 8px; font-weight: bold;">GENERATED BILL NUMBER</div>' +
                    '<div style="background: #c6f6d5; text-align: center; padding: 15px; font-size: 22px; font-weight: bold; color: #276749; border: 2px solid #38a169;">BILL NO.' + b.billNumber + '</div>' +
                    '<div style="margin: 20px 0; font-style: italic;">' +
                    '<p><strong>The General Manager,</strong></p>' +
                    '<p>Cameroon Postal Services</p>' +
                    '<p>B.P 1441 Yaound√©.</p>' +
                    '</div>' +
                    '<p style="margin: 20px 0;"><strong>Sir,</strong></p>' +
                    '<p style="margin-bottom: 20px;">In accordance with the contract de bail No.00000/9/MTP/G10 of 18th April 1991, I hereby present the rent bill for period of:</p>' +
                    '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                    '<tr style="background: #2c5282; color: white;"><td colspan="2" style="padding: 10px; text-align: center; font-weight: bold;">BILL DETAILS</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 35%;">Bill Date</td><td style="padding: 8px; border: 1px solid #ddd;">' + billDate + '</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Tenant Name</td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">CAMPOST MANKON</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Property Address</td><td style="padding: 8px; border: 1px solid #ddd;">B.P 36 Mankon-Bamenda</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Bill Number</td><td style="padding: 8px; border: 1px solid #ddd; background: #ebf8ff; color: #2c5282; font-weight: bold;">' + b.billNumber + '</td></tr>' +
                    '</table>' +
                    '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                    '<tr style="background: #d69e2e; color: white;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Description</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Qty (months)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Rate (XAF)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Amount (XAF)</th></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd;">Rent for ' + b.quarter + ' (' + qInfo.months + ')</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">' + CONFIG.months + '</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + fmt(rate) + '</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + fmt(grossAmount) + '</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd;">Less ' + taxPercent + '% Tax</td><td style="padding: 8px; border: 1px solid #ddd;"></td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + taxPercent + '%</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #e53e3e;">-' + fmt(taxAmount) + '</td></tr>' +
                    '<tr style="background: #f7fafc;"><td colspan="3" style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Net Amount (After Tax)</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">' + fmt(netAmount) + '</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd;">Less Advance Payment</td><td colspan="2" style="padding: 8px; border: 1px solid #ddd;"></td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #38a169;">-' + fmt(advancePayment) + '</td></tr>' +
                    '<tr style="background: #2c5282; color: white;"><td colspan="3" style="padding: 10px; font-weight: bold; text-align: center;">TOTAL AMOUNT DUE</td><td style="padding: 10px; text-align: right; font-weight: bold; font-size: 18px;">' + fmt(totalDue) + '</td></tr>' +
                    '</table>' +
                    '<p style="text-align: center; color: #e53e3e; font-style: italic; font-weight: bold;">(' + numberToWords(netAmount) + ' francs CFA.)</p>' +
                    '<div style="margin-top: 40px;">' +
                    '<p><strong>Signature:</strong></p>' +
                    '<div style="margin-top: 10px; border-bottom: 1px solid #333; width: 200px; height: 50px;"></div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="btn-group no-print" style="margin-top: 15px;">' +
                    '<button class="btn btn-primary" onclick="printInvoice()">üñ®Ô∏è Print Invoice</button>' +
                    '<button class="btn btn-outline" onclick="closeBillModal()">Close</button>' +
                    '</div>';

                document.getElementById('billModalBody').innerHTML = invoiceHtml;
                document.getElementById('billModal').classList.add('active');
            });
        }

        function closeBillModal() {
            document.getElementById('billModal').classList.remove('active');
        }

        function printInvoice() {
            var content = document.getElementById('invoicePrint').innerHTML;
            var w = window.open('', '_blank');
            w.document.write('<html><head><title>Rent Invoice</title><style>body{font-family:Arial,sans-serif;padding:20px;margin:0;}table{width:100%;border-collapse:collapse;}td,th{padding:8px;border:1px solid #ddd;}@media print{body{padding:10px;}}</style></head><body>' + content + '</body></html>');
            w.document.close();
            w.print();
        }

        // Payments
        function loadPayments() {
            api('/bills').then(function (bills) {
                document.getElementById('payBill').innerHTML = '<option value="">-- Select --</option>' + bills.map(function (b) {
                    return '<option value="' + b.billNumber + '">' + b.billNumber + ' - ' + b.period + ' ' + b.year + ' (' + fmt(b.outstanding) + ' due)</option>';
                }).join('');
            });
            if (!document.getElementById('payDate').value) {
                document.getElementById('payDate').valueAsDate = new Date();
            }
            api('/payments').then(function (payments) {
                document.getElementById('payTable').innerHTML = payments.map(function (p) {
                    return '<tr><td>' + fmtDate(p.date) + '</td><td>' + p.billNumber + '</td><td>' + p.period + ' ' + p.year + '</td><td class="amount-positive">+' + fmt(p.amount) + '</td><td>' + (p.reference || '-') + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editPayment(' + p.id + ')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deletePayment(' + p.id + ')">üóëÔ∏è</button></td></tr>';
                }).join('') || '<tr><td colspan="6">No payments</td></tr>';
            });
        }

        document.getElementById('payBill').addEventListener('change', function () {
            var bn = this.value;
            if (bn) {
                api('/bills').then(function (bills) {
                    var b = bills.find(function (x) { return x.billNumber === bn; });
                    if (b) document.getElementById('payOut').value = fmt(b.outstanding) + ' XAF';
                });
            }
        });

        function editPayment(id) {
            api('/payments/' + id).then(function (p) {
                document.getElementById('payId').value = id;
                document.getElementById('payBill').value = p.billNumber;
                document.getElementById('payAmt').value = p.amount;
                document.getElementById('payDate').value = p.date.split('T')[0];
                document.getElementById('payRef').value = p.reference || '';
                document.getElementById('payMethod').value = p.paymentMethod || 'Cash';
            });
        }

        function savePayment() {
            var id = document.getElementById('payId').value;
            var data = {
                billNumber: document.getElementById('payBill').value,
                amount: parseInt(document.getElementById('payAmt').value),
                date: document.getElementById('payDate').value,
                reference: document.getElementById('payRef').value,
                paymentMethod: document.getElementById('payMethod').value
            };
            if (!data.billNumber || !data.amount) {
                showAlert('Fill required fields', 'error');
                return;
            }
            var url = id ? '/payments/' + id : '/payments';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function () {
                showAlert(id ? 'Updated!' : 'Saved!');
                clearPaymentForm();
                loadPayments();
                loadBills();
                loadDashboard();
            });
        }

        function deletePayment(id) {
            if (!confirm('Delete?')) return;
            api('/payments/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Deleted');
                loadPayments();
                loadBills();
                loadDashboard();
            });
        }

        function clearPaymentForm() {
            document.getElementById('payId').value = '';
            document.getElementById('payBill').value = '';
            document.getElementById('payOut').value = '';
            document.getElementById('payAmt').value = '';
            document.getElementById('payRef').value = '';
        }

        // Campost Receipts
        function loadCampostReceipts() {
            api('/payments').then(function (payments) {
                // Filter valid payments (amount > 0)
                var validPayments = payments.filter(function (p) { return p.amount > 0; });

                var html = validPayments.map(function (p) {
                    var hasReceipt = !!p.receiptNumber;
                    var actionBtn = '';
                    if (hasReceipt) {
                        actionBtn = '<button class="btn btn-print btn-sm" onclick="printCampostReceipt(' + p.id + ')">üñ®Ô∏è</button> ' +
                            '<button class="btn btn-warning btn-sm" onclick="editCampostReceipt(' + p.id + ')">‚úèÔ∏è</button> ' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteCampostReceipt(' + p.id + ')">‚ùå</button>';
                    } else {
                        actionBtn = '<button class="btn btn-gold btn-sm" onclick="generateCampostReceipt(' + p.id + ')">üìÑ Generate</button>';
                    }

                    var receiptDisplay = hasReceipt
                        ? '<span class="badge badge-paid">' + p.receiptNumber + '</span>'
                        : '<span class="badge badge-new">Pending</span>';

                    return '<tr>' +
                        '<td>' + fmtDate(p.date) + '</td>' +
                        '<td>' + receiptDisplay + '</td>' +
                        '<td>' + p.billNumber + '</td>' +
                        '<td class="amount-positive">' + fmt(p.amount) + ' XAF</td>' +
                        '<td>' + p.period + ' ' + p.year + '</td>' +
                        '<td class="no-print">' + actionBtn + '</td>' +
                        '</tr>';
                }).join('');

                document.getElementById('campostReceiptsTable').innerHTML = html || '<tr><td colspan="6">No payments found</td></tr>';
            });
        }

        function generateCampostReceipt(paymentId) {
            if (!confirm('Generate official receipt for this payment?')) return;

            api('/receipts/generate', {
                method: 'POST',
                body: JSON.stringify({ paymentId: paymentId })
            }).then(function (receipt) {
                if (receipt.error) {
                    showAlert(receipt.error, 'error');
                } else {
                    showAlert('Receipt Generated: ' + receipt.receipt_number);
                    loadCampostReceipts();
                    // Auto print
                    printCampostReceipt(paymentId);
                }
            });
        }

        // Number to Words Utility (Western Style)
        function numberToWords(amount) {
            var words = new Array();
            words[0] = '';
            words[1] = 'One';
            words[2] = 'Two';
            words[3] = 'Three';
            words[4] = 'Four';
            words[5] = 'Five';
            words[6] = 'Six';
            words[7] = 'Seven';
            words[8] = 'Eight';
            words[9] = 'Nine';
            words[10] = 'Ten';
            words[11] = 'Eleven';
            words[12] = 'Twelve';
            words[13] = 'Thirteen';
            words[14] = 'Fourteen';
            words[15] = 'Fifteen';
            words[16] = 'Sixteen';
            words[17] = 'Seventeen';
            words[18] = 'Eighteen';
            words[19] = 'Nineteen';
            words[20] = 'Twenty';
            words[30] = 'Thirty';
            words[40] = 'Forty';
            words[50] = 'Fifty';
            words[60] = 'Sixty';
            words[70] = 'Seventy';
            words[80] = 'Eighty';
            words[90] = 'Ninety';

            amount = amount.toString();
            var atemp = amount.split(".");
            var number = atemp[0].split(",").join("");
            var n_length = number.length;
            var words_string = "";

            if (n_length <= 9) {
                var n_array = new Array(0, 0, 0, 0, 0, 0, 0, 0, 0);
                var received_n_array = new Array();
                for (var i = 0; i < n_length; i++) {
                    received_n_array[i] = number.substr(i, 1);
                }
                for (var i = 9 - n_length, j = 0; i < 9; i++, j++) {
                    n_array[i] = received_n_array[j];
                }
                for (var i = 0, j = 1; i < 9; i++, j++) {
                    if (i == 0 || i == 2 || i == 4 || i == 7) {
                        if (n_array[i] == 1) {
                            n_array[j] = 10 + parseInt(n_array[j]);
                            n_array[i] = 0;
                        }
                    }
                }
                var value = "";
                for (var i = 0; i < 9; i++) {
                    if (i == 0 || i == 2 || i == 4 || i == 7) {
                        value = n_array[i] * 10;
                    } else {
                        value = n_array[i];
                    }
                    if (value != 0) {
                        words_string += words[value] + " ";
                    }
                    if ((i == 1 && value != 0) || (i == 0 && value != 0 && n_array[i + 1] == 0)) {
                        words_string += "Million ";
                    }
                    if ((i == 3 && value != 0) || (i == 2 && value != 0 && n_array[i + 1] == 0)) {
                        words_string += "Hundred "; // Logic adjustment for hundreds of thousands needed, simplified below for cleaner western format
                    }
                    // Simplified logic for standard millions/thousands
                    // Better approach for standard western numbering:
                }
                // Re-implementation for robust Western numbering
                var num = parseInt(number);
                if (num === 0) return "Zero";

                function belowThousand(n) {
                    if (n === 0) return "";
                    else if (n < 20) return words[n] + " ";
                    else if (n < 100) return words[Math.floor(n / 10) * 10] + " " + belowThousand(n % 10);
                    else return words[Math.floor(n / 100)] + " Hundred " + belowThousand(n % 100);
                }

                words_string = "";
                if (Math.floor(num / 1000000) > 0) {
                    words_string += belowThousand(Math.floor(num / 1000000)) + "Million ";
                    num %= 1000000;
                }
                if (Math.floor(num / 1000) > 0) {
                    words_string += belowThousand(Math.floor(num / 1000)) + "Thousand ";
                    num %= 1000;
                }
                if (num > 0) {
                    words_string += belowThousand(num);
                }
            }
            return words_string.trim();
        }

        function printCampostReceipt(paymentId) {
            api('/payments/' + paymentId).then(function (p) {
                var dateStr = new Date(p.date).toLocaleDateString();
                var receiptNo = p.receiptNumber || 'DRAFT';
                var paymentMethod = p.paymentMethod || 'Cash';
                var amountWords = numberToWords(p.amount);

                var content = `
                <div style="font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; margin: 0 auto; max-width: 800px; color: #333;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; border-bottom: 3px solid #2d3748; padding-bottom: 20px;">
                        <div>
                            <h1 style="margin: 0; font-size: 28px; color: #2d3748; text-transform: uppercase; letter-spacing: 1px;">GHOUENZEN SOULEMANOU</h1>
                            <p style="margin: 5px 0 0; font-size: 14px; color: #4a5568;">B.P 36 Mankon-Bamenda</p>
                            <p style="margin: 2px 0 0; font-size: 14px; color: #4a5568;">Tel: 675299868</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 32px; font-weight: bold; color: #4a5568; letter-spacing: 2px;">RECEIPT</div>
                            <div style="font-size: 16px; color: #e53e3e; font-weight: bold; margin-top: 5px;">#${receiptNo}</div>
                        </div>
                    </div>

                    <!-- Info Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div>
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 12px; text-transform: uppercase; color: #718096; letter-spacing: 1px; margin-bottom: 5px;">Payment Date</div>
                                <div style="font-size: 16px; font-weight: 500;">${dateStr}</div>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 12px; text-transform: uppercase; color: #718096; letter-spacing: 1px; margin-bottom: 5px;">Received From</div>
                                <div style="font-size: 18px; font-weight: bold; color: #2d3748;">CAMPOST MANKON</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; text-transform: uppercase; color: #718096; letter-spacing: 1px; margin-bottom: 5px;">Payment Method</div>
                                <div style="font-size: 16px; display: inline-block; padding: 4px 12px; background: #e2e8f0; border-radius: 99px; font-weight: 500;">${paymentMethod}</div>
                            </div>
                        </div>
                        <div style="background: #f7fafc; padding: 20px; border-radius: 8px;">
                            <div style="margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px;">
                                <div style="font-size: 12px; text-transform: uppercase; color: #718096; letter-spacing: 1px; margin-bottom: 5px;">Payment For</div>
                                <div style="font-size: 16px; font-weight: 500;">Rent Payment - Bill #${p.billNumber}</div>
                                <div style="font-size: 14px; color: #718096; margin-top: 2px;">Period: ${p.period} ${p.year}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; text-transform: uppercase; color: #718096; letter-spacing: 1px; margin-bottom: 5px;">Amount Paid</div>
                                <div style="font-size: 28px; font-weight: bold; color: #38a169;">${fmt(p.amount)} XAF</div>
                                <div style="font-size: 14px; font-style: italic; color: #4a5568; margin-top: 5px;">${amountWords} Francs CFA</div>
                            </div>
                        </div>
                    </div>

                    <!-- Signature -->
                    <div style="margin-top: 50px; text-align: right;">
                        <div style="width: 200px; margin-left: auto; text-align: center;">
                            <img src="images/signature.png" style="height: 60px; margin-bottom: 5px; display: inline-block;" alt="Signature">
                            <div style="border-top: 1px solid #718096; padding-top: 5px;">
                                <div style="font-size: 12px; color: #718096; text-transform: uppercase;">Authorized Signature</div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="margin-top: 60px; border-top: 1px solid #e2e8f0; padding-top: 20px; text-align: center; color: #a0aec0; font-size: 12px;">
                        <p>Thank you for your payment.</p>
                        <p>This is a computer generated receipt.</p>
                    </div>
                </div>
                `;

                var w = window.open('', '_blank');
                w.document.write('<html><head><title>Receipt ' + receiptNo + '</title><style>@media print { @page { margin: 0; } body { margin: 1cm; } }</style></head><body>' + content + '</body></html>');
                w.document.close();
                // w.print();
            });
        }

        // Receipt Management
        function editCampostReceipt(paymentId) {
            api('/payments/' + paymentId).then(function (p) {
                var modal = document.getElementById('receiptEditModal');
                if (!modal) {
                    // Create modal if not exists
                    modal = document.createElement('div');
                    modal.id = 'receiptEditModal';
                    modal.className = 'modal-overlay';
                    modal.innerHTML = `
                        <div class="modal" style="max-width: 400px;">
                            <div class="modal-header"><h3>Edit Receipt</h3><button class="modal-close" onclick="closeReceiptModal()">√ó</button></div>
                            <div class="modal-body">
                                <input type="hidden" id="editReceiptId">
                                <div class="form-group">
                                    <label>Receipt Date</label>
                                    <input type="date" id="editReceiptDate">
                                </div>
                                <div class="form-group">
                                    <label>Payment Method</label>
                                    <select id="editReceiptMethod">
                                        <option value="Cash">Cash</option>
                                        <option value="Mobile Money">Mobile Money</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                    </select>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-success" onclick="saveCampostReceipt()">üíæ Save Changes</button>
                                </div>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                }

                // Populate
                document.getElementById('editReceiptId').value = paymentId;
                document.getElementById('editReceiptDate').value = p.receiptDate ? p.receiptDate.split('T')[0] : p.date.split('T')[0];
                document.getElementById('editReceiptMethod').value = p.paymentMethod || 'Cash';

                modal.classList.add('active');
            });
        }

        function saveCampostReceipt() {
            var id = document.getElementById('editReceiptId').value;
            var date = document.getElementById('editReceiptDate').value;
            var method = document.getElementById('editReceiptMethod').value;

            api('/receipts/' + id, {
                method: 'PUT',
                body: JSON.stringify({ date: date, paymentMethod: method })
            }).then(function (res) {
                if (res.error) {
                    showAlert(res.error, 'error');
                } else {
                    showAlert('Receipt Updated');
                    closeReceiptModal();
                    loadCampostReceipts();
                }
            }).catch(function (err) {
                showAlert('Error saving receipt: ' + err, 'error');
            });
        }

        function deleteCampostReceipt(paymentId) {
            if (!confirm('Are you sure you want to VOID this receipt? This will remove the receipt number.')) return;

            api('/receipts/' + paymentId, { method: 'DELETE' }).then(function () {
                showAlert('Receipt Voided');
                loadCampostReceipts();
            });
        }

        function closeReceiptModal() {
            var modal = document.getElementById('receiptEditModal');
            if (modal) modal.classList.remove('active');
        }

        // Inheritance
        function loadInheritance() {
            // First ensure we have the latest beneficiary selection from API
            loadCampostBeneficiariesFromAPI().then(function () {
                // Now load all heirs to display the selection list
                api('/heirs').then(function (allHeirs) {
                    loadCampostBeneficiaryList(allHeirs);

                    // Get inheritance calculation from backend (which now handles filtering)
                    api('/inheritance/calculate').then(function (d) {
                        document.getElementById('inhAmt').textContent = fmt(d.inheritanceAmount) + ' XAF';
                        if (document.getElementById('inhAmtTable')) document.getElementById('inhAmtTable').textContent = fmt(d.inheritanceAmount) + ' XAF';
                        document.getElementById('inhPaid').textContent = fmt(d.totalBillsPaid);
                        document.getElementById('inhExp').textContent = fmt(d.totalExpenses);
                        document.getElementById('inhRes').textContent = fmt(d.reserveFunds);
                        // Update summary cards
                        document.getElementById('inhPortions').textContent = d.baseNumber;
                        document.getElementById('inhPer').textContent = fmt(Math.round(d.perPortion));

                        // Display notes/rationale
                        var notesHtml = d.notes.map(function (n) { return '<li>' + n + '</li>'; }).join('');
                        var notesSection = document.getElementById('inhNotes');
                        if (!notesSection) {
                            var div = document.createElement('div');
                            div.id = 'inhNotes';
                            div.style = 'background: #fffbeb; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #d69e2e; font-size: 0.9rem;';
                            document.getElementById('heirGroups').parentElement.insertBefore(div, document.getElementById('heirGroups').nextSibling);
                            notesSection = div;
                        }
                        notesSection.innerHTML = '<strong>üìú Calculation Rationale:</strong><ul style="margin: 10px 0 0 20px;">' + notesHtml + '</ul>';

                        // Use group summary from backend
                        var html = '';
                        for (var g in d.groupSummary) {
                            var gInfo = d.groupSummary[g];
                            html += '<div class="heir-group"><h4>' + g + ' <span>' + gInfo.count + '</span></h4>' +
                                '<div class="summary-row"><span>Fraction:</span><span style="font-weight:bold;">' + gInfo.fraction + '</span></div>' +
                                '<div class="summary-row"><span>Parts (Group):</span><span>' + (Math.round(gInfo.partsPerHeir * gInfo.count * 100) / 100) + '</span></div>' +
                                '<div class="summary-row"><span>Per heir:</span><span>' + fmt(Math.round(gInfo.totalShare / gInfo.count)) + ' XAF</span></div>' +
                                '<div class="summary-row"><span>Total:</span><span style="font-weight:bold;">' + fmt(Math.round(gInfo.totalShare)) + ' XAF</span></div>' +
                                '</div>';
                        }
                        document.getElementById('heirGroups').innerHTML = html || '<p>No beneficiaries selected</p>';

                        var isAdmin = currentUser && currentUser.role === 'admin';
                        document.getElementById('heirTable').innerHTML = d.heirs.map(function (h) {
                            var actionsHtml = isAdmin ? '<td class="no-print"><button class="btn btn-gold btn-sm" onclick="printHeirCertificate(' + h.id + ')">üìú</button> <button class="btn btn-warning btn-sm" onclick="editHeir(' + h.id + ')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteHeir(' + h.id + ')">üóëÔ∏è</button></td>' : '';
                            return '<tr><td>' + h.name + '</td><td>' + h.relationship + '</td><td>' + h.fraction + '</td><td>' + h.parts + '</td><td>' + h.sharePercentage + '%</td><td class="amount-positive">' + fmt(Math.round(h.shareAmount)) + '</td>' + actionsHtml + '</tr>';
                        }).join('') || '<tr><td colspan="7">No beneficiaries selected</td></tr>';
                    });
                });
            });
        }

        // Load CAMPOST beneficiary selection list
        function loadCampostBeneficiaryList(heirs) {
            var selectedIds = getCampostBeneficiaries();
            var html = heirs.map(function (h) {
                var isSelected = selectedIds.length === 0 || selectedIds.includes(h.id);
                return '<div class="beneficiary-item ' + (isSelected ? 'selected' : '') + '">' +
                    '<input type="checkbox" id="campost-ben-' + h.id + '" ' + (isSelected ? 'checked' : '') + ' onchange="toggleCampostBeneficiary(' + h.id + ', this.checked)">' +
                    '<label for="campost-ben-' + h.id + '">' + h.name + '</label>' +
                    '<span class="heir-info">' + h.relationship + '</span>' +
                    '<span class="heir-portions">' + (h.sharePercentage || 0) + '% Share</span>' +
                    '</div>';
            }).join('');
            document.getElementById('campostBeneficiaryList').innerHTML = html || '<p>No heirs available</p>';
        }

        // Get selected CAMPOST beneficiaries from API
        var campostBeneficiariesCache = [];
        function getCampostBeneficiaries() {
            return campostBeneficiariesCache;
        }

        function loadCampostBeneficiariesFromAPI() {
            return api('/campost/beneficiaries').then(function (ids) {
                campostBeneficiariesCache = ids || [];
                return campostBeneficiariesCache;
            }).catch(function () {
                campostBeneficiariesCache = [];
                return [];
            });
        }

        // Toggle CAMPOST beneficiary selection
        function toggleCampostBeneficiary(id, checked) {
            var el = document.querySelector('#campost-ben-' + id).closest('.beneficiary-item');
            if (checked) {
                el.classList.add('selected');
                if (!campostBeneficiariesCache.includes(id)) {
                    campostBeneficiariesCache.push(id);
                }
            } else {
                el.classList.remove('selected');
                var index = campostBeneficiariesCache.indexOf(id);
                if (index > -1) {
                    campostBeneficiariesCache.splice(index, 1);
                }
            }
            // Reactive save and update
            saveCampostBeneficiaries();
        }

        // Select/Deselect all CAMPOST beneficiaries
        function selectAllCampostBeneficiaries(selectAll) {
            var checkboxes = document.querySelectorAll('#campostBeneficiaryList input[type="checkbox"]');
            campostBeneficiariesCache = [];
            checkboxes.forEach(function (cb) {
                cb.checked = selectAll;
                var id = parseInt(cb.id.replace('campost-ben-', ''));
                var el = cb.closest('.beneficiary-item');
                if (selectAll) {
                    el.classList.add('selected');
                    campostBeneficiariesCache.push(id);
                } else {
                    el.classList.remove('selected');
                }
            });
            // Reactive save and update
            saveCampostBeneficiaries();
        }

        // Save CAMPOST beneficiary selection to PostgreSQL
        function saveCampostBeneficiaries() {
            var checkboxes = document.querySelectorAll('#campostBeneficiaryList input[type="checkbox"]:checked');
            var selectedIds = Array.from(checkboxes).map(function (cb) {
                return parseInt(cb.id.replace('campost-ben-', ''));
            });

            api('/campost/beneficiaries', {
                method: 'POST',
                body: JSON.stringify({ selectedIds: selectedIds })
            }).then(function () {
                campostBeneficiariesCache = selectedIds;
                loadInheritance();
            }).catch(function (err) {
                showAlert('Error saving beneficiaries: ' + err.message, 'error');
            });
        }

        // Reset CAMPOST heirs to default family members
        function resetCampostHeirsToDefaults() {
            if (!confirm('This will delete all current heirs and reset to the default 16 family members. Continue?')) return;

            api('/heirs/reset-defaults', { method: 'POST' }).then(function (result) {
                if (result.success) {
                    // Clear beneficiary selection via API
                    api('/campost/beneficiaries', {
                        method: 'POST',
                        body: JSON.stringify({ selectedIds: [] })
                    }).then(function () {
                        campostBeneficiariesCache = [];
                        showAlert('Heirs reset to default family members (' + result.count + ' heirs)');
                        loadInheritance();
                    });
                } else {
                    showAlert('Error resetting heirs', 'error');
                }
            }).catch(function (err) {
                showAlert('Error: ' + err.message, 'error');
            });
        }

        function openHeirModal() { document.getElementById('heirModal').classList.add('active'); }
        function closeHeirModal() {
            document.getElementById('heirModal').classList.remove('active');
            document.getElementById('heirId').value = '';
            document.getElementById('heirName').value = '';
        }

        function editHeir(id) {
            api('/heirs').then(function (heirs) {
                var h = heirs.find(function (x) { return x.id === id; });
                if (h) {
                    document.getElementById('heirId').value = id;
                    document.getElementById('heirName').value = h.name;
                    document.getElementById('heirRel').value = h.relationship;
                    document.getElementById('heirGrp').value = h.heir_group;
                    document.getElementById('heirPor').value = h.portions;
                    openHeirModal();
                }
            });
        }

        function saveHeir() {
            var id = document.getElementById('heirId').value;
            var data = {
                name: document.getElementById('heirName').value,
                relationship: document.getElementById('heirRel').value,
                heirGroup: document.getElementById('heirGrp').value,
                portions: parseFloat(document.getElementById('heirPor').value)
            };
            if (!data.name) { showAlert('Enter name', 'error'); return; }
            var url = id ? '/heirs/' + id : '/heirs';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function () {
                showAlert(id ? 'Updated!' : 'Added!');
                closeHeirModal();
                loadInheritance();
            });
        }

        function deleteHeir(id) {
            if (!confirm('Delete?')) return;
            api('/heirs/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Deleted');
                loadInheritance();
            });
        }

        // Heir Certificates
        function printHeirCertificate(heirId) {
            api('/inheritance/calculate').then(function (d) {
                var h = d.heirs.find(function (x) { return x.id === heirId; });
                if (!h) { showAlert('Heir not found', 'error'); return; }
                var certHtml = generateCertificateHTML(h, d);
                var w = window.open('', '_blank');
                w.document.write(certHtml);
                w.document.close();
                w.print();
            });
        }

        function printAllHeirCertificates() {
            api('/inheritance/calculate').then(function (d) {
                if (d.heirs.length === 0) { showAlert('No heirs', 'error'); return; }
                var allCerts = '<html><head><title>Certificates</title><style>@page{size:A5;margin:10mm;}body{font-family:Georgia,serif;margin:0;padding:0;}.certificate{page-break-after:always;padding:15mm;border:3px double #1a365d;margin:5mm;}.certificate:last-child{page-break-after:auto;}.cert-header{text-align:center;border-bottom:2px solid #d69e2e;padding-bottom:10px;margin-bottom:15px;}.cert-header h1{color:#1a365d;font-size:20px;margin:0;}.heir-name{text-align:center;font-size:24px;color:#1a365d;font-weight:bold;margin:20px 0;padding:10px;background:linear-gradient(135deg,rgba(214,158,46,0.1),rgba(237,137,54,0.1));border-radius:8px;}.cert-details{margin:15px 0;}.detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dotted #ccc;}.share-amount{text-align:center;margin:20px 0;padding:15px;background:#1a365d;color:white;border-radius:8px;}.share-amount strong{font-size:28px;color:#d69e2e;}.signature-line{margin-top:30px;display:flex;justify-content:space-between;}.sig-block{text-align:center;width:40%;}.sig-line{border-top:1px solid #333;margin-top:40px;padding-top:5px;}</style></head><body>';
                d.heirs.forEach(function (h) { allCerts += generateCertificateBody(h, d); });
                allCerts += '</body></html>';
                var w = window.open('', '_blank');
                w.document.write(allCerts);
                w.document.close();
                w.print();
            });
        }

        function generateCertificateHTML(h, d) {
            return '<html><head><title>Certificate - ' + h.name + '</title><style>body{font-family:Georgia,serif;margin:0;padding:20mm;}.certificate{padding:20mm;border:3px double #1a365d;}.cert-header{text-align:center;border-bottom:2px solid #d69e2e;padding-bottom:15px;margin-bottom:20px;}.cert-header h1{color:#1a365d;font-size:24px;margin:0;}.heir-name{text-align:center;font-size:28px;color:#1a365d;font-weight:bold;margin:25px 0;padding:15px;background:linear-gradient(135deg,rgba(214,158,46,0.1),rgba(237,137,54,0.1));border-radius:10px;}.cert-details{margin:20px 0;}.detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dotted #ccc;}.share-amount{text-align:center;margin:25px 0;padding:20px;background:#1a365d;color:white;border-radius:10px;}.share-amount strong{font-size:32px;color:#d69e2e;}.signature-line{margin-top:40px;display:flex;justify-content:space-between;}.sig-block{text-align:center;width:40%;}.sig-line{border-top:1px solid #333;margin-top:50px;padding-top:5px;}</style></head><body>' + generateCertificateBody(h, d) + '</body></html>';
        }

        function generateCertificateBody(h, d) {
            return '<div class="certificate"><div style="text-align:center;margin:15px 0;"><h2 style="color:#d69e2e;font-size:18px;">üìú INHERITANCE SHARE CERTIFICATE</h2></div><p style="text-align:center;color:#666;font-size:12px;">This certifies that the following heir is entitled to receive their share:</p><div class="heir-name">' + h.name + '</div>' +
                '<div class="cert-details">' +
                '<div class="detail-row"><span>Relationship:</span><span style="font-weight:bold;">' + h.relationship + '</span></div>' +
                '<div class="detail-row"><span>Share Fraction:</span><span style="font-weight:bold; color: #1a365d;">' + (h.fraction || 'N/A') + '</span></div>' +
                '<div class="detail-row"><span>Parts of Base (' + d.baseNumber + '):</span><span style="font-weight:bold;">' + h.parts + '</span></div>' +
                '<div class="detail-row"><span>Share Percentage:</span><span style="font-weight:bold;">' + (h.sharePercentage || 0) + '%</span></div>' +
                '<div class="detail-row"><span>Total Estate:</span><span style="font-weight:bold;">' + fmt(d.inheritanceAmount) + ' XAF</span></div>' +
                '</div>' +
                '<div class="share-amount"><p style="margin:0 0 5px;opacity:0.8;">NET DISTRIBUTABLE AMOUNT</p><strong>' + fmt(Math.round(h.shareAmount)) + ' XAF</strong></div>' +
                '<div class="signature-line"><div class="sig-block"><img src="images/signature.png" style="height:60px;display:block;margin:0 auto -15px auto;"><div class="sig-line">Authorized Signature</div></div><div class="sig-block"><div style="height:45px;"></div><div class="sig-line">Heir Signature</div></div></div>' +
                '<p style="text-align:center;margin-top:20px;font-size:10px;color:#666;">Sequential Calculation Method (Fara\'id) | Generated on ' + today() + '</p></div>';
        }

        // Export functions
        function exportCSV(type) {
            var h = 'CAMPOST MANKON - GHOUENZEN Soulemanou\nB.P 36 Mankon-Bamenda | Tel: 675299868\n\n';
            if (type === 'bills') {
                api('/bills').then(function (d) {
                    var csv = h + 'Bill Number,Quarter,Period,Year,Due,Paid,Outstanding,Status\n';
                    d.forEach(function (b) { csv += b.billNumber + ',' + b.quarter + ',' + b.period + ',' + b.year + ',' + b.amountDue + ',' + b.paidAmount + ',' + b.outstanding + ',' + (b.outstanding === 0 ? 'Paid' : 'Outstanding') + '\n'; });
                    download(csv, 'campost_bills.csv');
                });
            } else if (type === 'payments') {
                api('/payments').then(function (d) {
                    var csv = h + 'Date,Bill,Period,Year,Amount,Reference\n';
                    d.forEach(function (p) { csv += p.date + ',' + p.billNumber + ',' + p.period + ',' + p.year + ',' + p.amount + ',"' + (p.reference || '') + '"\n'; });
                    download(csv, 'campost_payments.csv');
                });
            } else if (type === 'expenses') {
                api('/expenses').then(function (d) {
                    var csv = h + 'Date,Description,Category,Amount\n';
                    d.forEach(function (e) { csv += e.date + ',"' + e.description + '",' + e.categoryName + ',' + e.amount + '\n'; });
                    download(csv, 'campost_expenses.csv');
                });
            } else if (type === 'ledger') {
                Promise.all([api('/bills'), api('/expenses')]).then(function (results) {
                    var bills = results[0];
                    var expenses = results[1];
                    var csv = h + 'Date,Description,Type,Status,Income,Expense,Balance\n';

                    var ledgerEntries = [];
                    // Add bills with payments (paid or partial)
                    bills.forEach(function (b) {
                        if (b.paidAmount > 0) {
                            var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                            ledgerEntries.push({
                                date: b.createdAt || new Date().toISOString(),
                                description: 'Bill ' + b.billNumber + ' - ' + b.period + ' ' + b.year,
                                type: 'Income',
                                status: status,
                                income: b.paidAmount,
                                expense: 0
                            });
                        }
                    });
                    expenses.forEach(function (e) {
                        ledgerEntries.push({ date: e.date, description: e.description, type: e.categoryName, status: '', income: 0, expense: e.amount });
                    });
                    ledgerEntries.sort(function (a, b) { return new Date(a.date) - new Date(b.date); });

                    var balance = 0;
                    ledgerEntries.forEach(function (entry) {
                        balance += entry.income - entry.expense;
                        csv += (entry.date ? entry.date.split('T')[0] : '') + ',"' + entry.description + '",' + entry.type + ',' + entry.status + ',' + entry.income + ',' + entry.expense + ',' + balance + '\n';
                    });
                    download(csv, 'campost_ledger.csv');
                });
            }
        }

        function exportAllCSV() {
            api('/export/all').then(function (all) {
                var csv = 'CAMPOST MANKON - GHOUENZEN Soulemanou\nB.P 36 Mankon-Bamenda | Tel: 675299868\n';
                csv += '\nSUMMARY\nTotal Bills Paid: ' + all.summary.totalBillsPaid + '\nTotal Expenses: ' + all.summary.totalExpenses + '\nReserve Funds: ' + all.summary.reserveFunds + '\n';
                csv += '\n\nBILLS\nBill Number,Period,Year,Amount Due,Paid,Outstanding\n';
                all.bills.forEach(function (b) { csv += b.bill_number + ',' + b.period + ',' + b.year + ',' + b.amount_due + ',' + b.paid_amount + ',' + b.outstanding + '\n'; });
                csv += '\n\nPAYMENTS\nDate,Bill,Amount,Reference\n';
                all.payments.forEach(function (p) { csv += p.payment_date + ',' + p.bill_number + ',' + p.amount + ',"' + (p.reference || '') + '"\n'; });
                csv += '\n\nEXPENSES\nDate,Description,Category,Amount\n';
                all.expenses.forEach(function (e) { csv += e.expense_date + ',"' + e.description + '",' + e.category_name + ',' + e.amount + '\n'; });
                csv += '\n\nHEIRS\nName,Relationship,Group,Share (%)\n';
                all.heirs.forEach(function (h) {
                    var p = h.sharePercentage || (h.portions || 0);
                    csv += h.name + ',' + h.relationship + ',' + h.heir_group + ',' + p + (h.sharePercentage ? '%' : '') + '\n';
                });
                download(csv, 'campost_all_data.csv');
            });
        }

        function exportPDF(type) {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('CAMPOST MANKON', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868', 105, 22, { align: 'center' });
            doc.line(20, 25, 190, 25);

            if (type === 'bills') {
                api('/bills').then(function (d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('BILLS REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Bill #', 'Period', 'Year', 'Due', 'Paid', 'Outstanding']], body: d.map(function (b) { return [b.billNumber, b.period, b.year, fmt(b.amountDue), fmt(b.paidAmount), fmt(b.outstanding)]; }), styles: { fontSize: 8 } });
                    doc.save('campost_bills.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'payments') {
                api('/payments').then(function (d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PAYMENTS REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Date', 'Bill #', 'Period', 'Amount', 'Reference']], body: d.map(function (p) { return [fmtDate(p.date), p.billNumber, p.period + ' ' + p.year, fmt(p.amount), p.reference || '-']; }), styles: { fontSize: 8 } });
                    doc.save('campost_payments.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'expenses') {
                api('/expenses').then(function (d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('EXPENSES REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Date', 'Description', 'Category', 'Amount']], body: d.map(function (e) { return [fmtDate(e.date), e.description.substring(0, 35), e.categoryName, fmt(e.amount)]; }), styles: { fontSize: 8 } });
                    doc.save('campost_expenses.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'ledger') {
                Promise.all([api('/bills'), api('/expenses')]).then(function (results) {
                    var bills = results[0];
                    var expenses = results[1];

                    // Build ledger entries from bills with payments
                    var ledgerEntries = [];
                    bills.forEach(function (b) {
                        if (b.paidAmount > 0) {
                            var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                            ledgerEntries.push({
                                date: b.createdAt || new Date().toISOString(),
                                description: b.billNumber + ' - ' + b.period + ' ' + b.year,
                                type: 'Income (' + status + ')',
                                income: b.paidAmount,
                                expense: 0
                            });
                        }
                    });
                    expenses.forEach(function (e) {
                        ledgerEntries.push({
                            date: e.date,
                            description: e.description.substring(0, 30),
                            type: e.categoryName,
                            income: 0,
                            expense: e.amount
                        });
                    });

                    // Sort by date
                    ledgerEntries.sort(function (a, b) {
                        return new Date(a.date) - new Date(b.date);
                    });

                    // Calculate running balance
                    var runningBalance = 0;
                    var totalIncome = 0;
                    var totalExpense = 0;
                    var tableData = ledgerEntries.map(function (entry) {
                        if (entry.income > 0) {
                            runningBalance += entry.income;
                            totalIncome += entry.income;
                        }
                        if (entry.expense > 0) {
                            runningBalance -= entry.expense;
                            totalExpense += entry.expense;
                        }
                        return [
                            fmtDate(entry.date),
                            entry.description,
                            entry.type,
                            entry.income > 0 ? fmt(entry.income) : '-',
                            entry.expense > 0 ? fmt(entry.expense) : '-',
                            fmt(runningBalance)
                        ];
                    });

                    // Add totals row
                    tableData.push(['', '', 'TOTALS:', fmt(totalIncome), fmt(totalExpense), fmt(runningBalance)]);

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('LEDGER REPORT', 105, 35, { align: 'center' });
                    doc.setFontSize(9);
                    doc.text('Total Income: ' + fmt(totalIncome) + ' XAF | Total Expenses: ' + fmt(totalExpense) + ' XAF | Balance: ' + fmt(runningBalance) + ' XAF', 105, 42, { align: 'center' });
                    doc.autoTable({
                        startY: 48,
                        head: [['Date', 'Description', 'Type', 'Income', 'Expense', 'Balance']],
                        body: tableData,
                        styles: { fontSize: 7 },
                        headStyles: { fillColor: [44, 82, 130] },
                        footStyles: { fillColor: [247, 250, 252], textColor: [0, 0, 0], fontStyle: 'bold' }
                    });
                    doc.save('campost_ledger.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'heirs') {
                api('/inheritance/calculate').then(function (d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('INHERITANCE REPORT', 105, 35, { align: 'center' });
                    doc.setFontSize(10);
                    doc.text('Amount: ' + fmt(d.inheritanceAmount) + ' XAF | Base Share: ' + fmt(d.sharePerPortion) + ' XAF', 105, 42, { align: 'center' });
                    doc.autoTable({ startY: 48, head: [['Name', 'Relationship', 'Group', 'Share (%)', 'Amount']], body: d.heirs.map(function (h) { return [h.name, h.relationship, h.heir_group, (h.sharePercentage || 0) + '%', fmt(Math.round(h.shareAmount))]; }), styles: { fontSize: 8 } });
                    doc.save('campost_heirs.pdf');
                    showAlert('PDF exported!');
                });

            }

            function exportAllPDF() {
                var jsPDF = window.jspdf.jsPDF;
                var doc = new jsPDF();
                Promise.all([api('/export/all'), api('/inheritance/calculate')]).then(function (results) {
                    var all = results[0];
                    var inh = results[1];
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('CAMPOST MANKON', 105, 15, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868', 105, 22, { align: 'center' });
                    doc.line(20, 25, 190, 25);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('FINANCIAL SUMMARY', 20, 33);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Bills Paid: ' + fmt(all.summary.totalBillsPaid) + ' | Expenses: ' + fmt(all.summary.totalExpenses) + ' | Reserve: ' + fmt(all.summary.reserveFunds), 20, 40);
                    doc.text('BILLS', 20, 50);
                    doc.autoTable({ startY: 53, head: [['Bill #', 'Period', 'Year', 'Due', 'Paid', 'Outstanding']], body: all.bills.map(function (b) { return [b.bill_number, b.period, b.year, fmt(b.amount_due), fmt(b.paid_amount), fmt(b.outstanding)]; }), styles: { fontSize: 7 } });
                    doc.addPage();
                    doc.setFont('helvetica', 'bold');
                    doc.text('PAYMENTS', 20, 15);
                    doc.autoTable({ startY: 18, head: [['Date', 'Bill', 'Amount', 'Reference']], body: all.payments.map(function (p) { return [p.payment_date ? p.payment_date.split('T')[0] : '', p.bill_number, fmt(p.amount), p.reference || '']; }), styles: { fontSize: 7 } });
                    var y = doc.lastAutoTable.finalY + 10;
                    doc.text('EXPENSES', 20, y);
                    doc.autoTable({ startY: y + 3, head: [['Date', 'Description', 'Category', 'Amount']], body: all.expenses.map(function (e) { return [e.expense_date ? e.expense_date.split('T')[0] : '', e.description ? e.description.substring(0, 25) : '', e.category_name || '', fmt(e.amount)]; }), styles: { fontSize: 7 } });
                    doc.addPage();
                    doc.text('INHERITANCE (' + fmt(inh.inheritanceAmount) + ' XAF)', 20, 15);
                    doc.autoTable({ startY: 20, head: [['Name', 'Relationship', 'Group', 'Share (%)', 'Amount']], body: inh.heirs.map(function (h) { return [h.name, h.relationship, h.heir_group, (h.sharePercentage || 0) + '%', fmt(Math.round(h.shareAmount))]; }), styles: { fontSize: 7 } });
                    doc.save('campost_complete_report.pdf');
                    showAlert('Complete PDF exported!');
                });
            }

            function download(content, filename) {
                var a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([content], { type: 'text/csv' }));
                a.download = filename;
                a.click();
                showAlert('Exported!');
            }

            // Print specific element by cloning to temp page
            // Print specific element by opening a new window with clean styles
            function printElement(sourceId) {
                var content = document.getElementById(sourceId).innerHTML;

                // Extract the amount to distribute if present
                var amountDistHeader = '';
                var amountEl = document.getElementById('inhAmt');
                if (amountEl && sourceId === 'campost-heir-shares-card') {
                    // We already have the highlight-box in the content now due to previous step, 
                    // but let's make sure it looks good in print or add a specific header if needed.
                }

                // Create a clean print window
                var w = window.open('', '_blank');
                w.document.write('<!DOCTYPE html><html><head><title>Print Summary</title>');
                w.document.write('<style>');
                w.document.write('@import url("https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap");');
                w.document.write('body { font-family: "Segoe UI", Arial, sans-serif; padding: 40px; color: #333; background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }');

                // Header Styles
                w.document.write('.print-header { border-bottom: 2px solid #2c5282; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }');
                w.document.write('.logo-area h1 { margin: 0; font-size: 24px; color: #2c5282; text-transform: uppercase; letter-spacing: 1px; }');
                w.document.write('.logo-area p { margin: 5px 0 0; font-size: 13px; color: #718096; }');
                w.document.write('.doc-title { text-align: right; }');
                w.document.write('.doc-title h2 { margin: 0; font-size: 28px; color: #d69e2e; font-weight: 700; }');
                w.document.write('.doc-title p { margin: 0; font-size: 14px; color: #a0aec0; }');

                // Table Styles
                w.document.write('table { width: 100%; border-collapse: collapse; margin-top: 25px; font-size: 12px; border: 1px solid #e2e8f0; }');
                w.document.write('thead { background-color: #2c5282; color: white; }');
                w.document.write('th { padding: 12px; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; border-bottom: 2px solid #2a4365; }');
                w.document.write('td { padding: 10px 12px; border-bottom: 1px solid #edf2f7; color: #4a5568; }');
                w.document.write('tr:nth-child(even) { background-color: #f7fafc; }');
                w.document.write('tr:hover { background-color: #ebf8ff; }');

                // Amount Box in Print
                w.document.write('.highlight-box { background: #fffaf0; border-left: 4px solid #d69e2e; padding: 15px; margin-bottom: 25px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }');
                w.document.write('.highlight-box p { margin: 0 0 5px; font-size: 12px; color: #744210; text-transform: uppercase; font-weight: 600; }');
                w.document.write('.highlight-box h3 { margin: 0; font-size: 20px; color: #975a16; }');

                // Utility
                w.document.write('.card-header { display: none; }'); // Hide default card header
                w.document.write('.no-print { display: none !important; }');
                w.document.write('.admin-only { display: none !important; }'); // Ensure admin columns are hidden

                // Footer
                w.document.write('.print-footer { margin-top: 50px; border-top: 1px solid #e2e8f0; padding-top: 20px; display: flex; justify-content: space-between; font-size: 10px; color: #a0aec0; }');
                w.document.write('.signature-area { margin-top: 60px; display: flex; justify-content: flex-end; gap: 40px; }');
                w.document.write('.sig-line { width: 200px; border-top: 1px solid #cbd5e0; padding-top: 10px; text-align: center; color: #4a5568; font-size: 11px; font-weight: 600; }');

                w.document.write('</style>');
                w.document.write('</head><body>');

                // Header Section
                w.document.write('<div class="print-header">');
                w.document.write('<div class="logo-area">');
                w.document.write('<h1>Campost Mankon</h1>');
                w.document.write('<p>B.P 36 Mankon-Bamenda | Tel: 675299868</p>');
                w.document.write('<p>Estate Administrator: GHOUENZEN Soulemanou</p>');
                w.document.write('</div>');
                w.document.write('<div class="doc-title">');
                w.document.write('<h2>HEIR SHARES</h2>');
                w.document.write('<p>Beneficiaries Distribution Summary</p>');
                w.document.write('</div>');
                w.document.write('</div>');

                w.document.write('<div class="print-container">');
                w.document.write(content);
                w.document.write('</div>');

                // Signatures
                w.document.write('<div class="signature-area">');
                w.document.write('<div><div style="height:40px;"></div><div class="sig-line">Administrator Signature</div></div>');
                w.document.write('</div>');

                // Footer Section
                w.document.write('<div class="print-footer">');
                w.document.write('<div>Generated on: ' + new Date().toLocaleString() + '</div>');
                w.document.write('<div>Campost Estate Management System</div>');
                w.document.write('</div>');

                w.document.write('</body></html>');
                w.document.close();

                // Wait for content to load then print
                setTimeout(function () {
                    w.focus();
                    w.print();
                }, 500);
            }

            function printPage(pageId) {
                document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('printing'); });
                var p = document.getElementById(pageId);
                if (p) {
                    p.classList.add('printing');
                    // Small delay to allow CSS classes to apply
                    setTimeout(function () {
                        window.print();
                    }, 200);
                }
            }

            // Settings
            function checkDb() {
                api('/status').then(function (s) {
                    document.getElementById('dbStatus').textContent = s.connected ? '‚úì Connected' : '‚úó Offline';
                    document.getElementById('dbStatus').className = 'db-status ' + (s.connected ? 'connected' : 'disconnected');
                    document.getElementById('settingsAlert').className = 'alert alert-' + (s.connected ? 'success' : 'error');
                    document.getElementById('settingsAlert').innerHTML = s.connected ? '‚úì PostgreSQL Connected' : '‚úó Offline';
                }).catch(function () {
                    document.getElementById('dbStatus').textContent = '‚úó Offline';
                    document.getElementById('dbStatus').className = 'db-status disconnected';
                });
            }

            function resetAll() {
                if (!confirm('RESET ALL DATA?')) return;
                api('/reset', { method: 'POST' }).then(function () {
                    showAlert('Data reset!');
                    loadDashboard();
                });
            }

            // Initialize - check for existing session or show login
            function init() {
                // Hide main app initially
                document.getElementById('mainApp').style.display = 'none';

                // Check for existing session
                checkExistingSession();
            }

            init();
    </script>
</body>

</html>