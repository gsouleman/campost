<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAMPOST MANKON - Property & Billing Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-dark: #1a365d;
            --primary-blue: #2c5282;
            --primary-light: #4299e1;
            --accent-gold: #d69e2e;
            --accent-orange: #ed8936;
            --success-green: #38a169;
            --danger-red: #e53e3e;
            --bg-cream: #faf5eb;
            --bg-white: #ffffff;
            --text-dark: #1a202c;
            --text-gray: #4a5568;
            --border-color: #e2e8f0;
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans Pro', sans-serif; background: linear-gradient(135deg, var(--bg-cream) 0%, #e8e0d5 100%); min-height: 100vh; color: var(--text-dark); }
        
        .header { background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%); color: white; position: sticky; top: 0; z-index: 1000; }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 1.5rem; flex-wrap: wrap; gap: 0.5rem; }
        .logo-section { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 38px; height: 38px; background: var(--accent-gold); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--primary-dark); }
        .logo-text h1 { font-family: 'Playfair Display', serif; font-size: 1.2rem; }
        .logo-text p { font-size: 0.65rem; opacity: 0.8; }
        .header-info { text-align: right; font-size: 0.75rem; }
        .db-status { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 10px; font-size: 0.6rem; margin-top: 0.1rem; }
        .db-status.connected { background: rgba(56,161,105,0.3); color: #9ae6b4; }
        .db-status.disconnected { background: rgba(229,62,62,0.3); color: #feb2b2; }
        
        .nav { display: flex; padding: 0 0.5rem; flex-wrap: wrap; overflow-x: auto; border-top: 1px solid rgba(255,255,255,0.1); }
        .nav-btn { background: transparent; border: none; color: white; padding: 0.5rem 0.7rem; font-size: 0.75rem; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); }
        .nav-btn.active { background: rgba(255,255,255,0.15); border-bottom-color: var(--accent-gold); }
        
        .main-content { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: var(--bg-white); border-radius: 10px; box-shadow: var(--shadow-md); margin-bottom: 1rem; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%); color: white; padding: 0.75rem 1rem; font-family: 'Playfair Display', serif; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-header.green { background: linear-gradient(135deg, var(--success-green) 0%, #276749 100%); }
        .card-header.gold { background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%); }
        .card-body { padding: 1rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .stat-card { background: var(--bg-white); border-radius: 8px; padding: 0.75rem; box-shadow: var(--shadow-md); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.blue::before { background: var(--primary-blue); }
        .stat-card.green::before { background: var(--success-green); }
        .stat-card.red::before { background: var(--danger-red); }
        .stat-card.gold::before { background: var(--accent-gold); }
        .stat-icon { font-size: 1.1rem; margin-bottom: 0.2rem; }
        .stat-value { font-size: 1rem; font-weight: 700; margin-bottom: 0.1rem; }
        .stat-label { color: var(--text-gray); font-size: 0.65rem; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; }
        .form-group { margin-bottom: 0.75rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 600; font-size: 0.75rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.4rem 0.6rem; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-blue); }
        .form-group input:read-only { background: #f7fafc; }
        
        .btn { padding: 0.4rem 0.8rem; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.25rem; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success-green) 0%, #276749 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger-red) 0%, #c53030 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--accent-orange) 0%, #c05621 100%); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary-blue); color: var(--primary-blue); }
        .btn-print { background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%); color: white; }
        .btn-gold { background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%); color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
        .btn-group { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
        
        .table-container { overflow-x: auto; border-radius: 6px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; min-width: 400px; }
        th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.8rem; }
        th { background: #f7fafc; font-weight: 700; font-size: 0.7rem; text-transform: uppercase; }
        tr:hover { background: #f7fafc; }
        tr.clickable { cursor: pointer; }
        tr.clickable:hover { background: rgba(66,153,225,0.1); }
        
        .badge { padding: 0.15rem 0.35rem; border-radius: 8px; font-size: 0.6rem; font-weight: 600; text-transform: uppercase; }
        .badge-income { background: rgba(56,161,105,0.15); color: var(--success-green); }
        .badge-expense { background: rgba(229,62,62,0.15); color: var(--danger-red); }
        .badge-inheritance { background: rgba(214,158,46,0.15); color: var(--accent-gold); }
        .badge-paid { background: rgba(56,161,105,0.15); color: var(--success-green); }
        .badge-partial { background: rgba(236,201,75,0.2); color: #b7791f; }
        .badge-unpaid { background: rgba(229,62,62,0.15); color: var(--danger-red); }
        .badge-new { background: rgba(66,153,225,0.15); color: var(--primary-blue); }
        
        .amount-positive { color: var(--success-green); font-weight: 600; }
        .amount-negative { color: var(--danger-red); font-weight: 600; }
        .amount-gold { color: var(--accent-gold); font-weight: 600; }
        
        .alert { padding: 0.6rem 0.9rem; border-radius: 6px; margin-bottom: 0.75rem; font-size: 0.8rem; }
        .alert-success { background: rgba(56,161,105,0.15); color: var(--success-green); border: 1px solid var(--success-green); }
        .alert-error { background: rgba(229,62,62,0.15); color: var(--danger-red); border: 1px solid var(--danger-red); }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 10px; max-width: 750px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%); color: white; padding: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }
        .modal-body { padding: 1.25rem; }
        
        .heir-group { background: #f7fafc; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem; }
        .heir-group h4 { color: var(--primary-blue); margin-bottom: 0.3rem; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .summary-row { display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px dashed var(--border-color); font-size: 0.8rem; }
        .summary-row:last-child { border-bottom: none; font-weight: 700; }
        
        .highlight-box { background: linear-gradient(135deg, rgba(214,158,46,0.15) 0%, rgba(237,137,54,0.15) 100%); border: 2px solid var(--accent-gold); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; text-align: center; }
        .highlight-box h3 { color: var(--accent-gold); font-size: 1.3rem; }
        .highlight-box p { font-size: 0.75rem; color: var(--text-gray); }
        
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1rem; }
        .tab-btn { background: none; border: none; padding: 0.5rem 1rem; font-size: 0.8rem; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { border-bottom-color: var(--primary-blue); color: var(--primary-blue); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        @media print { body { background: white !important; } .no-print { display: none !important; } }
        @media (max-width: 768px) { .header-top { flex-direction: column; text-align: center; } .main-content { padding: 0.5rem; } }
    </style>
</head>
<body>
    <header class="header no-print">
        <div class="header-top">
            <div class="logo-section">
                <div class="logo-icon">CP</div>
                <div class="logo-text"><h1>CAMPOST MANKON</h1><p>Property & Billing Management</p></div>
            </div>
            <div class="header-info">
                <strong>GHOUENZEN Soulemanou</strong><br>
                <span>B.P 36 Mankon-Bamenda | 675299868</span>
                <div class="db-status disconnected" id="dbStatus">Connecting...</div>
            </div>
        </div>
        <nav class="nav">
            <button class="nav-btn active" data-page="dashboard">üìä Dashboard</button>
            <button class="nav-btn" data-page="ledger">üìí Ledger</button>
            <button class="nav-btn" data-page="expenses">üí∏ Expenses</button>
            <button class="nav-btn" data-page="bills">üìÑ Bills</button>
            <button class="nav-btn" data-page="payments">üíµ Payments</button>
            <button class="nav-btn" data-page="inheritance">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Inheritance</button>
            <button class="nav-btn" data-page="export">üì• Export</button>
            <button class="nav-btn" data-page="settings">‚öôÔ∏è Settings</button>
        </nav>
    </header>

    <main class="main-content">
        <!-- DASHBOARD -->
        <div id="dashboard" class="page active">
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">üíµ</div><div class="stat-value" id="dashIncome">0</div><div class="stat-label">Total Income</div></div>
                <div class="stat-card red"><div class="stat-icon">üí∏</div><div class="stat-value" id="dashExp">0</div><div class="stat-label">Total Expenses</div></div>
                <div class="stat-card blue"><div class="stat-icon">üè¶</div><div class="stat-value" id="dashReserve">0</div><div class="stat-label">Reserve Funds</div></div>
                <div class="stat-card gold"><div class="stat-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div><div class="stat-value" id="dashInh">0</div><div class="stat-label">Inheritance Pool</div></div>
            </div>
            <div class="card">
                <div class="card-header"><span>üìä Financial Summary</span></div>
                <div class="card-body">
                    <div class="summary-row"><span>Total Income (Bills Paid):</span><span class="amount-positive" id="dashIncomeSum">0 XAF</span></div>
                    <div class="summary-row"><span>Total Expenses:</span><span class="amount-negative" id="dashExpSum">0 XAF</span></div>
                    <div class="summary-row" style="font-size: 1rem;"><span><strong>Reserve Funds (Income - Expenses):</strong></span><span id="dashReserveSum" style="font-weight: bold;">0 XAF</span></div>
                    <div class="summary-row"><span>Inheritance Pool (from distributions):</span><span class="amount-gold" id="dashInhSum">0 XAF</span></div>
                </div>
            </div>
        </div>

        <!-- LEDGER -->
        <div id="ledger" class="page">
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">üíµ</div><div class="stat-value" id="ledgerIncome">0</div><div class="stat-label">Total Income</div></div>
                <div class="stat-card red"><div class="stat-icon">üí∏</div><div class="stat-value" id="ledgerExpense">0</div><div class="stat-label">Total Expenses</div></div>
                <div class="stat-card blue"><div class="stat-icon">üè¶</div><div class="stat-value" id="ledgerBalance">0</div><div class="stat-label">Balance (Reserve)</div></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span>üìí Ledger (Auto-Generated)</span>
                    <div class="no-print">
                        <button class="btn btn-print btn-sm" onclick="exportPDF('ledger')">üì• Export PDF</button>
                        <button class="btn btn-outline btn-sm" onclick="exportCSV('ledger')">üì• Export CSV</button>
                        <button class="btn btn-print btn-sm" onclick="printPage('ledger')">üñ®Ô∏è Print</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Income (Credit)</th>
                                    <th>Expense (Debit)</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody id="ledgerTable"></tbody>
                            <tfoot id="ledgerTotals"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXPENSES -->
        <div id="expenses" class="page">
            <div class="card no-print">
                <div class="card-header green"><span>‚ûï Add/Edit Expense</span></div>
                <div class="card-body">
                    <input type="hidden" id="expId">
                    <div class="form-grid">
                        <div class="form-group"><label>Date</label><input type="date" id="expDate"></div>
                        <div class="form-group"><label>Description</label><input type="text" id="expDesc" placeholder="Description"></div>
                        <div class="form-group"><label>Category</label><select id="expCat"></select></div>
                        <div class="form-group"><label>Amount (XAF)</label><input type="number" id="expAmt" placeholder="Amount"></div>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="saveExpense()">üíæ Save</button><button class="btn btn-outline" onclick="clearExpenseForm()">üîÑ Clear</button></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><span>üí∏ Expenses</span><button class="btn btn-print btn-sm no-print" onclick="printPage('expenses')">üñ®Ô∏è Print</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th class="no-print">Actions</th></tr></thead><tbody id="expTable"></tbody></table></div></div></div>
        </div>

        <!-- BILLS -->
        <div id="bills" class="page">
            <div class="card no-print">
                <div class="card-header green"><span>‚ûï Add/Edit Bill</span></div>
                <div class="card-body">
                    <input type="hidden" id="billEditMode"><input type="hidden" id="billOldNumber">
                    <div class="form-grid">
                        <div class="form-group"><label>Quarter</label><select id="billQ"><option value="Q1">Q1</option><option value="Q2">Q2</option><option value="Q3">Q3</option><option value="Q4">Q4</option></select></div>
                        <div class="form-group"><label>Year</label><select id="billY"></select></div>
                        <div class="form-group"><label>Period</label><select id="billP"><option value="January to March">January to March</option><option value="April to June">April to June</option><option value="July to September">July to September</option><option value="October to December">October to December</option></select></div>
                        <div class="form-group"><label>Bill Number</label><input type="text" id="billNum" readonly></div>
                    </div>
                    <div style="background: #ebf8ff; padding: 12px; border-radius: 8px; margin: 10px 0; border: 1px solid #90cdf4;">
                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; font-size: 0.85rem;">
                            <div><span style="color: #4a5568;">Monthly Rate:</span> <strong id="billShowRate">200,000</strong> XAF</div>
                            <div><span style="color: #4a5568;">Gross (3 mo):</span> <strong id="billShowGross">600,000</strong> XAF</div>
                            <div><span style="color: #4a5568;">Tax (<span id="billShowTaxPct">15</span>%):</span> <strong id="billShowTax" style="color: #e53e3e;">-90,000</strong> XAF</div>
                            <div><span style="color: #4a5568;">Net Due:</span> <strong id="billShowNet" style="color: #38a169;">510,000</strong> XAF</div>
                        </div>
                        <p style="margin-top: 8px; font-size: 0.7rem; color: #718096;">üí° To change monthly rate or tax rate, go to <strong>Settings</strong> tab</p>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="saveBill()">üíæ Save Bill</button><button class="btn btn-outline" onclick="clearBillForm()">üîÑ Clear</button></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><span>üìÑ All Bills (Click to View Invoice)</span><button class="btn btn-print btn-sm no-print" onclick="printPage('bills')">üñ®Ô∏è Print List</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Bill #</th><th>Period</th><th>Due</th><th>Paid</th><th>Outstanding</th><th>Status</th><th class="no-print">Actions</th></tr></thead><tbody id="billTable"></tbody></table></div></div></div>
        </div>

        <!-- PAYMENTS -->
        <div id="payments" class="page">
            <div class="card no-print">
                <div class="card-header green"><span>‚ûï Add/Edit Payment</span></div>
                <div class="card-body">
                    <input type="hidden" id="payId">
                    <div class="form-grid">
                        <div class="form-group"><label>Select Bill</label><select id="payBill"></select></div>
                        <div class="form-group"><label>Outstanding</label><input type="text" id="payOut" readonly></div>
                        <div class="form-group"><label>Amount (XAF)</label><input type="number" id="payAmt"></div>
                        <div class="form-group"><label>Date</label><input type="date" id="payDate"></div>
                        <div class="form-group"><label>Reference</label><input type="text" id="payRef" placeholder="Receipt #"></div>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="savePayment()">üíæ Save</button><button class="btn btn-outline" onclick="clearPaymentForm()">üîÑ Clear</button></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><span>üíµ Payments</span><button class="btn btn-print btn-sm no-print" onclick="printPage('payments')">üñ®Ô∏è Print</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Date</th><th>Bill #</th><th>Period</th><th>Amount</th><th>Reference</th><th class="no-print">Actions</th></tr></thead><tbody id="payTable"></tbody></table></div></div></div>
        </div>

        <!-- INHERITANCE -->
        <div id="inheritance" class="page">
            <div class="highlight-box">
                <p>Amount to Distribute (from Inheritance Share expenses)</p>
                <h3 id="inhAmt">0 XAF</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">üíµ</div><div class="stat-value" id="inhPaid">0</div><div class="stat-label">Bills Paid</div></div>
                <div class="stat-card red"><div class="stat-icon">üí∏</div><div class="stat-value" id="inhExp">0</div><div class="stat-label">Expenses</div></div>
                <div class="stat-card blue"><div class="stat-icon">üè¶</div><div class="stat-value" id="inhRes">0</div><div class="stat-label">Reserve</div></div>
                <div class="stat-card gold"><div class="stat-icon">üìä</div><div class="stat-value" id="inhPer">0</div><div class="stat-label">Per Portion</div></div>
            </div>
            <div class="card">
                <div class="card-header gold"><span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Heirs (<span id="inhPortions">24</span> portions)</span>
                <div class="no-print"><button class="btn btn-outline btn-sm" onclick="openHeirModal()">‚ûï Add</button><button class="btn btn-gold btn-sm" onclick="printAllHeirCertificates()">üñ®Ô∏è Print All Certificates</button></div>
                </div>
                <div class="card-body" id="heirGroups"></div>
            </div>
            <div class="card"><div class="card-header"><span>üìã Heir Shares</span><button class="btn btn-print btn-sm no-print" onclick="printPage('inheritance')">üñ®Ô∏è Print Summary</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Name</th><th>Relationship</th><th>Group</th><th>Portions</th><th>Share (XAF)</th><th class="no-print">Actions</th></tr></thead><tbody id="heirTable"></tbody></table></div></div></div>
        </div>

        <!-- EXPORT -->
        <div id="export" class="page">
            <div class="card"><div class="card-header"><span>üì• Export All Data</span></div>
            <div class="card-body">
                <p style="margin-bottom:1rem;font-size:0.85rem;">Export with CAMPOST MANKON header.</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="exportAllCSV()">üìÑ All CSV</button>
                    <button class="btn btn-print" onclick="exportAllPDF()">üìë All PDF</button>
                </div>
            </div></div>
            <div class="card"><div class="card-header"><span>üìä Individual Exports</span></div>
            <div class="card-body">
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('bills')">Bills CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('payments')">Payments CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('expenses')">Expenses CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('ledger')">Ledger CSV</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-print btn-sm" onclick="exportPDF('bills')">Bills PDF</button>
                    <button class="btn btn-print btn-sm" onclick="exportPDF('payments')">Payments PDF</button>
                    <button class="btn btn-print btn-sm" onclick="exportPDF('expenses')">Expenses PDF</button>
                    <button class="btn btn-primary btn-sm" onclick="exportPDF('ledger')">Ledger PDF</button>
                    <button class="btn btn-gold btn-sm" onclick="exportPDF('heirs')">Heirs PDF</button>
                </div>
            </div></div>
        </div>

        <!-- SETTINGS -->
        <div id="settings" class="page">
            <div class="card">
                <div class="card-header gold"><span>üí∞ Rent Configuration</span></div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Monthly Rent (XAF)</label>
                            <input type="number" id="settingMonthlyRent" value="200000">
                        </div>
                        <div class="form-group">
                            <label>Tax Rate (%)</label>
                            <input type="number" id="settingTaxRate" value="15" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Months per Quarter</label>
                            <input type="number" id="settingMonths" value="3" readonly>
                        </div>
                    </div>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-bottom: 10px; color: #2c5282;">üìä Calculated Amounts</h4>
                        <div class="summary-row"><span>Quarterly Gross:</span><span id="calcGross">600,000 XAF</span></div>
                        <div class="summary-row"><span>Tax Deduction:</span><span id="calcTax">90,000 XAF</span></div>
                        <div class="summary-row" style="font-weight: bold; color: #38a169;"><span>Net Amount Due:</span><span id="calcNet">510,000 XAF</span></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span>‚öôÔ∏è System Status</span></div>
                <div class="card-body">
                    <div class="alert" id="settingsAlert">Checking...</div>
                    <div class="btn-group">
                        <button class="btn btn-outline" onclick="checkDb()">üîÑ Refresh</button>
                        <button class="btn btn-danger" onclick="resetAll()">üóëÔ∏è Reset All Data</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bill/Invoice Modal -->
    <div class="modal-overlay" id="billModal">
        <div class="modal">
            <div class="modal-header"><h3>üìÑ Rent Invoice</h3><button class="modal-close" onclick="closeBillModal()">√ó</button></div>
            <div class="modal-body" id="billModalBody"></div>
        </div>
    </div>

    <!-- Heir Modal -->
    <div class="modal-overlay" id="heirModal">
        <div class="modal">
            <div class="modal-header"><h3>üë§ Heir</h3><button class="modal-close" onclick="closeHeirModal()">√ó</button></div>
            <div class="modal-body">
                <input type="hidden" id="heirId">
                <div class="form-group"><label>Name</label><input type="text" id="heirName"></div>
                <div class="form-group"><label>Relationship</label><select id="heirRel"><option value="Spouse">Spouse</option><option value="Child">Child</option></select></div>
                <div class="form-group"><label>Group</label><select id="heirGrp"><option value="Wives">Wives</option><option value="Daughters">Daughters</option><option value="Sons">Sons</option></select></div>
                <div class="form-group"><label>Portions</label><input type="number" id="heirPor" value="3" step="0.5"></div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveHeir()">üíæ Save</button></div>
            </div>
        </div>
    </div>

    <div id="alertBox" style="position:fixed;top:60px;right:10px;z-index:3000;max-width:280px;"></div>

    <script>
        // Configuration - load from localStorage or use defaults
        var CONFIG = {
            monthlyRate: parseInt(localStorage.getItem('monthlyRate')) || 200000,
            taxRate: parseFloat(localStorage.getItem('taxRate')) || 0.15,
            months: 3,
            accountNo: '12003 14012 10868895015 89'
        };

        // Calculate amounts based on config
        function calcAmounts() {
            var gross = CONFIG.monthlyRate * CONFIG.months;
            var tax = Math.round(gross * CONFIG.taxRate);
            var net = gross - tax;
            return { gross: gross, tax: tax, net: net };
        }

        // Update displayed calculations
        function updateCalcDisplays() {
            var calc = calcAmounts();
            var taxPct = Math.round(CONFIG.taxRate * 100);
            // Settings page
            if (document.getElementById('calcGross')) {
                document.getElementById('calcGross').textContent = fmt(calc.gross) + ' XAF';
                document.getElementById('calcTax').textContent = fmt(calc.tax) + ' XAF';
                document.getElementById('calcNet').textContent = fmt(calc.net) + ' XAF';
            }
            // Bills page
            if (document.getElementById('billShowRate')) {
                document.getElementById('billShowRate').textContent = fmt(CONFIG.monthlyRate);
                document.getElementById('billShowGross').textContent = fmt(calc.gross);
                document.getElementById('billShowTax').textContent = '-' + fmt(calc.tax);
                document.getElementById('billShowNet').textContent = fmt(calc.net);
                if (document.getElementById('billShowTaxPct')) {
                    document.getElementById('billShowTaxPct').textContent = taxPct;
                }
            }
        }

        // Save settings
        function saveSettings() {
            var rate = parseInt(document.getElementById('settingMonthlyRent').value);
            var tax = parseFloat(document.getElementById('settingTaxRate').value) / 100;
            if (rate < 1000) {
                showAlert('Invalid monthly rate', 'error');
                return;
            }
            CONFIG.monthlyRate = rate;
            CONFIG.taxRate = tax;
            localStorage.setItem('monthlyRate', rate);
            localStorage.setItem('taxRate', tax);
            updateCalcDisplays();
            showAlert('Settings saved!');
        }

        // Load settings into form
        function loadSettings() {
            document.getElementById('settingMonthlyRent').value = CONFIG.monthlyRate;
            document.getElementById('settingTaxRate').value = Math.round(CONFIG.taxRate * 100);
            updateCalcDisplays();
        }

        // Add event listeners for real-time calculation in settings
        function setupSettingsListeners() {
            var rateInput = document.getElementById('settingMonthlyRent');
            var taxInput = document.getElementById('settingTaxRate');
            if (rateInput) {
                rateInput.addEventListener('input', function() {
                    var tempRate = parseInt(this.value) || 0;
                    var tempTax = parseFloat(taxInput.value) / 100 || 0.15;
                    var gross = tempRate * CONFIG.months;
                    var tax = Math.round(gross * tempTax);
                    var net = gross - tax;
                    document.getElementById('calcGross').textContent = fmt(gross) + ' XAF';
                    document.getElementById('calcTax').textContent = fmt(tax) + ' XAF';
                    document.getElementById('calcNet').textContent = fmt(net) + ' XAF';
                });
            }
            if (taxInput) {
                taxInput.addEventListener('input', function() {
                    var tempRate = parseInt(rateInput.value) || CONFIG.monthlyRate;
                    var tempTax = parseFloat(this.value) / 100 || 0.15;
                    var gross = tempRate * CONFIG.months;
                    var tax = Math.round(gross * tempTax);
                    var net = gross - tax;
                    document.getElementById('calcGross').textContent = fmt(gross) + ' XAF';
                    document.getElementById('calcTax').textContent = fmt(tax) + ' XAF';
                    document.getElementById('calcNet').textContent = fmt(net) + ' XAF';
                });
            }
        }

        var QUARTERS = {
            'Q1': { period: 'January to March', months: 'Jan-Mar', shortPeriod: 'Q1 (Jan-Mar)' },
            'Q2': { period: 'April to June', months: 'Apr-Jun', shortPeriod: 'Q2 (Apr-Jun)' },
            'Q3': { period: 'July to September', months: 'Jul-Sep', shortPeriod: 'Q3 (Jul-Sep)' },
            'Q4': { period: 'October to December', months: 'Oct-Dec', shortPeriod: 'Q4 (Oct-Dec)' }
        };

        var API = window.location.origin + '/api';

        function fmt(n) {
            return n ? Math.abs(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
        }

        function fmtDate(d) {
            return new Date(d).toLocaleDateString();
        }

        function formatDateLong(d) {
            var date = new Date(d);
            var day = date.getDate();
            var suffix = (day === 1 || day === 21 || day === 31) ? 'st' : (day === 2 || day === 22) ? 'nd' : (day === 3 || day === 23) ? 'rd' : 'th';
            var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return day + suffix + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
        }

        function today() {
            return new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function numberToWords(n) {
            var ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            var tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            if (n < 20) return ones[n];
            if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
            if (n < 1000) return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' and ' + numberToWords(n % 100) : '');
            if (n < 1000000) return numberToWords(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 ? ' ' + numberToWords(n % 1000) : '');
            return numberToWords(Math.floor(n / 1000000)) + ' Million' + (n % 1000000 ? ' ' + numberToWords(n % 1000000) : '');
        }

        function showAlert(msg, type) {
            type = type || 'success';
            var el = document.createElement('div');
            el.className = 'alert alert-' + type;
            el.innerHTML = msg;
            document.getElementById('alertBox').appendChild(el);
            setTimeout(function() { el.remove(); }, 2500);
        }

        function api(url, opts) {
            opts = opts || {};
            return fetch(API + url, {
                headers: { 'Content-Type': 'application/json' },
                method: opts.method || 'GET',
                body: opts.body
            }).then(function(res) { return res.json(); });
        }

        // Tabs
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var page = this.dataset.page;
                document.querySelectorAll('.nav-btn').forEach(function(b) { b.classList.remove('active'); });
                document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
                this.classList.add('active');
                document.getElementById(page).classList.add('active');
                loadPage(page);
            });
        });

        function loadPage(p) {
            if (p === 'dashboard') loadDashboard();
            else if (p === 'ledger') loadLedger();
            else if (p === 'expenses') loadExpenses();
            else if (p === 'bills') { loadBills(); updateCalcDisplays(); }
            else if (p === 'payments') loadPayments();
            else if (p === 'inheritance') loadInheritance();
            else if (p === 'settings') { loadSettings(); setupSettingsListeners(); checkDb(); }
        }

        // Dashboard
        function loadDashboard() {
            // Get total income from payments (bills paid)
            api('/payments').then(function(payments) {
                var totalIncome = 0;
                payments.forEach(function(p) {
                    totalIncome += p.amount;
                });
                document.getElementById('dashIncome').textContent = fmt(totalIncome);
                document.getElementById('dashIncomeSum').textContent = fmt(totalIncome) + ' XAF';
                
                // Get expenses
                api('/expenses').then(function(expenses) {
                    var totalExpenses = 0;
                    expenses.forEach(function(e) {
                        totalExpenses += e.amount;
                    });
                    document.getElementById('dashExp').textContent = fmt(totalExpenses);
                    document.getElementById('dashExpSum').textContent = fmt(totalExpenses) + ' XAF';
                    
                    // Calculate reserve funds = Income - Expenses
                    var reserveFunds = totalIncome - totalExpenses;
                    document.getElementById('dashReserve').textContent = fmt(reserveFunds);
                    document.getElementById('dashReserveSum').textContent = fmt(reserveFunds) + ' XAF';
                    if (reserveFunds < 0) {
                        document.getElementById('dashReserveSum').className = 'amount-negative';
                    } else {
                        document.getElementById('dashReserveSum').className = 'amount-positive';
                    }
                });
            });
            
            // Get inheritance amount
            api('/inheritance/calculate').then(function(d) {
                document.getElementById('dashInh').textContent = fmt(d.inheritanceAmount);
                document.getElementById('dashInhSum').textContent = fmt(d.inheritanceAmount) + ' XAF';
            });
        }

        // Ledger - combines income (payments) and expenses
        function loadLedger() {
            Promise.all([api('/payments'), api('/expenses')]).then(function(results) {
                var payments = results[0];
                var expenses = results[1];
                
                // Combine into ledger entries
                var ledgerEntries = [];
                
                // Add payments as income
                payments.forEach(function(p) {
                    ledgerEntries.push({
                        date: p.date,
                        description: 'Payment for ' + p.billNumber + ' (' + p.period + ' ' + p.year + ')',
                        type: 'Income',
                        income: p.amount,
                        expense: 0,
                        reference: p.reference
                    });
                });
                
                // Add expenses
                expenses.forEach(function(e) {
                    ledgerEntries.push({
                        date: e.date,
                        description: e.description,
                        type: e.categoryName,
                        income: 0,
                        expense: e.amount,
                        category: e.categoryName
                    });
                });
                
                // Sort by date
                ledgerEntries.sort(function(a, b) {
                    return new Date(a.date) - new Date(b.date);
                });
                
                // Calculate running balance and totals
                var runningBalance = 0;
                var totalIncome = 0;
                var totalExpense = 0;
                
                var tableHtml = '';
                ledgerEntries.forEach(function(entry) {
                    if (entry.income > 0) {
                        runningBalance += entry.income;
                        totalIncome += entry.income;
                    }
                    if (entry.expense > 0) {
                        runningBalance -= entry.expense;
                        totalExpense += entry.expense;
                    }
                    
                    var isInheritance = entry.type === 'Inheritance Share';
                    tableHtml += '<tr>' +
                        '<td>' + fmtDate(entry.date) + '</td>' +
                        '<td>' + entry.description + '</td>' +
                        '<td><span class="badge ' + (entry.income > 0 ? 'badge-income' : isInheritance ? 'badge-inheritance' : 'badge-expense') + '">' + entry.type + '</span></td>' +
                        '<td class="amount-positive">' + (entry.income > 0 ? fmt(entry.income) : '-') + '</td>' +
                        '<td class="' + (isInheritance ? 'amount-gold' : 'amount-negative') + '">' + (entry.expense > 0 ? fmt(entry.expense) : '-') + '</td>' +
                        '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(runningBalance) + '</td>' +
                        '</tr>';
                });
                
                document.getElementById('ledgerTable').innerHTML = tableHtml || '<tr><td colspan="6">No transactions</td></tr>';
                
                // Totals footer
                document.getElementById('ledgerTotals').innerHTML = 
                    '<tr style="background: #f7fafc; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right;">TOTALS:</td>' +
                    '<td class="amount-positive">' + fmt(totalIncome) + '</td>' +
                    '<td class="amount-negative">' + fmt(totalExpense) + '</td>' +
                    '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(runningBalance) + '</td>' +
                    '</tr>';
                
                // Update stats
                document.getElementById('ledgerIncome').textContent = fmt(totalIncome);
                document.getElementById('ledgerExpense').textContent = fmt(totalExpense);
                document.getElementById('ledgerBalance').textContent = fmt(runningBalance);
            });
        }

        // Expenses
        function loadExpenses() {
            api('/categories').then(function(cats) {
                document.getElementById('expCat').innerHTML = cats.map(function(c) {
                    return '<option value="' + c.id + '">' + c.name + '</option>';
                }).join('');
            });
            if (!document.getElementById('expDate').value) {
                document.getElementById('expDate').valueAsDate = new Date();
            }
            api('/expenses').then(function(expenses) {
                document.getElementById('expTable').innerHTML = expenses.map(function(e) {
                    var isInh = e.categoryName === 'Inheritance Share';
                    return '<tr><td>' + fmtDate(e.date) + '</td><td>' + e.description + '</td><td>' + e.categoryName + '</td><td class="' + (isInh ? 'amount-gold' : 'amount-negative') + '">-' + fmt(e.amount) + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editExpense(' + e.id + ')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteExpense(' + e.id + ')">üóëÔ∏è</button></td></tr>';
                }).join('') || '<tr><td colspan="5">No expenses</td></tr>';
            });
        }

        function editExpense(id) {
            api('/expenses').then(function(expenses) {
                var e = expenses.find(function(x) { return x.id === id; });
                if (e) {
                    document.getElementById('expId').value = id;
                    document.getElementById('expDate').value = e.date.split('T')[0];
                    document.getElementById('expDesc').value = e.description;
                    document.getElementById('expCat').value = e.categoryId;
                    document.getElementById('expAmt').value = e.amount;
                }
            });
        }

        function saveExpense() {
            var id = document.getElementById('expId').value;
            var data = {
                date: document.getElementById('expDate').value,
                description: document.getElementById('expDesc').value,
                categoryId: document.getElementById('expCat').value,
                amount: parseInt(document.getElementById('expAmt').value)
            };
            if (!data.date || !data.description || !data.amount) {
                showAlert('Fill all fields', 'error');
                return;
            }
            var url = id ? '/expenses/' + id : '/expenses';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                showAlert(id ? 'Updated!' : 'Saved!');
                clearExpenseForm();
                loadExpenses();
                loadDashboard();
            });
        }

        function deleteExpense(id) {
            if (!confirm('Delete?')) return;
            api('/expenses/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadExpenses();
            });
        }

        function clearExpenseForm() {
            document.getElementById('expId').value = '';
            document.getElementById('expDesc').value = '';
            document.getElementById('expAmt').value = '';
        }

        // Bills
        function loadBills() {
            var yearSel = document.getElementById('billY');
            if (yearSel.options.length === 0) {
                for (var y = 2022; y <= 2035; y++) {
                    yearSel.innerHTML += '<option value="' + y + '">' + y + '</option>';
                }
                yearSel.value = new Date().getFullYear();
            }
            updateBillNumber();
            api('/bills').then(function(bills) {
                document.getElementById('billTable').innerHTML = bills.map(function(b) {
                    return '<tr class="clickable" onclick="viewBill(\'' + b.billNumber + '\')"><td><strong>' + b.billNumber + '</strong>' + (b.isNew ? ' <span class="badge badge-new">NEW</span>' : '') + '</td><td>' + b.period + ' ' + b.year + '</td><td>' + fmt(b.amountDue) + '</td><td class="amount-positive">' + fmt(b.paidAmount) + '</td><td class="' + (b.outstanding > 0 ? 'amount-negative' : '') + '">' + fmt(b.outstanding) + '</td><td><span class="badge badge-' + (b.outstanding === 0 ? 'paid' : b.paidAmount > 0 ? 'partial' : 'unpaid') + '">' + (b.outstanding === 0 ? 'Paid' : b.paidAmount > 0 ? 'Partial' : 'Unpaid') + '</span></td><td class="no-print" onclick="event.stopPropagation()"><button class="btn btn-warning btn-sm" onclick="editBill(\'' + b.billNumber + '\')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteBill(\'' + b.billNumber + '\')">üóëÔ∏è</button></td></tr>';
                }).join('');
            });
        }

        function updateBillNumber() {
            var q = document.getElementById('billQ').value;
            var y = document.getElementById('billY').value;
            var n = q === 'Q1' ? 1 : q === 'Q2' ? 2 : q === 'Q3' ? 3 : 4;
            document.getElementById('billNum').value = q + '-' + y + '-00' + n;
        }

        document.getElementById('billQ').addEventListener('change', updateBillNumber);
        document.getElementById('billY').addEventListener('change', updateBillNumber);

        function editBill(bn) {
            api('/bills').then(function(bills) {
                var b = bills.find(function(x) { return x.billNumber === bn; });
                if (b) {
                    document.getElementById('billEditMode').value = 'edit';
                    document.getElementById('billOldNumber').value = bn;
                    document.getElementById('billQ').value = b.quarter;
                    document.getElementById('billY').value = b.year;
                    document.getElementById('billP').value = b.period;
                    updateBillNumber();
                    updateCalcDisplays();
                }
            });
        }

        function saveBill() {
            var em = document.getElementById('billEditMode').value;
            var old = document.getElementById('billOldNumber').value;
            var q = document.getElementById('billQ').value;
            var y = parseInt(document.getElementById('billY').value);
            var p = document.getElementById('billP').value;
            var calc = calcAmounts();
            var amountDue = calc.net; // Use calculated net amount from CONFIG
            var bn = document.getElementById('billNum').value;

            if (em === 'edit') {
                api('/bills/' + old, { method: 'PUT', body: JSON.stringify({ quarter: q, year: y, period: p, amountDue: amountDue }) }).then(function() {
                    showAlert('Updated!');
                    clearBillForm();
                    loadBills();
                    loadDashboard();
                });
            } else {
                api('/bills', { method: 'POST', body: JSON.stringify({ billNumber: bn, quarter: q, year: y, period: p, amountDue: amountDue, paidAmount: 0, outstanding: amountDue, isNew: true }) }).then(function() {
                    showAlert('Created!');
                    clearBillForm();
                    loadBills();
                    loadDashboard();
                });
            }
        }

        function deleteBill(bn) {
            if (!confirm('Delete ' + bn + '?')) return;
            api('/bills/' + bn, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadBills();
                loadDashboard();
            });
        }

        function clearBillForm() {
            document.getElementById('billEditMode').value = '';
            document.getElementById('billOldNumber').value = '';
            document.getElementById('billY').value = new Date().getFullYear();
            updateBillNumber();
            updateCalcDisplays();
        }

        // View Bill as Invoice
        function viewBill(bn) {
            api('/bills/' + bn).then(function(b) {
                var rate = CONFIG.monthlyRate; // Monthly rate from settings
                var grossAmount = rate * CONFIG.months; // Quarterly gross
                var taxPercent = Math.round(CONFIG.taxRate * 100); // Tax percentage for display
                var taxAmount = Math.round(grossAmount * CONFIG.taxRate); // Tax amount
                var netAmount = grossAmount - taxAmount; // Net amount due per quarter
                var advancePayment = b.paidAmount;
                var totalDue = netAmount - advancePayment; // Outstanding after payments
                var qInfo = QUARTERS[b.quarter] || { months: b.period };
                var paymentNum = b.quarter === 'Q1' ? 1 : b.quarter === 'Q2' ? 2 : b.quarter === 'Q3' ? 3 : 4;
                var billDate = b.createdAt ? formatDateLong(b.createdAt) : formatDateLong(new Date());

                var invoiceHtml = '<div id="invoicePrint" style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto;">' +
                    '<div style="text-align: center; background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0;">' +
                        '<h1 style="margin: 0; font-size: 24px;">GHOUENZEN Soulemanou</h1>' +
                        '<p style="margin: 5px 0 0; font-size: 14px;">B.P 36 Mankon-Bamenda</p>' +
                        '<p style="margin: 3px 0 0; font-size: 14px;">Tel: 675299868</p>' +
                        '<p style="margin: 3px 0 0; font-size: 12px;">Account No. ' + CONFIG.accountNo + '</p>' +
                    '</div>' +
                    '<div style="border: 1px solid #ddd; border-top: none; padding: 20px;">' +
                        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                            '<tr style="background: #2c5282; color: white;"><td colspan="4" style="padding: 8px; text-align: center; font-weight: bold;">BILLING PERIOD SELECTION</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 25%;">Billing Period:</td><td colspan="3" style="padding: 8px; border: 1px solid #ddd;">' + b.period + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Year:</td><td style="padding: 8px; border: 1px solid #ddd;">' + b.year + '</td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Quarter:</td><td style="padding: 8px; border: 1px solid #ddd; background: #2c5282; color: white; text-align: center;">' + b.quarter + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Payment Number:</td><td style="padding: 8px; border: 1px solid #ddd;">' + paymentNum + '</td><td colspan="2"></td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Bill Date:</td><td colspan="3" style="padding: 8px; border: 1px solid #ddd;">' + billDate + '</td></tr>' +
                        '</table>' +
                        '<div style="background: #38a169; color: white; text-align: center; padding: 8px; font-weight: bold;">GENERATED BILL NUMBER</div>' +
                        '<div style="background: #c6f6d5; text-align: center; padding: 15px; font-size: 22px; font-weight: bold; color: #276749; border: 2px solid #38a169;">BILL NO.' + b.billNumber + '</div>' +
                        '<div style="margin: 20px 0; font-style: italic;">' +
                            '<p><strong>The General Manager,</strong></p>' +
                            '<p>Cameroon Postal Services</p>' +
                            '<p>B.P 1441 Yaound√©.</p>' +
                        '</div>' +
                        '<p style="margin: 20px 0;"><strong>Sir,</strong></p>' +
                        '<p style="margin-bottom: 20px;">In accordance with the contract de bail No.00000/9/MTP/G10 of 18th April 1991, I hereby present the rent bill for period of:</p>' +
                        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                            '<tr style="background: #2c5282; color: white;"><td colspan="2" style="padding: 10px; text-align: center; font-weight: bold;">BILL DETAILS</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 35%;">Bill Date</td><td style="padding: 8px; border: 1px solid #ddd;">' + billDate + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Tenant Name</td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">CAMPOST MANKON</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Property Address</td><td style="padding: 8px; border: 1px solid #ddd;">B.P 36 Mankon-Bamenda</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Bill Number</td><td style="padding: 8px; border: 1px solid #ddd; background: #ebf8ff; color: #2c5282; font-weight: bold;">' + b.billNumber + '</td></tr>' +
                        '</table>' +
                        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                            '<tr style="background: #d69e2e; color: white;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Description</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Qty (months)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Rate (XAF)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Amount (XAF)</th></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd;">Rent for ' + b.quarter + ' (' + qInfo.months + ')</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">' + CONFIG.months + '</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + fmt(rate) + '</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + fmt(grossAmount) + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd;">Less ' + taxPercent + '% Tax</td><td style="padding: 8px; border: 1px solid #ddd;"></td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + taxPercent + '%</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #e53e3e;">-' + fmt(taxAmount) + '</td></tr>' +
                            '<tr style="background: #f7fafc;"><td colspan="3" style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Net Amount (After Tax)</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">' + fmt(netAmount) + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd;">Less Advance Payment</td><td colspan="2" style="padding: 8px; border: 1px solid #ddd;"></td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #38a169;">-' + fmt(advancePayment) + '</td></tr>' +
                            '<tr style="background: #2c5282; color: white;"><td colspan="3" style="padding: 10px; font-weight: bold; text-align: center;">TOTAL AMOUNT DUE</td><td style="padding: 10px; text-align: right; font-weight: bold; font-size: 18px;">' + fmt(totalDue) + '</td></tr>' +
                        '</table>' +
                        '<p style="text-align: center; color: #e53e3e; font-style: italic; font-weight: bold;">(' + numberToWords(netAmount) + ' francs CFA.)</p>' +
                        '<div style="margin-top: 40px;">' +
                            '<p><strong>Signature:</strong></p>' +
                            '<div style="margin-top: 10px; border-bottom: 1px solid #333; width: 200px; height: 50px;"></div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="btn-group no-print" style="margin-top: 15px;">' +
                    '<button class="btn btn-primary" onclick="printInvoice()">üñ®Ô∏è Print Invoice</button>' +
                    '<button class="btn btn-outline" onclick="closeBillModal()">Close</button>' +
                '</div>';

                document.getElementById('billModalBody').innerHTML = invoiceHtml;
                document.getElementById('billModal').classList.add('active');
            });
        }

        function closeBillModal() {
            document.getElementById('billModal').classList.remove('active');
        }

        function printInvoice() {
            var content = document.getElementById('invoicePrint').innerHTML;
            var w = window.open('', '_blank');
            w.document.write('<html><head><title>Rent Invoice</title><style>body{font-family:Arial,sans-serif;padding:20px;margin:0;}table{width:100%;border-collapse:collapse;}td,th{padding:8px;border:1px solid #ddd;}@media print{body{padding:10px;}}</style></head><body>' + content + '</body></html>');
            w.document.close();
            w.print();
        }

        // Payments
        function loadPayments() {
            api('/bills').then(function(bills) {
                document.getElementById('payBill').innerHTML = '<option value="">-- Select --</option>' + bills.map(function(b) {
                    return '<option value="' + b.billNumber + '">' + b.billNumber + ' - ' + b.period + ' ' + b.year + ' (' + fmt(b.outstanding) + ' due)</option>';
                }).join('');
            });
            if (!document.getElementById('payDate').value) {
                document.getElementById('payDate').valueAsDate = new Date();
            }
            api('/payments').then(function(payments) {
                document.getElementById('payTable').innerHTML = payments.map(function(p) {
                    return '<tr><td>' + fmtDate(p.date) + '</td><td>' + p.billNumber + '</td><td>' + p.period + ' ' + p.year + '</td><td class="amount-positive">+' + fmt(p.amount) + '</td><td>' + (p.reference || '-') + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editPayment(' + p.id + ')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deletePayment(' + p.id + ')">üóëÔ∏è</button></td></tr>';
                }).join('') || '<tr><td colspan="6">No payments</td></tr>';
            });
        }

        document.getElementById('payBill').addEventListener('change', function() {
            var bn = this.value;
            if (bn) {
                api('/bills').then(function(bills) {
                    var b = bills.find(function(x) { return x.billNumber === bn; });
                    if (b) document.getElementById('payOut').value = fmt(b.outstanding) + ' XAF';
                });
            }
        });

        function editPayment(id) {
            api('/payments/' + id).then(function(p) {
                document.getElementById('payId').value = id;
                document.getElementById('payBill').value = p.billNumber;
                document.getElementById('payAmt').value = p.amount;
                document.getElementById('payDate').value = p.date.split('T')[0];
                document.getElementById('payRef').value = p.reference || '';
            });
        }

        function savePayment() {
            var id = document.getElementById('payId').value;
            var data = {
                billNumber: document.getElementById('payBill').value,
                amount: parseInt(document.getElementById('payAmt').value),
                date: document.getElementById('payDate').value,
                reference: document.getElementById('payRef').value
            };
            if (!data.billNumber || !data.amount) {
                showAlert('Fill required fields', 'error');
                return;
            }
            var url = id ? '/payments/' + id : '/payments';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                showAlert(id ? 'Updated!' : 'Saved!');
                clearPaymentForm();
                loadPayments();
                loadBills();
                loadDashboard();
            });
        }

        function deletePayment(id) {
            if (!confirm('Delete?')) return;
            api('/payments/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadPayments();
                loadBills();
                loadDashboard();
            });
        }

        function clearPaymentForm() {
            document.getElementById('payId').value = '';
            document.getElementById('payBill').value = '';
            document.getElementById('payOut').value = '';
            document.getElementById('payAmt').value = '';
            document.getElementById('payRef').value = '';
        }

        // Inheritance
        function loadInheritance() {
            api('/inheritance/calculate').then(function(d) {
                document.getElementById('inhAmt').textContent = fmt(d.inheritanceAmount) + ' XAF';
                document.getElementById('inhPaid').textContent = fmt(d.totalBillsPaid);
                document.getElementById('inhExp').textContent = fmt(d.totalExpenses);
                document.getElementById('inhRes').textContent = fmt(d.reserveFunds);
                document.getElementById('inhPortions').textContent = d.totalPortions;
                document.getElementById('inhPer').textContent = fmt(d.sharePerPortion);

                var html = '';
                for (var g in d.groupSummary) {
                    var i = d.groupSummary[g];
                    html += '<div class="heir-group"><h4>' + g + ' <span>' + i.count + '</span></h4><div class="summary-row"><span>Per heir:</span><span>' + fmt(Math.round(i.totalShare / i.count)) + ' XAF</span></div><div class="summary-row"><span>Total:</span><span>' + fmt(Math.round(i.totalShare)) + ' XAF</span></div></div>';
                }
                document.getElementById('heirGroups').innerHTML = html || '<p>No heirs</p>';

                document.getElementById('heirTable').innerHTML = d.heirs.map(function(h) {
                    return '<tr><td>' + h.name + '</td><td>' + h.relationship + '</td><td>' + h.heir_group + '</td><td>' + h.portions + '</td><td class="amount-positive">' + fmt(Math.round(h.shareAmount)) + '</td><td class="no-print"><button class="btn btn-gold btn-sm" onclick="printHeirCertificate(' + h.id + ')">üìú</button> <button class="btn btn-warning btn-sm" onclick="editHeir(' + h.id + ')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteHeir(' + h.id + ')">üóëÔ∏è</button></td></tr>';
                }).join('') || '<tr><td colspan="6">No heirs</td></tr>';
            });
        }

        function openHeirModal() { document.getElementById('heirModal').classList.add('active'); }
        function closeHeirModal() {
            document.getElementById('heirModal').classList.remove('active');
            document.getElementById('heirId').value = '';
            document.getElementById('heirName').value = '';
        }

        function editHeir(id) {
            api('/heirs').then(function(heirs) {
                var h = heirs.find(function(x) { return x.id === id; });
                if (h) {
                    document.getElementById('heirId').value = id;
                    document.getElementById('heirName').value = h.name;
                    document.getElementById('heirRel').value = h.relationship;
                    document.getElementById('heirGrp').value = h.heir_group;
                    document.getElementById('heirPor').value = h.portions;
                    openHeirModal();
                }
            });
        }

        function saveHeir() {
            var id = document.getElementById('heirId').value;
            var data = {
                name: document.getElementById('heirName').value,
                relationship: document.getElementById('heirRel').value,
                heirGroup: document.getElementById('heirGrp').value,
                portions: parseFloat(document.getElementById('heirPor').value)
            };
            if (!data.name) { showAlert('Enter name', 'error'); return; }
            var url = id ? '/heirs/' + id : '/heirs';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                showAlert(id ? 'Updated!' : 'Added!');
                closeHeirModal();
                loadInheritance();
            });
        }

        function deleteHeir(id) {
            if (!confirm('Delete?')) return;
            api('/heirs/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadInheritance();
            });
        }

        // Heir Certificates
        function printHeirCertificate(heirId) {
            api('/inheritance/calculate').then(function(d) {
                var h = d.heirs.find(function(x) { return x.id === heirId; });
                if (!h) { showAlert('Heir not found', 'error'); return; }
                var certHtml = generateCertificateHTML(h, d);
                var w = window.open('', '_blank');
                w.document.write(certHtml);
                w.document.close();
                w.print();
            });
        }

        function printAllHeirCertificates() {
            api('/inheritance/calculate').then(function(d) {
                if (d.heirs.length === 0) { showAlert('No heirs', 'error'); return; }
                var allCerts = '<html><head><title>Certificates</title><style>@page{size:A5;margin:10mm;}body{font-family:Georgia,serif;margin:0;padding:0;}.certificate{page-break-after:always;padding:15mm;border:3px double #1a365d;margin:5mm;}.certificate:last-child{page-break-after:auto;}.cert-header{text-align:center;border-bottom:2px solid #d69e2e;padding-bottom:10px;margin-bottom:15px;}.cert-header h1{color:#1a365d;font-size:20px;margin:0;}.heir-name{text-align:center;font-size:24px;color:#1a365d;font-weight:bold;margin:20px 0;padding:10px;background:linear-gradient(135deg,rgba(214,158,46,0.1),rgba(237,137,54,0.1));border-radius:8px;}.cert-details{margin:15px 0;}.detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dotted #ccc;}.share-amount{text-align:center;margin:20px 0;padding:15px;background:#1a365d;color:white;border-radius:8px;}.share-amount strong{font-size:28px;color:#d69e2e;}.signature-line{margin-top:30px;display:flex;justify-content:space-between;}.sig-block{text-align:center;width:40%;}.sig-line{border-top:1px solid #333;margin-top:40px;padding-top:5px;}</style></head><body>';
                d.heirs.forEach(function(h) { allCerts += generateCertificateBody(h, d); });
                allCerts += '</body></html>';
                var w = window.open('', '_blank');
                w.document.write(allCerts);
                w.document.close();
                w.print();
            });
        }

        function generateCertificateHTML(h, d) {
            return '<html><head><title>Certificate - ' + h.name + '</title><style>body{font-family:Georgia,serif;margin:0;padding:20mm;}.certificate{padding:20mm;border:3px double #1a365d;}.cert-header{text-align:center;border-bottom:2px solid #d69e2e;padding-bottom:15px;margin-bottom:20px;}.cert-header h1{color:#1a365d;font-size:24px;margin:0;}.heir-name{text-align:center;font-size:28px;color:#1a365d;font-weight:bold;margin:25px 0;padding:15px;background:linear-gradient(135deg,rgba(214,158,46,0.1),rgba(237,137,54,0.1));border-radius:10px;}.cert-details{margin:20px 0;}.detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dotted #ccc;}.share-amount{text-align:center;margin:25px 0;padding:20px;background:#1a365d;color:white;border-radius:10px;}.share-amount strong{font-size:32px;color:#d69e2e;}.signature-line{margin-top:40px;display:flex;justify-content:space-between;}.sig-block{text-align:center;width:40%;}.sig-line{border-top:1px solid #333;margin-top:50px;padding-top:5px;}</style></head><body>' + generateCertificateBody(h, d) + '</body></html>';
        }

        function generateCertificateBody(h, d) {
            return '<div class="certificate"><div class="cert-header"><h1>CAMPOST MANKON</h1><p style="color:#666;font-size:12px;">GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868</p></div><div style="text-align:center;margin:15px 0;"><h2 style="color:#d69e2e;font-size:18px;">üìú INHERITANCE SHARE CERTIFICATE</h2></div><p style="text-align:center;color:#666;font-size:12px;">This certifies that the following heir is entitled to receive their share:</p><div class="heir-name">' + h.name + '</div><div class="cert-details"><div class="detail-row"><span>Relationship:</span><span style="font-weight:bold;">' + h.relationship + '</span></div><div class="detail-row"><span>Heir Group:</span><span style="font-weight:bold;">' + h.heir_group + '</span></div><div class="detail-row"><span>Portions:</span><span style="font-weight:bold;">' + h.portions + ' of ' + d.totalPortions + '</span></div><div class="detail-row"><span>Total Distribution:</span><span style="font-weight:bold;">' + fmt(d.inheritanceAmount) + ' XAF</span></div><div class="detail-row"><span>Per Portion:</span><span style="font-weight:bold;">' + fmt(d.sharePerPortion) + ' XAF</span></div></div><div class="share-amount"><p style="margin:0 0 5px;opacity:0.8;">ENTITLED SHARE AMOUNT</p><strong>' + fmt(Math.round(h.shareAmount)) + ' XAF</strong></div><div class="signature-line"><div class="sig-block"><div class="sig-line">Authorized Signature</div></div><div class="sig-block"><div class="sig-line">Heir Signature</div></div></div><p style="text-align:center;margin-top:20px;font-size:10px;color:#666;">Generated on ' + today() + '</p></div>';
        }

        // Export functions
        function exportCSV(type) {
            var h = 'CAMPOST MANKON - GHOUENZEN Soulemanou\nB.P 36 Mankon-Bamenda | Tel: 675299868\n\n';
            if (type === 'bills') {
                api('/bills').then(function(d) {
                    var csv = h + 'Bill Number,Quarter,Period,Year,Due,Paid,Outstanding,Status\n';
                    d.forEach(function(b) { csv += b.billNumber + ',' + b.quarter + ',' + b.period + ',' + b.year + ',' + b.amountDue + ',' + b.paidAmount + ',' + b.outstanding + ',' + (b.outstanding === 0 ? 'Paid' : 'Outstanding') + '\n'; });
                    download(csv, 'campost_bills.csv');
                });
            } else if (type === 'payments') {
                api('/payments').then(function(d) {
                    var csv = h + 'Date,Bill,Period,Year,Amount,Reference\n';
                    d.forEach(function(p) { csv += p.date + ',' + p.billNumber + ',' + p.period + ',' + p.year + ',' + p.amount + ',"' + (p.reference || '') + '"\n'; });
                    download(csv, 'campost_payments.csv');
                });
            } else if (type === 'expenses') {
                api('/expenses').then(function(d) {
                    var csv = h + 'Date,Description,Category,Amount\n';
                    d.forEach(function(e) { csv += e.date + ',"' + e.description + '",' + e.categoryName + ',' + e.amount + '\n'; });
                    download(csv, 'campost_expenses.csv');
                });
            } else if (type === 'ledger') {
                Promise.all([api('/payments'), api('/expenses')]).then(function(results) {
                    var payments = results[0];
                    var expenses = results[1];
                    var csv = h + 'Date,Description,Type,Income,Expense,Balance\n';
                    
                    var ledgerEntries = [];
                    payments.forEach(function(p) {
                        ledgerEntries.push({ date: p.date, description: 'Payment: ' + p.billNumber, type: 'Income', income: p.amount, expense: 0 });
                    });
                    expenses.forEach(function(e) {
                        ledgerEntries.push({ date: e.date, description: e.description, type: e.categoryName, income: 0, expense: e.amount });
                    });
                    ledgerEntries.sort(function(a, b) { return new Date(a.date) - new Date(b.date); });
                    
                    var balance = 0;
                    ledgerEntries.forEach(function(entry) {
                        balance += entry.income - entry.expense;
                        csv += entry.date + ',"' + entry.description + '",' + entry.type + ',' + entry.income + ',' + entry.expense + ',' + balance + '\n';
                    });
                    download(csv, 'campost_ledger.csv');
                });
            }
        }

        function exportAllCSV() {
            api('/export/all').then(function(all) {
                var csv = 'CAMPOST MANKON - GHOUENZEN Soulemanou\nB.P 36 Mankon-Bamenda | Tel: 675299868\n';
                csv += '\nSUMMARY\nTotal Bills Paid: ' + all.summary.totalBillsPaid + '\nTotal Expenses: ' + all.summary.totalExpenses + '\nReserve Funds: ' + all.summary.reserveFunds + '\n';
                csv += '\n\nBILLS\nBill Number,Period,Year,Amount Due,Paid,Outstanding\n';
                all.bills.forEach(function(b) { csv += b.bill_number + ',' + b.period + ',' + b.year + ',' + b.amount_due + ',' + b.paid_amount + ',' + b.outstanding + '\n'; });
                csv += '\n\nPAYMENTS\nDate,Bill,Amount,Reference\n';
                all.payments.forEach(function(p) { csv += p.payment_date + ',' + p.bill_number + ',' + p.amount + ',"' + (p.reference || '') + '"\n'; });
                csv += '\n\nEXPENSES\nDate,Description,Category,Amount\n';
                all.expenses.forEach(function(e) { csv += e.expense_date + ',"' + e.description + '",' + e.category_name + ',' + e.amount + '\n'; });
                csv += '\n\nHEIRS\nName,Relationship,Group,Portions\n';
                all.heirs.forEach(function(h) { csv += h.name + ',' + h.relationship + ',' + h.heir_group + ',' + h.portions + '\n'; });
                download(csv, 'campost_all_data.csv');
            });
        }

        function exportPDF(type) {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('CAMPOST MANKON', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868', 105, 22, { align: 'center' });
            doc.line(20, 25, 190, 25);

            if (type === 'bills') {
                api('/bills').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('BILLS REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Bill #', 'Period', 'Year', 'Due', 'Paid', 'Outstanding']], body: d.map(function(b) { return [b.billNumber, b.period, b.year, fmt(b.amountDue), fmt(b.paidAmount), fmt(b.outstanding)]; }), styles: { fontSize: 8 } });
                    doc.save('campost_bills.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'payments') {
                api('/payments').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PAYMENTS REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Date', 'Bill #', 'Period', 'Amount', 'Reference']], body: d.map(function(p) { return [fmtDate(p.date), p.billNumber, p.period + ' ' + p.year, fmt(p.amount), p.reference || '-']; }), styles: { fontSize: 8 } });
                    doc.save('campost_payments.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'expenses') {
                api('/expenses').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('EXPENSES REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Date', 'Description', 'Category', 'Amount']], body: d.map(function(e) { return [fmtDate(e.date), e.description.substring(0, 35), e.categoryName, fmt(e.amount)]; }), styles: { fontSize: 8 } });
                    doc.save('campost_expenses.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'ledger') {
                Promise.all([api('/payments'), api('/expenses')]).then(function(results) {
                    var payments = results[0];
                    var expenses = results[1];
                    
                    // Build ledger entries
                    var ledgerEntries = [];
                    payments.forEach(function(p) {
                        ledgerEntries.push({
                            date: p.date,
                            description: 'Payment: ' + p.billNumber,
                            type: 'Income',
                            income: p.amount,
                            expense: 0
                        });
                    });
                    expenses.forEach(function(e) {
                        ledgerEntries.push({
                            date: e.date,
                            description: e.description.substring(0, 30),
                            type: e.categoryName,
                            income: 0,
                            expense: e.amount
                        });
                    });
                    
                    // Sort by date
                    ledgerEntries.sort(function(a, b) {
                        return new Date(a.date) - new Date(b.date);
                    });
                    
                    // Calculate running balance
                    var runningBalance = 0;
                    var totalIncome = 0;
                    var totalExpense = 0;
                    var tableData = ledgerEntries.map(function(entry) {
                        if (entry.income > 0) {
                            runningBalance += entry.income;
                            totalIncome += entry.income;
                        }
                        if (entry.expense > 0) {
                            runningBalance -= entry.expense;
                            totalExpense += entry.expense;
                        }
                        return [
                            fmtDate(entry.date),
                            entry.description,
                            entry.type,
                            entry.income > 0 ? fmt(entry.income) : '-',
                            entry.expense > 0 ? fmt(entry.expense) : '-',
                            fmt(runningBalance)
                        ];
                    });
                    
                    // Add totals row
                    tableData.push(['', '', 'TOTALS:', fmt(totalIncome), fmt(totalExpense), fmt(runningBalance)]);
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('LEDGER REPORT', 105, 35, { align: 'center' });
                    doc.setFontSize(9);
                    doc.text('Total Income: ' + fmt(totalIncome) + ' XAF | Total Expenses: ' + fmt(totalExpense) + ' XAF | Balance: ' + fmt(runningBalance) + ' XAF', 105, 42, { align: 'center' });
                    doc.autoTable({ 
                        startY: 48, 
                        head: [['Date', 'Description', 'Type', 'Income', 'Expense', 'Balance']], 
                        body: tableData, 
                        styles: { fontSize: 7 },
                        headStyles: { fillColor: [44, 82, 130] },
                        footStyles: { fillColor: [247, 250, 252], textColor: [0, 0, 0], fontStyle: 'bold' }
                    });
                    doc.save('campost_ledger.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'heirs') {
                api('/inheritance/calculate').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('INHERITANCE REPORT', 105, 35, { align: 'center' });
                    doc.setFontSize(10);
                    doc.text('Amount: ' + fmt(d.inheritanceAmount) + ' XAF | Per Portion: ' + fmt(d.sharePerPortion) + ' XAF', 105, 42, { align: 'center' });
                    doc.autoTable({ startY: 48, head: [['Name', 'Relationship', 'Group', 'Portions', 'Share']], body: d.heirs.map(function(h) { return [h.name, h.relationship, h.heir_group, h.portions, fmt(Math.round(h.shareAmount))]; }), styles: { fontSize: 8 } });
                    doc.save('campost_heirs.pdf');
                    showAlert('PDF exported!');
                });
            }
        }

        function exportAllPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            Promise.all([api('/export/all'), api('/inheritance/calculate')]).then(function(results) {
                var all = results[0];
                var inh = results[1];
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('CAMPOST MANKON', 105, 15, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868', 105, 22, { align: 'center' });
                doc.line(20, 25, 190, 25);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('FINANCIAL SUMMARY', 20, 33);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Bills Paid: ' + fmt(all.summary.totalBillsPaid) + ' | Expenses: ' + fmt(all.summary.totalExpenses) + ' | Reserve: ' + fmt(all.summary.reserveFunds), 20, 40);
                doc.text('BILLS', 20, 50);
                doc.autoTable({ startY: 53, head: [['Bill #', 'Period', 'Year', 'Due', 'Paid', 'Outstanding']], body: all.bills.map(function(b) { return [b.bill_number, b.period, b.year, fmt(b.amount_due), fmt(b.paid_amount), fmt(b.outstanding)]; }), styles: { fontSize: 7 } });
                doc.addPage();
                doc.setFont('helvetica', 'bold');
                doc.text('PAYMENTS', 20, 15);
                doc.autoTable({ startY: 18, head: [['Date', 'Bill', 'Amount', 'Reference']], body: all.payments.map(function(p) { return [p.payment_date ? p.payment_date.split('T')[0] : '', p.bill_number, fmt(p.amount), p.reference || '']; }), styles: { fontSize: 7 } });
                var y = doc.lastAutoTable.finalY + 10;
                doc.text('EXPENSES', 20, y);
                doc.autoTable({ startY: y + 3, head: [['Date', 'Description', 'Category', 'Amount']], body: all.expenses.map(function(e) { return [e.expense_date ? e.expense_date.split('T')[0] : '', e.description ? e.description.substring(0, 25) : '', e.category_name || '', fmt(e.amount)]; }), styles: { fontSize: 7 } });
                doc.addPage();
                doc.text('INHERITANCE (' + fmt(inh.inheritanceAmount) + ' XAF)', 20, 15);
                doc.autoTable({ startY: 20, head: [['Name', 'Relationship', 'Group', 'Portions', 'Share']], body: inh.heirs.map(function(h) { return [h.name, h.relationship, h.heir_group, h.portions, fmt(Math.round(h.shareAmount))]; }), styles: { fontSize: 7 } });
                doc.save('campost_complete_report.pdf');
                showAlert('Complete PDF exported!');
            });
        }

        function download(content, filename) {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content], { type: 'text/csv' }));
            a.download = filename;
            a.click();
            showAlert('Exported!');
        }

        function printPage(pageId) {
            document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('printing'); });
            document.getElementById(pageId).classList.add('printing');
            window.print();
        }

        // Settings
        function checkDb() {
            api('/status').then(function(s) {
                document.getElementById('dbStatus').textContent = s.connected ? '‚úì Connected' : '‚úó Offline';
                document.getElementById('dbStatus').className = 'db-status ' + (s.connected ? 'connected' : 'disconnected');
                document.getElementById('settingsAlert').className = 'alert alert-' + (s.connected ? 'success' : 'error');
                document.getElementById('settingsAlert').innerHTML = s.connected ? '‚úì PostgreSQL Connected' : '‚úó Offline';
            }).catch(function() {
                document.getElementById('dbStatus').textContent = '‚úó Offline';
                document.getElementById('dbStatus').className = 'db-status disconnected';
            });
        }

        function resetAll() {
            if (!confirm('RESET ALL DATA?')) return;
            api('/reset', { method: 'POST' }).then(function() {
                showAlert('Data reset!');
                loadDashboard();
            });
        }

        // Initialize
        function init() {
            checkDb();
            loadDashboard();
        }

        init();
    </script>
</body>
</html>
