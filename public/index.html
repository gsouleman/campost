<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAMPOST MANKON - Property & Billing Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-dark: #1a365d;
            --primary-blue: #2c5282;
            --primary-light: #4299e1;
            --accent-gold: #d69e2e;
            --accent-orange: #ed8936;
            --success-green: #38a169;
            --danger-red: #e53e3e;
            --bg-cream: #faf5eb;
            --bg-white: #ffffff;
            --text-dark: #1a202c;
            --text-gray: #4a5568;
            --border-color: #e2e8f0;
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans Pro', sans-serif; background: linear-gradient(135deg, var(--bg-cream) 0%, #e8e0d5 100%); min-height: 100vh; color: var(--text-dark); }
        
        .header { background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%); color: white; position: sticky; top: 0; z-index: 1000; }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 1.5rem; flex-wrap: wrap; gap: 0.5rem; }
        .logo-section { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 38px; height: 38px; background: var(--accent-gold); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--primary-dark); }
        .logo-text h1 { font-family: 'Playfair Display', serif; font-size: 1.2rem; }
        .logo-text p { font-size: 0.65rem; opacity: 0.8; }
        .header-info { text-align: right; font-size: 0.75rem; }
        .db-status { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 10px; font-size: 0.6rem; margin-top: 0.1rem; }
        .db-status.connected { background: rgba(56,161,105,0.3); color: #9ae6b4; }
        .db-status.disconnected { background: rgba(229,62,62,0.3); color: #feb2b2; }
        
        .nav { display: flex; padding: 0 0.5rem; flex-wrap: wrap; overflow-x: auto; border-top: 1px solid rgba(255,255,255,0.1); }
        .nav-btn { background: transparent; border: none; color: white; padding: 0.5rem 0.7rem; font-size: 0.75rem; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); }
        .nav-btn.active { background: rgba(255,255,255,0.15); border-bottom-color: var(--accent-gold); }
        
        .main-content { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: var(--bg-white); border-radius: 10px; box-shadow: var(--shadow-md); margin-bottom: 1rem; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%); color: white; padding: 0.75rem 1rem; font-family: 'Playfair Display', serif; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-header.green { background: linear-gradient(135deg, var(--success-green) 0%, #276749 100%); }
        .card-header.gold { background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%); }
        .card-body { padding: 1rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .stat-card { background: var(--bg-white); border-radius: 8px; padding: 0.75rem; box-shadow: var(--shadow-md); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.blue::before { background: var(--primary-blue); }
        .stat-card.green::before { background: var(--success-green); }
        .stat-card.red::before { background: var(--danger-red); }
        .stat-card.gold::before { background: var(--accent-gold); }
        .stat-icon { font-size: 1.1rem; margin-bottom: 0.2rem; }
        .stat-value { font-size: 1rem; font-weight: 700; margin-bottom: 0.1rem; }
        .stat-label { color: var(--text-gray); font-size: 0.65rem; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; }
        .form-group { margin-bottom: 0.75rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 600; font-size: 0.75rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.4rem 0.6rem; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-blue); }
        .form-group input:read-only { background: #f7fafc; }
        
        .btn { padding: 0.4rem 0.8rem; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.25rem; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success-green) 0%, #276749 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger-red) 0%, #c53030 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--accent-orange) 0%, #c05621 100%); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary-blue); color: var(--primary-blue); }
        .btn-print { background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%); color: white; }
        .btn-gold { background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%); color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
        .btn-group { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
        
        .table-container { overflow-x: auto; border-radius: 6px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; min-width: 400px; }
        th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.8rem; }
        th { background: #f7fafc; font-weight: 700; font-size: 0.7rem; text-transform: uppercase; }
        tr:hover { background: #f7fafc; }
        tr.clickable { cursor: pointer; }
        tr.clickable:hover { background: rgba(66,153,225,0.1); }
        
        .badge { padding: 0.15rem 0.35rem; border-radius: 8px; font-size: 0.6rem; font-weight: 600; text-transform: uppercase; }
        .badge-income { background: rgba(56,161,105,0.15); color: var(--success-green); }
        .badge-expense { background: rgba(229,62,62,0.15); color: var(--danger-red); }
        .badge-inheritance { background: rgba(214,158,46,0.15); color: var(--accent-gold); }
        .badge-paid { background: rgba(56,161,105,0.15); color: var(--success-green); }
        .badge-partial { background: rgba(236,201,75,0.2); color: #b7791f; }
        .badge-unpaid { background: rgba(229,62,62,0.15); color: var(--danger-red); }
        .badge-new { background: rgba(66,153,225,0.15); color: var(--primary-blue); }
        
        .amount-positive { color: var(--success-green); font-weight: 600; }
        .amount-negative { color: var(--danger-red); font-weight: 600; }
        .amount-gold { color: var(--accent-gold); font-weight: 600; }
        
        .alert { padding: 0.6rem 0.9rem; border-radius: 6px; margin-bottom: 0.75rem; font-size: 0.8rem; }
        .alert-success { background: rgba(56,161,105,0.15); color: var(--success-green); border: 1px solid var(--success-green); }
        .alert-error { background: rgba(229,62,62,0.15); color: var(--danger-red); border: 1px solid var(--danger-red); }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 10px; max-width: 750px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%); color: white; padding: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }
        .modal-body { padding: 1.25rem; }
        
        .heir-group { background: #f7fafc; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem; }
        .heir-group h4 { color: var(--primary-blue); margin-bottom: 0.3rem; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .summary-row { display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px dashed var(--border-color); font-size: 0.8rem; }
        .summary-row:last-child { border-bottom: none; font-weight: 700; }
        
        .highlight-box { background: linear-gradient(135deg, rgba(214,158,46,0.15) 0%, rgba(237,137,54,0.15) 100%); border: 2px solid var(--accent-gold); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; text-align: center; }
        .highlight-box h3 { color: var(--accent-gold); font-size: 1.3rem; }
        .highlight-box p { font-size: 0.75rem; color: var(--text-gray); }
        
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1rem; }
        .tab-btn { background: none; border: none; padding: 0.5rem 1rem; font-size: 0.8rem; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { border-bottom-color: var(--primary-blue); color: var(--primary-blue); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        @media print { body { background: white !important; } .no-print { display: none !important; } }
        @media (max-width: 768px) { .header-top { flex-direction: column; text-align: center; } .main-content { padding: 0.5rem; } }
    </style>
</head>
<body>
    <header class="header no-print">
        <div class="header-top">
            <div class="logo-section">
                <div class="logo-icon">CP</div>
                <div class="logo-text"><h1>CAMPOST MANKON</h1><p>Property & Billing Management</p></div>
            </div>
            <div class="header-info">
                <strong>GHOUENZEN Soulemanou</strong><br>
                <span>B.P 36 Mankon-Bamenda | 675299868</span>
                <div class="db-status disconnected" id="dbStatus">Connecting...</div>
            </div>
        </div>
        <nav class="nav">
            <button class="nav-btn active" data-page="dashboard">ğŸ“Š Dashboard</button>
            <button class="nav-btn" data-page="ledger">ğŸ“’ Ledger</button>
            <button class="nav-btn" data-page="expenses">ğŸ’¸ Expenses</button>
            <button class="nav-btn" data-page="bills">ğŸ“„ Bills</button>
            <button class="nav-btn" data-page="payments">ğŸ’µ Payments</button>
            <button class="nav-btn" data-page="inheritance">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Inheritance</button>
            <button class="nav-btn" data-page="realestate">ğŸ  Family Real Estates</button>
            <button class="nav-btn" data-page="export">ğŸ“¥ Export</button>
            <button class="nav-btn" data-page="settings">âš™ï¸ Settings</button>
        </nav>
    </header>

    <main class="main-content">
        <!-- DASHBOARD -->
        <div id="dashboard" class="page active">
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">ğŸ’µ</div><div class="stat-value" id="dashIncome">0</div><div class="stat-label">Total Income</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ’¸</div><div class="stat-value" id="dashExp">0</div><div class="stat-label">Total Expenses</div></div>
                <div class="stat-card blue"><div class="stat-icon">ğŸ¦</div><div class="stat-value" id="dashReserve">0</div><div class="stat-label">Reserve Funds</div></div>
                <div class="stat-card gold"><div class="stat-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div><div class="stat-value" id="dashInh">0</div><div class="stat-label">Inheritance Pool</div></div>
            </div>
            <div class="card">
                <div class="card-header"><span>ğŸ“Š Financial Summary</span></div>
                <div class="card-body">
                    <div class="summary-row"><span>Total Income (Bills Paid):</span><span class="amount-positive" id="dashIncomeSum">0 XAF</span></div>
                    <div class="summary-row"><span>Total Expenses:</span><span class="amount-negative" id="dashExpSum">0 XAF</span></div>
                    <div class="summary-row" style="font-size: 1rem;"><span><strong>Reserve Funds (Income - Expenses):</strong></span><span id="dashReserveSum" style="font-weight: bold;">0 XAF</span></div>
                    <div class="summary-row"><span>Inheritance Pool (from distributions):</span><span class="amount-gold" id="dashInhSum">0 XAF</span></div>
                </div>
            </div>
        </div>

        <!-- LEDGER -->
        <div id="ledger" class="page">
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">ğŸ’µ</div><div class="stat-value" id="ledgerIncome">0</div><div class="stat-label">Total Income (from Bills)</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ’¸</div><div class="stat-value" id="ledgerExpense">0</div><div class="stat-label">Total Expenses</div></div>
                <div class="stat-card blue"><div class="stat-icon">ğŸ¦</div><div class="stat-value" id="ledgerBalance">0</div><div class="stat-label">Balance (Reserve)</div></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“’ Ledger - Income & Expenses (Auto-Generated)</span>
                    <div class="no-print">
                        <button class="btn btn-print btn-sm" onclick="exportPDF('ledger')">ğŸ“¥ Export PDF</button>
                        <button class="btn btn-outline btn-sm" onclick="exportCSV('ledger')">ğŸ“¥ Export CSV</button>
                        <button class="btn btn-print btn-sm" onclick="printPage('ledger')">ğŸ–¨ï¸ Print</button>
                    </div>
                </div>
                <div class="card-body">
                    <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                        ğŸ“Œ <strong>Income</strong> = Bills with status Paid or Partial | <strong>Expenses</strong> = All recorded expenses
                    </p>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th style="background: #c6f6d5; color: #276749;">Income (Credit)</th>
                                    <th style="background: #fed7d7; color: #c53030;">Expense (Debit)</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody id="ledgerTable"></tbody>
                            <tfoot id="ledgerTotals"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXPENSES -->
        <div id="expenses" class="page">
            <div class="card no-print">
                <div class="card-header green"><span>â• Add/Edit Expense</span></div>
                <div class="card-body">
                    <input type="hidden" id="expId">
                    <div class="form-grid">
                        <div class="form-group"><label>Date</label><input type="date" id="expDate"></div>
                        <div class="form-group"><label>Description</label><input type="text" id="expDesc" placeholder="Description"></div>
                        <div class="form-group"><label>Category</label><select id="expCat"></select></div>
                        <div class="form-group"><label>Amount (XAF)</label><input type="number" id="expAmt" placeholder="Amount"></div>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="saveExpense()">ğŸ’¾ Save</button><button class="btn btn-outline" onclick="clearExpenseForm()">ğŸ”„ Clear</button></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><span>ğŸ’¸ Expenses</span><button class="btn btn-print btn-sm no-print" onclick="printPage('expenses')">ğŸ–¨ï¸ Print</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th class="no-print">Actions</th></tr></thead><tbody id="expTable"></tbody></table></div></div></div>
        </div>

        <!-- BILLS -->
        <div id="bills" class="page">
            <div class="card no-print">
                <div class="card-header green"><span>â• Add/Edit Bill</span></div>
                <div class="card-body">
                    <input type="hidden" id="billEditMode"><input type="hidden" id="billOldNumber">
                    <div class="form-grid">
                        <div class="form-group"><label>Quarter</label><select id="billQ"><option value="Q1">Q1</option><option value="Q2">Q2</option><option value="Q3">Q3</option><option value="Q4">Q4</option></select></div>
                        <div class="form-group"><label>Year</label><select id="billY"></select></div>
                        <div class="form-group"><label>Period</label><select id="billP"><option value="January to March">January to March</option><option value="April to June">April to June</option><option value="July to September">July to September</option><option value="October to December">October to December</option></select></div>
                        <div class="form-group"><label>Bill Number</label><input type="text" id="billNum" readonly></div>
                    </div>
                    <div style="background: #ebf8ff; padding: 12px; border-radius: 8px; margin: 10px 0; border: 1px solid #90cdf4;">
                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; font-size: 0.85rem;">
                            <div><span style="color: #4a5568;">Monthly Rate:</span> <strong id="billShowRate">200,000</strong> XAF</div>
                            <div><span style="color: #4a5568;">Gross (3 mo):</span> <strong id="billShowGross">600,000</strong> XAF</div>
                            <div><span style="color: #4a5568;">Tax (<span id="billShowTaxPct">15</span>%):</span> <strong id="billShowTax" style="color: #e53e3e;">-90,000</strong> XAF</div>
                            <div><span style="color: #4a5568;">Net Due:</span> <strong id="billShowNet" style="color: #38a169;">510,000</strong> XAF</div>
                        </div>
                        <p style="margin-top: 8px; font-size: 0.7rem; color: #718096;">ğŸ’¡ To change monthly rate or tax rate, go to <strong>Settings</strong> tab</p>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="saveBill()">ğŸ’¾ Save Bill</button><button class="btn btn-outline" onclick="clearBillForm()">ğŸ”„ Clear</button></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><span>ğŸ“„ All Bills (Click to View Invoice)</span><button class="btn btn-print btn-sm no-print" onclick="printPage('bills')">ğŸ–¨ï¸ Print List</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Bill #</th><th>Period</th><th>Due</th><th>Paid</th><th>Outstanding</th><th>Status</th><th class="no-print">Actions</th></tr></thead><tbody id="billTable"></tbody></table></div></div></div>
        </div>

        <!-- PAYMENTS -->
        <div id="payments" class="page">
            <div class="card no-print">
                <div class="card-header green"><span>â• Add/Edit Payment</span></div>
                <div class="card-body">
                    <input type="hidden" id="payId">
                    <div class="form-grid">
                        <div class="form-group"><label>Select Bill</label><select id="payBill"></select></div>
                        <div class="form-group"><label>Outstanding</label><input type="text" id="payOut" readonly></div>
                        <div class="form-group"><label>Amount (XAF)</label><input type="number" id="payAmt"></div>
                        <div class="form-group"><label>Date</label><input type="date" id="payDate"></div>
                        <div class="form-group"><label>Reference</label><input type="text" id="payRef" placeholder="Receipt #"></div>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="savePayment()">ğŸ’¾ Save</button><button class="btn btn-outline" onclick="clearPaymentForm()">ğŸ”„ Clear</button></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><span>ğŸ’µ Payments</span><button class="btn btn-print btn-sm no-print" onclick="printPage('payments')">ğŸ–¨ï¸ Print</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Date</th><th>Bill #</th><th>Period</th><th>Amount</th><th>Reference</th><th class="no-print">Actions</th></tr></thead><tbody id="payTable"></tbody></table></div></div></div>
        </div>

        <!-- INHERITANCE -->
        <div id="inheritance" class="page">
            <div class="highlight-box">
                <p>Amount to Distribute (from Inheritance Share expenses)</p>
                <h3 id="inhAmt">0 XAF</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">ğŸ’µ</div><div class="stat-value" id="inhPaid">0</div><div class="stat-label">Bills Paid</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ’¸</div><div class="stat-value" id="inhExp">0</div><div class="stat-label">Expenses</div></div>
                <div class="stat-card blue"><div class="stat-icon">ğŸ¦</div><div class="stat-value" id="inhRes">0</div><div class="stat-label">Reserve</div></div>
                <div class="stat-card gold"><div class="stat-icon">ğŸ“Š</div><div class="stat-value" id="inhPer">0</div><div class="stat-label">Per Portion</div></div>
            </div>
            <div class="card">
                <div class="card-header gold"><span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Heirs (<span id="inhPortions">24</span> portions)</span>
                <div class="no-print"><button class="btn btn-outline btn-sm" onclick="openHeirModal()">â• Add</button><button class="btn btn-gold btn-sm" onclick="printAllHeirCertificates()">ğŸ–¨ï¸ Print All Certificates</button></div>
                </div>
                <div class="card-body" id="heirGroups"></div>
            </div>
            <div class="card"><div class="card-header"><span>ğŸ“‹ Heir Shares</span><button class="btn btn-print btn-sm no-print" onclick="printPage('inheritance')">ğŸ–¨ï¸ Print Summary</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Name</th><th>Relationship</th><th>Group</th><th>Portions</th><th>Share (XAF)</th><th class="no-print">Actions</th></tr></thead><tbody id="heirTable"></tbody></table></div></div></div>
        </div>

        <!-- EXPORT -->
        <div id="export" class="page">
            <div class="card"><div class="card-header"><span>ğŸ“¥ Export All Data</span></div>
            <div class="card-body">
                <p style="margin-bottom:1rem;font-size:0.85rem;">Export with CAMPOST MANKON header.</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="exportAllCSV()">ğŸ“„ All CSV</button>
                    <button class="btn btn-print" onclick="exportAllPDF()">ğŸ“‘ All PDF</button>
                </div>
            </div></div>
            <div class="card"><div class="card-header"><span>ğŸ“Š Individual Exports</span></div>
            <div class="card-body">
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('bills')">Bills CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('payments')">Payments CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('expenses')">Expenses CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('ledger')">Ledger CSV</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-print btn-sm" onclick="exportPDF('bills')">Bills PDF</button>
                    <button class="btn btn-print btn-sm" onclick="exportPDF('payments')">Payments PDF</button>
                    <button class="btn btn-print btn-sm" onclick="exportPDF('expenses')">Expenses PDF</button>
                    <button class="btn btn-primary btn-sm" onclick="exportPDF('ledger')">Ledger PDF</button>
                    <button class="btn btn-gold btn-sm" onclick="exportPDF('heirs')">Heirs PDF</button>
                    <button class="btn btn-success btn-sm" onclick="exportPDF('properties')">Properties PDF</button>
                </div>
            </div></div>
        </div>

        <!-- FAMILY REAL ESTATES -->
        <div id="realestate" class="page">
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">ğŸ </div><div class="stat-value" id="reTotalProps">0</div><div class="stat-label">Total Properties</div></div>
                <div class="stat-card blue"><div class="stat-icon">ğŸ”‘</div><div class="stat-value" id="reRented">0</div><div class="stat-label">Rented Properties</div></div>
                <div class="stat-card gold"><div class="stat-icon">ğŸ’°</div><div class="stat-value" id="reTotalIncome">0</div><div class="stat-label">Total Income</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ’¸</div><div class="stat-value" id="reTotalExpenses">0</div><div class="stat-label">Total Expenses</div></div>
            </div>

            <!-- RE Navigation Tabs -->
            <div class="tabs" style="margin-bottom: 15px; flex-wrap: wrap;">
                <button class="tab-btn active" onclick="showRETab('rePropertiesTab', this)">ğŸ  Properties</button>
                <button class="tab-btn" onclick="showRETab('reIncomeTab', this)">ğŸ’µ Rental Income</button>
                <button class="tab-btn" onclick="showRETab('reBillsTab', this)">ğŸ“„ Bills</button>
                <button class="tab-btn" onclick="showRETab('rePaymentsTab', this)">ğŸ’³ Payments</button>
                <button class="tab-btn" onclick="showRETab('reExpensesTab', this)">ğŸ’¸ Expenses</button>
                <button class="tab-btn" onclick="showRETab('reInheritanceTab', this)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Inheritance</button>
                <button class="tab-btn" onclick="showRETab('reLedgerTab', this)">ğŸ“’ Ledger</button>
                <button class="tab-btn" onclick="showRETab('reExportTab', this)">ğŸ“¥ Export</button>
                <button class="tab-btn" onclick="showRETab('reSettingsTab', this)">âš™ï¸ Settings</button>
            </div>

            <!-- ========== PROPERTIES TAB ========== -->
            <div id="rePropertiesTab" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <span>ğŸ  Family Properties Portfolio</span>
                        <div class="no-print">
                            <button class="btn btn-success btn-sm" onclick="openPropertyModal()">â• Add Property</button>
                            <button class="btn btn-print btn-sm" onclick="exportPDF('properties')">ğŸ“¥ Export PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="margin-bottom: 10px;">
                            <select id="reStatusFilter" onchange="filterProperties()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="">All Status</option>
                                <option value="Rented">Rented</option>
                                <option value="Sold">Sold</option>
                                <option value="For sale">For Sale</option>
                                <option value="Not to be sold">Not to be Sold</option>
                                <option value="Shared">Shared</option>
                                <option value="Admin issues">Admin Issues</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Property Name</th>
                                        <th>Location</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Rent Amount</th>
                                        <th>Period</th>
                                        <th>Tax Rate</th>
                                        <th>Net Income</th>
                                        <th>Islamic Inh.</th>
                                        <th class="no-print">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="propertiesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RENTAL INCOME TAB ========== -->
            <div id="reIncomeTab" class="tab-content">
                <div class="card">
                    <div class="card-header gold">
                        <span>ğŸ’µ Rental Income Summary</span>
                        <button class="btn btn-print btn-sm no-print" onclick="exportPDF('rentalIncome')">ğŸ“¥ Export PDF</button>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px; background: #fffbeb; padding: 10px; border-radius: 6px;">
                            ğŸ“Œ <strong>Note:</strong> Only properties with status <strong>"Rented"</strong> have income. All other properties show Rent Amount, Period, Tax Rate, Gross Income, Tax Amount, and Net Income as <strong>0</strong>.
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Rent Amount</th>
                                        <th>Period</th>
                                        <th>Tax Rate</th>
                                        <th>Gross Income</th>
                                        <th>Tax Amount</th>
                                        <th>Net Income</th>
                                    </tr>
                                </thead>
                                <tbody id="rentalIncomeTable"></tbody>
                                <tfoot id="rentalIncomeTotals"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE BILLS TAB ========== -->
            <div id="reBillsTab" class="tab-content">
                <div class="card no-print">
                    <div class="card-header green"><span>â• Create Property Bill</span></div>
                    <div class="card-body">
                        <input type="hidden" id="reBillId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Property *</label>
                                <select id="reBillProperty"></select>
                            </div>
                            <div class="form-group">
                                <label>Bill Date *</label>
                                <input type="date" id="reBillDate">
                            </div>
                            <div class="form-group">
                                <label>Period *</label>
                                <select id="reBillPeriod">
                                    <option value="Jan-Mar">Jan-Mar (Q1)</option>
                                    <option value="Apr-Jun">Apr-Jun (Q2)</option>
                                    <option value="Jul-Sep">Jul-Sep (Q3)</option>
                                    <option value="Oct-Dec">Oct-Dec (Q4)</option>
                                    <option value="Monthly">Monthly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Year *</label>
                                <input type="number" id="reBillYear" value="2025">
                            </div>
                            <div class="form-group">
                                <label>Amount Due (XAF) *</label>
                                <input type="number" id="reBillAmount" placeholder="Amount">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="reBillDesc" placeholder="Bill description">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="saveREBill()">ğŸ’¾ Save Bill</button>
                            <button class="btn btn-outline" onclick="clearREBillForm()">ğŸ”„ Clear</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>ğŸ“„ Property Bills</span><button class="btn btn-print btn-sm no-print" onclick="exportPDF('reBills')">ğŸ“¥ Export PDF</button></div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Bill #</th><th>Property</th><th>Period</th><th>Year</th><th>Amount Due</th><th>Paid</th><th>Outstanding</th><th>Status</th><th class="no-print">Actions</th></tr></thead>
                                <tbody id="reBillsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE PAYMENTS TAB ========== -->
            <div id="rePaymentsTab" class="tab-content">
                <div class="card no-print">
                    <div class="card-header green"><span>â• Record Payment</span></div>
                    <div class="card-body">
                        <input type="hidden" id="rePayId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Bill *</label>
                                <select id="rePayBill"></select>
                            </div>
                            <div class="form-group">
                                <label>Payment Date *</label>
                                <input type="date" id="rePayDate">
                            </div>
                            <div class="form-group">
                                <label>Amount (XAF) *</label>
                                <input type="number" id="rePayAmount" placeholder="Payment amount">
                            </div>
                            <div class="form-group">
                                <label>Reference</label>
                                <input type="text" id="rePayRef" placeholder="Receipt/Reference number">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="saveREPayment()">ğŸ’¾ Save Payment</button>
                            <button class="btn btn-outline" onclick="clearREPaymentForm()">ğŸ”„ Clear</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>ğŸ’³ Payment History</span><button class="btn btn-print btn-sm no-print" onclick="exportPDF('rePayments')">ğŸ“¥ Export PDF</button></div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Date</th><th>Property</th><th>Bill #</th><th>Amount</th><th>Reference</th><th class="no-print">Actions</th></tr></thead>
                                <tbody id="rePaymentsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE EXPENSES TAB ========== -->
            <div id="reExpensesTab" class="tab-content">
                <div class="card no-print">
                    <div class="card-header green"><span>â• Add Property Expense</span></div>
                    <div class="card-body">
                        <input type="hidden" id="reExpId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Property *</label>
                                <select id="reExpProperty"></select>
                            </div>
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" id="reExpDate">
                            </div>
                            <div class="form-group">
                                <label>Category *</label>
                                <select id="reExpCategory">
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Repairs">Repairs</option>
                                    <option value="Taxes">Taxes</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Insurance">Insurance</option>
                                    <option value="Legal">Legal Fees</option>
                                    <option value="Agent Fees">Agent Fees</option>
                                    <option value="Inheritance Share">Inheritance Share</option>
                                    <option value="Others">Others</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Amount (XAF) *</label>
                                <input type="number" id="reExpAmount" placeholder="Amount">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Description *</label>
                                <input type="text" id="reExpDesc" placeholder="Expense description">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="saveREExpense()">ğŸ’¾ Save Expense</button>
                            <button class="btn btn-outline" onclick="clearREExpenseForm()">ğŸ”„ Clear</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>ğŸ’¸ Property Expenses</span><button class="btn btn-print btn-sm no-print" onclick="exportPDF('reExpenses')">ğŸ“¥ Export PDF</button></div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Date</th><th>Property</th><th>Category</th><th>Description</th><th>Amount</th><th class="no-print">Actions</th></tr></thead>
                                <tbody id="reExpensesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE INHERITANCE TAB ========== -->
            <div id="reInheritanceTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card gold"><div class="stat-icon">ğŸ’°</div><div class="stat-value" id="reInhPool">0</div><div class="stat-label">Inheritance Pool</div></div>
                    <div class="stat-card green"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value" id="reInhHeirs">0</div><div class="stat-label">Total Heirs</div></div>
                    <div class="stat-card blue"><div class="stat-icon">ğŸ“Š</div><div class="stat-value" id="reInhPortions">0</div><div class="stat-label">Total Portions</div></div>
                    <div class="stat-card red"><div class="stat-icon">ğŸ’µ</div><div class="stat-value" id="reInhPerPortion">0</div><div class="stat-label">Per Portion</div></div>
                </div>
                <div class="card">
                    <div class="card-header gold">
                        <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Real Estate Inheritance Distribution</span>
                        <div class="no-print">
                            <button class="btn btn-success btn-sm" onclick="openREHeirModal()">â• Add Heir</button>
                            <button class="btn btn-print btn-sm" onclick="exportPDF('reHeirs')">ğŸ“¥ Export PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                            ğŸ“Œ Inheritance pool is calculated from: <strong>Total Income - Total Expenses</strong> from properties marked for Islamic Inheritance.
                        </p>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Name</th><th>Relationship</th><th>Group</th><th>Portions</th><th>Share Amount</th><th class="no-print">Actions</th></tr></thead>
                                <tbody id="reHeirsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE LEDGER TAB ========== -->
            <div id="reLedgerTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <span>ğŸ“’ Real Estate Ledger (Auto-Generated)</span>
                        <div class="no-print">
                            <button class="btn btn-print btn-sm" onclick="exportPDF('reLedger')">ğŸ“¥ Export PDF</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('reLedger')">ğŸ“¥ Export CSV</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                            ğŸ“Œ <strong>Income</strong> = Payments from bills (Paid/Partial) | <strong>Expenses</strong> = All property expenses
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Property</th>
                                        <th>Description</th>
                                        <th>Type</th>
                                        <th style="background: #c6f6d5;">Income</th>
                                        <th style="background: #fed7d7;">Expense</th>
                                        <th>Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="reLedgerTable"></tbody>
                                <tfoot id="reLedgerTotals"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE EXPORT TAB ========== -->
            <div id="reExportTab" class="tab-content">
                <div class="card">
                    <div class="card-header"><span>ğŸ“¥ Export Real Estate Data</span></div>
                    <div class="card-body">
                        <p style="margin-bottom: 15px; color: #718096;">Export all Real Estate data with headers.</p>
                        <div class="btn-group" style="flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="exportAllRECSV()">ğŸ“„ All CSV</button>
                            <button class="btn btn-print" onclick="exportAllREPDF()">ğŸ“‘ All PDF</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>ğŸ“Š Individual Exports</span></div>
                    <div class="card-body">
                        <div class="btn-group" style="flex-wrap: wrap; margin-bottom: 10px;">
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('reProperties')">Properties CSV</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('reBills')">Bills CSV</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('rePayments')">Payments CSV</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('reExpenses')">Expenses CSV</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('reLedger')">Ledger CSV</button>
                        </div>
                        <div class="btn-group" style="flex-wrap: wrap;">
                            <button class="btn btn-print btn-sm" onclick="exportPDF('properties')">Properties PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportPDF('reBills')">Bills PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportPDF('rePayments')">Payments PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportPDF('reExpenses')">Expenses PDF</button>
                            <button class="btn btn-primary btn-sm" onclick="exportPDF('reLedger')">Ledger PDF</button>
                            <button class="btn btn-gold btn-sm" onclick="exportPDF('reHeirs')">Heirs PDF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE SETTINGS TAB ========== -->
            <div id="reSettingsTab" class="tab-content">
                <div class="card">
                    <div class="card-header gold"><span>âš™ï¸ Real Estate Settings</span></div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Default Tax Rate (%)</label>
                                <select id="reSettingTaxRate">
                                    <option value="0">0%</option>
                                    <option value="5">5%</option>
                                    <option value="10">10%</option>
                                    <option value="15" selected>15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Default Rental Period</label>
                                <select id="reSettingPeriod">
                                    <option value="Monthly">Monthly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Inheritance Pool %</label>
                                <input type="number" id="reSettingInhPercent" value="100" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="reSettingCurrency">
                                    <option value="XAF">XAF (CFA Franc)</option>
                                    <option value="USD">USD (US Dollar)</option>
                                    <option value="EUR">EUR (Euro)</option>
                                </select>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="saveRESettings()">ğŸ’¾ Save Settings</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header red"><span>âš ï¸ Data Management</span></div>
                    <div class="card-body">
                        <p style="margin-bottom: 15px; color: #e53e3e;">Warning: These actions cannot be undone!</p>
                        <div class="btn-group">
                            <button class="btn btn-danger" onclick="resetREData()">ğŸ—‘ï¸ Reset All RE Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Property Modal -->
        <div class="modal-overlay" id="propertyModal">
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header"><h3 id="propertyModalTitle">ğŸ  Add Property</h3><button class="modal-close" onclick="closePropertyModal()">Ã—</button></div>
                <div class="modal-body">
                    <input type="hidden" id="propId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Property Name *</label>
                            <input type="text" id="propName" placeholder="e.g., Commercial Building A">
                        </div>
                        <div class="form-group">
                            <label>Location *</label>
                            <input type="text" id="propLocation" placeholder="e.g., Bamenda, NW Region">
                        </div>
                        <div class="form-group">
                            <label>Type *</label>
                            <select id="propType">
                                <option value="Residential">Residential</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Land">Land</option>
                                <option value="Industrial">Industrial</option>
                                <option value="Mixed">Mixed Use</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="propStatus" onchange="toggleRentalFields()">
                                <option value="Rented">Rented</option>
                                <option value="Sold">Sold</option>
                                <option value="For sale">For Sale</option>
                                <option value="Not to be sold">Not to be Sold</option>
                                <option value="Shared">Shared</option>
                                <option value="Admin issues">Admin Issues</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Rental Fields (only for Rented status) -->
                    <div id="rentalFields" style="background: #ebf8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #2c5282; margin-bottom: 10px;">ğŸ’° Rental Configuration</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Rent Amount (XAF) *</label>
                                <input type="number" id="propRentAmount" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Rental Period *</label>
                                <select id="propRentPeriod">
                                    <option value="Monthly">Monthly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tax Rate (%) *</label>
                                <select id="propTaxRate">
                                    <option value="0">0%</option>
                                    <option value="5">5%</option>
                                    <option value="10">10%</option>
                                    <option value="15" selected>15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                </select>
                            </div>
                        </div>
                        <div style="background: #fff; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <div class="summary-row"><span>Gross Rent:</span><span id="propGrossRent">0 XAF</span></div>
                            <div class="summary-row"><span>Tax Deduction:</span><span id="propTaxAmount" style="color: #e53e3e;">0 XAF</span></div>
                            <div class="summary-row" style="font-weight: bold;"><span>Net Income:</span><span id="propNetIncome" style="color: #38a169;">0 XAF</span></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Shared per Islamic Inheritance?</label>
                        <select id="propInheritance">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                            <option value="NA">N/A</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="propNotes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveProperty()">ğŸ’¾ Save Property</button>
                        <button class="btn btn-outline" onclick="closePropertyModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RE Heir Modal -->
        <div class="modal-overlay" id="reHeirModal">
            <div class="modal">
                <div class="modal-header"><h3>ğŸ‘¤ Add/Edit Heir</h3><button class="modal-close" onclick="closeREHeirModal()">Ã—</button></div>
                <div class="modal-body">
                    <input type="hidden" id="reHeirId">
                    <div class="form-grid">
                        <div class="form-group"><label>Name *</label><input type="text" id="reHeirName" placeholder="Full name"></div>
                        <div class="form-group"><label>Relationship *</label><select id="reHeirRel"><option value="Spouse">Spouse</option><option value="Child">Child</option><option value="Parent">Parent</option><option value="Sibling">Sibling</option><option value="Other">Other</option></select></div>
                        <div class="form-group"><label>Group *</label><select id="reHeirGrp"><option value="Wives">Wives</option><option value="Sons">Sons</option><option value="Daughters">Daughters</option><option value="Parents">Parents</option><option value="Siblings">Siblings</option><option value="Others">Others</option></select></div>
                        <div class="form-group"><label>Portions *</label><input type="number" id="reHeirPor" value="1" min="0.5" step="0.5"></div>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="saveREHeir()">ğŸ’¾ Save</button><button class="btn btn-outline" onclick="closeREHeirModal()">Cancel</button></div>
                </div>
            </div>
        </div>

        <!-- SETTINGS -->
        <div id="settings" class="page">
            <div class="card">
                <div class="card-header gold"><span>ğŸ’° Rent Configuration</span></div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Monthly Rent (XAF)</label>
                            <input type="number" id="settingMonthlyRent" value="200000">
                        </div>
                        <div class="form-group">
                            <label>Tax Rate (%)</label>
                            <input type="number" id="settingTaxRate" value="15" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Months per Quarter</label>
                            <input type="number" id="settingMonths" value="3" readonly>
                        </div>
                    </div>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-bottom: 10px; color: #2c5282;">ğŸ“Š Calculated Amounts</h4>
                        <div class="summary-row"><span>Quarterly Gross:</span><span id="calcGross">600,000 XAF</span></div>
                        <div class="summary-row"><span>Tax Deduction:</span><span id="calcTax">90,000 XAF</span></div>
                        <div class="summary-row" style="font-weight: bold; color: #38a169;"><span>Net Amount Due:</span><span id="calcNet">510,000 XAF</span></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span>âš™ï¸ System Status</span></div>
                <div class="card-body">
                    <div class="alert" id="settingsAlert">Checking...</div>
                    <div class="btn-group">
                        <button class="btn btn-outline" onclick="checkDb()">ğŸ”„ Refresh</button>
                        <button class="btn btn-danger" onclick="resetAll()">ğŸ—‘ï¸ Reset All Data</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bill/Invoice Modal -->
    <div class="modal-overlay" id="billModal">
        <div class="modal">
            <div class="modal-header"><h3>ğŸ“„ Rent Invoice</h3><button class="modal-close" onclick="closeBillModal()">Ã—</button></div>
            <div class="modal-body" id="billModalBody"></div>
        </div>
    </div>

    <!-- Heir Modal -->
    <div class="modal-overlay" id="heirModal">
        <div class="modal">
            <div class="modal-header"><h3>ğŸ‘¤ Heir</h3><button class="modal-close" onclick="closeHeirModal()">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="heirId">
                <div class="form-group"><label>Name</label><input type="text" id="heirName"></div>
                <div class="form-group"><label>Relationship</label><select id="heirRel"><option value="Spouse">Spouse</option><option value="Child">Child</option></select></div>
                <div class="form-group"><label>Group</label><select id="heirGrp"><option value="Wives">Wives</option><option value="Daughters">Daughters</option><option value="Sons">Sons</option></select></div>
                <div class="form-group"><label>Portions</label><input type="number" id="heirPor" value="3" step="0.5"></div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveHeir()">ğŸ’¾ Save</button></div>
            </div>
        </div>
    </div>

    <div id="alertBox" style="position:fixed;top:60px;right:10px;z-index:3000;max-width:280px;"></div>

    <script>
        // Configuration - load from localStorage or use defaults
        var CONFIG = {
            monthlyRate: parseInt(localStorage.getItem('monthlyRate')) || 200000,
            taxRate: parseFloat(localStorage.getItem('taxRate')) || 0.15,
            months: 3,
            accountNo: '12003 14012 10868895015 89'
        };

        // Calculate amounts based on config
        function calcAmounts() {
            var gross = CONFIG.monthlyRate * CONFIG.months;
            var tax = Math.round(gross * CONFIG.taxRate);
            var net = gross - tax;
            return { gross: gross, tax: tax, net: net };
        }

        // Update displayed calculations
        function updateCalcDisplays() {
            var calc = calcAmounts();
            var taxPct = Math.round(CONFIG.taxRate * 100);
            // Settings page
            if (document.getElementById('calcGross')) {
                document.getElementById('calcGross').textContent = fmt(calc.gross) + ' XAF';
                document.getElementById('calcTax').textContent = fmt(calc.tax) + ' XAF';
                document.getElementById('calcNet').textContent = fmt(calc.net) + ' XAF';
            }
            // Bills page
            if (document.getElementById('billShowRate')) {
                document.getElementById('billShowRate').textContent = fmt(CONFIG.monthlyRate);
                document.getElementById('billShowGross').textContent = fmt(calc.gross);
                document.getElementById('billShowTax').textContent = '-' + fmt(calc.tax);
                document.getElementById('billShowNet').textContent = fmt(calc.net);
                if (document.getElementById('billShowTaxPct')) {
                    document.getElementById('billShowTaxPct').textContent = taxPct;
                }
            }
        }

        // Save settings
        function saveSettings() {
            var rate = parseInt(document.getElementById('settingMonthlyRent').value);
            var tax = parseFloat(document.getElementById('settingTaxRate').value) / 100;
            if (rate < 1000) {
                showAlert('Invalid monthly rate', 'error');
                return;
            }
            CONFIG.monthlyRate = rate;
            CONFIG.taxRate = tax;
            localStorage.setItem('monthlyRate', rate);
            localStorage.setItem('taxRate', tax);
            updateCalcDisplays();
            showAlert('Settings saved!');
        }

        // Load settings into form
        function loadSettings() {
            document.getElementById('settingMonthlyRent').value = CONFIG.monthlyRate;
            document.getElementById('settingTaxRate').value = Math.round(CONFIG.taxRate * 100);
            updateCalcDisplays();
        }

        // Add event listeners for real-time calculation in settings
        function setupSettingsListeners() {
            var rateInput = document.getElementById('settingMonthlyRent');
            var taxInput = document.getElementById('settingTaxRate');
            if (rateInput) {
                rateInput.addEventListener('input', function() {
                    var tempRate = parseInt(this.value) || 0;
                    var tempTax = parseFloat(taxInput.value) / 100 || 0.15;
                    var gross = tempRate * CONFIG.months;
                    var tax = Math.round(gross * tempTax);
                    var net = gross - tax;
                    document.getElementById('calcGross').textContent = fmt(gross) + ' XAF';
                    document.getElementById('calcTax').textContent = fmt(tax) + ' XAF';
                    document.getElementById('calcNet').textContent = fmt(net) + ' XAF';
                });
            }
            if (taxInput) {
                taxInput.addEventListener('input', function() {
                    var tempRate = parseInt(rateInput.value) || CONFIG.monthlyRate;
                    var tempTax = parseFloat(this.value) / 100 || 0.15;
                    var gross = tempRate * CONFIG.months;
                    var tax = Math.round(gross * tempTax);
                    var net = gross - tax;
                    document.getElementById('calcGross').textContent = fmt(gross) + ' XAF';
                    document.getElementById('calcTax').textContent = fmt(tax) + ' XAF';
                    document.getElementById('calcNet').textContent = fmt(net) + ' XAF';
                });
            }
        }

        var QUARTERS = {
            'Q1': { period: 'January to March', months: 'Jan-Mar', shortPeriod: 'Q1 (Jan-Mar)' },
            'Q2': { period: 'April to June', months: 'Apr-Jun', shortPeriod: 'Q2 (Apr-Jun)' },
            'Q3': { period: 'July to September', months: 'Jul-Sep', shortPeriod: 'Q3 (Jul-Sep)' },
            'Q4': { period: 'October to December', months: 'Oct-Dec', shortPeriod: 'Q4 (Oct-Dec)' }
        };

        var API = window.location.origin + '/api';

        function fmt(n) {
            return n ? Math.abs(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
        }

        function fmtDate(d) {
            return new Date(d).toLocaleDateString();
        }

        function formatDateLong(d) {
            var date = new Date(d);
            var day = date.getDate();
            var suffix = (day === 1 || day === 21 || day === 31) ? 'st' : (day === 2 || day === 22) ? 'nd' : (day === 3 || day === 23) ? 'rd' : 'th';
            var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return day + suffix + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
        }

        function today() {
            return new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function numberToWords(n) {
            var ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            var tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            if (n < 20) return ones[n];
            if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
            if (n < 1000) return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' and ' + numberToWords(n % 100) : '');
            if (n < 1000000) return numberToWords(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 ? ' ' + numberToWords(n % 1000) : '');
            return numberToWords(Math.floor(n / 1000000)) + ' Million' + (n % 1000000 ? ' ' + numberToWords(n % 1000000) : '');
        }

        function showAlert(msg, type) {
            type = type || 'success';
            var el = document.createElement('div');
            el.className = 'alert alert-' + type;
            el.innerHTML = msg;
            document.getElementById('alertBox').appendChild(el);
            setTimeout(function() { el.remove(); }, 2500);
        }

        function api(url, opts) {
            opts = opts || {};
            return fetch(API + url, {
                headers: { 'Content-Type': 'application/json' },
                method: opts.method || 'GET',
                body: opts.body
            }).then(function(res) { return res.json(); });
        }

        // Tabs
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var page = this.dataset.page;
                document.querySelectorAll('.nav-btn').forEach(function(b) { b.classList.remove('active'); });
                document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
                this.classList.add('active');
                document.getElementById(page).classList.add('active');
                loadPage(page);
            });
        });

        function loadPage(p) {
            if (p === 'dashboard') loadDashboard();
            else if (p === 'ledger') loadLedger();
            else if (p === 'expenses') loadExpenses();
            else if (p === 'bills') { loadBills(); updateCalcDisplays(); }
            else if (p === 'payments') loadPayments();
            else if (p === 'inheritance') loadInheritance();
            else if (p === 'realestate') loadRealEstate();
            else if (p === 'settings') { loadSettings(); setupSettingsListeners(); checkDb(); }
        }

        // Dashboard
        function loadDashboard() {
            // Get total income from bills (paid amounts from bills with paid or partial status)
            api('/bills').then(function(bills) {
                var totalIncome = 0;
                bills.forEach(function(b) {
                    // Include paid amount from bills that have any payment (paid or partial)
                    if (b.paidAmount > 0) {
                        totalIncome += b.paidAmount;
                    }
                });
                document.getElementById('dashIncome').textContent = fmt(totalIncome);
                document.getElementById('dashIncomeSum').textContent = fmt(totalIncome) + ' XAF';
                
                // Get expenses
                api('/expenses').then(function(expenses) {
                    var totalExpenses = 0;
                    expenses.forEach(function(e) {
                        totalExpenses += e.amount;
                    });
                    document.getElementById('dashExp').textContent = fmt(totalExpenses);
                    document.getElementById('dashExpSum').textContent = fmt(totalExpenses) + ' XAF';
                    
                    // Calculate reserve funds = Income - Expenses
                    var reserveFunds = totalIncome - totalExpenses;
                    document.getElementById('dashReserve').textContent = fmt(reserveFunds);
                    document.getElementById('dashReserveSum').textContent = fmt(reserveFunds) + ' XAF';
                    if (reserveFunds < 0) {
                        document.getElementById('dashReserveSum').className = 'amount-negative';
                    } else {
                        document.getElementById('dashReserveSum').className = 'amount-positive';
                    }
                });
            });
            
            // Get inheritance amount
            api('/inheritance/calculate').then(function(d) {
                document.getElementById('dashInh').textContent = fmt(d.inheritanceAmount);
                document.getElementById('dashInhSum').textContent = fmt(d.inheritanceAmount) + ' XAF';
            });
        }

        // Ledger - combines income (from bills paid/partial) and expenses
        function loadLedger() {
            Promise.all([api('/bills'), api('/expenses')]).then(function(results) {
                var bills = results[0];
                var expenses = results[1];
                
                // Combine into ledger entries
                var ledgerEntries = [];
                
                // Add bills with payments as income (paid or partial status)
                bills.forEach(function(b) {
                    if (b.paidAmount > 0) {
                        var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                        ledgerEntries.push({
                            date: b.createdAt || new Date().toISOString(),
                            description: 'Bill ' + b.billNumber + ' - ' + b.period + ' ' + b.year + ' (' + status + ')',
                            type: 'Income',
                            income: b.paidAmount,
                            expense: 0,
                            status: status
                        });
                    }
                });
                
                // Add expenses
                expenses.forEach(function(e) {
                    ledgerEntries.push({
                        date: e.date,
                        description: e.description,
                        type: e.categoryName,
                        income: 0,
                        expense: e.amount,
                        category: e.categoryName
                    });
                });
                
                // Sort by date
                ledgerEntries.sort(function(a, b) {
                    return new Date(a.date) - new Date(b.date);
                });
                
                // Calculate running balance and totals
                var runningBalance = 0;
                var totalIncome = 0;
                var totalExpense = 0;
                
                var tableHtml = '';
                ledgerEntries.forEach(function(entry) {
                    if (entry.income > 0) {
                        runningBalance += entry.income;
                        totalIncome += entry.income;
                    }
                    if (entry.expense > 0) {
                        runningBalance -= entry.expense;
                        totalExpense += entry.expense;
                    }
                    
                    var isInheritance = entry.type === 'Inheritance Share';
                    var isIncome = entry.income > 0;
                    tableHtml += '<tr>' +
                        '<td>' + fmtDate(entry.date) + '</td>' +
                        '<td>' + entry.description + '</td>' +
                        '<td><span class="badge ' + (isIncome ? 'badge-income' : isInheritance ? 'badge-inheritance' : 'badge-expense') + '">' + entry.type + (entry.status ? ' (' + entry.status + ')' : '') + '</span></td>' +
                        '<td class="amount-positive">' + (entry.income > 0 ? fmt(entry.income) : '-') + '</td>' +
                        '<td class="' + (isInheritance ? 'amount-gold' : 'amount-negative') + '">' + (entry.expense > 0 ? fmt(entry.expense) : '-') + '</td>' +
                        '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(runningBalance) + '</td>' +
                        '</tr>';
                });
                
                document.getElementById('ledgerTable').innerHTML = tableHtml || '<tr><td colspan="6">No transactions</td></tr>';
                
                // Totals footer
                document.getElementById('ledgerTotals').innerHTML = 
                    '<tr style="background: #f7fafc; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right;">TOTALS:</td>' +
                    '<td class="amount-positive">' + fmt(totalIncome) + '</td>' +
                    '<td class="amount-negative">' + fmt(totalExpense) + '</td>' +
                    '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(runningBalance) + '</td>' +
                    '</tr>';
                
                // Update stats
                document.getElementById('ledgerIncome').textContent = fmt(totalIncome);
                document.getElementById('ledgerExpense').textContent = fmt(totalExpense);
                document.getElementById('ledgerBalance').textContent = fmt(runningBalance);
            });
        }

        // Expenses
        function loadExpenses() {
            api('/categories').then(function(cats) {
                document.getElementById('expCat').innerHTML = cats.map(function(c) {
                    return '<option value="' + c.id + '">' + c.name + '</option>';
                }).join('');
            });
            if (!document.getElementById('expDate').value) {
                document.getElementById('expDate').valueAsDate = new Date();
            }
            api('/expenses').then(function(expenses) {
                document.getElementById('expTable').innerHTML = expenses.map(function(e) {
                    var isInh = e.categoryName === 'Inheritance Share';
                    return '<tr><td>' + fmtDate(e.date) + '</td><td>' + e.description + '</td><td>' + e.categoryName + '</td><td class="' + (isInh ? 'amount-gold' : 'amount-negative') + '">-' + fmt(e.amount) + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editExpense(' + e.id + ')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteExpense(' + e.id + ')">ğŸ—‘ï¸</button></td></tr>';
                }).join('') || '<tr><td colspan="5">No expenses</td></tr>';
            });
        }

        function editExpense(id) {
            api('/expenses').then(function(expenses) {
                var e = expenses.find(function(x) { return x.id === id; });
                if (e) {
                    document.getElementById('expId').value = id;
                    document.getElementById('expDate').value = e.date.split('T')[0];
                    document.getElementById('expDesc').value = e.description;
                    document.getElementById('expCat').value = e.categoryId;
                    document.getElementById('expAmt').value = e.amount;
                }
            });
        }

        function saveExpense() {
            var id = document.getElementById('expId').value;
            var data = {
                date: document.getElementById('expDate').value,
                description: document.getElementById('expDesc').value,
                categoryId: document.getElementById('expCat').value,
                amount: parseInt(document.getElementById('expAmt').value)
            };
            if (!data.date || !data.description || !data.amount) {
                showAlert('Fill all fields', 'error');
                return;
            }
            var url = id ? '/expenses/' + id : '/expenses';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                showAlert(id ? 'Updated!' : 'Saved!');
                clearExpenseForm();
                loadExpenses();
                loadDashboard();
            });
        }

        function deleteExpense(id) {
            if (!confirm('Delete?')) return;
            api('/expenses/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadExpenses();
            });
        }

        function clearExpenseForm() {
            document.getElementById('expId').value = '';
            document.getElementById('expDesc').value = '';
            document.getElementById('expAmt').value = '';
        }

        // Bills
        function loadBills() {
            var yearSel = document.getElementById('billY');
            if (yearSel.options.length === 0) {
                for (var y = 2022; y <= 2035; y++) {
                    yearSel.innerHTML += '<option value="' + y + '">' + y + '</option>';
                }
                yearSel.value = new Date().getFullYear();
            }
            updateBillNumber();
            api('/bills').then(function(bills) {
                document.getElementById('billTable').innerHTML = bills.map(function(b) {
                    return '<tr class="clickable" onclick="viewBill(\'' + b.billNumber + '\')"><td><strong>' + b.billNumber + '</strong>' + (b.isNew ? ' <span class="badge badge-new">NEW</span>' : '') + '</td><td>' + b.period + ' ' + b.year + '</td><td>' + fmt(b.amountDue) + '</td><td class="amount-positive">' + fmt(b.paidAmount) + '</td><td class="' + (b.outstanding > 0 ? 'amount-negative' : '') + '">' + fmt(b.outstanding) + '</td><td><span class="badge badge-' + (b.outstanding === 0 ? 'paid' : b.paidAmount > 0 ? 'partial' : 'unpaid') + '">' + (b.outstanding === 0 ? 'Paid' : b.paidAmount > 0 ? 'Partial' : 'Unpaid') + '</span></td><td class="no-print" onclick="event.stopPropagation()"><button class="btn btn-warning btn-sm" onclick="editBill(\'' + b.billNumber + '\')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteBill(\'' + b.billNumber + '\')">ğŸ—‘ï¸</button></td></tr>';
                }).join('');
            });
        }

        function updateBillNumber() {
            var q = document.getElementById('billQ').value;
            var y = document.getElementById('billY').value;
            var n = q === 'Q1' ? 1 : q === 'Q2' ? 2 : q === 'Q3' ? 3 : 4;
            document.getElementById('billNum').value = q + '-' + y + '-00' + n;
        }

        document.getElementById('billQ').addEventListener('change', updateBillNumber);
        document.getElementById('billY').addEventListener('change', updateBillNumber);

        function editBill(bn) {
            api('/bills').then(function(bills) {
                var b = bills.find(function(x) { return x.billNumber === bn; });
                if (b) {
                    document.getElementById('billEditMode').value = 'edit';
                    document.getElementById('billOldNumber').value = bn;
                    document.getElementById('billQ').value = b.quarter;
                    document.getElementById('billY').value = b.year;
                    document.getElementById('billP').value = b.period;
                    updateBillNumber();
                    updateCalcDisplays();
                }
            });
        }

        function saveBill() {
            var em = document.getElementById('billEditMode').value;
            var old = document.getElementById('billOldNumber').value;
            var q = document.getElementById('billQ').value;
            var y = parseInt(document.getElementById('billY').value);
            var p = document.getElementById('billP').value;
            var calc = calcAmounts();
            var amountDue = calc.net; // Use calculated net amount from CONFIG
            var bn = document.getElementById('billNum').value;

            if (em === 'edit') {
                api('/bills/' + old, { method: 'PUT', body: JSON.stringify({ quarter: q, year: y, period: p, amountDue: amountDue }) }).then(function() {
                    showAlert('Updated!');
                    clearBillForm();
                    loadBills();
                    loadDashboard();
                });
            } else {
                api('/bills', { method: 'POST', body: JSON.stringify({ billNumber: bn, quarter: q, year: y, period: p, amountDue: amountDue, paidAmount: 0, outstanding: amountDue, isNew: true }) }).then(function() {
                    showAlert('Created!');
                    clearBillForm();
                    loadBills();
                    loadDashboard();
                });
            }
        }

        function deleteBill(bn) {
            if (!confirm('Delete ' + bn + '?')) return;
            api('/bills/' + bn, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadBills();
                loadDashboard();
            });
        }

        function clearBillForm() {
            document.getElementById('billEditMode').value = '';
            document.getElementById('billOldNumber').value = '';
            document.getElementById('billY').value = new Date().getFullYear();
            updateBillNumber();
            updateCalcDisplays();
        }

        // View Bill as Invoice
        function viewBill(bn) {
            api('/bills/' + bn).then(function(b) {
                var rate = CONFIG.monthlyRate; // Monthly rate from settings
                var grossAmount = rate * CONFIG.months; // Quarterly gross
                var taxPercent = Math.round(CONFIG.taxRate * 100); // Tax percentage for display
                var taxAmount = Math.round(grossAmount * CONFIG.taxRate); // Tax amount
                var netAmount = grossAmount - taxAmount; // Net amount due per quarter
                var advancePayment = b.paidAmount;
                var totalDue = netAmount - advancePayment; // Outstanding after payments
                var qInfo = QUARTERS[b.quarter] || { months: b.period };
                var paymentNum = b.quarter === 'Q1' ? 1 : b.quarter === 'Q2' ? 2 : b.quarter === 'Q3' ? 3 : 4;
                var billDate = b.createdAt ? formatDateLong(b.createdAt) : formatDateLong(new Date());

                var invoiceHtml = '<div id="invoicePrint" style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto;">' +
                    '<div style="text-align: center; background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0;">' +
                        '<h1 style="margin: 0; font-size: 24px;">GHOUENZEN Soulemanou</h1>' +
                        '<p style="margin: 5px 0 0; font-size: 14px;">B.P 36 Mankon-Bamenda</p>' +
                        '<p style="margin: 3px 0 0; font-size: 14px;">Tel: 675299868</p>' +
                        '<p style="margin: 3px 0 0; font-size: 12px;">Account No. ' + CONFIG.accountNo + '</p>' +
                    '</div>' +
                    '<div style="border: 1px solid #ddd; border-top: none; padding: 20px;">' +
                        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                            '<tr style="background: #2c5282; color: white;"><td colspan="4" style="padding: 8px; text-align: center; font-weight: bold;">BILLING PERIOD SELECTION</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 25%;">Billing Period:</td><td colspan="3" style="padding: 8px; border: 1px solid #ddd;">' + b.period + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Year:</td><td style="padding: 8px; border: 1px solid #ddd;">' + b.year + '</td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Quarter:</td><td style="padding: 8px; border: 1px solid #ddd; background: #2c5282; color: white; text-align: center;">' + b.quarter + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Payment Number:</td><td style="padding: 8px; border: 1px solid #ddd;">' + paymentNum + '</td><td colspan="2"></td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Bill Date:</td><td colspan="3" style="padding: 8px; border: 1px solid #ddd;">' + billDate + '</td></tr>' +
                        '</table>' +
                        '<div style="background: #38a169; color: white; text-align: center; padding: 8px; font-weight: bold;">GENERATED BILL NUMBER</div>' +
                        '<div style="background: #c6f6d5; text-align: center; padding: 15px; font-size: 22px; font-weight: bold; color: #276749; border: 2px solid #38a169;">BILL NO.' + b.billNumber + '</div>' +
                        '<div style="margin: 20px 0; font-style: italic;">' +
                            '<p><strong>The General Manager,</strong></p>' +
                            '<p>Cameroon Postal Services</p>' +
                            '<p>B.P 1441 YaoundÃ©.</p>' +
                        '</div>' +
                        '<p style="margin: 20px 0;"><strong>Sir,</strong></p>' +
                        '<p style="margin-bottom: 20px;">In accordance with the contract de bail No.00000/9/MTP/G10 of 18th April 1991, I hereby present the rent bill for period of:</p>' +
                        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                            '<tr style="background: #2c5282; color: white;"><td colspan="2" style="padding: 10px; text-align: center; font-weight: bold;">BILL DETAILS</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 35%;">Bill Date</td><td style="padding: 8px; border: 1px solid #ddd;">' + billDate + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Tenant Name</td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">CAMPOST MANKON</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Property Address</td><td style="padding: 8px; border: 1px solid #ddd;">B.P 36 Mankon-Bamenda</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Bill Number</td><td style="padding: 8px; border: 1px solid #ddd; background: #ebf8ff; color: #2c5282; font-weight: bold;">' + b.billNumber + '</td></tr>' +
                        '</table>' +
                        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                            '<tr style="background: #d69e2e; color: white;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Description</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Qty (months)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Rate (XAF)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Amount (XAF)</th></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd;">Rent for ' + b.quarter + ' (' + qInfo.months + ')</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">' + CONFIG.months + '</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + fmt(rate) + '</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + fmt(grossAmount) + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd;">Less ' + taxPercent + '% Tax</td><td style="padding: 8px; border: 1px solid #ddd;"></td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + taxPercent + '%</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #e53e3e;">-' + fmt(taxAmount) + '</td></tr>' +
                            '<tr style="background: #f7fafc;"><td colspan="3" style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Net Amount (After Tax)</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">' + fmt(netAmount) + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd;">Less Advance Payment</td><td colspan="2" style="padding: 8px; border: 1px solid #ddd;"></td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #38a169;">-' + fmt(advancePayment) + '</td></tr>' +
                            '<tr style="background: #2c5282; color: white;"><td colspan="3" style="padding: 10px; font-weight: bold; text-align: center;">TOTAL AMOUNT DUE</td><td style="padding: 10px; text-align: right; font-weight: bold; font-size: 18px;">' + fmt(totalDue) + '</td></tr>' +
                        '</table>' +
                        '<p style="text-align: center; color: #e53e3e; font-style: italic; font-weight: bold;">(' + numberToWords(netAmount) + ' francs CFA.)</p>' +
                        '<div style="margin-top: 40px;">' +
                            '<p><strong>Signature:</strong></p>' +
                            '<div style="margin-top: 10px; border-bottom: 1px solid #333; width: 200px; height: 50px;"></div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="btn-group no-print" style="margin-top: 15px;">' +
                    '<button class="btn btn-primary" onclick="printInvoice()">ğŸ–¨ï¸ Print Invoice</button>' +
                    '<button class="btn btn-outline" onclick="closeBillModal()">Close</button>' +
                '</div>';

                document.getElementById('billModalBody').innerHTML = invoiceHtml;
                document.getElementById('billModal').classList.add('active');
            });
        }

        function closeBillModal() {
            document.getElementById('billModal').classList.remove('active');
        }

        function printInvoice() {
            var content = document.getElementById('invoicePrint').innerHTML;
            var w = window.open('', '_blank');
            w.document.write('<html><head><title>Rent Invoice</title><style>body{font-family:Arial,sans-serif;padding:20px;margin:0;}table{width:100%;border-collapse:collapse;}td,th{padding:8px;border:1px solid #ddd;}@media print{body{padding:10px;}}</style></head><body>' + content + '</body></html>');
            w.document.close();
            w.print();
        }

        // Payments
        function loadPayments() {
            api('/bills').then(function(bills) {
                document.getElementById('payBill').innerHTML = '<option value="">-- Select --</option>' + bills.map(function(b) {
                    return '<option value="' + b.billNumber + '">' + b.billNumber + ' - ' + b.period + ' ' + b.year + ' (' + fmt(b.outstanding) + ' due)</option>';
                }).join('');
            });
            if (!document.getElementById('payDate').value) {
                document.getElementById('payDate').valueAsDate = new Date();
            }
            api('/payments').then(function(payments) {
                document.getElementById('payTable').innerHTML = payments.map(function(p) {
                    return '<tr><td>' + fmtDate(p.date) + '</td><td>' + p.billNumber + '</td><td>' + p.period + ' ' + p.year + '</td><td class="amount-positive">+' + fmt(p.amount) + '</td><td>' + (p.reference || '-') + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editPayment(' + p.id + ')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deletePayment(' + p.id + ')">ğŸ—‘ï¸</button></td></tr>';
                }).join('') || '<tr><td colspan="6">No payments</td></tr>';
            });
        }

        document.getElementById('payBill').addEventListener('change', function() {
            var bn = this.value;
            if (bn) {
                api('/bills').then(function(bills) {
                    var b = bills.find(function(x) { return x.billNumber === bn; });
                    if (b) document.getElementById('payOut').value = fmt(b.outstanding) + ' XAF';
                });
            }
        });

        function editPayment(id) {
            api('/payments/' + id).then(function(p) {
                document.getElementById('payId').value = id;
                document.getElementById('payBill').value = p.billNumber;
                document.getElementById('payAmt').value = p.amount;
                document.getElementById('payDate').value = p.date.split('T')[0];
                document.getElementById('payRef').value = p.reference || '';
            });
        }

        function savePayment() {
            var id = document.getElementById('payId').value;
            var data = {
                billNumber: document.getElementById('payBill').value,
                amount: parseInt(document.getElementById('payAmt').value),
                date: document.getElementById('payDate').value,
                reference: document.getElementById('payRef').value
            };
            if (!data.billNumber || !data.amount) {
                showAlert('Fill required fields', 'error');
                return;
            }
            var url = id ? '/payments/' + id : '/payments';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                showAlert(id ? 'Updated!' : 'Saved!');
                clearPaymentForm();
                loadPayments();
                loadBills();
                loadDashboard();
            });
        }

        function deletePayment(id) {
            if (!confirm('Delete?')) return;
            api('/payments/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadPayments();
                loadBills();
                loadDashboard();
            });
        }

        function clearPaymentForm() {
            document.getElementById('payId').value = '';
            document.getElementById('payBill').value = '';
            document.getElementById('payOut').value = '';
            document.getElementById('payAmt').value = '';
            document.getElementById('payRef').value = '';
        }

        // Inheritance
        function loadInheritance() {
            api('/inheritance/calculate').then(function(d) {
                document.getElementById('inhAmt').textContent = fmt(d.inheritanceAmount) + ' XAF';
                document.getElementById('inhPaid').textContent = fmt(d.totalBillsPaid);
                document.getElementById('inhExp').textContent = fmt(d.totalExpenses);
                document.getElementById('inhRes').textContent = fmt(d.reserveFunds);
                document.getElementById('inhPortions').textContent = d.totalPortions;
                document.getElementById('inhPer').textContent = fmt(d.sharePerPortion);

                var html = '';
                for (var g in d.groupSummary) {
                    var i = d.groupSummary[g];
                    html += '<div class="heir-group"><h4>' + g + ' <span>' + i.count + '</span></h4><div class="summary-row"><span>Per heir:</span><span>' + fmt(Math.round(i.totalShare / i.count)) + ' XAF</span></div><div class="summary-row"><span>Total:</span><span>' + fmt(Math.round(i.totalShare)) + ' XAF</span></div></div>';
                }
                document.getElementById('heirGroups').innerHTML = html || '<p>No heirs</p>';

                document.getElementById('heirTable').innerHTML = d.heirs.map(function(h) {
                    return '<tr><td>' + h.name + '</td><td>' + h.relationship + '</td><td>' + h.heir_group + '</td><td>' + h.portions + '</td><td class="amount-positive">' + fmt(Math.round(h.shareAmount)) + '</td><td class="no-print"><button class="btn btn-gold btn-sm" onclick="printHeirCertificate(' + h.id + ')">ğŸ“œ</button> <button class="btn btn-warning btn-sm" onclick="editHeir(' + h.id + ')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteHeir(' + h.id + ')">ğŸ—‘ï¸</button></td></tr>';
                }).join('') || '<tr><td colspan="6">No heirs</td></tr>';
            });
        }

        function openHeirModal() { document.getElementById('heirModal').classList.add('active'); }
        function closeHeirModal() {
            document.getElementById('heirModal').classList.remove('active');
            document.getElementById('heirId').value = '';
            document.getElementById('heirName').value = '';
        }

        function editHeir(id) {
            api('/heirs').then(function(heirs) {
                var h = heirs.find(function(x) { return x.id === id; });
                if (h) {
                    document.getElementById('heirId').value = id;
                    document.getElementById('heirName').value = h.name;
                    document.getElementById('heirRel').value = h.relationship;
                    document.getElementById('heirGrp').value = h.heir_group;
                    document.getElementById('heirPor').value = h.portions;
                    openHeirModal();
                }
            });
        }

        function saveHeir() {
            var id = document.getElementById('heirId').value;
            var data = {
                name: document.getElementById('heirName').value,
                relationship: document.getElementById('heirRel').value,
                heirGroup: document.getElementById('heirGrp').value,
                portions: parseFloat(document.getElementById('heirPor').value)
            };
            if (!data.name) { showAlert('Enter name', 'error'); return; }
            var url = id ? '/heirs/' + id : '/heirs';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                showAlert(id ? 'Updated!' : 'Added!');
                closeHeirModal();
                loadInheritance();
            });
        }

        function deleteHeir(id) {
            if (!confirm('Delete?')) return;
            api('/heirs/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadInheritance();
            });
        }

        // Heir Certificates
        function printHeirCertificate(heirId) {
            api('/inheritance/calculate').then(function(d) {
                var h = d.heirs.find(function(x) { return x.id === heirId; });
                if (!h) { showAlert('Heir not found', 'error'); return; }
                var certHtml = generateCertificateHTML(h, d);
                var w = window.open('', '_blank');
                w.document.write(certHtml);
                w.document.close();
                w.print();
            });
        }

        function printAllHeirCertificates() {
            api('/inheritance/calculate').then(function(d) {
                if (d.heirs.length === 0) { showAlert('No heirs', 'error'); return; }
                var allCerts = '<html><head><title>Certificates</title><style>@page{size:A5;margin:10mm;}body{font-family:Georgia,serif;margin:0;padding:0;}.certificate{page-break-after:always;padding:15mm;border:3px double #1a365d;margin:5mm;}.certificate:last-child{page-break-after:auto;}.cert-header{text-align:center;border-bottom:2px solid #d69e2e;padding-bottom:10px;margin-bottom:15px;}.cert-header h1{color:#1a365d;font-size:20px;margin:0;}.heir-name{text-align:center;font-size:24px;color:#1a365d;font-weight:bold;margin:20px 0;padding:10px;background:linear-gradient(135deg,rgba(214,158,46,0.1),rgba(237,137,54,0.1));border-radius:8px;}.cert-details{margin:15px 0;}.detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dotted #ccc;}.share-amount{text-align:center;margin:20px 0;padding:15px;background:#1a365d;color:white;border-radius:8px;}.share-amount strong{font-size:28px;color:#d69e2e;}.signature-line{margin-top:30px;display:flex;justify-content:space-between;}.sig-block{text-align:center;width:40%;}.sig-line{border-top:1px solid #333;margin-top:40px;padding-top:5px;}</style></head><body>';
                d.heirs.forEach(function(h) { allCerts += generateCertificateBody(h, d); });
                allCerts += '</body></html>';
                var w = window.open('', '_blank');
                w.document.write(allCerts);
                w.document.close();
                w.print();
            });
        }

        function generateCertificateHTML(h, d) {
            return '<html><head><title>Certificate - ' + h.name + '</title><style>body{font-family:Georgia,serif;margin:0;padding:20mm;}.certificate{padding:20mm;border:3px double #1a365d;}.cert-header{text-align:center;border-bottom:2px solid #d69e2e;padding-bottom:15px;margin-bottom:20px;}.cert-header h1{color:#1a365d;font-size:24px;margin:0;}.heir-name{text-align:center;font-size:28px;color:#1a365d;font-weight:bold;margin:25px 0;padding:15px;background:linear-gradient(135deg,rgba(214,158,46,0.1),rgba(237,137,54,0.1));border-radius:10px;}.cert-details{margin:20px 0;}.detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dotted #ccc;}.share-amount{text-align:center;margin:25px 0;padding:20px;background:#1a365d;color:white;border-radius:10px;}.share-amount strong{font-size:32px;color:#d69e2e;}.signature-line{margin-top:40px;display:flex;justify-content:space-between;}.sig-block{text-align:center;width:40%;}.sig-line{border-top:1px solid #333;margin-top:50px;padding-top:5px;}</style></head><body>' + generateCertificateBody(h, d) + '</body></html>';
        }

        function generateCertificateBody(h, d) {
            return '<div class="certificate"><div class="cert-header"><h1>CAMPOST MANKON</h1><p style="color:#666;font-size:12px;">GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868</p></div><div style="text-align:center;margin:15px 0;"><h2 style="color:#d69e2e;font-size:18px;">ğŸ“œ INHERITANCE SHARE CERTIFICATE</h2></div><p style="text-align:center;color:#666;font-size:12px;">This certifies that the following heir is entitled to receive their share:</p><div class="heir-name">' + h.name + '</div><div class="cert-details"><div class="detail-row"><span>Relationship:</span><span style="font-weight:bold;">' + h.relationship + '</span></div><div class="detail-row"><span>Heir Group:</span><span style="font-weight:bold;">' + h.heir_group + '</span></div><div class="detail-row"><span>Portions:</span><span style="font-weight:bold;">' + h.portions + ' of ' + d.totalPortions + '</span></div><div class="detail-row"><span>Total Distribution:</span><span style="font-weight:bold;">' + fmt(d.inheritanceAmount) + ' XAF</span></div><div class="detail-row"><span>Per Portion:</span><span style="font-weight:bold;">' + fmt(d.sharePerPortion) + ' XAF</span></div></div><div class="share-amount"><p style="margin:0 0 5px;opacity:0.8;">ENTITLED SHARE AMOUNT</p><strong>' + fmt(Math.round(h.shareAmount)) + ' XAF</strong></div><div class="signature-line"><div class="sig-block"><div class="sig-line">Authorized Signature</div></div><div class="sig-block"><div class="sig-line">Heir Signature</div></div></div><p style="text-align:center;margin-top:20px;font-size:10px;color:#666;">Generated on ' + today() + '</p></div>';
        }

        // Export functions
        function exportCSV(type) {
            var h = 'CAMPOST MANKON - GHOUENZEN Soulemanou\nB.P 36 Mankon-Bamenda | Tel: 675299868\n\n';
            if (type === 'bills') {
                api('/bills').then(function(d) {
                    var csv = h + 'Bill Number,Quarter,Period,Year,Due,Paid,Outstanding,Status\n';
                    d.forEach(function(b) { csv += b.billNumber + ',' + b.quarter + ',' + b.period + ',' + b.year + ',' + b.amountDue + ',' + b.paidAmount + ',' + b.outstanding + ',' + (b.outstanding === 0 ? 'Paid' : 'Outstanding') + '\n'; });
                    download(csv, 'campost_bills.csv');
                });
            } else if (type === 'payments') {
                api('/payments').then(function(d) {
                    var csv = h + 'Date,Bill,Period,Year,Amount,Reference\n';
                    d.forEach(function(p) { csv += p.date + ',' + p.billNumber + ',' + p.period + ',' + p.year + ',' + p.amount + ',"' + (p.reference || '') + '"\n'; });
                    download(csv, 'campost_payments.csv');
                });
            } else if (type === 'expenses') {
                api('/expenses').then(function(d) {
                    var csv = h + 'Date,Description,Category,Amount\n';
                    d.forEach(function(e) { csv += e.date + ',"' + e.description + '",' + e.categoryName + ',' + e.amount + '\n'; });
                    download(csv, 'campost_expenses.csv');
                });
            } else if (type === 'ledger') {
                Promise.all([api('/bills'), api('/expenses')]).then(function(results) {
                    var bills = results[0];
                    var expenses = results[1];
                    var csv = h + 'Date,Description,Type,Status,Income,Expense,Balance\n';
                    
                    var ledgerEntries = [];
                    // Add bills with payments (paid or partial)
                    bills.forEach(function(b) {
                        if (b.paidAmount > 0) {
                            var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                            ledgerEntries.push({ 
                                date: b.createdAt || new Date().toISOString(), 
                                description: 'Bill ' + b.billNumber + ' - ' + b.period + ' ' + b.year, 
                                type: 'Income', 
                                status: status,
                                income: b.paidAmount, 
                                expense: 0 
                            });
                        }
                    });
                    expenses.forEach(function(e) {
                        ledgerEntries.push({ date: e.date, description: e.description, type: e.categoryName, status: '', income: 0, expense: e.amount });
                    });
                    ledgerEntries.sort(function(a, b) { return new Date(a.date) - new Date(b.date); });
                    
                    var balance = 0;
                    ledgerEntries.forEach(function(entry) {
                        balance += entry.income - entry.expense;
                        csv += (entry.date ? entry.date.split('T')[0] : '') + ',"' + entry.description + '",' + entry.type + ',' + entry.status + ',' + entry.income + ',' + entry.expense + ',' + balance + '\n';
                    });
                    download(csv, 'campost_ledger.csv');
                });
            }
        }

        function exportAllCSV() {
            api('/export/all').then(function(all) {
                var csv = 'CAMPOST MANKON - GHOUENZEN Soulemanou\nB.P 36 Mankon-Bamenda | Tel: 675299868\n';
                csv += '\nSUMMARY\nTotal Bills Paid: ' + all.summary.totalBillsPaid + '\nTotal Expenses: ' + all.summary.totalExpenses + '\nReserve Funds: ' + all.summary.reserveFunds + '\n';
                csv += '\n\nBILLS\nBill Number,Period,Year,Amount Due,Paid,Outstanding\n';
                all.bills.forEach(function(b) { csv += b.bill_number + ',' + b.period + ',' + b.year + ',' + b.amount_due + ',' + b.paid_amount + ',' + b.outstanding + '\n'; });
                csv += '\n\nPAYMENTS\nDate,Bill,Amount,Reference\n';
                all.payments.forEach(function(p) { csv += p.payment_date + ',' + p.bill_number + ',' + p.amount + ',"' + (p.reference || '') + '"\n'; });
                csv += '\n\nEXPENSES\nDate,Description,Category,Amount\n';
                all.expenses.forEach(function(e) { csv += e.expense_date + ',"' + e.description + '",' + e.category_name + ',' + e.amount + '\n'; });
                csv += '\n\nHEIRS\nName,Relationship,Group,Portions\n';
                all.heirs.forEach(function(h) { csv += h.name + ',' + h.relationship + ',' + h.heir_group + ',' + h.portions + '\n'; });
                download(csv, 'campost_all_data.csv');
            });
        }

        function exportPDF(type) {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('CAMPOST MANKON', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868', 105, 22, { align: 'center' });
            doc.line(20, 25, 190, 25);

            if (type === 'bills') {
                api('/bills').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('BILLS REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Bill #', 'Period', 'Year', 'Due', 'Paid', 'Outstanding']], body: d.map(function(b) { return [b.billNumber, b.period, b.year, fmt(b.amountDue), fmt(b.paidAmount), fmt(b.outstanding)]; }), styles: { fontSize: 8 } });
                    doc.save('campost_bills.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'payments') {
                api('/payments').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PAYMENTS REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Date', 'Bill #', 'Period', 'Amount', 'Reference']], body: d.map(function(p) { return [fmtDate(p.date), p.billNumber, p.period + ' ' + p.year, fmt(p.amount), p.reference || '-']; }), styles: { fontSize: 8 } });
                    doc.save('campost_payments.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'expenses') {
                api('/expenses').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('EXPENSES REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Date', 'Description', 'Category', 'Amount']], body: d.map(function(e) { return [fmtDate(e.date), e.description.substring(0, 35), e.categoryName, fmt(e.amount)]; }), styles: { fontSize: 8 } });
                    doc.save('campost_expenses.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'ledger') {
                Promise.all([api('/bills'), api('/expenses')]).then(function(results) {
                    var bills = results[0];
                    var expenses = results[1];
                    
                    // Build ledger entries from bills with payments
                    var ledgerEntries = [];
                    bills.forEach(function(b) {
                        if (b.paidAmount > 0) {
                            var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                            ledgerEntries.push({
                                date: b.createdAt || new Date().toISOString(),
                                description: b.billNumber + ' - ' + b.period + ' ' + b.year,
                                type: 'Income (' + status + ')',
                                income: b.paidAmount,
                                expense: 0
                            });
                        }
                    });
                    expenses.forEach(function(e) {
                        ledgerEntries.push({
                            date: e.date,
                            description: e.description.substring(0, 30),
                            type: e.categoryName,
                            income: 0,
                            expense: e.amount
                        });
                    });
                    
                    // Sort by date
                    ledgerEntries.sort(function(a, b) {
                        return new Date(a.date) - new Date(b.date);
                    });
                    
                    // Calculate running balance
                    var runningBalance = 0;
                    var totalIncome = 0;
                    var totalExpense = 0;
                    var tableData = ledgerEntries.map(function(entry) {
                        if (entry.income > 0) {
                            runningBalance += entry.income;
                            totalIncome += entry.income;
                        }
                        if (entry.expense > 0) {
                            runningBalance -= entry.expense;
                            totalExpense += entry.expense;
                        }
                        return [
                            fmtDate(entry.date),
                            entry.description,
                            entry.type,
                            entry.income > 0 ? fmt(entry.income) : '-',
                            entry.expense > 0 ? fmt(entry.expense) : '-',
                            fmt(runningBalance)
                        ];
                    });
                    
                    // Add totals row
                    tableData.push(['', '', 'TOTALS:', fmt(totalIncome), fmt(totalExpense), fmt(runningBalance)]);
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('LEDGER REPORT', 105, 35, { align: 'center' });
                    doc.setFontSize(9);
                    doc.text('Total Income: ' + fmt(totalIncome) + ' XAF | Total Expenses: ' + fmt(totalExpense) + ' XAF | Balance: ' + fmt(runningBalance) + ' XAF', 105, 42, { align: 'center' });
                    doc.autoTable({ 
                        startY: 48, 
                        head: [['Date', 'Description', 'Type', 'Income', 'Expense', 'Balance']], 
                        body: tableData, 
                        styles: { fontSize: 7 },
                        headStyles: { fillColor: [44, 82, 130] },
                        footStyles: { fillColor: [247, 250, 252], textColor: [0, 0, 0], fontStyle: 'bold' }
                    });
                    doc.save('campost_ledger.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'heirs') {
                api('/inheritance/calculate').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('INHERITANCE REPORT', 105, 35, { align: 'center' });
                    doc.setFontSize(10);
                    doc.text('Amount: ' + fmt(d.inheritanceAmount) + ' XAF | Per Portion: ' + fmt(d.sharePerPortion) + ' XAF', 105, 42, { align: 'center' });
                    doc.autoTable({ startY: 48, head: [['Name', 'Relationship', 'Group', 'Portions', 'Share']], body: d.heirs.map(function(h) { return [h.name, h.relationship, h.heir_group, h.portions, fmt(Math.round(h.shareAmount))]; }), styles: { fontSize: 8 } });
                    doc.save('campost_heirs.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'properties') {
                var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('FAMILY REAL ESTATE PORTFOLIO', 105, 35, { align: 'center' });
                doc.setFontSize(9);
                doc.text('Total Properties: ' + properties.length + ' | Rented: ' + properties.filter(function(p) { return p.status === 'Rented'; }).length, 105, 42, { align: 'center' });
                doc.autoTable({ 
                    startY: 48, 
                    head: [['Property', 'Location', 'Type', 'Status', 'Income', 'Islamic Inh.']], 
                    body: properties.map(function(p) { 
                        return [p.name, p.location, p.type, p.status, p.status === 'Rented' ? fmt(p.rent_amount) : '0', p.islamic_inheritance || 'NA']; 
                    }), 
                    styles: { fontSize: 7 },
                    headStyles: { fillColor: [44, 82, 130] }
                });
                doc.save('family_properties.pdf');
                showAlert('PDF exported!');
            } else if (type === 'rentalIncome') {
                var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
                var rentedProps = properties.filter(function(p) { return p.status === 'Rented'; });
                var totalGross = 0, totalTax = 0, totalNet = 0;
                
                var tableData = rentedProps.map(function(p) {
                    var rent = parseFloat(p.rent_amount) || 0;
                    var taxRate = parseFloat(p.tax_rate) || 0;
                    var taxAmt = rent * taxRate / 100;
                    var net = rent - taxAmt;
                    totalGross += rent;
                    totalTax += taxAmt;
                    totalNet += net;
                    return [p.name, p.location, fmt(rent), p.rent_period || 'Monthly', taxRate + '%', fmt(Math.round(taxAmt)), fmt(Math.round(net))];
                });
                tableData.push(['', '', 'TOTALS:', '', '', fmt(Math.round(totalTax)), fmt(Math.round(totalNet))]);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('RENTAL INCOME REPORT', 105, 35, { align: 'center' });
                doc.setFontSize(9);
                doc.text('Gross: ' + fmt(Math.round(totalGross)) + ' XAF | Tax: ' + fmt(Math.round(totalTax)) + ' XAF | Net: ' + fmt(Math.round(totalNet)) + ' XAF', 105, 42, { align: 'center' });
                doc.autoTable({ 
                    startY: 48, 
                    head: [['Property', 'Location', 'Rent', 'Period', 'Tax Rate', 'Tax Amount', 'Net Income']], 
                    body: tableData, 
                    styles: { fontSize: 7 },
                    headStyles: { fillColor: [214, 158, 46] }
                });
                doc.save('rental_income.pdf');
                showAlert('PDF exported!');
            } else if (type === 'reLedger') {
                var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
                var rentedProps = properties.filter(function(p) { return p.status === 'Rented'; });
                var totalIncome = 0;
                
                var tableData = rentedProps.map(function(p) {
                    var rent = parseFloat(p.rent_amount) || 0;
                    var taxRate = parseFloat(p.tax_rate) || 0;
                    var net = rent - (rent * taxRate / 100);
                    totalIncome += net;
                    return [fmtDate(new Date()), p.name, 'Rental Income (' + (p.rent_period || 'Monthly') + ')', 'Income', fmt(Math.round(net)), '-', fmt(Math.round(totalIncome))];
                });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REAL ESTATE LEDGER', 105, 35, { align: 'center' });
                doc.autoTable({ 
                    startY: 42, 
                    head: [['Date', 'Property', 'Description', 'Type', 'Income', 'Expense', 'Balance']], 
                    body: tableData, 
                    styles: { fontSize: 7 },
                    headStyles: { fillColor: [44, 82, 130] }
                });
                doc.save('real_estate_ledger.pdf');
                showAlert('PDF exported!');
            }
        }

        function exportAllPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            Promise.all([api('/export/all'), api('/inheritance/calculate')]).then(function(results) {
                var all = results[0];
                var inh = results[1];
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('CAMPOST MANKON', 105, 15, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868', 105, 22, { align: 'center' });
                doc.line(20, 25, 190, 25);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('FINANCIAL SUMMARY', 20, 33);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Bills Paid: ' + fmt(all.summary.totalBillsPaid) + ' | Expenses: ' + fmt(all.summary.totalExpenses) + ' | Reserve: ' + fmt(all.summary.reserveFunds), 20, 40);
                doc.text('BILLS', 20, 50);
                doc.autoTable({ startY: 53, head: [['Bill #', 'Period', 'Year', 'Due', 'Paid', 'Outstanding']], body: all.bills.map(function(b) { return [b.bill_number, b.period, b.year, fmt(b.amount_due), fmt(b.paid_amount), fmt(b.outstanding)]; }), styles: { fontSize: 7 } });
                doc.addPage();
                doc.setFont('helvetica', 'bold');
                doc.text('PAYMENTS', 20, 15);
                doc.autoTable({ startY: 18, head: [['Date', 'Bill', 'Amount', 'Reference']], body: all.payments.map(function(p) { return [p.payment_date ? p.payment_date.split('T')[0] : '', p.bill_number, fmt(p.amount), p.reference || '']; }), styles: { fontSize: 7 } });
                var y = doc.lastAutoTable.finalY + 10;
                doc.text('EXPENSES', 20, y);
                doc.autoTable({ startY: y + 3, head: [['Date', 'Description', 'Category', 'Amount']], body: all.expenses.map(function(e) { return [e.expense_date ? e.expense_date.split('T')[0] : '', e.description ? e.description.substring(0, 25) : '', e.category_name || '', fmt(e.amount)]; }), styles: { fontSize: 7 } });
                doc.addPage();
                doc.text('INHERITANCE (' + fmt(inh.inheritanceAmount) + ' XAF)', 20, 15);
                doc.autoTable({ startY: 20, head: [['Name', 'Relationship', 'Group', 'Portions', 'Share']], body: inh.heirs.map(function(h) { return [h.name, h.relationship, h.heir_group, h.portions, fmt(Math.round(h.shareAmount))]; }), styles: { fontSize: 7 } });
                doc.save('campost_complete_report.pdf');
                showAlert('Complete PDF exported!');
            });
        }

        function download(content, filename) {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content], { type: 'text/csv' }));
            a.download = filename;
            a.click();
            showAlert('Exported!');
        }

        function printPage(pageId) {
            document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('printing'); });
            document.getElementById(pageId).classList.add('printing');
            window.print();
        }

        // Settings
        function checkDb() {
            api('/status').then(function(s) {
                document.getElementById('dbStatus').textContent = s.connected ? 'âœ“ Connected' : 'âœ— Offline';
                document.getElementById('dbStatus').className = 'db-status ' + (s.connected ? 'connected' : 'disconnected');
                document.getElementById('settingsAlert').className = 'alert alert-' + (s.connected ? 'success' : 'error');
                document.getElementById('settingsAlert').innerHTML = s.connected ? 'âœ“ PostgreSQL Connected' : 'âœ— Offline';
            }).catch(function() {
                document.getElementById('dbStatus').textContent = 'âœ— Offline';
                document.getElementById('dbStatus').className = 'db-status disconnected';
            });
        }

        function resetAll() {
            if (!confirm('RESET ALL DATA?')) return;
            api('/reset', { method: 'POST' }).then(function() {
                showAlert('Data reset!');
                loadDashboard();
            });
        }

        // ==========================================
        // FAMILY REAL ESTATES MODULE
        // ==========================================

        // Show RE Tab
        function showRETab(tabId, btn) {
            document.querySelectorAll('#realestate .tab-content').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('#realestate .tab-btn').forEach(function(b) { b.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        // Load Real Estate Data
        function loadRealEstate() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');

            var totalIncome = 0;
            rePayments.forEach(function(p) { totalIncome += parseFloat(p.amount) || 0; });

            var totalExpenses = 0;
            reExpenses.forEach(function(e) { totalExpenses += parseFloat(e.amount) || 0; });

            var rentedProps = properties.filter(function(p) { return p.status === 'Rented'; });

            document.getElementById('reTotalProps').textContent = properties.length;
            document.getElementById('reRented').textContent = rentedProps.length;
            document.getElementById('reTotalIncome').textContent = fmt(Math.round(totalIncome));
            document.getElementById('reTotalExpenses').textContent = fmt(Math.round(totalExpenses));

            renderPropertiesTable(properties);
            renderRentalIncomeTable(properties);
        }

        // Render Properties Table - show ALL properties with zeros for non-rented
        function renderPropertiesTable(properties) {
            var filterStatus = document.getElementById('reStatusFilter').value;
            var filtered = filterStatus ? properties.filter(function(p) { return p.status === filterStatus; }) : properties;

            var html = filtered.map(function(p) {
                var isRented = p.status === 'Rented';
                var statusClass = isRented ? 'badge-income' : p.status === 'Sold' ? 'badge-paid' : p.status === 'For sale' ? 'badge-new' : 'badge-expense';
                
                // Non-rented: all financial fields are 0
                var rentAmount = isRented ? (parseFloat(p.rent_amount) || 0) : 0;
                var period = isRented ? (p.rent_period || 'Monthly') : '-';
                var taxRate = isRented ? (parseFloat(p.tax_rate) || 0) : 0;
                var taxAmount = rentAmount * taxRate / 100;
                var netIncome = rentAmount - taxAmount;

                return '<tr>' +
                    '<td><strong>' + p.name + '</strong></td>' +
                    '<td>' + p.location + '</td>' +
                    '<td>' + p.type + '</td>' +
                    '<td><span class="badge ' + statusClass + '">' + p.status + '</span></td>' +
                    '<td>' + fmt(rentAmount) + '</td>' +
                    '<td>' + period + '</td>' +
                    '<td>' + taxRate + '%</td>' +
                    '<td class="' + (netIncome > 0 ? 'amount-positive' : '') + '">' + fmt(Math.round(netIncome)) + '</td>' +
                    '<td>' + (p.islamic_inheritance || 'NA') + '</td>' +
                    '<td class="no-print">' +
                        '<button class="btn btn-warning btn-sm" onclick="editProperty(' + p.id + ')">âœï¸</button> ' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteProperty(' + p.id + ')">ğŸ—‘ï¸</button>' +
                    '</td>' +
                '</tr>';
            }).join('');

            document.getElementById('propertiesTable').innerHTML = html || '<tr><td colspan="10">No properties found</td></tr>';
        }

        // Render Rental Income Table - show ALL properties with zeros for non-rented
        function renderRentalIncomeTable(properties) {
            var totalGross = 0;
            var totalTax = 0;
            var totalNet = 0;

            var html = properties.map(function(p) {
                var isRented = p.status === 'Rented';
                
                // Non-rented: all zeros
                var rent = isRented ? (parseFloat(p.rent_amount) || 0) : 0;
                var taxRate = isRented ? (parseFloat(p.tax_rate) || 0) : 0;
                var period = isRented ? (p.rent_period || 'Monthly') : '-';
                var taxAmount = rent * taxRate / 100;
                var netIncome = rent - taxAmount;

                totalGross += rent;
                totalTax += taxAmount;
                totalNet += netIncome;

                var statusClass = isRented ? 'badge-income' : 'badge-expense';

                return '<tr>' +
                    '<td><strong>' + p.name + '</strong></td>' +
                    '<td>' + p.location + '</td>' +
                    '<td><span class="badge ' + statusClass + '">' + p.status + '</span></td>' +
                    '<td>' + fmt(rent) + '</td>' +
                    '<td>' + period + '</td>' +
                    '<td>' + taxRate + '%</td>' +
                    '<td>' + fmt(rent) + '</td>' +
                    '<td class="' + (taxAmount > 0 ? 'amount-negative' : '') + '">' + (taxAmount > 0 ? '-' : '') + fmt(Math.round(taxAmount)) + '</td>' +
                    '<td class="' + (netIncome > 0 ? 'amount-positive' : '') + '">' + fmt(Math.round(netIncome)) + '</td>' +
                '</tr>';
            }).join('');

            document.getElementById('rentalIncomeTable').innerHTML = html || '<tr><td colspan="9">No properties</td></tr>';
            
            document.getElementById('rentalIncomeTotals').innerHTML = 
                '<tr style="background: #f7fafc; font-weight: bold;">' +
                '<td colspan="6" style="text-align: right;">TOTALS:</td>' +
                '<td>' + fmt(Math.round(totalGross)) + '</td>' +
                '<td class="amount-negative">-' + fmt(Math.round(totalTax)) + '</td>' +
                '<td class="amount-positive">' + fmt(Math.round(totalNet)) + '</td>' +
                '</tr>';
        }

        // Filter Properties
        function filterProperties() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            renderPropertiesTable(properties);
        }

        // Toggle Rental Fields - non-rented properties have zeros
        function toggleRentalFields() {
            var status = document.getElementById('propStatus').value;
            var rentalFields = document.getElementById('rentalFields');
            var isRented = status === 'Rented';
            
            if (isRented) {
                rentalFields.style.display = 'block';
            } else {
                rentalFields.style.display = 'none';
                // Set all to zero for non-rented
                document.getElementById('propRentAmount').value = 0;
                document.getElementById('propTaxRate').value = '0';
            }
            updatePropertyCalc();
        }

        // Update Property Calculation - respects rented status
        function updatePropertyCalc() {
            var status = document.getElementById('propStatus').value;
            var isRented = status === 'Rented';
            
            var rent = isRented ? (parseFloat(document.getElementById('propRentAmount').value) || 0) : 0;
            var taxRate = isRented ? (parseFloat(document.getElementById('propTaxRate').value) || 0) : 0;
            var taxAmount = rent * taxRate / 100;
            var netIncome = rent - taxAmount;

            document.getElementById('propGrossRent').textContent = fmt(rent) + ' XAF';
            document.getElementById('propTaxAmount').textContent = '-' + fmt(Math.round(taxAmount)) + ' XAF';
            document.getElementById('propNetIncome').textContent = fmt(Math.round(netIncome)) + ' XAF';
        }

        // Open Property Modal
        function openPropertyModal() {
            document.getElementById('propertyModalTitle').textContent = 'ğŸ  Add Property';
            document.getElementById('propId').value = '';
            document.getElementById('propName').value = '';
            document.getElementById('propLocation').value = '';
            document.getElementById('propType').value = 'Residential';
            document.getElementById('propStatus').value = 'Rented';
            document.getElementById('propRentAmount').value = 0;
            document.getElementById('propRentPeriod').value = 'Monthly';
            document.getElementById('propTaxRate').value = '15';
            document.getElementById('propInheritance').value = 'Yes';
            document.getElementById('propNotes').value = '';
            toggleRentalFields();
            document.getElementById('propertyModal').classList.add('active');
        }

        function closePropertyModal() {
            document.getElementById('propertyModal').classList.remove('active');
        }

        // Edit Property - loads zeros for non-rented
        function editProperty(id) {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var p = properties.find(function(x) { return x.id === id; });
            if (p) {
                var isRented = p.status === 'Rented';
                document.getElementById('propertyModalTitle').textContent = 'ğŸ  Edit Property';
                document.getElementById('propId').value = p.id;
                document.getElementById('propName').value = p.name;
                document.getElementById('propLocation').value = p.location;
                document.getElementById('propType').value = p.type;
                document.getElementById('propStatus').value = p.status;
                document.getElementById('propRentAmount').value = isRented ? (p.rent_amount || 0) : 0;
                document.getElementById('propRentPeriod').value = p.rent_period || 'Monthly';
                document.getElementById('propTaxRate').value = isRented ? (p.tax_rate || '15') : '0';
                document.getElementById('propInheritance').value = p.islamic_inheritance || 'Yes';
                document.getElementById('propNotes').value = p.notes || '';
                toggleRentalFields();
                document.getElementById('propertyModal').classList.add('active');
            }
        }

        // Save Property
        function saveProperty() {
            var id = document.getElementById('propId').value;
            var name = document.getElementById('propName').value;
            var location = document.getElementById('propLocation').value;
            var type = document.getElementById('propType').value;
            var status = document.getElementById('propStatus').value;
            
            // Non-rented properties: all financial fields are 0
            var isRented = status === 'Rented';
            var rentAmount = isRented ? (parseFloat(document.getElementById('propRentAmount').value) || 0) : 0;
            var rentPeriod = isRented ? document.getElementById('propRentPeriod').value : 'Monthly';
            var taxRate = isRented ? (parseFloat(document.getElementById('propTaxRate').value) || 0) : 0;
            var inheritance = document.getElementById('propInheritance').value;
            var notes = document.getElementById('propNotes').value;

            if (!name || !location) {
                showAlert('Please fill required fields', 'error');
                return;
            }

            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');

            if (id) {
                // Update existing
                var idx = properties.findIndex(function(p) { return p.id === parseInt(id); });
                if (idx !== -1) {
                    properties[idx] = {
                        id: parseInt(id),
                        name: name,
                        location: location,
                        type: type,
                        status: status,
                        rent_amount: rentAmount,
                        rent_period: rentPeriod,
                        tax_rate: taxRate,
                        islamic_inheritance: inheritance,
                        notes: notes,
                        updated_at: new Date().toISOString()
                    };
                }
            } else {
                // Add new
                var newId = properties.length > 0 ? Math.max.apply(null, properties.map(function(p) { return p.id; })) + 1 : 1;
                properties.push({
                    id: newId,
                    name: name,
                    location: location,
                    type: type,
                    status: status,
                    rent_amount: rentAmount,
                    rent_period: rentPeriod,
                    tax_rate: taxRate,
                    islamic_inheritance: inheritance,
                    notes: notes,
                    created_at: new Date().toISOString()
                });
            }

            localStorage.setItem('familyProperties', JSON.stringify(properties));
            closePropertyModal();
            showAlert(id ? 'Property updated!' : 'Property added!');
            loadRealEstate();
        }

        // Delete Property
        function deleteProperty(id) {
            if (!confirm('Delete this property?')) return;
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            properties = properties.filter(function(p) { return p.id !== id; });
            localStorage.setItem('familyProperties', JSON.stringify(properties));
            showAlert('Property deleted');
            loadRealEstate();
        }

        // ========== RE BILLS ==========
        function loadREBills() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var rentedProps = properties.filter(function(p) { return p.status === 'Rented'; });
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');

            document.getElementById('reBillProperty').innerHTML = '<option value="">Select Property</option>' + 
                rentedProps.map(function(p) { return '<option value="' + p.id + '">' + p.name + '</option>'; }).join('');

            if (!document.getElementById('reBillDate').value) {
                document.getElementById('reBillDate').valueAsDate = new Date();
            }

            var html = reBills.map(function(b) {
                var prop = properties.find(function(p) { return p.id === b.property_id; });
                var status = b.outstanding === 0 ? 'Paid' : b.paid_amount > 0 ? 'Partial' : 'Unpaid';
                var statusClass = status === 'Paid' ? 'badge-paid' : status === 'Partial' ? 'badge-new' : 'badge-unpaid';
                return '<tr><td><strong>' + b.bill_number + '</strong></td><td>' + (prop ? prop.name : 'N/A') + '</td><td>' + b.period + '</td><td>' + b.year + '</td><td>' + fmt(b.amount_due) + '</td><td class="amount-positive">' + fmt(b.paid_amount || 0) + '</td><td class="' + (b.outstanding > 0 ? 'amount-negative' : '') + '">' + fmt(b.outstanding) + '</td><td><span class="badge ' + statusClass + '">' + status + '</span></td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editREBill(' + b.id + ')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteREBill(' + b.id + ')">ğŸ—‘ï¸</button></td></tr>';
            }).join('');

            document.getElementById('reBillsTable').innerHTML = html || '<tr><td colspan="9">No bills</td></tr>';
        }

        function saveREBill() {
            var id = document.getElementById('reBillId').value;
            var propertyId = parseInt(document.getElementById('reBillProperty').value);
            var billDate = document.getElementById('reBillDate').value;
            var period = document.getElementById('reBillPeriod').value;
            var year = document.getElementById('reBillYear').value;
            var amountDue = parseFloat(document.getElementById('reBillAmount').value) || 0;
            var desc = document.getElementById('reBillDesc').value;

            if (!propertyId || !amountDue) { showAlert('Please fill required fields', 'error'); return; }

            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var billNumber = 'RE-' + period.substring(0,2).toUpperCase() + '-' + year + '-' + String(reBills.length + 1).padStart(3, '0');

            if (id) {
                var idx = reBills.findIndex(function(b) { return b.id === parseInt(id); });
                if (idx !== -1) {
                    reBills[idx].property_id = propertyId;
                    reBills[idx].bill_date = billDate;
                    reBills[idx].period = period;
                    reBills[idx].year = year;
                    reBills[idx].amount_due = amountDue;
                    reBills[idx].outstanding = amountDue - (reBills[idx].paid_amount || 0);
                    reBills[idx].description = desc;
                }
            } else {
                reBills.push({ id: reBills.length > 0 ? Math.max.apply(null, reBills.map(function(b) { return b.id; })) + 1 : 1, bill_number: billNumber, property_id: propertyId, bill_date: billDate, period: period, year: year, amount_due: amountDue, paid_amount: 0, outstanding: amountDue, description: desc, created_at: new Date().toISOString() });
            }

            localStorage.setItem('reBills', JSON.stringify(reBills));
            clearREBillForm();
            showAlert(id ? 'Bill updated!' : 'Bill created!');
            loadREBills();
        }

        function clearREBillForm() { document.getElementById('reBillId').value = ''; document.getElementById('reBillProperty').value = ''; document.getElementById('reBillAmount').value = ''; document.getElementById('reBillDesc').value = ''; }

        function editREBill(id) {
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var b = reBills.find(function(x) { return x.id === id; });
            if (b) { document.getElementById('reBillId').value = b.id; document.getElementById('reBillProperty').value = b.property_id; document.getElementById('reBillDate').value = b.bill_date; document.getElementById('reBillPeriod').value = b.period; document.getElementById('reBillYear').value = b.year; document.getElementById('reBillAmount').value = b.amount_due; document.getElementById('reBillDesc').value = b.description || ''; }
        }

        function deleteREBill(id) { if (!confirm('Delete this bill?')) return; var reBills = JSON.parse(localStorage.getItem('reBills') || '[]'); reBills = reBills.filter(function(b) { return b.id !== id; }); localStorage.setItem('reBills', JSON.stringify(reBills)); showAlert('Bill deleted'); loadREBills(); }

        // ========== RE PAYMENTS ==========
        function loadREPayments() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');

            var unpaidBills = reBills.filter(function(b) { return b.outstanding > 0; });
            document.getElementById('rePayBill').innerHTML = '<option value="">Select Bill</option>' + unpaidBills.map(function(b) { var prop = properties.find(function(p) { return p.id === b.property_id; }); return '<option value="' + b.id + '">' + b.bill_number + ' - ' + (prop ? prop.name : '') + ' (' + fmt(b.outstanding) + ' due)</option>'; }).join('');

            if (!document.getElementById('rePayDate').value) { document.getElementById('rePayDate').valueAsDate = new Date(); }

            var html = rePayments.map(function(p) { var bill = reBills.find(function(b) { return b.id === p.bill_id; }); var prop = bill ? properties.find(function(pr) { return pr.id === bill.property_id; }) : null; return '<tr><td>' + fmtDate(p.payment_date) + '</td><td>' + (prop ? prop.name : 'N/A') + '</td><td>' + (bill ? bill.bill_number : 'N/A') + '</td><td class="amount-positive">' + fmt(p.amount) + '</td><td>' + (p.reference || '-') + '</td><td class="no-print"><button class="btn btn-danger btn-sm" onclick="deleteREPayment(' + p.id + ')">ğŸ—‘ï¸</button></td></tr>'; }).join('');

            document.getElementById('rePaymentsTable').innerHTML = html || '<tr><td colspan="6">No payments</td></tr>';
        }

        function saveREPayment() {
            var billId = parseInt(document.getElementById('rePayBill').value);
            var payDate = document.getElementById('rePayDate').value;
            var amount = parseFloat(document.getElementById('rePayAmount').value) || 0;
            var reference = document.getElementById('rePayRef').value;

            if (!billId || !amount) { showAlert('Please fill required fields', 'error'); return; }

            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');

            var billIdx = reBills.findIndex(function(b) { return b.id === billId; });
            if (billIdx !== -1) { reBills[billIdx].paid_amount = (reBills[billIdx].paid_amount || 0) + amount; reBills[billIdx].outstanding = reBills[billIdx].amount_due - reBills[billIdx].paid_amount; localStorage.setItem('reBills', JSON.stringify(reBills)); }

            rePayments.push({ id: rePayments.length > 0 ? Math.max.apply(null, rePayments.map(function(p) { return p.id; })) + 1 : 1, bill_id: billId, payment_date: payDate, amount: amount, reference: reference, created_at: new Date().toISOString() });

            localStorage.setItem('rePayments', JSON.stringify(rePayments));
            clearREPaymentForm();
            showAlert('Payment recorded!');
            loadREPayments();
            loadRealEstate();
        }

        function clearREPaymentForm() { document.getElementById('rePayId').value = ''; document.getElementById('rePayBill').value = ''; document.getElementById('rePayAmount').value = ''; document.getElementById('rePayRef').value = ''; }

        function deleteREPayment(id) {
            if (!confirm('Delete this payment?')) return;
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            var payment = rePayments.find(function(p) { return p.id === id; });
            if (payment) { var reBills = JSON.parse(localStorage.getItem('reBills') || '[]'); var billIdx = reBills.findIndex(function(b) { return b.id === payment.bill_id; }); if (billIdx !== -1) { reBills[billIdx].paid_amount -= payment.amount; reBills[billIdx].outstanding += payment.amount; localStorage.setItem('reBills', JSON.stringify(reBills)); } }
            rePayments = rePayments.filter(function(p) { return p.id !== id; });
            localStorage.setItem('rePayments', JSON.stringify(rePayments));
            showAlert('Payment deleted');
            loadREPayments();
            loadRealEstate();
        }

        // ========== RE EXPENSES ==========
        function loadREExpenses() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');

            document.getElementById('reExpProperty').innerHTML = '<option value="">Select Property</option>' + properties.map(function(p) { return '<option value="' + p.id + '">' + p.name + '</option>'; }).join('');

            if (!document.getElementById('reExpDate').value) { document.getElementById('reExpDate').valueAsDate = new Date(); }

            var html = reExpenses.map(function(e) { var prop = properties.find(function(p) { return p.id === e.property_id; }); var isInh = e.category === 'Inheritance Share'; return '<tr><td>' + fmtDate(e.expense_date) + '</td><td>' + (prop ? prop.name : 'General') + '</td><td>' + e.category + '</td><td>' + e.description + '</td><td class="' + (isInh ? 'amount-gold' : 'amount-negative') + '">-' + fmt(e.amount) + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editREExpense(' + e.id + ')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteREExpense(' + e.id + ')">ğŸ—‘ï¸</button></td></tr>'; }).join('');

            document.getElementById('reExpensesTable').innerHTML = html || '<tr><td colspan="6">No expenses</td></tr>';
        }

        function saveREExpense() {
            var id = document.getElementById('reExpId').value;
            var propertyId = parseInt(document.getElementById('reExpProperty').value) || null;
            var expDate = document.getElementById('reExpDate').value;
            var category = document.getElementById('reExpCategory').value;
            var amount = parseFloat(document.getElementById('reExpAmount').value) || 0;
            var desc = document.getElementById('reExpDesc').value;

            if (!amount || !desc) { showAlert('Please fill required fields', 'error'); return; }

            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');

            if (id) { var idx = reExpenses.findIndex(function(e) { return e.id === parseInt(id); }); if (idx !== -1) { reExpenses[idx].property_id = propertyId; reExpenses[idx].expense_date = expDate; reExpenses[idx].category = category; reExpenses[idx].amount = amount; reExpenses[idx].description = desc; } }
            else { reExpenses.push({ id: reExpenses.length > 0 ? Math.max.apply(null, reExpenses.map(function(e) { return e.id; })) + 1 : 1, property_id: propertyId, expense_date: expDate, category: category, amount: amount, description: desc, created_at: new Date().toISOString() }); }

            localStorage.setItem('reExpenses', JSON.stringify(reExpenses));
            clearREExpenseForm();
            showAlert(id ? 'Expense updated!' : 'Expense added!');
            loadREExpenses();
            loadRealEstate();
        }

        function clearREExpenseForm() { document.getElementById('reExpId').value = ''; document.getElementById('reExpProperty').value = ''; document.getElementById('reExpAmount').value = ''; document.getElementById('reExpDesc').value = ''; }

        function editREExpense(id) { var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]'); var e = reExpenses.find(function(x) { return x.id === id; }); if (e) { document.getElementById('reExpId').value = e.id; document.getElementById('reExpProperty').value = e.property_id || ''; document.getElementById('reExpDate').value = e.expense_date; document.getElementById('reExpCategory').value = e.category; document.getElementById('reExpAmount').value = e.amount; document.getElementById('reExpDesc').value = e.description; } }

        function deleteREExpense(id) { if (!confirm('Delete this expense?')) return; var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]'); reExpenses = reExpenses.filter(function(e) { return e.id !== id; }); localStorage.setItem('reExpenses', JSON.stringify(reExpenses)); showAlert('Expense deleted'); loadREExpenses(); loadRealEstate(); }

        // ========== RE INHERITANCE ==========
        function loadREInheritance() {
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');
            var reHeirs = JSON.parse(localStorage.getItem('reHeirs') || '[]');

            var totalIncome = 0; rePayments.forEach(function(p) { totalIncome += parseFloat(p.amount) || 0; });
            var totalExpenses = 0; reExpenses.forEach(function(e) { totalExpenses += parseFloat(e.amount) || 0; });

            var inheritancePool = Math.max(0, totalIncome - totalExpenses);
            var totalPortions = reHeirs.reduce(function(sum, h) { return sum + parseFloat(h.portions); }, 0);
            var perPortion = totalPortions > 0 ? inheritancePool / totalPortions : 0;

            document.getElementById('reInhPool').textContent = fmt(Math.round(inheritancePool));
            document.getElementById('reInhHeirs').textContent = reHeirs.length;
            document.getElementById('reInhPortions').textContent = totalPortions;
            document.getElementById('reInhPerPortion').textContent = fmt(Math.round(perPortion));

            var html = reHeirs.map(function(h) { var shareAmount = perPortion * parseFloat(h.portions); return '<tr><td>' + h.name + '</td><td>' + h.relationship + '</td><td>' + h.heir_group + '</td><td>' + h.portions + '</td><td class="amount-positive">' + fmt(Math.round(shareAmount)) + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editREHeir(' + h.id + ')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteREHeir(' + h.id + ')">ğŸ—‘ï¸</button></td></tr>'; }).join('');

            document.getElementById('reHeirsTable').innerHTML = html || '<tr><td colspan="6">No heirs</td></tr>';
        }

        function openREHeirModal() { document.getElementById('reHeirId').value = ''; document.getElementById('reHeirName').value = ''; document.getElementById('reHeirRel').value = 'Spouse'; document.getElementById('reHeirGrp').value = 'Wives'; document.getElementById('reHeirPor').value = 1; document.getElementById('reHeirModal').classList.add('active'); }
        function closeREHeirModal() { document.getElementById('reHeirModal').classList.remove('active'); }

        function editREHeir(id) { var reHeirs = JSON.parse(localStorage.getItem('reHeirs') || '[]'); var h = reHeirs.find(function(x) { return x.id === id; }); if (h) { document.getElementById('reHeirId').value = h.id; document.getElementById('reHeirName').value = h.name; document.getElementById('reHeirRel').value = h.relationship; document.getElementById('reHeirGrp').value = h.heir_group; document.getElementById('reHeirPor').value = h.portions; document.getElementById('reHeirModal').classList.add('active'); } }

        function saveREHeir() {
            var id = document.getElementById('reHeirId').value;
            var name = document.getElementById('reHeirName').value;
            var rel = document.getElementById('reHeirRel').value;
            var grp = document.getElementById('reHeirGrp').value;
            var por = parseFloat(document.getElementById('reHeirPor').value) || 1;

            if (!name) { showAlert('Please enter name', 'error'); return; }

            var reHeirs = JSON.parse(localStorage.getItem('reHeirs') || '[]');

            if (id) { var idx = reHeirs.findIndex(function(h) { return h.id === parseInt(id); }); if (idx !== -1) { reHeirs[idx].name = name; reHeirs[idx].relationship = rel; reHeirs[idx].heir_group = grp; reHeirs[idx].portions = por; } }
            else { reHeirs.push({ id: reHeirs.length > 0 ? Math.max.apply(null, reHeirs.map(function(h) { return h.id; })) + 1 : 1, name: name, relationship: rel, heir_group: grp, portions: por }); }

            localStorage.setItem('reHeirs', JSON.stringify(reHeirs));
            closeREHeirModal();
            showAlert(id ? 'Heir updated!' : 'Heir added!');
            loadREInheritance();
        }

        function deleteREHeir(id) { if (!confirm('Delete this heir?')) return; var reHeirs = JSON.parse(localStorage.getItem('reHeirs') || '[]'); reHeirs = reHeirs.filter(function(h) { return h.id !== id; }); localStorage.setItem('reHeirs', JSON.stringify(reHeirs)); showAlert('Heir deleted'); loadREInheritance(); }

        // ========== RE LEDGER ==========
        function loadRELedgerFull() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');

            var ledgerEntries = [];

            rePayments.forEach(function(p) { var bill = reBills.find(function(b) { return b.id === p.bill_id; }); var prop = bill ? properties.find(function(pr) { return pr.id === bill.property_id; }) : null; ledgerEntries.push({ date: p.payment_date, property: prop ? prop.name : 'N/A', description: 'Payment for ' + (bill ? bill.bill_number : 'Bill'), type: 'Income', income: p.amount, expense: 0 }); });

            reExpenses.forEach(function(e) { var prop = properties.find(function(p) { return p.id === e.property_id; }); ledgerEntries.push({ date: e.expense_date, property: prop ? prop.name : 'General', description: e.description, type: e.category, income: 0, expense: e.amount }); });

            ledgerEntries.sort(function(a, b) { return new Date(a.date) - new Date(b.date); });

            var runningBalance = 0, totalIncome = 0, totalExpense = 0;

            var html = ledgerEntries.map(function(entry) { runningBalance += entry.income - entry.expense; totalIncome += entry.income; totalExpense += entry.expense; var isIncome = entry.income > 0; var isInh = entry.type === 'Inheritance Share'; return '<tr><td>' + fmtDate(entry.date) + '</td><td>' + entry.property + '</td><td>' + entry.description + '</td><td><span class="badge ' + (isIncome ? 'badge-income' : isInh ? 'badge-inheritance' : 'badge-expense') + '">' + entry.type + '</span></td><td class="amount-positive">' + (entry.income > 0 ? fmt(entry.income) : '-') + '</td><td class="' + (isInh ? 'amount-gold' : 'amount-negative') + '">' + (entry.expense > 0 ? fmt(entry.expense) : '-') + '</td><td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(Math.round(runningBalance)) + '</td></tr>'; }).join('');

            document.getElementById('reLedgerTable').innerHTML = html || '<tr><td colspan="7">No transactions</td></tr>';
            document.getElementById('reLedgerTotals').innerHTML = '<tr style="background: #f7fafc; font-weight: bold;"><td colspan="4" style="text-align: right;">TOTALS:</td><td class="amount-positive">' + fmt(Math.round(totalIncome)) + '</td><td class="amount-negative">' + fmt(Math.round(totalExpense)) + '</td><td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(Math.round(runningBalance)) + '</td></tr>';
        }

        // ========== RE SETTINGS & EXPORT ==========
        function saveRESettings() { var settings = { taxRate: document.getElementById('reSettingTaxRate').value, period: document.getElementById('reSettingPeriod').value, inhPercent: document.getElementById('reSettingInhPercent').value, currency: document.getElementById('reSettingCurrency').value }; localStorage.setItem('reSettings', JSON.stringify(settings)); showAlert('Settings saved!'); }

        function resetREData() { if (!confirm('This will delete ALL Real Estate data. Are you sure?')) return; if (!confirm('FINAL WARNING: This cannot be undone!')) return; localStorage.removeItem('familyProperties'); localStorage.removeItem('reBills'); localStorage.removeItem('rePayments'); localStorage.removeItem('reExpenses'); localStorage.removeItem('reHeirs'); showAlert('All RE data reset'); loadRealEstate(); }

        function exportAllRECSV() { var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]'); var csv = 'FAMILY REAL ESTATES\n\nPROPERTIES\nName,Location,Type,Status,Rent,Period,Tax,Net,Islamic Inh\n'; properties.forEach(function(p) { var isRented = p.status === 'Rented'; var rent = isRented ? (p.rent_amount || 0) : 0; var tax = isRented ? (p.tax_rate || 0) : 0; var net = rent - (rent * tax / 100); csv += '"' + p.name + '","' + p.location + '",' + p.type + ',' + p.status + ',' + rent + ',' + (isRented ? p.rent_period : '-') + ',' + tax + '%,' + Math.round(net) + ',' + (p.islamic_inheritance || 'NA') + '\n'; }); var blob = new Blob([csv], { type: 'text/csv' }); var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'family_real_estates.csv'; a.click(); showAlert('CSV exported!'); }

        function exportAllREPDF() { var jsPDF = window.jspdf.jsPDF; var doc = new jsPDF(); var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]'); doc.setFontSize(16); doc.text('FAMILY REAL ESTATES', 105, 15, { align: 'center' }); doc.setFontSize(10); doc.text('GHOUENZEN Soulemanou', 105, 22, { align: 'center' }); doc.autoTable({ startY: 30, head: [['Property', 'Location', 'Status', 'Rent', 'Tax', 'Net']], body: properties.map(function(p) { var isRented = p.status === 'Rented'; var rent = isRented ? (p.rent_amount || 0) : 0; var tax = isRented ? (p.tax_rate || 0) : 0; var net = rent - (rent * tax / 100); return [p.name, p.location, p.status, fmt(rent), tax + '%', fmt(Math.round(net))]; }), styles: { fontSize: 7 } }); doc.save('family_real_estates.pdf'); showAlert('PDF exported!'); }

        // Setup property form listeners
        document.addEventListener('DOMContentLoaded', function() {
            var rentInput = document.getElementById('propRentAmount');
            var taxInput = document.getElementById('propTaxRate');
            if (rentInput) rentInput.addEventListener('input', updatePropertyCalc);
            if (taxInput) taxInput.addEventListener('change', updatePropertyCalc);
        });

        // Initialize
        function init() {
            checkDb();
            loadDashboard();
        }

        init();
    </script>
</body>
</html>
