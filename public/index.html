<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NJIKAM SALIFU ESTATE</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-dark: #1a365d;
            --primary-blue: #2c5282;
            --primary-light: #4299e1;
            --accent-gold: #d69e2e;
            --accent-orange: #ed8936;
            --success-green: #38a169;
            --danger-red: #e53e3e;
            --bg-cream: #faf5eb;
            --bg-white: #ffffff;
            --text-dark: #1a202c;
            --text-gray: #4a5568;
            --border-color: #e2e8f0;
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', sans-serif;
            background: linear-gradient(135deg, var(--bg-cream) 0%, #e8e0d5 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 1.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: var(--accent-gold);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .logo-text h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
        }

        .logo-text p {
            font-size: 0.65rem;
            opacity: 0.8;
        }

        .header-info {
            text-align: right;
            font-size: 0.75rem;
            flex: 1;
        }

        .db-status {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.6rem;
            margin-top: 0.1rem;
        }

        .db-status.connected {
            background: rgba(56, 161, 105, 0.3);
            color: #9ae6b4;
        }

        .db-status.disconnected {
            background: rgba(229, 62, 62, 0.3);
            color: #feb2b2;
        }

        /* User Profile Section */
        .user-profile-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
        }

        .user-profile-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-icon {
            font-size: 1.2rem;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: white;
        }

        .btn-logout {
            background: rgba(229, 62, 62, 0.8);
            color: white;
            border: none;
            padding: 0.35rem 0.7rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: var(--danger-red);
            transform: scale(1.02);
        }

        .nav {
            display: flex;
            padding: 0 0.5rem;
            flex-wrap: wrap;
            overflow-x: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 0.5rem 0.7rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.15);
            border-bottom-color: var(--accent-gold);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .card {
            background: var(--bg-white);
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.75rem 1rem;
            font-family: 'Playfair Display', serif;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .card-header.green {
            background: linear-gradient(135deg, var(--success-green) 0%, #276749 100%);
        }

        .card-header.gold {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%);
        }

        .card-header.red {
            background: linear-gradient(135deg, var(--danger-red) 0%, #c53030 100%);
        }

        .card-body {
            padding: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--bg-white);
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card.blue::before {
            background: var(--primary-blue);
        }

        .stat-card.green::before {
            background: var(--success-green);
        }

        .stat-card.red::before {
            background: var(--danger-red);
        }

        .stat-card.gold::before {
            background: var(--accent-gold);
        }

        .stat-icon {
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.1rem;
        }

        .stat-label {
            color: var(--text-gray);
            font-size: 0.65rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .form-group input:read-only {
            background: #f7fafc;
        }

        .btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green) 0%, #276749 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-red) 0%, #c53030 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--accent-orange) 0%, #c05621 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-blue);
            color: var(--primary-blue);
        }

        .btn-print {
            background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%);
            color: white;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%);
            color: white;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 400px;
        }

        th,
        td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem;
        }

        th {
            background: #f7fafc;
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        tr:hover {
            background: #f7fafc;
        }

        tr.clickable {
            cursor: pointer;
        }

        tr.clickable:hover {
            background: rgba(66, 153, 225, 0.1);
        }

        .badge {
            padding: 0.15rem 0.35rem;
            border-radius: 8px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-income {
            background: rgba(56, 161, 105, 0.15);
            color: var(--success-green);
        }

        .badge-expense {
            background: rgba(229, 62, 62, 0.15);
            color: var(--danger-red);
        }

        .badge-inheritance {
            background: rgba(214, 158, 46, 0.15);
            color: var(--accent-gold);
        }

        .badge-paid {
            background: rgba(56, 161, 105, 0.15);
            color: var(--success-green);
        }

        .badge-partial {
            background: rgba(236, 201, 75, 0.2);
            color: #b7791f;
        }

        .badge-unpaid {
            background: rgba(229, 62, 62, 0.15);
            color: var(--danger-red);
        }

        .badge-new {
            background: rgba(66, 153, 225, 0.15);
            color: var(--primary-blue);
        }

        /* Landing Page Styles */
        .landing-page {
            text-align: center;
            padding: 2rem 1rem;
        }

        .landing-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .landing-subtitle {
            color: var(--text-gray);
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .landing-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto 2rem;
        }

        @media (max-width: 1200px) {
            .landing-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
            }
        }

        @media (max-width: 900px) {
            .landing-cards {
                grid-template-columns: 1fr;
                max-width: 500px;
            }
        }

        .landing-card {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid transparent;
        }

        .landing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .landing-card.campost {
            border-color: var(--primary-blue);
        }

        .landing-card.campost:hover {
            border-color: var(--accent-gold);
        }

        .landing-card.family {
            border-color: var(--success-green);
        }

        .landing-card.family:hover {
            border-color: var(--accent-gold);
        }

        .landing-card.assets {
            border-color: #805ad5;
        }

        .landing-card.assets:hover {
            border-color: var(--accent-gold);
        }

        .landing-card-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .landing-card-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .landing-card-desc {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 1rem;
            min-height: 40px;
        }

        .landing-card-stats {
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
            padding: 0.75rem 0;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .landing-stat {
            text-align: center;
        }

        .landing-stat-value {
            font-size: 0.95rem;
            font-weight: 700;
        }

        .landing-stat-label {
            font-size: 0.7rem;
            color: var(--text-gray);
        }

        /* Asset Tab Styles */
        .asset-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: #e2e8f0;
            color: #4a5568;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .asset-tab:hover {
            background: #cbd5e0;
        }

        .asset-tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .asset-tab.manka-tab.active {
            background: var(--success-green);
            color: white;
        }

        .asset-tab-content {
            display: none;
        }

        .asset-tab-content.active {
            display: block;
        }

        .manka-tab-content {
            display: none;
        }

        .manka-tab-content.active {
            display: block;
        }

        .asset-actions {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
        }

        .asset-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .tab-wrapper {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .tab-wrapper:hover .tab-actions {
            opacity: 1;
        }

        .tab-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .btn-tab-action {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: none;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e2e8f0;
        }

        .btn-tab-action:hover {
            background: #cbd5e0;
        }

        .btn-tab-delete {
            background: #fed7d7;
            color: #c53030;
        }

        .btn-tab-delete:hover {
            background: #fc8181;
        }

        .landing-card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .landing-card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .landing-card-desc {
            color: var(--text-gray);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .landing-card-stats {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .landing-stat {
            text-align: center;
        }

        .landing-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .landing-stat-label {
            font-size: 0.7rem;
            color: var(--text-gray);
        }

        .back-btn {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 999;
        }

        .module-header {
            display: none;
        }

        .module-header.active {
            display: block;
        }

        .amount-positive {
            color: var(--success-green);
            font-weight: 600;
        }

        .amount-negative {
            color: var(--danger-red);
            font-weight: 600;
        }

        .amount-gold {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .alert {
            padding: 0.6rem 0.9rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
        }

        .alert-success {
            background: rgba(56, 161, 105, 0.15);
            color: var(--success-green);
            border: 1px solid var(--success-green);
        }

        .alert-error {
            background: rgba(229, 62, 62, 0.15);
            color: var(--danger-red);
            border: 1px solid var(--danger-red);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 10px;
            max-width: 750px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .modal-body {
            padding: 1.25rem;
        }

        /* Login Page Styles */
        .login-container {
            display: none;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%);
        }

        .login-container.active {
            display: flex;
        }

        .login-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            overflow: hidden;
        }

        .login-header {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .login-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            margin-bottom: 0.25rem;
        }

        .login-header p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .login-body {
            padding: 1.5rem;
        }

        .login-body .form-group {
            margin-bottom: 1rem;
        }

        .login-body .form-group label {
            font-size: 0.85rem;
        }

        .login-body .form-group input {
            padding: 0.6rem;
            font-size: 0.9rem;
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .login-footer {
            text-align: center;
            padding: 1rem;
            background: #f7fafc;
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        .login-footer a {
            color: var(--primary-blue);
            cursor: pointer;
            text-decoration: underline;
        }

        .login-error {
            background: rgba(229, 62, 62, 0.15);
            color: var(--danger-red);
            padding: 0.5rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .user-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.65rem;
            margin-left: 0.5rem;
            font-weight: bold;
        }

        .user-badge.admin {
            background: rgba(214, 158, 46, 0.2);
            color: var(--accent-gold);
        }

        .user-badge.user {
            background: rgba(66, 153, 225, 0.2);
            color: var(--primary-blue);
        }

        .user-badge.guest {
            background: rgba(160, 174, 192, 0.2);
            color: #718096;
        }

        /* Role-based access control */
        .admin-only {
            display: none !important;
        }

        body.is-admin .admin-only {
            display: inline-flex !important;
        }

        .admin-only-section {
            display: none !important;
        }

        body.is-admin .admin-only-section {
            display: block !important;
        }

        .admin-only-nav {
            display: none !important;
        }

        body.is-admin .admin-only-nav {
            display: inline-block !important;
        }

        .user-restricted-notice {
            display: none;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        body:not(.is-admin) .user-restricted-notice {
            display: block;
        }

        .guest-restricted-notice {
            display: none;
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        body.is-guest .guest-restricted-notice {
            display: block;
        }

        /* Read-only mode for users */
        body.is-user .btn-success:not(.allow-user),
        body.is-user .btn-danger:not(.allow-user),
        body.is-user .btn-warning:not(.allow-user) {
            opacity: 0.5;
            pointer-events: none;
        }

        body.is-guest .btn {
            opacity: 0.5;
            pointer-events: none;
        }

        body.is-guest .btn.allow-guest {
            opacity: 1;
            pointer-events: auto;
        }

        .heir-group {
            background: #f7fafc;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .heir-group h4 {
            color: var(--primary-blue);
            margin-bottom: 0.3rem;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.3rem 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.8rem;
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: 700;
        }

        .highlight-box {
            background: linear-gradient(135deg, rgba(214, 158, 46, 0.15) 0%, rgba(237, 137, 54, 0.15) 100%);
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .highlight-box h3 {
            color: var(--accent-gold);
            font-size: 1.3rem;
        }

        .highlight-box p {
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        /* Beneficiary Selection Styles */
        .beneficiary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }

        .beneficiary-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            cursor: pointer;
        }

        .beneficiary-item:hover {
            background: #edf2f7;
        }

        .beneficiary-item.selected {
            background: #c6f6d5;
            border-color: #48bb78;
        }

        .beneficiary-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }

        .beneficiary-item label {
            cursor: pointer;
            flex: 1;
            font-size: 0.85rem;
        }

        .beneficiary-item .heir-info {
            font-size: 0.75rem;
            color: #718096;
            margin-left: auto;
        }

        .beneficiary-item .heir-portions {
            background: #4299e1;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media print {
            body {
                background: white !important;
            }

            .no-print {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                text-align: center;
            }

            .main-content {
                padding: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- ==================== MAIN APP ==================== -->
    <div id="mainApp" style="display: none;">
        <header class="header no-print">
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo-icon">NS</div>
                    <div class="logo-text">
                        <h1 id="mainTitle">NJIKAM SALIFU ESTATE</h1>
                        <p id="mainSubtitle">Property & Billing Management System</p>
                    </div>
                </div>
                <div class="header-info">
                    <span>B.P 36 Mankon-Bamenda | 675299868</span>
                </div>
                <!-- User Profile Section -->
                <div class="user-profile-section">
                    <div class="user-profile-info">
                        <span class="user-icon">üë§</span>
                        <span id="loggedInUser" class="user-name">User</span>
                        <span id="userRoleBadge" class="user-badge">USER</span>
                    </div>
                    <button class="btn btn-logout" onclick="doLogout()" title="Logout">
                        üö™ Logout
                    </button>
                </div>
            </div>
            <!-- Main Navigation - shown on landing page -->
            <nav class="nav" id="mainNav">
                <button class="nav-btn active" data-page="landing">üè† Home</button>
                <button class="nav-btn admin-only-nav" data-page="system-settings">‚öôÔ∏è System Settings</button>
            </nav>
            <!-- CAMPOST MANKON Navigation -->
            <nav class="nav module-header" id="campostNav">
                <button class="nav-btn" onclick="goToLanding()">üè† Home</button>
                <button class="nav-btn active" data-page="campost-dashboard">üìä Dashboard</button>
                <button class="nav-btn" data-page="campost-ledger">üìí Ledger</button>
                <button class="nav-btn" data-page="campost-expenses">üí∏ Expenses</button>
                <button class="nav-btn" data-page="campost-bills">üìÑ Bills</button>
                <button class="nav-btn" data-page="campost-payments">üíµ Payments</button>
                <button class="nav-btn" data-page="campost-inheritance">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Inheritance</button>
                <button class="nav-btn" data-page="campost-export">üì• Export</button>
                <button class="nav-btn" data-page="campost-settings">‚öôÔ∏è Settings</button>
            </nav>
            <!-- FAMILY ESTATES Navigation -->
            <nav class="nav module-header" id="familyNav">
                <button class="nav-btn" onclick="goToLanding()">üè† Home</button>
                <button class="nav-btn active" data-page="family-dashboard">üìä Dashboard</button>
                <button class="nav-btn" data-page="family-properties">üè† Properties</button>
                <button class="nav-btn" data-page="family-income">üíµ Rental Income</button>
                <button class="nav-btn" data-page="family-bills">üìÑ Bills</button>
                <button class="nav-btn" data-page="family-payments">üí≥ Payments</button>
                <button class="nav-btn" data-page="family-expenses">üí∏ Expenses</button>
                <button class="nav-btn" data-page="family-inheritance">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Inheritance</button>
                <button class="nav-btn" data-page="family-ledger">üìí Ledger</button>
                <button class="nav-btn" data-page="family-export">üì• Export</button>
                <button class="nav-btn" data-page="family-settings">‚öôÔ∏è Settings</button>
            </nav>
            <!-- RESIDENCE ASSETS Navigation -->
            <nav class="nav module-header" id="assetsNav" style="display: none;">
                <button class="nav-btn" onclick="goToLanding()">üè† Home</button>
                <button class="nav-btn active" data-page="assets-dashboard">üìä Dashboard</button>
                <button class="nav-btn" data-page="assets-oldtown">üèòÔ∏è Old Town</button>
                <button class="nav-btn" data-page="assets-manka">üè° Manka</button>
                <button class="nav-btn" data-page="assets-inheritance">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Inheritance</button>
                <button class="nav-btn" data-page="assets-export">üì• Export</button>
            </nav>
        </header>

        <main class="main-content">
            <!-- ==================== LANDING PAGE ==================== -->
            <div id="landing" class="page active">
                <div class="landing-page">
                    <h1 class="landing-title">üè¢ NJIKAM SALIFU ESTATE</h1>
                    <p class="landing-subtitle">Comprehensive Property & Billing Management System</p>

                    <div class="landing-cards">
                        <!-- CAMPOST MANKON Card -->
                        <div class="landing-card campost" onclick="openModule('campost')">
                            <div class="landing-card-icon">üèõÔ∏è</div>
                            <h2 class="landing-card-title">CAMPOST MANKON</h2>
                            <p class="landing-card-desc">Manage CAMPOST property billing, payments, expenses, and
                                inheritance distribution.</p>
                            <div class="landing-card-stats">
                                <div class="landing-stat">
                                    <div class="landing-stat-value amount-positive" id="landingCampostIncome">0</div>
                                    <div class="landing-stat-label">Total Income</div>
                                </div>
                                <div class="landing-stat">
                                    <div class="landing-stat-value amount-negative" id="landingCampostExpenses">0</div>
                                    <div class="landing-stat-label">Total Expenses</div>
                                </div>
                                <div class="landing-stat">
                                    <div class="landing-stat-value amount-gold" id="landingCampostBalance">0</div>
                                    <div class="landing-stat-label">Balance</div>
                                </div>
                            </div>
                            <div class="btn-group" style="justify-content: center; margin-top: 1rem;">
                                <button class="btn btn-primary btn-lg">Enter CAMPOST MANKON ‚Üí</button>
                            </div>
                        </div>

                        <!-- FAMILY ESTATES Card -->
                        <div class="landing-card family" onclick="openModule('family')">
                            <div class="landing-card-icon">üè†</div>
                            <h2 class="landing-card-title">FAMILY ESTATES</h2>
                            <p class="landing-card-desc">Manage family properties, rental income, bills, payments, and
                                Islamic inheritance.</p>
                            <div class="landing-card-stats">
                                <div class="landing-stat">
                                    <div class="landing-stat-value amount-positive" id="landingFamilyIncome">0</div>
                                    <div class="landing-stat-label">Total Income</div>
                                </div>
                                <div class="landing-stat">
                                    <div class="landing-stat-value amount-negative" id="landingFamilyExpenses">0</div>
                                    <div class="landing-stat-label">Total Expenses</div>
                                </div>
                                <div class="landing-stat">
                                    <div class="landing-stat-value" id="landingFamilyProperties">0</div>
                                    <div class="landing-stat-label">Properties</div>
                                </div>
                            </div>
                            <div class="btn-group" style="justify-content: center; margin-top: 1rem;">
                                <button class="btn btn-success btn-lg">Enter Family Estates ‚Üí</button>
                            </div>
                        </div>

                        <!-- RESIDENCE ASSETS Card -->
                        <div class="landing-card assets" onclick="openModule('assets')">
                            <div class="landing-card-icon">ü™ë</div>
                            <h2 class="landing-card-title">RESIDENCE ASSETS</h2>
                            <p class="landing-card-desc">Inventory of household assets at Old Town & Manka Residences
                                for inheritance distribution.</p>
                            <div class="landing-card-stats">
                                <div class="landing-stat">
                                    <div class="landing-stat-value" id="landingOldTownValue">0</div>
                                    <div class="landing-stat-label">Old Town</div>
                                </div>
                                <div class="landing-stat">
                                    <div class="landing-stat-value" id="landingMankaValue">0</div>
                                    <div class="landing-stat-label">Manka</div>
                                </div>
                                <div class="landing-stat">
                                    <div class="landing-stat-value amount-gold" id="landingTotalAssets">0</div>
                                    <div class="landing-stat-label">Total Value</div>
                                </div>
                            </div>
                            <div class="btn-group" style="justify-content: center; margin-top: 1rem;">
                                <button class="btn btn-warning btn-lg">Enter Residence Assets ‚Üí</button>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="max-width: 1400px; margin: 0 auto;">
                        <div class="card-header gold"><span>üìä Combined Portfolio Overview</span></div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-card green">
                                    <div class="stat-icon">üíµ</div>
                                    <div class="stat-value" id="landingTotalIncome">0</div>
                                    <div class="stat-label">Combined Income</div>
                                </div>
                                <div class="stat-card red">
                                    <div class="stat-icon">üí∏</div>
                                    <div class="stat-value" id="landingTotalExpenses">0</div>
                                    <div class="stat-label">Combined Expenses</div>
                                </div>
                                <div class="stat-card blue">
                                    <div class="stat-icon">üè¶</div>
                                    <div class="stat-value" id="landingTotalBalance">0</div>
                                    <div class="stat-label">Combined Balance</div>
                                </div>
                                <div class="stat-card gold">
                                    <div class="stat-icon">üè†</div>
                                    <div class="stat-value" id="landingTotalProperties">0</div>
                                    <div class="stat-label">Total Properties</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== MAIN SETTINGS PAGE ==================== -->
            <div id="main-settings" class="page">
                <div class="card">
                    <div class="card-header gold"><span>üë§ My Account</span></div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="myUsername" readonly>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="myEmail" readonly>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <input type="text" id="myRole" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><span>üîê Change My Password</span></div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" id="changeCurrentPwd" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" id="changeNewPwd" placeholder="Enter new password">
                            </div>
                            <div class="form-group">
                                <label>Confirm New Password</label>
                                <input type="password" id="changeConfirmPwd" placeholder="Confirm new password">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="changeMyPassword()">üîê Change Password</button>
                        </div>
                    </div>
                </div>

                <!-- Admin Only: User Management -->
                <div id="adminUserManagement" style="display: none;">
                    <div class="card">
                        <div class="card-header green"><span>‚ûï Create New User</span><span
                                class="badge badge-income">ADMIN ONLY</span></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Username *</label>
                                    <input type="text" id="newUserUsername" placeholder="Enter username">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" id="newUserEmail" placeholder="Enter email address">
                                </div>
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" id="newUserFullName" placeholder="Enter full name">
                                </div>
                                <div class="form-group">
                                    <label>Role *</label>
                                    <select id="newUserRole">
                                        <option value="user">User (View Only)</option>
                                        <option value="guest">Guest (Limited Access)</option>
                                        <option value="admin">Admin (Full Access)</option>
                                    </select>
                                </div>
                            </div>
                            <p
                                style="font-size: 0.8rem; color: #718096; margin: 10px 0; background: #ebf8ff; padding: 8px; border-radius: 6px;">
                                üìå Default password for new users is <strong>1234</strong>. User must change it on first
                                login.
                            </p>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="createNewUser()">üë§ Create User</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span>üë• All Users</span><span class="badge badge-income">ADMIN
                                ONLY</span></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Full Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== SYSTEM SETTINGS PAGE ==================== -->
            <div id="system-settings" class="page">
                <h2
                    style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    ‚öôÔ∏è System Settings
                    <span class="badge badge-inheritance">ADMIN ONLY</span>
                </h2>

                <!-- Access Control Notice for Non-Admins -->
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access system settings. Please contact your system administrator.
                </div>

                <div class="admin-only-section">
                    <!-- User Management Section -->
                    <div class="card">
                        <div class="card-header gold">
                            <span>üë• User Management</span>
                            <button class="btn btn-sm" onclick="loadSystemUsers()"
                                style="background: rgba(255,255,255,0.2);">üîÑ Refresh</button>
                        </div>
                        <div class="card-body">
                            <!-- Create New User -->
                            <div style="background: #f7fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <h4 style="color: var(--primary-blue); margin-bottom: 0.75rem;">‚ûï Create New User</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Username *</label>
                                        <input type="text" id="sysNewUsername" placeholder="Enter username">
                                    </div>
                                    <div class="form-group">
                                        <label>Full Name *</label>
                                        <input type="text" id="sysNewFullName" placeholder="Enter full name">
                                    </div>
                                    <div class="form-group">
                                        <label>Email *</label>
                                        <input type="email" id="sysNewEmail" placeholder="Enter email address">
                                    </div>
                                    <div class="form-group">
                                        <label>Role *</label>
                                        <select id="sysNewRole">
                                            <option value="guest">Guest (Limited Access)</option>
                                            <option value="user" selected>User (View Only)</option>
                                            <option value="admin">Admin (Full Access)</option>
                                        </select>
                                    </div>
                                </div>
                                <div
                                    style="background: #ebf8ff; border: 1px solid #4299e1; border-radius: 6px; padding: 0.75rem; margin: 0.75rem 0;">
                                    <strong>üìå Password Policy:</strong>
                                    <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.85rem;">
                                        <li>Default password for new users: <code
                                                style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 3px;">1234</code>
                                        </li>
                                        <li>Users must change password on first login</li>
                                        <li>Minimum password length: 6 characters</li>
                                    </ul>
                                </div>
                                <button class="btn btn-success" onclick="createSystemUser()">üë§ Create User</button>
                            </div>

                            <!-- Users Table -->
                            <h4 style="color: var(--primary-blue); margin-bottom: 0.75rem;">üìã All Users</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Username</th>
                                            <th>Full Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Password</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="systemUsersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Role Permissions Info -->
                    <div class="card">
                        <div class="card-header"><span>üîê Role Permissions</span></div>
                        <div class="card-body">
                            <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                                <!-- Admin -->
                                <div
                                    style="background: linear-gradient(135deg, rgba(214,158,46,0.1), rgba(237,137,54,0.1)); border: 2px solid var(--accent-gold); border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: var(--accent-gold); margin-bottom: 0.5rem;">üëë ADMIN</h4>
                                    <p style="font-size: 0.8rem; color: #744210; margin-bottom: 0.5rem;"><strong>Full
                                            System Access</strong></p>
                                    <ul style="font-size: 0.75rem; margin-left: 1rem; color: #744210;">
                                        <li>‚úÖ Create, edit, delete all data</li>
                                        <li>‚úÖ Manage users & roles</li>
                                        <li>‚úÖ Access all modules</li>
                                        <li>‚úÖ Export & settings</li>
                                        <li>‚úÖ Inheritance management</li>
                                    </ul>
                                </div>
                                <!-- User -->
                                <div
                                    style="background: linear-gradient(135deg, rgba(66,153,225,0.1), rgba(49,130,206,0.1)); border: 2px solid var(--primary-blue); border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: var(--primary-blue); margin-bottom: 0.5rem;">üë§ USER</h4>
                                    <p style="font-size: 0.8rem; color: #2c5282; margin-bottom: 0.5rem;"><strong>View
                                            Only Access</strong></p>
                                    <ul style="font-size: 0.75rem; margin-left: 1rem; color: #2c5282;">
                                        <li>‚úÖ View all data</li>
                                        <li>‚úÖ View dashboards</li>
                                        <li>‚úÖ View reports</li>
                                        <li>‚ùå Cannot edit data</li>
                                        <li>‚ùå Cannot manage users</li>
                                    </ul>
                                </div>
                                <!-- Guest -->
                                <div
                                    style="background: linear-gradient(135deg, rgba(160,174,192,0.1), rgba(113,128,150,0.1)); border: 2px solid #a0aec0; border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: #718096; margin-bottom: 0.5rem;">üëÅÔ∏è GUEST</h4>
                                    <p style="font-size: 0.8rem; color: #4a5568; margin-bottom: 0.5rem;"><strong>Limited
                                            Access</strong></p>
                                    <ul style="font-size: 0.75rem; margin-left: 1rem; color: #4a5568;">
                                        <li>‚úÖ View dashboards only</li>
                                        <li>‚úÖ View properties</li>
                                        <li>‚ùå Cannot view finances</li>
                                        <li>‚ùå Cannot edit data</li>
                                        <li>‚ùå Cannot access settings</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My Profile Section -->
                    <div class="card">
                        <div class="card-header green"><span>üë§ My Profile</span></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" id="myProfileUsername" readonly style="background: #f7fafc;">
                                </div>
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" id="myProfileFullName" readonly style="background: #f7fafc;">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="text" id="myProfileEmail" readonly style="background: #f7fafc;">
                                </div>
                                <div class="form-group">
                                    <label>Role</label>
                                    <input type="text" id="myProfileRole" readonly style="background: #f7fafc;">
                                </div>
                            </div>

                            <h4 style="color: var(--primary-blue); margin: 1rem 0 0.75rem;">üîë Change My Password</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Current Password</label>
                                    <input type="password" id="myCurrentPassword" placeholder="Enter current password">
                                </div>
                                <div class="form-group">
                                    <label>New Password</label>
                                    <input type="password" id="myNewPassword"
                                        placeholder="Enter new password (min 6 chars)">
                                </div>
                                <div class="form-group">
                                    <label>Confirm New Password</label>
                                    <input type="password" id="myConfirmPassword" placeholder="Confirm new password">
                                </div>
                            </div>
                            <button class="btn btn-warning" onclick="changeMyPassword()">üîê Change Password</button>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="card">
                        <div class="card-header red"><span>üõ°Ô∏è Security Actions</span></div>
                        <div class="card-body">
                            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                                <div
                                    style="background: #fff5f5; border: 1px solid #fc8181; border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: #c53030; margin-bottom: 0.5rem;">üîÑ Force Password Reset</h4>
                                    <p style="font-size: 0.8rem; color: #742a2a; margin-bottom: 0.75rem;">
                                        Reset all non-admin users' passwords to default and force them to change on next
                                        login.
                                    </p>
                                    <button class="btn btn-danger btn-sm" onclick="forceAllPasswordReset()">Reset All
                                        Passwords</button>
                                </div>
                                <div
                                    style="background: #fffff0; border: 1px solid #ecc94b; border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: #744210; margin-bottom: 0.5rem;">üìã Export User List</h4>
                                    <p style="font-size: 0.8rem; color: #744210; margin-bottom: 0.75rem;">
                                        Download a CSV file of all users (passwords excluded for security).
                                    </p>
                                    <button class="btn btn-warning btn-sm" onclick="exportUserList()">Export Users
                                        CSV</button>
                                </div>
                                <div
                                    style="background: #f0fff4; border: 1px solid #68d391; border-radius: 8px; padding: 1rem;">
                                    <h4 style="color: #276749; margin-bottom: 0.5rem;">üìä Login Statistics</h4>
                                    <p style="font-size: 0.8rem; color: #276749; margin-bottom: 0.75rem;">
                                        Total Users: <strong id="statTotalUsers">0</strong> |
                                        Active: <strong id="statActiveUsers">0</strong> |
                                        Admins: <strong id="statAdminUsers">0</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== CAMPOST MANKON MODULE ==================== -->

            <!-- CAMPOST DASHBOARD -->
            <div id="campost-dashboard" class="page">
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" id="dashIncome">0</div>
                        <div class="stat-label">Total Income</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üí∏</div>
                        <div class="stat-value" id="dashExp">0</div>
                        <div class="stat-label">Total Expenses</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üè¶</div>
                        <div class="stat-value" id="dashReserve">0</div>
                        <div class="stat-label">Reserved Funds</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="dashNetBalance">0</div>
                        <div class="stat-label">Net Balance</div>
                    </div>
                    <div class="stat-card gold">
                        <div class="stat-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <div class="stat-value" id="dashInh">0</div>
                        <div class="stat-label">Inheritance Amount</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>üìä Financial Summary</span></div>
                    <div class="card-body">
                        <div class="summary-row"><span>Total Income (Bills Paid):</span><span class="amount-positive"
                                id="dashIncomeSum">0 XAF</span></div>
                        <div class="summary-row"><span>Total Expenses:</span><span class="amount-negative"
                                id="dashExpSum">0 XAF</span></div>
                        <div class="summary-row"><span>Reserved Funds (<span id="dashReservePercent">10</span>% of
                                Income):</span><span class="amount-negative" id="dashReserveSum">0 XAF</span></div>
                        <div class="summary-row"
                            style="font-size: 1rem; background: #fed7d7; padding: 8px; border-radius: 6px;">
                            <span><strong>üìä Net Balance (Income - Expenses - Reserved):</strong></span><span
                                id="dashNetBalanceSum" style="font-weight: bold; color: #c53030;">0 XAF</span>
                        </div>
                        <div class="summary-row"><span>Inheritance Amount (from distributions):</span><span
                                class="amount-gold" id="dashInhSum">0 XAF</span></div>
                    </div>
                </div>
            </div>

            <!-- LEDGER -->
            <div id="campost-ledger" class="page">
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" id="ledgerIncome">0</div>
                        <div class="stat-label">Total Income (from Bills)</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üí∏</div>
                        <div class="stat-value" id="ledgerExpense">0</div>
                        <div class="stat-label">Total Expenses</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üè¶</div>
                        <div class="stat-value" id="ledgerReserved">0</div>
                        <div class="stat-label">Reserved Funds</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="ledgerNetBalance">0</div>
                        <div class="stat-label">Net Balance</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span>üìí Ledger - Income & Expenses (Auto-Generated)</span>
                        <div class="no-print">
                            <button class="btn btn-print btn-sm" onclick="exportPDF('ledger')">üì• Export PDF</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('ledger')">üì• Export CSV</button>
                            <button class="btn btn-print btn-sm" onclick="printPage('ledger')">üñ®Ô∏è Print</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                            üìå <strong>Income</strong> = Bills with status Paid or Partial | <strong>Expenses</strong> =
                            All recorded expenses | <strong>Net Balance</strong> = Income - Expenses - Reserved Funds
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Type</th>
                                        <th style="background: #c6f6d5; color: #276749;">Income (Credit)</th>
                                        <th style="background: #fed7d7; color: #c53030;">Expense (Debit)</th>
                                        <th>Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="ledgerTable"></tbody>
                                <tfoot id="ledgerTotals"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXPENSES -->
            <div id="campost-expenses" class="page">
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access Expenses. Please contact an admin if you need to add or modify
                    expenses.
                </div>
                <div class="admin-only-section">
                    <div class="card no-print">
                        <div class="card-header green"><span>‚ûï Add/Edit Expense</span></div>
                        <div class="card-body">
                            <div id="campostExpenseWarning"
                                style="display: none; background: #fed7d7; border: 1px solid #fc8181; color: #c53030; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                                <strong>‚ö†Ô∏è Expenses Disabled:</strong> Net Balance is zero. You cannot add more expenses
                                until more income is received.
                                <br><small>Net Balance = Total Income - Total Expenses - Reserved Funds</small>
                            </div>
                            <input type="hidden" id="expId">
                            <div class="form-grid">
                                <div class="form-group"><label>Date</label><input type="date" id="expDate"></div>
                                <div class="form-group"><label>Description</label><input type="text" id="expDesc"
                                        placeholder="Description"></div>
                                <div class="form-group"><label>Category</label><select id="expCat"></select></div>
                                <div class="form-group"><label>Amount</label><input type="number" id="expAmt"
                                        placeholder="Amount"></div>
                            </div>
                            <div class="btn-group"><button class="btn btn-success" id="campostSaveExpenseBtn"
                                    onclick="saveExpense()">üíæ Save</button><button class="btn btn-outline"
                                    onclick="clearExpenseForm()">üîÑ Clear</button></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>üí∏ Expenses</span><button class="btn btn-print btn-sm no-print"
                                onclick="printPage('expenses')">üñ®Ô∏è Print</button></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th>Amount</th>
                                            <th class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expTable"></tbody>
                                    <tfoot id="expTotals"></tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BILLS -->
            <div id="campost-bills" class="page">
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access Bills. Please contact an admin if you need to create or modify bills.
                </div>
                <div class="admin-only-section">
                    <div class="card no-print">
                        <div class="card-header green"><span>‚ûï Add/Edit Bill</span></div>
                        <div class="card-body">
                            <input type="hidden" id="billEditMode"><input type="hidden" id="billOldNumber">
                            <div class="form-grid">
                                <div class="form-group"><label>Quarter</label><select id="billQ">
                                        <option value="Q1">Q1</option>
                                        <option value="Q2">Q2</option>
                                        <option value="Q3">Q3</option>
                                        <option value="Q4">Q4</option>
                                    </select></div>
                                <div class="form-group"><label>Year</label><select id="billY"></select></div>
                                <div class="form-group"><label>Period</label><select id="billP">
                                        <option value="January to March">January to March</option>
                                        <option value="April to June">April to June</option>
                                        <option value="July to September">July to September</option>
                                        <option value="October to December">October to December</option>
                                    </select></div>
                                <div class="form-group"><label>Bill Number</label><input type="text" id="billNum"
                                        readonly></div>
                            </div>
                            <div
                                style="background: #ebf8ff; padding: 12px; border-radius: 8px; margin: 10px 0; border: 1px solid #90cdf4;">
                                <div
                                    style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; font-size: 0.85rem;">
                                    <div><span style="color: #4a5568;">Monthly Rate:</span> <strong
                                            id="billShowRate">200,000</strong> XAF</div>
                                    <div><span style="color: #4a5568;">Gross (3 mo):</span> <strong
                                            id="billShowGross">600,000</strong> XAF</div>
                                    <div><span style="color: #4a5568;">Tax (<span
                                                id="billShowTaxPct">15</span>%):</span> <strong id="billShowTax"
                                            style="color: #e53e3e;">-90,000</strong> XAF</div>
                                    <div><span style="color: #4a5568;">Net Due:</span> <strong id="billShowNet"
                                            style="color: #38a169;">510,000</strong> XAF</div>
                                </div>
                                <p style="margin-top: 8px; font-size: 0.7rem; color: #718096;">üí° To change monthly rate
                                    or tax rate, go to <strong>Settings</strong> tab</p>
                            </div>
                            <div class="btn-group"><button class="btn btn-success" onclick="saveBill()">üíæ Save
                                    Bill</button><button class="btn btn-outline" onclick="clearBillForm()">üîÑ
                                    Clear</button></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>üìÑ All Bills (Click to View Invoice)</span><button
                                class="btn btn-print btn-sm no-print" onclick="printPage('bills')">üñ®Ô∏è Print
                                List</button></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Bill #</th>
                                            <th>Period</th>
                                            <th>Due</th>
                                            <th>Paid</th>
                                            <th>Outstanding</th>
                                            <th>Status</th>
                                            <th class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAYMENTS -->
            <div id="campost-payments" class="page">
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access Payments. Please contact an admin if you need to record payments.
                </div>
                <div class="admin-only-section">
                    <div class="card no-print">
                        <div class="card-header green"><span>‚ûï Add/Edit Payment</span></div>
                        <div class="card-body">
                            <input type="hidden" id="payId">
                            <div class="form-grid">
                                <div class="form-group"><label>Select Bill</label><select id="payBill"></select></div>
                                <div class="form-group"><label>Outstanding</label><input type="text" id="payOut"
                                        readonly></div>
                                <div class="form-group"><label>Amount (XAF)</label><input type="number" id="payAmt">
                                </div>
                                <div class="form-group"><label>Date</label><input type="date" id="payDate"></div>
                                <div class="form-group"><label>Reference</label><input type="text" id="payRef"
                                        placeholder="Receipt #"></div>
                            </div>
                            <div class="btn-group"><button class="btn btn-success" onclick="savePayment()">üíæ
                                    Save</button><button class="btn btn-outline" onclick="clearPaymentForm()">üîÑ
                                    Clear</button></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>üíµ Payments</span><button class="btn btn-print btn-sm no-print"
                                onclick="printPage('payments')">üñ®Ô∏è Print</button></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Bill #</th>
                                            <th>Period</th>
                                            <th>Amount</th>
                                            <th>Reference</th>
                                            <th class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="payTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INHERITANCE -->
            <div id="campost-inheritance" class="page">
                <div class="highlight-box">
                    <p>Amount to Distribute (from Inheritance Share expenses)</p>
                    <h3 id="inhAmt">0 XAF</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" id="inhPaid">0</div>
                        <div class="stat-label">Bills Paid</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üí∏</div>
                        <div class="stat-value" id="inhExp">0</div>
                        <div class="stat-label">Expenses</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-icon">üè¶</div>
                        <div class="stat-value" id="inhRes">0</div>
                        <div class="stat-label">Reserve</div>
                    </div>
                    <div class="stat-card gold">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="inhPer">0</div>
                        <div class="stat-label">Per Portion</div>
                    </div>
                </div>

                <!-- Beneficiary Selection Card -->
                <div class="card admin-only-section no-print">
                    <div class="card-header blue"><span>‚úÖ Select Beneficiaries</span>
                        <div>
                            <button class="btn btn-outline btn-sm" onclick="selectAllCampostBeneficiaries(true)">Select
                                All</button>
                            <button class="btn btn-outline btn-sm"
                                onclick="selectAllCampostBeneficiaries(false)">Deselect All</button>
                            <button class="btn btn-warning btn-sm" onclick="resetCampostHeirsToDefaults()">üîÑ Reset to
                                Defaults</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                            ‚úÖ Check the heirs who should receive inheritance. Only selected heirs will be included in
                            the distribution.
                        </p>
                        <div id="campostBeneficiaryList"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">
                        </div>
                        <div class="btn-group" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="saveCampostBeneficiaries()">üíæ Save Selection &
                                Recalculate</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header gold"><span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Heirs (<span id="inhPortions">24</span>
                            portions)</span>
                        <div class="no-print"><button class="btn btn-outline btn-sm admin-only"
                                onclick="openHeirModal()">‚ûï Add</button><button class="btn btn-gold btn-sm"
                                onclick="printAllHeirCertificates()">üñ®Ô∏è Print All Certificates</button></div>
                    </div>
                    <div class="card-body" id="heirGroups"></div>
                </div>
                <div class="card">
                    <div class="card-header"><span>üìã Heir Shares (Beneficiaries Only)</span><button
                            class="btn btn-print btn-sm no-print" onclick="printPage('inheritance')">üñ®Ô∏è Print
                            Summary</button></div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Relationship</th>
                                        <th>Group</th>
                                        <th>Portions</th>
                                        <th>Share (XAF)</th>
                                        <th class="no-print admin-only">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="heirTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXPORT -->
            <div id="campost-export" class="page">
                <div class="card">
                    <div class="card-header"><span>üì• Export All Data</span></div>
                    <div class="card-body">
                        <p style="margin-bottom:1rem;font-size:0.85rem;">Export with CAMPOST MANKON header.</p>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="exportAllCSV()">üìÑ All CSV</button>
                            <button class="btn btn-print" onclick="exportAllPDF()">üìë All PDF</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>üìä Individual Exports</span></div>
                    <div class="card-body">
                        <div class="btn-group">
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('bills')">Bills CSV</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('payments')">Payments CSV</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('expenses')">Expenses CSV</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('ledger')">Ledger CSV</button>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-print btn-sm" onclick="exportPDF('bills')">Bills PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportPDF('payments')">Payments PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportPDF('expenses')">Expenses PDF</button>
                            <button class="btn btn-primary btn-sm" onclick="exportPDF('ledger')">Ledger PDF</button>
                            <button class="btn btn-gold btn-sm" onclick="exportPDF('heirs')">Heirs PDF</button>
                            <button class="btn btn-success btn-sm" onclick="exportREPropertiesPDF()">Properties
                                PDF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== FAMILY ESTATES MODULE ==================== -->

            <!-- FAMILY DASHBOARD -->
            <div id="family-dashboard" class="page">
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-icon">üè†</div>
                        <div class="stat-value" id="reTotalProps">0</div>
                        <div class="stat-label">Total Properties</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-icon">üîë</div>
                        <div class="stat-value" id="reRented">0</div>
                        <div class="stat-label">Rented Properties</div>
                    </div>
                    <div class="stat-card gold">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="reTotalIncome">0</div>
                        <div class="stat-label">Total Income</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üí∏</div>
                        <div class="stat-value" id="reTotalExpenses">0</div>
                        <div class="stat-label">Total Expenses</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üè¶</div>
                        <div class="stat-value" id="reReservedFunds">0</div>
                        <div class="stat-label">Reserved Funds</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="reNetBalance">0</div>
                        <div class="stat-label">Net Balance</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header gold"><span>üìä Family Estate Summary</span></div>
                    <div class="card-body">
                        <div class="summary-row"><span>Total Properties:</span><span id="familySummaryProps">0</span>
                        </div>
                        <div class="summary-row"><span>Rented Properties:</span><span class="amount-positive"
                                id="familySummaryRented">0</span></div>
                        <div class="summary-row"><span>Total Income (Net after Tax):</span><span class="amount-positive"
                                id="familySummaryIncome">0 XAF</span></div>
                        <div class="summary-row"><span>Total Expenses:</span><span class="amount-negative"
                                id="familySummaryExpenses">0 XAF</span></div>
                        <div class="summary-row"><span>Reserved Funds:</span><span class="amount-negative"
                                id="familySummaryReserved">0 XAF</span></div>
                        <div class="summary-row" style="font-size: 1rem;"><span><strong>Net
                                    Balance:</strong></span><span id="familySummaryBalance" style="font-weight: bold;">0
                                XAF</span></div>
                    </div>
                </div>
            </div>

            <!-- FAMILY PROPERTIES -->
            <div id="family-properties" class="page">
                <div class="card">
                    <div class="card-header">
                        <span>üè† Family Properties Portfolio</span>
                        <div class="no-print">
                            <button class="btn btn-success btn-sm admin-only" onclick="openPropertyModal()">‚ûï Add
                                Property</button>
                            <button class="btn btn-print btn-sm" onclick="exportREPropertiesPDF()">üì• Export
                                PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="user-restricted-notice" style="margin-bottom: 10px;">
                            <strong>üîí View Only Mode</strong><br>
                            Only administrators can add, edit, or delete properties.
                        </div>
                        <div style="margin-bottom: 10px;">
                            <select id="reStatusFilter" onchange="filterProperties()"
                                style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="">All Status</option>
                                <option value="Rented">Rented</option>
                                <option value="Sold">Sold</option>
                                <option value="For sale">For Sale</option>
                                <option value="Not to be sold">Not to be Sold</option>
                                <option value="Shared">Shared</option>
                                <option value="Admin issues">Admin Issues</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Property Name</th>
                                        <th>Location</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Rent Amount</th>
                                        <th>Period</th>
                                        <th>Tax Rate</th>
                                        <th>Net Income</th>
                                        <th>Islamic Inh.</th>
                                        <th class="no-print admin-only">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="propertiesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RENTAL INCOME TAB ========== -->
            <div id="family-income" class="page">
                <div class="card">
                    <div class="card-header gold">
                        <span>üíµ Rental Income Summary</span>
                        <button class="btn btn-print btn-sm no-print" onclick="exportRERentalIncomePDF()">üì• Export
                            PDF</button>
                    </div>
                    <div class="card-body">
                        <p
                            style="font-size: 0.85rem; color: #718096; margin-bottom: 15px; background: #fffbeb; padding: 10px; border-radius: 6px;">
                            üìå <strong>Note:</strong> Only properties with status <strong>"Rented"</strong> have income.
                            All other properties show Rent Amount, Period, Tax Rate, Gross Income, Tax Amount, and Net
                            Income as <strong>0</strong>.
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Rent Amount</th>
                                        <th>Period</th>
                                        <th>Tax Rate</th>
                                        <th>Gross Income</th>
                                        <th>Tax Amount</th>
                                        <th>Net Income</th>
                                    </tr>
                                </thead>
                                <tbody id="rentalIncomeTable"></tbody>
                                <tfoot id="rentalIncomeTotals"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE BILLS TAB ========== -->
            <div id="family-bills" class="page">
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access Bills. Please contact an admin if you need to create or modify bills.
                </div>
                <div class="admin-only-section">
                    <div class="card no-print">
                        <div class="card-header green"><span>‚ûï Create Property Bill</span></div>
                        <div class="card-body">
                            <input type="hidden" id="reBillId">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Property *</label>
                                    <select id="reBillProperty" onchange="onREPropertySelect()"></select>
                                </div>
                                <div class="form-group">
                                    <label>Bill Date *</label>
                                    <input type="date" id="reBillDate">
                                </div>
                                <div class="form-group">
                                    <label>Period</label>
                                    <input type="text" id="reBillPeriod" readonly style="background: #e2e8f0;">
                                </div>
                                <div class="form-group">
                                    <label>Amount</label>
                                    <input type="number" id="reBillGrossAmount" readonly
                                        style="background: #e2e8f0; font-weight: bold;">
                                </div>
                                <div class="form-group">
                                    <label>Tax</label>
                                    <input type="text" id="reBillTaxRate" readonly style="background: #e2e8f0;"
                                        value="0%">
                                </div>
                                <input type="hidden" id="reBillTaxAmount" value="0">
                                <div class="form-group">
                                    <label>Net Amount Due</label>
                                    <input type="text" id="reBillAmount" readonly
                                        style="background: #c6f6d5; font-weight: bold; color: #276749;" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" id="reBillDesc" placeholder="Bill description (optional)">
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="saveREBill()">üíæ Save Bill</button>
                                <button class="btn btn-outline" onclick="clearREBillForm()">üîÑ Clear</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>üìÑ Property Bills (Net After Tax)</span><button
                                class="btn btn-print btn-sm no-print" onclick="exportREBillsPDF()">üì• Export
                                PDF</button></div>
                        <div class="card-body">
                            <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                                üìå All amounts shown are <strong>NET</strong> after tax deductions. Tax is calculated
                                based on property tax rate.
                            </p>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Bill #</th>
                                            <th>Property</th>
                                            <th>Period</th>
                                            <th>Date</th>
                                            <th>Gross</th>
                                            <th>Tax</th>
                                            <th>Net Due</th>
                                            <th>Description</th>
                                            <th class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reBillsTable"></tbody>
                                    <tfoot id="reBillsTotals"></tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE PAYMENTS TAB ========== -->
            <div id="family-payments" class="page">
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access Payments. Please contact an admin if you need to record payments.
                </div>
                <div class="admin-only-section">
                    <div class="card no-print">
                        <div class="card-header green"><span>‚ûï Record Payment</span></div>
                        <div class="card-body">
                            <input type="hidden" id="rePayId">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Select Bill *</label>
                                    <select id="rePayBill" onchange="onREBillSelect()"></select>
                                </div>
                                <div class="form-group">
                                    <label>Payment Date *</label>
                                    <input type="date" id="rePayDate">
                                </div>
                                <div class="form-group">
                                    <label>Amount</label>
                                    <input type="number" id="rePayAmount" readonly
                                        style="background: #e2e8f0; font-weight: bold;">
                                </div>
                                <div class="form-group">
                                    <label>Amount Paid *</label>
                                    <input type="number" id="rePayAmountPaid" placeholder="Enter amount to pay">
                                </div>
                                <div class="form-group">
                                    <label>Reference</label>
                                    <input type="text" id="rePayRef" readonly style="background: #e2e8f0;">
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="saveREPayment()">üíæ Save Payment</button>
                                <button class="btn btn-outline" onclick="clearREPaymentForm()">üîÑ Clear</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>üí≥ Payment History</span><button
                                class="btn btn-print btn-sm no-print" onclick="exportREPaymentsPDF()">üì• Export
                                PDF</button></div>
                        <div class="card-body">
                            <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                                üìå Payment amounts match the <strong>Net Amount Due</strong> from Bills (tax already
                                deducted in Bills).
                            </p>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Property</th>
                                            <th>Bill #</th>
                                            <th>Amount</th>
                                            <th>Amount Paid</th>
                                            <th>Amount Due</th>
                                            <th>Status</th>
                                            <th>Reference</th>
                                            <th class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rePaymentsTable"></tbody>
                                    <tfoot id="rePaymentsTotals"></tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE EXPENSES TAB ========== -->
            <div id="family-expenses" class="page">
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access Expenses. Please contact an admin if you need to add or modify
                    expenses.
                </div>
                <div class="admin-only-section">

                    <!-- Available Funds Card -->
                    <div class="card">
                        <div class="card-header blue"><span>üí∞ Available Funds</span></div>
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                                üìå Available funds are automatically calculated as: <strong>Total Income - Total
                                    Expenses - Reserved Funds</strong>.
                                Reserved Funds percentage can be set in the Settings section.
                            </p>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div
                                    style="padding: 15px; background: #e6fffa; border-radius: 8px; border: 2px solid #38b2ac;">
                                    <div style="font-size: 12px; color: #234e52; font-weight: bold;">TOTAL INCOME</div>
                                    <div id="expTotalIncome"
                                        style="font-size: 20px; font-weight: bold; color: #38a169;">0 XAF</div>
                                </div>
                                <div
                                    style="padding: 15px; background: #fed7d7; border-radius: 8px; border: 2px solid #fc8181;">
                                    <div style="font-size: 12px; color: #742a2a; font-weight: bold;">TOTAL EXPENSES
                                    </div>
                                    <div id="expTotalExpenses"
                                        style="font-size: 20px; font-weight: bold; color: #c53030;">0 XAF</div>
                                </div>
                                <div
                                    style="padding: 15px; background: #fef3c7; border-radius: 8px; border: 2px solid #d69e2e;">
                                    <div style="font-size: 12px; color: #744210; font-weight: bold;">RESERVED FUNDS
                                        (<span id="expReservedPercent">10</span>%)</div>
                                    <div id="expReservedFunds"
                                        style="font-size: 20px; font-weight: bold; color: #d69e2e;">0 XAF</div>
                                </div>
                                <div
                                    style="padding: 15px; background: #ebf8ff; border-radius: 8px; border: 2px solid #3182ce;">
                                    <div style="font-size: 12px; color: #2c5282; font-weight: bold;">AVAILABLE FUNDS
                                    </div>
                                    <div id="expAvailableFunds"
                                        style="font-size: 20px; font-weight: bold; color: #2b6cb0;">0 XAF</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card no-print">
                        <div class="card-header green"><span>‚ûï Add Property Expense</span></div>
                        <div class="card-body">
                            <div id="expenseWarning"
                                style="display: none; background: #fed7d7; border: 1px solid #fc8181; color: #c53030; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                                <strong>‚ö†Ô∏è Expenses Disabled:</strong> Net Balance is zero. You cannot add more expenses
                                until more income is received.
                                <br><small>Net Balance = Total Income - Total Expenses - Reserved Funds</small>
                            </div>
                            <input type="hidden" id="reExpId">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Property (Optional)</label>
                                    <select id="reExpProperty"></select>
                                </div>
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" id="reExpDate">
                                </div>
                                <div class="form-group">
                                    <label>Category *</label>
                                    <select id="reExpCategory">
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Repairs">Repairs</option>
                                        <option value="Taxes">Taxes</option>
                                        <option value="Utilities">Utilities</option>
                                        <option value="Insurance">Insurance</option>
                                        <option value="Legal">Legal Fees</option>
                                        <option value="Agent Fees">Agent Fees</option>
                                        <option value="Inheritance Allocation">Inheritance Allocation</option>
                                        <option value="Others">Others</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Amount *</label>
                                    <input type="number" id="reExpAmount" placeholder="Amount" min="0">
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label>Description *</label>
                                    <input type="text" id="reExpDesc" placeholder="Expense description">
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="saveREExpense()">üíæ Save Expense</button>
                                <button class="btn btn-outline" onclick="clearREExpenseForm()">üîÑ Clear</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>üí∏ Property Expenses</span><button
                                class="btn btn-print btn-sm no-print" onclick="exportREExpensesPDF()">üì• Export
                                PDF</button></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Property</th>
                                            <th>Category</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reExpensesTable"></tbody>
                                    <tfoot id="reExpensesTotal"></tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE INHERITANCE TAB ========== -->
            <div id="family-inheritance" class="page">
                <div class="stats-grid">
                    <div class="stat-card gold">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="reInhPool">0</div>
                        <div class="stat-label">Inheritance Amount</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-value" id="reInhHeirs">0</div>
                        <div class="stat-label">Beneficiaries</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="reInhPortions">0</div>
                        <div class="stat-label">Total Portions</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" id="reInhPerPortion">0</div>
                        <div class="stat-label">Per Portion</div>
                    </div>
                </div>

                <!-- Beneficiary Selection Card -->
                <div class="card admin-only-section no-print">
                    <div class="card-header blue"><span>‚úÖ Select Beneficiaries</span>
                        <div>
                            <button class="btn btn-outline btn-sm" onclick="selectAllREBeneficiaries(true)">Select
                                All</button>
                            <button class="btn btn-outline btn-sm" onclick="selectAllREBeneficiaries(false)">Deselect
                                All</button>
                            <button class="btn btn-warning btn-sm" onclick="resetREHeirsToDefaults()">üîÑ Reset to
                                Defaults</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                            ‚úÖ Check the heirs who should receive inheritance from Family Estates. Only selected heirs
                            will be included in the distribution.
                        </p>
                        <div id="reBeneficiaryList"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">
                        </div>
                        <div class="btn-group" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="saveREBeneficiaries()">üíæ Save Selection &
                                Recalculate</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header gold">
                        <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Real Estate Inheritance Distribution</span>
                        <div class="no-print">
                            <button class="btn btn-success btn-sm admin-only" onclick="openREHeirModal()">‚ûï Add
                                Heir</button>
                            <button class="btn btn-gold btn-sm" onclick="printAllREHeirCertificates()">üñ®Ô∏è Print All
                                Certificates</button>
                            <button class="btn btn-print btn-sm" onclick="exportREHeirsPDF()">üì• Export PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                            üìå Inheritance amount is the total of all <strong>Inheritance Allocation</strong> expenses
                            recorded in the Expenses section.
                            <br>Only <strong>selected beneficiaries</strong> are included in the distribution below.
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Relationship</th>
                                        <th>Gender</th>
                                        <th>Portions</th>
                                        <th>Share Amount</th>
                                        <th class="no-print">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reHeirsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE LEDGER TAB ========== -->
            <div id="family-ledger" class="page">
                <div class="card">
                    <div class="card-header">
                        <span>üìí Estate Ledger</span>
                        <div class="no-print">
                            <button class="btn btn-print btn-sm" onclick="exportRELedgerPDF()">üì• Export PDF</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('reLedger')">üì• Export
                                CSV</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                            üìå <strong>Income</strong> = Payments from bills (Paid/Partial) | <strong>Expenses</strong>
                            = All property expenses
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Property</th>
                                        <th>Description</th>
                                        <th>Type</th>
                                        <th style="background: #c6f6d5;">Income</th>
                                        <th style="background: #fed7d7;">Expense</th>
                                        <th>Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="reLedgerTable"></tbody>
                                <tfoot id="reLedgerTotals"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE EXPORT TAB ========== -->
            <div id="family-export" class="page">
                <div class="card">
                    <div class="card-header"><span>üì• Export Estate Data</span></div>
                    <div class="card-body">
                        <p style="margin-bottom: 15px; color: #718096;">Export all Estate data with headers.</p>
                        <div class="btn-group" style="flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="exportAllRECSV()">üìÑ All Data CSV</button>
                            <button class="btn btn-print" onclick="exportAllREPDF()">üìë All Data PDF</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>üìä Individual PDF Exports</span></div>
                    <div class="card-body">
                        <div class="btn-group" style="flex-wrap: wrap;">
                            <button class="btn btn-print btn-sm" onclick="exportREPropertiesPDF()">üè† Properties
                                PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportRERentalIncomePDF()">üíµ Rental Income
                                PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportREBillsPDF()">üìÑ Bills PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportREPaymentsPDF()">üí≥ Payments
                                PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportREExpensesPDF()">üí∏ Expenses
                                PDF</button>
                            <button class="btn btn-primary btn-sm" onclick="exportRELedgerPDF()">üìí Ledger PDF</button>
                            <button class="btn btn-gold btn-sm" onclick="exportREHeirsPDF()">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Inheritance
                                PDF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE SETTINGS TAB ========== -->
            <div id="family-settings" class="page">
                <div class="user-restricted-notice">
                    <strong>üîí Access Restricted</strong><br>
                    Only administrators can access Settings. Please contact an admin if you need to modify system
                    settings.
                </div>
                <div class="admin-only-section">
                    <div class="card">
                        <div class="card-header gold"><span>‚öôÔ∏è Global Default Settings</span></div>
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                                These defaults will be applied to new properties. Changes here will update all existing
                                properties.
                            </p>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Default Tax Rate (%)</label>
                                    <select id="reSettingTaxRate" onchange="previewGlobalSettings()">
                                        <option value="0">0%</option>
                                        <option value="5">5%</option>
                                        <option value="10">10%</option>
                                        <option value="15" selected>15%</option>
                                        <option value="20">20%</option>
                                        <option value="25">25%</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Default Rental Period</label>
                                    <select id="reSettingPeriod" onchange="previewGlobalSettings()">
                                        <option value="Monthly">Monthly</option>
                                        <option value="Quarterly">Quarterly</option>
                                        <option value="Yearly">Yearly</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Currency</label>
                                    <select id="reSettingCurrency">
                                        <option value="XAF">XAF (CFA Franc)</option>
                                        <option value="USD">USD (US Dollar)</option>
                                        <option value="EUR">EUR (Euro)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Reserved Funds (% of Income)</label>
                                    <select id="reSettingReservedPercent">
                                        <option value="0">0% - No Reserve</option>
                                        <option value="5">5%</option>
                                        <option value="10" selected>10%</option>
                                        <option value="15">15%</option>
                                        <option value="20">20%</option>
                                        <option value="25">25%</option>
                                        <option value="30">30%</option>
                                    </select>
                                </div>
                            </div>
                            <div style="background: #f0f4f8; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                <p style="font-size: 0.85rem; color: #4a5568; margin: 0;">
                                    üè¶ <strong>Reserved Funds:</strong> A percentage of total income set aside for
                                    maintenance, emergencies, or future investments.
                                    <br>üìä <strong>Net Balance</strong> = Total Income - Total Expenses - Reserved Funds
                                </p>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="saveGlobalRESettings()">üíæ Save & Apply to All
                                    Properties</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span>üè† Property-Specific Settings</span></div>
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                                Override global settings for individual properties.
                            </p>
                            <div class="form-grid">
                                <div class="form-group" style="grid-column: span 2;">
                                    <label>Select Property</label>
                                    <select id="reSettingProperty" onchange="loadPropertySettings()">
                                        <option value="">-- Select a Property --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Tax Rate (%)</label>
                                    <select id="reSettingPropTaxRate">
                                        <option value="0">0%</option>
                                        <option value="5">5%</option>
                                        <option value="10">10%</option>
                                        <option value="15">15%</option>
                                        <option value="20">20%</option>
                                        <option value="25">25%</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Rental Period</label>
                                    <select id="reSettingPropPeriod">
                                        <option value="Monthly">Monthly</option>
                                        <option value="Quarterly">Quarterly</option>
                                        <option value="Yearly">Yearly</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Rent Amount</label>
                                    <input type="number" id="reSettingPropRent" placeholder="Rent amount">
                                </div>
                                <div class="form-group">
                                    <label>Status</label>
                                    <select id="reSettingPropStatus">
                                        <option value="Rented">Rented</option>
                                        <option value="Not for Rent">Not for Rent</option>
                                        <option value="Sold">Sold</option>
                                        <option value="For sale">For Sale</option>
                                        <option value="Not to be sold">Not to be Sold</option>
                                        <option value="Shared">Shared</option>
                                        <option value="Admin issues">Admin Issues</option>
                                        <option value="Others">Others</option>
                                    </select>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="savePropertySettings()">üíæ Save Property
                                    Settings</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span>üìã Properties Overview</span></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Property</th>
                                            <th>Status</th>
                                            <th>Tax Rate</th>
                                            <th>Period</th>
                                            <th>Rent</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reSettingsPropertiesTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header red"><span>‚ö†Ô∏è Data Management</span></div>
                        <div class="card-body">
                            <p style="margin-bottom: 15px; color: #e53e3e;">Warning: These actions cannot be undone!</p>
                            <div class="btn-group">
                                <button class="btn btn-danger" onclick="resetREData()">üóëÔ∏è Reset All RE Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    <!-- ==================== RESIDENCE ASSETS MODULE ==================== -->

    <!-- ASSETS DASHBOARD -->
    <div id="assets-dashboard" class="page">
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-icon">üèòÔ∏è</div>
                <div class="stat-value" id="assetsOldTownTotal">2,953,000</div>
                <div class="stat-label">Old Town Value (XAF)</div>
            </div>
            <div class="stat-card green">
                <div class="stat-icon">üè°</div>
                <div class="stat-value" id="assetsMankaTotal">4,650,000</div>
                <div class="stat-label">Manka Value (XAF)</div>
            </div>
            <div class="stat-card gold">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="assetsCombinedTotal">7,603,000</div>
                <div class="stat-label">Combined Total (XAF)</div>
            </div>
            <div class="stat-card red">
                <div class="stat-icon">üì¶</div>
                <div class="stat-value" id="assetsTotalItems">0</div>
                <div class="stat-label">Total Items</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%);">
                <span>ü™ë Residence Assets Overview</span>
            </div>
            <div class="card-body">
                <p
                    style="font-size: 0.85rem; color: #718096; margin-bottom: 15px; background: #faf5ff; padding: 10px; border-radius: 6px; border-left: 4px solid #805ad5;">
                    üìå <strong>Disclaimer:</strong> All values are approximate resale/market estimates in Central
                    African Francs (XAF) for used items in good condition. Actual sale prices may vary. Professional
                    appraisal is recommended for high-value items.
                </p>

                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <!-- Old Town Summary -->
                    <div
                        style="background: linear-gradient(135deg, rgba(66,153,225,0.1), rgba(49,130,206,0.1)); border: 2px solid var(--primary-blue); border-radius: 10px; padding: 1rem;">
                        <h3
                            style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üèòÔ∏è OLD TOWN RESIDENCE</h3>
                        <div class="summary-row"><span>Living Room & Common Areas</span><span
                                id="oldTownLiving">745,000</span></div>
                        <div class="summary-row"><span>Kitchen & Dining</span><span id="oldTownKitchen">690,000</span>
                        </div>
                        <div class="summary-row"><span>Master Bedroom</span><span id="oldTownMaster">585,000</span>
                        </div>
                        <div class="summary-row"><span>Bedroom 2</span><span id="oldTownBed2">283,000</span></div>
                        <div class="summary-row"><span>Bedroom 3</span><span id="oldTownBed3">295,000</span></div>
                        <div class="summary-row"><span>Outdoor & Miscellaneous</span><span
                                id="oldTownMisc">355,000</span></div>
                        <div class="summary-row" style="font-size: 1.1rem; color: var(--primary-blue);"><strong>GRAND
                                TOTAL</strong><strong id="oldTownGrand">2,953,000 XAF</strong></div>
                    </div>

                    <!-- Manka Summary -->
                    <div
                        style="background: linear-gradient(135deg, rgba(56,161,105,0.1), rgba(39,103,73,0.1)); border: 2px solid var(--success-green); border-radius: 10px; padding: 1rem;">
                        <h3
                            style="color: var(--success-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üè° MANKA RESIDENCE</h3>
                        <div class="summary-row"><span>Living Room & Common Areas</span><span
                                id="mankaLiving">995,000</span></div>
                        <div class="summary-row"><span>Kitchen & Dining</span><span id="mankaKitchen">1,080,000</span>
                        </div>
                        <div class="summary-row"><span>Master Bedroom</span><span id="mankaMaster">970,000</span></div>
                        <div class="summary-row"><span>Bedroom 2 (Guest Suite)</span><span id="mankaBed2">430,000</span>
                        </div>
                        <div class="summary-row"><span>Bedroom 3</span><span id="mankaBed3">280,000</span></div>
                        <div class="summary-row"><span>Outdoor, Laundry & Misc</span><span id="mankaMisc">895,000</span>
                        </div>
                        <div class="summary-row" style="font-size: 1.1rem; color: var(--success-green);"><strong>GRAND
                                TOTAL</strong><strong id="mankaGrand">4,650,000 XAF</strong></div>
                    </div>
                </div>

                <div class="highlight-box"
                    style="margin-top: 1.5rem; background: linear-gradient(135deg, rgba(128,90,213,0.15), rgba(85,60,154,0.15)); border-color: #805ad5;">
                    <p style="color: #553c9a; font-size: 0.9rem;">OVERALL GRAND TOTAL</p>
                    <h3 style="color: #805ad5;" id="assetsOverallTotal">7,603,000 XAF</h3>
                    <p style="color: #718096; font-size: 0.8rem;">(Seven Million Six Hundred Three Thousand Central
                        African Francs)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- OLD TOWN RESIDENCE ASSETS -->
    <div id="assets-oldtown" class="page">
        <div class="card">
            <div class="card-header"
                style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);">
                <span>üèòÔ∏è Old Town Residence - Asset Inventory</span>
                <span class="badge badge-income" id="oldTownTotalBadge">2,953,000 XAF</span>
            </div>
            <div class="card-body">
                <!-- Category Tabs - Dynamic -->
                <div class="asset-tabs-container">
                    <div id="oldTownTabs" class="asset-tabs"
                        style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem;">
                        <!-- Tabs rendered dynamically -->
                    </div>
                    <button class="btn btn-success btn-sm admin-only" onclick="showAddCategoryModal('oldTown')"
                        style="margin-bottom: 1rem;">‚ûï Add Category</button>
                </div>

                <!-- Tab Content - Dynamic -->
                <div id="oldTownTabContent">
                    <!-- Content rendered dynamically -->
                </div>

                <div class="highlight-box" style="margin-top: 1.5rem;">
                    <p style="color: #744210;">OLD TOWN RESIDENCE GRAND TOTAL</p>
                    <h3 id="oldTownFinalTotal">2,953,000 XAF</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- MANKA RESIDENCE ASSETS -->
    <div id="assets-manka" class="page">
        <div class="card">
            <div class="card-header green">
                <span>üè° Manka Residence - Asset Inventory</span>
                <span class="badge badge-income" id="mankaTotalBadge">4,650,000 XAF</span>
            </div>
            <div class="card-body">
                <!-- Category Tabs - Dynamic -->
                <div class="asset-tabs-container">
                    <div id="mankaTabs" class="asset-tabs"
                        style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem;">
                        <!-- Tabs rendered dynamically -->
                    </div>
                    <button class="btn btn-success btn-sm admin-only" onclick="showAddCategoryModal('manka')"
                        style="margin-bottom: 1rem;">‚ûï Add Category</button>
                </div>

                <!-- Tab Content - Dynamic -->
                <div id="mankaTabContent">
                    <!-- Content rendered dynamically -->
                </div>

                <div class="highlight-box"
                    style="margin-top: 1.5rem; background: linear-gradient(135deg, rgba(56,161,105,0.15), rgba(39,103,73,0.15)); border-color: var(--success-green);">
                    <p style="color: #276749;">MANKA RESIDENCE GRAND TOTAL</p>
                    <h3 style="color: var(--success-green);" id="mankaFinalTotal">4,650,000 XAF</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- ASSETS INHERITANCE -->
    <div id="assets-inheritance" class="page">
        <div class="card">
            <div class="card-header gold">
                <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Assets Inheritance Distribution</span>
            </div>
            <div class="card-body">
                <div class="highlight-box">
                    <p style="color: #744210;">Total Assets Pool for Distribution</p>
                    <h3 id="assetsInheritancePool">7,603,000 XAF</h3>
                    <p style="color: #718096; font-size: 0.8rem;">Combined value of Old Town + Manka Residence assets
                    </p>
                </div>

                <p
                    style="font-size: 0.85rem; color: #718096; margin: 15px 0; background: #fffaf0; padding: 10px; border-radius: 6px; border-left: 4px solid var(--accent-gold);">
                    üìå <strong>Islamic Inheritance:</strong> Distribution follows the same heir portions as defined in
                    the Family Estates module. Wives receive 1/8 collectively, Sons receive 2 portions each, Daughters
                    receive 1 portion each.
                </p>

                <!-- Beneficiary Selection -->
                <div class="card" style="margin-bottom: 1rem; border: 2px solid var(--accent-gold);">
                    <div class="card-header" style="background: linear-gradient(135deg, #744210 0%, #975a16 100%);">
                        <span>‚úÖ Select Beneficiaries</span>
                        <span class="badge" style="background: white; color: #744210;" id="assetsBeneficiaryCount">0
                            selected</span>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 1rem;">Select which heirs will
                            receive a share of the residence assets. Only selected heirs will be included in the
                            distribution calculation.</p>

                        <div class="btn-group" style="margin-bottom: 1rem;">
                            <button class="btn btn-success btn-sm" onclick="selectAllAssetsBeneficiaries()">‚úÖ Select
                                All</button>
                            <button class="btn btn-outline btn-sm" onclick="deselectAllAssetsBeneficiaries()">‚òê Deselect
                                All</button>
                        </div>

                        <div id="assetsBeneficiaryList" class="beneficiary-grid">
                            <!-- Beneficiaries loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Distribution Table -->
                <div class="card">
                    <div class="card-header green">
                        <span>üìä Distribution to Selected Beneficiaries</span>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Heir Name</th>
                                        <th>Relationship</th>
                                        <th>Group</th>
                                        <th style="text-align: center;">Portions</th>
                                        <th style="text-align: right;">Share (XAF)</th>
                                    </tr>
                                </thead>
                                <tbody id="assetsHeirsTable"></tbody>
                                <tfoot>
                                    <tr style="background: #f0fff4; font-weight: bold;">
                                        <td colspan="3">TOTAL DISTRIBUTED</td>
                                        <td style="text-align: center;" id="assetsTotalPortions">0</td>
                                        <td style="text-align: right;" id="assetsTotalDistributed">0 XAF</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div id="assetsUndistributedWarning"
                            style="display: none; margin-top: 1rem; padding: 10px; background: #fed7d7; border-radius: 6px; border-left: 4px solid #c53030;">
                            <p style="color: #c53030; margin: 0;"><strong>‚ö†Ô∏è Warning:</strong> <span
                                    id="assetsUndistributedAmount">0 XAF</span> remains undistributed. Please select
                                more beneficiaries or the full amount will not be allocated.</p>
                        </div>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: 1rem;">
                    <button class="btn btn-print" onclick="printAssetsInheritance()">üñ®Ô∏è Print Certificates</button>
                    <button class="btn btn-success" onclick="exportAssetsInheritancePDF()">üì• Export PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ASSETS EXPORT -->
    <div id="assets-export" class="page">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%);">
                <span>üì• Export Assets Data</span>
            </div>
            <div class="card-body">
                <p style="margin-bottom: 15px; color: #718096;">Export residence assets inventory and inheritance
                    distribution.</p>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <button class="btn btn-primary" onclick="exportAssetsPDF()">üìÑ Full Assets Report (PDF)</button>
                    <button class="btn btn-success" onclick="exportAssetsCSV()">üìä Assets List (CSV)</button>
                    <button class="btn btn-warning" onclick="exportAssetsInheritancePDF()">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Inheritance
                        Report (PDF)</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><span>üìã Quick Summary</span></div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-icon">üèòÔ∏è</div>
                        <div class="stat-value">2,953,000</div>
                        <div class="stat-label">Old Town (XAF)</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-icon">üè°</div>
                        <div class="stat-value">4,650,000</div>
                        <div class="stat-label">Manka (XAF)</div>
                    </div>
                    <div class="stat-card gold">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value">7,603,000</div>
                        <div class="stat-label">Combined (XAF)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Modal -->
    <div class="modal-overlay" id="assetModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);">
                <h3 id="assetModalTitle">ü™ë Add Asset</h3>
                <button class="modal-close" onclick="closeAssetModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="assetResidence">
                <input type="hidden" id="assetCategory">
                <input type="hidden" id="assetIndex">
                <div class="form-group">
                    <label>Item Name *</label>
                    <select id="assetItemSelect" onchange="handleAssetItemChange()">
                        <option value="">-- Select or Add New --</option>
                    </select>
                </div>
                <div class="form-group" id="assetCustomItemGroup" style="display: none;">
                    <label>Custom Item Name *</label>
                    <input type="text" id="assetCustomItem" placeholder="Enter item name">
                </div>
                <div class="form-group">
                    <label>Value (XAF) *</label>
                    <input type="number" id="assetValue" placeholder="Enter value" min="0">
                </div>
                <div class="btn-group" style="margin-top: 1rem;">
                    <button class="btn btn-success" onclick="saveAsset()">üíæ Save</button>
                    <button class="btn btn-outline" onclick="closeAssetModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset View Modal -->
    <div class="modal-overlay" id="assetViewModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%);">
                <h3>üìã Asset Details</h3>
                <button class="modal-close" onclick="closeAssetViewModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Item</label>
                    <input type="text" id="assetViewItem" readonly style="background: #f7fafc;">
                </div>
                <div class="form-group">
                    <label>Value (XAF)</label>
                    <input type="text" id="assetViewValue" readonly style="background: #f7fafc;">
                </div>
                <div class="form-group">
                    <label>Residence</label>
                    <input type="text" id="assetViewResidence" readonly style="background: #f7fafc;">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" id="assetViewCategory" readonly style="background: #f7fafc;">
                </div>
                <div class="btn-group" style="margin-top: 1rem;">
                    <button class="btn btn-outline" onclick="closeAssetViewModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal (Add/Edit) -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%);">
                <h3 id="categoryModalTitle">üìÅ Add Category</h3>
                <button class="modal-close" onclick="closeCategoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="categoryResidence">
                <input type="hidden" id="categoryOldKey">
                <div class="form-group">
                    <label>Category Icon</label>
                    <select id="categoryIcon">
                        <option value="üõãÔ∏è">üõãÔ∏è Living Room</option>
                        <option value="üçΩÔ∏è">üçΩÔ∏è Kitchen/Dining</option>
                        <option value="üõèÔ∏è">üõèÔ∏è Bedroom</option>
                        <option value="üöø">üöø Bathroom</option>
                        <option value="üå≥">üå≥ Outdoor</option>
                        <option value="üöó">üöó Garage</option>
                        <option value="üì¶">üì¶ Storage</option>
                        <option value="üè†">üè† General</option>
                        <option value="üîß">üîß Tools/Equipment</option>
                        <option value="üí°">üí° Electronics</option>
                        <option value="üé®">üé® Decor</option>
                        <option value="üìö">üìö Office/Study</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category Name *</label>
                    <input type="text" id="categoryName" placeholder="e.g., Living Room, Kitchen, Garage">
                </div>
                <div class="btn-group" style="margin-top: 1rem;">
                    <button class="btn btn-success" onclick="saveCategory()">üíæ Save Category</button>
                    <button class="btn btn-outline" onclick="closeCategoryModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Modal -->
    <div class="modal-overlay" id="propertyModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="propertyModalTitle">üè† Add Property</h3><button class="modal-close"
                    onclick="closePropertyModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="propId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Property Name *</label>
                        <input type="text" id="propName" placeholder="e.g., Commercial Building A">
                    </div>
                    <div class="form-group">
                        <label>Location *</label>
                        <input type="text" id="propLocation" placeholder="e.g., Bamenda, NW Region">
                    </div>
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="propType">
                            <option value="Residential">Residential</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Land">Land</option>
                            <option value="Industrial">Industrial</option>
                            <option value="Mixed">Mixed Use</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="propStatus" onchange="toggleRentalFields()">
                            <option value="Rented">Rented</option>
                            <option value="Not for Rent">Not for Rent</option>
                            <option value="Sold">Sold</option>
                            <option value="For sale">For Sale</option>
                            <option value="Not to be sold">Not to be Sold</option>
                            <option value="Shared">Shared</option>
                            <option value="Admin issues">Admin Issues</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                </div>

                <!-- Rental Fields (only for Rented status) -->
                <div id="rentalFields" style="background: #ebf8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #2c5282; margin-bottom: 10px;">üí∞ Rental Configuration</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Rent Amount (XAF) *</label>
                            <input type="number" id="propRentAmount" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label>Rental Period *</label>
                            <select id="propRentPeriod">
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tax Rate (%) *</label>
                            <select id="propTaxRate">
                                <option value="0">0%</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="15" selected>15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                            </select>
                        </div>
                    </div>
                    <div style="background: #fff; padding: 10px; border-radius: 6px; margin-top: 10px;">
                        <div class="summary-row"><span>Gross Rent:</span><span id="propGrossRent">0 XAF</span></div>
                        <div class="summary-row"><span>Tax Deduction:</span><span id="propTaxAmount"
                                style="color: #e53e3e;">0 XAF</span></div>
                        <div class="summary-row" style="font-weight: bold;"><span>Net Income:</span><span
                                id="propNetIncome" style="color: #38a169;">0 XAF</span></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Shared per Islamic Inheritance?</label>
                    <select id="propInheritance">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="NA">N/A</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="propNotes" rows="3"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveProperty()">üíæ Save Property</button>
                    <button class="btn btn-outline" onclick="closePropertyModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- RE Heir Modal -->
    <div class="modal-overlay" id="reHeirModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üë§ Add/Edit Heir</h3><button class="modal-close" onclick="closeREHeirModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reHeirId">
                <div class="form-grid">
                    <div class="form-group"><label>Name *</label><input type="text" id="reHeirName"
                            placeholder="Full name"></div>
                    <div class="form-group">
                        <label>Relationship *</label>
                        <select id="reHeirRel" onchange="updateIslamicPortions()">
                            <option value="Wife">Wife</option>
                            <option value="Husband">Husband</option>
                            <option value="Son">Son</option>
                            <option value="Daughter">Daughter</option>
                            <option value="Father">Father</option>
                            <option value="Mother">Mother</option>
                            <option value="Brother">Brother</option>
                            <option value="Sister">Sister</option>
                            <option value="Grandfather">Grandfather</option>
                            <option value="Grandmother">Grandmother</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gender *</label>
                        <select id="reHeirGender" onchange="updateIslamicPortions()">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Portions (Auto-Calculated)</label>
                        <input type="number" id="reHeirPor" value="1" min="0" step="0.125" readonly
                            style="background: #f0f0f0;">
                    </div>
                </div>
                <div
                    style="background: #fffbeb; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 0.85rem;">
                    <strong>üìú Islamic Inheritance Rules:</strong><br>
                    ‚Ä¢ Sons get 2x daughters' share<br>
                    ‚Ä¢ Wife gets 1/8 (with children) or 1/4 (no children)<br>
                    ‚Ä¢ Husband gets 1/4 (with children) or 1/2 (no children)<br>
                    ‚Ä¢ Parents each get 1/6 (with children)
                </div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveREHeir()">üíæ Save</button><button
                        class="btn btn-outline" onclick="closeREHeirModal()">Cancel</button></div>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="campost-settings" class="page">
        <div class="user-restricted-notice">
            <strong>üîí Access Restricted</strong><br>
            Only administrators can access Settings. Please contact an admin if you need to modify system settings.
        </div>
        <div class="admin-only-section">
            <div class="card">
                <div class="card-header gold"><span>üåç Currency & Global Settings</span></div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Currency</label>
                            <select id="campostCurrency" onchange="updateCampostCalcDisplays()">
                                <option value="XAF" selected>XAF - Central African CFA Franc</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="USD">USD - US Dollar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reserved Funds (% of Income)</label>
                            <select id="campostReservedPercent" onchange="updateCampostCalcDisplays()">
                                <option value="0">0% - No Reserve</option>
                                <option value="5">5%</option>
                                <option value="10" selected>10%</option>
                                <option value="15">15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                                <option value="30">30%</option>
                            </select>
                        </div>
                    </div>
                    <p
                        style="font-size: 0.8rem; color: #718096; margin: 10px 0; background: #ebf8ff; padding: 10px; border-radius: 6px;">
                        üè¶ <strong>Reserved Funds:</strong> A percentage of total income set aside for maintenance,
                        emergencies, or future investments.<br>
                        üìä <strong>Net Balance</strong> = Total Income - Total Expenses - Reserved Funds
                    </p>
                </div>
            </div>
            <div class="card">
                <div class="card-header gold"><span>üí∞ Rent Configuration</span></div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Monthly Rent</label>
                            <input type="number" id="settingMonthlyRent" value="200000">
                        </div>
                        <div class="form-group">
                            <label>Tax Rate (%)</label>
                            <input type="number" id="settingTaxRate" value="15" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Months per Quarter</label>
                            <input type="number" id="settingMonths" value="3" readonly>
                        </div>
                    </div>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-bottom: 10px; color: #2c5282;">üìä Calculated Amounts</h4>
                        <div class="summary-row"><span>Quarterly Gross:</span><span id="calcGross">600,000 XAF</span>
                        </div>
                        <div class="summary-row"><span>Tax Deduction:</span><span id="calcTax">90,000 XAF</span></div>
                        <div class="summary-row" style="font-weight: bold; color: #38a169;"><span>Net Amount
                                Due:</span><span id="calcNet">510,000 XAF</span></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveSettings()">üíæ Save All Settings</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span>‚öôÔ∏è System Status</span></div>
                <div class="card-body">
                    <div class="alert" id="settingsAlert">Checking...</div>
                    <div class="btn-group">
                        <button class="btn btn-outline" onclick="checkDb()">üîÑ Refresh</button>
                        <button class="btn btn-danger" onclick="resetAll()">üóëÔ∏è Reset All Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>

    <!-- Bill/Invoice Modal -->
    <div class="modal-overlay" id="billModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üìÑ Rent Invoice</h3><button class="modal-close" onclick="closeBillModal()">√ó</button>
            </div>
            <div class="modal-body" id="billModalBody"></div>
        </div>
    </div>

    <!-- Heir Modal -->
    <div class="modal-overlay" id="heirModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üë§ Heir</h3><button class="modal-close" onclick="closeHeirModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="heirId">
                <div class="form-group"><label>Name</label><input type="text" id="heirName"></div>
                <div class="form-group"><label>Relationship</label><select id="heirRel">
                        <option value="Spouse">Spouse</option>
                        <option value="Child">Child</option>
                    </select></div>
                <div class="form-group"><label>Group</label><select id="heirGrp">
                        <option value="Wives">Wives</option>
                        <option value="Daughters">Daughters</option>
                        <option value="Sons">Sons</option>
                    </select></div>
                <div class="form-group"><label>Portions</label><input type="number" id="heirPor" value="3" step="0.5">
                </div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveHeir()">üíæ Save</button></div>
            </div>
        </div>
    </div>
    </div> <!-- End mainApp -->

    <!-- ==================== LOGIN CONTAINER ==================== -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üè¢</div>
                <h1>NJIKAM SALIFU ESTATE</h1>
                <p>Property & Billing Management System</p>
            </div>
            <div class="login-body">
                <div id="loginError" class="login-error"></div>
                <div class="form-group">
                    <label>üë§ Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>üîë Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password"
                        autocomplete="current-password" onkeypress="if(event.key==='Enter')doLogin()">
                </div>
                <button class="btn btn-success login-btn" onclick="doLogin()">üîì Login</button>
            </div>
            <div class="login-footer">
                <a onclick="showForgotPassword()">Forgot Password?</a>
                <br><br>
                <span>¬© 2024-2025 NJIKAM SALIFU ESTATE</span>
            </div>
        </div>
    </div>

    <!-- ==================== FORGOT PASSWORD MODAL ==================== -->
    <div id="forgotPasswordModal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h3>üîê Reset Password</h3>
                <button class="modal-close" onclick="closeForgotPassword()" style="color: white;">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size: 0.9rem; color: #718096; margin-bottom: 15px;">
                    Enter your username and email address. A temporary password will be sent to your registered email.
                </p>
                <div id="forgotError" class="login-error"></div>
                <div class="form-group">
                    <label>üë§ Username</label>
                    <input type="text" id="forgotUsername" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label>üìß Email Address</label>
                    <input type="email" id="forgotEmail" placeholder="Enter your email address">
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="requestPasswordReset()">üì® Send Temporary Password</button>
                    <button class="btn btn-outline" onclick="closeForgotPassword()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== FORCE PASSWORD CHANGE MODAL ==================== -->
    <div id="forcePasswordModal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white;">
                <h3>‚ö†Ô∏è Password Change Required</h3>
            </div>
            <div class="modal-body">
                <div
                    style="background: #fffaf0; border: 1px solid #ed8936; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="font-size: 0.9rem; color: #744210; margin: 0;">
                        <strong>üîí Security Notice:</strong> You must change your password before continuing. This is
                        required for:
                    </p>
                    <ul style="font-size: 0.85rem; color: #744210; margin: 10px 0 0 20px; padding: 0;">
                        <li>First-time login with default credentials</li>
                        <li>Login after password reset</li>
                    </ul>
                </div>
                <div id="forcePasswordError" class="login-error"></div>
                <div class="form-group">
                    <label>üîë New Password</label>
                    <input type="password" id="forceNewPassword" placeholder="Enter new password (min 6 characters)">
                </div>
                <div class="form-group">
                    <label>üîë Confirm New Password</label>
                    <input type="password" id="forceConfirmPassword" placeholder="Confirm new password"
                        onkeypress="if(event.key==='Enter')forceChangePassword()">
                </div>
                <div class="btn-group">
                    <button class="btn btn-warning" onclick="forceChangePassword()">üîê Change Password &
                        Continue</button>
                </div>
            </div>
        </div>
    </div>

    <div id="alertBox" style="position:fixed;top:60px;right:10px;z-index:3000;max-width:280px;"></div>

    <script>
        // ==================== API CONFIGURATION ====================
        var API = window.location.origin + '/api';

        // ==================== AUTHENTICATION SYSTEM ====================

        // Initialize default admin user if not exists
        function initializeUsers() {
            // Users are now initialized in PostgreSQL
            // No localStorage initialization needed
        }

        // Initialize default heirs - now handled by server
        function initializeDefaultHeirs() {
            // RE heirs are now initialized in PostgreSQL
            // No localStorage initialization needed
        }

        // Current logged in user
        var currentUser = null;

        // Login function
        function doLogin() {
            var username = document.getElementById('loginUsername').value.trim().toLowerCase();
            var password = document.getElementById('loginPassword').value;
            var errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = 'Please enter username and password';
                errorEl.classList.add('show');
                return;
            }

            fetch(API + '/users/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            })
                .then(function (res) { return res.json(); })
                .then(function (result) {
                    if (result.success && result.user) {
                        currentUser = result.user;
                        localStorage.setItem('currentSession', JSON.stringify({ userId: result.user.id, loginTime: new Date().toISOString() }));

                        // Check if password change is required
                        if (result.user.must_change_password) {
                            showForcePasswordChange();
                        } else {
                            enterMainApp();
                        }
                    } else {
                        errorEl.textContent = result.error || 'Invalid username or password';
                        errorEl.classList.add('show');
                    }
                }).catch(function (err) {
                    errorEl.textContent = 'Login failed: ' + (err.error || err.message || 'Connection error');
                    errorEl.classList.add('show');
                });
        }

        // Show force password change modal
        function showForcePasswordChange() {
            document.getElementById('forcePasswordModal').style.display = 'flex';
            document.getElementById('forceNewPassword').value = '';
            document.getElementById('forceConfirmPassword').value = '';
            document.getElementById('forcePasswordError').classList.remove('show');
        }

        // Force password change (for first login or after reset)
        function forceChangePassword() {
            var newPwd = document.getElementById('forceNewPassword').value;
            var confirmPwd = document.getElementById('forceConfirmPassword').value;
            var errorEl = document.getElementById('forcePasswordError');

            if (newPwd.length < 6) {
                errorEl.textContent = 'New password must be at least 6 characters';
                errorEl.classList.add('show');
                return;
            }

            if (newPwd !== confirmPwd) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.add('show');
                return;
            }

            // Check if new password is same as default
            if (newPwd === 'admin' || newPwd === '1234') {
                errorEl.textContent = 'Please choose a different password than the default';
                errorEl.classList.add('show');
                return;
            }

            // Update password via API
            api('/users/force-change-password', {
                method: 'POST',
                body: JSON.stringify({
                    userId: currentUser.id,
                    newPassword: newPwd
                })
            }).then(function (result) {
                if (result.success) {
                    document.getElementById('forcePasswordModal').style.display = 'none';
                    currentUser.must_change_password = false;
                    showAlert('Password changed successfully!');
                    enterMainApp();
                } else {
                    errorEl.textContent = result.error || 'Failed to change password';
                    errorEl.classList.add('show');
                }
            }).catch(function (err) {
                errorEl.textContent = 'Error: ' + (err.message || 'Connection error');
                errorEl.classList.add('show');
            });
        }

        // Forgot password functions
        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'flex';
            document.getElementById('forgotUsername').value = '';
            document.getElementById('forgotEmail').value = '';
            document.getElementById('forgotError').classList.remove('show');
        }

        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
        }

        function requestPasswordReset() {
            var username = document.getElementById('forgotUsername').value.trim();
            var email = document.getElementById('forgotEmail').value.trim();
            var errorEl = document.getElementById('forgotError');

            if (!username || !email) {
                errorEl.textContent = 'Please enter both username and email';
                errorEl.classList.add('show');
                return;
            }

            api('/users/reset-password', {
                method: 'POST',
                body: JSON.stringify({ username: username, email: email })
            }).then(function (result) {
                if (result.success) {
                    closeForgotPassword();
                    // For demo, show the temp password. In production, this would be sent via email
                    if (result.tempPassword) {
                        showAlert('Temporary password: ' + result.tempPassword + '\nPlease use this to login and change your password.', 'success');
                    } else {
                        showAlert('Password reset email sent! Check your inbox.');
                    }
                } else {
                    errorEl.textContent = result.error || 'Reset failed';
                    errorEl.classList.add('show');
                }
            }).catch(function (err) {
                errorEl.textContent = err.error || 'Account not found or connection error';
                errorEl.classList.add('show');
            });
        }

        // Enter main app after successful login
        function enterMainApp() {
            document.getElementById('loginContainer').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';

            // Update UI with user info
            document.getElementById('loggedInUser').textContent = currentUser.full_name || currentUser.username;
            var badge = document.getElementById('userRoleBadge');
            badge.textContent = currentUser.role.toUpperCase();
            badge.className = 'user-badge ' + currentUser.role;

            // Set role classes on body for role-based access control
            document.body.classList.remove('is-admin', 'is-user', 'is-guest');
            document.body.classList.add('is-' + currentUser.role);

            // Show/hide admin user management
            if (currentUser.role === 'admin') {
                document.getElementById('adminUserManagement').style.display = 'block';
            } else {
                document.getElementById('adminUserManagement').style.display = 'none';
            }

            // Apply role-based restrictions
            applyRoleBasedAccess();

            // Initialize app
            checkDb();
            goToLanding();
        }

        // Apply role-based access control
        function applyRoleBasedAccess() {
            var role = currentUser ? currentUser.role : 'guest';

            // Admin-only sections (full access)
            var adminOnlySections = document.querySelectorAll('.admin-only-section');
            adminOnlySections.forEach(function (el) {
                el.style.display = (role === 'admin') ? 'block' : 'none';
            });

            // Admin-only elements (buttons, links)
            var adminOnlyElements = document.querySelectorAll('.admin-only');
            adminOnlyElements.forEach(function (el) {
                el.style.display = (role === 'admin') ? '' : 'none';
            });

            // User restricted notice (shown to non-admins)
            var userNotices = document.querySelectorAll('.user-restricted-notice');
            userNotices.forEach(function (el) {
                el.style.display = (role === 'admin') ? 'none' : 'block';
            });

            // Guest restricted notice (shown to guests only)
            var guestNotices = document.querySelectorAll('.guest-restricted-notice');
            guestNotices.forEach(function (el) {
                el.style.display = (role === 'guest') ? 'block' : 'none';
            });

            // Hide navigation buttons based on role
            applyNavRestrictions();
        }

        // Apply navigation restrictions based on role
        function applyNavRestrictions() {
            var role = currentUser ? currentUser.role : 'guest';

            // Admin-only pages (full write access)
            var adminPages = ['campost-expenses', 'campost-bills', 'campost-payments', 'campost-inheritance', 'campost-export', 'campost-settings', 'family-expenses', 'family-bills', 'family-payments', 'family-inheritance', 'family-export', 'family-settings', 'family-ledger'];

            // Guest restricted pages (guests cannot access these)
            var guestRestrictedPages = ['campost-ledger', 'campost-expenses', 'campost-bills', 'campost-payments', 'campost-inheritance', 'campost-export', 'campost-settings', 'family-ledger', 'family-expenses', 'family-bills', 'family-payments', 'family-inheritance', 'family-export', 'family-settings'];

            // Apply restrictions
            document.querySelectorAll('.nav-btn[data-page]').forEach(function (btn) {
                var page = btn.getAttribute('data-page');

                if (role === 'guest' && guestRestrictedPages.indexOf(page) !== -1) {
                    btn.style.display = 'none';
                } else if (role === 'user' && adminPages.indexOf(page) !== -1) {
                    // Users can see but have read-only access (handled elsewhere)
                    btn.style.display = '';
                } else {
                    btn.style.display = '';
                }
            });
        }

        // Logout function
        function doLogout() {
            if (!confirm('Are you sure you want to logout?')) return;

            currentUser = null;
            localStorage.removeItem('currentSession');

            // Reset UI
            document.body.classList.remove('is-admin', 'is-user', 'is-guest');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginContainer').classList.add('active');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('adminUserManagement').style.display = 'none';
        }

        // Old force password change (now replaced)
        function oldForceChangePassword() {
            var currentPwd = document.getElementById('forceCurrentPassword').value;
            var newPwd = document.getElementById('forceNewPassword').value;
            var confirmPwd = document.getElementById('forceConfirmPassword').value;

            if (newPwd.length < 4) {
                showAlert('New password must be at least 4 characters', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showAlert('New passwords do not match', 'error');
                return;
            }

            // Update password via API
            api('/users/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    userId: currentUser.id,
                    currentPassword: currentPwd,
                    newPassword: newPwd
                })
            }).then(function (result) {
                if (result.success) {
                    document.getElementById('forcePasswordModal').classList.remove('active');
                    showAlert('Password changed successfully!');
                    enterMainApp();
                } else {
                    showAlert(result.error || 'Failed to change password', 'error');
                }
            }).catch(function (err) {
                showAlert('Current password is incorrect', 'error');
            });
        }

        // Change my password (from settings)
        function changeMyPassword() {
            var currentPwd = document.getElementById('changeCurrentPwd').value;
            var newPwd = document.getElementById('changeNewPwd').value;
            var confirmPwd = document.getElementById('changeConfirmPwd').value;

            if (newPwd.length < 4) {
                showAlert('New password must be at least 4 characters', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showAlert('New passwords do not match', 'error');
                return;
            }

            api('/users/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    userId: currentUser.id,
                    currentPassword: currentPwd,
                    newPassword: newPwd
                })
            }).then(function (result) {
                if (result.success) {
                    document.getElementById('changeCurrentPwd').value = '';
                    document.getElementById('changeNewPwd').value = '';
                    document.getElementById('changeConfirmPwd').value = '';
                    showAlert('Password changed successfully!');
                } else {
                    showAlert(result.error || 'Failed to change password', 'error');
                }
            }).catch(function (err) {
                showAlert('Current password is incorrect', 'error');
            });
        }

        // Create new user (admin only)
        function createNewUser() {
            if (currentUser.role !== 'admin') {
                showAlert('Only admins can create users', 'error');
                return;
            }

            var username = document.getElementById('newUserUsername').value.trim().toLowerCase();
            var email = document.getElementById('newUserEmail').value.trim().toLowerCase();
            var fullName = document.getElementById('newUserFullName').value.trim();
            var role = document.getElementById('newUserRole').value;

            if (!username) {
                showAlert('Username is required', 'error');
                return;
            }

            if (!email) {
                showAlert('Email is required', 'error');
                return;
            }

            api('/users', {
                method: 'POST',
                body: JSON.stringify({
                    username: username,
                    password: '1234',
                    fullName: fullName || username,
                    email: email,
                    role: role,
                    active: true
                })
            }).then(function (result) {
                if (result.error) {
                    showAlert(result.error, 'error');
                } else {
                    document.getElementById('newUserUsername').value = '';
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserFullName').value = '';
                    document.getElementById('newUserRole').value = 'user';
                    showAlert('User created successfully! Default password is 1234. User must change it on first login.');
                    loadUsersTable();
                }
            }).catch(function (err) {
                showAlert('Error creating user: ' + err.message, 'error');
            });
        }

        // Load users table (admin only)
        function loadUsersTable() {
            api('/users').then(function (users) {
                var html = users.map(function (u) {
                    var statusClass = u.active ? 'badge-paid' : 'badge-unpaid';
                    var statusText = u.active ? 'Active' : 'Inactive';
                    var roleClass = u.role === 'admin' ? 'badge-inheritance' : (u.role === 'guest' ? 'badge-expense' : 'badge-new');
                    var pwdStatus = u.must_change_password ? '<span style="color:#ed8936;font-size:0.7rem;">‚ö†Ô∏è Must change</span>' : '';

                    return '<tr>' +
                        '<td><strong>' + u.username + '</strong></td>' +
                        '<td>' + (u.full_name || '-') + '</td>' +
                        '<td>' + (u.email || '-') + '</td>' +
                        '<td><span class="badge ' + roleClass + '">' + u.role.toUpperCase() + '</span></td>' +
                        '<td><span class="badge ' + statusClass + '">' + statusText + '</span> ' + pwdStatus + '</td>' +
                        '<td>' +
                        (u.id !== currentUser.id ?
                            '<button class="btn btn-warning btn-sm" onclick="resetUserPassword(' + u.id + ')">üîë Reset</button> ' +
                            '<button class="btn btn-' + (u.active ? 'danger' : 'success') + ' btn-sm" onclick="toggleUserStatus(' + u.id + ', ' + u.active + ')">' + (u.active ? 'üö´' : '‚úÖ') + '</button> ' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteUser(' + u.id + ')">üóëÔ∏è</button>'
                            : '<span style="color:#718096;font-size:0.75rem;">Current User</span>') +
                        '</td>' +
                        '</tr>';
                }).join('');

                document.getElementById('usersTable').innerHTML = html || '<tr><td colspan="6">No users</td></tr>';
            });
        }

        // ==================== SYSTEM SETTINGS FUNCTIONS ====================

        // Load system users table
        function loadSystemUsers() {
            api('/users').then(function (users) {
                var html = users.map(function (u) {
                    var statusClass = u.active ? 'badge-paid' : 'badge-unpaid';
                    var statusText = u.active ? 'Active' : 'Inactive';
                    var roleClass = u.role === 'admin' ? 'badge-inheritance' : (u.role === 'guest' ? 'badge-expense' : 'badge-new');
                    var pwdStatus = u.must_change_password ?
                        '<span class="badge" style="background:#fed7d7;color:#c53030;">Must Change</span>' :
                        '<span class="badge" style="background:#c6f6d5;color:#276749;">OK</span>';
                    var isCurrentUser = u.id === currentUser.id;

                    return '<tr' + (isCurrentUser ? ' style="background:#ebf8ff;"' : '') + '>' +
                        '<td><strong>#' + u.id + '</strong></td>' +
                        '<td><strong>' + u.username + '</strong>' + (isCurrentUser ? ' <span style="color:#4299e1;font-size:0.7rem;">(You)</span>' : '') + '</td>' +
                        '<td>' + (u.full_name || '-') + '</td>' +
                        '<td>' + (u.email || '-') + '</td>' +
                        '<td><span class="badge ' + roleClass + '">' + u.role.toUpperCase() + '</span></td>' +
                        '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
                        '<td>' + pwdStatus + '</td>' +
                        '<td>' +
                        (isCurrentUser ?
                            '<span style="color:#718096;font-size:0.75rem;">Current User</span>' :
                            '<button class="btn btn-warning btn-sm" onclick="resetUserPassword(' + u.id + ')" title="Reset Password">üîë</button> ' +
                            '<button class="btn btn-primary btn-sm" onclick="editSystemUser(' + u.id + ')" title="Edit User">‚úèÔ∏è</button> ' +
                            '<button class="btn btn-' + (u.active ? 'danger' : 'success') + ' btn-sm" onclick="toggleUserStatus(' + u.id + ', ' + u.active + ')" title="' + (u.active ? 'Disable' : 'Enable') + '">' + (u.active ? 'üö´' : '‚úÖ') + '</button> ' +
                            (u.role !== 'admin' ? '<button class="btn btn-danger btn-sm" onclick="deleteUser(' + u.id + ')" title="Delete">üóëÔ∏è</button>' : '')
                        ) +
                        '</td>' +
                        '</tr>';
                }).join('');

                document.getElementById('systemUsersTable').innerHTML = html || '<tr><td colspan="8">No users found</td></tr>';

                // Update statistics
                document.getElementById('statTotalUsers').textContent = users.length;
                document.getElementById('statActiveUsers').textContent = users.filter(function (u) { return u.active; }).length;
                document.getElementById('statAdminUsers').textContent = users.filter(function (u) { return u.role === 'admin'; }).length;

                // Update my profile section
                updateMyProfile();
            });
        }

        // Create system user
        function createSystemUser() {
            if (currentUser.role !== 'admin') {
                showAlert('Only admins can create users', 'error');
                return;
            }

            var username = document.getElementById('sysNewUsername').value.trim().toLowerCase();
            var fullName = document.getElementById('sysNewFullName').value.trim();
            var email = document.getElementById('sysNewEmail').value.trim().toLowerCase();
            var role = document.getElementById('sysNewRole').value;

            if (!username) {
                showAlert('Username is required', 'error');
                return;
            }

            if (!fullName) {
                showAlert('Full name is required', 'error');
                return;
            }

            if (!email || !email.includes('@')) {
                showAlert('Valid email is required', 'error');
                return;
            }

            api('/users', {
                method: 'POST',
                body: JSON.stringify({
                    username: username,
                    password: '1234',
                    fullName: fullName,
                    email: email,
                    role: role,
                    active: true
                })
            }).then(function (result) {
                if (result.error) {
                    showAlert(result.error, 'error');
                } else {
                    document.getElementById('sysNewUsername').value = '';
                    document.getElementById('sysNewFullName').value = '';
                    document.getElementById('sysNewEmail').value = '';
                    document.getElementById('sysNewRole').value = 'user';
                    showAlert('User "' + username + '" created successfully! Default password: 1234');
                    loadSystemUsers();
                    loadUsersTable(); // Also refresh the other table
                }
            }).catch(function (err) {
                showAlert('Error: ' + (err.error || err.message), 'error');
            });
        }

        // Edit system user
        function editSystemUser(userId) {
            api('/users').then(function (users) {
                var user = users.find(function (u) { return u.id === userId; });
                if (!user) return;

                var newFullName = prompt('Edit Full Name:', user.full_name || '');
                if (newFullName === null) return;

                var newEmail = prompt('Edit Email:', user.email || '');
                if (newEmail === null) return;

                var newRole = prompt('Edit Role (admin/user/guest):', user.role || 'user');
                if (newRole === null) return;

                if (!['admin', 'user', 'guest'].includes(newRole.toLowerCase())) {
                    showAlert('Invalid role. Use: admin, user, or guest', 'error');
                    return;
                }

                api('/users/' + userId, {
                    method: 'PUT',
                    body: JSON.stringify({
                        username: user.username,
                        fullName: newFullName,
                        email: newEmail,
                        role: newRole.toLowerCase(),
                        active: user.active
                    })
                }).then(function () {
                    showAlert('User updated successfully');
                    loadSystemUsers();
                    loadUsersTable();
                });
            });
        }

        // Update my profile display
        function updateMyProfile() {
            if (currentUser) {
                document.getElementById('myProfileUsername').value = currentUser.username || '';
                document.getElementById('myProfileFullName').value = currentUser.full_name || '';
                document.getElementById('myProfileEmail').value = currentUser.email || '';
                document.getElementById('myProfileRole').value = (currentUser.role || 'user').charAt(0).toUpperCase() + (currentUser.role || 'user').slice(1);
            }
        }

        // Change my password
        function changeMyPassword() {
            var currentPwd = document.getElementById('myCurrentPassword').value;
            var newPwd = document.getElementById('myNewPassword').value;
            var confirmPwd = document.getElementById('myConfirmPassword').value;

            if (!currentPwd) {
                showAlert('Please enter your current password', 'error');
                return;
            }

            if (newPwd.length < 6) {
                showAlert('New password must be at least 6 characters', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showAlert('New passwords do not match', 'error');
                return;
            }

            api('/users/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    userId: currentUser.id,
                    currentPassword: currentPwd,
                    newPassword: newPwd
                })
            }).then(function (result) {
                if (result.success) {
                    document.getElementById('myCurrentPassword').value = '';
                    document.getElementById('myNewPassword').value = '';
                    document.getElementById('myConfirmPassword').value = '';
                    showAlert('Password changed successfully!');
                } else {
                    showAlert(result.error || 'Failed to change password', 'error');
                }
            }).catch(function (err) {
                showAlert('Error: ' + (err.error || 'Current password is incorrect'), 'error');
            });
        }

        // Force all users to reset passwords
        function forceAllPasswordReset() {
            if (currentUser.role !== 'admin') return;

            if (!confirm('This will reset ALL non-admin users\' passwords to "1234" and force them to change on next login. Continue?')) return;

            api('/users').then(function (users) {
                var promises = users
                    .filter(function (u) { return u.role !== 'admin'; })
                    .map(function (u) {
                        return api('/users/' + u.id, {
                            method: 'PUT',
                            body: JSON.stringify({ password: '1234', mustChangePassword: true })
                        });
                    });

                Promise.all(promises).then(function () {
                    showAlert('All non-admin passwords reset to 1234');
                    loadSystemUsers();
                });
            });
        }

        // Export user list as CSV
        function exportUserList() {
            api('/users').then(function (users) {
                var csv = 'ID,Username,Full Name,Email,Role,Status,Created At\n';
                users.forEach(function (u) {
                    csv += u.id + ',' +
                        '"' + u.username + '",' +
                        '"' + (u.full_name || '') + '",' +
                        '"' + (u.email || '') + '",' +
                        u.role + ',' +
                        (u.active ? 'Active' : 'Inactive') + ',' +
                        (u.created_at || '') + '\n';
                });

                var blob = new Blob([csv], { type: 'text/csv' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'users_' + new Date().toISOString().split('T')[0] + '.csv';
                a.click();
                URL.revokeObjectURL(url);
                showAlert('User list exported!');
            });
        }

        // ==================== END SYSTEM SETTINGS FUNCTIONS ====================

        // Reset user password (admin only)
        function resetUserPassword(userId) {
            if (currentUser.role !== 'admin') return;
            if (!confirm('Reset this user\'s password to 1234? They will need to change it on next login.')) return;

            api('/users/' + userId, {
                method: 'PUT',
                body: JSON.stringify({ password: '1234', mustChangePassword: true })
            }).then(function () {
                showAlert('Password reset to 1234. User must change it on next login.');
                loadUsersTable();
                loadSystemUsers();
            });
        }

        // Toggle user status (admin only)
        function toggleUserStatus(userId, currentActive) {
            if (currentUser.role !== 'admin') return;

            api('/users/' + userId, {
                method: 'PUT',
                body: JSON.stringify({ active: !currentActive })
            }).then(function () {
                showAlert('User status updated');
                loadUsersTable();
                loadSystemUsers();
            });
        }

        // Delete user
        function deleteUser(userId) {
            if (currentUser.role !== 'admin') return;
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            api('/users/' + userId, { method: 'DELETE' }).then(function () {
                showAlert('User deleted');
                loadUsersTable();
                loadSystemUsers();
            });
        }

        // Forgot password flow - simplified for demo
        function showForgotPassword() {
            showAlert('Please contact an administrator to reset your password.', 'error');
        }

        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
        }

        function resetPasswordWithCode() {
            var email = document.getElementById('forgotEmail').value.trim().toLowerCase();
            var code = document.getElementById('resetCode').value.trim();
            var newPwd = document.getElementById('newResetPassword').value;
            var confirmPwd = document.getElementById('confirmResetPassword').value;

            if (!code || !newPwd || !confirmPwd) {
                showAlert('Please fill all fields', 'error');
                return;
            }

            if (newPwd.length < 4) {
                showAlert('Password must be at least 4 characters', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            var resetCodes = JSON.parse(localStorage.getItem('resetCodes') || '{}');
            var resetData = resetCodes[email];

            if (!resetData || resetData.code !== code) {
                showAlert('Invalid reset code', 'error');
                return;
            }

            if (Date.now() > resetData.expires) {
                showAlert('Reset code has expired. Please request a new one.', 'error');
                return;
            }

            // Update password via API
            api('/users/' + resetData.userId, {
                method: 'PUT',
                body: JSON.stringify({
                    username: resetData.username,
                    password: newPwd,
                    fullName: resetData.fullName || 'User',
                    role: resetData.role || 'user',
                    active: true
                })
            }).then(function () {
                // Remove used code
                delete resetCodes[email];
                localStorage.setItem('resetCodes', JSON.stringify(resetCodes));

                closeForgotPassword();
                showAlert('Password reset successfully! You can now login.');
            }).catch(function (err) {
                showAlert('Error resetting password: ' + err.message, 'error');
            });
        }

        // Load my account info
        function loadMyAccount() {
            if (currentUser) {
                document.getElementById('myUsername').value = currentUser.username;
                document.getElementById('myEmail').value = currentUser.email || '';
                document.getElementById('myRole').value = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            }
        }

        // Check for existing session on page load
        function checkExistingSession() {
            initializeUsers();

            var session = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (session && session.userId) {
                // Verify session with API - fetch user details
                api('/users').then(function (users) {
                    var user = users.find(function (u) { return u.id === session.userId && u.active; });
                    if (user) {
                        currentUser = user;
                        enterMainApp();
                    } else {
                        // Invalid session, clear it
                        localStorage.removeItem('currentSession');
                        document.getElementById('loginContainer').classList.add('active');
                    }
                }).catch(function () {
                    // API error, show login
                    localStorage.removeItem('currentSession');
                    document.getElementById('loginContainer').classList.add('active');
                });
                return;
            }
            // No valid session, show login
            document.getElementById('loginContainer').classList.add('active');
        }

        // ==================== END AUTHENTICATION SYSTEM ====================

        // Configuration - loaded from PostgreSQL API on startup
        var CONFIG = {
            monthlyRate: 200000,
            taxRate: 0.15,
            months: 3,
            accountNo: '12003 14012 10868895015 89'
        };

        // Load config from API on startup
        function initConfigFromAPI() {
            api('/campost/settings').then(function (settings) {
                if (settings.monthlyRate) CONFIG.monthlyRate = parseInt(settings.monthlyRate);
                if (settings.taxRate) CONFIG.taxRate = parseFloat(settings.taxRate);
                campostSettingsCache = {
                    currency: settings.currency || 'XAF',
                    reservedPercent: parseFloat(settings.reservedFundsPercent) || 10,
                    monthlyRate: CONFIG.monthlyRate,
                    taxRate: CONFIG.taxRate
                };
            });
        }

        // Calculate amounts based on config
        function calcAmounts() {
            var gross = CONFIG.monthlyRate * CONFIG.months;
            var tax = Math.round(gross * CONFIG.taxRate);
            var net = gross - tax;
            return { gross: gross, tax: tax, net: net };
        }

        // Update displayed calculations
        function updateCalcDisplays() {
            var calc = calcAmounts();
            var taxPct = Math.round(CONFIG.taxRate * 100);
            // Settings page
            if (document.getElementById('calcGross')) {
                document.getElementById('calcGross').textContent = fmt(calc.gross) + ' XAF';
                document.getElementById('calcTax').textContent = fmt(calc.tax) + ' XAF';
                document.getElementById('calcNet').textContent = fmt(calc.net) + ' XAF';
            }
            // Bills page
            if (document.getElementById('billShowRate')) {
                document.getElementById('billShowRate').textContent = fmt(CONFIG.monthlyRate);
                document.getElementById('billShowGross').textContent = fmt(calc.gross);
                document.getElementById('billShowTax').textContent = '-' + fmt(calc.tax);
                document.getElementById('billShowNet').textContent = fmt(calc.net);
                if (document.getElementById('billShowTaxPct')) {
                    document.getElementById('billShowTaxPct').textContent = taxPct;
                }
            }
        }

        // Save settings to PostgreSQL
        function saveSettings() {
            var rate = parseInt(document.getElementById('settingMonthlyRent').value);
            var tax = parseFloat(document.getElementById('settingTaxRate').value) / 100;
            var currency = document.getElementById('campostCurrency').value;
            var reservedPercent = document.getElementById('campostReservedPercent').value;

            if (rate < 1000) {
                showAlert('Invalid monthly rate', 'error');
                return;
            }
            CONFIG.monthlyRate = rate;
            CONFIG.taxRate = tax;

            // Save all settings to PostgreSQL via API
            Promise.all([
                api('/campost/settings', { method: 'POST', body: JSON.stringify({ key: 'monthlyRate', value: rate.toString() }) }),
                api('/campost/settings', { method: 'POST', body: JSON.stringify({ key: 'taxRate', value: tax.toString() }) }),
                api('/campost/settings', { method: 'POST', body: JSON.stringify({ key: 'currency', value: currency }) }),
                api('/campost/settings', { method: 'POST', body: JSON.stringify({ key: 'reservedFundsPercent', value: reservedPercent }) })
            ]).then(function () {
                campostSettingsCache = { currency: currency, reservedPercent: parseFloat(reservedPercent), monthlyRate: rate, taxRate: tax };
                updateCalcDisplays();
                showAlert('All settings saved! Currency: ' + currency + ', Reserved: ' + reservedPercent + '%');
            }).catch(function (err) {
                showAlert('Error saving settings: ' + err.message, 'error');
            });
        }

        // Load settings from PostgreSQL API
        function loadSettings() {
            api('/campost/settings').then(function (settings) {
                CONFIG.monthlyRate = parseInt(settings.monthlyRate) || 200000;
                CONFIG.taxRate = parseFloat(settings.taxRate) || 0.15;

                document.getElementById('settingMonthlyRent').value = CONFIG.monthlyRate;
                document.getElementById('settingTaxRate').value = Math.round(CONFIG.taxRate * 100);

                // Load currency and reserved percent
                var currency = settings.currency || 'XAF';
                var reservedPercent = settings.reservedFundsPercent || '10';
                document.getElementById('campostCurrency').value = currency;
                document.getElementById('campostReservedPercent').value = reservedPercent;

                campostSettingsCache = { currency: currency, reservedPercent: parseFloat(reservedPercent), monthlyRate: CONFIG.monthlyRate, taxRate: CONFIG.taxRate };
                updateCalcDisplays();
            }).catch(function () {
                // Use defaults
                document.getElementById('settingMonthlyRent').value = CONFIG.monthlyRate;
                document.getElementById('settingTaxRate').value = Math.round(CONFIG.taxRate * 100);
                document.getElementById('campostCurrency').value = 'XAF';
                document.getElementById('campostReservedPercent').value = '10';
                updateCalcDisplays();
            });
        }

        // Update CAMPOST calc displays with currency
        function updateCampostCalcDisplays() {
            var currency = document.getElementById('campostCurrency').value;
            var gross = CONFIG.monthlyRate * CONFIG.months;
            var tax = Math.round(gross * CONFIG.taxRate);
            var net = gross - tax;
            document.getElementById('calcGross').textContent = fmt(gross) + ' ' + currency;
            document.getElementById('calcTax').textContent = fmt(tax) + ' ' + currency;
            document.getElementById('calcNet').textContent = fmt(net) + ' ' + currency;
        }

        // Add event listeners for real-time calculation in settings
        function setupSettingsListeners() {
            var rateInput = document.getElementById('settingMonthlyRent');
            var taxInput = document.getElementById('settingTaxRate');
            var currencySelect = document.getElementById('campostCurrency');

            if (rateInput) {
                rateInput.addEventListener('input', function () {
                    var currency = currencySelect ? currencySelect.value : 'XAF';
                    var tempRate = parseInt(this.value) || 0;
                    var tempTax = parseFloat(taxInput.value) / 100 || 0.15;
                    var gross = tempRate * CONFIG.months;
                    var tax = Math.round(gross * tempTax);
                    var net = gross - tax;
                    document.getElementById('calcGross').textContent = fmt(gross) + ' ' + currency;
                    document.getElementById('calcTax').textContent = fmt(tax) + ' ' + currency;
                    document.getElementById('calcNet').textContent = fmt(net) + ' ' + currency;
                });
            }
            if (taxInput) {
                taxInput.addEventListener('input', function () {
                    var currency = currencySelect ? currencySelect.value : 'XAF';
                    var tempRate = parseInt(rateInput.value) || CONFIG.monthlyRate;
                    var tempTax = parseFloat(this.value) / 100 || 0.15;
                    var gross = tempRate * CONFIG.months;
                    var tax = Math.round(gross * tempTax);
                    var net = gross - tax;
                    document.getElementById('calcGross').textContent = fmt(gross) + ' ' + currency;
                    document.getElementById('calcTax').textContent = fmt(tax) + ' ' + currency;
                    document.getElementById('calcNet').textContent = fmt(net) + ' ' + currency;
                });
            }
        }

        var QUARTERS = {
            'Q1': { period: 'January to March', months: 'Jan-Mar', shortPeriod: 'Q1 (Jan-Mar)' },
            'Q2': { period: 'April to June', months: 'Apr-Jun', shortPeriod: 'Q2 (Apr-Jun)' },
            'Q3': { period: 'July to September', months: 'Jul-Sep', shortPeriod: 'Q3 (Jul-Sep)' },
            'Q4': { period: 'October to December', months: 'Oct-Dec', shortPeriod: 'Q4 (Oct-Dec)' }
        };

        function fmt(n) {
            return n ? Math.abs(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
        }

        // RE Settings cache 
        var reSettingsCache = null;

        function getCurrency() {
            return reSettingsCache ? (reSettingsCache.currency || 'XAF') : 'XAF';
        }

        function loadRESettingsFromAPI() {
            return api('/re/settings').then(function (settings) {
                reSettingsCache = settings;
                return settings;
            }).catch(function () {
                reSettingsCache = { currency: 'XAF', reservedFundsPercent: '10' };
                return reSettingsCache;
            });
        }

        function fmtCurrency(n) {
            return fmt(n) + ' ' + getCurrency();
        }

        function fmtDate(d) {
            return new Date(d).toLocaleDateString();
        }

        function formatDateLong(d) {
            var date = new Date(d);
            var day = date.getDate();
            var suffix = (day === 1 || day === 21 || day === 31) ? 'st' : (day === 2 || day === 22) ? 'nd' : (day === 3 || day === 23) ? 'rd' : 'th';
            var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return day + suffix + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
        }

        function today() {
            return new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function numberToWords(n) {
            var ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            var tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            if (n < 20) return ones[n];
            if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
            if (n < 1000) return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' and ' + numberToWords(n % 100) : '');
            if (n < 1000000) return numberToWords(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 ? ' ' + numberToWords(n % 1000) : '');
            return numberToWords(Math.floor(n / 1000000)) + ' Million' + (n % 1000000 ? ' ' + numberToWords(n % 1000000) : '');
        }

        function showAlert(msg, type) {
            type = type || 'success';
            var el = document.createElement('div');
            el.className = 'alert alert-' + type;
            el.innerHTML = msg;
            document.getElementById('alertBox').appendChild(el);
            setTimeout(function () { el.remove(); }, 2500);
        }

        function api(url, opts) {
            opts = opts || {};
            return fetch(API + url, {
                headers: { 'Content-Type': 'application/json' },
                method: opts.method || 'GET',
                body: opts.body
            }).then(function (res) {
                return res.json().then(function (data) {
                    if (!res.ok) {
                        return Promise.reject(data);
                    }
                    return data;
                });
            });
        }

        // Tabs
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(function (t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-btn').forEach(function (b) { b.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        // Current active module
        var currentModule = 'landing';

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                var page = this.dataset.page;
                if (!page) return; // Skip buttons without data-page (like Home buttons with onclick)

                // Update active states within current nav
                var currentNav = this.closest('.nav');
                currentNav.querySelectorAll('.nav-btn').forEach(function (b) { b.classList.remove('active'); });
                this.classList.add('active');

                // Hide all pages and show selected
                document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });
                document.getElementById(page).classList.add('active');

                loadPage(page);
            });
        });

        // Open a module (CAMPOST or FAMILY)
        function openModule(module) {
            currentModule = module;

            // Hide all navs and pages
            document.querySelectorAll('.nav').forEach(function (n) { n.style.display = 'none'; });
            document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });

            if (module === 'campost') {
                // Show CAMPOST nav and dashboard
                document.getElementById('campostNav').style.display = 'flex';
                document.getElementById('campost-dashboard').classList.add('active');
                document.getElementById('mainTitle').textContent = 'CAMPOST MANKON';
                document.getElementById('mainSubtitle').textContent = 'Property & Billing Management';
                document.querySelector('.logo-icon').textContent = 'CP';
                loadDashboard();
            } else if (module === 'family') {
                // Show FAMILY nav and dashboard
                document.getElementById('familyNav').style.display = 'flex';
                document.getElementById('family-dashboard').classList.add('active');
                document.getElementById('mainTitle').textContent = 'FAMILY ESTATES';
                document.getElementById('mainSubtitle').textContent = 'Property & Rental Management';
                document.querySelector('.logo-icon').textContent = 'FE';
                loadRealEstate();
                loadFamilyDashboardSummary();
            } else if (module === 'assets') {
                // Show ASSETS nav and dashboard
                document.getElementById('assetsNav').style.display = 'flex';
                document.getElementById('assets-dashboard').classList.add('active');
                document.getElementById('mainTitle').textContent = 'RESIDENCE ASSETS';
                document.getElementById('mainSubtitle').textContent = 'Old Town & Manka Inventory';
                document.querySelector('.logo-icon').textContent = 'RA';
                loadAssetsDashboard();
            }
        }

        // Go back to landing page
        function goToLanding() {
            currentModule = 'landing';

            // Hide all navs
            document.querySelectorAll('.nav').forEach(function (n) { n.style.display = 'none'; });

            // Show main nav and landing page
            document.getElementById('mainNav').style.display = 'flex';
            document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });
            document.getElementById('landing').classList.add('active');

            // Reset header
            document.getElementById('mainTitle').textContent = 'NJIKAM SALIFU ESTATE';
            document.getElementById('mainSubtitle').textContent = 'Property & Billing Management System';
            document.querySelector('.logo-icon').textContent = 'NS';

            // Load landing page stats
            loadLandingStats();
        }

        // Load landing page statistics
        function loadLandingStats() {
            // CAMPOST stats
            api('/bills').then(function (bills) {
                var campostIncome = 0;
                bills.forEach(function (b) { if (b.paidAmount > 0) campostIncome += b.paidAmount; });
                document.getElementById('landingCampostIncome').textContent = fmt(campostIncome);

                api('/expenses').then(function (expenses) {
                    var campostExpenses = 0;
                    expenses.forEach(function (e) { campostExpenses += e.amount; });
                    document.getElementById('landingCampostExpenses').textContent = fmt(campostExpenses);
                    document.getElementById('landingCampostBalance').textContent = fmt(campostIncome - campostExpenses);

                    // Update combined totals
                    updateCombinedTotals();
                });
            });

            // Family RE stats - load from API
            api('/re/dashboard').then(function (data) {
                document.getElementById('landingFamilyIncome').textContent = fmt(Math.round(data.totalIncome));
                document.getElementById('landingFamilyExpenses').textContent = fmt(Math.round(data.totalExpenses));
                document.getElementById('landingFamilyProperties').textContent = data.totalProperties;
                document.getElementById('landingTotalProperties').textContent = data.totalProperties;
                updateCombinedTotals();
            }).catch(function () {
                document.getElementById('landingFamilyIncome').textContent = '0';
                document.getElementById('landingFamilyExpenses').textContent = '0';
                document.getElementById('landingFamilyProperties').textContent = '0';
                document.getElementById('landingTotalProperties').textContent = '0';
            });

            // Assets stats - calculated from hardcoded data
            if (typeof calcAssetTotals === 'function') {
                var totals = calcAssetTotals();
                if (document.getElementById('landingOldTownValue')) {
                    document.getElementById('landingOldTownValue').textContent = fmt(totals.oldTown.total);
                }
                if (document.getElementById('landingMankaValue')) {
                    document.getElementById('landingMankaValue').textContent = fmt(totals.manka.total);
                }
                if (document.getElementById('landingTotalAssets')) {
                    document.getElementById('landingTotalAssets').textContent = fmt(totals.grandTotal);
                }
            }
        }

        function updateCombinedTotals() {
            var campostIncome = parseInt(document.getElementById('landingCampostIncome').textContent.replace(/,/g, '')) || 0;
            var campostExpenses = parseInt(document.getElementById('landingCampostExpenses').textContent.replace(/,/g, '')) || 0;
            var familyIncome = parseInt(document.getElementById('landingFamilyIncome').textContent.replace(/,/g, '')) || 0;
            var familyExpenses = parseInt(document.getElementById('landingFamilyExpenses').textContent.replace(/,/g, '')) || 0;

            document.getElementById('landingTotalIncome').textContent = fmt(campostIncome + familyIncome);
            document.getElementById('landingTotalExpenses').textContent = fmt(campostExpenses + familyExpenses);
            document.getElementById('landingTotalBalance').textContent = fmt((campostIncome + familyIncome) - (campostExpenses + familyExpenses));
        }

        // Load Family Dashboard Summary - from PostgreSQL API
        function loadFamilyDashboardSummary() {
            Promise.all([api('/re/dashboard'), api('/re/settings')]).then(function (results) {
                var data = results[0];
                var settings = results[1];
                var currency = settings.currency || 'XAF';

                document.getElementById('familySummaryProps').textContent = data.totalProperties;
                document.getElementById('familySummaryRented').textContent = data.rentedProperties;
                document.getElementById('familySummaryIncome').textContent = fmt(Math.round(data.totalIncome)) + ' ' + currency;
                document.getElementById('familySummaryExpenses').textContent = fmt(Math.round(data.totalExpenses)) + ' ' + currency;
                document.getElementById('familySummaryReserved').textContent = fmt(Math.round(data.reservedFunds)) + ' ' + currency;
                document.getElementById('familySummaryBalance').textContent = fmt(Math.round(data.netBalance)) + ' ' + currency;
            });
        }

        function loadPage(p) {
            // CAMPOST pages
            if (p === 'campost-dashboard') loadDashboard();
            else if (p === 'campost-ledger') loadLedger();
            else if (p === 'campost-expenses') loadExpenses();
            else if (p === 'campost-bills') { loadBills(); updateCalcDisplays(); }
            else if (p === 'campost-payments') loadPayments();
            else if (p === 'campost-inheritance') loadInheritance();
            else if (p === 'campost-settings') { loadSettings(); setupSettingsListeners(); checkDb(); }
            // Family RE pages
            else if (p === 'family-dashboard') { loadRealEstate(); loadFamilyDashboardSummary(); }
            else if (p === 'family-properties') loadRealEstate();
            else if (p === 'family-income') { loadRealEstate(); api('/properties').then(function (props) { renderRentalIncomeTable(props); }); }
            else if (p === 'family-bills') loadREBills();
            else if (p === 'family-payments') loadREPayments();
            else if (p === 'family-expenses') loadREExpenses();
            else if (p === 'family-inheritance') loadREInheritance();
            else if (p === 'family-ledger') loadRELedgerFull();
            else if (p === 'family-settings') loadRESettings();
            // Assets pages
            else if (p === 'assets-dashboard') loadAssetsDashboard();
            else if (p === 'assets-oldtown') loadOldTownAssets();
            else if (p === 'assets-manka') loadMankaAssets();
            else if (p === 'assets-inheritance') loadAssetsInheritance();
            // System Settings (login management)
            else if (p === 'system-settings') { loadSystemUsers(); updateMyProfile(); }
            // Main settings (user management)
            else if (p === 'main-settings') { loadMyAccount(); loadUsersTable(); }
            // Landing
            else if (p === 'landing') loadLandingStats();
        }

        // Dashboard
        // Get CAMPOST settings - cached in memory, loaded from API
        var campostSettingsCache = null;
        function getCampostSettings() {
            if (campostSettingsCache) return campostSettingsCache;
            return {
                currency: 'XAF',
                reservedPercent: 10
            };
        }

        function loadCampostSettingsFromAPI() {
            return api('/campost/settings').then(function (settings) {
                campostSettingsCache = {
                    currency: settings.currency || 'XAF',
                    reservedPercent: parseFloat(settings.reservedFundsPercent) || 10,
                    monthlyRate: parseInt(settings.monthlyRate) || 200000,
                    taxRate: parseFloat(settings.taxRate) || 0.15
                };
                CONFIG.monthlyRate = campostSettingsCache.monthlyRate;
                CONFIG.taxRate = campostSettingsCache.taxRate;
                return campostSettingsCache;
            }).catch(function () {
                campostSettingsCache = { currency: 'XAF', reservedPercent: 10 };
                return campostSettingsCache;
            });
        }

        function loadDashboard() {
            var settings = getCampostSettings();
            var currency = settings.currency;
            var reservedPercent = settings.reservedPercent;

            // Get total income from bills (paid amounts from bills with paid or partial status)
            api('/bills').then(function (bills) {
                var totalIncome = 0;
                bills.forEach(function (b) {
                    // Include paid amount from bills that have any payment (paid or partial)
                    if (b.paidAmount > 0) {
                        totalIncome += b.paidAmount;
                    }
                });
                document.getElementById('dashIncome').textContent = fmt(totalIncome);
                document.getElementById('dashIncomeSum').textContent = fmt(totalIncome) + ' ' + currency;

                // Get expenses
                api('/expenses').then(function (expenses) {
                    var totalExpenses = 0;
                    expenses.forEach(function (e) {
                        totalExpenses += e.amount;
                    });
                    document.getElementById('dashExp').textContent = fmt(totalExpenses);
                    document.getElementById('dashExpSum').textContent = fmt(totalExpenses) + ' ' + currency;

                    // Calculate reserved funds = percentage of income
                    var reservedFunds = Math.round(totalIncome * reservedPercent / 100);
                    document.getElementById('dashReserve').textContent = fmt(reservedFunds);
                    document.getElementById('dashReserveSum').textContent = fmt(reservedFunds) + ' ' + currency;
                    document.getElementById('dashReservePercent').textContent = reservedPercent;

                    // Calculate net balance = Income - Expenses - Reserved (minimum 0)
                    var netBalance = Math.max(0, totalIncome - totalExpenses - reservedFunds);
                    document.getElementById('dashNetBalance').textContent = fmt(netBalance);
                    document.getElementById('dashNetBalanceSum').textContent = fmt(netBalance) + ' ' + currency;

                    // Update expense form state
                    updateCampostExpenseFormState(netBalance);
                });
            });

            // Get inheritance amount
            api('/inheritance/calculate').then(function (d) {
                document.getElementById('dashInh').textContent = fmt(d.inheritanceAmount);
                document.getElementById('dashInhSum').textContent = fmt(d.inheritanceAmount) + ' ' + currency;
            });
        }

        // Enable/Disable CAMPOST expense form based on net balance
        function updateCampostExpenseFormState(netBalance) {
            var expenseFields = ['expDate', 'expDesc', 'expCat', 'expAmt'];
            var saveBtn = document.getElementById('campostSaveExpenseBtn');
            var warningEl = document.getElementById('campostExpenseWarning');

            if (netBalance <= 0) {
                // Disable all expense input fields
                expenseFields.forEach(function (id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.disabled = true;
                        el.style.backgroundColor = '#f0f0f0';
                        el.style.cursor = 'not-allowed';
                    }
                });

                // Disable save button
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.5';
                    saveBtn.style.cursor = 'not-allowed';
                }

                // Show warning message
                if (warningEl) {
                    warningEl.style.display = 'block';
                }
            } else {
                // Enable all expense input fields
                expenseFields.forEach(function (id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.disabled = false;
                        el.style.backgroundColor = '';
                        el.style.cursor = '';
                    }
                });

                // Enable save button
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = '';
                }

                // Hide warning message
                if (warningEl) {
                    warningEl.style.display = 'none';
                }
            }
        }

        // Ledger - combines income (from bills paid/partial) and expenses
        function loadLedger() {
            Promise.all([api('/bills'), api('/expenses')]).then(function (results) {
                var bills = results[0];
                var expenses = results[1];

                // Combine into ledger entries
                var ledgerEntries = [];

                // Add bills with payments as income (paid or partial status)
                bills.forEach(function (b) {
                    if (b.paidAmount > 0) {
                        var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                        ledgerEntries.push({
                            date: b.createdAt || new Date().toISOString(),
                            description: 'Bill ' + b.billNumber + ' - ' + b.period + ' ' + b.year + ' (' + status + ')',
                            type: 'Income',
                            income: b.paidAmount,
                            expense: 0,
                            status: status
                        });
                    }
                });

                // Add expenses
                expenses.forEach(function (e) {
                    ledgerEntries.push({
                        date: e.date,
                        description: e.description,
                        type: e.categoryName,
                        income: 0,
                        expense: e.amount,
                        category: e.categoryName
                    });
                });

                // Sort by date
                ledgerEntries.sort(function (a, b) {
                    return new Date(a.date) - new Date(b.date);
                });

                // Calculate running balance and totals
                var runningBalance = 0;
                var totalIncome = 0;
                var totalExpense = 0;

                var tableHtml = '';
                ledgerEntries.forEach(function (entry) {
                    if (entry.income > 0) {
                        runningBalance += entry.income;
                        totalIncome += entry.income;
                    }
                    if (entry.expense > 0) {
                        runningBalance -= entry.expense;
                        totalExpense += entry.expense;
                    }

                    var isInheritance = entry.type === 'Inheritance Share';
                    var isIncome = entry.income > 0;
                    tableHtml += '<tr>' +
                        '<td>' + fmtDate(entry.date) + '</td>' +
                        '<td>' + entry.description + '</td>' +
                        '<td><span class="badge ' + (isIncome ? 'badge-income' : isInheritance ? 'badge-inheritance' : 'badge-expense') + '">' + entry.type + (entry.status ? ' (' + entry.status + ')' : '') + '</span></td>' +
                        '<td class="amount-positive">' + (entry.income > 0 ? fmt(entry.income) : '-') + '</td>' +
                        '<td class="' + (isInheritance ? 'amount-gold' : 'amount-negative') + '">' + (entry.expense > 0 ? fmt(entry.expense) : '-') + '</td>' +
                        '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(runningBalance) + '</td>' +
                        '</tr>';
                });

                document.getElementById('ledgerTable').innerHTML = tableHtml || '<tr><td colspan="6">No transactions</td></tr>';

                // Calculate reserved funds and net balance
                var settings = getCampostSettings();
                var currency = settings.currency;
                var reservedPercent = settings.reservedPercent;
                var reservedFunds = Math.round(totalIncome * reservedPercent / 100);
                var netBalance = Math.max(0, runningBalance - reservedFunds);

                // Totals footer with 3 rows
                document.getElementById('ledgerTotals').innerHTML =
                    '<tr style="background: #f7fafc; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right;">SUBTOTAL (' + currency + '):</td>' +
                    '<td class="amount-positive">' + fmt(totalIncome) + '</td>' +
                    '<td class="amount-negative">' + fmt(totalExpense) + '</td>' +
                    '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(runningBalance) + '</td>' +
                    '</tr>' +
                    '<tr style="background: #fed7d7; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right; color: #c53030;">üè¶ Reserved Funds (' + reservedPercent + '% of Income):</td>' +
                    '<td></td>' +
                    '<td style="color: #c53030;">-' + fmt(reservedFunds) + '</td>' +
                    '<td></td>' +
                    '</tr>' +
                    '<tr style="background: #fc8181; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right; color: #742a2a;">üìä NET BALANCE:</td>' +
                    '<td></td>' +
                    '<td></td>' +
                    '<td style="color: #742a2a;">' + fmt(netBalance) + '</td>' +
                    '</tr>';

                // Update stats
                document.getElementById('ledgerIncome').textContent = fmt(totalIncome);
                document.getElementById('ledgerExpense').textContent = fmt(totalExpense);
                document.getElementById('ledgerReserved').textContent = fmt(reservedFunds);
                document.getElementById('ledgerNetBalance').textContent = fmt(netBalance);
            });
        }

        // Expenses
        function loadExpenses() {
            var settings = getCampostSettings();
            var currency = settings.currency;

            api('/categories').then(function (cats) {
                document.getElementById('expCat').innerHTML = cats.map(function (c) {
                    return '<option value="' + c.id + '">' + c.name + '</option>';
                }).join('');
            });
            if (!document.getElementById('expDate').value) {
                document.getElementById('expDate').valueAsDate = new Date();
            }
            api('/expenses').then(function (expenses) {
                var totalExp = 0;
                var html = expenses.map(function (e) {
                    var isInh = e.categoryName === 'Inheritance Share';
                    totalExp += e.amount;
                    return '<tr><td>' + fmtDate(e.date) + '</td><td>' + e.description + '</td><td>' + e.categoryName + '</td><td class="' + (isInh ? 'amount-gold' : 'amount-negative') + '">-' + fmt(e.amount) + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editExpense(' + e.id + ')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteExpense(' + e.id + ')">üóëÔ∏è</button></td></tr>';
                }).join('') || '<tr><td colspan="5">No expenses</td></tr>';

                document.getElementById('expTable').innerHTML = html;

                // Add totals row
                var totalsEl = document.getElementById('expTotals');
                if (totalsEl) {
                    totalsEl.innerHTML = '<tr style="background: #f7fafc; font-weight: bold;">' +
                        '<td colspan="3" style="text-align: right;">TOTAL (' + currency + '):</td>' +
                        '<td class="amount-negative">' + fmt(totalExp) + '</td>' +
                        '<td></td></tr>';
                }
            });
        }

        function editExpense(id) {
            api('/expenses').then(function (expenses) {
                var e = expenses.find(function (x) { return x.id === id; });
                if (e) {
                    document.getElementById('expId').value = id;
                    document.getElementById('expDate').value = e.date.split('T')[0];
                    document.getElementById('expDesc').value = e.description;
                    document.getElementById('expCat').value = e.categoryId;
                    document.getElementById('expAmt').value = e.amount;
                }
            });
        }

        function saveExpense() {
            var id = document.getElementById('expId').value;
            var data = {
                date: document.getElementById('expDate').value,
                description: document.getElementById('expDesc').value,
                categoryId: document.getElementById('expCat').value,
                amount: parseInt(document.getElementById('expAmt').value)
            };
            if (!data.date || !data.description || !data.amount) {
                showAlert('Fill all fields', 'error');
                return;
            }

            // Check net balance before saving (only for new expenses)
            if (!id) {
                var settings = getCampostSettings();
                var reservedPercent = settings.reservedPercent;

                // Get current totals
                Promise.all([api('/bills'), api('/expenses')]).then(function (results) {
                    var bills = results[0];
                    var expenses = results[1];

                    var totalIncome = 0;
                    bills.forEach(function (b) { if (b.paidAmount > 0) totalIncome += b.paidAmount; });

                    var totalExpenses = 0;
                    expenses.forEach(function (e) { totalExpenses += e.amount; });

                    var reservedFunds = Math.round(totalIncome * reservedPercent / 100);
                    var currentNetBalance = totalIncome - totalExpenses - reservedFunds;

                    if (currentNetBalance <= 0) {
                        showAlert('Cannot add expense: Net Balance is zero. Add more income first.', 'error');
                        return;
                    }

                    if (data.amount > currentNetBalance) {
                        showAlert('Cannot add expense: Amount (' + fmt(data.amount) + ') exceeds available Net Balance (' + fmt(currentNetBalance) + ')', 'error');
                        return;
                    }

                    // Proceed with save
                    doSaveExpense(null, data);
                });
            } else {
                // Editing existing expense - just save
                doSaveExpense(id, data);
            }
        }

        function doSaveExpense(id, data) {
            var url = id ? '/expenses/' + id : '/expenses';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function () {
                showAlert(id ? 'Updated!' : 'Saved!');
                clearExpenseForm();
                loadExpenses();
                loadDashboard();
            });
        }

        function deleteExpense(id) {
            if (!confirm('Delete?')) return;
            api('/expenses/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Deleted');
                loadExpenses();
            });
        }

        function clearExpenseForm() {
            document.getElementById('expId').value = '';
            document.getElementById('expDesc').value = '';
            document.getElementById('expAmt').value = '';
        }

        // Bills
        function loadBills() {
            var yearSel = document.getElementById('billY');
            if (yearSel.options.length === 0) {
                for (var y = 2022; y <= 2035; y++) {
                    yearSel.innerHTML += '<option value="' + y + '">' + y + '</option>';
                }
                yearSel.value = new Date().getFullYear();
            }
            updateBillNumber();
            api('/bills').then(function (bills) {
                document.getElementById('billTable').innerHTML = bills.map(function (b) {
                    return '<tr class="clickable" onclick="viewBill(\'' + b.billNumber + '\')"><td><strong>' + b.billNumber + '</strong>' + (b.isNew ? ' <span class="badge badge-new">NEW</span>' : '') + '</td><td>' + b.period + ' ' + b.year + '</td><td>' + fmt(b.amountDue) + '</td><td class="amount-positive">' + fmt(b.paidAmount) + '</td><td class="' + (b.outstanding > 0 ? 'amount-negative' : '') + '">' + fmt(b.outstanding) + '</td><td><span class="badge badge-' + (b.outstanding === 0 ? 'paid' : b.paidAmount > 0 ? 'partial' : 'unpaid') + '">' + (b.outstanding === 0 ? 'Paid' : b.paidAmount > 0 ? 'Partial' : 'Unpaid') + '</span></td><td class="no-print" onclick="event.stopPropagation()"><button class="btn btn-warning btn-sm" onclick="editBill(\'' + b.billNumber + '\')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteBill(\'' + b.billNumber + '\')">üóëÔ∏è</button></td></tr>';
                }).join('');
            });
        }

        function updateBillNumber() {
            var q = document.getElementById('billQ').value;
            var y = document.getElementById('billY').value;
            var n = q === 'Q1' ? 1 : q === 'Q2' ? 2 : q === 'Q3' ? 3 : 4;
            document.getElementById('billNum').value = q + '-' + y + '-00' + n;
        }

        document.getElementById('billQ').addEventListener('change', updateBillNumber);
        document.getElementById('billY').addEventListener('change', updateBillNumber);

        function editBill(bn) {
            api('/bills').then(function (bills) {
                var b = bills.find(function (x) { return x.billNumber === bn; });
                if (b) {
                    document.getElementById('billEditMode').value = 'edit';
                    document.getElementById('billOldNumber').value = bn;
                    document.getElementById('billQ').value = b.quarter;
                    document.getElementById('billY').value = b.year;
                    document.getElementById('billP').value = b.period;
                    updateBillNumber();
                    updateCalcDisplays();
                }
            });
        }

        function saveBill() {
            var em = document.getElementById('billEditMode').value;
            var old = document.getElementById('billOldNumber').value;
            var q = document.getElementById('billQ').value;
            var y = parseInt(document.getElementById('billY').value);
            var p = document.getElementById('billP').value;
            var calc = calcAmounts();
            var amountDue = calc.net; // Use calculated net amount from CONFIG
            var bn = document.getElementById('billNum').value;

            if (em === 'edit') {
                api('/bills/' + old, { method: 'PUT', body: JSON.stringify({ quarter: q, year: y, period: p, amountDue: amountDue }) }).then(function () {
                    showAlert('Updated!');
                    clearBillForm();
                    loadBills();
                    loadDashboard();
                });
            } else {
                api('/bills', { method: 'POST', body: JSON.stringify({ billNumber: bn, quarter: q, year: y, period: p, amountDue: amountDue, paidAmount: 0, outstanding: amountDue, isNew: true }) }).then(function () {
                    showAlert('Created!');
                    clearBillForm();
                    loadBills();
                    loadDashboard();
                });
            }
        }

        function deleteBill(bn) {
            if (!confirm('Delete ' + bn + '?')) return;
            api('/bills/' + bn, { method: 'DELETE' }).then(function () {
                showAlert('Deleted');
                loadBills();
                loadDashboard();
            });
        }

        function clearBillForm() {
            document.getElementById('billEditMode').value = '';
            document.getElementById('billOldNumber').value = '';
            document.getElementById('billY').value = new Date().getFullYear();
            updateBillNumber();
            updateCalcDisplays();
        }

        // View Bill as Invoice
        function viewBill(bn) {
            api('/bills/' + bn).then(function (b) {
                var rate = CONFIG.monthlyRate; // Monthly rate from settings
                var grossAmount = rate * CONFIG.months; // Quarterly gross
                var taxPercent = Math.round(CONFIG.taxRate * 100); // Tax percentage for display
                var taxAmount = Math.round(grossAmount * CONFIG.taxRate); // Tax amount
                var netAmount = grossAmount - taxAmount; // Net amount due per quarter
                var advancePayment = b.paidAmount;
                var totalDue = netAmount - advancePayment; // Outstanding after payments
                var qInfo = QUARTERS[b.quarter] || { months: b.period };
                var paymentNum = b.quarter === 'Q1' ? 1 : b.quarter === 'Q2' ? 2 : b.quarter === 'Q3' ? 3 : 4;
                var billDate = b.createdAt ? formatDateLong(b.createdAt) : formatDateLong(new Date());

                var invoiceHtml = '<div id="invoicePrint" style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto;">' +
                    '<div style="text-align: center; background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0;">' +
                    '<h1 style="margin: 0; font-size: 24px;">GHOUENZEN Soulemanou</h1>' +
                    '<p style="margin: 5px 0 0; font-size: 14px;">B.P 36 Mankon-Bamenda</p>' +
                    '<p style="margin: 3px 0 0; font-size: 14px;">Tel: 675299868</p>' +
                    '<p style="margin: 3px 0 0; font-size: 12px;">Account No. ' + CONFIG.accountNo + '</p>' +
                    '</div>' +
                    '<div style="border: 1px solid #ddd; border-top: none; padding: 20px;">' +
                    '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                    '<tr style="background: #2c5282; color: white;"><td colspan="4" style="padding: 8px; text-align: center; font-weight: bold;">BILLING PERIOD SELECTION</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 25%;">Billing Period:</td><td colspan="3" style="padding: 8px; border: 1px solid #ddd;">' + b.period + '</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Year:</td><td style="padding: 8px; border: 1px solid #ddd;">' + b.year + '</td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Quarter:</td><td style="padding: 8px; border: 1px solid #ddd; background: #2c5282; color: white; text-align: center;">' + b.quarter + '</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Payment Number:</td><td style="padding: 8px; border: 1px solid #ddd;">' + paymentNum + '</td><td colspan="2"></td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Bill Date:</td><td colspan="3" style="padding: 8px; border: 1px solid #ddd;">' + billDate + '</td></tr>' +
                    '</table>' +
                    '<div style="background: #38a169; color: white; text-align: center; padding: 8px; font-weight: bold;">GENERATED BILL NUMBER</div>' +
                    '<div style="background: #c6f6d5; text-align: center; padding: 15px; font-size: 22px; font-weight: bold; color: #276749; border: 2px solid #38a169;">BILL NO.' + b.billNumber + '</div>' +
                    '<div style="margin: 20px 0; font-style: italic;">' +
                    '<p><strong>The General Manager,</strong></p>' +
                    '<p>Cameroon Postal Services</p>' +
                    '<p>B.P 1441 Yaound√©.</p>' +
                    '</div>' +
                    '<p style="margin: 20px 0;"><strong>Sir,</strong></p>' +
                    '<p style="margin-bottom: 20px;">In accordance with the contract de bail No.00000/9/MTP/G10 of 18th April 1991, I hereby present the rent bill for period of:</p>' +
                    '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                    '<tr style="background: #2c5282; color: white;"><td colspan="2" style="padding: 10px; text-align: center; font-weight: bold;">BILL DETAILS</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 35%;">Bill Date</td><td style="padding: 8px; border: 1px solid #ddd;">' + billDate + '</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Tenant Name</td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">CAMPOST MANKON</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Property Address</td><td style="padding: 8px; border: 1px solid #ddd;">B.P 36 Mankon-Bamenda</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Bill Number</td><td style="padding: 8px; border: 1px solid #ddd; background: #ebf8ff; color: #2c5282; font-weight: bold;">' + b.billNumber + '</td></tr>' +
                    '</table>' +
                    '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                    '<tr style="background: #d69e2e; color: white;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Description</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Qty (months)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Rate (XAF)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Amount (XAF)</th></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd;">Rent for ' + b.quarter + ' (' + qInfo.months + ')</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">' + CONFIG.months + '</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + fmt(rate) + '</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + fmt(grossAmount) + '</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd;">Less ' + taxPercent + '% Tax</td><td style="padding: 8px; border: 1px solid #ddd;"></td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + taxPercent + '%</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #e53e3e;">-' + fmt(taxAmount) + '</td></tr>' +
                    '<tr style="background: #f7fafc;"><td colspan="3" style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Net Amount (After Tax)</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">' + fmt(netAmount) + '</td></tr>' +
                    '<tr><td style="padding: 8px; border: 1px solid #ddd;">Less Advance Payment</td><td colspan="2" style="padding: 8px; border: 1px solid #ddd;"></td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #38a169;">-' + fmt(advancePayment) + '</td></tr>' +
                    '<tr style="background: #2c5282; color: white;"><td colspan="3" style="padding: 10px; font-weight: bold; text-align: center;">TOTAL AMOUNT DUE</td><td style="padding: 10px; text-align: right; font-weight: bold; font-size: 18px;">' + fmt(totalDue) + '</td></tr>' +
                    '</table>' +
                    '<p style="text-align: center; color: #e53e3e; font-style: italic; font-weight: bold;">(' + numberToWords(netAmount) + ' francs CFA.)</p>' +
                    '<div style="margin-top: 40px;">' +
                    '<p><strong>Signature:</strong></p>' +
                    '<div style="margin-top: 10px; border-bottom: 1px solid #333; width: 200px; height: 50px;"></div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="btn-group no-print" style="margin-top: 15px;">' +
                    '<button class="btn btn-primary" onclick="printInvoice()">üñ®Ô∏è Print Invoice</button>' +
                    '<button class="btn btn-outline" onclick="closeBillModal()">Close</button>' +
                    '</div>';

                document.getElementById('billModalBody').innerHTML = invoiceHtml;
                document.getElementById('billModal').classList.add('active');
            });
        }

        function closeBillModal() {
            document.getElementById('billModal').classList.remove('active');
        }

        function printInvoice() {
            var content = document.getElementById('invoicePrint').innerHTML;
            var w = window.open('', '_blank');
            w.document.write('<html><head><title>Rent Invoice</title><style>body{font-family:Arial,sans-serif;padding:20px;margin:0;}table{width:100%;border-collapse:collapse;}td,th{padding:8px;border:1px solid #ddd;}@media print{body{padding:10px;}}</style></head><body>' + content + '</body></html>');
            w.document.close();
            w.print();
        }

        // Payments
        function loadPayments() {
            api('/bills').then(function (bills) {
                document.getElementById('payBill').innerHTML = '<option value="">-- Select --</option>' + bills.map(function (b) {
                    return '<option value="' + b.billNumber + '">' + b.billNumber + ' - ' + b.period + ' ' + b.year + ' (' + fmt(b.outstanding) + ' due)</option>';
                }).join('');
            });
            if (!document.getElementById('payDate').value) {
                document.getElementById('payDate').valueAsDate = new Date();
            }
            api('/payments').then(function (payments) {
                document.getElementById('payTable').innerHTML = payments.map(function (p) {
                    return '<tr><td>' + fmtDate(p.date) + '</td><td>' + p.billNumber + '</td><td>' + p.period + ' ' + p.year + '</td><td class="amount-positive">+' + fmt(p.amount) + '</td><td>' + (p.reference || '-') + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editPayment(' + p.id + ')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deletePayment(' + p.id + ')">üóëÔ∏è</button></td></tr>';
                }).join('') || '<tr><td colspan="6">No payments</td></tr>';
            });
        }

        document.getElementById('payBill').addEventListener('change', function () {
            var bn = this.value;
            if (bn) {
                api('/bills').then(function (bills) {
                    var b = bills.find(function (x) { return x.billNumber === bn; });
                    if (b) document.getElementById('payOut').value = fmt(b.outstanding) + ' XAF';
                });
            }
        });

        function editPayment(id) {
            api('/payments/' + id).then(function (p) {
                document.getElementById('payId').value = id;
                document.getElementById('payBill').value = p.billNumber;
                document.getElementById('payAmt').value = p.amount;
                document.getElementById('payDate').value = p.date.split('T')[0];
                document.getElementById('payRef').value = p.reference || '';
            });
        }

        function savePayment() {
            var id = document.getElementById('payId').value;
            var data = {
                billNumber: document.getElementById('payBill').value,
                amount: parseInt(document.getElementById('payAmt').value),
                date: document.getElementById('payDate').value,
                reference: document.getElementById('payRef').value
            };
            if (!data.billNumber || !data.amount) {
                showAlert('Fill required fields', 'error');
                return;
            }
            var url = id ? '/payments/' + id : '/payments';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function () {
                showAlert(id ? 'Updated!' : 'Saved!');
                clearPaymentForm();
                loadPayments();
                loadBills();
                loadDashboard();
            });
        }

        function deletePayment(id) {
            if (!confirm('Delete?')) return;
            api('/payments/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Deleted');
                loadPayments();
                loadBills();
                loadDashboard();
            });
        }

        function clearPaymentForm() {
            document.getElementById('payId').value = '';
            document.getElementById('payBill').value = '';
            document.getElementById('payOut').value = '';
            document.getElementById('payAmt').value = '';
            document.getElementById('payRef').value = '';
        }

        // Inheritance
        function loadInheritance() {
            // First load all heirs for the beneficiary selection
            api('/heirs').then(function (allHeirs) {
                loadCampostBeneficiaryList(allHeirs);

                // Get selected beneficiaries
                var selectedIds = getCampostBeneficiaries();

                // Calculate inheritance only for selected beneficiaries
                api('/inheritance/calculate').then(function (d) {
                    // Filter heirs to only include selected beneficiaries
                    var beneficiaries = d.heirs.filter(function (h) {
                        return selectedIds.length === 0 || selectedIds.includes(h.id);
                    });

                    // If NO beneficiaries are selected, show none (unless selection is empty which might mean 'show all' initially)
                    // But in this logic, if we want strict selection-based calculation:
                    // If selection list exists but nothing checked, beneficiaries will be empty.

                    // Islamic Inheritance Calculation logic (frontend version)
                    var fixedHeirs = beneficiaries.filter(function (h) { return parseFloat(h.portions) < 1; });
                    var residuaryHeirs = beneficiaries.filter(function (h) { return parseFloat(h.portions) >= 1; });

                    var fixedTotalAmount = 0;
                    fixedHeirs.forEach(function (h) { fixedTotalAmount += d.inheritanceAmount * parseFloat(h.portions); });

                    var residueAmount = Math.max(0, d.inheritanceAmount - fixedTotalAmount);
                    var totalResiduaryPortions = residuaryHeirs.reduce(function (sum, h) { return sum + parseFloat(h.portions); }, 0);
                    var sharePerPortion = totalResiduaryPortions > 0 ? residueAmount / totalResiduaryPortions : 0;

                    document.getElementById('inhAmt').textContent = fmt(d.inheritanceAmount) + ' XAF';
                    document.getElementById('inhPaid').textContent = fmt(d.totalBillsPaid);
                    document.getElementById('inhExp').textContent = fmt(d.totalExpenses);
                    document.getElementById('inhRes').textContent = fmt(d.reserveFunds);
                    document.getElementById('inhPortions').textContent = totalResiduaryPortions; // Now shows residuary portions
                    document.getElementById('inhPer').textContent = fmt(Math.round(sharePerPortion));

                    // Calculate group summary for beneficiaries
                    var groupSummary = {};
                    beneficiaries.forEach(function (h) {
                        if (!groupSummary[h.heir_group]) {
                            groupSummary[h.heir_group] = { count: 0, totalShare: 0 };
                        }
                        var share = parseFloat(h.portions) < 1 ?
                            (d.inheritanceAmount * parseFloat(h.portions)) :
                            (parseFloat(h.portions) * sharePerPortion);
                        groupSummary[h.heir_group].count++;
                        groupSummary[h.heir_group].totalShare += share;
                    });

                    var html = '';
                    for (var g in groupSummary) {
                        var i = groupSummary[g];
                        html += '<div class="heir-group"><h4>' + g + ' <span>' + i.count + '</span></h4><div class="summary-row"><span>Per heir:</span><span>' + fmt(Math.round(i.totalShare / i.count)) + ' XAF</span></div><div class="summary-row"><span>Total:</span><span>' + fmt(Math.round(i.totalShare)) + ' XAF</span></div></div>';
                    }
                    document.getElementById('heirGroups').innerHTML = html || '<p>No beneficiaries selected</p>';

                    var isAdmin = currentUser && currentUser.role === 'admin';
                    document.getElementById('heirTable').innerHTML = beneficiaries.map(function (h) {
                        var share = parseFloat(h.portions) < 1 ?
                            (d.inheritanceAmount * parseFloat(h.portions)) :
                            (parseFloat(h.portions) * sharePerPortion);
                        var actionsHtml = isAdmin ? '<td class="no-print"><button class="btn btn-gold btn-sm" onclick="printHeirCertificate(' + h.id + ')">üìú</button> <button class="btn btn-warning btn-sm" onclick="editHeir(' + h.id + ')">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteHeir(' + h.id + ')">üóëÔ∏è</button></td>' : '';
                        return '<tr><td>' + h.name + '</td><td>' + h.relationship + '</td><td>' + h.heir_group + '</td><td>' + h.portions + '</td><td class="amount-positive">' + fmt(Math.round(share)) + '</td>' + actionsHtml + '</tr>';
                    }).join('') || '<tr><td colspan="6">No beneficiaries selected</td></tr>';
                });
            });
        }

        // Load CAMPOST beneficiary selection list
        function loadCampostBeneficiaryList(heirs) {
            var selectedIds = getCampostBeneficiaries();
            var html = heirs.map(function (h) {
                var isSelected = selectedIds.length === 0 || selectedIds.includes(h.id);
                return '<div class="beneficiary-item ' + (isSelected ? 'selected' : '') + '">' +
                    '<input type="checkbox" id="campost-ben-' + h.id + '" ' + (isSelected ? 'checked' : '') + ' onchange="toggleCampostBeneficiary(' + h.id + ', this.checked)">' +
                    '<label for="campost-ben-' + h.id + '">' + h.name + '</label>' +
                    '<span class="heir-info">' + h.relationship + '</span>' +
                    '<span class="heir-portions">' + h.portions + ' portions</span>' +
                    '</div>';
            }).join('');
            document.getElementById('campostBeneficiaryList').innerHTML = html || '<p>No heirs available</p>';
        }

        // Get selected CAMPOST beneficiaries from API
        var campostBeneficiariesCache = [];
        function getCampostBeneficiaries() {
            return campostBeneficiariesCache;
        }

        function loadCampostBeneficiariesFromAPI() {
            return api('/campost/beneficiaries').then(function (ids) {
                campostBeneficiariesCache = ids || [];
                return campostBeneficiariesCache;
            }).catch(function () {
                campostBeneficiariesCache = [];
                return [];
            });
        }

        // Toggle CAMPOST beneficiary selection
        function toggleCampostBeneficiary(id, checked) {
            var el = document.querySelector('#campost-ben-' + id).closest('.beneficiary-item');
            if (checked) {
                el.classList.add('selected');
                if (!campostBeneficiariesCache.includes(id)) {
                    campostBeneficiariesCache.push(id);
                }
            } else {
                el.classList.remove('selected');
                var index = campostBeneficiariesCache.indexOf(id);
                if (index > -1) {
                    campostBeneficiariesCache.splice(index, 1);
                }
            }
            // Reactive save and update
            saveCampostBeneficiaries();
        }

        // Select/Deselect all CAMPOST beneficiaries
        function selectAllCampostBeneficiaries(selectAll) {
            var checkboxes = document.querySelectorAll('#campostBeneficiaryList input[type="checkbox"]');
            campostBeneficiariesCache = [];
            checkboxes.forEach(function (cb) {
                cb.checked = selectAll;
                var id = parseInt(cb.id.replace('campost-ben-', ''));
                var el = cb.closest('.beneficiary-item');
                if (selectAll) {
                    el.classList.add('selected');
                    campostBeneficiariesCache.push(id);
                } else {
                    el.classList.remove('selected');
                }
            });
            // Reactive save and update
            saveCampostBeneficiaries();
        }

        // Save CAMPOST beneficiary selection to PostgreSQL
        function saveCampostBeneficiaries() {
            var checkboxes = document.querySelectorAll('#campostBeneficiaryList input[type="checkbox"]:checked');
            var selectedIds = Array.from(checkboxes).map(function (cb) {
                return parseInt(cb.id.replace('campost-ben-', ''));
            });

            api('/campost/beneficiaries', {
                method: 'POST',
                body: JSON.stringify({ selectedIds: selectedIds })
            }).then(function () {
                campostBeneficiariesCache = selectedIds;
                loadInheritance();
            }).catch(function (err) {
                showAlert('Error saving beneficiaries: ' + err.message, 'error');
            });
        }

        // Reset CAMPOST heirs to default family members
        function resetCampostHeirsToDefaults() {
            if (!confirm('This will delete all current heirs and reset to the default 16 family members. Continue?')) return;

            api('/heirs/reset-defaults', { method: 'POST' }).then(function (result) {
                if (result.success) {
                    // Clear beneficiary selection via API
                    api('/campost/beneficiaries', {
                        method: 'POST',
                        body: JSON.stringify({ selectedIds: [] })
                    }).then(function () {
                        campostBeneficiariesCache = [];
                        showAlert('Heirs reset to default family members (' + result.count + ' heirs)');
                        loadInheritance();
                    });
                } else {
                    showAlert('Error resetting heirs', 'error');
                }
            }).catch(function (err) {
                showAlert('Error: ' + err.message, 'error');
            });
        }

        function openHeirModal() { document.getElementById('heirModal').classList.add('active'); }
        function closeHeirModal() {
            document.getElementById('heirModal').classList.remove('active');
            document.getElementById('heirId').value = '';
            document.getElementById('heirName').value = '';
        }

        function editHeir(id) {
            api('/heirs').then(function (heirs) {
                var h = heirs.find(function (x) { return x.id === id; });
                if (h) {
                    document.getElementById('heirId').value = id;
                    document.getElementById('heirName').value = h.name;
                    document.getElementById('heirRel').value = h.relationship;
                    document.getElementById('heirGrp').value = h.heir_group;
                    document.getElementById('heirPor').value = h.portions;
                    openHeirModal();
                }
            });
        }

        function saveHeir() {
            var id = document.getElementById('heirId').value;
            var data = {
                name: document.getElementById('heirName').value,
                relationship: document.getElementById('heirRel').value,
                heirGroup: document.getElementById('heirGrp').value,
                portions: parseFloat(document.getElementById('heirPor').value)
            };
            if (!data.name) { showAlert('Enter name', 'error'); return; }
            var url = id ? '/heirs/' + id : '/heirs';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function () {
                showAlert(id ? 'Updated!' : 'Added!');
                closeHeirModal();
                loadInheritance();
            });
        }

        function deleteHeir(id) {
            if (!confirm('Delete?')) return;
            api('/heirs/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Deleted');
                loadInheritance();
            });
        }

        // Heir Certificates
        function printHeirCertificate(heirId) {
            api('/inheritance/calculate').then(function (d) {
                var h = d.heirs.find(function (x) { return x.id === heirId; });
                if (!h) { showAlert('Heir not found', 'error'); return; }
                var certHtml = generateCertificateHTML(h, d);
                var w = window.open('', '_blank');
                w.document.write(certHtml);
                w.document.close();
                w.print();
            });
        }

        function printAllHeirCertificates() {
            api('/inheritance/calculate').then(function (d) {
                if (d.heirs.length === 0) { showAlert('No heirs', 'error'); return; }
                var allCerts = '<html><head><title>Certificates</title><style>@page{size:A5;margin:10mm;}body{font-family:Georgia,serif;margin:0;padding:0;}.certificate{page-break-after:always;padding:15mm;border:3px double #1a365d;margin:5mm;}.certificate:last-child{page-break-after:auto;}.cert-header{text-align:center;border-bottom:2px solid #d69e2e;padding-bottom:10px;margin-bottom:15px;}.cert-header h1{color:#1a365d;font-size:20px;margin:0;}.heir-name{text-align:center;font-size:24px;color:#1a365d;font-weight:bold;margin:20px 0;padding:10px;background:linear-gradient(135deg,rgba(214,158,46,0.1),rgba(237,137,54,0.1));border-radius:8px;}.cert-details{margin:15px 0;}.detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dotted #ccc;}.share-amount{text-align:center;margin:20px 0;padding:15px;background:#1a365d;color:white;border-radius:8px;}.share-amount strong{font-size:28px;color:#d69e2e;}.signature-line{margin-top:30px;display:flex;justify-content:space-between;}.sig-block{text-align:center;width:40%;}.sig-line{border-top:1px solid #333;margin-top:40px;padding-top:5px;}</style></head><body>';
                d.heirs.forEach(function (h) { allCerts += generateCertificateBody(h, d); });
                allCerts += '</body></html>';
                var w = window.open('', '_blank');
                w.document.write(allCerts);
                w.document.close();
                w.print();
            });
        }

        function generateCertificateHTML(h, d) {
            return '<html><head><title>Certificate - ' + h.name + '</title><style>body{font-family:Georgia,serif;margin:0;padding:20mm;}.certificate{padding:20mm;border:3px double #1a365d;}.cert-header{text-align:center;border-bottom:2px solid #d69e2e;padding-bottom:15px;margin-bottom:20px;}.cert-header h1{color:#1a365d;font-size:24px;margin:0;}.heir-name{text-align:center;font-size:28px;color:#1a365d;font-weight:bold;margin:25px 0;padding:15px;background:linear-gradient(135deg,rgba(214,158,46,0.1),rgba(237,137,54,0.1));border-radius:10px;}.cert-details{margin:20px 0;}.detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dotted #ccc;}.share-amount{text-align:center;margin:25px 0;padding:20px;background:#1a365d;color:white;border-radius:10px;}.share-amount strong{font-size:32px;color:#d69e2e;}.signature-line{margin-top:40px;display:flex;justify-content:space-between;}.sig-block{text-align:center;width:40%;}.sig-line{border-top:1px solid #333;margin-top:50px;padding-top:5px;}</style></head><body>' + generateCertificateBody(h, d) + '</body></html>';
        }

        function generateCertificateBody(h, d) {
            return '<div class="certificate"><div class="cert-header"><h1>CAMPOST MANKON</h1><p style="color:#666;font-size:12px;">GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868</p></div><div style="text-align:center;margin:15px 0;"><h2 style="color:#d69e2e;font-size:18px;">üìú INHERITANCE SHARE CERTIFICATE</h2></div><p style="text-align:center;color:#666;font-size:12px;">This certifies that the following heir is entitled to receive their share:</p><div class="heir-name">' + h.name + '</div><div class="cert-details"><div class="detail-row"><span>Relationship:</span><span style="font-weight:bold;">' + h.relationship + '</span></div><div class="detail-row"><span>Heir Group:</span><span style="font-weight:bold;">' + h.heir_group + '</span></div><div class="detail-row"><span>Portions:</span><span style="font-weight:bold;">' + h.portions + ' of ' + d.totalPortions + '</span></div><div class="detail-row"><span>Total Distribution:</span><span style="font-weight:bold;">' + fmt(d.inheritanceAmount) + ' XAF</span></div><div class="detail-row"><span>Per Portion:</span><span style="font-weight:bold;">' + fmt(d.sharePerPortion) + ' XAF</span></div></div><div class="share-amount"><p style="margin:0 0 5px;opacity:0.8;">ENTITLED SHARE AMOUNT</p><strong>' + fmt(Math.round(h.shareAmount)) + ' XAF</strong></div><div class="signature-line"><div class="sig-block"><div class="sig-line">Authorized Signature</div></div><div class="sig-block"><div class="sig-line">Heir Signature</div></div></div><p style="text-align:center;margin-top:20px;font-size:10px;color:#666;">Generated on ' + today() + '</p></div>';
        }

        // Export functions
        function exportCSV(type) {
            var h = 'CAMPOST MANKON - GHOUENZEN Soulemanou\nB.P 36 Mankon-Bamenda | Tel: 675299868\n\n';
            if (type === 'bills') {
                api('/bills').then(function (d) {
                    var csv = h + 'Bill Number,Quarter,Period,Year,Due,Paid,Outstanding,Status\n';
                    d.forEach(function (b) { csv += b.billNumber + ',' + b.quarter + ',' + b.period + ',' + b.year + ',' + b.amountDue + ',' + b.paidAmount + ',' + b.outstanding + ',' + (b.outstanding === 0 ? 'Paid' : 'Outstanding') + '\n'; });
                    download(csv, 'campost_bills.csv');
                });
            } else if (type === 'payments') {
                api('/payments').then(function (d) {
                    var csv = h + 'Date,Bill,Period,Year,Amount,Reference\n';
                    d.forEach(function (p) { csv += p.date + ',' + p.billNumber + ',' + p.period + ',' + p.year + ',' + p.amount + ',"' + (p.reference || '') + '"\n'; });
                    download(csv, 'campost_payments.csv');
                });
            } else if (type === 'expenses') {
                api('/expenses').then(function (d) {
                    var csv = h + 'Date,Description,Category,Amount\n';
                    d.forEach(function (e) { csv += e.date + ',"' + e.description + '",' + e.categoryName + ',' + e.amount + '\n'; });
                    download(csv, 'campost_expenses.csv');
                });
            } else if (type === 'ledger') {
                Promise.all([api('/bills'), api('/expenses')]).then(function (results) {
                    var bills = results[0];
                    var expenses = results[1];
                    var csv = h + 'Date,Description,Type,Status,Income,Expense,Balance\n';

                    var ledgerEntries = [];
                    // Add bills with payments (paid or partial)
                    bills.forEach(function (b) {
                        if (b.paidAmount > 0) {
                            var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                            ledgerEntries.push({
                                date: b.createdAt || new Date().toISOString(),
                                description: 'Bill ' + b.billNumber + ' - ' + b.period + ' ' + b.year,
                                type: 'Income',
                                status: status,
                                income: b.paidAmount,
                                expense: 0
                            });
                        }
                    });
                    expenses.forEach(function (e) {
                        ledgerEntries.push({ date: e.date, description: e.description, type: e.categoryName, status: '', income: 0, expense: e.amount });
                    });
                    ledgerEntries.sort(function (a, b) { return new Date(a.date) - new Date(b.date); });

                    var balance = 0;
                    ledgerEntries.forEach(function (entry) {
                        balance += entry.income - entry.expense;
                        csv += (entry.date ? entry.date.split('T')[0] : '') + ',"' + entry.description + '",' + entry.type + ',' + entry.status + ',' + entry.income + ',' + entry.expense + ',' + balance + '\n';
                    });
                    download(csv, 'campost_ledger.csv');
                });
            }
        }

        function exportAllCSV() {
            api('/export/all').then(function (all) {
                var csv = 'CAMPOST MANKON - GHOUENZEN Soulemanou\nB.P 36 Mankon-Bamenda | Tel: 675299868\n';
                csv += '\nSUMMARY\nTotal Bills Paid: ' + all.summary.totalBillsPaid + '\nTotal Expenses: ' + all.summary.totalExpenses + '\nReserve Funds: ' + all.summary.reserveFunds + '\n';
                csv += '\n\nBILLS\nBill Number,Period,Year,Amount Due,Paid,Outstanding\n';
                all.bills.forEach(function (b) { csv += b.bill_number + ',' + b.period + ',' + b.year + ',' + b.amount_due + ',' + b.paid_amount + ',' + b.outstanding + '\n'; });
                csv += '\n\nPAYMENTS\nDate,Bill,Amount,Reference\n';
                all.payments.forEach(function (p) { csv += p.payment_date + ',' + p.bill_number + ',' + p.amount + ',"' + (p.reference || '') + '"\n'; });
                csv += '\n\nEXPENSES\nDate,Description,Category,Amount\n';
                all.expenses.forEach(function (e) { csv += e.expense_date + ',"' + e.description + '",' + e.category_name + ',' + e.amount + '\n'; });
                csv += '\n\nHEIRS\nName,Relationship,Group,Portions\n';
                all.heirs.forEach(function (h) { csv += h.name + ',' + h.relationship + ',' + h.heir_group + ',' + h.portions + '\n'; });
                download(csv, 'campost_all_data.csv');
            });
        }

        function exportPDF(type) {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('CAMPOST MANKON', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868', 105, 22, { align: 'center' });
            doc.line(20, 25, 190, 25);

            if (type === 'bills') {
                api('/bills').then(function (d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('BILLS REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Bill #', 'Period', 'Year', 'Due', 'Paid', 'Outstanding']], body: d.map(function (b) { return [b.billNumber, b.period, b.year, fmt(b.amountDue), fmt(b.paidAmount), fmt(b.outstanding)]; }), styles: { fontSize: 8 } });
                    doc.save('campost_bills.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'payments') {
                api('/payments').then(function (d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PAYMENTS REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Date', 'Bill #', 'Period', 'Amount', 'Reference']], body: d.map(function (p) { return [fmtDate(p.date), p.billNumber, p.period + ' ' + p.year, fmt(p.amount), p.reference || '-']; }), styles: { fontSize: 8 } });
                    doc.save('campost_payments.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'expenses') {
                api('/expenses').then(function (d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('EXPENSES REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Date', 'Description', 'Category', 'Amount']], body: d.map(function (e) { return [fmtDate(e.date), e.description.substring(0, 35), e.categoryName, fmt(e.amount)]; }), styles: { fontSize: 8 } });
                    doc.save('campost_expenses.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'ledger') {
                Promise.all([api('/bills'), api('/expenses')]).then(function (results) {
                    var bills = results[0];
                    var expenses = results[1];

                    // Build ledger entries from bills with payments
                    var ledgerEntries = [];
                    bills.forEach(function (b) {
                        if (b.paidAmount > 0) {
                            var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                            ledgerEntries.push({
                                date: b.createdAt || new Date().toISOString(),
                                description: b.billNumber + ' - ' + b.period + ' ' + b.year,
                                type: 'Income (' + status + ')',
                                income: b.paidAmount,
                                expense: 0
                            });
                        }
                    });
                    expenses.forEach(function (e) {
                        ledgerEntries.push({
                            date: e.date,
                            description: e.description.substring(0, 30),
                            type: e.categoryName,
                            income: 0,
                            expense: e.amount
                        });
                    });

                    // Sort by date
                    ledgerEntries.sort(function (a, b) {
                        return new Date(a.date) - new Date(b.date);
                    });

                    // Calculate running balance
                    var runningBalance = 0;
                    var totalIncome = 0;
                    var totalExpense = 0;
                    var tableData = ledgerEntries.map(function (entry) {
                        if (entry.income > 0) {
                            runningBalance += entry.income;
                            totalIncome += entry.income;
                        }
                        if (entry.expense > 0) {
                            runningBalance -= entry.expense;
                            totalExpense += entry.expense;
                        }
                        return [
                            fmtDate(entry.date),
                            entry.description,
                            entry.type,
                            entry.income > 0 ? fmt(entry.income) : '-',
                            entry.expense > 0 ? fmt(entry.expense) : '-',
                            fmt(runningBalance)
                        ];
                    });

                    // Add totals row
                    tableData.push(['', '', 'TOTALS:', fmt(totalIncome), fmt(totalExpense), fmt(runningBalance)]);

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('LEDGER REPORT', 105, 35, { align: 'center' });
                    doc.setFontSize(9);
                    doc.text('Total Income: ' + fmt(totalIncome) + ' XAF | Total Expenses: ' + fmt(totalExpense) + ' XAF | Balance: ' + fmt(runningBalance) + ' XAF', 105, 42, { align: 'center' });
                    doc.autoTable({
                        startY: 48,
                        head: [['Date', 'Description', 'Type', 'Income', 'Expense', 'Balance']],
                        body: tableData,
                        styles: { fontSize: 7 },
                        headStyles: { fillColor: [44, 82, 130] },
                        footStyles: { fillColor: [247, 250, 252], textColor: [0, 0, 0], fontStyle: 'bold' }
                    });
                    doc.save('campost_ledger.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'heirs') {
                api('/inheritance/calculate').then(function (d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('INHERITANCE REPORT', 105, 35, { align: 'center' });
                    doc.setFontSize(10);
                    doc.text('Amount: ' + fmt(d.inheritanceAmount) + ' XAF | Per Portion: ' + fmt(d.sharePerPortion) + ' XAF', 105, 42, { align: 'center' });
                    doc.autoTable({ startY: 48, head: [['Name', 'Relationship', 'Group', 'Portions', 'Share']], body: d.heirs.map(function (h) { return [h.name, h.relationship, h.heir_group, h.portions, fmt(Math.round(h.shareAmount))]; }), styles: { fontSize: 8 } });
                    doc.save('campost_heirs.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'properties') {
                var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('FAMILY ESTATE PORTFOLIO', 105, 35, { align: 'center' });
                doc.setFontSize(9);
                doc.text('Total Properties: ' + properties.length + ' | Rented: ' + properties.filter(function (p) { return p.status === 'Rented'; }).length, 105, 42, { align: 'center' });
                doc.autoTable({
                    startY: 48,
                    head: [['Property', 'Location', 'Type', 'Status', 'Income', 'Islamic Inh.']],
                    body: properties.map(function (p) {
                        return [p.name, p.location, p.type, p.status, p.status === 'Rented' ? fmt(p.rent_amount) : '0', p.islamic_inheritance || 'NA'];
                    }),
                    styles: { fontSize: 7 },
                    headStyles: { fillColor: [44, 82, 130] }
                });
                doc.save('family_properties.pdf');
                showAlert('PDF exported!');
            } else if (type === 'rentalIncome') {
                var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
                var rentedProps = properties.filter(function (p) { return p.status === 'Rented'; });
                var totalGross = 0, totalTax = 0, totalNet = 0;

                var tableData = rentedProps.map(function (p) {
                    var rent = parseFloat(p.rent_amount) || 0;
                    var taxRate = parseFloat(p.tax_rate) || 0;
                    var taxAmt = rent * taxRate / 100;
                    var net = rent - taxAmt;
                    totalGross += rent;
                    totalTax += taxAmt;
                    totalNet += net;
                    return [p.name, p.location, fmt(rent), p.rent_period || 'Monthly', taxRate + '%', fmt(Math.round(taxAmt)), fmt(Math.round(net))];
                });
                tableData.push(['', '', 'TOTALS:', '', '', fmt(Math.round(totalTax)), fmt(Math.round(totalNet))]);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('RENTAL INCOME REPORT', 105, 35, { align: 'center' });
                doc.setFontSize(9);
                doc.text('Gross: ' + fmt(Math.round(totalGross)) + ' XAF | Tax: ' + fmt(Math.round(totalTax)) + ' XAF | Net: ' + fmt(Math.round(totalNet)) + ' XAF', 105, 42, { align: 'center' });
                doc.autoTable({
                    startY: 48,
                    head: [['Property', 'Location', 'Rent', 'Period', 'Tax Rate', 'Tax Amount', 'Net Income']],
                    body: tableData,
                    styles: { fontSize: 7 },
                    headStyles: { fillColor: [214, 158, 46] }
                });
                doc.save('rental_income.pdf');
                showAlert('PDF exported!');
            } else if (type === 'reLedger') {
                var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
                var rentedProps = properties.filter(function (p) { return p.status === 'Rented'; });
                var totalIncome = 0;

                var tableData = rentedProps.map(function (p) {
                    var rent = parseFloat(p.rent_amount) || 0;
                    var taxRate = parseFloat(p.tax_rate) || 0;
                    var net = rent - (rent * taxRate / 100);
                    totalIncome += net;
                    return [fmtDate(new Date()), p.name, 'Rental Income (' + (p.rent_period || 'Monthly') + ')', 'Income', fmt(Math.round(net)), '-', fmt(Math.round(totalIncome))];
                });

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REAL ESTATE LEDGER', 105, 35, { align: 'center' });
                doc.autoTable({
                    startY: 42,
                    head: [['Date', 'Property', 'Description', 'Type', 'Income', 'Expense', 'Balance']],
                    body: tableData,
                    styles: { fontSize: 7 },
                    headStyles: { fillColor: [44, 82, 130] }
                });
                doc.save('real_estate_ledger.pdf');
                showAlert('PDF exported!');
            }
        }

        function exportAllPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            Promise.all([api('/export/all'), api('/inheritance/calculate')]).then(function (results) {
                var all = results[0];
                var inh = results[1];
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('CAMPOST MANKON', 105, 15, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868', 105, 22, { align: 'center' });
                doc.line(20, 25, 190, 25);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('FINANCIAL SUMMARY', 20, 33);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Bills Paid: ' + fmt(all.summary.totalBillsPaid) + ' | Expenses: ' + fmt(all.summary.totalExpenses) + ' | Reserve: ' + fmt(all.summary.reserveFunds), 20, 40);
                doc.text('BILLS', 20, 50);
                doc.autoTable({ startY: 53, head: [['Bill #', 'Period', 'Year', 'Due', 'Paid', 'Outstanding']], body: all.bills.map(function (b) { return [b.bill_number, b.period, b.year, fmt(b.amount_due), fmt(b.paid_amount), fmt(b.outstanding)]; }), styles: { fontSize: 7 } });
                doc.addPage();
                doc.setFont('helvetica', 'bold');
                doc.text('PAYMENTS', 20, 15);
                doc.autoTable({ startY: 18, head: [['Date', 'Bill', 'Amount', 'Reference']], body: all.payments.map(function (p) { return [p.payment_date ? p.payment_date.split('T')[0] : '', p.bill_number, fmt(p.amount), p.reference || '']; }), styles: { fontSize: 7 } });
                var y = doc.lastAutoTable.finalY + 10;
                doc.text('EXPENSES', 20, y);
                doc.autoTable({ startY: y + 3, head: [['Date', 'Description', 'Category', 'Amount']], body: all.expenses.map(function (e) { return [e.expense_date ? e.expense_date.split('T')[0] : '', e.description ? e.description.substring(0, 25) : '', e.category_name || '', fmt(e.amount)]; }), styles: { fontSize: 7 } });
                doc.addPage();
                doc.text('INHERITANCE (' + fmt(inh.inheritanceAmount) + ' XAF)', 20, 15);
                doc.autoTable({ startY: 20, head: [['Name', 'Relationship', 'Group', 'Portions', 'Share']], body: inh.heirs.map(function (h) { return [h.name, h.relationship, h.heir_group, h.portions, fmt(Math.round(h.shareAmount))]; }), styles: { fontSize: 7 } });
                doc.save('campost_complete_report.pdf');
                showAlert('Complete PDF exported!');
            });
        }

        function download(content, filename) {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content], { type: 'text/csv' }));
            a.download = filename;
            a.click();
            showAlert('Exported!');
        }

        function printPage(pageId) {
            document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('printing'); });
            document.getElementById(pageId).classList.add('printing');
            window.print();
        }

        // Settings
        function checkDb() {
            api('/status').then(function (s) {
                document.getElementById('dbStatus').textContent = s.connected ? '‚úì Connected' : '‚úó Offline';
                document.getElementById('dbStatus').className = 'db-status ' + (s.connected ? 'connected' : 'disconnected');
                document.getElementById('settingsAlert').className = 'alert alert-' + (s.connected ? 'success' : 'error');
                document.getElementById('settingsAlert').innerHTML = s.connected ? '‚úì PostgreSQL Connected' : '‚úó Offline';
            }).catch(function () {
                document.getElementById('dbStatus').textContent = '‚úó Offline';
                document.getElementById('dbStatus').className = 'db-status disconnected';
            });
        }

        function resetAll() {
            if (!confirm('RESET ALL DATA?')) return;
            api('/reset', { method: 'POST' }).then(function () {
                showAlert('Data reset!');
                loadDashboard();
            });
        }

        // ==========================================
        // FAMILY ESTATES MODULE
        // ==========================================

        // Show RE Tab
        function showRETab(tabId, btn) {
            document.querySelectorAll('#realestate .tab-content').forEach(function (t) { t.classList.remove('active'); });
            document.querySelectorAll('#realestate .tab-btn').forEach(function (b) { b.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            // Load data for specific tabs to populate dropdowns
            if (tabId === 'reBillsTab') {
                loadREBills();
            } else if (tabId === 'rePaymentsTab') {
                loadREPayments();
            } else if (tabId === 'reExpensesTab') {
                loadREExpenses();
            } else if (tabId === 'reInheritanceTab') {
                loadREInheritance();
            } else if (tabId === 'reLedgerTab') {
                loadRELedgerFull();
            } else if (tabId === 'reSettingsTab') {
                loadRESettings();
            }
        }

        // Load Real Estate Data
        function loadRealEstate() {
            api('/re/dashboard').then(function (data) {
                document.getElementById('reTotalProps').textContent = data.totalProperties;
                document.getElementById('reRented').textContent = data.rentedProperties;
                document.getElementById('reTotalIncome').textContent = fmt(Math.round(data.totalIncome));
                document.getElementById('reTotalExpenses').textContent = fmt(Math.round(data.totalExpenses));
                document.getElementById('reReservedFunds').textContent = fmt(Math.round(data.reservedFunds));
                document.getElementById('reNetBalance').textContent = fmt(Math.round(data.netBalance));

                // Check if expenses should be disabled
                updateExpenseFormState(data.netBalance);
            });

            // Load properties for table
            api('/properties').then(function (properties) {
                renderPropertiesTable(properties);
                renderRentalIncomeTable(properties);
            });

            // Also load tab-specific data
            loadREBills();
            loadREPayments();
            loadREExpenses();
        }

        // Enable/Disable expense form based on net balance
        function updateExpenseFormState(netBalance) {
            var expenseFields = [
                'reExpProperty',
                'reExpDate',
                'reExpCategory',
                'reExpAmount',
                'reExpDesc'
            ];
            var saveBtn = document.querySelector('#reExpensesTab .btn-success');
            var warningEl = document.getElementById('expenseWarning');

            if (netBalance <= 0) {
                // Disable all expense input fields
                expenseFields.forEach(function (id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.disabled = true;
                        el.style.backgroundColor = '#f0f0f0';
                        el.style.cursor = 'not-allowed';
                    }
                });

                // Disable save button
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.5';
                    saveBtn.style.cursor = 'not-allowed';
                }

                // Show warning message
                if (warningEl) {
                    warningEl.style.display = 'block';
                }
            } else {
                // Enable all expense input fields
                expenseFields.forEach(function (id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.disabled = false;
                        el.style.backgroundColor = '';
                        el.style.cursor = '';
                    }
                });

                // Enable save button
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = '';
                }

                // Hide warning message
                if (warningEl) {
                    warningEl.style.display = 'none';
                }
            }
        }

        // Render Properties Table - show ALL properties with zeros for non-rented
        function renderPropertiesTable(properties) {
            var filterStatus = document.getElementById('reStatusFilter').value;
            var filtered = filterStatus ? properties.filter(function (p) { return p.status === filterStatus; }) : properties;
            var isAdmin = currentUser && currentUser.role === 'admin';

            var html = filtered.map(function (p) {
                var isRented = p.status === 'Rented';
                var statusClass = isRented ? 'badge-income' : p.status === 'Sold' ? 'badge-paid' : p.status === 'For sale' ? 'badge-new' : 'badge-expense';

                // Non-rented: all financial fields are 0
                var rentAmount = isRented ? (parseFloat(p.rent_amount) || 0) : 0;
                var period = isRented ? (p.rent_period || 'Monthly') : '-';
                var taxRate = isRented ? (parseFloat(p.tax_rate) || 0) : 0;
                var taxAmount = rentAmount * taxRate / 100;
                var netIncome = rentAmount - taxAmount;

                var actionsHtml = isAdmin ?
                    '<td class="no-print">' +
                    '<button class="btn btn-warning btn-sm" onclick="editProperty(' + p.id + ')">‚úèÔ∏è</button> ' +
                    '<button class="btn btn-danger btn-sm" onclick="deleteProperty(' + p.id + ')">üóëÔ∏è</button>' +
                    '</td>' : '';

                return '<tr>' +
                    '<td><strong>' + p.name + '</strong></td>' +
                    '<td>' + p.location + '</td>' +
                    '<td>' + p.type + '</td>' +
                    '<td><span class="badge ' + statusClass + '">' + p.status + '</span></td>' +
                    '<td>' + fmt(rentAmount) + '</td>' +
                    '<td>' + period + '</td>' +
                    '<td>' + taxRate + '%</td>' +
                    '<td class="' + (netIncome > 0 ? 'amount-positive' : '') + '">' + fmt(Math.round(netIncome)) + '</td>' +
                    '<td>' + (p.islamic_inheritance || 'NA') + '</td>' +
                    actionsHtml +
                    '</tr>';
            }).join('');

            document.getElementById('propertiesTable').innerHTML = html || '<tr><td colspan="' + (isAdmin ? '10' : '9') + '">No properties found</td></tr>';
        }

        // Render Rental Income Table - show ALL properties with zeros for non-rented
        function renderRentalIncomeTable(properties) {
            var totalGross = 0;
            var totalTax = 0;
            var totalNet = 0;
            var currency = getCurrency();

            var html = properties.map(function (p) {
                var isRented = p.status === 'Rented';

                // Non-rented: all zeros
                var rent = isRented ? (parseFloat(p.rent_amount) || 0) : 0;
                var taxRate = isRented ? (parseFloat(p.tax_rate) || 0) : 0;
                var period = isRented ? (p.rent_period || 'Monthly') : '-';
                var taxAmount = rent * taxRate / 100;
                var netIncome = rent - taxAmount;

                totalGross += rent;
                totalTax += taxAmount;
                totalNet += netIncome;

                var statusClass = isRented ? 'badge-income' : 'badge-expense';

                return '<tr>' +
                    '<td><strong>' + p.name + '</strong></td>' +
                    '<td>' + p.location + '</td>' +
                    '<td><span class="badge ' + statusClass + '">' + p.status + '</span></td>' +
                    '<td>' + fmt(rent) + '</td>' +
                    '<td>' + period + '</td>' +
                    '<td>' + taxRate + '%</td>' +
                    '<td>' + fmt(rent) + '</td>' +
                    '<td class="' + (taxAmount > 0 ? 'amount-negative' : '') + '">' + (taxAmount > 0 ? '-' : '') + fmt(Math.round(taxAmount)) + '</td>' +
                    '<td class="' + (netIncome > 0 ? 'amount-positive' : '') + '">' + fmt(Math.round(netIncome)) + '</td>' +
                    '</tr>';
            }).join('');

            document.getElementById('rentalIncomeTable').innerHTML = html || '<tr><td colspan="9">No properties</td></tr>';

            document.getElementById('rentalIncomeTotals').innerHTML =
                '<tr style="background: #f7fafc; font-weight: bold;">' +
                '<td colspan="6" style="text-align: right;">TOTALS (' + currency + '):</td>' +
                '<td>' + fmt(Math.round(totalGross)) + '</td>' +
                '<td class="amount-negative">-' + fmt(Math.round(totalTax)) + '</td>' +
                '<td class="amount-positive">' + fmt(Math.round(totalNet)) + '</td>' +
                '</tr>';
        }

        // Filter Properties
        function filterProperties() {
            api('/properties').then(function (properties) {
                renderPropertiesTable(properties);
            });
        }

        // Toggle Rental Fields - non-rented properties have zeros
        function toggleRentalFields() {
            var status = document.getElementById('propStatus').value;
            var rentalFields = document.getElementById('rentalFields');
            var isRented = status === 'Rented';

            if (isRented) {
                rentalFields.style.display = 'block';
            } else {
                rentalFields.style.display = 'none';
                // Set all to zero for non-rented
                document.getElementById('propRentAmount').value = 0;
                document.getElementById('propTaxRate').value = '0';
            }
            updatePropertyCalc();
        }

        // Update Property Calculation - respects rented status
        function updatePropertyCalc() {
            var status = document.getElementById('propStatus').value;
            var isRented = status === 'Rented';

            var rent = isRented ? (parseFloat(document.getElementById('propRentAmount').value) || 0) : 0;
            var taxRate = isRented ? (parseFloat(document.getElementById('propTaxRate').value) || 0) : 0;
            var taxAmount = rent * taxRate / 100;
            var netIncome = rent - taxAmount;

            document.getElementById('propGrossRent').textContent = fmt(rent) + ' XAF';
            document.getElementById('propTaxAmount').textContent = '-' + fmt(Math.round(taxAmount)) + ' XAF';
            document.getElementById('propNetIncome').textContent = fmt(Math.round(netIncome)) + ' XAF';
        }

        // Open Property Modal
        function openPropertyModal() {
            // Get global default settings from API cache
            api('/re/settings').then(function (settings) {
                var defaultTaxRate = settings.taxRate || '15';
                var defaultPeriod = settings.period || 'Monthly';

                document.getElementById('propertyModalTitle').textContent = 'üè† Add Property';
                document.getElementById('propId').value = '';
                document.getElementById('propName').value = '';
                document.getElementById('propLocation').value = '';
                document.getElementById('propType').value = 'Residential';
                document.getElementById('propStatus').value = 'Rented';
                document.getElementById('propRentAmount').value = 0;
                document.getElementById('propRentPeriod').value = defaultPeriod;
                document.getElementById('propTaxRate').value = defaultTaxRate;
                document.getElementById('propInheritance').value = 'Yes';
                document.getElementById('propNotes').value = '';
                toggleRentalFields();
                document.getElementById('propertyModal').classList.add('active');
            });
        }

        function closePropertyModal() {
            document.getElementById('propertyModal').classList.remove('active');
        }

        // Edit Property - loads from API
        function editProperty(id) {
            api('/properties/' + id).then(function (p) {
                if (p) {
                    var isRented = p.status === 'Rented';
                    document.getElementById('propertyModalTitle').textContent = 'üè† Edit Property';
                    document.getElementById('propId').value = p.id;
                    document.getElementById('propName').value = p.name;
                    document.getElementById('propLocation').value = p.location;
                    document.getElementById('propType').value = p.type;
                    document.getElementById('propStatus').value = p.status;
                    document.getElementById('propRentAmount').value = isRented ? (p.rent_amount || 0) : 0;
                    document.getElementById('propRentPeriod').value = p.rent_period || 'Monthly';
                    document.getElementById('propTaxRate').value = isRented ? (p.tax_rate || '15') : '0';
                    document.getElementById('propInheritance').value = p.islamic_inheritance || 'Yes';
                    document.getElementById('propNotes').value = p.notes || '';
                    toggleRentalFields();
                    document.getElementById('propertyModal').classList.add('active');
                }
            });
        }

        // Save Property to PostgreSQL
        function saveProperty() {
            var id = document.getElementById('propId').value;
            var name = document.getElementById('propName').value;
            var location = document.getElementById('propLocation').value;
            var type = document.getElementById('propType').value;
            var status = document.getElementById('propStatus').value;

            // Non-rented properties: all financial fields are 0
            var isRented = status === 'Rented';
            var rentAmount = isRented ? (parseFloat(document.getElementById('propRentAmount').value) || 0) : 0;
            var rentPeriod = isRented ? document.getElementById('propRentPeriod').value : 'Monthly';
            var taxRate = isRented ? (parseFloat(document.getElementById('propTaxRate').value) || 0) : 0;
            var inheritance = document.getElementById('propInheritance').value;
            var notes = document.getElementById('propNotes').value;

            if (!name || !location) {
                showAlert('Please fill required fields', 'error');
                return;
            }

            var propertyData = {
                name: name,
                location: location,
                type: type,
                status: status,
                rent_amount: rentAmount,
                rent_period: rentPeriod,
                tax_rate: taxRate,
                islamic_inheritance: inheritance,
                notes: notes
            };

            if (id) {
                // Update existing
                api('/properties/' + id, {
                    method: 'PUT',
                    body: JSON.stringify(propertyData)
                }).then(function () {
                    closePropertyModal();
                    showAlert('Property updated!');
                    loadRealEstate();
                }).catch(function (err) {
                    showAlert('Error updating property: ' + err.message, 'error');
                });
            } else {
                // Add new
                api('/properties', {
                    method: 'POST',
                    body: JSON.stringify(propertyData)
                }).then(function () {
                    closePropertyModal();
                    showAlert('Property added!');
                    loadRealEstate();
                }).catch(function (err) {
                    showAlert('Error adding property: ' + err.message, 'error');
                });
            }
        }

        // Delete Property from PostgreSQL
        function deleteProperty(id) {
            if (!confirm('Delete this property?')) return;
            api('/properties/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Property deleted');
                loadRealEstate();
            }).catch(function (err) {
                showAlert('Error deleting property: ' + err.message, 'error');
            });
        }

        // ========== RE BILLS ==========
        function loadREBills() {
            Promise.all([api('/properties'), api('/re/bills')]).then(function (results) {
                var properties = results[0];
                var reBills = results[1];
                var rentedProps = properties.filter(function (p) { return p.status === 'Rented'; });
                var currency = getCurrency();

                // Get IDs of properties that already have bills
                var billedPropertyIds = reBills.map(function (b) { return b.property_id; });

                // Get currently editing bill ID (if any)
                var editingBillId = document.getElementById('reBillId').value;
                var editingPropertyId = null;
                if (editingBillId) {
                    var editingBill = reBills.find(function (b) { return b.id === parseInt(editingBillId); });
                    if (editingBill) editingPropertyId = editingBill.property_id;
                }

                // Filter out properties that already have bills (except the one being edited)
                var availableProps = rentedProps.filter(function (p) {
                    return !billedPropertyIds.includes(p.id) || p.id === editingPropertyId;
                });

                // Populate property dropdown with available rented properties only
                document.getElementById('reBillProperty').innerHTML = '<option value="">Select Rented Property</option>' +
                    availableProps.map(function (p) {
                        var taxRate = parseFloat(p.tax_rate) || 0;
                        var grossRent = parseFloat(p.rent_amount) || 0;
                        var netRent = grossRent - (grossRent * taxRate / 100);
                        return '<option value="' + p.id + '" data-period="' + (p.rent_period || 'Monthly') + '" data-rent="' + grossRent + '" data-taxrate="' + taxRate + '">' +
                            p.name + ' (' + (p.rent_period || 'Monthly') + ' | Gross: ' + fmt(grossRent) + ' | Tax: ' + taxRate + '% | Net: ' + fmt(Math.round(netRent)) + ' ' + currency + ')</option>';
                    }).join('');

                if (!document.getElementById('reBillDate').value) {
                    document.getElementById('reBillDate').valueAsDate = new Date();
                }

                var totalGross = 0, totalTax = 0, totalNet = 0;

                var isAdmin = currentUser && currentUser.role === 'admin';

                var html = reBills.map(function (b) {
                    var prop = properties.find(function (p) { return p.id === b.property_id; });

                    // Get Period from property (Monthly, Quarterly, Yearly)
                    var period = prop ? (prop.rent_period || 'Monthly') : 'N/A';

                    // Get Gross from property rent_amount
                    var grossAmount = prop ? (parseFloat(prop.rent_amount) || 0) : (parseFloat(b.amount) || 0);
                    var taxRate = prop ? parseFloat(prop.tax_rate) : 0;
                    var taxAmount = grossAmount * taxRate / 100;
                    var netAmount = grossAmount - taxAmount;

                    // Get description from bill
                    var description = b.notes || b.description || '-';

                    totalGross += grossAmount;
                    totalTax += taxAmount;
                    totalNet += netAmount;

                    // Actions: Edit, Delete for admin only
                    var actionsHtml = '<td class="no-print">';
                    if (isAdmin) {
                        actionsHtml += '<button class="btn btn-warning btn-sm" onclick="editREBill(' + b.id + ')" title="Edit">‚úèÔ∏è</button> ' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteREBill(' + b.id + ')" title="Delete">üóëÔ∏è</button>';
                    } else {
                        actionsHtml += '<span style="color: #999;">-</span>';
                    }
                    actionsHtml += '</td>';

                    return '<tr>' +
                        '<td><strong>BILL-' + b.id + '</strong></td>' +
                        '<td>' + (prop ? prop.name : (b.property_name || 'N/A')) + '</td>' +
                        '<td>' + period + '</td>' +
                        '<td>' + (b.bill_date ? b.bill_date.split('T')[0] : '') + '</td>' +
                        '<td>' + fmt(Math.round(grossAmount)) + '</td>' +
                        '<td class="amount-negative">' + fmt(Math.round(taxAmount)) + ' (' + taxRate + '%)</td>' +
                        '<td><strong>' + fmt(Math.round(netAmount)) + '</strong></td>' +
                        '<td>' + description + '</td>' +
                        actionsHtml +
                        '</tr>';
                }).join('');

                document.getElementById('reBillsTable').innerHTML = html || '<tr><td colspan="9">No bills</td></tr>';

                // Add totals row
                document.getElementById('reBillsTotals').innerHTML =
                    '<tr style="background: #f7fafc; font-weight: bold;">' +
                    '<td colspan="4" style="text-align: right;">TOTALS (' + currency + '):</td>' +
                    '<td>' + fmt(Math.round(totalGross)) + '</td>' +
                    '<td class="amount-negative">' + fmt(Math.round(totalTax)) + '</td>' +
                    '<td>' + fmt(Math.round(totalNet)) + '</td>' +
                    '<td colspan="2"></td>' +
                    '</tr>';
            });
        }

        // Auto-populate period, amount, and tax when property is selected
        function onREPropertySelect() {
            var select = document.getElementById('reBillProperty');
            var selectedOption = select.options[select.selectedIndex];

            if (selectedOption && selectedOption.value) {
                var period = selectedOption.getAttribute('data-period') || 'Monthly';
                var grossRent = parseFloat(selectedOption.getAttribute('data-rent')) || 0;
                var taxRate = parseFloat(selectedOption.getAttribute('data-taxrate')) || 0;

                var taxAmount = grossRent * taxRate / 100;
                var netAmount = grossRent - taxAmount;

                document.getElementById('reBillPeriod').value = period;
                document.getElementById('reBillGrossAmount').value = grossRent;
                document.getElementById('reBillTaxRate').value = taxRate + '%';
                document.getElementById('reBillTaxAmount').value = fmt(Math.round(taxAmount));
                document.getElementById('reBillAmount').value = fmt(Math.round(netAmount));
            } else {
                document.getElementById('reBillPeriod').value = '';
                document.getElementById('reBillGrossAmount').value = '';
                document.getElementById('reBillTaxRate').value = '0%';
                document.getElementById('reBillTaxAmount').value = '0';
                document.getElementById('reBillAmount').value = '0';
            }
        }

        // Calculate net bill amount when gross changes
        function calculateBillNet() {
            var grossAmount = parseFloat(document.getElementById('reBillGrossAmount').value) || 0;
            var taxRateStr = document.getElementById('reBillTaxRate').value;
            var taxRate = parseFloat(taxRateStr.replace('%', '')) || 0;

            var taxAmount = grossAmount * taxRate / 100;
            var netAmount = grossAmount - taxAmount;

            document.getElementById('reBillTaxAmount').value = fmt(Math.round(taxAmount));
            document.getElementById('reBillAmount').value = fmt(Math.round(netAmount));
        }

        function saveREBill() {
            var id = document.getElementById('reBillId').value;
            var propertyId = parseInt(document.getElementById('reBillProperty').value);
            var tenantName = document.getElementById('reBillTenant') ? document.getElementById('reBillTenant').value : 'Tenant';
            var billDate = document.getElementById('reBillDate').value;
            var dueDate = document.getElementById('reBillDueDate') ? document.getElementById('reBillDueDate').value : billDate;
            var amount = parseFloat(document.getElementById('reBillAmount').value) || parseFloat(document.getElementById('reBillGrossAmount').value) || 0;
            var notes = document.getElementById('reBillDesc').value;

            if (!propertyId || !amount) { showAlert('Please select property and enter amount', 'error'); return; }

            var data = {
                propertyId: propertyId,
                tenantName: tenantName || 'Tenant',
                billDate: billDate,
                dueDate: dueDate || billDate,
                amount: amount,
                status: 'Unpaid',
                notes: notes
            };

            var url = id ? '/re/bills/' + id : '/re/bills';
            var method = id ? 'PUT' : 'POST';

            api(url, { method: method, body: JSON.stringify(data) }).then(function () {
                clearREBillForm();
                showAlert(id ? 'Bill updated!' : 'Bill created!');
                loadREBills();
                loadRealEstate();
            });
        }

        function clearREBillForm() {
            document.getElementById('reBillId').value = '';
            document.getElementById('reBillProperty').value = '';
            if (document.getElementById('reBillPeriod')) document.getElementById('reBillPeriod').value = '';
            if (document.getElementById('reBillGrossAmount')) document.getElementById('reBillGrossAmount').value = '';
            if (document.getElementById('reBillTaxRate')) document.getElementById('reBillTaxRate').value = '0%';
            if (document.getElementById('reBillTaxAmount')) document.getElementById('reBillTaxAmount').value = '0';
            if (document.getElementById('reBillAmount')) document.getElementById('reBillAmount').value = '0';
            document.getElementById('reBillDesc').value = '';
        }

        function editREBill(id) {
            Promise.all([api('/re/bills'), api('/properties')]).then(function (results) {
                var reBills = results[0];
                var properties = results[1];
                var b = reBills.find(function (x) { return x.id === id; });
                if (b) {
                    var prop = properties.find(function (p) { return p.id === b.property_id; });

                    // Get values from property
                    var period = prop ? (prop.rent_period || 'Monthly') : 'N/A';
                    var grossAmount = prop ? (parseFloat(prop.rent_amount) || 0) : 0;
                    var taxRate = prop ? parseFloat(prop.tax_rate) : 0;
                    var taxAmount = grossAmount * taxRate / 100;
                    var netAmount = grossAmount - taxAmount;

                    document.getElementById('reBillId').value = b.id;
                    document.getElementById('reBillProperty').value = b.property_id;
                    document.getElementById('reBillDate').value = b.bill_date ? b.bill_date.split('T')[0] : '';
                    if (document.getElementById('reBillPeriod')) document.getElementById('reBillPeriod').value = period;
                    if (document.getElementById('reBillGrossAmount')) document.getElementById('reBillGrossAmount').value = Math.round(grossAmount);
                    if (document.getElementById('reBillTaxRate')) document.getElementById('reBillTaxRate').value = taxRate + '%';
                    if (document.getElementById('reBillTaxAmount')) document.getElementById('reBillTaxAmount').value = fmt(Math.round(taxAmount));
                    if (document.getElementById('reBillAmount')) document.getElementById('reBillAmount').value = fmt(Math.round(netAmount));
                    document.getElementById('reBillDesc').value = b.notes || '';
                }
            });
        }

        function deleteREBill(id) {
            if (!confirm('Delete this bill?')) return;
            api('/re/bills/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Bill deleted');
                loadREBills();
                loadRealEstate();
            });
        }

        // ========== RE PAYMENTS ==========
        // Generate unique payment reference
        function generatePaymentReference() {
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return 'PAY-' + year + month + day + '-' + random;
        }

        function loadREPayments() {
            var currency = getCurrency();

            // Get bills and properties to calculate Net Amount Due properly
            Promise.all([api('/re/bills'), api('/properties'), api('/re/payments')]).then(function (results) {
                var reBills = results[0];
                var properties = results[1];
                var rePayments = results[2];

                // Calculate Net Amount Due for each bill (from property) and track payment status
                var billsWithNetAmount = reBills.map(function (b) {
                    var prop = properties.find(function (p) { return p.id === b.property_id; });
                    var grossAmount = prop ? (parseFloat(prop.rent_amount) || 0) : (parseFloat(b.amount) || 0);
                    var taxRate = prop ? parseFloat(prop.tax_rate) : 0;
                    var netAmount = grossAmount - (grossAmount * taxRate / 100);

                    // Calculate total paid for this bill
                    var totalPaidForBill = rePayments
                        .filter(function (p) { return p.bill_id === b.id; })
                        .reduce(function (sum, p) { return sum + (parseFloat(p.amount) || 0); }, 0);

                    // Determine payment status
                    var paymentStatus = 'Unpaid';
                    if (totalPaidForBill >= netAmount) {
                        paymentStatus = totalPaidForBill > netAmount ? 'Overpaid' : 'Paid';
                    } else if (totalPaidForBill > 0) {
                        paymentStatus = 'Partial';
                    }

                    return {
                        id: b.id,
                        property_id: b.property_id,
                        property_name: prop ? prop.name : (b.property_name || 'N/A'),
                        netAmount: netAmount,
                        totalPaid: totalPaidForBill,
                        paymentStatus: paymentStatus,
                        status: b.status
                    };
                });

                // Filter bills that are NOT fully paid or overpaid for the dropdown
                var unpaidBills = billsWithNetAmount.filter(function (b) {
                    return b.paymentStatus !== 'Paid' && b.paymentStatus !== 'Overpaid';
                });

                // Populate Select Bill dropdown - only show unpaid/partial bills
                document.getElementById('rePayBill').innerHTML = '<option value="">Select Bill</option>' +
                    unpaidBills.map(function (b) {
                        var remaining = b.netAmount - b.totalPaid;
                        var statusText = b.paymentStatus === 'Partial' ? ' (Partial - Remaining: ' + fmt(Math.round(remaining)) + ')' : '';
                        return '<option value="' + b.id + '" data-amount="' + Math.round(b.netAmount) + '" data-remaining="' + Math.round(remaining) + '" data-property="' + b.property_name + '">' +
                            'BILL-' + b.id + ' | ' + b.property_name + ' | Amount: ' + fmt(Math.round(b.netAmount)) + ' ' + currency + statusText +
                            '</option>';
                    }).join('');

                if (!document.getElementById('rePayDate').value) {
                    document.getElementById('rePayDate').valueAsDate = new Date();
                }

                // Generate reference for new payments
                if (!document.getElementById('rePayRef').value) {
                    document.getElementById('rePayRef').value = generatePaymentReference();
                }

                var totalAmount = 0, totalPaid = 0, totalDue = 0;
                var isAdmin = currentUser && currentUser.role === 'admin';

                var html = rePayments.map(function (p) {
                    // Find the corresponding bill to get Net Amount Due
                    var bill = billsWithNetAmount.find(function (b) { return b.id === p.bill_id; });
                    var amount = bill ? bill.netAmount : (parseFloat(p.amount) || 0);
                    var amountPaid = parseFloat(p.amount) || 0;
                    var amountDue = amount - amountPaid;

                    // Determine status
                    var status, statusClass;
                    if (amountPaid >= amount) {
                        if (amountPaid > amount) {
                            status = 'Overpayment';
                            statusClass = 'badge-inheritance';
                        } else {
                            status = 'Paid in Full';
                            statusClass = 'badge-paid';
                        }
                    } else {
                        status = 'Partial Payment';
                        statusClass = 'badge-new';
                    }

                    totalAmount += amount;
                    totalPaid += amountPaid;
                    totalDue += Math.max(0, amountDue);

                    // Actions: View, Print, Delete
                    var actionsHtml = '<td class="no-print">';
                    actionsHtml += '<button class="btn btn-primary btn-sm" onclick="viewREPayment(' + p.id + ')" title="View">üëÅÔ∏è</button> ';
                    actionsHtml += '<button class="btn btn-gold btn-sm" onclick="printREPayment(' + p.id + ')" title="Print">üñ®Ô∏è</button> ';
                    if (isAdmin) {
                        actionsHtml += '<button class="btn btn-danger btn-sm" onclick="deleteREPayment(' + p.id + ')" title="Delete">üóëÔ∏è</button>';
                    }
                    actionsHtml += '</td>';

                    return '<tr>' +
                        '<td>' + fmtDate(p.payment_date) + '</td>' +
                        '<td>' + (bill ? bill.property_name : (p.property_name || 'N/A')) + '</td>' +
                        '<td>BILL-' + (p.bill_id || 'N/A') + '</td>' +
                        '<td class="amount-positive"><strong>' + fmt(Math.round(amount)) + '</strong></td>' +
                        '<td class="amount-positive">' + fmt(Math.round(amountPaid)) + '</td>' +
                        '<td class="' + (amountDue > 0 ? 'amount-negative' : amountDue < 0 ? 'amount-gold' : '') + '">' + fmt(Math.round(amountDue)) + '</td>' +
                        '<td><span class="badge ' + statusClass + '">' + status + '</span></td>' +
                        '<td>' + (p.reference || '-') + '</td>' +
                        actionsHtml +
                        '</tr>';
                }).join('');

                document.getElementById('rePaymentsTable').innerHTML = html || '<tr><td colspan="9">No payments</td></tr>';

                // Add totals row
                if (document.getElementById('rePaymentsTotals')) {
                    document.getElementById('rePaymentsTotals').innerHTML =
                        '<tr style="background: #f7fafc; font-weight: bold;">' +
                        '<td colspan="3" style="text-align: right;">TOTALS (' + currency + '):</td>' +
                        '<td class="amount-positive">' + fmt(Math.round(totalAmount)) + '</td>' +
                        '<td class="amount-positive">' + fmt(Math.round(totalPaid)) + '</td>' +
                        '<td class="' + (totalDue > 0 ? 'amount-negative' : '') + '">' + fmt(Math.round(totalDue)) + '</td>' +
                        '<td colspan="3"></td>' +
                        '</tr>';
                }
            });
        }

        // Auto-populate amount and reference when bill is selected
        function onREBillSelect() {
            var select = document.getElementById('rePayBill');
            var selectedOption = select.options[select.selectedIndex];

            if (selectedOption && selectedOption.value) {
                var amount = parseFloat(selectedOption.getAttribute('data-amount')) || 0;
                var remaining = parseFloat(selectedOption.getAttribute('data-remaining')) || amount;
                document.getElementById('rePayAmount').value = amount;
                // Pre-fill amount paid with remaining balance
                document.getElementById('rePayAmountPaid').value = remaining;
                // Generate new reference if empty
                if (!document.getElementById('rePayRef').value) {
                    document.getElementById('rePayRef').value = generatePaymentReference();
                }
            } else {
                document.getElementById('rePayAmount').value = '';
                document.getElementById('rePayAmountPaid').value = '';
            }
        }

        function saveREPayment() {
            var billId = parseInt(document.getElementById('rePayBill').value);
            var payDate = document.getElementById('rePayDate').value;
            var amountPaid = parseFloat(document.getElementById('rePayAmountPaid').value) || 0;
            var reference = document.getElementById('rePayRef').value || generatePaymentReference();

            if (!billId) { showAlert('Please select a bill', 'error'); return; }
            if (!amountPaid || amountPaid <= 0) { showAlert('Please enter amount paid', 'error'); return; }

            api('/re/payments', {
                method: 'POST',
                body: JSON.stringify({
                    billId: billId,
                    amount: amountPaid,
                    paymentDate: payDate,
                    paymentMethod: 'Cash',
                    reference: reference
                })
            }).then(function () {
                clearREPaymentForm();
                showAlert('Payment recorded!');
                loadREPayments();
                loadREBills();
                loadRealEstate();
            });
        }

        function clearREPaymentForm() {
            if (document.getElementById('rePayId')) document.getElementById('rePayId').value = '';
            document.getElementById('rePayBill').value = '';
            document.getElementById('rePayAmount').value = '';
            document.getElementById('rePayAmountPaid').value = '';
            document.getElementById('rePayRef').value = generatePaymentReference();
        }

        function deleteREPayment(id) {
            if (!confirm('Delete this payment?')) return;
            api('/re/payments/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Payment deleted');
                loadREPayments();
                loadREBills();
                loadRealEstate();
            });
        }

        // View payment details - Certificate style modal
        function viewREPayment(id) {
            Promise.all([api('/re/payments'), api('/re/bills'), api('/properties')]).then(function (results) {
                var payments = results[0];
                var bills = results[1];
                var properties = results[2];
                var payment = payments.find(function (p) { return p.id === id; });

                if (payment) {
                    var bill = bills.find(function (b) { return b.id === payment.bill_id; });
                    var prop = bill ? properties.find(function (p) { return p.id === bill.property_id; }) : null;
                    var propName = prop ? prop.name : (payment.property_name || 'N/A');
                    var grossAmount = prop ? (parseFloat(prop.rent_amount) || 0) : 0;
                    var taxRate = prop ? parseFloat(prop.tax_rate) : 0;
                    var netAmount = grossAmount - (grossAmount * taxRate / 100);
                    var amountPaid = parseFloat(payment.amount) || 0;
                    var amountDue = netAmount - amountPaid;
                    var status, statusColor;
                    if (amountPaid >= netAmount) {
                        status = amountPaid > netAmount ? 'Overpayment, Credit on Account' : 'Paid in Full';
                        statusColor = amountPaid > netAmount ? '#d69e2e' : '#38a169';
                    } else {
                        status = 'Partial Payment';
                        statusColor = '#dd6b20';
                    }

                    var currency = getCurrency();
                    var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                    // Create certificate-style modal
                    var modalHtml = '<div id="paymentViewModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">' +
                        '<div style="background: linear-gradient(135deg, #fef9e7 0%, #fdebd0 100%); max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 3px solid #c9a227;">' +
                        '<div style="background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%); color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">' +
                        '<div style="font-size: 24px; font-weight: bold;">üè† FAMILY ESTATES</div>' +
                        '<div style="font-size: 14px; margin-top: 5px;">NJIKAM SALIFU ESTATE</div>' +
                        '<div style="font-size: 12px; font-style: italic; color: #90cdf4; margin-top: 5px;">Payment Receipt</div>' +
                        '</div>' +
                        '<div style="padding: 30px;">' +
                        '<div style="text-align: center; margin-bottom: 20px;">' +
                        '<h2 style="color: #2c5282; margin: 0; font-size: 22px;">PAYMENT RECEIPT</h2>' +
                        '<div style="color: #718096; font-size: 12px;">Receipt No: ' + (payment.reference || 'N/A') + '</div>' +
                        '</div>' +
                        '<div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">' +
                        '<p style="font-size: 14px; line-height: 1.8; margin: 0;">This is to acknowledge receipt of payment for <strong>' + propName + '</strong> property rental, Bill <strong>BILL-' + payment.bill_id + '</strong>, dated <strong>' + fmtDate(payment.payment_date) + '</strong>.</p>' +
                        '</div>' +
                        '<div style="display: flex; gap: 15px; margin-bottom: 20px;">' +
                        '<div style="flex: 1; background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%); border: 2px solid #3182ce; border-radius: 8px; padding: 15px; text-align: center;">' +
                        '<div style="font-size: 11px; color: #2c5282; font-weight: bold; text-transform: uppercase;">Total Amount Due</div>' +
                        '<div style="font-size: 20px; color: #2c5282; font-weight: bold;">' + fmt(Math.round(netAmount)) + ' ' + currency + '</div>' +
                        '</div>' +
                        '<div style="flex: 1; background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); border: 2px solid #38a169; border-radius: 8px; padding: 15px; text-align: center;">' +
                        '<div style="font-size: 11px; color: #276749; font-weight: bold; text-transform: uppercase;">Amount Paid</div>' +
                        '<div style="font-size: 20px; color: #38a169; font-weight: bold;">' + fmt(Math.round(amountPaid)) + ' ' + currency + '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div style="background: linear-gradient(135deg, #fffaf0 0%, #feebc8 100%); border: 3px dashed #c9a227; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 20px;">' +
                        '<div style="font-size: 11px; color: #744210; font-weight: bold; text-transform: uppercase;">Balance Due</div>' +
                        '<div style="font-size: 28px; color: ' + (amountDue > 0 ? '#c53030' : '#38a169') + '; font-weight: bold;">' + fmt(Math.round(Math.abs(amountDue))) + ' ' + currency + '</div>' +
                        '<div style="margin-top: 10px;">' +
                        '<span style="background: ' + statusColor + '; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold;">' + status + '</span>' +
                        '</div>' +
                        '</div>' +
                        '<div style="display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">' +
                        '<div style="text-align: center;">' +
                        '<div style="width: 150px; border-top: 1px solid #2c5282; margin-bottom: 5px;"></div>' +
                        '<div style="font-weight: bold; font-size: 12px;">Estate Administrator</div>' +
                        '<div style="font-size: 10px; color: #718096;">Date: ' + today + '</div>' +
                        '</div>' +
                        '<div style="text-align: center;">' +
                        '<div style="width: 150px; border-top: 1px solid #2c5282; margin-bottom: 5px;"></div>' +
                        '<div style="font-weight: bold; font-size: 12px;">Received By</div>' +
                        '<div style="font-size: 10px; color: #718096;">Date: ' + today + '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div style="background: #f7fafc; padding: 15px; text-align: center; border-radius: 0 0 8px 8px; border-top: 1px solid #e2e8f0;">' +
                        '<div style="font-size: 10px; color: #718096;">This receipt is issued as acknowledgment of payment received</div>' +
                        '<div style="font-size: 10px; color: #718096;">for the Family Estate properties of the late NJIKAM SALIFU</div>' +
                        '<div style="font-size: 10px; color: #a0aec0; margin-top: 5px;">Generated on: ' + today + '</div>' +
                        '<button onclick="document.getElementById(\'paymentViewModal\').remove()" style="margin-top: 15px; background: #2c5282; color: white; border: none; padding: 10px 30px; border-radius: 5px; cursor: pointer; font-weight: bold;">Close</button>' +
                        '</div>' +
                        '</div>' +
                        '</div>';

                    // Remove existing modal if any
                    var existingModal = document.getElementById('paymentViewModal');
                    if (existingModal) existingModal.remove();

                    // Add modal to page
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                }
            });
        }

        // Print payment receipt - Certificate style PDF
        function printREPayment(id) {
            Promise.all([api('/re/payments'), api('/re/bills'), api('/properties')]).then(function (results) {
                var payments = results[0];
                var bills = results[1];
                var properties = results[2];
                var payment = payments.find(function (p) { return p.id === id; });

                if (payment) {
                    var bill = bills.find(function (b) { return b.id === payment.bill_id; });
                    var prop = bill ? properties.find(function (p) { return p.id === bill.property_id; }) : null;
                    var propName = prop ? prop.name : (payment.property_name || 'N/A');
                    var grossAmount = prop ? (parseFloat(prop.rent_amount) || 0) : 0;
                    var taxRate = prop ? parseFloat(prop.tax_rate) : 0;
                    var netAmount = grossAmount - (grossAmount * taxRate / 100);
                    var amountPaid = parseFloat(payment.amount) || 0;
                    var amountDue = netAmount - amountPaid;
                    var status;
                    if (amountPaid >= netAmount) {
                        status = amountPaid > netAmount ? 'Overpayment, Credit on Account' : 'Paid in Full';
                    } else {
                        status = 'Partial Payment';
                    }

                    var currency = getCurrency();
                    var jsPDF = window.jspdf.jsPDF;
                    var doc = new jsPDF();
                    var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                    // Background color (cream/beige)
                    doc.setFillColor(254, 249, 231);
                    doc.rect(0, 0, 210, 297, 'F');

                    // Header bar (dark blue)
                    doc.setFillColor(44, 82, 130);
                    doc.rect(10, 10, 190, 35, 'F');

                    // Header text
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('FAMILY ESTATES', 105, 22, { align: 'center' });
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    doc.text('NJIKAM SALIFU ESTATE', 105, 30, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(144, 205, 244);
                    doc.text('Payment Receipt', 105, 38, { align: 'center' });

                    // Dotted line
                    doc.setDrawColor(201, 162, 39);
                    doc.setLineDash([2, 2]);
                    doc.line(20, 52, 190, 52);
                    doc.setLineDash([]);

                    // Title
                    doc.setTextColor(44, 82, 130);
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PAYMENT RECEIPT', 105, 65, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setTextColor(113, 128, 150);
                    doc.text('Receipt No: ' + (payment.reference || 'N/A'), 105, 72, { align: 'center' });

                    // Description box
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(226, 232, 240);
                    doc.roundedRect(20, 80, 170, 25, 3, 3, 'FD');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    var descText = 'This is to acknowledge receipt of payment for ' + propName + ' property rental,';
                    var descText2 = 'Bill BILL-' + payment.bill_id + ', dated ' + fmtDate(payment.payment_date) + '.';
                    doc.text(descText, 105, 90, { align: 'center' });
                    doc.text(descText2, 105, 97, { align: 'center' });

                    // Amount boxes
                    // Total Amount Due (blue)
                    doc.setFillColor(235, 248, 255);
                    doc.setDrawColor(49, 130, 206);
                    doc.roundedRect(20, 115, 82, 35, 3, 3, 'FD');
                    doc.setTextColor(44, 82, 130);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TOTAL AMOUNT DUE', 61, 125, { align: 'center' });
                    doc.setFontSize(16);
                    doc.text(fmt(Math.round(netAmount)) + ' ' + currency, 61, 140, { align: 'center' });

                    // Amount Paid (green)
                    doc.setFillColor(240, 255, 244);
                    doc.setDrawColor(56, 161, 105);
                    doc.roundedRect(108, 115, 82, 35, 3, 3, 'FD');
                    doc.setTextColor(39, 103, 73);
                    doc.setFontSize(9);
                    doc.text('AMOUNT PAID', 149, 125, { align: 'center' });
                    doc.setFontSize(16);
                    doc.setTextColor(56, 161, 105);
                    doc.text(fmt(Math.round(amountPaid)) + ' ' + currency, 149, 140, { align: 'center' });

                    // Balance box (gold border)
                    doc.setFillColor(255, 250, 240);
                    doc.setDrawColor(201, 162, 39);
                    doc.setLineDash([3, 3]);
                    doc.roundedRect(20, 160, 170, 45, 3, 3, 'FD');
                    doc.setLineDash([]);

                    doc.setTextColor(116, 66, 16);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('BALANCE DUE', 105, 172, { align: 'center' });

                    doc.setFontSize(22);
                    if (amountDue > 0) {
                        doc.setTextColor(197, 48, 48);
                    } else {
                        doc.setTextColor(56, 161, 105);
                    }
                    doc.text(fmt(Math.round(Math.abs(amountDue))) + ' ' + currency, 105, 186, { align: 'center' });

                    // Status badge
                    var statusColor;
                    if (status === 'Paid in Full') {
                        statusColor = [56, 161, 105];
                    } else if (status === 'Partial Payment') {
                        statusColor = [221, 107, 32];
                    } else {
                        statusColor = [214, 158, 46];
                    }
                    doc.setFillColor(statusColor[0], statusColor[1], statusColor[2]);
                    doc.roundedRect(60, 192, 90, 8, 4, 4, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.text(status, 105, 198, { align: 'center' });

                    // Signatures
                    doc.setTextColor(0, 0, 0);
                    doc.setDrawColor(44, 82, 130);
                    doc.line(30, 230, 90, 230);
                    doc.line(120, 230, 180, 230);

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Estate Administrator', 60, 237, { align: 'center' });
                    doc.text('Received By', 150, 237, { align: 'center' });

                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(113, 128, 150);
                    doc.text('Date: ' + today, 60, 243, { align: 'center' });
                    doc.text('Date: ' + today, 150, 243, { align: 'center' });

                    // Footer
                    doc.setFillColor(247, 250, 252);
                    doc.rect(10, 255, 190, 30, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(113, 128, 150);
                    doc.text('This receipt is issued as acknowledgment of payment received', 105, 263, { align: 'center' });
                    doc.text('for the Family Estate properties of the late NJIKAM SALIFU', 105, 269, { align: 'center' });
                    doc.setTextColor(160, 174, 192);
                    doc.text('Generated on: ' + today, 105, 278, { align: 'center' });

                    doc.save('payment_receipt_' + (payment.reference || id) + '.pdf');
                    showAlert('Payment receipt downloaded!');
                }
            });
        }

        // ========== RE AVAILABLE FUNDS ==========
        function loadREAvailableFunds() {
            var currency = getCurrency();

            Promise.all([
                api('/re/payments'),
                api('/re/expenses'),
                api('/re/settings')
            ]).then(function (results) {
                var payments = results[0] || [];
                var expenses = results[1] || [];
                var settings = results[2] || {};

                // Get reserved funds percentage from settings (settings is an object, not array)
                var reservedPercent = parseFloat(settings.reservedFundsPercent) || 10;

                // Calculate totals
                var totalIncome = 0;
                var totalExpenses = 0;

                // Sum all payments
                if (Array.isArray(payments)) {
                    payments.forEach(function (p) {
                        totalIncome += parseFloat(p.amount) || 0;
                    });
                }

                // Sum all expenses
                if (Array.isArray(expenses)) {
                    expenses.forEach(function (e) {
                        totalExpenses += parseFloat(e.amount) || 0;
                    });
                }

                var reservedFunds = totalIncome * (reservedPercent / 100);
                var availableFunds = Math.max(0, totalIncome - totalExpenses - reservedFunds);

                // Update display in Available Funds card (Expenses section)
                var elIncome = document.getElementById('expTotalIncome');
                var elExpenses = document.getElementById('expTotalExpenses');
                var elPercent = document.getElementById('expReservedPercent');
                var elReserved = document.getElementById('expReservedFunds');
                var elAvailable = document.getElementById('expAvailableFunds');

                if (elIncome) elIncome.textContent = fmt(Math.round(totalIncome)) + ' ' + currency;
                if (elExpenses) elExpenses.textContent = fmt(Math.round(totalExpenses)) + ' ' + currency;
                if (elPercent) elPercent.textContent = reservedPercent;
                if (elReserved) elReserved.textContent = fmt(Math.round(reservedFunds)) + ' ' + currency;
                if (elAvailable) elAvailable.textContent = fmt(Math.round(availableFunds)) + ' ' + currency;

                console.log('Available Funds loaded:', { totalIncome: totalIncome, totalExpenses: totalExpenses, reservedFunds: reservedFunds, availableFunds: availableFunds });
            }).catch(function (err) {
                console.error('Error loading available funds:', err);
            });
        }

        // ========== RE EXPENSES ==========
        function loadREExpenses() {
            var currency = getCurrency();

            // Load available funds
            loadREAvailableFunds();

            // Populate property dropdown with all properties
            api('/properties').then(function (properties) {
                var propOptions = properties.map(function (p) {
                    return '<option value="' + p.id + '">' + p.name + ' (' + p.status + ' - ' + p.location + ')</option>';
                }).join('');
                document.getElementById('reExpProperty').innerHTML = '<option value="">Select Property (Optional)</option>' + propOptions;
            });

            if (!document.getElementById('reExpDate').value) {
                document.getElementById('reExpDate').valueAsDate = new Date();
            }

            api('/re/expenses').then(function (reExpenses) {
                var totalExpenses = 0;
                var html = reExpenses.map(function (e) {
                    var isInheritance = e.category === 'Inheritance Allocation';
                    totalExpenses += parseFloat(e.amount) || 0;
                    return '<tr>' +
                        '<td>' + fmtDate(e.expense_date) + '</td>' +
                        '<td>' + (e.property_name || 'General') + '</td>' +
                        '<td>' + (isInheritance ? '<span class="badge badge-gold">' + e.category + '</span>' : e.category) + '</td>' +
                        '<td>' + e.description + '</td>' +
                        '<td class="' + (isInheritance ? 'amount-gold' : 'amount-negative') + '">-' + fmt(e.amount) + '</td>' +
                        '<td class="no-print">' +
                        '<button class="btn btn-warning btn-sm" onclick="editREExpense(' + e.id + ')">‚úèÔ∏è</button> ' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteREExpense(' + e.id + ')">üóëÔ∏è</button>' +
                        '</td>' +
                        '</tr>';
                }).join('');

                document.getElementById('reExpensesTable').innerHTML = html || '<tr><td colspan="6">No expenses</td></tr>';

                // Update expenses total if element exists
                var expTotalEl = document.getElementById('reExpensesTotal');
                if (expTotalEl) {
                    expTotalEl.innerHTML = '<tr style="background: #f7fafc; font-weight: bold;"><td colspan="4" style="text-align: right;">TOTAL (' + currency + '):</td><td class="amount-negative">-' + fmt(Math.round(totalExpenses)) + '</td><td></td></tr>';
                }
            });
        }

        function saveREExpense() {
            var id = document.getElementById('reExpId').value;
            var propertyId = document.getElementById('reExpProperty').value;
            propertyId = propertyId ? parseInt(propertyId) : null;
            var expDate = document.getElementById('reExpDate').value;
            var category = document.getElementById('reExpCategory').value;
            var amount = parseFloat(document.getElementById('reExpAmount').value) || 0;
            var desc = document.getElementById('reExpDesc').value.trim();

            // Validate required fields
            if (!expDate) {
                showAlert('Please select a date', 'error');
                return;
            }
            if (!amount || amount <= 0) {
                showAlert('Please enter a valid amount', 'error');
                return;
            }
            if (!desc) {
                showAlert('Please enter a description', 'error');
                return;
            }

            var data = {
                propertyId: propertyId,
                expenseDate: expDate,
                category: category,
                amount: amount,
                description: desc
            };

            var url = id ? '/re/expenses/' + id : '/re/expenses';
            var method = id ? 'PUT' : 'POST';

            api(url, { method: method, body: JSON.stringify(data) }).then(function () {
                clearREExpenseForm();
                showAlert(id ? 'Expense updated!' : 'Expense added!');
                loadREExpenses();
                loadRealEstate();
            });
        }

        function clearREExpenseForm() {
            document.getElementById('reExpId').value = '';
            document.getElementById('reExpProperty').value = '';
            document.getElementById('reExpAmount').value = '';
            document.getElementById('reExpDesc').value = '';
        }

        function editREExpense(id) {
            api('/re/expenses').then(function (reExpenses) {
                var e = reExpenses.find(function (x) { return x.id === id; });
                if (e) {
                    document.getElementById('reExpId').value = e.id;
                    document.getElementById('reExpProperty').value = e.property_id || '';
                    document.getElementById('reExpDate').value = e.expense_date;
                    document.getElementById('reExpCategory').value = e.category;
                    document.getElementById('reExpAmount').value = e.amount;
                    document.getElementById('reExpDesc').value = e.description;
                }
            });
        }

        function deleteREExpense(id) {
            if (!confirm('Delete this expense?')) return;
            api('/re/expenses/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Expense deleted');
                loadREExpenses();
                loadRealEstate();
            });
        }

        // ========== RE INHERITANCE - ISLAMIC LAW ==========

        // Calculate Islamic inheritance portions based on relationship and existing heirs
        function updateIslamicPortions() {
            var rel = document.getElementById('reHeirRel').value;
            var gender = document.getElementById('reHeirGender').value;

            api('/re/heirs').then(function (reHeirs) {
                // Check existing heirs to determine portions
                var hasChildren = reHeirs.some(function (h) {
                    return h.relationship === 'Son' || h.relationship === 'Daughter';
                });
                var hasSons = reHeirs.some(function (h) { return h.relationship === 'Son'; });

                var portions = 1; // Default

                // Islamic Inheritance Rules (Faraid)
                switch (rel) {
                    case 'Wife':
                        var wivesCount = reHeirs.filter(function (h) { return h.relationship === 'Wife' || h.relationship === 'Spouse'; }).length;
                        // If adding new wife, count will be current + 1
                        wivesCount = Math.max(1, wivesCount + (reHeirs.some(h => h.id === parseInt(document.getElementById('reHeirId').value)) ? 0 : 1));
                        var totalWifePortions = hasChildren ? 3 : 6; // 1/8 or 1/4 of 24
                        portions = totalWifePortions / wivesCount;
                        document.getElementById('reHeirGender').value = 'Female';
                        break;
                    case 'Husband':
                        portions = hasChildren ? 0.25 : 0.5;
                        document.getElementById('reHeirGender').value = 'Male';
                        break;
                    case 'Son':
                        portions = 2;
                        document.getElementById('reHeirGender').value = 'Male';
                        break;
                    case 'Daughter':
                        portions = 1;
                        document.getElementById('reHeirGender').value = 'Female';
                        break;
                    case 'Father':
                        portions = hasChildren ? (1 / 6) : 1;
                        document.getElementById('reHeirGender').value = 'Male';
                        break;
                    case 'Mother':
                        portions = hasChildren ? (1 / 6) : (1 / 3);
                        document.getElementById('reHeirGender').value = 'Female';
                        break;
                    case 'Brother':
                        portions = hasSons ? 0 : 2;
                        document.getElementById('reHeirGender').value = 'Male';
                        break;
                    case 'Sister':
                        portions = hasSons ? 0 : 1;
                        document.getElementById('reHeirGender').value = 'Female';
                        break;
                    case 'Grandfather':
                        portions = hasChildren ? (1 / 6) : 1;
                        document.getElementById('reHeirGender').value = 'Male';
                        break;
                    case 'Grandmother':
                        portions = 1 / 6;
                        document.getElementById('reHeirGender').value = 'Female';
                        break;
                    default:
                        portions = 1;
                }

                // Round to 3 decimal places for display
                document.getElementById('reHeirPor').value = Math.round(portions * 1000) / 1000;
            });
        }

        function loadREInheritance() {
            var currency = getCurrency();

            // Use API to calculate inheritance
            api('/re/inheritance/calculate').then(function (data) {
                var beneficiaries = data.heirs || [];

                // Load beneficiary selection list with all heirs
                api('/re/heirs').then(function (allHeirs) {
                    loadREBeneficiaryList(allHeirs);
                });

                document.getElementById('reInhPool').textContent = fmt(Math.round(data.inheritancePool)) + ' ' + currency;
                document.getElementById('reInhHeirs').textContent = beneficiaries.length;
                document.getElementById('reInhPortions').textContent = Math.round(data.totalPortions * 1000) / 1000;
                document.getElementById('reInhPerPortion').textContent = fmt(Math.round(data.perPortion)) + ' ' + currency;

                // Store inheritance data for certificate printing
                window.reInheritanceData = {
                    inheritancePool: data.inheritancePool,
                    totalPortions: data.totalPortions,
                    perPortion: data.perPortion,
                    beneficiaries: beneficiaries,
                    currency: currency
                };

                var isAdmin = currentUser && currentUser.role === 'admin';
                var html = beneficiaries.map(function (h) {
                    var shareAmount = h.shareAmount || (data.perPortion * (parseFloat(h.portions) || 0));
                    var portionDisplay = h.portions;
                    // Show as fraction if possible
                    if (h.portions === 0.125) portionDisplay = '1/8';
                    else if (h.portions === 0.25) portionDisplay = '1/4';
                    else if (h.portions === 0.5) portionDisplay = '1/2';
                    else if (Math.abs(h.portions - 0.167) < 0.01) portionDisplay = '1/6';
                    else if (Math.abs(h.portions - 0.333) < 0.01) portionDisplay = '1/3';

                    // Print certificate button for all users, edit/delete only for admin
                    var actionsHtml = '<td class="no-print">' +
                        '<button class="btn btn-gold btn-sm" onclick="printREHeirCertificate(' + h.id + ')" title="Print Certificate">üìú</button> ';

                    if (isAdmin) {
                        actionsHtml += '<button class="btn btn-warning btn-sm" onclick="editREHeir(' + h.id + ')" title="Edit">‚úèÔ∏è</button> ' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteREHeir(' + h.id + ')" title="Delete">üóëÔ∏è</button>';
                    }
                    actionsHtml += '</td>';

                    return '<tr>' +
                        '<td>' + h.name + '</td>' +
                        '<td>' + h.relationship + '</td>' +
                        '<td>' + (h.gender || '-') + '</td>' +
                        '<td>' + portionDisplay + '</td>' +
                        '<td class="amount-positive">' + fmt(Math.round(shareAmount)) + ' ' + currency + '</td>' +
                        actionsHtml +
                        '</tr>';
                }).join('');

                document.getElementById('reHeirsTable').innerHTML = html || '<tr><td colspan="6">No beneficiaries selected. Select heirs above to calculate Islamic inheritance distribution.</td></tr>';
            });
        }

        // Load Family RE beneficiary selection list
        function loadREBeneficiaryList(heirs) {
            api('/re/beneficiaries').then(function (selectedIds) {
                var html = heirs.map(function (h) {
                    var isSelected = selectedIds.length === 0 || selectedIds.includes(h.id);
                    return '<div class="beneficiary-item ' + (isSelected ? 'selected' : '') + '">' +
                        '<input type="checkbox" id="re-ben-' + h.id + '" ' + (isSelected ? 'checked' : '') + ' onchange="toggleREBeneficiary(' + h.id + ', this.checked)">' +
                        '<label for="re-ben-' + h.id + '">' + h.name + '</label>' +
                        '<span class="heir-info">' + h.relationship + '</span>' +
                        '<span class="heir-portions">' + h.portions + ' portions</span>' +
                        '</div>';
                }).join('');
                document.getElementById('reBeneficiaryList').innerHTML = html || '<p>No heirs available. Add heirs first.</p>';
            });
        }

        // Get selected Family RE beneficiaries from API
        function getREBeneficiaries() {
            // This is now handled by the API
            return [];
        }

        // Toggle Family RE beneficiary selection
        function toggleREBeneficiary(id, checked) {
            var el = document.querySelector('#re-ben-' + id).closest('.beneficiary-item');
            if (checked) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
            // Reactive save and update
            saveREBeneficiaries();
        }

        // Select/Deselect all Family RE beneficiaries
        function selectAllREBeneficiaries(selectAll) {
            var checkboxes = document.querySelectorAll('#reBeneficiaryList input[type="checkbox"]');
            checkboxes.forEach(function (cb) {
                cb.checked = selectAll;
                var el = cb.closest('.beneficiary-item');
                if (selectAll) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
            // Reactive save and update
            saveREBeneficiaries();
        }

        // Save Family RE beneficiary selection
        function saveREBeneficiaries() {
            var checkboxes = document.querySelectorAll('#reBeneficiaryList input[type="checkbox"]:checked');
            var selectedIds = Array.from(checkboxes).map(function (cb) {
                return parseInt(cb.id.replace('re-ben-', ''));
            });

            api('/re/beneficiaries', {
                method: 'POST',
                body: JSON.stringify({ selectedIds: selectedIds })
            }).then(function () {
                loadREInheritance();
            });
        }

        // Reset Family RE heirs to default family members
        function resetREHeirsToDefaults() {
            if (!confirm('This will delete all current heirs and reset to the default 16 family members. Continue?')) return;

            api('/re/heirs/reset-defaults', { method: 'POST' }).then(function (result) {
                if (result.success) {
                    showAlert('Heirs reset to default family members (' + result.count + ' heirs)');
                    loadREInheritance();
                } else {
                    showAlert('Error resetting heirs', 'error');
                }
            });
        }

        // Print single RE heir certificate
        function printREHeirCertificate(heirId) {
            var data = window.reInheritanceData;
            if (!data) {
                showAlert('Please wait for inheritance data to load', 'error');
                return;
            }

            var h = data.beneficiaries.find(function (x) { return x.id === heirId; });
            if (!h) {
                showAlert('Heir not found', 'error');
                return;
            }

            var shareAmount = data.perPortion * (parseFloat(h.portions) || 0);
            var certHtml = generateRECertificateHTML(h, data, shareAmount);
            var w = window.open('', '_blank');
            w.document.write(certHtml);
            w.document.close();
            w.print();
        }

        // Print all RE heir certificates
        function printAllREHeirCertificates() {
            var data = window.reInheritanceData;
            if (!data || !data.beneficiaries || data.beneficiaries.length === 0) {
                showAlert('No beneficiaries to print', 'error');
                return;
            }

            var allCerts = data.beneficiaries.map(function (h) {
                var shareAmount = data.perPortion * (parseFloat(h.portions) || 0);
                return generateRECertificateHTML(h, data, shareAmount, true);
            }).join('<div style="page-break-after: always;"></div>');

            var w = window.open('', '_blank');
            w.document.write('<html><head><title>Family Estate - All Heir Certificates</title></head><body>' + allCerts + '</body></html>');
            w.document.close();
            w.print();
        }

        // Generate RE certificate HTML
        function generateRECertificateHTML(heir, data, shareAmount, isPartOfBatch) {
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            var currency = data.currency || 'XAF';

            return (isPartOfBatch ? '' : '<html><head><title>Heir Certificate - ' + heir.name + '</title></head><body>') +
                '<div style="max-width: 800px; margin: 0 auto; padding: 40px; font-family: Georgia, serif; border: 3px double #d69e2e; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);">' +
                '<div style="text-align: center; border-bottom: 2px solid #d69e2e; padding-bottom: 20px; margin-bottom: 30px;">' +
                '<h1 style="color: #92400e; margin: 0; font-size: 28px;">üè† FAMILY ESTATES</h1>' +
                '<h2 style="color: #78350f; margin: 10px 0; font-size: 20px;">NJIKAM SALIFU ESTATE</h2>' +
                '<p style="color: #a16207; font-style: italic; margin: 5px 0;">Islamic Inheritance Distribution Certificate</p>' +
                '</div>' +

                '<div style="text-align: center; margin-bottom: 30px;">' +
                '<h2 style="color: #1e40af; font-size: 24px; margin: 0;">CERTIFICATE OF INHERITANCE</h2>' +
                '<p style="color: #6b7280; font-size: 14px;">Certificate No: RE-' + new Date().getFullYear() + '-' + String(heir.id).padStart(4, '0') + '</p>' +
                '</div>' +

                '<div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #e5e7eb;">' +
                '<p style="font-size: 16px; line-height: 1.8; text-align: justify;">' +
                'This is to certify that <strong style="color: #1e40af; font-size: 18px;">' + heir.name + '</strong>, ' +
                'being a <strong>' + heir.relationship + '</strong> (' + (heir.gender || 'N/A') + ') of the deceased, ' +
                'is entitled to receive their rightful share of the Family Estate inheritance ' +
                'in accordance with Islamic law (Sharia).' +
                '</p>' +
                '</div>' +

                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">' +
                '<div style="background: #dbeafe; padding: 15px; border-radius: 8px; text-align: center;">' +
                '<p style="margin: 0; color: #6b7280; font-size: 12px;">TOTAL INHERITANCE AMOUNT</p>' +
                '<p style="margin: 5px 0; font-size: 20px; font-weight: bold; color: #1e40af;">' + fmt(Math.round(data.inheritancePool)) + ' ' + currency + '</p>' +
                '</div>' +
                '<div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;">' +
                '<p style="margin: 0; color: #6b7280; font-size: 12px;">TOTAL PORTIONS</p>' +
                '<p style="margin: 5px 0; font-size: 20px; font-weight: bold; color: #92400e;">' + data.totalPortions + '</p>' +
                '</div>' +
                '</div>' +

                '<div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 25px; border-radius: 8px; text-align: center; margin-bottom: 25px; border: 2px solid #22c55e;">' +
                '<p style="margin: 0; color: #166534; font-size: 14px;">HEIR\'S PORTIONS</p>' +
                '<p style="margin: 5px 0; font-size: 24px; font-weight: bold; color: #15803d;">' + heir.portions + ' portion(s)</p>' +
                '<hr style="border: none; border-top: 1px dashed #86efac; margin: 15px 0;">' +
                '<p style="margin: 0; color: #166534; font-size: 14px;">INHERITANCE SHARE AMOUNT</p>' +
                '<p style="margin: 5px 0; font-size: 32px; font-weight: bold; color: #15803d;">' + fmt(Math.round(shareAmount)) + ' ' + currency + '</p>' +
                '</div>' +

                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 50px; padding-top: 30px; border-top: 1px solid #e5e7eb;">' +
                '<div style="text-align: center;">' +
                '<div style="border-top: 2px solid #1e40af; width: 200px; margin: 0 auto;"></div>' +
                '<p style="margin: 10px 0 5px; font-weight: bold;">Estate Administrator</p>' +
                '<p style="margin: 0; color: #6b7280; font-size: 12px;">Date: ' + today + '</p>' +
                '</div>' +
                '<div style="text-align: center;">' +
                '<div style="border-top: 2px solid #1e40af; width: 200px; margin: 0 auto;"></div>' +
                '<p style="margin: 10px 0 5px; font-weight: bold;">Witness</p>' +
                '<p style="margin: 0; color: #6b7280; font-size: 12px;">Date: ' + today + '</p>' +
                '</div>' +
                '</div>' +

                '<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #d69e2e;">' +
                '<p style="color: #92400e; font-size: 11px; margin: 0;">This certificate is issued as part of the Islamic inheritance distribution</p>' +
                '<p style="color: #92400e; font-size: 11px; margin: 5px 0;">for the Family Estate properties of the late NJIKAM SALIFU</p>' +
                '<p style="color: #6b7280; font-size: 10px; margin-top: 10px;">Generated on: ' + today + '</p>' +
                '</div>' +
                '</div>' +
                (isPartOfBatch ? '' : '</body></html>');
        }

        function openREHeirModal() {
            document.getElementById('reHeirId').value = '';
            document.getElementById('reHeirName').value = '';
            document.getElementById('reHeirRel').value = 'Wife';
            document.getElementById('reHeirGender').value = 'Female';
            document.getElementById('reHeirPor').value = 0.125;
            updateIslamicPortions();
            document.getElementById('reHeirModal').classList.add('active');
        }

        function closeREHeirModal() {
            document.getElementById('reHeirModal').classList.remove('active');
        }

        function editREHeir(id) {
            api('/re/heirs').then(function (reHeirs) {
                var h = reHeirs.find(function (x) { return x.id === id; });
                if (h) {
                    document.getElementById('reHeirId').value = h.id;
                    document.getElementById('reHeirName').value = h.name;
                    document.getElementById('reHeirRel').value = h.relationship;
                    document.getElementById('reHeirGender').value = h.gender || 'Male';
                    document.getElementById('reHeirPor').value = h.portions;
                    document.getElementById('reHeirModal').classList.add('active');
                }
            });
        }

        function saveREHeir() {
            var id = document.getElementById('reHeirId').value;
            var name = document.getElementById('reHeirName').value.trim();
            var rel = document.getElementById('reHeirRel').value;
            var gender = document.getElementById('reHeirGender').value;
            var por = parseFloat(document.getElementById('reHeirPor').value) || 0;

            if (!name) {
                showAlert('Please enter heir name', 'error');
                return;
            }

            var data = {
                name: name,
                relationship: rel,
                gender: gender,
                heirGroup: gender === 'Male' ? 'Sons' : (rel === 'Wife' || rel === 'Spouse' ? 'Wives' : 'Daughters'),
                portions: por
            };

            var url = id ? '/re/heirs/' + id : '/re/heirs';
            var method = id ? 'PUT' : 'POST';

            api(url, { method: method, body: JSON.stringify(data) }).then(function () {
                closeREHeirModal();
                showAlert(id ? 'Heir updated!' : 'Heir added!');
                loadREInheritance();
            });
        }

        function deleteREHeir(id) {
            if (!confirm('Delete this heir?')) return;
            api('/re/heirs/' + id, { method: 'DELETE' }).then(function () {
                showAlert('Heir deleted');
                loadREInheritance();
            });
        }

        // ========== RE LEDGER ==========
        function loadRELedgerFull() {
            var currency = getCurrency();

            api('/re/ledger').then(function (ledgerEntries) {
                var runningBalance = 0, totalIncome = 0, totalExpense = 0;

                var html = ledgerEntries.map(function (entry) {
                    var income = parseFloat(entry.income) || 0;
                    var expense = parseFloat(entry.expense) || 0;
                    runningBalance = parseFloat(entry.balance) || (runningBalance + income - expense);
                    totalIncome += income;
                    totalExpense += expense;

                    var isIncome = income > 0;
                    var isInh = entry.type === 'Inheritance Share';

                    return '<tr>' +
                        '<td>' + fmtDate(entry.date) + '</td>' +
                        '<td>' + (entry.property || 'N/A') + '</td>' +
                        '<td>' + (entry.description || '') + '</td>' +
                        '<td><span class="badge ' + (isIncome ? 'badge-income' : isInh ? 'badge-inheritance' : 'badge-expense') + '">' + entry.type + '</span></td>' +
                        '<td class="amount-positive">' + (income > 0 ? fmt(Math.round(income)) : '-') + '</td>' +
                        '<td class="' + (isInh ? 'amount-gold' : 'amount-negative') + '">' + (expense > 0 ? fmt(Math.round(expense)) : '-') + '</td>' +
                        '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(Math.round(runningBalance)) + '</td>' +
                        '</tr>';
                }).join('');

                document.getElementById('reLedgerTable').innerHTML = html || '<tr><td colspan="7">No transactions</td></tr>';
                document.getElementById('reLedgerTotals').innerHTML =
                    '<tr style="background: #f7fafc; font-weight: bold;">' +
                    '<td colspan="4" style="text-align: right;">TOTALS (' + currency + '):</td>' +
                    '<td class="amount-positive">' + fmt(Math.round(totalIncome)) + '</td>' +
                    '<td class="amount-negative">' + fmt(Math.round(totalExpense)) + '</td>' +
                    '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(Math.round(runningBalance)) + '</td>' +
                    '</tr>';
            });
        }

        // ========== RE SETTINGS & EXPORT ==========
        // ========== RE SETTINGS FUNCTIONS ==========
        function loadRESettings() {
            Promise.all([api('/properties'), api('/re/settings')]).then(function (results) {
                var properties = results[0];
                var settings = results[1];

                // Load global settings
                if (settings.taxRate) document.getElementById('reSettingTaxRate').value = settings.taxRate;
                if (settings.period) document.getElementById('reSettingPeriod').value = settings.period;
                if (settings.currency) document.getElementById('reSettingCurrency').value = settings.currency;
                if (settings.reservedFundsPercent) document.getElementById('reSettingReservedPercent').value = settings.reservedFundsPercent;

                // Update cache
                reSettingsCache = settings;

                // Populate property dropdown
                document.getElementById('reSettingProperty').innerHTML = '<option value="">-- Select a Property --</option>' +
                    properties.map(function (p) {
                        return '<option value="' + p.id + '">' + p.name + ' (' + p.status + ')</option>';
                    }).join('');

                // Render properties overview table
                renderSettingsPropertiesTable();
            });
        }

        function renderSettingsPropertiesTable() {
            Promise.all([api('/properties'), api('/re/settings')]).then(function (results) {
                var properties = results[0];
                var settings = results[1];
                var currency = settings.currency || 'XAF';

                var html = properties.map(function (p) {
                    var isRented = p.status === 'Rented';
                    return '<tr>' +
                        '<td><strong>' + p.name + '</strong><br><small style="color: #718096;">' + p.location + '</small></td>' +
                        '<td><span class="badge ' + (isRented ? 'badge-paid' : 'badge-unpaid') + '">' + p.status + '</span></td>' +
                        '<td>' + (p.tax_rate || 0) + '%</td>' +
                        '<td>' + (p.rent_period || '-') + '</td>' +
                        '<td>' + (isRented ? fmt(p.rent_amount || 0) + ' ' + currency : '-') + '</td>' +
                        '</tr>';
                }).join('');

                document.getElementById('reSettingsPropertiesTable').innerHTML = html || '<tr><td colspan="5">No properties added yet</td></tr>';
            });
        }

        function loadPropertySettings() {
            var propertyId = parseInt(document.getElementById('reSettingProperty').value);
            if (!propertyId) {
                document.getElementById('reSettingPropTaxRate').value = '15';
                document.getElementById('reSettingPropPeriod').value = 'Monthly';
                document.getElementById('reSettingPropRent').value = '';
                document.getElementById('reSettingPropStatus').value = 'Rented';
                return;
            }

            api('/properties/' + propertyId).then(function (prop) {
                if (prop) {
                    document.getElementById('reSettingPropTaxRate').value = prop.tax_rate || '15';
                    document.getElementById('reSettingPropPeriod').value = prop.rent_period || 'Monthly';
                    document.getElementById('reSettingPropRent').value = prop.rent_amount || '';
                    document.getElementById('reSettingPropStatus').value = prop.status || 'Rented';
                }
            });
        }

        function savePropertySettings() {
            var propertyId = parseInt(document.getElementById('reSettingProperty').value);
            if (!propertyId) {
                showAlert('Please select a property first', 'error');
                return;
            }

            var taxRate = document.getElementById('reSettingPropTaxRate').value;
            var period = document.getElementById('reSettingPropPeriod').value;
            var rentAmount = parseFloat(document.getElementById('reSettingPropRent').value) || 0;
            var status = document.getElementById('reSettingPropStatus').value;

            // If not rented, clear rent values
            if (status !== 'Rented') {
                rentAmount = 0;
            }

            api('/properties/' + propertyId).then(function (prop) {
                return api('/properties/' + propertyId, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: prop.name,
                        location: prop.location,
                        type: prop.type,
                        status: status,
                        rent_amount: rentAmount,
                        rent_period: period,
                        tax_rate: taxRate,
                        islamic_inheritance: prop.islamic_inheritance,
                        notes: prop.notes
                    })
                });
            }).then(function () {
                showAlert('Property settings saved!');
                renderSettingsPropertiesTable();
                loadRealEstate();
            });
        }

        function saveGlobalRESettings() {
            var taxRate = document.getElementById('reSettingTaxRate').value;
            var period = document.getElementById('reSettingPeriod').value;
            var currency = document.getElementById('reSettingCurrency').value;
            var reservedPercent = document.getElementById('reSettingReservedPercent').value;

            // Save global settings to PostgreSQL
            Promise.all([
                api('/re/settings', { method: 'POST', body: JSON.stringify({ key: 'taxRate', value: taxRate }) }),
                api('/re/settings', { method: 'POST', body: JSON.stringify({ key: 'period', value: period }) }),
                api('/re/settings', { method: 'POST', body: JSON.stringify({ key: 'currency', value: currency }) }),
                api('/re/settings', { method: 'POST', body: JSON.stringify({ key: 'reservedFundsPercent', value: reservedPercent }) })
            ]).then(function () {
                reSettingsCache = { taxRate: taxRate, period: period, currency: currency, reservedFundsPercent: reservedPercent };
                showAlert('Global settings saved! Reserved Funds set to ' + reservedPercent + '% of income.');
                renderSettingsPropertiesTable();
                loadRealEstate();
            });
        }

        function previewGlobalSettings() {
            // Optional: Show preview of changes
        }

        function resetREData() {
            if (!confirm('This will delete ALL Real Estate data. Are you sure?')) return;
            if (!confirm('FINAL WARNING: This cannot be undone!')) return;

            // Reset data via API - delete all properties, bills, payments, expenses
            Promise.all([
                api('/properties').then(function (props) {
                    return Promise.all(props.map(function (p) {
                        return api('/properties/' + p.id, { method: 'DELETE' });
                    }));
                }),
                api('/re/bills').then(function (bills) {
                    return Promise.all(bills.map(function (b) {
                        return api('/re/bills/' + b.id, { method: 'DELETE' });
                    }));
                }),
                api('/re/payments').then(function (payments) {
                    return Promise.all(payments.map(function (p) {
                        return api('/re/payments/' + p.id, { method: 'DELETE' });
                    }));
                }),
                api('/re/expenses').then(function (expenses) {
                    return Promise.all(expenses.map(function (e) {
                        return api('/re/expenses/' + e.id, { method: 'DELETE' });
                    }));
                }),
                api('/re/heirs/reset-defaults', { method: 'POST' })
            ]).then(function () {
                showAlert('All RE data reset');
                loadRealEstate();
            });
        }

        // ========== RE PDF EXPORT FUNCTIONS ==========
        function exportREPropertiesPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var currency = getCurrency();
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            api('/properties').then(function (properties) {
                // Background
                doc.setFillColor(254, 249, 231);
                doc.rect(0, 0, 210, 297, 'F');

                // Header bar
                doc.setFillColor(44, 82, 130);
                doc.rect(10, 10, 190, 30, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('FAMILY ESTATES', 105, 22, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('NJIKAM SALIFU ESTATE', 105, 29, { align: 'center' });
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(144, 205, 244);
                doc.text('Properties Report', 105, 36, { align: 'center' });

                // Title
                doc.setTextColor(44, 82, 130);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('PROPERTY INVENTORY', 105, 52, { align: 'center' });

                var tableData = properties.map(function (p) {
                    var isRented = p.status === 'Rented';
                    var rent = isRented ? (parseFloat(p.rent_amount) || 0) : 0;
                    var tax = isRented ? (parseFloat(p.tax_rate) || 0) : 0;
                    var net = rent - (rent * tax / 100);
                    return [p.name, p.location, p.type || '-', p.status, fmt(rent), tax + '%', fmt(Math.round(net))];
                });

                doc.autoTable({
                    startY: 58,
                    head: [['Property', 'Location', 'Type', 'Status', 'Rent', 'Tax', 'Net Income']],
                    body: tableData,
                    styles: { fontSize: 8, cellPadding: 3 },
                    headStyles: { fillColor: [44, 82, 130], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [254, 249, 231] }
                });

                // Footer
                var finalY = doc.lastAutoTable.finalY + 10;
                doc.setFillColor(247, 250, 252);
                doc.rect(10, finalY, 190, 20, 'F');
                doc.setFontSize(8);
                doc.setTextColor(113, 128, 150);
                doc.text('Total Properties: ' + properties.length, 105, finalY + 8, { align: 'center' });
                doc.text('Generated on: ' + today, 105, finalY + 14, { align: 'center' });

                doc.save('re_properties_' + new Date().toISOString().split('T')[0] + '.pdf');
                showAlert('Properties PDF exported!');
            });
        }

        function exportREBillsPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('landscape');
            var currency = getCurrency();
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            Promise.all([api('/re/bills'), api('/properties')]).then(function (results) {
                var reBills = results[0] || [];
                var properties = results[1] || [];

                // Background
                doc.setFillColor(254, 249, 231);
                doc.rect(0, 0, 297, 210, 'F');

                // Header bar
                doc.setFillColor(56, 161, 105);
                doc.rect(10, 10, 277, 25, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('FAMILY ESTATES - BILLS REPORT', 148, 20, { align: 'center' });
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('NJIKAM SALIFU ESTATE', 148, 28, { align: 'center' });

                var totalGross = 0, totalTax = 0, totalNet = 0;

                var tableData = reBills.map(function (b) {
                    var prop = properties.find(function (p) { return p.id === b.property_id; });
                    var grossAmount = prop ? (parseFloat(prop.rent_amount) || 0) : (parseFloat(b.amount) || 0);
                    var taxRate = prop ? (parseFloat(prop.tax_rate) || 0) : 0;
                    var taxAmount = grossAmount * taxRate / 100;
                    var netAmount = grossAmount - taxAmount;

                    totalGross += grossAmount;
                    totalTax += taxAmount;
                    totalNet += netAmount;

                    return ['BILL-' + b.id, prop ? prop.name : 'N/A', prop ? prop.rent_period : '-', fmtDate(b.bill_date), fmt(Math.round(grossAmount)), taxRate + '%', fmt(Math.round(taxAmount)), fmt(Math.round(netAmount)), b.notes || '-'];
                });

                doc.autoTable({
                    startY: 40,
                    head: [['Bill #', 'Property', 'Period', 'Date', 'Gross', 'Tax %', 'Tax Amt', 'Net Due', 'Description']],
                    body: tableData,
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [56, 161, 105], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [240, 255, 244] }
                });

                // Totals
                var finalY = doc.lastAutoTable.finalY + 5;
                doc.setFillColor(56, 161, 105);
                doc.rect(10, finalY, 277, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTALS - Gross: ' + fmt(Math.round(totalGross)) + ' | Tax: ' + fmt(Math.round(totalTax)) + ' | Net: ' + fmt(Math.round(totalNet)) + ' ' + currency, 148, finalY + 7, { align: 'center' });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(113, 128, 150);
                doc.text('Generated on: ' + today, 148, finalY + 18, { align: 'center' });

                doc.save('re_bills_' + new Date().toISOString().split('T')[0] + '.pdf');
                showAlert('Bills PDF exported!');
            });
        }

        function exportREPaymentsPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var currency = getCurrency();
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            Promise.all([api('/re/payments'), api('/re/bills'), api('/properties')]).then(function (results) {
                var rePayments = results[0] || [];
                var reBills = results[1] || [];
                var properties = results[2] || [];

                // Background
                doc.setFillColor(254, 249, 231);
                doc.rect(0, 0, 210, 297, 'F');

                // Header bar
                doc.setFillColor(66, 153, 225);
                doc.rect(10, 10, 190, 30, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('FAMILY ESTATES', 105, 22, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('NJIKAM SALIFU ESTATE', 105, 29, { align: 'center' });
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(190, 227, 248);
                doc.text('Payment History Report', 105, 36, { align: 'center' });

                // Title
                doc.setTextColor(44, 82, 130);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('PAYMENT HISTORY', 105, 52, { align: 'center' });

                var totalAmount = 0;

                var tableData = rePayments.map(function (p) {
                    var bill = reBills.find(function (b) { return b.id === p.bill_id; });
                    var prop = bill ? properties.find(function (pr) { return pr.id === bill.property_id; }) : null;
                    var amount = parseFloat(p.amount) || 0;
                    totalAmount += amount;
                    return [fmtDate(p.payment_date), prop ? prop.name : 'N/A', 'BILL-' + (p.bill_id || 'N/A'), fmt(Math.round(amount)), p.reference || '-'];
                });

                doc.autoTable({
                    startY: 58,
                    head: [['Date', 'Property', 'Bill #', 'Amount', 'Reference']],
                    body: tableData,
                    styles: { fontSize: 9, cellPadding: 4 },
                    headStyles: { fillColor: [66, 153, 225], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [235, 248, 255] },
                    columnStyles: { 3: { halign: 'right', fontStyle: 'bold' } }
                });

                // Totals
                var finalY = doc.lastAutoTable.finalY + 5;
                doc.setFillColor(66, 153, 225);
                doc.rect(10, finalY, 190, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL PAYMENTS: ' + fmt(Math.round(totalAmount)) + ' ' + currency, 105, finalY + 7, { align: 'center' });

                // Footer
                doc.setFillColor(247, 250, 252);
                doc.rect(10, finalY + 15, 190, 20, 'F');
                doc.setFontSize(8);
                doc.setTextColor(113, 128, 150);
                doc.text('This report shows all recorded payments for Family Estate properties', 105, finalY + 23, { align: 'center' });
                doc.text('Generated on: ' + today, 105, finalY + 29, { align: 'center' });

                doc.save('re_payments_' + new Date().toISOString().split('T')[0] + '.pdf');
                showAlert('Payments PDF exported!');
            });
        }

        function exportREExpensesPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var currency = getCurrency();
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            Promise.all([api('/re/expenses'), api('/properties')]).then(function (results) {
                var reExpenses = results[0] || [];
                var properties = results[1] || [];

                // Background
                doc.setFillColor(254, 249, 231);
                doc.rect(0, 0, 210, 297, 'F');

                // Header bar
                doc.setFillColor(229, 62, 62);
                doc.rect(10, 10, 190, 30, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('FAMILY ESTATES', 105, 22, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('NJIKAM SALIFU ESTATE', 105, 29, { align: 'center' });
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(254, 215, 215);
                doc.text('Expenses Report', 105, 36, { align: 'center' });

                // Title
                doc.setTextColor(197, 48, 48);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('PROPERTY EXPENSES', 105, 52, { align: 'center' });

                var total = 0;
                var tableData = reExpenses.map(function (e) {
                    var prop = properties.find(function (p) { return p.id === e.property_id; });
                    var amount = parseFloat(e.amount) || 0;
                    total += amount;
                    var isInheritance = e.category === 'Inheritance Allocation';
                    return [fmtDate(e.expense_date), prop ? prop.name : 'General', e.category, e.description, fmt(Math.round(amount))];
                });

                doc.autoTable({
                    startY: 58,
                    head: [['Date', 'Property', 'Category', 'Description', 'Amount']],
                    body: tableData,
                    styles: { fontSize: 9, cellPadding: 4 },
                    headStyles: { fillColor: [229, 62, 62], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [254, 242, 242] },
                    columnStyles: { 4: { halign: 'right', fontStyle: 'bold' } }
                });

                // Totals
                var finalY = doc.lastAutoTable.finalY + 5;
                doc.setFillColor(229, 62, 62);
                doc.rect(10, finalY, 190, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL EXPENSES: ' + fmt(Math.round(total)) + ' ' + currency, 105, finalY + 7, { align: 'center' });

                // Footer
                doc.setFillColor(247, 250, 252);
                doc.rect(10, finalY + 15, 190, 20, 'F');
                doc.setFontSize(8);
                doc.setTextColor(113, 128, 150);
                doc.text('This report shows all recorded expenses for Family Estate properties', 105, finalY + 23, { align: 'center' });
                doc.text('Generated on: ' + today, 105, finalY + 29, { align: 'center' });

                doc.save('re_expenses_' + new Date().toISOString().split('T')[0] + '.pdf');
                showAlert('Expenses PDF exported!');
            });
        }

        function exportRELedgerPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('landscape');
            var currency = getCurrency();
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            Promise.all([api('/re/payments'), api('/re/expenses'), api('/re/bills'), api('/properties'), api('/re/settings')]).then(function (results) {
                var rePayments = Array.isArray(results[0]) ? results[0] : [];
                var reExpenses = Array.isArray(results[1]) ? results[1] : [];
                var reBills = Array.isArray(results[2]) ? results[2] : [];
                var properties = Array.isArray(results[3]) ? results[3] : [];
                var settings = results[4] || {};

                console.log('Ledger PDF Data:', { payments: rePayments.length, expenses: reExpenses.length, bills: reBills.length, properties: properties.length });

                // Background
                doc.setFillColor(254, 249, 231);
                doc.rect(0, 0, 297, 210, 'F');

                // Header bar
                doc.setFillColor(44, 82, 130);
                doc.rect(10, 10, 277, 28, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('FAMILY ESTATES', 148, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('NJIKAM SALIFU ESTATE', 148, 27, { align: 'center' });
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(144, 205, 244);
                doc.text('Estate Ledger Report', 148, 34, { align: 'center' });

                // Title
                doc.setTextColor(44, 82, 130);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('ESTATE LEDGER', 148, 48, { align: 'center' });

                var ledgerEntries = [];

                // Payments as income
                rePayments.forEach(function (p) {
                    var bill = reBills.find(function (b) { return b.id === p.bill_id; });
                    var prop = bill ? properties.find(function (pr) { return pr.id === bill.property_id; }) : null;
                    var amount = parseFloat(p.amount) || 0;
                    ledgerEntries.push({
                        date: p.payment_date || new Date().toISOString().split('T')[0],
                        property: prop ? prop.name : 'N/A',
                        desc: 'Payment - ' + (p.reference || 'BILL-' + p.bill_id),
                        type: 'Income',
                        income: amount,
                        expense: 0
                    });
                });

                // Expenses
                reExpenses.forEach(function (e) {
                    var prop = properties.find(function (p) { return p.id === e.property_id; });
                    ledgerEntries.push({
                        date: e.expense_date || new Date().toISOString().split('T')[0],
                        property: prop ? prop.name : 'General',
                        desc: e.description || 'Expense',
                        type: e.category || 'Other',
                        income: 0,
                        expense: parseFloat(e.amount) || 0
                    });
                });

                // Sort by date
                ledgerEntries.sort(function (a, b) { return new Date(a.date) - new Date(b.date); });

                var balance = 0, totalIn = 0, totalOut = 0;
                var tableData = ledgerEntries.map(function (e) {
                    balance += e.income - e.expense;
                    totalIn += e.income;
                    totalOut += e.expense;
                    return [
                        fmtDate(e.date),
                        e.property || '-',
                        e.desc || '-',
                        e.type || '-',
                        e.income > 0 ? fmt(Math.round(e.income)) : '-',
                        e.expense > 0 ? fmt(Math.round(e.expense)) : '-',
                        fmt(Math.round(balance))
                    ];
                });

                if (tableData.length === 0) {
                    tableData = [['No transactions recorded', '-', '-', '-', '-', '-', '0']];
                }

                doc.autoTable({
                    startY: 54,
                    head: [['Date', 'Property', 'Description', 'Type', 'Income', 'Expense', 'Balance']],
                    body: tableData,
                    styles: { fontSize: 8, cellPadding: 3 },
                    headStyles: { fillColor: [44, 82, 130], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [254, 249, 231] }
                });

                // Summary boxes
                var finalY = doc.lastAutoTable.finalY + 8;

                // Income box
                doc.setFillColor(240, 255, 244);
                doc.setDrawColor(56, 161, 105);
                doc.roundedRect(10, finalY, 85, 20, 2, 2, 'FD');
                doc.setTextColor(39, 103, 73);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL INCOME', 52, finalY + 7, { align: 'center' });
                doc.setFontSize(12);
                doc.setTextColor(56, 161, 105);
                doc.text(fmt(Math.round(totalIn)) + ' ' + currency, 52, finalY + 15, { align: 'center' });

                // Expenses box
                doc.setFillColor(254, 242, 242);
                doc.setDrawColor(229, 62, 62);
                doc.roundedRect(100, finalY, 85, 20, 2, 2, 'FD');
                doc.setTextColor(116, 42, 42);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL EXPENSES', 142, finalY + 7, { align: 'center' });
                doc.setFontSize(12);
                doc.setTextColor(229, 62, 62);
                doc.text(fmt(Math.round(totalOut)) + ' ' + currency, 142, finalY + 15, { align: 'center' });

                // Balance box
                doc.setFillColor(235, 248, 255);
                doc.setDrawColor(66, 153, 225);
                doc.roundedRect(190, finalY, 97, 20, 2, 2, 'FD');
                doc.setTextColor(44, 82, 130);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('NET BALANCE', 238, finalY + 7, { align: 'center' });
                doc.setFontSize(12);
                // Fix: Use individual RGB values instead of array
                if (balance >= 0) {
                    doc.setTextColor(56, 161, 105);
                } else {
                    doc.setTextColor(229, 62, 62);
                }
                doc.text(fmt(Math.round(balance)) + ' ' + currency, 238, finalY + 15, { align: 'center' });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(113, 128, 150);
                doc.text('Generated on: ' + today, 148, finalY + 30, { align: 'center' });

                doc.save('estate_ledger_' + new Date().toISOString().split('T')[0] + '.pdf');
                showAlert('Estate Ledger PDF exported!');
            }).catch(function (err) {
                console.error('Ledger PDF export error:', err);
                showAlert('Error exporting ledger: ' + (err.message || 'Unknown error'), 'error');
            });
        }

        function exportREHeirsPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var currency = getCurrency();
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Use API to get inheritance data
            api('/re/inheritance/calculate').then(function (data) {
                var beneficiaries = data.heirs || [];
                var pool = data.inheritancePool || 0;
                var totalPortions = data.totalPortions || 0;
                var perPortion = data.perPortion || 0;

                // Background color (cream/beige)
                doc.setFillColor(254, 249, 231);
                doc.rect(0, 0, 210, 297, 'F');

                // Header bar (dark blue)
                doc.setFillColor(44, 82, 130);
                doc.rect(10, 10, 190, 35, 'F');

                // Header text
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('FAMILY ESTATES', 105, 22, { align: 'center' });
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text('NJIKAM SALIFU ESTATE', 105, 30, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(144, 205, 244);
                doc.text('Islamic Inheritance Distribution Report', 105, 38, { align: 'center' });

                // Dotted line
                doc.setDrawColor(201, 162, 39);
                doc.setLineDash([2, 2]);
                doc.line(20, 52, 190, 52);
                doc.setLineDash([]);

                // Title
                doc.setTextColor(44, 82, 130);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('INHERITANCE DISTRIBUTION', 105, 62, { align: 'center' });

                // Summary boxes
                // Inheritance Amount (blue)
                doc.setFillColor(235, 248, 255);
                doc.setDrawColor(49, 130, 206);
                doc.roundedRect(20, 70, 55, 25, 3, 3, 'FD');
                doc.setTextColor(44, 82, 130);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('INHERITANCE AMOUNT', 47.5, 78, { align: 'center' });
                doc.setFontSize(11);
                doc.text(fmt(Math.round(pool)) + ' ' + currency, 47.5, 88, { align: 'center' });

                // Total Portions (green)
                doc.setFillColor(240, 255, 244);
                doc.setDrawColor(56, 161, 105);
                doc.roundedRect(80, 70, 45, 25, 3, 3, 'FD');
                doc.setTextColor(39, 103, 73);
                doc.setFontSize(8);
                doc.text('TOTAL PORTIONS', 102.5, 78, { align: 'center' });
                doc.setFontSize(11);
                doc.setTextColor(56, 161, 105);
                doc.text(String(Math.round(totalPortions * 1000) / 1000), 102.5, 88, { align: 'center' });

                // Per Portion (gold)
                doc.setFillColor(255, 250, 240);
                doc.setDrawColor(201, 162, 39);
                doc.roundedRect(130, 70, 60, 25, 3, 3, 'FD');
                doc.setTextColor(116, 66, 16);
                doc.setFontSize(8);
                doc.text('VALUE PER PORTION', 160, 78, { align: 'center' });
                doc.setFontSize(11);
                doc.setTextColor(212, 175, 55);
                doc.text(fmt(Math.round(perPortion)) + ' ' + currency, 160, 88, { align: 'center' });

                // Table data with share amounts
                var tableData = beneficiaries.map(function (h) {
                    var shareAmount = h.shareAmount || (perPortion * (parseFloat(h.portions) || 0));
                    var portionDisplay = h.portions;
                    if (h.portions === 0.125) portionDisplay = '1/8';
                    else if (h.portions === 0.25) portionDisplay = '1/4';
                    else if (h.portions === 0.5) portionDisplay = '1/2';
                    else if (Math.abs(h.portions - 0.167) < 0.01) portionDisplay = '1/6';
                    else if (Math.abs(h.portions - 0.333) < 0.01) portionDisplay = '1/3';
                    else if (h.portions === 2) portionDisplay = '2';
                    else if (h.portions === 1) portionDisplay = '1';
                    return [h.name, h.relationship, h.gender || '-', portionDisplay, fmt(Math.round(shareAmount)) + ' ' + currency];
                });

                // Heirs table
                doc.autoTable({
                    startY: 102,
                    head: [['Heir Name', 'Relationship', 'Gender', 'Portions', 'Share Amount']],
                    body: tableData,
                    styles: {
                        fontSize: 9,
                        cellPadding: 4
                    },
                    headStyles: {
                        fillColor: [44, 82, 130],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [254, 249, 231]
                    },
                    columnStyles: {
                        4: { halign: 'right', fontStyle: 'bold', textColor: [56, 161, 105] }
                    }
                });

                // Get final Y position after table
                var finalY = doc.lastAutoTable.finalY || 150;

                // Total row
                var totalShares = beneficiaries.reduce(function (sum, h) {
                    return sum + (h.shareAmount || (perPortion * (parseFloat(h.portions) || 0)));
                }, 0);

                doc.setFillColor(212, 175, 55);
                doc.rect(20, finalY + 5, 170, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL DISTRIBUTION:', 25, finalY + 12);
                doc.text(fmt(Math.round(totalShares)) + ' ' + currency, 185, finalY + 12, { align: 'right' });

                // Footer
                var footerY = finalY + 30;
                doc.setFillColor(247, 250, 252);
                doc.rect(10, footerY, 190, 25, 'F');
                doc.setFontSize(8);
                doc.setTextColor(113, 128, 150);
                doc.text('This report is generated as part of the Islamic inheritance distribution', 105, footerY + 8, { align: 'center' });
                doc.text('for the Family Estate properties of the late NJIKAM SALIFU', 105, footerY + 14, { align: 'center' });
                doc.setTextColor(160, 174, 192);
                doc.text('Generated on: ' + today, 105, footerY + 21, { align: 'center' });

                doc.save('re_inheritance_distribution_' + new Date().toISOString().split('T')[0] + '.pdf');
                showAlert('Inheritance PDF exported!');
            });
        }

        function exportRERentalIncomePDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var currency = getCurrency();
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            api('/properties').then(function (properties) {
                properties = properties || [];

                // Background
                doc.setFillColor(254, 249, 231);
                doc.rect(0, 0, 210, 297, 'F');

                // Header bar
                doc.setFillColor(212, 175, 55);
                doc.rect(10, 10, 190, 30, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('FAMILY ESTATES', 105, 22, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('NJIKAM SALIFU ESTATE', 105, 29, { align: 'center' });
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(255, 250, 240);
                doc.text('Rental Income Report', 105, 36, { align: 'center' });

                // Title
                doc.setTextColor(116, 66, 16);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('RENTAL INCOME SUMMARY', 105, 52, { align: 'center' });

                var totalGross = 0, totalTax = 0, totalNet = 0;
                var tableData = properties.map(function (p) {
                    var isRented = p.status === 'Rented';
                    var rent = isRented ? (parseFloat(p.rent_amount) || 0) : 0;
                    var taxRate = isRented ? (parseFloat(p.tax_rate) || 0) : 0;
                    var taxAmt = rent * taxRate / 100;
                    var net = rent - taxAmt;
                    totalGross += rent;
                    totalTax += taxAmt;
                    totalNet += net;
                    return [p.name, p.location, p.status, p.rent_period || '-', fmt(rent), taxRate + '%', fmt(Math.round(taxAmt)), fmt(Math.round(net))];
                });

                doc.autoTable({
                    startY: 58,
                    head: [['Property', 'Location', 'Status', 'Period', 'Gross Rent', 'Tax %', 'Tax Amt', 'Net Income']],
                    body: tableData,
                    styles: { fontSize: 8, cellPadding: 3 },
                    headStyles: { fillColor: [212, 175, 55], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [255, 250, 240] },
                    columnStyles: {
                        4: { halign: 'right' },
                        6: { halign: 'right', textColor: [229, 62, 62] },
                        7: { halign: 'right', fontStyle: 'bold', textColor: [56, 161, 105] }
                    }
                });

                // Summary boxes
                var finalY = doc.lastAutoTable.finalY + 8;

                // Gross box
                doc.setFillColor(254, 243, 199);
                doc.setDrawColor(212, 175, 55);
                doc.roundedRect(10, finalY, 60, 22, 2, 2, 'FD');
                doc.setTextColor(116, 66, 16);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('GROSS INCOME', 40, finalY + 7, { align: 'center' });
                doc.setFontSize(11);
                doc.text(fmt(Math.round(totalGross)) + ' ' + currency, 40, finalY + 16, { align: 'center' });

                // Tax box
                doc.setFillColor(254, 242, 242);
                doc.setDrawColor(229, 62, 62);
                doc.roundedRect(75, finalY, 60, 22, 2, 2, 'FD');
                doc.setTextColor(116, 42, 42);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL TAX', 105, finalY + 7, { align: 'center' });
                doc.setFontSize(11);
                doc.setTextColor(229, 62, 62);
                doc.text(fmt(Math.round(totalTax)) + ' ' + currency, 105, finalY + 16, { align: 'center' });

                // Net box
                doc.setFillColor(240, 255, 244);
                doc.setDrawColor(56, 161, 105);
                doc.roundedRect(140, finalY, 60, 22, 2, 2, 'FD');
                doc.setTextColor(39, 103, 73);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('NET INCOME', 170, finalY + 7, { align: 'center' });
                doc.setFontSize(11);
                doc.setTextColor(56, 161, 105);
                doc.text(fmt(Math.round(totalNet)) + ' ' + currency, 170, finalY + 16, { align: 'center' });

                // Footer
                doc.setFillColor(247, 250, 252);
                doc.rect(10, finalY + 28, 190, 20, 'F');
                doc.setFontSize(8);
                doc.setTextColor(113, 128, 150);
                doc.text('This report shows expected rental income from all properties', 105, finalY + 36, { align: 'center' });
                doc.text('Generated on: ' + today, 105, finalY + 42, { align: 'center' });

                doc.save('re_rental_income_' + new Date().toISOString().split('T')[0] + '.pdf');
                showAlert('Rental Income PDF exported!');
            });
        }

        function exportAllRECSV() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');

            var csv = 'FAMILY ESTATES - GHOUENZEN Soulemanou\nGenerated: ' + new Date().toLocaleDateString() + '\n\n';

            csv += 'PROPERTIES\nName,Location,Type,Status,Rent,Period,Tax,Net,Islamic Inh\n';
            properties.forEach(function (p) {
                var isRented = p.status === 'Rented';
                var rent = isRented ? (p.rent_amount || 0) : 0;
                var tax = isRented ? (p.tax_rate || 0) : 0;
                var net = rent - (rent * tax / 100);
                csv += '"' + p.name + '","' + p.location + '",' + p.type + ',' + p.status + ',' + rent + ',' + (isRented ? p.rent_period : '-') + ',' + tax + '%,' + Math.round(net) + ',' + (p.islamic_inheritance || 'NA') + '\n';
            });

            csv += '\nBILLS\nBill #,Property,Period,Year,Amount,Paid,Outstanding,Status\n';
            reBills.forEach(function (b) {
                var prop = properties.find(function (p) { return p.id === b.property_id; });
                var status = b.outstanding === 0 ? 'Paid' : b.paid_amount > 0 ? 'Partial' : 'Unpaid';
                csv += b.bill_number + ',"' + (prop ? prop.name : '') + '",' + b.period + ',' + b.year + ',' + b.amount_due + ',' + (b.paid_amount || 0) + ',' + b.outstanding + ',' + status + '\n';
            });

            csv += '\nPAYMENTS\nDate,Property,Bill,Amount,Reference\n';
            rePayments.forEach(function (p) {
                var bill = reBills.find(function (b) { return b.id === p.bill_id; });
                var prop = bill ? properties.find(function (pr) { return pr.id === bill.property_id; }) : null;
                csv += p.payment_date + ',"' + (prop ? prop.name : '') + '",' + (bill ? bill.bill_number : '') + ',' + p.amount + ',"' + (p.reference || '') + '"\n';
            });

            csv += '\nEXPENSES\nDate,Property,Category,Description,Amount\n';
            reExpenses.forEach(function (e) {
                var prop = properties.find(function (p) { return p.id === e.property_id; });
                csv += e.expense_date + ',"' + (prop ? prop.name : 'General') + '",' + e.category + ',"' + e.description + '",' + e.amount + '\n';
            });

            var blob = new Blob([csv], { type: 'text/csv' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'family_real_estates_all_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            showAlert('All CSV exported!');
        }

        function exportAllREPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');

            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('FAMILY ESTATES - COMPLETE REPORT', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | Generated: ' + new Date().toLocaleDateString(), 105, 22, { align: 'center' });
            doc.line(20, 25, 190, 25);

            doc.setFontSize(12);
            doc.text('Properties Summary', 20, 35);

            doc.autoTable({
                startY: 40,
                head: [['Property', 'Location', 'Status', 'Rent', 'Tax', 'Net']],
                body: properties.map(function (p) {
                    var isRented = p.status === 'Rented';
                    var rent = isRented ? (p.rent_amount || 0) : 0;
                    var tax = isRented ? (p.tax_rate || 0) : 0;
                    var net = rent - (rent * tax / 100);
                    return [p.name, p.location, p.status, fmt(rent), tax + '%', fmt(Math.round(net))];
                }),
                styles: { fontSize: 7 },
                headStyles: { fillColor: [44, 82, 130] }
            });

            doc.save('family_real_estates_complete_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('Complete PDF exported!');
        }

        // ==================== RESIDENCE ASSETS MODULE ====================

        // Assets data - hardcoded based on inventory document
        var ASSETS_DATA = {
            oldTown: {
                living: [
                    { item: '3-Seater Sofa (Fabric)', value: 85000 },
                    { item: '2-Seater Sofa (Fabric)', value: 60000 },
                    { item: 'Coffee Table (Wood & Glass)', value: 35000 },
                    { item: 'Side Tables (Set of 2)', value: 25000 },
                    { item: 'TV Stand/Entertainment Unit', value: 45000 },
                    { item: 'LCD Television (43-inch)', value: 150000 },
                    { item: 'Area Rug (Medium)', value: 30000 },
                    { item: 'Floor Lamp', value: 15000 },
                    { item: 'Decorative Mirrors & Wall Art', value: 40000 },
                    { item: 'Bookshelf (Large, Wooden)', value: 55000 },
                    { item: 'Ceiling Fan', value: 25000 },
                    { item: 'Air Conditioner (2.5 HP)', value: 180000 }
                ],
                kitchen: [
                    { item: 'Dining Table with 6 Chairs', value: 120000 },
                    { item: 'Sideboard/Buffet Cabinet', value: 45000 },
                    { item: 'Refrigerator (Double Door)', value: 220000 },
                    { item: 'Gas Cooker (4 Burner + Oven)', value: 90000 },
                    { item: 'Microwave Oven', value: 40000 },
                    { item: 'Blender & Food Processor Set', value: 25000 },
                    { item: 'Complete Dinnerware Set (for 12)', value: 60000 },
                    { item: 'Cookware Set (Pots & Pans)', value: 55000 },
                    { item: 'Kitchen Utensils & Cutlery', value: 35000 }
                ],
                master: [
                    { item: 'Queen Size Bed Frame', value: 75000 },
                    { item: 'Quality Mattress & Box Spring', value: 130000 },
                    { item: 'Wardrobe (Large, Built-in/Wooden)', value: 110000 },
                    { item: 'Dressing Table with Stool', value: 45000 },
                    { item: 'Nightstands (Set of 2)', value: 40000 },
                    { item: 'Bedding Sets (Luxury)', value: 35000 },
                    { item: 'Air Conditioner (1.5 HP)', value: 150000 }
                ],
                bed2: [
                    { item: 'Full Size Bed Frame', value: 60000 },
                    { item: 'Mattress', value: 85000 },
                    { item: 'Wardrobe (Medium)', value: 70000 },
                    { item: 'Study Desk & Chair', value: 50000 },
                    { item: 'Nightstand', value: 18000 }
                ],
                bed3: [
                    { item: 'Twin Beds (2)', value: 90000 },
                    { item: 'Mattresses (2)', value: 110000 },
                    { item: 'Shared Wardrobe', value: 65000 },
                    { item: 'Study Table', value: 30000 }
                ],
                misc: [
                    { item: 'Washing Machine (Automatic)', value: 125000 },
                    { item: 'Water Heater (50L)', value: 75000 },
                    { item: 'Vacuum Cleaner', value: 30000 },
                    { item: 'Irons & Ironing Board', value: 20000 },
                    { item: 'Garden Furniture Set (Table, 4 Chairs)', value: 65000 },
                    { item: 'Basic Tools (Drill, Toolkit)', value: 40000 }
                ]
            },
            manka: {
                living: [
                    { item: 'L-Shaped Sectional Sofa', value: 140000 },
                    { item: 'Center Table (Solid Wood)', value: 50000 },
                    { item: 'TV Stand (Modern Design)', value: 60000 },
                    { item: 'Smart Television (55-inch)', value: 250000 },
                    { item: 'Home Theater System (Soundbar & Subwoofer)', value: 120000 },
                    { item: 'Large Decorative Rug', value: 50000 },
                    { item: 'Reading Chair & Floor Lamp', value: 40000 },
                    { item: 'Art Pieces & Sculptures', value: 75000 },
                    { item: 'Air Conditioner (2.0 HP)', value: 160000 },
                    { item: 'Ceiling Fans (2)', value: 50000 }
                ],
                kitchen: [
                    { item: 'Extendable Dining Table with 8 Chairs', value: 200000 },
                    { item: 'China Cabinet/Display', value: 80000 },
                    { item: 'Refrigerator (French Door)', value: 320000 },
                    { item: 'Electric Stove with Cooktop', value: 150000 },
                    { item: 'Dishwasher', value: 100000 },
                    { item: 'Toaster Oven & Electric Kettle', value: 25000 },
                    { item: 'Premium Cookware Set', value: 85000 },
                    { item: 'Fine China & Crystal Glassware', value: 120000 }
                ],
                master: [
                    { item: 'King Size Bed (Ornate Frame)', value: 150000 },
                    { item: 'Premium Orthopedic Mattress', value: 200000 },
                    { item: 'Walk-in Closet System', value: 180000 },
                    { item: 'Vanity with Mirror', value: 70000 },
                    { item: 'Armchair & Ottoman', value: 55000 },
                    { item: 'Designer Bed Linens', value: 50000 },
                    { item: 'Air Conditioner (2.0 HP Inverter)', value: 220000 },
                    { item: 'Safe Box (Small)', value: 45000 }
                ],
                bed2: [
                    { item: 'Queen Size Bed Frame', value: 90000 },
                    { item: 'Mattress', value: 120000 },
                    { item: 'Wardrobe & Dresser Combo', value: 100000 },
                    { item: 'Desk & Office Chair', value: 60000 },
                    { item: 'En-suite Water Heater', value: 60000 }
                ],
                bed3: [
                    { item: 'Bunk Bed (Metal/Wood)', value: 80000 },
                    { item: 'Mattresses (2)', value: 90000 },
                    { item: 'Chest of Drawers', value: 45000 },
                    { item: 'Study Desk', value: 35000 },
                    { item: 'Bookshelf', value: 30000 }
                ],
                misc: [
                    { item: 'Washing Machine & Dryer Combo', value: 200000 },
                    { item: 'Generator (5kVA)', value: 350000 },
                    { item: 'Outdoor Patio Set (Lounge)', value: 150000 },
                    { item: 'Barbecue Grill', value: 65000 },
                    { item: 'Vacuum & Cleaning Equipment', value: 50000 },
                    { item: 'Power Tools & Garden Tools', value: 80000 }
                ]
            }
        };

        // Calculate totals
        function calcAssetTotals() {
            var oldTown = { total: 0 };
            Object.keys(ASSETS_DATA.oldTown).forEach(function (k) {
                var items = ASSETS_DATA.oldTown[k] || [];
                var sum = items.reduce(function (s, i) { return s + i.value; }, 0);
                oldTown[k] = sum;
                oldTown.total += sum;
            });

            var manka = { total: 0 };
            Object.keys(ASSETS_DATA.manka).forEach(function (k) {
                var items = ASSETS_DATA.manka[k] || [];
                var sum = items.reduce(function (s, i) { return s + i.value; }, 0);
                manka[k] = sum;
                manka.total += sum;
            });

            return { oldTown: oldTown, manka: manka, grandTotal: oldTown.total + manka.total };
        }

        // Load Assets Dashboard
        function loadAssetsDashboard() {
            var totals = calcAssetTotals();
            var totalItems = 0;
            Object.keys(ASSETS_DATA.oldTown).forEach(function (k) {
                var items = ASSETS_DATA.oldTown[k];
                if (Array.isArray(items)) totalItems += items.length;
            });
            Object.keys(ASSETS_DATA.manka).forEach(function (k) {
                var items = ASSETS_DATA.manka[k];
                if (Array.isArray(items)) totalItems += items.length;
            });

            // Update stats
            document.getElementById('assetsOldTownTotal').textContent = fmt(totals.oldTown.total);
            document.getElementById('assetsMankaTotal').textContent = fmt(totals.manka.total);
            document.getElementById('assetsCombinedTotal').textContent = fmt(totals.grandTotal);
            document.getElementById('assetsTotalItems').textContent = totalItems;
            document.getElementById('assetsOverallTotal').textContent = fmt(totals.grandTotal) + ' XAF';

            // Update landing page stats
            if (document.getElementById('landingOldTownValue')) {
                document.getElementById('landingOldTownValue').textContent = fmt(totals.oldTown.total);
                document.getElementById('landingMankaValue').textContent = fmt(totals.manka.total);
                document.getElementById('landingTotalAssets').textContent = fmt(totals.grandTotal);
            }
        }

        // Category metadata - now includes icon and name
        var ASSET_CATEGORIES = {
            oldTown: {
                living: { icon: 'üõãÔ∏è', name: 'Living Room & Common Areas' },
                kitchen: { icon: 'üçΩÔ∏è', name: 'Kitchen & Dining' },
                master: { icon: 'üõèÔ∏è', name: 'Bedroom 1 (Master)' },
                bed2: { icon: 'üõèÔ∏è', name: 'Bedroom 2' },
                bed3: { icon: 'üõèÔ∏è', name: 'Bedroom 3' },
                misc: { icon: 'üå≥', name: 'Outdoor & Miscellaneous' }
            },
            manka: {
                living: { icon: 'üõãÔ∏è', name: 'Living Room & Common Areas' },
                kitchen: { icon: 'üçΩÔ∏è', name: 'Kitchen & Dining' },
                master: { icon: 'üõèÔ∏è', name: 'Bedroom 1 (Master)' },
                bed2: { icon: 'üõèÔ∏è', name: 'Bedroom 2 (Guest Suite)' },
                bed3: { icon: 'üõèÔ∏è', name: 'Bedroom 3' },
                misc: { icon: 'üå≥', name: 'Outdoor, Laundry & Miscellaneous' }
            }
        };

        // Current active tab for each residence
        var activeTab = { oldTown: null, manka: null };

        // Render dynamic tabs for a residence
        function renderResidenceTabs(residence) {
            var tabsContainer = document.getElementById(residence === 'oldTown' ? 'oldTownTabs' : 'mankaTabs');
            var contentContainer = document.getElementById(residence === 'oldTown' ? 'oldTownTabContent' : 'mankaTabContent');
            var categories = ASSET_CATEGORIES[residence];
            var categoryKeys = Object.keys(categories);
            var isOldTown = residence === 'oldTown';
            var tabClass = isOldTown ? 'asset-tab' : 'asset-tab manka-tab';
            var bgColor = isOldTown ? '#ebf8ff' : '#f0fff4';
            var titleColor = isOldTown ? 'var(--primary-blue)' : 'var(--success-green)';

            // Set first tab as active if no active tab
            if (!activeTab[residence] && categoryKeys.length > 0) {
                activeTab[residence] = categoryKeys[0];
            }

            // Render tabs
            var tabsHtml = categoryKeys.map(function (key) {
                var cat = categories[key];
                var isActive = activeTab[residence] === key;
                return '<div class="tab-wrapper" style="position: relative; display: inline-flex; align-items: center;">' +
                    '<button class="' + tabClass + (isActive ? ' active' : '') + '" onclick="showResidenceTab(\'' + residence + '\', \'' + key + '\')" data-tab="' + key + '">' +
                    cat.icon + ' ' + cat.name +
                    '</button>' +
                    '<div class="tab-actions admin-only" style="position: absolute; right: -5px; top: -5px; display: flex; gap: 2px;">' +
                    '<button class="btn-tab-action" onclick="editCategory(\'' + residence + '\', \'' + key + '\')" title="Edit">‚úèÔ∏è</button>' +
                    '<button class="btn-tab-action btn-tab-delete" onclick="deleteCategory(\'' + residence + '\', \'' + key + '\')" title="Delete">√ó</button>' +
                    '</div>' +
                    '</div>';
            }).join('');

            tabsContainer.innerHTML = tabsHtml;

            // Render content for all categories
            var contentHtml = categoryKeys.map(function (key) {
                var cat = categories[key];
                var isActive = activeTab[residence] === key;
                var items = ASSETS_DATA[residence][key] || [];
                var subtotal = items.reduce(function (s, i) { return s + i.value; }, 0);

                return '<div id="' + residence + '-tab-' + key + '" class="asset-tab-content' + (isActive ? ' active' : '') + '">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">' +
                    '<h4 style="color: ' + titleColor + '; margin: 0;">' + cat.icon + ' ' + cat.name + '</h4>' +
                    '<button class="btn btn-success btn-sm admin-only" onclick="showAddAssetModal(\'' + residence + '\', \'' + key + '\')">‚ûï Add Item</button>' +
                    '</div>' +
                    '<div class="table-container">' +
                    '<table>' +
                    '<thead><tr>' +
                    '<th style="width: 50%;">Item</th>' +
                    '<th style="width: 25%; text-align: right;">Value (XAF)</th>' +
                    '<th style="width: 25%; text-align: center;">Actions</th>' +
                    '</tr></thead>' +
                    '<tbody id="' + residence + '_' + key + '_table">' + renderAssetRows(items, residence, key) + '</tbody>' +
                    '<tfoot><tr style="background: ' + bgColor + ';">' +
                    '<td><strong>Subtotal</strong></td>' +
                    '<td style="text-align: right;"><strong id="' + residence + '_' + key + '_subtotal">' + fmt(subtotal) + '</strong></td>' +
                    '<td></td>' +
                    '</tr></tfoot>' +
                    '</table>' +
                    '</div>' +
                    '</div>';
            }).join('');

            contentContainer.innerHTML = contentHtml || '<p style="text-align: center; color: #718096;">No categories. Click "Add Category" to create one.</p>';

            // Update grand total
            updateResidenceTotal(residence);
        }

        // Render asset rows
        function renderAssetRows(items, residence, category) {
            if (!items || items.length === 0) {
                return '<tr><td colspan="3" style="text-align: center; color: #718096;">No items in this category</td></tr>';
            }
            return items.map(function (item, index) {
                return '<tr>' +
                    '<td>' +
                    '<select class="asset-item-dropdown" style="width: 100%; padding: 0.4rem; border: 1px solid #e2e8f0; border-radius: 4px;" disabled>' +
                    '<option selected>' + item.item + '</option>' +
                    '</select>' +
                    '</td>' +
                    '<td style="text-align: right; font-weight: 600;">' + fmt(item.value) + '</td>' +
                    '<td>' +
                    '<div class="asset-actions">' +
                    '<button class="btn btn-primary btn-sm" onclick="viewAsset(\'' + residence + '\', \'' + category + '\', ' + index + ')" title="View">üëÅÔ∏è</button>' +
                    '<button class="btn btn-warning btn-sm admin-only" onclick="editAsset(\'' + residence + '\', \'' + category + '\', ' + index + ')" title="Edit">‚úèÔ∏è</button>' +
                    '<button class="btn btn-danger btn-sm admin-only" onclick="deleteAsset(\'' + residence + '\', \'' + category + '\', ' + index + ')" title="Delete">üóëÔ∏è</button>' +
                    '</div>' +
                    '</td>' +
                    '</tr>';
            }).join('');
        }

        // Show tab for residence
        function showResidenceTab(residence, tabKey) {
            activeTab[residence] = tabKey;
            var prefix = residence === 'oldTown' ? '#assets-oldtown' : '#assets-manka';

            // Hide all tabs content
            document.querySelectorAll(prefix + ' .asset-tab-content').forEach(function (t) { t.classList.remove('active'); });
            document.querySelectorAll(prefix + ' .asset-tab').forEach(function (t) { t.classList.remove('active'); });

            // Show selected
            var tabContent = document.getElementById(residence + '-tab-' + tabKey);
            var tabButton = document.querySelector(prefix + ' .asset-tab[data-tab="' + tabKey + '"]');
            if (tabContent) tabContent.classList.add('active');
            if (tabButton) tabButton.classList.add('active');
        }

        // Backward compatibility - keep old function names
        function showOldTownTab(tabName) { showResidenceTab('oldTown', tabName); }
        function showMankaTab(tabName) { showResidenceTab('manka', tabName); }

        // Update residence grand total
        function updateResidenceTotal(residence) {
            var total = 0;
            var categories = ASSET_CATEGORIES[residence];
            Object.keys(categories).forEach(function (key) {
                var items = ASSETS_DATA[residence][key] || [];
                items.forEach(function (i) { total += i.value; });
            });

            if (residence === 'oldTown') {
                document.getElementById('oldTownFinalTotal').textContent = fmt(total) + ' XAF';
                document.getElementById('oldTownTotalBadge').textContent = fmt(total) + ' XAF';
            } else {
                document.getElementById('mankaFinalTotal').textContent = fmt(total) + ' XAF';
                document.getElementById('mankaTotalBadge').textContent = fmt(total) + ' XAF';
            }
        }

        // Load Old Town Assets
        function loadOldTownAssets() {
            renderResidenceTabs('oldTown');
        }

        // Load Manka Assets
        function loadMankaAssets() {
            renderResidenceTabs('manka');
        }

        // ===== CATEGORY MANAGEMENT =====

        // Show Add Category Modal
        function showAddCategoryModal(residence) {
            document.getElementById('categoryResidence').value = residence;
            document.getElementById('categoryOldKey').value = '';
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryIcon').value = 'üè†';
            document.getElementById('categoryModalTitle').textContent = '‚ûï Add Category';
            document.getElementById('categoryModal').classList.add('active');
        }

        // Edit Category
        function editCategory(residence, key) {
            var cat = ASSET_CATEGORIES[residence][key];
            document.getElementById('categoryResidence').value = residence;
            document.getElementById('categoryOldKey').value = key;
            document.getElementById('categoryName').value = cat.name;
            document.getElementById('categoryIcon').value = cat.icon;
            document.getElementById('categoryModalTitle').textContent = '‚úèÔ∏è Edit Category';
            document.getElementById('categoryModal').classList.add('active');
        }

        // Close Category Modal
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }

        // Save Category
        function saveCategory() {
            var residence = document.getElementById('categoryResidence').value;
            var oldKey = document.getElementById('categoryOldKey').value;
            var name = document.getElementById('categoryName').value.trim();
            var icon = document.getElementById('categoryIcon').value;

            if (!name) {
                showAlert('Please enter a category name', 'error');
                return;
            }

            // Generate key from name
            var newKey = name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');

            if (oldKey) {
                // Editing existing category
                if (oldKey !== newKey) {
                    // Key changed - move data
                    ASSETS_DATA[residence][newKey] = ASSETS_DATA[residence][oldKey] || [];
                    delete ASSETS_DATA[residence][oldKey];
                    delete ASSET_CATEGORIES[residence][oldKey];
                }
                ASSET_CATEGORIES[residence][newKey] = { icon: icon, name: name };
                showAlert('Category updated!');
            } else {
                // Adding new category
                if (ASSET_CATEGORIES[residence][newKey]) {
                    showAlert('Category already exists', 'error');
                    return;
                }
                ASSET_CATEGORIES[residence][newKey] = { icon: icon, name: name };
                ASSETS_DATA[residence][newKey] = [];
                showAlert('Category added!');
            }

            closeCategoryModal();

            if (residence === 'oldTown') {
                loadOldTownAssets();
            } else {
                loadMankaAssets();
            }
            loadAssetsDashboard();
        }

        // Delete Category
        function deleteCategory(residence, key) {
            var cat = ASSET_CATEGORIES[residence][key];
            var itemCount = (ASSETS_DATA[residence][key] || []).length;
            var message = 'Delete category "' + cat.name + '"?';
            if (itemCount > 0) {
                message += '\n\nWARNING: This will also delete ' + itemCount + ' item(s) in this category!';
            }

            if (!confirm(message)) return;

            delete ASSET_CATEGORIES[residence][key];
            delete ASSETS_DATA[residence][key];

            // Reset active tab if deleted
            if (activeTab[residence] === key) {
                var remainingKeys = Object.keys(ASSET_CATEGORIES[residence]);
                activeTab[residence] = remainingKeys.length > 0 ? remainingKeys[0] : null;
            }

            showAlert('Category deleted!');

            if (residence === 'oldTown') {
                loadOldTownAssets();
            } else {
                loadMankaAssets();
            }
            loadAssetsDashboard();
        }

        // ===== ASSET ITEM MANAGEMENT =====

        // Show Add Asset Modal
        function showAddAssetModal(residence, category) {
            document.getElementById('assetResidence').value = residence;
            document.getElementById('assetCategory').value = category;
            document.getElementById('assetIndex').value = '-1';
            document.getElementById('assetValue').value = '';
            document.getElementById('assetCustomItem').value = '';
            document.getElementById('assetCustomItemGroup').style.display = 'none';

            // Populate dropdown with common items
            var select = document.getElementById('assetItemSelect');
            select.innerHTML = '<option value="">-- Select or Add New --</option>' +
                '<option value="__custom__">‚ûï Add Custom Item</option>' +
                '<option value="Sofa">Sofa</option>' +
                '<option value="Table">Table</option>' +
                '<option value="Chair">Chair</option>' +
                '<option value="Bed">Bed</option>' +
                '<option value="Mattress">Mattress</option>' +
                '<option value="Wardrobe">Wardrobe</option>' +
                '<option value="Television">Television</option>' +
                '<option value="Refrigerator">Refrigerator</option>' +
                '<option value="Air Conditioner">Air Conditioner</option>' +
                '<option value="Washing Machine">Washing Machine</option>' +
                '<option value="Microwave">Microwave</option>' +
                '<option value="Fan">Fan</option>';

            var catInfo = ASSET_CATEGORIES[residence][category];
            document.getElementById('assetModalTitle').textContent = '‚ûï Add Asset to ' + (catInfo ? catInfo.name : category);
            document.getElementById('assetModal').classList.add('active');
        }

        // Handle asset item dropdown change
        function handleAssetItemChange() {
            var select = document.getElementById('assetItemSelect');
            var customGroup = document.getElementById('assetCustomItemGroup');

            if (select.value === '__custom__') {
                customGroup.style.display = 'block';
                document.getElementById('assetCustomItem').focus();
            } else {
                customGroup.style.display = 'none';
            }
        }

        // Close asset modal
        function closeAssetModal() {
            document.getElementById('assetModal').classList.remove('active');
        }

        // Save asset
        function saveAsset() {
            var residence = document.getElementById('assetResidence').value;
            var category = document.getElementById('assetCategory').value;
            var index = parseInt(document.getElementById('assetIndex').value);
            var selectValue = document.getElementById('assetItemSelect').value;
            var customItem = document.getElementById('assetCustomItem').value.trim();
            var value = parseInt(document.getElementById('assetValue').value);

            var itemName = selectValue === '__custom__' ? customItem : selectValue;

            if (!itemName) {
                showAlert('Please select or enter an item name', 'error');
                return;
            }

            if (!value || value <= 0) {
                showAlert('Please enter a valid value', 'error');
                return;
            }

            if (index === -1) {
                // Add new
                ASSETS_DATA[residence][category].push({ item: itemName, value: value });
                showAlert('Asset added successfully!');
            } else {
                // Update existing
                ASSETS_DATA[residence][category][index] = { item: itemName, value: value };
                showAlert('Asset updated successfully!');
            }

            closeAssetModal();

            // Reload the appropriate table
            if (residence === 'oldTown') {
                loadOldTownAssets();
            } else {
                loadMankaAssets();
            }

            // Update dashboard
            loadAssetsDashboard();
        }

        // View asset
        function viewAsset(residence, category, index) {
            var item = ASSETS_DATA[residence][category][index];
            document.getElementById('assetViewItem').value = item.item;
            document.getElementById('assetViewValue').value = fmt(item.value) + ' XAF';
            document.getElementById('assetViewResidence').value = residence === 'oldTown' ? 'Old Town Residence' : 'Manka Residence';
            var catInfo = ASSET_CATEGORIES[residence][category];
            document.getElementById('assetViewCategory').value = catInfo ? catInfo.name : category;
            document.getElementById('assetViewModal').classList.add('active');
        }

        // Close view modal
        function closeAssetViewModal() {
            document.getElementById('assetViewModal').classList.remove('active');
        }

        // Edit asset
        function editAsset(residence, category, index) {
            var item = ASSETS_DATA[residence][category][index];

            document.getElementById('assetResidence').value = residence;
            document.getElementById('assetCategory').value = category;
            document.getElementById('assetIndex').value = index;
            document.getElementById('assetValue').value = item.value;

            // Set dropdown to custom and show the item name
            var select = document.getElementById('assetItemSelect');
            select.innerHTML = '<option value="">-- Select or Add New --</option>' +
                '<option value="__custom__">‚ûï Add Custom Item</option>' +
                '<option value="' + item.item + '" selected>' + item.item + '</option>';

            document.getElementById('assetCustomItemGroup').style.display = 'none';
            document.getElementById('assetModalTitle').textContent = '‚úèÔ∏è Edit Asset';
            document.getElementById('assetModal').classList.add('active');
        }

        // Delete asset
        function deleteAsset(residence, category, index) {
            var item = ASSETS_DATA[residence][category][index];
            if (!confirm('Delete "' + item.item + '" (' + fmt(item.value) + ' XAF)?')) return;

            ASSETS_DATA[residence][category].splice(index, 1);
            showAlert('Asset deleted!');

            if (residence === 'oldTown') {
                loadOldTownAssets();
            } else {
                loadMankaAssets();
            }

            loadAssetsDashboard();
        }

        // Load Assets Inheritance
        // Assets beneficiaries storage
        var assetsBeneficiaries = [];
        var allAssetsHeirs = [];

        // Default heirs data (used as fallback if API returns empty)
        var DEFAULT_HEIRS = [
            { id: 1, name: 'MODER PASMA IDRISU EPSE SALIFOU', relationship: 'Spouse', gender: 'Female', heir_group: 'Wives', portions: 0.0625 },
            { id: 2, name: 'MENJIKOUE ABIBA SPOUSE NJIKAM', relationship: 'Spouse', gender: 'Female', heir_group: 'Wives', portions: 0.0625 },
            { id: 3, name: 'SAHNATU SALIFU', relationship: 'Child', gender: 'Female', heir_group: 'Daughters', portions: 1 },
            { id: 4, name: 'MOHAMAN SALIFU', relationship: 'Child', gender: 'Male', heir_group: 'Sons', portions: 2 },
            { id: 5, name: 'ABIBATU SALIFU', relationship: 'Child', gender: 'Female', heir_group: 'Daughters', portions: 1 },
            { id: 6, name: 'ZAKARE SALIFU', relationship: 'Child', gender: 'Male', heir_group: 'Sons', portions: 2 },
            { id: 7, name: 'FERER ALIMATU SALIFU', relationship: 'Child', gender: 'Female', heir_group: 'Daughters', portions: 1 },
            { id: 8, name: 'NTENTIE REKIATU NJIKAM', relationship: 'Child', gender: 'Female', heir_group: 'Daughters', portions: 1 },
            { id: 9, name: 'KAHPUI MARIAMA SALIFU', relationship: 'Child', gender: 'Female', heir_group: 'Daughters', portions: 1 },
            { id: 10, name: 'GHOUENZEN SOULEMANOU', relationship: 'Child', gender: 'Male', heir_group: 'Sons', portions: 2 },
            { id: 11, name: 'NGAMENPOUYE MAIMUNATE', relationship: 'Child', gender: 'Female', heir_group: 'Daughters', portions: 1 },
            { id: 12, name: 'LOUMNGAM NCHINTOUO AMINATOUO', relationship: 'Child', gender: 'Female', heir_group: 'Daughters', portions: 1 },
            { id: 13, name: 'MENTCHA ABOUBAKAR SALIFOU', relationship: 'Child', gender: 'Male', heir_group: 'Sons', portions: 2 },
            { id: 14, name: 'HAROUNA SALIFU', relationship: 'Child', gender: 'Male', heir_group: 'Sons', portions: 2 },
            { id: 15, name: 'MBALLEY ABDOU RAHAMA SALIFOU', relationship: 'Child', gender: 'Male', heir_group: 'Sons', portions: 2 },
            { id: 16, name: 'NGAMDAMOUN IBRAHIM SALIFOU', relationship: 'Child', gender: 'Male', heir_group: 'Sons', portions: 2 }
        ];

        function loadAssetsInheritance() {
            var totals = calcAssetTotals();
            document.getElementById('assetsInheritancePool').textContent = fmt(totals.grandTotal) + ' XAF';

            // Load heirs from RE module
            api('/re/heirs').then(function (heirs) {
                // Use default heirs if API returns empty
                if (!heirs || heirs.length === 0) {
                    heirs = DEFAULT_HEIRS;
                }

                allAssetsHeirs = heirs;

                // Initialize all heirs as selected if first load
                if (assetsBeneficiaries.length === 0) {
                    assetsBeneficiaries = heirs.map(function (h) { return h.id; });
                }

                // Render beneficiary selection grid
                renderAssetsBeneficiaryList(heirs);

                // Calculate and display distribution
                calculateAssetsDistribution();
            }).catch(function (err) {
                // Use default heirs on error
                console.log('Using default heirs due to API error:', err);
                allAssetsHeirs = DEFAULT_HEIRS;

                if (assetsBeneficiaries.length === 0) {
                    assetsBeneficiaries = DEFAULT_HEIRS.map(function (h) { return h.id; });
                }

                renderAssetsBeneficiaryList(DEFAULT_HEIRS);
                calculateAssetsDistribution();
            });
        }

        // Render beneficiary selection list
        function renderAssetsBeneficiaryList(heirs) {
            var html = heirs.map(function (h) {
                var isSelected = assetsBeneficiaries.indexOf(h.id) !== -1;
                var groupColor = h.heir_group === 'Wives' ? '#805ad5' : (h.heir_group === 'Sons' ? '#3182ce' : '#38a169');
                return '<div class="beneficiary-item' + (isSelected ? ' selected' : '') + '" onclick="toggleAssetsBeneficiary(' + h.id + ')">' +
                    '<input type="checkbox" ' + (isSelected ? 'checked' : '') + '>' +
                    '<label>' +
                    '<strong>' + h.name + '</strong><br>' +
                    '<span style="font-size: 0.75rem; color: #718096;">' + h.relationship + ' ‚Ä¢ </span>' +
                    '<span style="font-size: 0.7rem; background: ' + groupColor + '; color: white; padding: 1px 6px; border-radius: 10px;">' + h.heir_group + '</span>' +
                    '<span style="font-size: 0.75rem; color: #718096;"> ‚Ä¢ ' + h.portions + ' portion(s)</span>' +
                    '</label>' +
                    '</div>';
            }).join('');

            document.getElementById('assetsBeneficiaryList').innerHTML = html || '<p style="color: #718096;">No heirs defined. Please add heirs in the Family Estates module.</p>';

            // Update count
            document.getElementById('assetsBeneficiaryCount').textContent = assetsBeneficiaries.length + ' selected';
        }

        // Toggle beneficiary selection
        function toggleAssetsBeneficiary(heirId) {
            var index = assetsBeneficiaries.indexOf(heirId);
            if (index === -1) {
                assetsBeneficiaries.push(heirId);
            } else {
                assetsBeneficiaries.splice(index, 1);
            }

            // Re-render
            renderAssetsBeneficiaryList(allAssetsHeirs);
            calculateAssetsDistribution();
        }

        // Select all beneficiaries
        function selectAllAssetsBeneficiaries() {
            assetsBeneficiaries = allAssetsHeirs.map(function (h) { return h.id; });
            renderAssetsBeneficiaryList(allAssetsHeirs);
            calculateAssetsDistribution();
        }

        // Deselect all beneficiaries
        function deselectAllAssetsBeneficiaries() {
            assetsBeneficiaries = [];
            renderAssetsBeneficiaryList(allAssetsHeirs);
            calculateAssetsDistribution();
        }

        // Calculate and display distribution
        function calculateAssetsDistribution() {
            var totals = calcAssetTotals();
            var pool = totals.grandTotal;

            // Filter selected heirs
            var selectedHeirs = allAssetsHeirs.filter(function (h) {
                return assetsBeneficiaries.indexOf(h.id) !== -1;
            });

            if (selectedHeirs.length === 0) {
                document.getElementById('assetsHeirsTable').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #718096;">No beneficiaries selected. Please select at least one heir above.</td></tr>';
                document.getElementById('assetsTotalPortions').textContent = '0';
                document.getElementById('assetsTotalDistributed').textContent = '0 XAF';
                document.getElementById('assetsUndistributedWarning').style.display = 'block';
                document.getElementById('assetsUndistributedAmount').textContent = fmt(pool) + ' XAF';
                return;
            }

            // Correct Islamic Inheritance Calculation:
            // 1. Heirs with portions < 1 are "Fixed Share" heirs (Fara'id)
            // 2. Heirs with portions >= 1 are "Residuary" heirs (Asabat)
            var fixedHeirs = selectedHeirs.filter(function (h) { return parseFloat(h.portions) < 1; });
            var residuaryHeirs = selectedHeirs.filter(function (h) { return parseFloat(h.portions) >= 1; });

            var fixedTotalAmount = 0;
            fixedHeirs.forEach(function (h) { fixedTotalAmount += pool * parseFloat(h.portions); });

            var residueAmount = Math.max(0, pool - fixedTotalAmount);
            var totalResiduaryPortions = residuaryHeirs.reduce(function (sum, h) { return sum + parseFloat(h.portions); }, 0);
            var perPortion = totalResiduaryPortions > 0 ? residueAmount / totalResiduaryPortions : 0;

            var totalDistributed = 0;

            // Render distribution table
            var html = selectedHeirs.map(function (h) {
                var share = parseFloat(h.portions) < 1 ? (pool * parseFloat(h.portions)) : (parseFloat(h.portions) * perPortion);
                totalDistributed += share;
                return '<tr>' +
                    '<td><strong>' + h.name + '</strong></td>' +
                    '<td>' + h.relationship + '</td>' +
                    '<td>' + h.heir_group + '</td>' +
                    '<td style="text-align: center;">' + h.portions + '</td>' +
                    '<td style="text-align: right; color: var(--success-green); font-weight: bold;">' + fmt(Math.round(share)) + '</td>' +
                    '</tr>';
            }).join('');

            document.getElementById('assetsHeirsTable').innerHTML = html;
            document.getElementById('assetsTotalPortions').textContent = totalResiduaryPortions;
            document.getElementById('assetsTotalDistributed').textContent = fmt(Math.round(totalDistributed)) + ' XAF';

            // Check for undistributed amount (should be 0 if all selected)
            var undistributed = pool - totalDistributed;
            if (Math.abs(undistributed) > 1) {
                document.getElementById('assetsUndistributedWarning').style.display = 'block';
                document.getElementById('assetsUndistributedAmount').textContent = fmt(Math.round(undistributed)) + ' XAF';
            } else {
                document.getElementById('assetsUndistributedWarning').style.display = 'none';
            }
        }

        // Export Assets PDF
        function exportAssetsPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var totals = calcAssetTotals();
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Background
            doc.setFillColor(250, 245, 255);
            doc.rect(0, 0, 210, 297, 'F');

            // Header
            doc.setFillColor(128, 90, 213);
            doc.rect(10, 10, 190, 30, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('RESIDENCE ASSETS INVENTORY', 105, 22, { align: 'center' });
            doc.setFontSize(10);
            doc.text('NJIKAM SALIFU ESTATE - Old Town & Manka Residences', 105, 30, { align: 'center' });

            doc.setTextColor(128, 90, 213);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('SUMMARY', 105, 50, { align: 'center' });

            // Summary table
            doc.autoTable({
                startY: 55,
                head: [['Residence', 'Total Value (XAF)']],
                body: [
                    ['Old Town Residence', fmt(totals.oldTown.total)],
                    ['Manka Residence', fmt(totals.manka.total)],
                    ['GRAND TOTAL', fmt(totals.grandTotal)]
                ],
                styles: { fontSize: 10, cellPadding: 5 },
                headStyles: { fillColor: [128, 90, 213], textColor: [255, 255, 255] },
                footStyles: { fillColor: [250, 245, 255], fontStyle: 'bold' }
            });

            // Disclaimer
            doc.setFontSize(8);
            doc.setTextColor(113, 128, 150);
            doc.text('Disclaimer: All values are approximate resale/market estimates for used items in good condition.', 105, doc.lastAutoTable.finalY + 10, { align: 'center' });
            doc.text('Generated on: ' + today, 105, doc.lastAutoTable.finalY + 15, { align: 'center' });

            doc.save('residence_assets_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('Assets PDF exported!');
        }

        // Export Assets CSV
        function exportAssetsCSV() {
            var totals = calcAssetTotals();
            var csv = 'RESIDENCE ASSETS INVENTORY - NJIKAM SALIFU ESTATE\n';
            csv += 'Generated: ' + new Date().toLocaleDateString() + '\n\n';

            csv += 'OLD TOWN RESIDENCE\n';
            csv += 'Category,Item,Value (XAF)\n';
            Object.keys(ASSETS_DATA.oldTown).forEach(function (cat) {
                ASSETS_DATA.oldTown[cat].forEach(function (item) {
                    csv += cat.toUpperCase() + ',"' + item.item + '",' + item.value + '\n';
                });
            });
            csv += ',OLD TOWN TOTAL,' + totals.oldTown.total + '\n\n';

            csv += 'MANKA RESIDENCE\n';
            csv += 'Category,Item,Value (XAF)\n';
            Object.keys(ASSETS_DATA.manka).forEach(function (cat) {
                ASSETS_DATA.manka[cat].forEach(function (item) {
                    csv += cat.toUpperCase() + ',"' + item.item + '",' + item.value + '\n';
                });
            });
            csv += ',MANKA TOTAL,' + totals.manka.total + '\n\n';
            csv += ',GRAND TOTAL,' + totals.grandTotal + '\n';

            var blob = new Blob([csv], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'residence_assets_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
            showAlert('Assets CSV exported!');
        }

        // Export Assets Inheritance PDF
        function exportAssetsInheritancePDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var totals = calcAssetTotals();
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Filter to selected beneficiaries only
            var selectedHeirs = allAssetsHeirs.filter(function (h) {
                return assetsBeneficiaries.indexOf(h.id) !== -1;
            });

            if (selectedHeirs.length === 0) {
                showAlert('Please select at least one beneficiary before exporting', 'error');
                return;
            }

            var pool = totals.grandTotal;
            var fixedHeirs = selectedHeirs.filter(function (h) { return parseFloat(h.portions) < 1; });
            var residuaryHeirs = selectedHeirs.filter(function (h) { return parseFloat(h.portions) >= 1; });

            var fixedTotalAmount = 0;
            fixedHeirs.forEach(function (h) { fixedTotalAmount += pool * parseFloat(h.portions); });

            var residueAmount = Math.max(0, pool - fixedTotalAmount);
            var totalResiduaryPortions = residuaryHeirs.reduce(function (sum, h) { return sum + parseFloat(h.portions); }, 0);
            var perPortion = totalResiduaryPortions > 0 ? residueAmount / totalResiduaryPortions : 0;

            // Background
            doc.setFillColor(255, 250, 240);
            doc.rect(0, 0, 210, 297, 'F');

            // Header
            doc.setFillColor(214, 158, 46);
            doc.rect(10, 10, 190, 30, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('ASSETS INHERITANCE DISTRIBUTION', 105, 22, { align: 'center' });
            doc.setFontSize(10);
            doc.text('NJIKAM SALIFU ESTATE - Islamic Inheritance', 105, 30, { align: 'center' });

            // Pool info
            doc.setTextColor(116, 66, 16);
            doc.setFontSize(12);
            doc.text('Total Assets Pool: ' + fmt(totals.grandTotal) + ' XAF', 105, 50, { align: 'center' });
            doc.setFontSize(9);
            doc.text('(Old Town: ' + fmt(totals.oldTown.total) + ' + Manka: ' + fmt(totals.manka.total) + ')', 105, 57, { align: 'center' });

            // Beneficiary count
            doc.setFontSize(10);
            doc.text('Selected Beneficiaries: ' + selectedHeirs.length + ' of ' + allAssetsHeirs.length + ' heirs', 105, 64, { align: 'center' });

            // Heirs table
            var totalDistributed = 0;
            var tableData = selectedHeirs.map(function (h) {
                var share = parseFloat(h.portions) < 1 ? (pool * parseFloat(h.portions)) : (parseFloat(h.portions) * perPortion);
                totalDistributed += share;
                return [h.name, h.relationship, h.heir_group, h.portions, fmt(Math.round(share))];
            });

            // Add total row
            tableData.push(['TOTAL', '', '', (totalResiduaryPortions + fixedHeirs.length), fmt(Math.round(totalDistributed))]);

            doc.autoTable({
                startY: 72,
                head: [['Heir Name', 'Relationship', 'Group', 'Portions', 'Share (XAF)']],
                body: tableData,
                styles: { fontSize: 9, cellPadding: 4 },
                headStyles: { fillColor: [214, 158, 46], textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [255, 250, 240] },
                didParseCell: function (data) {
                    // Bold the total row
                    if (data.row.index === tableData.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [254, 243, 199];
                    }
                }
            });

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(113, 128, 150);
            doc.text('Generated on: ' + today, 105, doc.lastAutoTable.finalY + 10, { align: 'center' });

            doc.save('assets_inheritance_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('Assets Inheritance PDF exported!');
        }

        // Print Assets Inheritance
        function printAssetsInheritance() {
            window.print();
        }

        // ==================== END RESIDENCE ASSETS MODULE ====================

        // Setup property form listeners
        document.addEventListener('DOMContentLoaded', function () {
            var rentInput = document.getElementById('propRentAmount');
            var taxInput = document.getElementById('propTaxRate');
            if (rentInput) rentInput.addEventListener('input', updatePropertyCalc);
            if (taxInput) taxInput.addEventListener('change', updatePropertyCalc);
        });

        // Initialize - check for existing session or show login
        function init() {
            // Hide main app initially
            document.getElementById('mainApp').style.display = 'none';

            // Check for existing session
            checkExistingSession();
        }

        init();
    </script>
</body>

</html>