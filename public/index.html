<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NJIKAM SALIFU REAL ESTATE PROPERTIES</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-dark: #1a365d;
            --primary-blue: #2c5282;
            --primary-light: #4299e1;
            --accent-gold: #d69e2e;
            --accent-orange: #ed8936;
            --success-green: #38a169;
            --danger-red: #e53e3e;
            --bg-cream: #faf5eb;
            --bg-white: #ffffff;
            --text-dark: #1a202c;
            --text-gray: #4a5568;
            --border-color: #e2e8f0;
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans Pro', sans-serif; background: linear-gradient(135deg, var(--bg-cream) 0%, #e8e0d5 100%); min-height: 100vh; color: var(--text-dark); }
        
        .header { background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%); color: white; position: sticky; top: 0; z-index: 1000; }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 1.5rem; flex-wrap: wrap; gap: 0.5rem; }
        .logo-section { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 38px; height: 38px; background: var(--accent-gold); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--primary-dark); }
        .logo-text h1 { font-family: 'Playfair Display', serif; font-size: 1.2rem; }
        .logo-text p { font-size: 0.65rem; opacity: 0.8; }
        .header-info { text-align: right; font-size: 0.75rem; }
        .db-status { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 10px; font-size: 0.6rem; margin-top: 0.1rem; }
        .db-status.connected { background: rgba(56,161,105,0.3); color: #9ae6b4; }
        .db-status.disconnected { background: rgba(229,62,62,0.3); color: #feb2b2; }
        
        .nav { display: flex; padding: 0 0.5rem; flex-wrap: wrap; overflow-x: auto; border-top: 1px solid rgba(255,255,255,0.1); }
        .nav-btn { background: transparent; border: none; color: white; padding: 0.5rem 0.7rem; font-size: 0.75rem; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); }
        .nav-btn.active { background: rgba(255,255,255,0.15); border-bottom-color: var(--accent-gold); }
        
        .main-content { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: var(--bg-white); border-radius: 10px; box-shadow: var(--shadow-md); margin-bottom: 1rem; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%); color: white; padding: 0.75rem 1rem; font-family: 'Playfair Display', serif; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-header.green { background: linear-gradient(135deg, var(--success-green) 0%, #276749 100%); }
        .card-header.gold { background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%); }
        .card-header.red { background: linear-gradient(135deg, var(--danger-red) 0%, #c53030 100%); }
        .card-body { padding: 1rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .stat-card { background: var(--bg-white); border-radius: 8px; padding: 0.75rem; box-shadow: var(--shadow-md); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.blue::before { background: var(--primary-blue); }
        .stat-card.green::before { background: var(--success-green); }
        .stat-card.red::before { background: var(--danger-red); }
        .stat-card.gold::before { background: var(--accent-gold); }
        .stat-icon { font-size: 1.1rem; margin-bottom: 0.2rem; }
        .stat-value { font-size: 1rem; font-weight: 700; margin-bottom: 0.1rem; }
        .stat-label { color: var(--text-gray); font-size: 0.65rem; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; }
        .form-group { margin-bottom: 0.75rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-weight: 600; font-size: 0.75rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.4rem 0.6rem; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-blue); }
        .form-group input:read-only { background: #f7fafc; }
        
        .btn { padding: 0.4rem 0.8rem; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.25rem; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success-green) 0%, #276749 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger-red) 0%, #c53030 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--accent-orange) 0%, #c05621 100%); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary-blue); color: var(--primary-blue); }
        .btn-print { background: linear-gradient(135deg, #805ad5 0%, #553c9a 100%); color: white; }
        .btn-gold { background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%); color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
        .btn-lg { padding: 1rem 2rem; font-size: 1.1rem; }
        .btn-group { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
        
        .table-container { overflow-x: auto; border-radius: 6px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; min-width: 400px; }
        th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.8rem; }
        th { background: #f7fafc; font-weight: 700; font-size: 0.7rem; text-transform: uppercase; }
        tr:hover { background: #f7fafc; }
        tr.clickable { cursor: pointer; }
        tr.clickable:hover { background: rgba(66,153,225,0.1); }
        
        .badge { padding: 0.15rem 0.35rem; border-radius: 8px; font-size: 0.6rem; font-weight: 600; text-transform: uppercase; }
        .badge-income { background: rgba(56,161,105,0.15); color: var(--success-green); }
        .badge-expense { background: rgba(229,62,62,0.15); color: var(--danger-red); }
        .badge-inheritance { background: rgba(214,158,46,0.15); color: var(--accent-gold); }
        .badge-paid { background: rgba(56,161,105,0.15); color: var(--success-green); }
        .badge-partial { background: rgba(236,201,75,0.2); color: #b7791f; }
        .badge-unpaid { background: rgba(229,62,62,0.15); color: var(--danger-red); }
        .badge-new { background: rgba(66,153,225,0.15); color: var(--primary-blue); }
        
        /* Landing Page Styles */
        .landing-page { text-align: center; padding: 2rem 1rem; }
        .landing-title { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--primary-dark); margin-bottom: 0.5rem; }
        .landing-subtitle { color: var(--text-gray); font-size: 1rem; margin-bottom: 2rem; }
        .landing-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; max-width: 900px; margin: 0 auto 2rem; }
        .landing-card { background: var(--bg-white); border-radius: 12px; box-shadow: var(--shadow-md); padding: 1.5rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 3px solid transparent; }
        .landing-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .landing-card.campost { border-color: var(--primary-blue); }
        .landing-card.campost:hover { border-color: var(--accent-gold); }
        .landing-card.family { border-color: var(--success-green); }
        .landing-card.family:hover { border-color: var(--accent-gold); }
        .landing-card-icon { font-size: 3rem; margin-bottom: 1rem; }
        .landing-card-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; color: var(--primary-dark); margin-bottom: 0.5rem; }
        .landing-card-desc { color: var(--text-gray); font-size: 0.85rem; margin-bottom: 1rem; }
        .landing-card-stats { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; }
        .landing-stat { text-align: center; }
        .landing-stat-value { font-size: 1.2rem; font-weight: 700; }
        .landing-stat-label { font-size: 0.7rem; color: var(--text-gray); }
        .back-btn { position: fixed; top: 80px; left: 20px; z-index: 999; }
        
        .module-header { display: none; }
        .module-header.active { display: block; }
        
        .amount-positive { color: var(--success-green); font-weight: 600; }
        .amount-negative { color: var(--danger-red); font-weight: 600; }
        .amount-gold { color: var(--accent-gold); font-weight: 600; }
        
        .alert { padding: 0.6rem 0.9rem; border-radius: 6px; margin-bottom: 0.75rem; font-size: 0.8rem; }
        .alert-success { background: rgba(56,161,105,0.15); color: var(--success-green); border: 1px solid var(--success-green); }
        .alert-error { background: rgba(229,62,62,0.15); color: var(--danger-red); border: 1px solid var(--danger-red); }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 10px; max-width: 750px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%); color: white; padding: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }
        .modal-body { padding: 1.25rem; }
        
        /* Login Page Styles */
        .login-container { display: none; min-height: 100vh; align-items: center; justify-content: center; padding: 1rem; background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%); }
        .login-container.active { display: flex; }
        .login-box { background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 400px; width: 100%; overflow: hidden; }
        .login-header { background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%); color: white; padding: 1.5rem; text-align: center; }
        .login-header h1 { font-family: 'Playfair Display', serif; font-size: 1.3rem; margin-bottom: 0.25rem; }
        .login-header p { font-size: 0.8rem; opacity: 0.9; }
        .login-body { padding: 1.5rem; }
        .login-body .form-group { margin-bottom: 1rem; }
        .login-body .form-group label { font-size: 0.85rem; }
        .login-body .form-group input { padding: 0.6rem; font-size: 0.9rem; }
        .login-btn { width: 100%; padding: 0.75rem; font-size: 1rem; margin-top: 0.5rem; }
        .login-footer { text-align: center; padding: 1rem; background: #f7fafc; font-size: 0.75rem; color: var(--text-gray); }
        .login-footer a { color: var(--primary-blue); cursor: pointer; text-decoration: underline; }
        .login-error { background: rgba(229,62,62,0.15); color: var(--danger-red); padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.8rem; display: none; }
        .login-error.show { display: block; }
        .user-badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.65rem; margin-left: 0.5rem; }
        .user-badge.admin { background: rgba(214,158,46,0.2); color: var(--accent-gold); }
        .user-badge.user { background: rgba(66,153,225,0.2); color: var(--primary-blue); }
        
        /* Role-based access control */
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: inline-flex !important; }
        .admin-only-section { display: none !important; }
        body.is-admin .admin-only-section { display: block !important; }
        .user-restricted-notice { display: none; background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        body:not(.is-admin) .user-restricted-notice { display: block; }
        
        .heir-group { background: #f7fafc; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem; }
        .heir-group h4 { color: var(--primary-blue); margin-bottom: 0.3rem; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .summary-row { display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px dashed var(--border-color); font-size: 0.8rem; }
        .summary-row:last-child { border-bottom: none; font-weight: 700; }
        
        .highlight-box { background: linear-gradient(135deg, rgba(214,158,46,0.15) 0%, rgba(237,137,54,0.15) 100%); border: 2px solid var(--accent-gold); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; text-align: center; }
        .highlight-box h3 { color: var(--accent-gold); font-size: 1.3rem; }
        .highlight-box p { font-size: 0.75rem; color: var(--text-gray); }
        
        /* Beneficiary Selection Styles */
        .beneficiary-item { display: flex; align-items: center; padding: 10px; background: #f7fafc; border-radius: 6px; border: 1px solid #e2e8f0; transition: all 0.2s; }
        .beneficiary-item:hover { background: #edf2f7; }
        .beneficiary-item.selected { background: #c6f6d5; border-color: #48bb78; }
        .beneficiary-item input[type="checkbox"] { width: 18px; height: 18px; margin-right: 10px; cursor: pointer; }
        .beneficiary-item label { cursor: pointer; flex: 1; font-size: 0.85rem; }
        .beneficiary-item .heir-info { font-size: 0.75rem; color: #718096; margin-left: auto; }
        .beneficiary-item .heir-portions { background: #4299e1; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 8px; }
        
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1rem; }
        .tab-btn { background: none; border: none; padding: 0.5rem 1rem; font-size: 0.8rem; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { border-bottom-color: var(--primary-blue); color: var(--primary-blue); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        @media print { body { background: white !important; } .no-print { display: none !important; } }
        @media (max-width: 768px) { .header-top { flex-direction: column; text-align: center; } .main-content { padding: 0.5rem; } }
    </style>
</head>
<body>
    <!-- ==================== LOGIN PAGE ==================== -->
    <div class="login-container active" id="loginContainer">
        <div class="login-box">
            <div class="login-header">
                <h1>ğŸ¢ NJIKAM SALIFU REAL ESTATE</h1>
                <p>Property & Billing Management System</p>
            </div>
            <div class="login-body">
                <div class="login-error" id="loginError"></div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" onkeypress="if(event.key==='Enter')doLogin()">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')doLogin()">
                </div>
                <button class="btn btn-primary login-btn" onclick="doLogin()">ğŸ” Login</button>
            </div>
            <div class="login-footer">
                <a onclick="showForgotPassword()">Forgot Password?</a>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgotPasswordModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><h3>ğŸ”‘ Reset Password</h3><button class="modal-close" onclick="closeForgotPassword()">Ã—</button></div>
            <div class="modal-body">
                <p style="font-size: 0.85rem; color: #718096; margin-bottom: 1rem;">Enter your email address to receive a password reset code.</p>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="forgotEmail" placeholder="Enter your email">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="sendResetCode()">ğŸ“§ Send Reset Code</button>
                </div>
                <div id="resetCodeSection" style="display: none; margin-top: 1rem;">
                    <div class="form-group">
                        <label>Reset Code</label>
                        <input type="text" id="resetCode" placeholder="Enter code from email">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newResetPassword" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmResetPassword" placeholder="Confirm new password">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="resetPasswordWithCode()">ğŸ” Reset Password</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Force Password Change Modal -->
    <div class="modal-overlay" id="forcePasswordModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--accent-gold) 0%, #b7791f 100%);"><h3>ğŸ” Change Password Required</h3></div>
            <div class="modal-body">
                <p style="font-size: 0.85rem; color: #718096; margin-bottom: 1rem; background: #fffbeb; padding: 10px; border-radius: 6px;">
                    âš ï¸ You must change your password before continuing. This is required for first-time login.
                </p>
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="forceCurrentPassword" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="forceNewPassword" placeholder="Enter new password (min 4 characters)">
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="forceConfirmPassword" placeholder="Confirm new password">
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="forceChangePassword()">ğŸ” Change Password & Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN APP (Hidden until login) ==================== -->
    <div id="mainApp" style="display: none;">
    <header class="header no-print">
        <div class="header-top">
            <div class="logo-section">
                <div class="logo-icon">NS</div>
                <div class="logo-text">
                    <h1 id="mainTitle">NJIKAM SALIFU REAL ESTATE PROPERTIES</h1>
                    <p id="mainSubtitle">Property & Billing Management System</p>
                </div>
            </div>
            <div class="header-info">
                <div style="margin-bottom: 5px;">
                    <strong id="loggedInUser">User</strong>
                    <span class="user-badge" id="userRoleBadge">User</span>
                </div>
                <span>B.P 36 Mankon-Bamenda | 675299868</span>
                <div style="margin-top: 5px;">
                    <button class="btn btn-sm btn-outline" style="padding: 2px 8px; font-size: 0.65rem; border-color: white; color: white;" onclick="doLogout()">ğŸšª Logout</button>
                </div>
            </div>
        </div>
        <!-- Main Navigation - shown on landing page -->
        <nav class="nav" id="mainNav">
            <button class="nav-btn active" data-page="landing">ğŸ  Home</button>
            <button class="nav-btn" data-page="main-settings">âš™ï¸ Settings</button>
        </nav>
        <!-- CAMPOST MANKON Navigation -->
        <nav class="nav module-header" id="campostNav">
            <button class="nav-btn" onclick="goToLanding()">ğŸ  Home</button>
            <button class="nav-btn active" data-page="campost-dashboard">ğŸ“Š Dashboard</button>
            <button class="nav-btn" data-page="campost-ledger">ğŸ“’ Ledger</button>
            <button class="nav-btn admin-only" data-page="campost-expenses">ğŸ’¸ Expenses</button>
            <button class="nav-btn admin-only" data-page="campost-bills">ğŸ“„ Bills</button>
            <button class="nav-btn admin-only" data-page="campost-payments">ğŸ’µ Payments</button>
            <button class="nav-btn" data-page="campost-inheritance">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Inheritance</button>
            <button class="nav-btn" data-page="campost-export">ğŸ“¥ Export</button>
            <button class="nav-btn admin-only" data-page="campost-settings">âš™ï¸ Settings</button>
        </nav>
        <!-- FAMILY REAL ESTATES Navigation -->
        <nav class="nav module-header" id="familyNav">
            <button class="nav-btn" onclick="goToLanding()">ğŸ  Home</button>
            <button class="nav-btn active" data-page="family-dashboard">ğŸ“Š Dashboard</button>
            <button class="nav-btn" data-page="family-properties">ğŸ  Properties</button>
            <button class="nav-btn" data-page="family-income">ğŸ’µ Rental Income</button>
            <button class="nav-btn admin-only" data-page="family-bills">ğŸ“„ Bills</button>
            <button class="nav-btn admin-only" data-page="family-payments">ğŸ’³ Payments</button>
            <button class="nav-btn admin-only" data-page="family-expenses">ğŸ’¸ Expenses</button>
            <button class="nav-btn" data-page="family-inheritance">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Inheritance</button>
            <button class="nav-btn" data-page="family-ledger">ğŸ“’ Ledger</button>
            <button class="nav-btn" data-page="family-export">ğŸ“¥ Export</button>
            <button class="nav-btn admin-only" data-page="family-settings">âš™ï¸ Settings</button>
        </nav>
    </header>

    <main class="main-content">
        <!-- ==================== LANDING PAGE ==================== -->
        <div id="landing" class="page active">
            <div class="landing-page">
                <h1 class="landing-title">ğŸ¢ NJIKAM SALIFU REAL ESTATE PROPERTIES</h1>
                <p class="landing-subtitle">Comprehensive Property & Billing Management System</p>
                
                <div class="landing-cards">
                    <!-- CAMPOST MANKON Card -->
                    <div class="landing-card campost" onclick="openModule('campost')">
                        <div class="landing-card-icon">ğŸ›ï¸</div>
                        <h2 class="landing-card-title">CAMPOST MANKON</h2>
                        <p class="landing-card-desc">Manage CAMPOST property billing, payments, expenses, and inheritance distribution.</p>
                        <div class="landing-card-stats">
                            <div class="landing-stat">
                                <div class="landing-stat-value amount-positive" id="landingCampostIncome">0</div>
                                <div class="landing-stat-label">Total Income</div>
                            </div>
                            <div class="landing-stat">
                                <div class="landing-stat-value amount-negative" id="landingCampostExpenses">0</div>
                                <div class="landing-stat-label">Total Expenses</div>
                            </div>
                            <div class="landing-stat">
                                <div class="landing-stat-value amount-gold" id="landingCampostBalance">0</div>
                                <div class="landing-stat-label">Balance</div>
                            </div>
                        </div>
                        <div class="btn-group" style="justify-content: center; margin-top: 1rem;">
                            <button class="btn btn-primary btn-lg">Enter CAMPOST MANKON â†’</button>
                        </div>
                    </div>
                    
                    <!-- FAMILY REAL ESTATES Card -->
                    <div class="landing-card family" onclick="openModule('family')">
                        <div class="landing-card-icon">ğŸ </div>
                        <h2 class="landing-card-title">FAMILY REAL ESTATES</h2>
                        <p class="landing-card-desc">Manage family properties, rental income, bills, payments, and Islamic inheritance.</p>
                        <div class="landing-card-stats">
                            <div class="landing-stat">
                                <div class="landing-stat-value amount-positive" id="landingFamilyIncome">0</div>
                                <div class="landing-stat-label">Total Income</div>
                            </div>
                            <div class="landing-stat">
                                <div class="landing-stat-value amount-negative" id="landingFamilyExpenses">0</div>
                                <div class="landing-stat-label">Total Expenses</div>
                            </div>
                            <div class="landing-stat">
                                <div class="landing-stat-value" id="landingFamilyProperties">0</div>
                                <div class="landing-stat-label">Properties</div>
                            </div>
                        </div>
                        <div class="btn-group" style="justify-content: center; margin-top: 1rem;">
                            <button class="btn btn-success btn-lg">Enter Family Real Estates â†’</button>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="max-width: 900px; margin: 0 auto;">
                    <div class="card-header gold"><span>ğŸ“Š Combined Portfolio Overview</span></div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card green"><div class="stat-icon">ğŸ’µ</div><div class="stat-value" id="landingTotalIncome">0</div><div class="stat-label">Combined Income</div></div>
                            <div class="stat-card red"><div class="stat-icon">ğŸ’¸</div><div class="stat-value" id="landingTotalExpenses">0</div><div class="stat-label">Combined Expenses</div></div>
                            <div class="stat-card blue"><div class="stat-icon">ğŸ¦</div><div class="stat-value" id="landingTotalBalance">0</div><div class="stat-label">Combined Balance</div></div>
                            <div class="stat-card gold"><div class="stat-icon">ğŸ </div><div class="stat-value" id="landingTotalProperties">0</div><div class="stat-label">Total Properties</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== MAIN SETTINGS PAGE ==================== -->
        <div id="main-settings" class="page">
            <div class="card">
                <div class="card-header gold"><span>ğŸ‘¤ My Account</span></div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="myUsername" readonly>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="myEmail" readonly>
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <input type="text" id="myRole" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span>ğŸ” Change My Password</span></div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" id="changeCurrentPwd" placeholder="Enter current password">
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="changeNewPwd" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" id="changeConfirmPwd" placeholder="Confirm new password">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="changeMyPassword()">ğŸ” Change Password</button>
                    </div>
                </div>
            </div>

            <!-- Admin Only: User Management -->
            <div id="adminUserManagement" style="display: none;">
                <div class="card">
                    <div class="card-header green"><span>â• Create New User</span><span class="badge badge-income">ADMIN ONLY</span></div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Username *</label>
                                <input type="text" id="newUserUsername" placeholder="Enter username">
                            </div>
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" id="newUserEmail" placeholder="Enter email address">
                            </div>
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="newUserFullName" placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label>Role *</label>
                                <select id="newUserRole">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        <p style="font-size: 0.8rem; color: #718096; margin: 10px 0; background: #ebf8ff; padding: 8px; border-radius: 6px;">
                            ğŸ“Œ Default password for new users is <strong>1234</strong>. User must change it on first login.
                        </p>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="createNewUser()">ğŸ‘¤ Create User</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><span>ğŸ‘¥ All Users</span><span class="badge badge-income">ADMIN ONLY</span></div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Full Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== CAMPOST MANKON MODULE ==================== -->
        
        <!-- CAMPOST DASHBOARD -->
        <div id="campost-dashboard" class="page">
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">ğŸ’µ</div><div class="stat-value" id="dashIncome">0</div><div class="stat-label">Total Income</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ’¸</div><div class="stat-value" id="dashExp">0</div><div class="stat-label">Total Expenses</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ¦</div><div class="stat-value" id="dashReserve">0</div><div class="stat-label">Reserved Funds</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ“Š</div><div class="stat-value" id="dashNetBalance">0</div><div class="stat-label">Net Balance</div></div>
                <div class="stat-card gold"><div class="stat-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div><div class="stat-value" id="dashInh">0</div><div class="stat-label">Inheritance Pool</div></div>
            </div>
            <div class="card">
                <div class="card-header"><span>ğŸ“Š Financial Summary</span></div>
                <div class="card-body">
                    <div class="summary-row"><span>Total Income (Bills Paid):</span><span class="amount-positive" id="dashIncomeSum">0 XAF</span></div>
                    <div class="summary-row"><span>Total Expenses:</span><span class="amount-negative" id="dashExpSum">0 XAF</span></div>
                    <div class="summary-row"><span>Reserved Funds (<span id="dashReservePercent">10</span>% of Income):</span><span class="amount-negative" id="dashReserveSum">0 XAF</span></div>
                    <div class="summary-row" style="font-size: 1rem; background: #fed7d7; padding: 8px; border-radius: 6px;"><span><strong>ğŸ“Š Net Balance (Income - Expenses - Reserved):</strong></span><span id="dashNetBalanceSum" style="font-weight: bold; color: #c53030;">0 XAF</span></div>
                    <div class="summary-row"><span>Inheritance Pool (from distributions):</span><span class="amount-gold" id="dashInhSum">0 XAF</span></div>
                </div>
            </div>
        </div>

        <!-- LEDGER -->
        <div id="campost-ledger" class="page">
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">ğŸ’µ</div><div class="stat-value" id="ledgerIncome">0</div><div class="stat-label">Total Income (from Bills)</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ’¸</div><div class="stat-value" id="ledgerExpense">0</div><div class="stat-label">Total Expenses</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ¦</div><div class="stat-value" id="ledgerReserved">0</div><div class="stat-label">Reserved Funds</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ“Š</div><div class="stat-value" id="ledgerNetBalance">0</div><div class="stat-label">Net Balance</div></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“’ Ledger - Income & Expenses (Auto-Generated)</span>
                    <div class="no-print">
                        <button class="btn btn-print btn-sm" onclick="exportPDF('ledger')">ğŸ“¥ Export PDF</button>
                        <button class="btn btn-outline btn-sm" onclick="exportCSV('ledger')">ğŸ“¥ Export CSV</button>
                        <button class="btn btn-print btn-sm" onclick="printPage('ledger')">ğŸ–¨ï¸ Print</button>
                    </div>
                </div>
                <div class="card-body">
                    <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                        ğŸ“Œ <strong>Income</strong> = Bills with status Paid or Partial | <strong>Expenses</strong> = All recorded expenses | <strong>Net Balance</strong> = Income - Expenses - Reserved Funds
                    </p>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th style="background: #c6f6d5; color: #276749;">Income (Credit)</th>
                                    <th style="background: #fed7d7; color: #c53030;">Expense (Debit)</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody id="ledgerTable"></tbody>
                            <tfoot id="ledgerTotals"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXPENSES -->
        <div id="campost-expenses" class="page">
            <div class="user-restricted-notice">
                <strong>ğŸ”’ Access Restricted</strong><br>
                Only administrators can access Expenses. Please contact an admin if you need to add or modify expenses.
            </div>
            <div class="admin-only-section">
            <div class="card no-print">
                <div class="card-header green"><span>â• Add/Edit Expense</span></div>
                <div class="card-body">
                    <div id="campostExpenseWarning" style="display: none; background: #fed7d7; border: 1px solid #fc8181; color: #c53030; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>âš ï¸ Expenses Disabled:</strong> Net Balance is zero. You cannot add more expenses until more income is received. 
                        <br><small>Net Balance = Total Income - Total Expenses - Reserved Funds</small>
                    </div>
                    <input type="hidden" id="expId">
                    <div class="form-grid">
                        <div class="form-group"><label>Date</label><input type="date" id="expDate"></div>
                        <div class="form-group"><label>Description</label><input type="text" id="expDesc" placeholder="Description"></div>
                        <div class="form-group"><label>Category</label><select id="expCat"></select></div>
                        <div class="form-group"><label>Amount</label><input type="number" id="expAmt" placeholder="Amount"></div>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" id="campostSaveExpenseBtn" onclick="saveExpense()">ğŸ’¾ Save</button><button class="btn btn-outline" onclick="clearExpenseForm()">ğŸ”„ Clear</button></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><span>ğŸ’¸ Expenses</span><button class="btn btn-print btn-sm no-print" onclick="printPage('expenses')">ğŸ–¨ï¸ Print</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th class="no-print">Actions</th></tr></thead><tbody id="expTable"></tbody><tfoot id="expTotals"></tfoot></table></div></div></div>
            </div>
        </div>

        <!-- BILLS -->
        <div id="campost-bills" class="page">
            <div class="user-restricted-notice">
                <strong>ğŸ”’ Access Restricted</strong><br>
                Only administrators can access Bills. Please contact an admin if you need to create or modify bills.
            </div>
            <div class="admin-only-section">
            <div class="card no-print">
                <div class="card-header green"><span>â• Add/Edit Bill</span></div>
                <div class="card-body">
                    <input type="hidden" id="billEditMode"><input type="hidden" id="billOldNumber">
                    <div class="form-grid">
                        <div class="form-group"><label>Quarter</label><select id="billQ"><option value="Q1">Q1</option><option value="Q2">Q2</option><option value="Q3">Q3</option><option value="Q4">Q4</option></select></div>
                        <div class="form-group"><label>Year</label><select id="billY"></select></div>
                        <div class="form-group"><label>Period</label><select id="billP"><option value="January to March">January to March</option><option value="April to June">April to June</option><option value="July to September">July to September</option><option value="October to December">October to December</option></select></div>
                        <div class="form-group"><label>Bill Number</label><input type="text" id="billNum" readonly></div>
                    </div>
                    <div style="background: #ebf8ff; padding: 12px; border-radius: 8px; margin: 10px 0; border: 1px solid #90cdf4;">
                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; font-size: 0.85rem;">
                            <div><span style="color: #4a5568;">Monthly Rate:</span> <strong id="billShowRate">200,000</strong> XAF</div>
                            <div><span style="color: #4a5568;">Gross (3 mo):</span> <strong id="billShowGross">600,000</strong> XAF</div>
                            <div><span style="color: #4a5568;">Tax (<span id="billShowTaxPct">15</span>%):</span> <strong id="billShowTax" style="color: #e53e3e;">-90,000</strong> XAF</div>
                            <div><span style="color: #4a5568;">Net Due:</span> <strong id="billShowNet" style="color: #38a169;">510,000</strong> XAF</div>
                        </div>
                        <p style="margin-top: 8px; font-size: 0.7rem; color: #718096;">ğŸ’¡ To change monthly rate or tax rate, go to <strong>Settings</strong> tab</p>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="saveBill()">ğŸ’¾ Save Bill</button><button class="btn btn-outline" onclick="clearBillForm()">ğŸ”„ Clear</button></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><span>ğŸ“„ All Bills (Click to View Invoice)</span><button class="btn btn-print btn-sm no-print" onclick="printPage('bills')">ğŸ–¨ï¸ Print List</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Bill #</th><th>Period</th><th>Due</th><th>Paid</th><th>Outstanding</th><th>Status</th><th class="no-print">Actions</th></tr></thead><tbody id="billTable"></tbody></table></div></div></div>
            </div>
        </div>

        <!-- PAYMENTS -->
        <div id="campost-payments" class="page">
            <div class="user-restricted-notice">
                <strong>ğŸ”’ Access Restricted</strong><br>
                Only administrators can access Payments. Please contact an admin if you need to record payments.
            </div>
            <div class="admin-only-section">
            <div class="card no-print">
                <div class="card-header green"><span>â• Add/Edit Payment</span></div>
                <div class="card-body">
                    <input type="hidden" id="payId">
                    <div class="form-grid">
                        <div class="form-group"><label>Select Bill</label><select id="payBill"></select></div>
                        <div class="form-group"><label>Outstanding</label><input type="text" id="payOut" readonly></div>
                        <div class="form-group"><label>Amount (XAF)</label><input type="number" id="payAmt"></div>
                        <div class="form-group"><label>Date</label><input type="date" id="payDate"></div>
                        <div class="form-group"><label>Reference</label><input type="text" id="payRef" placeholder="Receipt #"></div>
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="savePayment()">ğŸ’¾ Save</button><button class="btn btn-outline" onclick="clearPaymentForm()">ğŸ”„ Clear</button></div>
                </div>
            </div>
            <div class="card"><div class="card-header"><span>ğŸ’µ Payments</span><button class="btn btn-print btn-sm no-print" onclick="printPage('payments')">ğŸ–¨ï¸ Print</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Date</th><th>Bill #</th><th>Period</th><th>Amount</th><th>Reference</th><th class="no-print">Actions</th></tr></thead><tbody id="payTable"></tbody></table></div></div></div>
            </div>
        </div>

        <!-- INHERITANCE -->
        <div id="campost-inheritance" class="page">
            <div class="highlight-box">
                <p>Amount to Distribute (from Inheritance Share expenses)</p>
                <h3 id="inhAmt">0 XAF</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">ğŸ’µ</div><div class="stat-value" id="inhPaid">0</div><div class="stat-label">Bills Paid</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ’¸</div><div class="stat-value" id="inhExp">0</div><div class="stat-label">Expenses</div></div>
                <div class="stat-card blue"><div class="stat-icon">ğŸ¦</div><div class="stat-value" id="inhRes">0</div><div class="stat-label">Reserve</div></div>
                <div class="stat-card gold"><div class="stat-icon">ğŸ“Š</div><div class="stat-value" id="inhPer">0</div><div class="stat-label">Per Portion</div></div>
            </div>
            
            <!-- Beneficiary Selection Card -->
            <div class="card admin-only-section no-print">
                <div class="card-header blue"><span>âœ… Select Beneficiaries</span>
                    <div>
                        <button class="btn btn-outline btn-sm" onclick="selectAllCampostBeneficiaries(true)">Select All</button>
                        <button class="btn btn-outline btn-sm" onclick="selectAllCampostBeneficiaries(false)">Deselect All</button>
                        <button class="btn btn-warning btn-sm" onclick="resetCampostHeirsToDefaults()">ğŸ”„ Reset to Defaults</button>
                    </div>
                </div>
                <div class="card-body">
                    <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                        âœ… Check the heirs who should receive inheritance. Only selected heirs will be included in the distribution.
                    </p>
                    <div id="campostBeneficiaryList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;"></div>
                    <div class="btn-group" style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="saveCampostBeneficiaries()">ğŸ’¾ Save Selection & Recalculate</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header gold"><span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Heirs (<span id="inhPortions">24</span> portions)</span>
                <div class="no-print"><button class="btn btn-outline btn-sm admin-only" onclick="openHeirModal()">â• Add</button><button class="btn btn-gold btn-sm" onclick="printAllHeirCertificates()">ğŸ–¨ï¸ Print All Certificates</button></div>
                </div>
                <div class="card-body" id="heirGroups"></div>
            </div>
            <div class="card"><div class="card-header"><span>ğŸ“‹ Heir Shares (Beneficiaries Only)</span><button class="btn btn-print btn-sm no-print" onclick="printPage('inheritance')">ğŸ–¨ï¸ Print Summary</button></div>
            <div class="card-body"><div class="table-container"><table><thead><tr><th>Name</th><th>Relationship</th><th>Group</th><th>Portions</th><th>Share (XAF)</th><th class="no-print admin-only">Actions</th></tr></thead><tbody id="heirTable"></tbody></table></div></div></div>
        </div>

        <!-- EXPORT -->
        <div id="campost-export" class="page">
            <div class="card"><div class="card-header"><span>ğŸ“¥ Export All Data</span></div>
            <div class="card-body">
                <p style="margin-bottom:1rem;font-size:0.85rem;">Export with CAMPOST MANKON header.</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="exportAllCSV()">ğŸ“„ All CSV</button>
                    <button class="btn btn-print" onclick="exportAllPDF()">ğŸ“‘ All PDF</button>
                </div>
            </div></div>
            <div class="card"><div class="card-header"><span>ğŸ“Š Individual Exports</span></div>
            <div class="card-body">
                <div class="btn-group">
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('bills')">Bills CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('payments')">Payments CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('expenses')">Expenses CSV</button>
                    <button class="btn btn-outline btn-sm" onclick="exportCSV('ledger')">Ledger CSV</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-print btn-sm" onclick="exportPDF('bills')">Bills PDF</button>
                    <button class="btn btn-print btn-sm" onclick="exportPDF('payments')">Payments PDF</button>
                    <button class="btn btn-print btn-sm" onclick="exportPDF('expenses')">Expenses PDF</button>
                    <button class="btn btn-primary btn-sm" onclick="exportPDF('ledger')">Ledger PDF</button>
                    <button class="btn btn-gold btn-sm" onclick="exportPDF('heirs')">Heirs PDF</button>
                    <button class="btn btn-success btn-sm" onclick="exportREPropertiesPDF()">Properties PDF</button>
                </div>
            </div></div>
        </div>

        <!-- ==================== FAMILY REAL ESTATES MODULE ==================== -->
        
        <!-- FAMILY DASHBOARD -->
        <div id="family-dashboard" class="page">
            <div class="stats-grid">
                <div class="stat-card green"><div class="stat-icon">ğŸ </div><div class="stat-value" id="reTotalProps">0</div><div class="stat-label">Total Properties</div></div>
                <div class="stat-card blue"><div class="stat-icon">ğŸ”‘</div><div class="stat-value" id="reRented">0</div><div class="stat-label">Rented Properties</div></div>
                <div class="stat-card gold"><div class="stat-icon">ğŸ’°</div><div class="stat-value" id="reTotalIncome">0</div><div class="stat-label">Total Income</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ’¸</div><div class="stat-value" id="reTotalExpenses">0</div><div class="stat-label">Total Expenses</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ¦</div><div class="stat-value" id="reReservedFunds">0</div><div class="stat-label">Reserved Funds</div></div>
                <div class="stat-card red"><div class="stat-icon">ğŸ“Š</div><div class="stat-value" id="reNetBalance">0</div><div class="stat-label">Net Balance</div></div>
            </div>
            <div class="card">
                <div class="card-header gold"><span>ğŸ“Š Family Real Estate Summary</span></div>
                <div class="card-body">
                    <div class="summary-row"><span>Total Properties:</span><span id="familySummaryProps">0</span></div>
                    <div class="summary-row"><span>Rented Properties:</span><span class="amount-positive" id="familySummaryRented">0</span></div>
                    <div class="summary-row"><span>Total Income (Net after Tax):</span><span class="amount-positive" id="familySummaryIncome">0 XAF</span></div>
                    <div class="summary-row"><span>Total Expenses:</span><span class="amount-negative" id="familySummaryExpenses">0 XAF</span></div>
                    <div class="summary-row"><span>Reserved Funds:</span><span class="amount-negative" id="familySummaryReserved">0 XAF</span></div>
                    <div class="summary-row" style="font-size: 1rem;"><span><strong>Net Balance:</strong></span><span id="familySummaryBalance" style="font-weight: bold;">0 XAF</span></div>
                </div>
            </div>
        </div>

        <!-- FAMILY PROPERTIES -->
        <div id="family-properties" class="page">
            <div class="card">
                <div class="card-header">
                    <span>ğŸ  Family Properties Portfolio</span>
                    <div class="no-print">
                        <button class="btn btn-success btn-sm admin-only" onclick="openPropertyModal()">â• Add Property</button>
                        <button class="btn btn-print btn-sm" onclick="exportREPropertiesPDF()">ğŸ“¥ Export PDF</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="user-restricted-notice" style="margin-bottom: 10px;">
                        <strong>ğŸ”’ View Only Mode</strong><br>
                        Only administrators can add, edit, or delete properties.
                    </div>
                    <div style="margin-bottom: 10px;">
                        <select id="reStatusFilter" onchange="filterProperties()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="">All Status</option>
                            <option value="Rented">Rented</option>
                            <option value="Sold">Sold</option>
                            <option value="For sale">For Sale</option>
                            <option value="Not to be sold">Not to be Sold</option>
                            <option value="Shared">Shared</option>
                            <option value="Admin issues">Admin Issues</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Property Name</th>
                                    <th>Location</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Rent Amount</th>
                                    <th>Period</th>
                                    <th>Tax Rate</th>
                                    <th>Net Income</th>
                                    <th>Islamic Inh.</th>
                                    <th class="no-print admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="propertiesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

            <!-- ========== RENTAL INCOME TAB ========== -->
            <div id="family-income" class="page">
                <div class="card">
                    <div class="card-header gold">
                        <span>ğŸ’µ Rental Income Summary</span>
                        <button class="btn btn-print btn-sm no-print" onclick="exportRERentalIncomePDF()">ğŸ“¥ Export PDF</button>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px; background: #fffbeb; padding: 10px; border-radius: 6px;">
                            ğŸ“Œ <strong>Note:</strong> Only properties with status <strong>"Rented"</strong> have income. All other properties show Rent Amount, Period, Tax Rate, Gross Income, Tax Amount, and Net Income as <strong>0</strong>.
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Rent Amount</th>
                                        <th>Period</th>
                                        <th>Tax Rate</th>
                                        <th>Gross Income</th>
                                        <th>Tax Amount</th>
                                        <th>Net Income</th>
                                    </tr>
                                </thead>
                                <tbody id="rentalIncomeTable"></tbody>
                                <tfoot id="rentalIncomeTotals"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE BILLS TAB ========== -->
            <div id="family-bills" class="page">
                <div class="user-restricted-notice">
                    <strong>ğŸ”’ Access Restricted</strong><br>
                    Only administrators can access Bills. Please contact an admin if you need to create or modify bills.
                </div>
                <div class="admin-only-section">
                <div class="card no-print">
                    <div class="card-header green"><span>â• Create Property Bill</span></div>
                    <div class="card-body">
                        <input type="hidden" id="reBillId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Property (Rented Only) *</label>
                                <select id="reBillProperty" onchange="onREPropertySelect()"></select>
                            </div>
                            <div class="form-group">
                                <label>Bill Date *</label>
                                <input type="date" id="reBillDate">
                            </div>
                            <div class="form-group">
                                <label>Period (from Property)</label>
                                <input type="text" id="reBillPeriod" readonly placeholder="Select property first" style="background: #f0f0f0;">
                            </div>
                            <div class="form-group">
                                <label>Year *</label>
                                <input type="number" id="reBillYear" value="2025">
                            </div>
                            <div class="form-group">
                                <label>Gross Rent (XAF)</label>
                                <input type="number" id="reBillGrossAmount" placeholder="Gross rent" onchange="calculateBillNet()" oninput="calculateBillNet()">
                            </div>
                            <div class="form-group">
                                <label>Tax Rate (%)</label>
                                <input type="text" id="reBillTaxRate" readonly style="background: #f0f0f0;" value="0%">
                            </div>
                            <div class="form-group">
                                <label>Tax Amount (XAF)</label>
                                <input type="text" id="reBillTaxAmount" readonly style="background: #f0f0f0; color: #e53e3e;" value="0">
                            </div>
                            <div class="form-group">
                                <label>Net Amount Due (After Tax) *</label>
                                <input type="text" id="reBillAmount" readonly style="background: #c6f6d5; font-weight: bold; color: #276749;" value="0">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Description</label>
                                <input type="text" id="reBillDesc" placeholder="Bill description">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="saveREBill()">ğŸ’¾ Save Bill</button>
                            <button class="btn btn-outline" onclick="clearREBillForm()">ğŸ”„ Clear</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>ğŸ“„ Property Bills (Net After Tax)</span><button class="btn btn-print btn-sm no-print" onclick="exportREBillsPDF()">ğŸ“¥ Export PDF</button></div>
                    <div class="card-body">
                        <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                            ğŸ“Œ All amounts shown are <strong>NET</strong> after tax deductions. Tax is calculated based on property tax rate.
                        </p>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Bill #</th><th>Property</th><th>Period</th><th>Year</th><th>Gross</th><th>Tax</th><th>Net Due</th><th>Paid</th><th>Outstanding</th><th>Status</th><th class="no-print">Actions</th></tr></thead>
                                <tbody id="reBillsTable"></tbody>
                                <tfoot id="reBillsTotals"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- ========== RE PAYMENTS TAB ========== -->
            <div id="family-payments" class="page">
                <div class="user-restricted-notice">
                    <strong>ğŸ”’ Access Restricted</strong><br>
                    Only administrators can access Payments. Please contact an admin if you need to record payments.
                </div>
                <div class="admin-only-section">
                <div class="card no-print">
                    <div class="card-header green"><span>â• Record Payment</span></div>
                    <div class="card-body">
                        <input type="hidden" id="rePayId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Bill (from Bills) *</label>
                                <select id="rePayBill" onchange="onREBillSelect()"></select>
                            </div>
                            <div class="form-group">
                                <label>Payment Date *</label>
                                <input type="date" id="rePayDate">
                            </div>
                            <div class="form-group">
                                <label>Amount (XAF) *</label>
                                <input type="number" id="rePayAmount" placeholder="Payment amount">
                            </div>
                            <div class="form-group">
                                <label>Reference</label>
                                <input type="text" id="rePayRef" placeholder="Receipt/Reference number">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="saveREPayment()">ğŸ’¾ Save Payment</button>
                            <button class="btn btn-outline" onclick="clearREPaymentForm()">ğŸ”„ Clear</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>ğŸ’³ Payment History</span><button class="btn btn-print btn-sm no-print" onclick="exportREPaymentsPDF()">ğŸ“¥ Export PDF</button></div>
                    <div class="card-body">
                        <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                            ğŸ“Œ Payment amounts match the <strong>Net Amount Due</strong> from Bills (tax already deducted in Bills).
                        </p>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Date</th><th>Property</th><th>Bill #</th><th>Amount</th><th>Reference</th><th class="no-print">Actions</th></tr></thead>
                                <tbody id="rePaymentsTable"></tbody>
                                <tfoot id="rePaymentsTotals"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- ========== RE EXPENSES TAB ========== -->
            <div id="family-expenses" class="page">
                <div class="user-restricted-notice">
                    <strong>ğŸ”’ Access Restricted</strong><br>
                    Only administrators can access Expenses. Please contact an admin if you need to add or modify expenses.
                </div>
                <div class="admin-only-section">
                <div class="card no-print">
                    <div class="card-header green"><span>â• Add Property Expense</span></div>
                    <div class="card-body">
                        <div id="expenseWarning" style="display: none; background: #fed7d7; border: 1px solid #fc8181; color: #c53030; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <strong>âš ï¸ Expenses Disabled:</strong> Net Balance is zero. You cannot add more expenses until more income is received. 
                            <br><small>Net Balance = Total Income - Total Expenses - Reserved Funds</small>
                        </div>
                        <input type="hidden" id="reExpId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Property (Optional)</label>
                                <select id="reExpProperty"></select>
                            </div>
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" id="reExpDate">
                            </div>
                            <div class="form-group">
                                <label>Category *</label>
                                <select id="reExpCategory">
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Repairs">Repairs</option>
                                    <option value="Taxes">Taxes</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Insurance">Insurance</option>
                                    <option value="Legal">Legal Fees</option>
                                    <option value="Agent Fees">Agent Fees</option>
                                    <option value="Inheritance Share">Inheritance Share</option>
                                    <option value="Others">Others</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Amount *</label>
                                <input type="number" id="reExpAmount" placeholder="Amount" min="0">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Description *</label>
                                <input type="text" id="reExpDesc" placeholder="Expense description">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="saveREExpense()">ğŸ’¾ Save Expense</button>
                            <button class="btn btn-outline" onclick="clearREExpenseForm()">ğŸ”„ Clear</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>ğŸ’¸ Property Expenses</span><button class="btn btn-print btn-sm no-print" onclick="exportREExpensesPDF()">ğŸ“¥ Export PDF</button></div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Date</th><th>Property</th><th>Category</th><th>Description</th><th>Amount</th><th class="no-print">Actions</th></tr></thead>
                                <tbody id="reExpensesTable"></tbody>
                                <tfoot id="reExpensesTotal"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- ========== RE INHERITANCE TAB ========== -->
            <div id="family-inheritance" class="page">
                <div class="stats-grid">
                    <div class="stat-card gold"><div class="stat-icon">ğŸ’°</div><div class="stat-value" id="reInhPool">0</div><div class="stat-label">Inheritance Pool</div></div>
                    <div class="stat-card green"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value" id="reInhHeirs">0</div><div class="stat-label">Beneficiaries</div></div>
                    <div class="stat-card blue"><div class="stat-icon">ğŸ“Š</div><div class="stat-value" id="reInhPortions">0</div><div class="stat-label">Total Portions</div></div>
                    <div class="stat-card red"><div class="stat-icon">ğŸ’µ</div><div class="stat-value" id="reInhPerPortion">0</div><div class="stat-label">Per Portion</div></div>
                </div>
                
                <!-- Beneficiary Selection Card -->
                <div class="card admin-only-section no-print">
                    <div class="card-header blue"><span>âœ… Select Beneficiaries</span>
                        <div>
                            <button class="btn btn-outline btn-sm" onclick="selectAllREBeneficiaries(true)">Select All</button>
                            <button class="btn btn-outline btn-sm" onclick="selectAllREBeneficiaries(false)">Deselect All</button>
                            <button class="btn btn-warning btn-sm" onclick="resetREHeirsToDefaults()">ğŸ”„ Reset to Defaults</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                            âœ… Check the heirs who should receive inheritance from Family Real Estates. Only selected heirs will be included in the distribution.
                        </p>
                        <div id="reBeneficiaryList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;"></div>
                        <div class="btn-group" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="saveREBeneficiaries()">ğŸ’¾ Save Selection & Recalculate</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header gold">
                        <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Real Estate Inheritance Distribution</span>
                        <div class="no-print">
                            <button class="btn btn-success btn-sm admin-only" onclick="openREHeirModal()">â• Add Heir</button>
                            <button class="btn btn-gold btn-sm" onclick="printAllREHeirCertificates()">ğŸ–¨ï¸ Print All Certificates</button>
                            <button class="btn btn-print btn-sm" onclick="exportREHeirsPDF()">ğŸ“¥ Export PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                            ğŸ“Œ Inheritance pool is calculated from: <strong>Total Income - Total Expenses</strong> from properties marked for Islamic Inheritance.
                            <br>Only <strong>selected beneficiaries</strong> are included in the distribution below.
                        </p>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Name</th><th>Relationship</th><th>Gender</th><th>Portions</th><th>Share Amount</th><th class="no-print">Actions</th></tr></thead>
                                <tbody id="reHeirsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE LEDGER TAB ========== -->
            <div id="family-ledger" class="page">
                <div class="card">
                    <div class="card-header">
                        <span>ğŸ“’ Real Estate Ledger (Auto-Generated)</span>
                        <div class="no-print">
                            <button class="btn btn-print btn-sm" onclick="exportRELedgerPDF()">ğŸ“¥ Export PDF</button>
                            <button class="btn btn-outline btn-sm" onclick="exportCSV('reLedger')">ğŸ“¥ Export CSV</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.8rem; color: #718096; margin-bottom: 10px;">
                            ğŸ“Œ <strong>Income</strong> = Payments from bills (Paid/Partial) | <strong>Expenses</strong> = All property expenses
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Property</th>
                                        <th>Description</th>
                                        <th>Type</th>
                                        <th style="background: #c6f6d5;">Income</th>
                                        <th style="background: #fed7d7;">Expense</th>
                                        <th>Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="reLedgerTable"></tbody>
                                <tfoot id="reLedgerTotals"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE EXPORT TAB ========== -->
            <div id="family-export" class="page">
                <div class="card">
                    <div class="card-header"><span>ğŸ“¥ Export Real Estate Data</span></div>
                    <div class="card-body">
                        <p style="margin-bottom: 15px; color: #718096;">Export all Real Estate data with headers.</p>
                        <div class="btn-group" style="flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="exportAllRECSV()">ğŸ“„ All Data CSV</button>
                            <button class="btn btn-print" onclick="exportAllREPDF()">ğŸ“‘ All Data PDF</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span>ğŸ“Š Individual PDF Exports</span></div>
                    <div class="card-body">
                        <div class="btn-group" style="flex-wrap: wrap;">
                            <button class="btn btn-print btn-sm" onclick="exportREPropertiesPDF()">ğŸ  Properties PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportRERentalIncomePDF()">ğŸ’µ Rental Income PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportREBillsPDF()">ğŸ“„ Bills PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportREPaymentsPDF()">ğŸ’³ Payments PDF</button>
                            <button class="btn btn-print btn-sm" onclick="exportREExpensesPDF()">ğŸ’¸ Expenses PDF</button>
                            <button class="btn btn-primary btn-sm" onclick="exportRELedgerPDF()">ğŸ“’ Ledger PDF</button>
                            <button class="btn btn-gold btn-sm" onclick="exportREHeirsPDF()">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Inheritance PDF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== RE SETTINGS TAB ========== -->
            <div id="family-settings" class="page">
                <div class="user-restricted-notice">
                    <strong>ğŸ”’ Access Restricted</strong><br>
                    Only administrators can access Settings. Please contact an admin if you need to modify system settings.
                </div>
                <div class="admin-only-section">
                <div class="card">
                    <div class="card-header gold"><span>âš™ï¸ Global Default Settings</span></div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                            These defaults will be applied to new properties. Changes here will update all existing properties.
                        </p>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Default Tax Rate (%)</label>
                                <select id="reSettingTaxRate" onchange="previewGlobalSettings()">
                                    <option value="0">0%</option>
                                    <option value="5">5%</option>
                                    <option value="10">10%</option>
                                    <option value="15" selected>15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Default Rental Period</label>
                                <select id="reSettingPeriod" onchange="previewGlobalSettings()">
                                    <option value="Monthly">Monthly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="reSettingCurrency">
                                    <option value="XAF">XAF (CFA Franc)</option>
                                    <option value="USD">USD (US Dollar)</option>
                                    <option value="EUR">EUR (Euro)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Reserved Funds (% of Income)</label>
                                <select id="reSettingReservedPercent">
                                    <option value="0">0% - No Reserve</option>
                                    <option value="5">5%</option>
                                    <option value="10" selected>10%</option>
                                    <option value="15">15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                    <option value="30">30%</option>
                                </select>
                            </div>
                        </div>
                        <div style="background: #f0f4f8; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                            <p style="font-size: 0.85rem; color: #4a5568; margin: 0;">
                                ğŸ¦ <strong>Reserved Funds:</strong> A percentage of total income set aside for maintenance, emergencies, or future investments. 
                                <br>ğŸ“Š <strong>Net Balance</strong> = Total Income - Total Expenses - Reserved Funds
                            </p>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="saveGlobalRESettings()">ğŸ’¾ Save & Apply to All Properties</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><span>ğŸ  Property-Specific Settings</span></div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                            Override global settings for individual properties.
                        </p>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Select Property</label>
                                <select id="reSettingProperty" onchange="loadPropertySettings()">
                                    <option value="">-- Select a Property --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tax Rate (%)</label>
                                <select id="reSettingPropTaxRate">
                                    <option value="0">0%</option>
                                    <option value="5">5%</option>
                                    <option value="10">10%</option>
                                    <option value="15">15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Rental Period</label>
                                <select id="reSettingPropPeriod">
                                    <option value="Monthly">Monthly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Rent Amount</label>
                                <input type="number" id="reSettingPropRent" placeholder="Rent amount">
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="reSettingPropStatus">
                                    <option value="Rented">Rented</option>
                                    <option value="Vacant">Vacant</option>
                                    <option value="Under Maintenance">Under Maintenance</option>
                                </select>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="savePropertySettings()">ğŸ’¾ Save Property Settings</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><span>ğŸ“‹ Properties Overview</span></div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Status</th>
                                        <th>Tax Rate</th>
                                        <th>Period</th>
                                        <th>Rent</th>
                                    </tr>
                                </thead>
                                <tbody id="reSettingsPropertiesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header red"><span>âš ï¸ Data Management</span></div>
                    <div class="card-body">
                        <p style="margin-bottom: 15px; color: #e53e3e;">Warning: These actions cannot be undone!</p>
                        <div class="btn-group">
                            <button class="btn btn-danger" onclick="resetREData()">ğŸ—‘ï¸ Reset All RE Data</button>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Property Modal -->
        <div class="modal-overlay" id="propertyModal">
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header"><h3 id="propertyModalTitle">ğŸ  Add Property</h3><button class="modal-close" onclick="closePropertyModal()">Ã—</button></div>
                <div class="modal-body">
                    <input type="hidden" id="propId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Property Name *</label>
                            <input type="text" id="propName" placeholder="e.g., Commercial Building A">
                        </div>
                        <div class="form-group">
                            <label>Location *</label>
                            <input type="text" id="propLocation" placeholder="e.g., Bamenda, NW Region">
                        </div>
                        <div class="form-group">
                            <label>Type *</label>
                            <select id="propType">
                                <option value="Residential">Residential</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Land">Land</option>
                                <option value="Industrial">Industrial</option>
                                <option value="Mixed">Mixed Use</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="propStatus" onchange="toggleRentalFields()">
                                <option value="Rented">Rented</option>
                                <option value="Sold">Sold</option>
                                <option value="For sale">For Sale</option>
                                <option value="Not to be sold">Not to be Sold</option>
                                <option value="Shared">Shared</option>
                                <option value="Admin issues">Admin Issues</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Rental Fields (only for Rented status) -->
                    <div id="rentalFields" style="background: #ebf8ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #2c5282; margin-bottom: 10px;">ğŸ’° Rental Configuration</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Rent Amount (XAF) *</label>
                                <input type="number" id="propRentAmount" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Rental Period *</label>
                                <select id="propRentPeriod">
                                    <option value="Monthly">Monthly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tax Rate (%) *</label>
                                <select id="propTaxRate">
                                    <option value="0">0%</option>
                                    <option value="5">5%</option>
                                    <option value="10">10%</option>
                                    <option value="15" selected>15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                </select>
                            </div>
                        </div>
                        <div style="background: #fff; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <div class="summary-row"><span>Gross Rent:</span><span id="propGrossRent">0 XAF</span></div>
                            <div class="summary-row"><span>Tax Deduction:</span><span id="propTaxAmount" style="color: #e53e3e;">0 XAF</span></div>
                            <div class="summary-row" style="font-weight: bold;"><span>Net Income:</span><span id="propNetIncome" style="color: #38a169;">0 XAF</span></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Shared per Islamic Inheritance?</label>
                        <select id="propInheritance">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                            <option value="NA">N/A</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="propNotes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveProperty()">ğŸ’¾ Save Property</button>
                        <button class="btn btn-outline" onclick="closePropertyModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RE Heir Modal -->
        <div class="modal-overlay" id="reHeirModal">
            <div class="modal">
                <div class="modal-header"><h3>ğŸ‘¤ Add/Edit Heir</h3><button class="modal-close" onclick="closeREHeirModal()">Ã—</button></div>
                <div class="modal-body">
                    <input type="hidden" id="reHeirId">
                    <div class="form-grid">
                        <div class="form-group"><label>Name *</label><input type="text" id="reHeirName" placeholder="Full name"></div>
                        <div class="form-group">
                            <label>Relationship *</label>
                            <select id="reHeirRel" onchange="updateIslamicPortions()">
                                <option value="Wife">Wife</option>
                                <option value="Husband">Husband</option>
                                <option value="Son">Son</option>
                                <option value="Daughter">Daughter</option>
                                <option value="Father">Father</option>
                                <option value="Mother">Mother</option>
                                <option value="Brother">Brother</option>
                                <option value="Sister">Sister</option>
                                <option value="Grandfather">Grandfather</option>
                                <option value="Grandmother">Grandmother</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gender *</label>
                            <select id="reHeirGender" onchange="updateIslamicPortions()">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Portions (Auto-Calculated)</label>
                            <input type="number" id="reHeirPor" value="1" min="0" step="0.125" readonly style="background: #f0f0f0;">
                        </div>
                    </div>
                    <div style="background: #fffbeb; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 0.85rem;">
                        <strong>ğŸ“œ Islamic Inheritance Rules:</strong><br>
                        â€¢ Sons get 2x daughters' share<br>
                        â€¢ Wife gets 1/8 (with children) or 1/4 (no children)<br>
                        â€¢ Husband gets 1/4 (with children) or 1/2 (no children)<br>
                        â€¢ Parents each get 1/6 (with children)
                    </div>
                    <div class="btn-group"><button class="btn btn-success" onclick="saveREHeir()">ğŸ’¾ Save</button><button class="btn btn-outline" onclick="closeREHeirModal()">Cancel</button></div>
                </div>
            </div>
        </div>

        <!-- SETTINGS -->
        <div id="campost-settings" class="page">
            <div class="user-restricted-notice">
                <strong>ğŸ”’ Access Restricted</strong><br>
                Only administrators can access Settings. Please contact an admin if you need to modify system settings.
            </div>
            <div class="admin-only-section">
            <div class="card">
                <div class="card-header gold"><span>ğŸŒ Currency & Global Settings</span></div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Currency</label>
                            <select id="campostCurrency" onchange="updateCampostCalcDisplays()">
                                <option value="XAF" selected>XAF - Central African CFA Franc</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="USD">USD - US Dollar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reserved Funds (% of Income)</label>
                            <select id="campostReservedPercent" onchange="updateCampostCalcDisplays()">
                                <option value="0">0% - No Reserve</option>
                                <option value="5">5%</option>
                                <option value="10" selected>10%</option>
                                <option value="15">15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                                <option value="30">30%</option>
                            </select>
                        </div>
                    </div>
                    <p style="font-size: 0.8rem; color: #718096; margin: 10px 0; background: #ebf8ff; padding: 10px; border-radius: 6px;">
                        ğŸ¦ <strong>Reserved Funds:</strong> A percentage of total income set aside for maintenance, emergencies, or future investments.<br>
                        ğŸ“Š <strong>Net Balance</strong> = Total Income - Total Expenses - Reserved Funds
                    </p>
                </div>
            </div>
            <div class="card">
                <div class="card-header gold"><span>ğŸ’° Rent Configuration</span></div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Monthly Rent</label>
                            <input type="number" id="settingMonthlyRent" value="200000">
                        </div>
                        <div class="form-group">
                            <label>Tax Rate (%)</label>
                            <input type="number" id="settingTaxRate" value="15" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Months per Quarter</label>
                            <input type="number" id="settingMonths" value="3" readonly>
                        </div>
                    </div>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-bottom: 10px; color: #2c5282;">ğŸ“Š Calculated Amounts</h4>
                        <div class="summary-row"><span>Quarterly Gross:</span><span id="calcGross">600,000 XAF</span></div>
                        <div class="summary-row"><span>Tax Deduction:</span><span id="calcTax">90,000 XAF</span></div>
                        <div class="summary-row" style="font-weight: bold; color: #38a169;"><span>Net Amount Due:</span><span id="calcNet">510,000 XAF</span></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ Save All Settings</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span>âš™ï¸ System Status</span></div>
                <div class="card-body">
                    <div class="alert" id="settingsAlert">Checking...</div>
                    <div class="btn-group">
                        <button class="btn btn-outline" onclick="checkDb()">ğŸ”„ Refresh</button>
                        <button class="btn btn-danger" onclick="resetAll()">ğŸ—‘ï¸ Reset All Data</button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </main>

    <!-- Bill/Invoice Modal -->
    <div class="modal-overlay" id="billModal">
        <div class="modal">
            <div class="modal-header"><h3>ğŸ“„ Rent Invoice</h3><button class="modal-close" onclick="closeBillModal()">Ã—</button></div>
            <div class="modal-body" id="billModalBody"></div>
        </div>
    </div>

    <!-- Heir Modal -->
    <div class="modal-overlay" id="heirModal">
        <div class="modal">
            <div class="modal-header"><h3>ğŸ‘¤ Heir</h3><button class="modal-close" onclick="closeHeirModal()">Ã—</button></div>
            <div class="modal-body">
                <input type="hidden" id="heirId">
                <div class="form-group"><label>Name</label><input type="text" id="heirName"></div>
                <div class="form-group"><label>Relationship</label><select id="heirRel"><option value="Spouse">Spouse</option><option value="Child">Child</option></select></div>
                <div class="form-group"><label>Group</label><select id="heirGrp"><option value="Wives">Wives</option><option value="Daughters">Daughters</option><option value="Sons">Sons</option></select></div>
                <div class="form-group"><label>Portions</label><input type="number" id="heirPor" value="3" step="0.5"></div>
                <div class="btn-group"><button class="btn btn-success" onclick="saveHeir()">ğŸ’¾ Save</button></div>
            </div>
        </div>
    </div>
    </div> <!-- End mainApp -->

    <div id="alertBox" style="position:fixed;top:60px;right:10px;z-index:3000;max-width:280px;"></div>

    <script>
        // ==================== AUTHENTICATION SYSTEM ====================
        
        // Initialize default admin user if not exists
        function initializeUsers() {
            // Users are now initialized in PostgreSQL
            // No localStorage initialization needed
        }
        
        // Initialize default heirs - now handled by server
        function initializeDefaultHeirs() {
            // RE heirs are now initialized in PostgreSQL
            // No localStorage initialization needed
        }
        
        // Current logged in user
        var currentUser = null;
        
        // Login function
        function doLogin() {
            var username = document.getElementById('loginUsername').value.trim().toLowerCase();
            var password = document.getElementById('loginPassword').value;
            var errorEl = document.getElementById('loginError');
            
            if (!username || !password) {
                errorEl.textContent = 'Please enter username and password';
                errorEl.classList.add('show');
                return;
            }
            
            api('/users/login', { 
                method: 'POST', 
                body: JSON.stringify({ username: username, password: password }) 
            }).then(function(result) {
                if (result.success && result.user) {
                    currentUser = result.user;
                    localStorage.setItem('currentSession', JSON.stringify({ userId: result.user.id, loginTime: new Date().toISOString() }));
                    enterMainApp();
                } else {
                    errorEl.textContent = result.error || 'Invalid username or password';
                    errorEl.classList.add('show');
                }
            }).catch(function(err) {
                errorEl.textContent = 'Login failed: ' + err.message;
                errorEl.classList.add('show');
            });
        }
        
        // Enter main app after successful login
        function enterMainApp() {
            document.getElementById('loginContainer').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';
            
            // Update UI with user info
            document.getElementById('loggedInUser').textContent = currentUser.full_name || currentUser.username;
            var badge = document.getElementById('userRoleBadge');
            badge.textContent = currentUser.role.toUpperCase();
            badge.className = 'user-badge ' + currentUser.role;
            
            // Set admin class on body for role-based access control
            if (currentUser.role === 'admin') {
                document.body.classList.add('is-admin');
                document.getElementById('adminUserManagement').style.display = 'block';
            } else {
                document.body.classList.remove('is-admin');
                document.getElementById('adminUserManagement').style.display = 'none';
            }
            
            // Initialize app
            checkDb();
            goToLanding();
        }
        
        // Logout function
        function doLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            currentUser = null;
            localStorage.removeItem('currentSession');
            
            // Reset UI
            document.body.classList.remove('is-admin');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginContainer').classList.add('active');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('adminUserManagement').style.display = 'none';
        }
        
        // Force password change
        function forceChangePassword() {
            var currentPwd = document.getElementById('forceCurrentPassword').value;
            var newPwd = document.getElementById('forceNewPassword').value;
            var confirmPwd = document.getElementById('forceConfirmPassword').value;
            
            if (currentPwd !== currentUser.password) {
                showAlert('Current password is incorrect', 'error');
                return;
            }
            
            if (newPwd.length < 4) {
                showAlert('New password must be at least 4 characters', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                showAlert('New passwords do not match', 'error');
                return;
            }
            
            if (newPwd === currentPwd) {
                showAlert('New password must be different from current password', 'error');
                return;
            }
            
            // Update password
            var users = JSON.parse(localStorage.getItem('appUsers') || '[]');
            var idx = users.findIndex(function(u) { return u.id === currentUser.id; });
            if (idx !== -1) {
                users[idx].password = newPwd;
                users[idx].mustChangePassword = false;
                localStorage.setItem('appUsers', JSON.stringify(users));
                currentUser = users[idx];
            }
            
            document.getElementById('forcePasswordModal').classList.remove('active');
            showAlert('Password changed successfully!');
            enterMainApp();
        }
        
        // Change my password (from settings)
        function changeMyPassword() {
            var currentPwd = document.getElementById('changeCurrentPwd').value;
            var newPwd = document.getElementById('changeNewPwd').value;
            var confirmPwd = document.getElementById('changeConfirmPwd').value;
            
            if (newPwd.length < 4) {
                showAlert('New password must be at least 4 characters', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                showAlert('New passwords do not match', 'error');
                return;
            }
            
            api('/users/change-password', {
                method: 'POST',
                body: JSON.stringify({ 
                    userId: currentUser.id, 
                    currentPassword: currentPwd, 
                    newPassword: newPwd 
                })
            }).then(function(result) {
                if (result.success) {
                    document.getElementById('changeCurrentPwd').value = '';
                    document.getElementById('changeNewPwd').value = '';
                    document.getElementById('changeConfirmPwd').value = '';
                    showAlert('Password changed successfully!');
                } else {
                    showAlert(result.error || 'Failed to change password', 'error');
                }
            }).catch(function(err) {
                showAlert('Current password is incorrect', 'error');
            });
        }
        
        // Create new user (admin only)
        function createNewUser() {
            if (currentUser.role !== 'admin') {
                showAlert('Only admins can create users', 'error');
                return;
            }
            
            var username = document.getElementById('newUserUsername').value.trim().toLowerCase();
            var fullName = document.getElementById('newUserFullName').value.trim();
            var role = document.getElementById('newUserRole').value;
            
            if (!username) {
                showAlert('Username is required', 'error');
                return;
            }
            
            api('/users', {
                method: 'POST',
                body: JSON.stringify({
                    username: username,
                    password: '1234',
                    fullName: fullName || username,
                    role: role,
                    active: true
                })
            }).then(function(result) {
                if (result.error) {
                    showAlert(result.error, 'error');
                } else {
                    document.getElementById('newUserUsername').value = '';
                    document.getElementById('newUserFullName').value = '';
                    document.getElementById('newUserRole').value = 'user';
                    showAlert('User created successfully! Default password is 1234');
                    loadUsersTable();
                }
            }).catch(function(err) {
                showAlert('Error creating user: ' + err.message, 'error');
            });
        }
        
        // Load users table (admin only)
        function loadUsersTable() {
            api('/users').then(function(users) {
                var html = users.map(function(u) {
                    var statusClass = u.active ? 'badge-paid' : 'badge-unpaid';
                    var statusText = u.active ? 'Active' : 'Inactive';
                    var roleClass = u.role === 'admin' ? 'badge-inheritance' : 'badge-new';
                    
                    return '<tr>' +
                        '<td><strong>' + u.username + '</strong></td>' +
                        '<td>' + (u.full_name || '-') + '</td>' +
                        '<td><span class="badge ' + roleClass + '">' + u.role.toUpperCase() + '</span></td>' +
                        '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
                        '<td>' +
                            (u.id !== currentUser.id ? 
                                '<button class="btn btn-warning btn-sm" onclick="resetUserPassword(' + u.id + ')">ğŸ”‘ Reset Pwd</button> ' +
                                '<button class="btn btn-' + (u.active ? 'danger' : 'success') + ' btn-sm" onclick="toggleUserStatus(' + u.id + ', ' + u.active + ')">' + (u.active ? 'ğŸš« Disable' : 'âœ… Enable') + '</button> ' +
                                '<button class="btn btn-danger btn-sm" onclick="deleteUser(' + u.id + ')">ğŸ—‘ï¸</button>'
                                : '<span style="color:#718096;font-size:0.75rem;">Current User</span>') +
                        '</td>' +
                    '</tr>';
                }).join('');
                
                document.getElementById('usersTable').innerHTML = html || '<tr><td colspan="5">No users</td></tr>';
            });
        }
        
        // Reset user password (admin only)
        function resetUserPassword(userId) {
            if (currentUser.role !== 'admin') return;
            if (!confirm('Reset this user\'s password to 1234?')) return;
            
            api('/users/' + userId, { 
                method: 'PUT', 
                body: JSON.stringify({ password: '1234' }) 
            }).then(function() {
                showAlert('Password reset to 1234');
                loadUsersTable();
            });
        }
        
        // Toggle user status (admin only)
        function toggleUserStatus(userId, currentActive) {
            if (currentUser.role !== 'admin') return;
            
            api('/users/' + userId, { 
                method: 'PUT', 
                body: JSON.stringify({ active: !currentActive }) 
            }).then(function() {
                showAlert('User status updated');
                loadUsersTable();
            });
        }
        
        // Delete user
        function deleteUser(userId) {
            if (currentUser.role !== 'admin') return;
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            api('/users/' + userId, { method: 'DELETE' }).then(function() {
                showAlert('User deleted');
                loadUsersTable();
            });
        }
        
        // Forgot password flow - simplified for demo
        function showForgotPassword() {
            showAlert('Please contact an administrator to reset your password.', 'error');
        }
        
        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
        }
        
        function resetPasswordWithCode() {
            var email = document.getElementById('forgotEmail').value.trim().toLowerCase();
            var code = document.getElementById('resetCode').value.trim();
            var newPwd = document.getElementById('newResetPassword').value;
            var confirmPwd = document.getElementById('confirmResetPassword').value;
            
            if (!code || !newPwd || !confirmPwd) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            if (newPwd.length < 4) {
                showAlert('Password must be at least 4 characters', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            var resetCodes = JSON.parse(localStorage.getItem('resetCodes') || '{}');
            var resetData = resetCodes[email];
            
            if (!resetData || resetData.code !== code) {
                showAlert('Invalid reset code', 'error');
                return;
            }
            
            if (Date.now() > resetData.expires) {
                showAlert('Reset code has expired. Please request a new one.', 'error');
                return;
            }
            
            // Update password
            var users = JSON.parse(localStorage.getItem('appUsers') || '[]');
            var idx = users.findIndex(function(u) { return u.id === resetData.userId; });
            if (idx !== -1) {
                users[idx].password = newPwd;
                users[idx].mustChangePassword = false;
                localStorage.setItem('appUsers', JSON.stringify(users));
            }
            
            // Remove used code
            delete resetCodes[email];
            localStorage.setItem('resetCodes', JSON.stringify(resetCodes));
            
            closeForgotPassword();
            showAlert('Password reset successfully! You can now login.');
        }
        
        // Load my account info
        function loadMyAccount() {
            if (currentUser) {
                document.getElementById('myUsername').value = currentUser.username;
                document.getElementById('myEmail').value = currentUser.email;
                document.getElementById('myRole').value = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            }
        }
        
        // Check for existing session on page load
        function checkExistingSession() {
            initializeUsers();
            
            var session = JSON.parse(localStorage.getItem('currentSession') || 'null');
            if (session) {
                var users = JSON.parse(localStorage.getItem('appUsers') || '[]');
                var user = users.find(function(u) { return u.id === session.userId && u.active; });
                if (user) {
                    currentUser = user;
                    if (user.mustChangePassword) {
                        document.getElementById('forcePasswordModal').classList.add('active');
                    } else {
                        enterMainApp();
                    }
                    return;
                }
            }
            // No valid session, show login
            document.getElementById('loginContainer').classList.add('active');
        }

        // ==================== END AUTHENTICATION SYSTEM ====================

        // Configuration - load from localStorage or use defaults
        var CONFIG = {
            monthlyRate: parseInt(localStorage.getItem('monthlyRate')) || 200000,
            taxRate: parseFloat(localStorage.getItem('taxRate')) || 0.15,
            months: 3,
            accountNo: '12003 14012 10868895015 89'
        };

        // Calculate amounts based on config
        function calcAmounts() {
            var gross = CONFIG.monthlyRate * CONFIG.months;
            var tax = Math.round(gross * CONFIG.taxRate);
            var net = gross - tax;
            return { gross: gross, tax: tax, net: net };
        }

        // Update displayed calculations
        function updateCalcDisplays() {
            var calc = calcAmounts();
            var taxPct = Math.round(CONFIG.taxRate * 100);
            // Settings page
            if (document.getElementById('calcGross')) {
                document.getElementById('calcGross').textContent = fmt(calc.gross) + ' XAF';
                document.getElementById('calcTax').textContent = fmt(calc.tax) + ' XAF';
                document.getElementById('calcNet').textContent = fmt(calc.net) + ' XAF';
            }
            // Bills page
            if (document.getElementById('billShowRate')) {
                document.getElementById('billShowRate').textContent = fmt(CONFIG.monthlyRate);
                document.getElementById('billShowGross').textContent = fmt(calc.gross);
                document.getElementById('billShowTax').textContent = '-' + fmt(calc.tax);
                document.getElementById('billShowNet').textContent = fmt(calc.net);
                if (document.getElementById('billShowTaxPct')) {
                    document.getElementById('billShowTaxPct').textContent = taxPct;
                }
            }
        }

        // Save settings
        function saveSettings() {
            var rate = parseInt(document.getElementById('settingMonthlyRent').value);
            var tax = parseFloat(document.getElementById('settingTaxRate').value) / 100;
            var currency = document.getElementById('campostCurrency').value;
            var reservedPercent = document.getElementById('campostReservedPercent').value;
            
            if (rate < 1000) {
                showAlert('Invalid monthly rate', 'error');
                return;
            }
            CONFIG.monthlyRate = rate;
            CONFIG.taxRate = tax;
            localStorage.setItem('monthlyRate', rate);
            localStorage.setItem('taxRate', tax);
            localStorage.setItem('campostCurrency', currency);
            localStorage.setItem('campostReservedPercent', reservedPercent);
            updateCalcDisplays();
            showAlert('All settings saved! Currency: ' + currency + ', Reserved: ' + reservedPercent + '%');
        }

        // Load settings into form
        function loadSettings() {
            document.getElementById('settingMonthlyRent').value = CONFIG.monthlyRate;
            document.getElementById('settingTaxRate').value = Math.round(CONFIG.taxRate * 100);
            
            // Load currency and reserved percent
            var currency = localStorage.getItem('campostCurrency') || 'XAF';
            var reservedPercent = localStorage.getItem('campostReservedPercent') || '10';
            document.getElementById('campostCurrency').value = currency;
            document.getElementById('campostReservedPercent').value = reservedPercent;
            
            updateCalcDisplays();
        }
        
        // Update CAMPOST calc displays with currency
        function updateCampostCalcDisplays() {
            var currency = document.getElementById('campostCurrency').value;
            var gross = CONFIG.monthlyRate * CONFIG.months;
            var tax = Math.round(gross * CONFIG.taxRate);
            var net = gross - tax;
            document.getElementById('calcGross').textContent = fmt(gross) + ' ' + currency;
            document.getElementById('calcTax').textContent = fmt(tax) + ' ' + currency;
            document.getElementById('calcNet').textContent = fmt(net) + ' ' + currency;
        }

        // Add event listeners for real-time calculation in settings
        function setupSettingsListeners() {
            var rateInput = document.getElementById('settingMonthlyRent');
            var taxInput = document.getElementById('settingTaxRate');
            var currencySelect = document.getElementById('campostCurrency');
            
            if (rateInput) {
                rateInput.addEventListener('input', function() {
                    var currency = currencySelect ? currencySelect.value : 'XAF';
                    var tempRate = parseInt(this.value) || 0;
                    var tempTax = parseFloat(taxInput.value) / 100 || 0.15;
                    var gross = tempRate * CONFIG.months;
                    var tax = Math.round(gross * tempTax);
                    var net = gross - tax;
                    document.getElementById('calcGross').textContent = fmt(gross) + ' ' + currency;
                    document.getElementById('calcTax').textContent = fmt(tax) + ' ' + currency;
                    document.getElementById('calcNet').textContent = fmt(net) + ' ' + currency;
                });
            }
            if (taxInput) {
                taxInput.addEventListener('input', function() {
                    var currency = currencySelect ? currencySelect.value : 'XAF';
                    var tempRate = parseInt(rateInput.value) || CONFIG.monthlyRate;
                    var tempTax = parseFloat(this.value) / 100 || 0.15;
                    var gross = tempRate * CONFIG.months;
                    var tax = Math.round(gross * tempTax);
                    var net = gross - tax;
                    document.getElementById('calcGross').textContent = fmt(gross) + ' ' + currency;
                    document.getElementById('calcTax').textContent = fmt(tax) + ' ' + currency;
                    document.getElementById('calcNet').textContent = fmt(net) + ' ' + currency;
                });
            }
        }

        var QUARTERS = {
            'Q1': { period: 'January to March', months: 'Jan-Mar', shortPeriod: 'Q1 (Jan-Mar)' },
            'Q2': { period: 'April to June', months: 'Apr-Jun', shortPeriod: 'Q2 (Apr-Jun)' },
            'Q3': { period: 'July to September', months: 'Jul-Sep', shortPeriod: 'Q3 (Jul-Sep)' },
            'Q4': { period: 'October to December', months: 'Oct-Dec', shortPeriod: 'Q4 (Oct-Dec)' }
        };

        var API = window.location.origin + '/api';

        function fmt(n) {
            return n ? Math.abs(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
        }
        
        function getCurrency() {
            var settings = JSON.parse(localStorage.getItem('reSettings') || '{}');
            return settings.currency || 'XAF';
        }
        
        function fmtCurrency(n) {
            return fmt(n) + ' ' + getCurrency();
        }

        function fmtDate(d) {
            return new Date(d).toLocaleDateString();
        }

        function formatDateLong(d) {
            var date = new Date(d);
            var day = date.getDate();
            var suffix = (day === 1 || day === 21 || day === 31) ? 'st' : (day === 2 || day === 22) ? 'nd' : (day === 3 || day === 23) ? 'rd' : 'th';
            var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return day + suffix + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
        }

        function today() {
            return new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function numberToWords(n) {
            var ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            var tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            if (n < 20) return ones[n];
            if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
            if (n < 1000) return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' and ' + numberToWords(n % 100) : '');
            if (n < 1000000) return numberToWords(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 ? ' ' + numberToWords(n % 1000) : '');
            return numberToWords(Math.floor(n / 1000000)) + ' Million' + (n % 1000000 ? ' ' + numberToWords(n % 1000000) : '');
        }

        function showAlert(msg, type) {
            type = type || 'success';
            var el = document.createElement('div');
            el.className = 'alert alert-' + type;
            el.innerHTML = msg;
            document.getElementById('alertBox').appendChild(el);
            setTimeout(function() { el.remove(); }, 2500);
        }

        function api(url, opts) {
            opts = opts || {};
            return fetch(API + url, {
                headers: { 'Content-Type': 'application/json' },
                method: opts.method || 'GET',
                body: opts.body
            }).then(function(res) { return res.json(); });
        }

        // Tabs
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }
        
        // Current active module
        var currentModule = 'landing';

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var page = this.dataset.page;
                if (!page) return; // Skip buttons without data-page (like Home buttons with onclick)
                
                // Update active states within current nav
                var currentNav = this.closest('.nav');
                currentNav.querySelectorAll('.nav-btn').forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                
                // Hide all pages and show selected
                document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
                document.getElementById(page).classList.add('active');
                
                loadPage(page);
            });
        });
        
        // Open a module (CAMPOST or FAMILY)
        function openModule(module) {
            currentModule = module;
            
            // Hide all navs and pages
            document.querySelectorAll('.nav').forEach(function(n) { n.style.display = 'none'; });
            document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
            
            if (module === 'campost') {
                // Show CAMPOST nav and dashboard
                document.getElementById('campostNav').style.display = 'flex';
                document.getElementById('campost-dashboard').classList.add('active');
                document.getElementById('mainTitle').textContent = 'CAMPOST MANKON';
                document.getElementById('mainSubtitle').textContent = 'Property & Billing Management';
                document.querySelector('.logo-icon').textContent = 'CP';
                loadDashboard();
            } else if (module === 'family') {
                // Show FAMILY nav and dashboard
                document.getElementById('familyNav').style.display = 'flex';
                document.getElementById('family-dashboard').classList.add('active');
                document.getElementById('mainTitle').textContent = 'FAMILY REAL ESTATES';
                document.getElementById('mainSubtitle').textContent = 'Property & Rental Management';
                document.querySelector('.logo-icon').textContent = 'FR';
                loadRealEstate();
                loadFamilyDashboardSummary();
            }
        }
        
        // Go back to landing page
        function goToLanding() {
            currentModule = 'landing';
            
            // Hide all navs
            document.querySelectorAll('.nav').forEach(function(n) { n.style.display = 'none'; });
            
            // Show main nav and landing page
            document.getElementById('mainNav').style.display = 'flex';
            document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
            document.getElementById('landing').classList.add('active');
            
            // Reset header
            document.getElementById('mainTitle').textContent = 'NJIKAM SALIFU REAL ESTATE PROPERTIES';
            document.getElementById('mainSubtitle').textContent = 'Property & Billing Management System';
            document.querySelector('.logo-icon').textContent = 'NS';
            
            // Load landing page stats
            loadLandingStats();
        }
        
        // Load landing page statistics
        function loadLandingStats() {
            // CAMPOST stats
            api('/bills').then(function(bills) {
                var campostIncome = 0;
                bills.forEach(function(b) { if (b.paidAmount > 0) campostIncome += b.paidAmount; });
                document.getElementById('landingCampostIncome').textContent = fmt(campostIncome);
                
                api('/expenses').then(function(expenses) {
                    var campostExpenses = 0;
                    expenses.forEach(function(e) { campostExpenses += e.amount; });
                    document.getElementById('landingCampostExpenses').textContent = fmt(campostExpenses);
                    document.getElementById('landingCampostBalance').textContent = fmt(campostIncome - campostExpenses);
                    
                    // Update combined totals
                    updateCombinedTotals();
                });
            });
            
            // Family RE stats
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            
            var familyIncome = 0;
            rePayments.forEach(function(p) { familyIncome += parseFloat(p.amount) || 0; });
            
            var familyExpenses = 0;
            reExpenses.forEach(function(e) { familyExpenses += parseFloat(e.amount) || 0; });
            
            document.getElementById('landingFamilyIncome').textContent = fmt(familyIncome);
            document.getElementById('landingFamilyExpenses').textContent = fmt(familyExpenses);
            document.getElementById('landingFamilyProperties').textContent = properties.length;
            document.getElementById('landingTotalProperties').textContent = properties.length;
        }
        
        function updateCombinedTotals() {
            var campostIncome = parseInt(document.getElementById('landingCampostIncome').textContent.replace(/,/g, '')) || 0;
            var campostExpenses = parseInt(document.getElementById('landingCampostExpenses').textContent.replace(/,/g, '')) || 0;
            var familyIncome = parseInt(document.getElementById('landingFamilyIncome').textContent.replace(/,/g, '')) || 0;
            var familyExpenses = parseInt(document.getElementById('landingFamilyExpenses').textContent.replace(/,/g, '')) || 0;
            
            document.getElementById('landingTotalIncome').textContent = fmt(campostIncome + familyIncome);
            document.getElementById('landingTotalExpenses').textContent = fmt(campostExpenses + familyExpenses);
            document.getElementById('landingTotalBalance').textContent = fmt((campostIncome + familyIncome) - (campostExpenses + familyExpenses));
        }
        
        // Load Family Dashboard Summary
        function loadFamilyDashboardSummary() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');
            var settings = JSON.parse(localStorage.getItem('reSettings') || '{}');
            var reservedPercent = parseFloat(settings.reservedPercent) || 10;
            var currency = settings.currency || 'XAF';
            
            var rentedProps = properties.filter(function(p) { return p.status === 'Rented'; });
            
            var totalIncome = 0;
            rePayments.forEach(function(p) { totalIncome += parseFloat(p.amount) || 0; });
            
            var totalExpenses = 0;
            reExpenses.forEach(function(e) { totalExpenses += parseFloat(e.amount) || 0; });
            
            var reservedFunds = totalIncome * reservedPercent / 100;
            var netBalance = Math.max(0, totalIncome - totalExpenses - reservedFunds);
            
            document.getElementById('familySummaryProps').textContent = properties.length;
            document.getElementById('familySummaryRented').textContent = rentedProps.length;
            document.getElementById('familySummaryIncome').textContent = fmt(Math.round(totalIncome)) + ' ' + currency;
            document.getElementById('familySummaryExpenses').textContent = fmt(Math.round(totalExpenses)) + ' ' + currency;
            document.getElementById('familySummaryReserved').textContent = fmt(Math.round(reservedFunds)) + ' ' + currency;
            document.getElementById('familySummaryBalance').textContent = fmt(Math.round(netBalance)) + ' ' + currency;
        }

        function loadPage(p) {
            // CAMPOST pages
            if (p === 'campost-dashboard') loadDashboard();
            else if (p === 'campost-ledger') loadLedger();
            else if (p === 'campost-expenses') loadExpenses();
            else if (p === 'campost-bills') { loadBills(); updateCalcDisplays(); }
            else if (p === 'campost-payments') loadPayments();
            else if (p === 'campost-inheritance') loadInheritance();
            else if (p === 'campost-settings') { loadSettings(); setupSettingsListeners(); checkDb(); }
            // Family RE pages
            else if (p === 'family-dashboard') { loadRealEstate(); loadFamilyDashboardSummary(); }
            else if (p === 'family-properties') loadRealEstate();
            else if (p === 'family-income') { loadRealEstate(); renderRentalIncomeTable(JSON.parse(localStorage.getItem('familyProperties') || '[]')); }
            else if (p === 'family-bills') loadREBills();
            else if (p === 'family-payments') loadREPayments();
            else if (p === 'family-expenses') loadREExpenses();
            else if (p === 'family-inheritance') loadREInheritance();
            else if (p === 'family-ledger') loadRELedgerFull();
            else if (p === 'family-settings') loadRESettings();
            // Main settings (user management)
            else if (p === 'main-settings') { loadMyAccount(); loadUsersTable(); }
            // Landing
            else if (p === 'landing') loadLandingStats();
        }

        // Dashboard
        // Get CAMPOST settings
        function getCampostSettings() {
            return {
                currency: localStorage.getItem('campostCurrency') || 'XAF',
                reservedPercent: parseFloat(localStorage.getItem('campostReservedPercent')) || 10
            };
        }
        
        function loadDashboard() {
            var settings = getCampostSettings();
            var currency = settings.currency;
            var reservedPercent = settings.reservedPercent;
            
            // Get total income from bills (paid amounts from bills with paid or partial status)
            api('/bills').then(function(bills) {
                var totalIncome = 0;
                bills.forEach(function(b) {
                    // Include paid amount from bills that have any payment (paid or partial)
                    if (b.paidAmount > 0) {
                        totalIncome += b.paidAmount;
                    }
                });
                document.getElementById('dashIncome').textContent = fmt(totalIncome);
                document.getElementById('dashIncomeSum').textContent = fmt(totalIncome) + ' ' + currency;
                
                // Get expenses
                api('/expenses').then(function(expenses) {
                    var totalExpenses = 0;
                    expenses.forEach(function(e) {
                        totalExpenses += e.amount;
                    });
                    document.getElementById('dashExp').textContent = fmt(totalExpenses);
                    document.getElementById('dashExpSum').textContent = fmt(totalExpenses) + ' ' + currency;
                    
                    // Calculate reserved funds = percentage of income
                    var reservedFunds = Math.round(totalIncome * reservedPercent / 100);
                    document.getElementById('dashReserve').textContent = fmt(reservedFunds);
                    document.getElementById('dashReserveSum').textContent = fmt(reservedFunds) + ' ' + currency;
                    document.getElementById('dashReservePercent').textContent = reservedPercent;
                    
                    // Calculate net balance = Income - Expenses - Reserved (minimum 0)
                    var netBalance = Math.max(0, totalIncome - totalExpenses - reservedFunds);
                    document.getElementById('dashNetBalance').textContent = fmt(netBalance);
                    document.getElementById('dashNetBalanceSum').textContent = fmt(netBalance) + ' ' + currency;
                    
                    // Update expense form state
                    updateCampostExpenseFormState(netBalance);
                });
            });
            
            // Get inheritance amount
            api('/inheritance/calculate').then(function(d) {
                document.getElementById('dashInh').textContent = fmt(d.inheritanceAmount);
                document.getElementById('dashInhSum').textContent = fmt(d.inheritanceAmount) + ' ' + currency;
            });
        }
        
        // Enable/Disable CAMPOST expense form based on net balance
        function updateCampostExpenseFormState(netBalance) {
            var expenseFields = ['expDate', 'expDesc', 'expCat', 'expAmt'];
            var saveBtn = document.getElementById('campostSaveExpenseBtn');
            var warningEl = document.getElementById('campostExpenseWarning');
            
            if (netBalance <= 0) {
                // Disable all expense input fields
                expenseFields.forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.disabled = true;
                        el.style.backgroundColor = '#f0f0f0';
                        el.style.cursor = 'not-allowed';
                    }
                });
                
                // Disable save button
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.5';
                    saveBtn.style.cursor = 'not-allowed';
                }
                
                // Show warning message
                if (warningEl) {
                    warningEl.style.display = 'block';
                }
            } else {
                // Enable all expense input fields
                expenseFields.forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.disabled = false;
                        el.style.backgroundColor = '';
                        el.style.cursor = '';
                    }
                });
                
                // Enable save button
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = '';
                }
                
                // Hide warning message
                if (warningEl) {
                    warningEl.style.display = 'none';
                }
            }
        }

        // Ledger - combines income (from bills paid/partial) and expenses
        function loadLedger() {
            Promise.all([api('/bills'), api('/expenses')]).then(function(results) {
                var bills = results[0];
                var expenses = results[1];
                
                // Combine into ledger entries
                var ledgerEntries = [];
                
                // Add bills with payments as income (paid or partial status)
                bills.forEach(function(b) {
                    if (b.paidAmount > 0) {
                        var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                        ledgerEntries.push({
                            date: b.createdAt || new Date().toISOString(),
                            description: 'Bill ' + b.billNumber + ' - ' + b.period + ' ' + b.year + ' (' + status + ')',
                            type: 'Income',
                            income: b.paidAmount,
                            expense: 0,
                            status: status
                        });
                    }
                });
                
                // Add expenses
                expenses.forEach(function(e) {
                    ledgerEntries.push({
                        date: e.date,
                        description: e.description,
                        type: e.categoryName,
                        income: 0,
                        expense: e.amount,
                        category: e.categoryName
                    });
                });
                
                // Sort by date
                ledgerEntries.sort(function(a, b) {
                    return new Date(a.date) - new Date(b.date);
                });
                
                // Calculate running balance and totals
                var runningBalance = 0;
                var totalIncome = 0;
                var totalExpense = 0;
                
                var tableHtml = '';
                ledgerEntries.forEach(function(entry) {
                    if (entry.income > 0) {
                        runningBalance += entry.income;
                        totalIncome += entry.income;
                    }
                    if (entry.expense > 0) {
                        runningBalance -= entry.expense;
                        totalExpense += entry.expense;
                    }
                    
                    var isInheritance = entry.type === 'Inheritance Share';
                    var isIncome = entry.income > 0;
                    tableHtml += '<tr>' +
                        '<td>' + fmtDate(entry.date) + '</td>' +
                        '<td>' + entry.description + '</td>' +
                        '<td><span class="badge ' + (isIncome ? 'badge-income' : isInheritance ? 'badge-inheritance' : 'badge-expense') + '">' + entry.type + (entry.status ? ' (' + entry.status + ')' : '') + '</span></td>' +
                        '<td class="amount-positive">' + (entry.income > 0 ? fmt(entry.income) : '-') + '</td>' +
                        '<td class="' + (isInheritance ? 'amount-gold' : 'amount-negative') + '">' + (entry.expense > 0 ? fmt(entry.expense) : '-') + '</td>' +
                        '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(runningBalance) + '</td>' +
                        '</tr>';
                });
                
                document.getElementById('ledgerTable').innerHTML = tableHtml || '<tr><td colspan="6">No transactions</td></tr>';
                
                // Calculate reserved funds and net balance
                var settings = getCampostSettings();
                var currency = settings.currency;
                var reservedPercent = settings.reservedPercent;
                var reservedFunds = Math.round(totalIncome * reservedPercent / 100);
                var netBalance = Math.max(0, runningBalance - reservedFunds);
                
                // Totals footer with 3 rows
                document.getElementById('ledgerTotals').innerHTML = 
                    '<tr style="background: #f7fafc; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right;">SUBTOTAL (' + currency + '):</td>' +
                    '<td class="amount-positive">' + fmt(totalIncome) + '</td>' +
                    '<td class="amount-negative">' + fmt(totalExpense) + '</td>' +
                    '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(runningBalance) + '</td>' +
                    '</tr>' +
                    '<tr style="background: #fed7d7; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right; color: #c53030;">ğŸ¦ Reserved Funds (' + reservedPercent + '% of Income):</td>' +
                    '<td></td>' +
                    '<td style="color: #c53030;">-' + fmt(reservedFunds) + '</td>' +
                    '<td></td>' +
                    '</tr>' +
                    '<tr style="background: #fc8181; font-weight: bold;">' +
                    '<td colspan="3" style="text-align: right; color: #742a2a;">ğŸ“Š NET BALANCE:</td>' +
                    '<td></td>' +
                    '<td></td>' +
                    '<td style="color: #742a2a;">' + fmt(netBalance) + '</td>' +
                    '</tr>';
                
                // Update stats
                document.getElementById('ledgerIncome').textContent = fmt(totalIncome);
                document.getElementById('ledgerExpense').textContent = fmt(totalExpense);
                document.getElementById('ledgerReserved').textContent = fmt(reservedFunds);
                document.getElementById('ledgerNetBalance').textContent = fmt(netBalance);
            });
        }

        // Expenses
        function loadExpenses() {
            var settings = getCampostSettings();
            var currency = settings.currency;
            
            api('/categories').then(function(cats) {
                document.getElementById('expCat').innerHTML = cats.map(function(c) {
                    return '<option value="' + c.id + '">' + c.name + '</option>';
                }).join('');
            });
            if (!document.getElementById('expDate').value) {
                document.getElementById('expDate').valueAsDate = new Date();
            }
            api('/expenses').then(function(expenses) {
                var totalExp = 0;
                var html = expenses.map(function(e) {
                    var isInh = e.categoryName === 'Inheritance Share';
                    totalExp += e.amount;
                    return '<tr><td>' + fmtDate(e.date) + '</td><td>' + e.description + '</td><td>' + e.categoryName + '</td><td class="' + (isInh ? 'amount-gold' : 'amount-negative') + '">-' + fmt(e.amount) + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editExpense(' + e.id + ')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteExpense(' + e.id + ')">ğŸ—‘ï¸</button></td></tr>';
                }).join('') || '<tr><td colspan="5">No expenses</td></tr>';
                
                document.getElementById('expTable').innerHTML = html;
                
                // Add totals row
                var totalsEl = document.getElementById('expTotals');
                if (totalsEl) {
                    totalsEl.innerHTML = '<tr style="background: #f7fafc; font-weight: bold;">' +
                        '<td colspan="3" style="text-align: right;">TOTAL (' + currency + '):</td>' +
                        '<td class="amount-negative">' + fmt(totalExp) + '</td>' +
                        '<td></td></tr>';
                }
            });
        }

        function editExpense(id) {
            api('/expenses').then(function(expenses) {
                var e = expenses.find(function(x) { return x.id === id; });
                if (e) {
                    document.getElementById('expId').value = id;
                    document.getElementById('expDate').value = e.date.split('T')[0];
                    document.getElementById('expDesc').value = e.description;
                    document.getElementById('expCat').value = e.categoryId;
                    document.getElementById('expAmt').value = e.amount;
                }
            });
        }

        function saveExpense() {
            var id = document.getElementById('expId').value;
            var data = {
                date: document.getElementById('expDate').value,
                description: document.getElementById('expDesc').value,
                categoryId: document.getElementById('expCat').value,
                amount: parseInt(document.getElementById('expAmt').value)
            };
            if (!data.date || !data.description || !data.amount) {
                showAlert('Fill all fields', 'error');
                return;
            }
            
            // Check net balance before saving (only for new expenses)
            if (!id) {
                var settings = getCampostSettings();
                var reservedPercent = settings.reservedPercent;
                
                // Get current totals
                Promise.all([api('/bills'), api('/expenses')]).then(function(results) {
                    var bills = results[0];
                    var expenses = results[1];
                    
                    var totalIncome = 0;
                    bills.forEach(function(b) { if (b.paidAmount > 0) totalIncome += b.paidAmount; });
                    
                    var totalExpenses = 0;
                    expenses.forEach(function(e) { totalExpenses += e.amount; });
                    
                    var reservedFunds = Math.round(totalIncome * reservedPercent / 100);
                    var currentNetBalance = totalIncome - totalExpenses - reservedFunds;
                    
                    if (currentNetBalance <= 0) {
                        showAlert('Cannot add expense: Net Balance is zero. Add more income first.', 'error');
                        return;
                    }
                    
                    if (data.amount > currentNetBalance) {
                        showAlert('Cannot add expense: Amount (' + fmt(data.amount) + ') exceeds available Net Balance (' + fmt(currentNetBalance) + ')', 'error');
                        return;
                    }
                    
                    // Proceed with save
                    doSaveExpense(null, data);
                });
            } else {
                // Editing existing expense - just save
                doSaveExpense(id, data);
            }
        }
        
        function doSaveExpense(id, data) {
            var url = id ? '/expenses/' + id : '/expenses';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                showAlert(id ? 'Updated!' : 'Saved!');
                clearExpenseForm();
                loadExpenses();
                loadDashboard();
            });
        }

        function deleteExpense(id) {
            if (!confirm('Delete?')) return;
            api('/expenses/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadExpenses();
            });
        }

        function clearExpenseForm() {
            document.getElementById('expId').value = '';
            document.getElementById('expDesc').value = '';
            document.getElementById('expAmt').value = '';
        }

        // Bills
        function loadBills() {
            var yearSel = document.getElementById('billY');
            if (yearSel.options.length === 0) {
                for (var y = 2022; y <= 2035; y++) {
                    yearSel.innerHTML += '<option value="' + y + '">' + y + '</option>';
                }
                yearSel.value = new Date().getFullYear();
            }
            updateBillNumber();
            api('/bills').then(function(bills) {
                document.getElementById('billTable').innerHTML = bills.map(function(b) {
                    return '<tr class="clickable" onclick="viewBill(\'' + b.billNumber + '\')"><td><strong>' + b.billNumber + '</strong>' + (b.isNew ? ' <span class="badge badge-new">NEW</span>' : '') + '</td><td>' + b.period + ' ' + b.year + '</td><td>' + fmt(b.amountDue) + '</td><td class="amount-positive">' + fmt(b.paidAmount) + '</td><td class="' + (b.outstanding > 0 ? 'amount-negative' : '') + '">' + fmt(b.outstanding) + '</td><td><span class="badge badge-' + (b.outstanding === 0 ? 'paid' : b.paidAmount > 0 ? 'partial' : 'unpaid') + '">' + (b.outstanding === 0 ? 'Paid' : b.paidAmount > 0 ? 'Partial' : 'Unpaid') + '</span></td><td class="no-print" onclick="event.stopPropagation()"><button class="btn btn-warning btn-sm" onclick="editBill(\'' + b.billNumber + '\')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteBill(\'' + b.billNumber + '\')">ğŸ—‘ï¸</button></td></tr>';
                }).join('');
            });
        }

        function updateBillNumber() {
            var q = document.getElementById('billQ').value;
            var y = document.getElementById('billY').value;
            var n = q === 'Q1' ? 1 : q === 'Q2' ? 2 : q === 'Q3' ? 3 : 4;
            document.getElementById('billNum').value = q + '-' + y + '-00' + n;
        }

        document.getElementById('billQ').addEventListener('change', updateBillNumber);
        document.getElementById('billY').addEventListener('change', updateBillNumber);

        function editBill(bn) {
            api('/bills').then(function(bills) {
                var b = bills.find(function(x) { return x.billNumber === bn; });
                if (b) {
                    document.getElementById('billEditMode').value = 'edit';
                    document.getElementById('billOldNumber').value = bn;
                    document.getElementById('billQ').value = b.quarter;
                    document.getElementById('billY').value = b.year;
                    document.getElementById('billP').value = b.period;
                    updateBillNumber();
                    updateCalcDisplays();
                }
            });
        }

        function saveBill() {
            var em = document.getElementById('billEditMode').value;
            var old = document.getElementById('billOldNumber').value;
            var q = document.getElementById('billQ').value;
            var y = parseInt(document.getElementById('billY').value);
            var p = document.getElementById('billP').value;
            var calc = calcAmounts();
            var amountDue = calc.net; // Use calculated net amount from CONFIG
            var bn = document.getElementById('billNum').value;

            if (em === 'edit') {
                api('/bills/' + old, { method: 'PUT', body: JSON.stringify({ quarter: q, year: y, period: p, amountDue: amountDue }) }).then(function() {
                    showAlert('Updated!');
                    clearBillForm();
                    loadBills();
                    loadDashboard();
                });
            } else {
                api('/bills', { method: 'POST', body: JSON.stringify({ billNumber: bn, quarter: q, year: y, period: p, amountDue: amountDue, paidAmount: 0, outstanding: amountDue, isNew: true }) }).then(function() {
                    showAlert('Created!');
                    clearBillForm();
                    loadBills();
                    loadDashboard();
                });
            }
        }

        function deleteBill(bn) {
            if (!confirm('Delete ' + bn + '?')) return;
            api('/bills/' + bn, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadBills();
                loadDashboard();
            });
        }

        function clearBillForm() {
            document.getElementById('billEditMode').value = '';
            document.getElementById('billOldNumber').value = '';
            document.getElementById('billY').value = new Date().getFullYear();
            updateBillNumber();
            updateCalcDisplays();
        }

        // View Bill as Invoice
        function viewBill(bn) {
            api('/bills/' + bn).then(function(b) {
                var rate = CONFIG.monthlyRate; // Monthly rate from settings
                var grossAmount = rate * CONFIG.months; // Quarterly gross
                var taxPercent = Math.round(CONFIG.taxRate * 100); // Tax percentage for display
                var taxAmount = Math.round(grossAmount * CONFIG.taxRate); // Tax amount
                var netAmount = grossAmount - taxAmount; // Net amount due per quarter
                var advancePayment = b.paidAmount;
                var totalDue = netAmount - advancePayment; // Outstanding after payments
                var qInfo = QUARTERS[b.quarter] || { months: b.period };
                var paymentNum = b.quarter === 'Q1' ? 1 : b.quarter === 'Q2' ? 2 : b.quarter === 'Q3' ? 3 : 4;
                var billDate = b.createdAt ? formatDateLong(b.createdAt) : formatDateLong(new Date());

                var invoiceHtml = '<div id="invoicePrint" style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto;">' +
                    '<div style="text-align: center; background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0;">' +
                        '<h1 style="margin: 0; font-size: 24px;">GHOUENZEN Soulemanou</h1>' +
                        '<p style="margin: 5px 0 0; font-size: 14px;">B.P 36 Mankon-Bamenda</p>' +
                        '<p style="margin: 3px 0 0; font-size: 14px;">Tel: 675299868</p>' +
                        '<p style="margin: 3px 0 0; font-size: 12px;">Account No. ' + CONFIG.accountNo + '</p>' +
                    '</div>' +
                    '<div style="border: 1px solid #ddd; border-top: none; padding: 20px;">' +
                        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                            '<tr style="background: #2c5282; color: white;"><td colspan="4" style="padding: 8px; text-align: center; font-weight: bold;">BILLING PERIOD SELECTION</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 25%;">Billing Period:</td><td colspan="3" style="padding: 8px; border: 1px solid #ddd;">' + b.period + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Year:</td><td style="padding: 8px; border: 1px solid #ddd;">' + b.year + '</td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Quarter:</td><td style="padding: 8px; border: 1px solid #ddd; background: #2c5282; color: white; text-align: center;">' + b.quarter + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Payment Number:</td><td style="padding: 8px; border: 1px solid #ddd;">' + paymentNum + '</td><td colspan="2"></td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Bill Date:</td><td colspan="3" style="padding: 8px; border: 1px solid #ddd;">' + billDate + '</td></tr>' +
                        '</table>' +
                        '<div style="background: #38a169; color: white; text-align: center; padding: 8px; font-weight: bold;">GENERATED BILL NUMBER</div>' +
                        '<div style="background: #c6f6d5; text-align: center; padding: 15px; font-size: 22px; font-weight: bold; color: #276749; border: 2px solid #38a169;">BILL NO.' + b.billNumber + '</div>' +
                        '<div style="margin: 20px 0; font-style: italic;">' +
                            '<p><strong>The General Manager,</strong></p>' +
                            '<p>Cameroon Postal Services</p>' +
                            '<p>B.P 1441 YaoundÃ©.</p>' +
                        '</div>' +
                        '<p style="margin: 20px 0;"><strong>Sir,</strong></p>' +
                        '<p style="margin-bottom: 20px;">In accordance with the contract de bail No.00000/9/MTP/G10 of 18th April 1991, I hereby present the rent bill for period of:</p>' +
                        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                            '<tr style="background: #2c5282; color: white;"><td colspan="2" style="padding: 10px; text-align: center; font-weight: bold;">BILL DETAILS</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 35%;">Bill Date</td><td style="padding: 8px; border: 1px solid #ddd;">' + billDate + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Tenant Name</td><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">CAMPOST MANKON</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Property Address</td><td style="padding: 8px; border: 1px solid #ddd;">B.P 36 Mankon-Bamenda</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Bill Number</td><td style="padding: 8px; border: 1px solid #ddd; background: #ebf8ff; color: #2c5282; font-weight: bold;">' + b.billNumber + '</td></tr>' +
                        '</table>' +
                        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">' +
                            '<tr style="background: #d69e2e; color: white;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Description</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Qty (months)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Rate (XAF)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Amount (XAF)</th></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd;">Rent for ' + b.quarter + ' (' + qInfo.months + ')</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">' + CONFIG.months + '</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + fmt(rate) + '</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + fmt(grossAmount) + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd;">Less ' + taxPercent + '% Tax</td><td style="padding: 8px; border: 1px solid #ddd;"></td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">' + taxPercent + '%</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #e53e3e;">-' + fmt(taxAmount) + '</td></tr>' +
                            '<tr style="background: #f7fafc;"><td colspan="3" style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">Net Amount (After Tax)</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: bold;">' + fmt(netAmount) + '</td></tr>' +
                            '<tr><td style="padding: 8px; border: 1px solid #ddd;">Less Advance Payment</td><td colspan="2" style="padding: 8px; border: 1px solid #ddd;"></td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #38a169;">-' + fmt(advancePayment) + '</td></tr>' +
                            '<tr style="background: #2c5282; color: white;"><td colspan="3" style="padding: 10px; font-weight: bold; text-align: center;">TOTAL AMOUNT DUE</td><td style="padding: 10px; text-align: right; font-weight: bold; font-size: 18px;">' + fmt(totalDue) + '</td></tr>' +
                        '</table>' +
                        '<p style="text-align: center; color: #e53e3e; font-style: italic; font-weight: bold;">(' + numberToWords(netAmount) + ' francs CFA.)</p>' +
                        '<div style="margin-top: 40px;">' +
                            '<p><strong>Signature:</strong></p>' +
                            '<div style="margin-top: 10px; border-bottom: 1px solid #333; width: 200px; height: 50px;"></div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="btn-group no-print" style="margin-top: 15px;">' +
                    '<button class="btn btn-primary" onclick="printInvoice()">ğŸ–¨ï¸ Print Invoice</button>' +
                    '<button class="btn btn-outline" onclick="closeBillModal()">Close</button>' +
                '</div>';

                document.getElementById('billModalBody').innerHTML = invoiceHtml;
                document.getElementById('billModal').classList.add('active');
            });
        }

        function closeBillModal() {
            document.getElementById('billModal').classList.remove('active');
        }

        function printInvoice() {
            var content = document.getElementById('invoicePrint').innerHTML;
            var w = window.open('', '_blank');
            w.document.write('<html><head><title>Rent Invoice</title><style>body{font-family:Arial,sans-serif;padding:20px;margin:0;}table{width:100%;border-collapse:collapse;}td,th{padding:8px;border:1px solid #ddd;}@media print{body{padding:10px;}}</style></head><body>' + content + '</body></html>');
            w.document.close();
            w.print();
        }

        // Payments
        function loadPayments() {
            api('/bills').then(function(bills) {
                document.getElementById('payBill').innerHTML = '<option value="">-- Select --</option>' + bills.map(function(b) {
                    return '<option value="' + b.billNumber + '">' + b.billNumber + ' - ' + b.period + ' ' + b.year + ' (' + fmt(b.outstanding) + ' due)</option>';
                }).join('');
            });
            if (!document.getElementById('payDate').value) {
                document.getElementById('payDate').valueAsDate = new Date();
            }
            api('/payments').then(function(payments) {
                document.getElementById('payTable').innerHTML = payments.map(function(p) {
                    return '<tr><td>' + fmtDate(p.date) + '</td><td>' + p.billNumber + '</td><td>' + p.period + ' ' + p.year + '</td><td class="amount-positive">+' + fmt(p.amount) + '</td><td>' + (p.reference || '-') + '</td><td class="no-print"><button class="btn btn-warning btn-sm" onclick="editPayment(' + p.id + ')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deletePayment(' + p.id + ')">ğŸ—‘ï¸</button></td></tr>';
                }).join('') || '<tr><td colspan="6">No payments</td></tr>';
            });
        }

        document.getElementById('payBill').addEventListener('change', function() {
            var bn = this.value;
            if (bn) {
                api('/bills').then(function(bills) {
                    var b = bills.find(function(x) { return x.billNumber === bn; });
                    if (b) document.getElementById('payOut').value = fmt(b.outstanding) + ' XAF';
                });
            }
        });

        function editPayment(id) {
            api('/payments/' + id).then(function(p) {
                document.getElementById('payId').value = id;
                document.getElementById('payBill').value = p.billNumber;
                document.getElementById('payAmt').value = p.amount;
                document.getElementById('payDate').value = p.date.split('T')[0];
                document.getElementById('payRef').value = p.reference || '';
            });
        }

        function savePayment() {
            var id = document.getElementById('payId').value;
            var data = {
                billNumber: document.getElementById('payBill').value,
                amount: parseInt(document.getElementById('payAmt').value),
                date: document.getElementById('payDate').value,
                reference: document.getElementById('payRef').value
            };
            if (!data.billNumber || !data.amount) {
                showAlert('Fill required fields', 'error');
                return;
            }
            var url = id ? '/payments/' + id : '/payments';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                showAlert(id ? 'Updated!' : 'Saved!');
                clearPaymentForm();
                loadPayments();
                loadBills();
                loadDashboard();
            });
        }

        function deletePayment(id) {
            if (!confirm('Delete?')) return;
            api('/payments/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadPayments();
                loadBills();
                loadDashboard();
            });
        }

        function clearPaymentForm() {
            document.getElementById('payId').value = '';
            document.getElementById('payBill').value = '';
            document.getElementById('payOut').value = '';
            document.getElementById('payAmt').value = '';
            document.getElementById('payRef').value = '';
        }

        // Inheritance
        function loadInheritance() {
            // First load all heirs for the beneficiary selection
            api('/heirs').then(function(allHeirs) {
                loadCampostBeneficiaryList(allHeirs);
                
                // Get selected beneficiaries
                var selectedIds = getCampostBeneficiaries();
                
                // Calculate inheritance only for selected beneficiaries
                api('/inheritance/calculate').then(function(d) {
                    // Filter heirs to only include selected beneficiaries
                    var beneficiaries = d.heirs.filter(function(h) {
                        return selectedIds.length === 0 || selectedIds.includes(h.id);
                    });
                    
                    // Recalculate totals for beneficiaries only
                    var totalPortions = beneficiaries.reduce(function(sum, h) { return sum + parseFloat(h.portions); }, 0);
                    var sharePerPortion = totalPortions > 0 ? d.inheritanceAmount / totalPortions : 0;
                    
                    // Calculate group summary for beneficiaries
                    var groupSummary = {};
                    beneficiaries.forEach(function(h) {
                        if (!groupSummary[h.heir_group]) {
                            groupSummary[h.heir_group] = { count: 0, totalPortions: 0, totalShare: 0 };
                        }
                        groupSummary[h.heir_group].count++;
                        groupSummary[h.heir_group].totalPortions += parseFloat(h.portions);
                        groupSummary[h.heir_group].totalShare += parseFloat(h.portions) * sharePerPortion;
                    });
                    
                    document.getElementById('inhAmt').textContent = fmt(d.inheritanceAmount) + ' XAF';
                    document.getElementById('inhPaid').textContent = fmt(d.totalBillsPaid);
                    document.getElementById('inhExp').textContent = fmt(d.totalExpenses);
                    document.getElementById('inhRes').textContent = fmt(d.reserveFunds);
                    document.getElementById('inhPortions').textContent = totalPortions;
                    document.getElementById('inhPer').textContent = fmt(Math.round(sharePerPortion));

                    var html = '';
                    for (var g in groupSummary) {
                        var i = groupSummary[g];
                        html += '<div class="heir-group"><h4>' + g + ' <span>' + i.count + '</span></h4><div class="summary-row"><span>Per heir:</span><span>' + fmt(Math.round(i.totalShare / i.count)) + ' XAF</span></div><div class="summary-row"><span>Total:</span><span>' + fmt(Math.round(i.totalShare)) + ' XAF</span></div></div>';
                    }
                    document.getElementById('heirGroups').innerHTML = html || '<p>No beneficiaries selected</p>';

                    var isAdmin = currentUser && currentUser.role === 'admin';
                    document.getElementById('heirTable').innerHTML = beneficiaries.map(function(h) {
                        var share = parseFloat(h.portions) * sharePerPortion;
                        var actionsHtml = isAdmin ? '<td class="no-print"><button class="btn btn-gold btn-sm" onclick="printHeirCertificate(' + h.id + ')">ğŸ“œ</button> <button class="btn btn-warning btn-sm" onclick="editHeir(' + h.id + ')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteHeir(' + h.id + ')">ğŸ—‘ï¸</button></td>' : '';
                        return '<tr><td>' + h.name + '</td><td>' + h.relationship + '</td><td>' + h.heir_group + '</td><td>' + h.portions + '</td><td class="amount-positive">' + fmt(Math.round(share)) + '</td>' + actionsHtml + '</tr>';
                    }).join('') || '<tr><td colspan="6">No beneficiaries selected</td></tr>';
                });
            });
        }
        
        // Load CAMPOST beneficiary selection list
        function loadCampostBeneficiaryList(heirs) {
            var selectedIds = getCampostBeneficiaries();
            var html = heirs.map(function(h) {
                var isSelected = selectedIds.length === 0 || selectedIds.includes(h.id);
                return '<div class="beneficiary-item ' + (isSelected ? 'selected' : '') + '">' +
                    '<input type="checkbox" id="campost-ben-' + h.id + '" ' + (isSelected ? 'checked' : '') + ' onchange="toggleCampostBeneficiary(' + h.id + ', this.checked)">' +
                    '<label for="campost-ben-' + h.id + '">' + h.name + '</label>' +
                    '<span class="heir-info">' + h.relationship + '</span>' +
                    '<span class="heir-portions">' + h.portions + ' portions</span>' +
                '</div>';
            }).join('');
            document.getElementById('campostBeneficiaryList').innerHTML = html || '<p>No heirs available</p>';
        }
        
        // Get selected CAMPOST beneficiaries from localStorage
        function getCampostBeneficiaries() {
            var stored = localStorage.getItem('campostBeneficiaries');
            return stored ? JSON.parse(stored) : [];
        }
        
        // Toggle CAMPOST beneficiary selection
        function toggleCampostBeneficiary(id, checked) {
            var el = document.querySelector('#campost-ben-' + id).closest('.beneficiary-item');
            if (checked) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
        }
        
        // Select/Deselect all CAMPOST beneficiaries
        function selectAllCampostBeneficiaries(selectAll) {
            var checkboxes = document.querySelectorAll('#campostBeneficiaryList input[type="checkbox"]');
            checkboxes.forEach(function(cb) {
                cb.checked = selectAll;
                var el = cb.closest('.beneficiary-item');
                if (selectAll) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
        }
        
        // Save CAMPOST beneficiary selection
        function saveCampostBeneficiaries() {
            var checkboxes = document.querySelectorAll('#campostBeneficiaryList input[type="checkbox"]:checked');
            var selectedIds = Array.from(checkboxes).map(function(cb) {
                return parseInt(cb.id.replace('campost-ben-', ''));
            });
            localStorage.setItem('campostBeneficiaries', JSON.stringify(selectedIds));
            showAlert('Beneficiary selection saved!');
            loadInheritance();
        }
        
        // Reset CAMPOST heirs to default family members
        function resetCampostHeirsToDefaults() {
            if (!confirm('This will delete all current heirs and reset to the default 16 family members. Continue?')) return;
            
            api('/heirs/reset-defaults', { method: 'POST' }).then(function(result) {
                if (result.success) {
                    // Clear beneficiary selection to include all
                    localStorage.removeItem('campostBeneficiaries');
                    showAlert('Heirs reset to default family members (' + result.count + ' heirs)');
                    loadInheritance();
                } else {
                    showAlert('Error resetting heirs', 'error');
                }
            }).catch(function(err) {
                showAlert('Error: ' + err.message, 'error');
            });
        }

        function openHeirModal() { document.getElementById('heirModal').classList.add('active'); }
        function closeHeirModal() {
            document.getElementById('heirModal').classList.remove('active');
            document.getElementById('heirId').value = '';
            document.getElementById('heirName').value = '';
        }

        function editHeir(id) {
            api('/heirs').then(function(heirs) {
                var h = heirs.find(function(x) { return x.id === id; });
                if (h) {
                    document.getElementById('heirId').value = id;
                    document.getElementById('heirName').value = h.name;
                    document.getElementById('heirRel').value = h.relationship;
                    document.getElementById('heirGrp').value = h.heir_group;
                    document.getElementById('heirPor').value = h.portions;
                    openHeirModal();
                }
            });
        }

        function saveHeir() {
            var id = document.getElementById('heirId').value;
            var data = {
                name: document.getElementById('heirName').value,
                relationship: document.getElementById('heirRel').value,
                heirGroup: document.getElementById('heirGrp').value,
                portions: parseFloat(document.getElementById('heirPor').value)
            };
            if (!data.name) { showAlert('Enter name', 'error'); return; }
            var url = id ? '/heirs/' + id : '/heirs';
            var method = id ? 'PUT' : 'POST';
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                showAlert(id ? 'Updated!' : 'Added!');
                closeHeirModal();
                loadInheritance();
            });
        }

        function deleteHeir(id) {
            if (!confirm('Delete?')) return;
            api('/heirs/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Deleted');
                loadInheritance();
            });
        }

        // Heir Certificates
        function printHeirCertificate(heirId) {
            api('/inheritance/calculate').then(function(d) {
                var h = d.heirs.find(function(x) { return x.id === heirId; });
                if (!h) { showAlert('Heir not found', 'error'); return; }
                var certHtml = generateCertificateHTML(h, d);
                var w = window.open('', '_blank');
                w.document.write(certHtml);
                w.document.close();
                w.print();
            });
        }

        function printAllHeirCertificates() {
            api('/inheritance/calculate').then(function(d) {
                if (d.heirs.length === 0) { showAlert('No heirs', 'error'); return; }
                var allCerts = '<html><head><title>Certificates</title><style>@page{size:A5;margin:10mm;}body{font-family:Georgia,serif;margin:0;padding:0;}.certificate{page-break-after:always;padding:15mm;border:3px double #1a365d;margin:5mm;}.certificate:last-child{page-break-after:auto;}.cert-header{text-align:center;border-bottom:2px solid #d69e2e;padding-bottom:10px;margin-bottom:15px;}.cert-header h1{color:#1a365d;font-size:20px;margin:0;}.heir-name{text-align:center;font-size:24px;color:#1a365d;font-weight:bold;margin:20px 0;padding:10px;background:linear-gradient(135deg,rgba(214,158,46,0.1),rgba(237,137,54,0.1));border-radius:8px;}.cert-details{margin:15px 0;}.detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dotted #ccc;}.share-amount{text-align:center;margin:20px 0;padding:15px;background:#1a365d;color:white;border-radius:8px;}.share-amount strong{font-size:28px;color:#d69e2e;}.signature-line{margin-top:30px;display:flex;justify-content:space-between;}.sig-block{text-align:center;width:40%;}.sig-line{border-top:1px solid #333;margin-top:40px;padding-top:5px;}</style></head><body>';
                d.heirs.forEach(function(h) { allCerts += generateCertificateBody(h, d); });
                allCerts += '</body></html>';
                var w = window.open('', '_blank');
                w.document.write(allCerts);
                w.document.close();
                w.print();
            });
        }

        function generateCertificateHTML(h, d) {
            return '<html><head><title>Certificate - ' + h.name + '</title><style>body{font-family:Georgia,serif;margin:0;padding:20mm;}.certificate{padding:20mm;border:3px double #1a365d;}.cert-header{text-align:center;border-bottom:2px solid #d69e2e;padding-bottom:15px;margin-bottom:20px;}.cert-header h1{color:#1a365d;font-size:24px;margin:0;}.heir-name{text-align:center;font-size:28px;color:#1a365d;font-weight:bold;margin:25px 0;padding:15px;background:linear-gradient(135deg,rgba(214,158,46,0.1),rgba(237,137,54,0.1));border-radius:10px;}.cert-details{margin:20px 0;}.detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dotted #ccc;}.share-amount{text-align:center;margin:25px 0;padding:20px;background:#1a365d;color:white;border-radius:10px;}.share-amount strong{font-size:32px;color:#d69e2e;}.signature-line{margin-top:40px;display:flex;justify-content:space-between;}.sig-block{text-align:center;width:40%;}.sig-line{border-top:1px solid #333;margin-top:50px;padding-top:5px;}</style></head><body>' + generateCertificateBody(h, d) + '</body></html>';
        }

        function generateCertificateBody(h, d) {
            return '<div class="certificate"><div class="cert-header"><h1>CAMPOST MANKON</h1><p style="color:#666;font-size:12px;">GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868</p></div><div style="text-align:center;margin:15px 0;"><h2 style="color:#d69e2e;font-size:18px;">ğŸ“œ INHERITANCE SHARE CERTIFICATE</h2></div><p style="text-align:center;color:#666;font-size:12px;">This certifies that the following heir is entitled to receive their share:</p><div class="heir-name">' + h.name + '</div><div class="cert-details"><div class="detail-row"><span>Relationship:</span><span style="font-weight:bold;">' + h.relationship + '</span></div><div class="detail-row"><span>Heir Group:</span><span style="font-weight:bold;">' + h.heir_group + '</span></div><div class="detail-row"><span>Portions:</span><span style="font-weight:bold;">' + h.portions + ' of ' + d.totalPortions + '</span></div><div class="detail-row"><span>Total Distribution:</span><span style="font-weight:bold;">' + fmt(d.inheritanceAmount) + ' XAF</span></div><div class="detail-row"><span>Per Portion:</span><span style="font-weight:bold;">' + fmt(d.sharePerPortion) + ' XAF</span></div></div><div class="share-amount"><p style="margin:0 0 5px;opacity:0.8;">ENTITLED SHARE AMOUNT</p><strong>' + fmt(Math.round(h.shareAmount)) + ' XAF</strong></div><div class="signature-line"><div class="sig-block"><div class="sig-line">Authorized Signature</div></div><div class="sig-block"><div class="sig-line">Heir Signature</div></div></div><p style="text-align:center;margin-top:20px;font-size:10px;color:#666;">Generated on ' + today() + '</p></div>';
        }

        // Export functions
        function exportCSV(type) {
            var h = 'CAMPOST MANKON - GHOUENZEN Soulemanou\nB.P 36 Mankon-Bamenda | Tel: 675299868\n\n';
            if (type === 'bills') {
                api('/bills').then(function(d) {
                    var csv = h + 'Bill Number,Quarter,Period,Year,Due,Paid,Outstanding,Status\n';
                    d.forEach(function(b) { csv += b.billNumber + ',' + b.quarter + ',' + b.period + ',' + b.year + ',' + b.amountDue + ',' + b.paidAmount + ',' + b.outstanding + ',' + (b.outstanding === 0 ? 'Paid' : 'Outstanding') + '\n'; });
                    download(csv, 'campost_bills.csv');
                });
            } else if (type === 'payments') {
                api('/payments').then(function(d) {
                    var csv = h + 'Date,Bill,Period,Year,Amount,Reference\n';
                    d.forEach(function(p) { csv += p.date + ',' + p.billNumber + ',' + p.period + ',' + p.year + ',' + p.amount + ',"' + (p.reference || '') + '"\n'; });
                    download(csv, 'campost_payments.csv');
                });
            } else if (type === 'expenses') {
                api('/expenses').then(function(d) {
                    var csv = h + 'Date,Description,Category,Amount\n';
                    d.forEach(function(e) { csv += e.date + ',"' + e.description + '",' + e.categoryName + ',' + e.amount + '\n'; });
                    download(csv, 'campost_expenses.csv');
                });
            } else if (type === 'ledger') {
                Promise.all([api('/bills'), api('/expenses')]).then(function(results) {
                    var bills = results[0];
                    var expenses = results[1];
                    var csv = h + 'Date,Description,Type,Status,Income,Expense,Balance\n';
                    
                    var ledgerEntries = [];
                    // Add bills with payments (paid or partial)
                    bills.forEach(function(b) {
                        if (b.paidAmount > 0) {
                            var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                            ledgerEntries.push({ 
                                date: b.createdAt || new Date().toISOString(), 
                                description: 'Bill ' + b.billNumber + ' - ' + b.period + ' ' + b.year, 
                                type: 'Income', 
                                status: status,
                                income: b.paidAmount, 
                                expense: 0 
                            });
                        }
                    });
                    expenses.forEach(function(e) {
                        ledgerEntries.push({ date: e.date, description: e.description, type: e.categoryName, status: '', income: 0, expense: e.amount });
                    });
                    ledgerEntries.sort(function(a, b) { return new Date(a.date) - new Date(b.date); });
                    
                    var balance = 0;
                    ledgerEntries.forEach(function(entry) {
                        balance += entry.income - entry.expense;
                        csv += (entry.date ? entry.date.split('T')[0] : '') + ',"' + entry.description + '",' + entry.type + ',' + entry.status + ',' + entry.income + ',' + entry.expense + ',' + balance + '\n';
                    });
                    download(csv, 'campost_ledger.csv');
                });
            }
        }

        function exportAllCSV() {
            api('/export/all').then(function(all) {
                var csv = 'CAMPOST MANKON - GHOUENZEN Soulemanou\nB.P 36 Mankon-Bamenda | Tel: 675299868\n';
                csv += '\nSUMMARY\nTotal Bills Paid: ' + all.summary.totalBillsPaid + '\nTotal Expenses: ' + all.summary.totalExpenses + '\nReserve Funds: ' + all.summary.reserveFunds + '\n';
                csv += '\n\nBILLS\nBill Number,Period,Year,Amount Due,Paid,Outstanding\n';
                all.bills.forEach(function(b) { csv += b.bill_number + ',' + b.period + ',' + b.year + ',' + b.amount_due + ',' + b.paid_amount + ',' + b.outstanding + '\n'; });
                csv += '\n\nPAYMENTS\nDate,Bill,Amount,Reference\n';
                all.payments.forEach(function(p) { csv += p.payment_date + ',' + p.bill_number + ',' + p.amount + ',"' + (p.reference || '') + '"\n'; });
                csv += '\n\nEXPENSES\nDate,Description,Category,Amount\n';
                all.expenses.forEach(function(e) { csv += e.expense_date + ',"' + e.description + '",' + e.category_name + ',' + e.amount + '\n'; });
                csv += '\n\nHEIRS\nName,Relationship,Group,Portions\n';
                all.heirs.forEach(function(h) { csv += h.name + ',' + h.relationship + ',' + h.heir_group + ',' + h.portions + '\n'; });
                download(csv, 'campost_all_data.csv');
            });
        }

        function exportPDF(type) {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('CAMPOST MANKON', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868', 105, 22, { align: 'center' });
            doc.line(20, 25, 190, 25);

            if (type === 'bills') {
                api('/bills').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('BILLS REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Bill #', 'Period', 'Year', 'Due', 'Paid', 'Outstanding']], body: d.map(function(b) { return [b.billNumber, b.period, b.year, fmt(b.amountDue), fmt(b.paidAmount), fmt(b.outstanding)]; }), styles: { fontSize: 8 } });
                    doc.save('campost_bills.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'payments') {
                api('/payments').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PAYMENTS REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Date', 'Bill #', 'Period', 'Amount', 'Reference']], body: d.map(function(p) { return [fmtDate(p.date), p.billNumber, p.period + ' ' + p.year, fmt(p.amount), p.reference || '-']; }), styles: { fontSize: 8 } });
                    doc.save('campost_payments.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'expenses') {
                api('/expenses').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('EXPENSES REPORT', 105, 35, { align: 'center' });
                    doc.autoTable({ startY: 40, head: [['Date', 'Description', 'Category', 'Amount']], body: d.map(function(e) { return [fmtDate(e.date), e.description.substring(0, 35), e.categoryName, fmt(e.amount)]; }), styles: { fontSize: 8 } });
                    doc.save('campost_expenses.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'ledger') {
                Promise.all([api('/bills'), api('/expenses')]).then(function(results) {
                    var bills = results[0];
                    var expenses = results[1];
                    
                    // Build ledger entries from bills with payments
                    var ledgerEntries = [];
                    bills.forEach(function(b) {
                        if (b.paidAmount > 0) {
                            var status = b.outstanding === 0 ? 'Paid' : 'Partial';
                            ledgerEntries.push({
                                date: b.createdAt || new Date().toISOString(),
                                description: b.billNumber + ' - ' + b.period + ' ' + b.year,
                                type: 'Income (' + status + ')',
                                income: b.paidAmount,
                                expense: 0
                            });
                        }
                    });
                    expenses.forEach(function(e) {
                        ledgerEntries.push({
                            date: e.date,
                            description: e.description.substring(0, 30),
                            type: e.categoryName,
                            income: 0,
                            expense: e.amount
                        });
                    });
                    
                    // Sort by date
                    ledgerEntries.sort(function(a, b) {
                        return new Date(a.date) - new Date(b.date);
                    });
                    
                    // Calculate running balance
                    var runningBalance = 0;
                    var totalIncome = 0;
                    var totalExpense = 0;
                    var tableData = ledgerEntries.map(function(entry) {
                        if (entry.income > 0) {
                            runningBalance += entry.income;
                            totalIncome += entry.income;
                        }
                        if (entry.expense > 0) {
                            runningBalance -= entry.expense;
                            totalExpense += entry.expense;
                        }
                        return [
                            fmtDate(entry.date),
                            entry.description,
                            entry.type,
                            entry.income > 0 ? fmt(entry.income) : '-',
                            entry.expense > 0 ? fmt(entry.expense) : '-',
                            fmt(runningBalance)
                        ];
                    });
                    
                    // Add totals row
                    tableData.push(['', '', 'TOTALS:', fmt(totalIncome), fmt(totalExpense), fmt(runningBalance)]);
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('LEDGER REPORT', 105, 35, { align: 'center' });
                    doc.setFontSize(9);
                    doc.text('Total Income: ' + fmt(totalIncome) + ' XAF | Total Expenses: ' + fmt(totalExpense) + ' XAF | Balance: ' + fmt(runningBalance) + ' XAF', 105, 42, { align: 'center' });
                    doc.autoTable({ 
                        startY: 48, 
                        head: [['Date', 'Description', 'Type', 'Income', 'Expense', 'Balance']], 
                        body: tableData, 
                        styles: { fontSize: 7 },
                        headStyles: { fillColor: [44, 82, 130] },
                        footStyles: { fillColor: [247, 250, 252], textColor: [0, 0, 0], fontStyle: 'bold' }
                    });
                    doc.save('campost_ledger.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'heirs') {
                api('/inheritance/calculate').then(function(d) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('INHERITANCE REPORT', 105, 35, { align: 'center' });
                    doc.setFontSize(10);
                    doc.text('Amount: ' + fmt(d.inheritanceAmount) + ' XAF | Per Portion: ' + fmt(d.sharePerPortion) + ' XAF', 105, 42, { align: 'center' });
                    doc.autoTable({ startY: 48, head: [['Name', 'Relationship', 'Group', 'Portions', 'Share']], body: d.heirs.map(function(h) { return [h.name, h.relationship, h.heir_group, h.portions, fmt(Math.round(h.shareAmount))]; }), styles: { fontSize: 8 } });
                    doc.save('campost_heirs.pdf');
                    showAlert('PDF exported!');
                });
            } else if (type === 'properties') {
                var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('FAMILY REAL ESTATE PORTFOLIO', 105, 35, { align: 'center' });
                doc.setFontSize(9);
                doc.text('Total Properties: ' + properties.length + ' | Rented: ' + properties.filter(function(p) { return p.status === 'Rented'; }).length, 105, 42, { align: 'center' });
                doc.autoTable({ 
                    startY: 48, 
                    head: [['Property', 'Location', 'Type', 'Status', 'Income', 'Islamic Inh.']], 
                    body: properties.map(function(p) { 
                        return [p.name, p.location, p.type, p.status, p.status === 'Rented' ? fmt(p.rent_amount) : '0', p.islamic_inheritance || 'NA']; 
                    }), 
                    styles: { fontSize: 7 },
                    headStyles: { fillColor: [44, 82, 130] }
                });
                doc.save('family_properties.pdf');
                showAlert('PDF exported!');
            } else if (type === 'rentalIncome') {
                var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
                var rentedProps = properties.filter(function(p) { return p.status === 'Rented'; });
                var totalGross = 0, totalTax = 0, totalNet = 0;
                
                var tableData = rentedProps.map(function(p) {
                    var rent = parseFloat(p.rent_amount) || 0;
                    var taxRate = parseFloat(p.tax_rate) || 0;
                    var taxAmt = rent * taxRate / 100;
                    var net = rent - taxAmt;
                    totalGross += rent;
                    totalTax += taxAmt;
                    totalNet += net;
                    return [p.name, p.location, fmt(rent), p.rent_period || 'Monthly', taxRate + '%', fmt(Math.round(taxAmt)), fmt(Math.round(net))];
                });
                tableData.push(['', '', 'TOTALS:', '', '', fmt(Math.round(totalTax)), fmt(Math.round(totalNet))]);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('RENTAL INCOME REPORT', 105, 35, { align: 'center' });
                doc.setFontSize(9);
                doc.text('Gross: ' + fmt(Math.round(totalGross)) + ' XAF | Tax: ' + fmt(Math.round(totalTax)) + ' XAF | Net: ' + fmt(Math.round(totalNet)) + ' XAF', 105, 42, { align: 'center' });
                doc.autoTable({ 
                    startY: 48, 
                    head: [['Property', 'Location', 'Rent', 'Period', 'Tax Rate', 'Tax Amount', 'Net Income']], 
                    body: tableData, 
                    styles: { fontSize: 7 },
                    headStyles: { fillColor: [214, 158, 46] }
                });
                doc.save('rental_income.pdf');
                showAlert('PDF exported!');
            } else if (type === 'reLedger') {
                var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
                var rentedProps = properties.filter(function(p) { return p.status === 'Rented'; });
                var totalIncome = 0;
                
                var tableData = rentedProps.map(function(p) {
                    var rent = parseFloat(p.rent_amount) || 0;
                    var taxRate = parseFloat(p.tax_rate) || 0;
                    var net = rent - (rent * taxRate / 100);
                    totalIncome += net;
                    return [fmtDate(new Date()), p.name, 'Rental Income (' + (p.rent_period || 'Monthly') + ')', 'Income', fmt(Math.round(net)), '-', fmt(Math.round(totalIncome))];
                });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('REAL ESTATE LEDGER', 105, 35, { align: 'center' });
                doc.autoTable({ 
                    startY: 42, 
                    head: [['Date', 'Property', 'Description', 'Type', 'Income', 'Expense', 'Balance']], 
                    body: tableData, 
                    styles: { fontSize: 7 },
                    headStyles: { fillColor: [44, 82, 130] }
                });
                doc.save('real_estate_ledger.pdf');
                showAlert('PDF exported!');
            }
        }

        function exportAllPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            Promise.all([api('/export/all'), api('/inheritance/calculate')]).then(function(results) {
                var all = results[0];
                var inh = results[1];
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('CAMPOST MANKON', 105, 15, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('GHOUENZEN Soulemanou | B.P 36 Mankon-Bamenda | Tel: 675299868', 105, 22, { align: 'center' });
                doc.line(20, 25, 190, 25);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('FINANCIAL SUMMARY', 20, 33);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Bills Paid: ' + fmt(all.summary.totalBillsPaid) + ' | Expenses: ' + fmt(all.summary.totalExpenses) + ' | Reserve: ' + fmt(all.summary.reserveFunds), 20, 40);
                doc.text('BILLS', 20, 50);
                doc.autoTable({ startY: 53, head: [['Bill #', 'Period', 'Year', 'Due', 'Paid', 'Outstanding']], body: all.bills.map(function(b) { return [b.bill_number, b.period, b.year, fmt(b.amount_due), fmt(b.paid_amount), fmt(b.outstanding)]; }), styles: { fontSize: 7 } });
                doc.addPage();
                doc.setFont('helvetica', 'bold');
                doc.text('PAYMENTS', 20, 15);
                doc.autoTable({ startY: 18, head: [['Date', 'Bill', 'Amount', 'Reference']], body: all.payments.map(function(p) { return [p.payment_date ? p.payment_date.split('T')[0] : '', p.bill_number, fmt(p.amount), p.reference || '']; }), styles: { fontSize: 7 } });
                var y = doc.lastAutoTable.finalY + 10;
                doc.text('EXPENSES', 20, y);
                doc.autoTable({ startY: y + 3, head: [['Date', 'Description', 'Category', 'Amount']], body: all.expenses.map(function(e) { return [e.expense_date ? e.expense_date.split('T')[0] : '', e.description ? e.description.substring(0, 25) : '', e.category_name || '', fmt(e.amount)]; }), styles: { fontSize: 7 } });
                doc.addPage();
                doc.text('INHERITANCE (' + fmt(inh.inheritanceAmount) + ' XAF)', 20, 15);
                doc.autoTable({ startY: 20, head: [['Name', 'Relationship', 'Group', 'Portions', 'Share']], body: inh.heirs.map(function(h) { return [h.name, h.relationship, h.heir_group, h.portions, fmt(Math.round(h.shareAmount))]; }), styles: { fontSize: 7 } });
                doc.save('campost_complete_report.pdf');
                showAlert('Complete PDF exported!');
            });
        }

        function download(content, filename) {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content], { type: 'text/csv' }));
            a.download = filename;
            a.click();
            showAlert('Exported!');
        }

        function printPage(pageId) {
            document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('printing'); });
            document.getElementById(pageId).classList.add('printing');
            window.print();
        }

        // Settings
        function checkDb() {
            api('/status').then(function(s) {
                document.getElementById('dbStatus').textContent = s.connected ? 'âœ“ Connected' : 'âœ— Offline';
                document.getElementById('dbStatus').className = 'db-status ' + (s.connected ? 'connected' : 'disconnected');
                document.getElementById('settingsAlert').className = 'alert alert-' + (s.connected ? 'success' : 'error');
                document.getElementById('settingsAlert').innerHTML = s.connected ? 'âœ“ PostgreSQL Connected' : 'âœ— Offline';
            }).catch(function() {
                document.getElementById('dbStatus').textContent = 'âœ— Offline';
                document.getElementById('dbStatus').className = 'db-status disconnected';
            });
        }

        function resetAll() {
            if (!confirm('RESET ALL DATA?')) return;
            api('/reset', { method: 'POST' }).then(function() {
                showAlert('Data reset!');
                loadDashboard();
            });
        }

        // ==========================================
        // FAMILY REAL ESTATES MODULE
        // ==========================================

        // Show RE Tab
        function showRETab(tabId, btn) {
            document.querySelectorAll('#realestate .tab-content').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('#realestate .tab-btn').forEach(function(b) { b.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            
            // Load data for specific tabs to populate dropdowns
            if (tabId === 'reBillsTab') {
                loadREBills();
            } else if (tabId === 'rePaymentsTab') {
                loadREPayments();
            } else if (tabId === 'reExpensesTab') {
                loadREExpenses();
            } else if (tabId === 'reInheritanceTab') {
                loadREInheritance();
            } else if (tabId === 'reLedgerTab') {
                loadRELedgerFull();
            } else if (tabId === 'reSettingsTab') {
                loadRESettings();
            }
        }

        // Load Real Estate Data
        function loadRealEstate() {
            api('/re/dashboard').then(function(data) {
                document.getElementById('reTotalProps').textContent = data.totalProperties;
                document.getElementById('reRented').textContent = data.rentedProperties;
                document.getElementById('reTotalIncome').textContent = fmt(Math.round(data.totalIncome));
                document.getElementById('reTotalExpenses').textContent = fmt(Math.round(data.totalExpenses));
                document.getElementById('reReservedFunds').textContent = fmt(Math.round(data.reservedFunds));
                document.getElementById('reNetBalance').textContent = fmt(Math.round(data.netBalance));
                
                // Check if expenses should be disabled
                updateExpenseFormState(data.netBalance);
            });
            
            // Load properties for table
            api('/properties').then(function(properties) {
                renderPropertiesTable(properties);
                renderRentalIncomeTable(properties);
            });
            
            // Also load tab-specific data
            loadREBills();
            loadREPayments();
            loadREExpenses();
        }
        
        // Enable/Disable expense form based on net balance
        function updateExpenseFormState(netBalance) {
            var expenseFields = [
                'reExpProperty',
                'reExpDate', 
                'reExpCategory',
                'reExpAmount',
                'reExpDesc'
            ];
            var saveBtn = document.querySelector('#reExpensesTab .btn-success');
            var warningEl = document.getElementById('expenseWarning');
            
            if (netBalance <= 0) {
                // Disable all expense input fields
                expenseFields.forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.disabled = true;
                        el.style.backgroundColor = '#f0f0f0';
                        el.style.cursor = 'not-allowed';
                    }
                });
                
                // Disable save button
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.5';
                    saveBtn.style.cursor = 'not-allowed';
                }
                
                // Show warning message
                if (warningEl) {
                    warningEl.style.display = 'block';
                }
            } else {
                // Enable all expense input fields
                expenseFields.forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.disabled = false;
                        el.style.backgroundColor = '';
                        el.style.cursor = '';
                    }
                });
                
                // Enable save button
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = '';
                }
                
                // Hide warning message
                if (warningEl) {
                    warningEl.style.display = 'none';
                }
            }
        }

        // Render Properties Table - show ALL properties with zeros for non-rented
        function renderPropertiesTable(properties) {
            var filterStatus = document.getElementById('reStatusFilter').value;
            var filtered = filterStatus ? properties.filter(function(p) { return p.status === filterStatus; }) : properties;
            var isAdmin = currentUser && currentUser.role === 'admin';

            var html = filtered.map(function(p) {
                var isRented = p.status === 'Rented';
                var statusClass = isRented ? 'badge-income' : p.status === 'Sold' ? 'badge-paid' : p.status === 'For sale' ? 'badge-new' : 'badge-expense';
                
                // Non-rented: all financial fields are 0
                var rentAmount = isRented ? (parseFloat(p.rent_amount) || 0) : 0;
                var period = isRented ? (p.rent_period || 'Monthly') : '-';
                var taxRate = isRented ? (parseFloat(p.tax_rate) || 0) : 0;
                var taxAmount = rentAmount * taxRate / 100;
                var netIncome = rentAmount - taxAmount;

                var actionsHtml = isAdmin ? 
                    '<td class="no-print">' +
                        '<button class="btn btn-warning btn-sm" onclick="editProperty(' + p.id + ')">âœï¸</button> ' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteProperty(' + p.id + ')">ğŸ—‘ï¸</button>' +
                    '</td>' : '';

                return '<tr>' +
                    '<td><strong>' + p.name + '</strong></td>' +
                    '<td>' + p.location + '</td>' +
                    '<td>' + p.type + '</td>' +
                    '<td><span class="badge ' + statusClass + '">' + p.status + '</span></td>' +
                    '<td>' + fmt(rentAmount) + '</td>' +
                    '<td>' + period + '</td>' +
                    '<td>' + taxRate + '%</td>' +
                    '<td class="' + (netIncome > 0 ? 'amount-positive' : '') + '">' + fmt(Math.round(netIncome)) + '</td>' +
                    '<td>' + (p.islamic_inheritance || 'NA') + '</td>' +
                    actionsHtml +
                '</tr>';
            }).join('');

            document.getElementById('propertiesTable').innerHTML = html || '<tr><td colspan="' + (isAdmin ? '10' : '9') + '">No properties found</td></tr>';
        }

        // Render Rental Income Table - show ALL properties with zeros for non-rented
        function renderRentalIncomeTable(properties) {
            var totalGross = 0;
            var totalTax = 0;
            var totalNet = 0;
            var currency = getCurrency();

            var html = properties.map(function(p) {
                var isRented = p.status === 'Rented';
                
                // Non-rented: all zeros
                var rent = isRented ? (parseFloat(p.rent_amount) || 0) : 0;
                var taxRate = isRented ? (parseFloat(p.tax_rate) || 0) : 0;
                var period = isRented ? (p.rent_period || 'Monthly') : '-';
                var taxAmount = rent * taxRate / 100;
                var netIncome = rent - taxAmount;

                totalGross += rent;
                totalTax += taxAmount;
                totalNet += netIncome;

                var statusClass = isRented ? 'badge-income' : 'badge-expense';

                return '<tr>' +
                    '<td><strong>' + p.name + '</strong></td>' +
                    '<td>' + p.location + '</td>' +
                    '<td><span class="badge ' + statusClass + '">' + p.status + '</span></td>' +
                    '<td>' + fmt(rent) + '</td>' +
                    '<td>' + period + '</td>' +
                    '<td>' + taxRate + '%</td>' +
                    '<td>' + fmt(rent) + '</td>' +
                    '<td class="' + (taxAmount > 0 ? 'amount-negative' : '') + '">' + (taxAmount > 0 ? '-' : '') + fmt(Math.round(taxAmount)) + '</td>' +
                    '<td class="' + (netIncome > 0 ? 'amount-positive' : '') + '">' + fmt(Math.round(netIncome)) + '</td>' +
                '</tr>';
            }).join('');

            document.getElementById('rentalIncomeTable').innerHTML = html || '<tr><td colspan="9">No properties</td></tr>';
            
            document.getElementById('rentalIncomeTotals').innerHTML = 
                '<tr style="background: #f7fafc; font-weight: bold;">' +
                '<td colspan="6" style="text-align: right;">TOTALS (' + currency + '):</td>' +
                '<td>' + fmt(Math.round(totalGross)) + '</td>' +
                '<td class="amount-negative">-' + fmt(Math.round(totalTax)) + '</td>' +
                '<td class="amount-positive">' + fmt(Math.round(totalNet)) + '</td>' +
                '</tr>';
        }

        // Filter Properties
        function filterProperties() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            renderPropertiesTable(properties);
        }

        // Toggle Rental Fields - non-rented properties have zeros
        function toggleRentalFields() {
            var status = document.getElementById('propStatus').value;
            var rentalFields = document.getElementById('rentalFields');
            var isRented = status === 'Rented';
            
            if (isRented) {
                rentalFields.style.display = 'block';
            } else {
                rentalFields.style.display = 'none';
                // Set all to zero for non-rented
                document.getElementById('propRentAmount').value = 0;
                document.getElementById('propTaxRate').value = '0';
            }
            updatePropertyCalc();
        }

        // Update Property Calculation - respects rented status
        function updatePropertyCalc() {
            var status = document.getElementById('propStatus').value;
            var isRented = status === 'Rented';
            
            var rent = isRented ? (parseFloat(document.getElementById('propRentAmount').value) || 0) : 0;
            var taxRate = isRented ? (parseFloat(document.getElementById('propTaxRate').value) || 0) : 0;
            var taxAmount = rent * taxRate / 100;
            var netIncome = rent - taxAmount;

            document.getElementById('propGrossRent').textContent = fmt(rent) + ' XAF';
            document.getElementById('propTaxAmount').textContent = '-' + fmt(Math.round(taxAmount)) + ' XAF';
            document.getElementById('propNetIncome').textContent = fmt(Math.round(netIncome)) + ' XAF';
        }

        // Open Property Modal
        function openPropertyModal() {
            // Get global default settings
            var settings = JSON.parse(localStorage.getItem('reSettings') || '{}');
            var defaultTaxRate = settings.taxRate || '15';
            var defaultPeriod = settings.period || 'Monthly';
            
            document.getElementById('propertyModalTitle').textContent = 'ğŸ  Add Property';
            document.getElementById('propId').value = '';
            document.getElementById('propName').value = '';
            document.getElementById('propLocation').value = '';
            document.getElementById('propType').value = 'Residential';
            document.getElementById('propStatus').value = 'Rented';
            document.getElementById('propRentAmount').value = 0;
            document.getElementById('propRentPeriod').value = defaultPeriod;
            document.getElementById('propTaxRate').value = defaultTaxRate;
            document.getElementById('propInheritance').value = 'Yes';
            document.getElementById('propNotes').value = '';
            toggleRentalFields();
            document.getElementById('propertyModal').classList.add('active');
        }

        function closePropertyModal() {
            document.getElementById('propertyModal').classList.remove('active');
        }

        // Edit Property - loads zeros for non-rented
        function editProperty(id) {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var p = properties.find(function(x) { return x.id === id; });
            if (p) {
                var isRented = p.status === 'Rented';
                document.getElementById('propertyModalTitle').textContent = 'ğŸ  Edit Property';
                document.getElementById('propId').value = p.id;
                document.getElementById('propName').value = p.name;
                document.getElementById('propLocation').value = p.location;
                document.getElementById('propType').value = p.type;
                document.getElementById('propStatus').value = p.status;
                document.getElementById('propRentAmount').value = isRented ? (p.rent_amount || 0) : 0;
                document.getElementById('propRentPeriod').value = p.rent_period || 'Monthly';
                document.getElementById('propTaxRate').value = isRented ? (p.tax_rate || '15') : '0';
                document.getElementById('propInheritance').value = p.islamic_inheritance || 'Yes';
                document.getElementById('propNotes').value = p.notes || '';
                toggleRentalFields();
                document.getElementById('propertyModal').classList.add('active');
            }
        }

        // Save Property
        function saveProperty() {
            var id = document.getElementById('propId').value;
            var name = document.getElementById('propName').value;
            var location = document.getElementById('propLocation').value;
            var type = document.getElementById('propType').value;
            var status = document.getElementById('propStatus').value;
            
            // Non-rented properties: all financial fields are 0
            var isRented = status === 'Rented';
            var rentAmount = isRented ? (parseFloat(document.getElementById('propRentAmount').value) || 0) : 0;
            var rentPeriod = isRented ? document.getElementById('propRentPeriod').value : 'Monthly';
            var taxRate = isRented ? (parseFloat(document.getElementById('propTaxRate').value) || 0) : 0;
            var inheritance = document.getElementById('propInheritance').value;
            var notes = document.getElementById('propNotes').value;

            if (!name || !location) {
                showAlert('Please fill required fields', 'error');
                return;
            }

            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');

            if (id) {
                // Update existing
                var idx = properties.findIndex(function(p) { return p.id === parseInt(id); });
                if (idx !== -1) {
                    properties[idx] = {
                        id: parseInt(id),
                        name: name,
                        location: location,
                        type: type,
                        status: status,
                        rent_amount: rentAmount,
                        rent_period: rentPeriod,
                        tax_rate: taxRate,
                        islamic_inheritance: inheritance,
                        notes: notes,
                        updated_at: new Date().toISOString()
                    };
                }
            } else {
                // Add new
                var newId = properties.length > 0 ? Math.max.apply(null, properties.map(function(p) { return p.id; })) + 1 : 1;
                properties.push({
                    id: newId,
                    name: name,
                    location: location,
                    type: type,
                    status: status,
                    rent_amount: rentAmount,
                    rent_period: rentPeriod,
                    tax_rate: taxRate,
                    islamic_inheritance: inheritance,
                    notes: notes,
                    created_at: new Date().toISOString()
                });
            }

            localStorage.setItem('familyProperties', JSON.stringify(properties));
            closePropertyModal();
            showAlert(id ? 'Property updated!' : 'Property added!');
            loadRealEstate();
        }

        // Delete Property
        function deleteProperty(id) {
            if (!confirm('Delete this property?')) return;
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            properties = properties.filter(function(p) { return p.id !== id; });
            localStorage.setItem('familyProperties', JSON.stringify(properties));
            showAlert('Property deleted');
            loadRealEstate();
        }

        // ========== RE BILLS ==========
        function loadREBills() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var rentedProps = properties.filter(function(p) { return p.status === 'Rented'; });
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var currency = getCurrency();

            // Populate property dropdown with rented properties only, showing period and tax
            document.getElementById('reBillProperty').innerHTML = '<option value="">Select Rented Property</option>' + 
                rentedProps.map(function(p) {
                    var taxRate = parseFloat(p.tax_rate) || 0;
                    var grossRent = parseFloat(p.rent_amount) || 0;
                    var netRent = grossRent - (grossRent * taxRate / 100);
                    return '<option value="' + p.id + '" data-period="' + (p.rent_period || 'Monthly') + '" data-rent="' + grossRent + '" data-taxrate="' + taxRate + '">' + 
                        p.name + ' (' + (p.rent_period || 'Monthly') + ' | Gross: ' + fmt(grossRent) + ' | Tax: ' + taxRate + '% | Net: ' + fmt(Math.round(netRent)) + ' ' + currency + ')</option>'; 
                }).join('');

            if (!document.getElementById('reBillDate').value) {
                document.getElementById('reBillDate').valueAsDate = new Date();
            }

            var totalGross = 0, totalTax = 0, totalNet = 0, totalPaid = 0, totalOutstanding = 0;

            var html = reBills.map(function(b) {
                var prop = properties.find(function(p) { return p.id === b.property_id; });
                var status = b.outstanding === 0 ? 'Paid' : b.paid_amount > 0 ? 'Partial' : 'Unpaid';
                var statusClass = status === 'Paid' ? 'badge-paid' : status === 'Partial' ? 'badge-new' : 'badge-unpaid';
                
                // Get tax info
                var grossAmount = parseFloat(b.gross_amount) || parseFloat(b.amount_due) || 0;
                var taxRate = parseFloat(b.tax_rate) || (prop ? parseFloat(prop.tax_rate) : 0) || 0;
                var taxAmount = parseFloat(b.tax_amount) || (grossAmount * taxRate / 100);
                var netAmount = parseFloat(b.amount_due) || (grossAmount - taxAmount);
                
                totalGross += grossAmount;
                totalTax += taxAmount;
                totalNet += netAmount;
                totalPaid += parseFloat(b.paid_amount) || 0;
                totalOutstanding += parseFloat(b.outstanding) || 0;
                
                return '<tr>' +
                    '<td><strong>' + b.bill_number + '</strong></td>' +
                    '<td>' + (prop ? prop.name : 'N/A') + '</td>' +
                    '<td>' + b.period + '</td>' +
                    '<td>' + b.year + '</td>' +
                    '<td>' + fmt(Math.round(grossAmount)) + '</td>' +
                    '<td class="amount-negative">' + fmt(Math.round(taxAmount)) + ' (' + taxRate + '%)</td>' +
                    '<td><strong>' + fmt(Math.round(netAmount)) + '</strong></td>' +
                    '<td class="amount-positive">' + fmt(b.paid_amount || 0) + '</td>' +
                    '<td class="' + (b.outstanding > 0 ? 'amount-negative' : '') + '">' + fmt(b.outstanding || 0) + '</td>' +
                    '<td><span class="badge ' + statusClass + '">' + status + '</span></td>' +
                    '<td class="no-print"><button class="btn btn-warning btn-sm" onclick="editREBill(' + b.id + ')">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteREBill(' + b.id + ')">ğŸ—‘ï¸</button></td>' +
                '</tr>';
            }).join('');

            document.getElementById('reBillsTable').innerHTML = html || '<tr><td colspan="11">No bills</td></tr>';
            
            // Add totals row
            document.getElementById('reBillsTotals').innerHTML = 
                '<tr style="background: #f7fafc; font-weight: bold;">' +
                '<td colspan="4" style="text-align: right;">TOTALS (' + currency + '):</td>' +
                '<td>' + fmt(Math.round(totalGross)) + '</td>' +
                '<td class="amount-negative">' + fmt(Math.round(totalTax)) + '</td>' +
                '<td>' + fmt(Math.round(totalNet)) + '</td>' +
                '<td class="amount-positive">' + fmt(Math.round(totalPaid)) + '</td>' +
                '<td class="amount-negative">' + fmt(Math.round(totalOutstanding)) + '</td>' +
                '<td colspan="2"></td>' +
                '</tr>';
        }

        // Auto-populate period, amount, and tax when property is selected
        function onREPropertySelect() {
            var select = document.getElementById('reBillProperty');
            var selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                var period = selectedOption.getAttribute('data-period') || 'Monthly';
                var grossRent = parseFloat(selectedOption.getAttribute('data-rent')) || 0;
                var taxRate = parseFloat(selectedOption.getAttribute('data-taxrate')) || 0;
                
                var taxAmount = grossRent * taxRate / 100;
                var netAmount = grossRent - taxAmount;
                
                document.getElementById('reBillPeriod').value = period;
                document.getElementById('reBillGrossAmount').value = grossRent;
                document.getElementById('reBillTaxRate').value = taxRate + '%';
                document.getElementById('reBillTaxAmount').value = fmt(Math.round(taxAmount));
                document.getElementById('reBillAmount').value = fmt(Math.round(netAmount));
            } else {
                document.getElementById('reBillPeriod').value = '';
                document.getElementById('reBillGrossAmount').value = '';
                document.getElementById('reBillTaxRate').value = '0%';
                document.getElementById('reBillTaxAmount').value = '0';
                document.getElementById('reBillAmount').value = '0';
            }
        }
        
        // Calculate net bill amount when gross changes
        function calculateBillNet() {
            var grossAmount = parseFloat(document.getElementById('reBillGrossAmount').value) || 0;
            var taxRateStr = document.getElementById('reBillTaxRate').value;
            var taxRate = parseFloat(taxRateStr.replace('%', '')) || 0;
            
            var taxAmount = grossAmount * taxRate / 100;
            var netAmount = grossAmount - taxAmount;
            
            document.getElementById('reBillTaxAmount').value = fmt(Math.round(taxAmount));
            document.getElementById('reBillAmount').value = fmt(Math.round(netAmount));
        }

        function saveREBill() {
            var id = document.getElementById('reBillId').value;
            var propertyId = parseInt(document.getElementById('reBillProperty').value);
            var tenantName = document.getElementById('reBillTenant') ? document.getElementById('reBillTenant').value : 'Tenant';
            var billDate = document.getElementById('reBillDate').value;
            var dueDate = document.getElementById('reBillDueDate') ? document.getElementById('reBillDueDate').value : billDate;
            var amount = parseFloat(document.getElementById('reBillAmount').value) || parseFloat(document.getElementById('reBillGrossAmount').value) || 0;
            var notes = document.getElementById('reBillDesc').value;

            if (!propertyId || !amount) { showAlert('Please select property and enter amount', 'error'); return; }

            var data = {
                propertyId: propertyId,
                tenantName: tenantName || 'Tenant',
                billDate: billDate,
                dueDate: dueDate || billDate,
                amount: amount,
                status: 'Unpaid',
                notes: notes
            };

            var url = id ? '/re/bills/' + id : '/re/bills';
            var method = id ? 'PUT' : 'POST';
            
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                clearREBillForm();
                showAlert(id ? 'Bill updated!' : 'Bill created!');
                loadREBills();
                loadRealEstate();
            });
        }

        function clearREBillForm() { 
            document.getElementById('reBillId').value = ''; 
            document.getElementById('reBillProperty').value = ''; 
            if (document.getElementById('reBillPeriod')) document.getElementById('reBillPeriod').value = ''; 
            if (document.getElementById('reBillGrossAmount')) document.getElementById('reBillGrossAmount').value = '';
            if (document.getElementById('reBillTaxRate')) document.getElementById('reBillTaxRate').value = '0%';
            if (document.getElementById('reBillTaxAmount')) document.getElementById('reBillTaxAmount').value = '0';
            if (document.getElementById('reBillAmount')) document.getElementById('reBillAmount').value = '0'; 
            document.getElementById('reBillDesc').value = ''; 
        }

        function editREBill(id) {
            api('/re/bills').then(function(reBills) {
                var b = reBills.find(function(x) { return x.id === id; });
            if (b) { 
                var prop = properties.find(function(p) { return p.id === b.property_id; });
                var taxRate = b.tax_rate || (prop ? parseFloat(prop.tax_rate) : 0) || 0;
                var grossAmount = b.gross_amount || (b.amount_due / (1 - taxRate/100)) || b.amount_due;
                var taxAmount = b.tax_amount || (grossAmount * taxRate / 100);
                
                document.getElementById('reBillId').value = b.id; 
                document.getElementById('reBillProperty').value = b.property_id; 
                document.getElementById('reBillDate').value = b.bill_date; 
                document.getElementById('reBillPeriod').value = b.period; 
                document.getElementById('reBillYear').value = b.year;
                document.getElementById('reBillGrossAmount').value = Math.round(grossAmount);
                document.getElementById('reBillTaxRate').value = taxRate + '%';
                document.getElementById('reBillTaxAmount').value = fmt(Math.round(taxAmount));
                document.getElementById('reBillAmount').value = fmt(Math.round(b.amount_due)); 
                document.getElementById('reBillDesc').value = b.description || ''; 
            }
        }

        function deleteREBill(id) { 
            if (!confirm('Delete this bill?')) return; 
            api('/re/bills/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Bill deleted'); 
                loadREBills();
                loadRealEstate();
            });
        }

        // ========== RE PAYMENTS ==========
        function loadREPayments() {
            var currency = getCurrency();

            // Populate Select Bill dropdown from Bills section (only unpaid/partial bills)
            api('/re/bills').then(function(reBills) {
                var unpaidBills = reBills.filter(function(b) { return b.status !== 'Paid'; });
                document.getElementById('rePayBill').innerHTML = '<option value="">Select Bill to Pay</option>' + 
                    unpaidBills.map(function(b) { 
                        return '<option value="' + b.id + '" data-amount="' + b.amount + '">' + 
                            'BILL-' + b.id + ' | ' + (b.property_name || 'N/A') + ' | Amount: ' + fmt(b.amount) + ' ' + currency + ' (' + b.status + ')' + 
                        '</option>'; 
                    }).join('');
            });

            if (!document.getElementById('rePayDate').value) { 
                document.getElementById('rePayDate').valueAsDate = new Date(); 
            }

            api('/re/payments').then(function(rePayments) {
                var totalAmount = 0;
                
                var html = rePayments.map(function(p) { 
                    var amount = parseFloat(p.amount) || 0;
                    totalAmount += amount;
                    
                    return '<tr>' +
                        '<td>' + fmtDate(p.payment_date) + '</td>' +
                        '<td>' + (p.property_name || 'N/A') + '</td>' +
                        '<td>BILL-' + (p.bill_id || 'N/A') + '</td>' +
                        '<td class="amount-positive"><strong>' + fmt(Math.round(amount)) + '</strong></td>' +
                        '<td>' + (p.reference || '-') + '</td>' +
                        '<td class="no-print"><button class="btn btn-danger btn-sm" onclick="deleteREPayment(' + p.id + ')">ğŸ—‘ï¸</button></td>' +
                    '</tr>'; 
                }).join('');

                document.getElementById('rePaymentsTable').innerHTML = html || '<tr><td colspan="6">No payments</td></tr>';
                
                // Add totals row
                if (document.getElementById('rePaymentsTotals')) {
                    document.getElementById('rePaymentsTotals').innerHTML = 
                        '<tr style="background: #f7fafc; font-weight: bold;">' +
                        '<td colspan="3" style="text-align: right;">TOTAL (' + currency + '):</td>' +
                        '<td class="amount-positive">' + fmt(Math.round(totalAmount)) + '</td>' +
                        '<td colspan="2"></td>' +
                        '</tr>';
                }
            });
        }

        // Auto-populate amount when bill is selected
        function onREBillSelect() {
            var select = document.getElementById('rePayBill');
            var selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                var amount = parseFloat(selectedOption.getAttribute('data-amount')) || 0;
                document.getElementById('rePayAmount').value = amount;
            } else {
                document.getElementById('rePayAmount').value = '';
            }
        }

        function saveREPayment() {
            var billId = parseInt(document.getElementById('rePayBill').value);
            var payDate = document.getElementById('rePayDate').value;
            var amount = parseFloat(document.getElementById('rePayAmount').value) || 0;
            var reference = document.getElementById('rePayRef').value;

            if (!billId || !amount) { showAlert('Please fill required fields', 'error'); return; }

            api('/re/payments', {
                method: 'POST',
                body: JSON.stringify({
                    billId: billId,
                    amount: amount,
                    paymentDate: payDate,
                    paymentMethod: 'Cash',
                    reference: reference
                })
            }).then(function() {
                clearREPaymentForm();
                showAlert('Payment recorded!');
                loadREPayments();
                loadREBills();
                loadRealEstate();
            });
        }

        function clearREPaymentForm() { 
            if (document.getElementById('rePayId')) document.getElementById('rePayId').value = ''; 
            document.getElementById('rePayBill').value = ''; 
            document.getElementById('rePayAmount').value = ''; 
            document.getElementById('rePayRef').value = ''; 
        }

        function deleteREPayment(id) {
            if (!confirm('Delete this payment?')) return;
            api('/re/payments/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Payment deleted');
                loadREPayments();
                loadREBills();
                loadRealEstate();
            });
        }

        // ========== RE EXPENSES ==========
        function loadREExpenses() {
            var currency = getCurrency();

            // Populate property dropdown with all properties
            api('/properties').then(function(properties) {
                var propOptions = properties.map(function(p) { 
                    return '<option value="' + p.id + '">' + p.name + ' (' + p.status + ' - ' + p.location + ')</option>'; 
                }).join('');
                document.getElementById('reExpProperty').innerHTML = '<option value="">Select Property (Optional)</option>' + propOptions;
            });

            if (!document.getElementById('reExpDate').value) { 
                document.getElementById('reExpDate').valueAsDate = new Date(); 
            }

            api('/re/expenses').then(function(reExpenses) {
                var totalExpenses = 0;
                var html = reExpenses.map(function(e) { 
                    var isInh = e.category === 'Inheritance Share';
                    totalExpenses += parseFloat(e.amount) || 0;
                    return '<tr>' +
                        '<td>' + fmtDate(e.expense_date) + '</td>' +
                        '<td>' + (e.property_name || 'General') + '</td>' +
                        '<td>' + e.category + '</td>' +
                        '<td>' + e.description + '</td>' +
                        '<td class="' + (isInh ? 'amount-gold' : 'amount-negative') + '">-' + fmt(e.amount) + '</td>' +
                        '<td class="no-print">' +
                            '<button class="btn btn-warning btn-sm" onclick="editREExpense(' + e.id + ')">âœï¸</button> ' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteREExpense(' + e.id + ')">ğŸ—‘ï¸</button>' +
                        '</td>' +
                    '</tr>'; 
                }).join('');

                document.getElementById('reExpensesTable').innerHTML = html || '<tr><td colspan="6">No expenses</td></tr>';
                
                // Update expenses total if element exists
                var expTotalEl = document.getElementById('reExpensesTotal');
                if (expTotalEl) {
                    expTotalEl.innerHTML = '<tr style="background: #f7fafc; font-weight: bold;"><td colspan="4" style="text-align: right;">TOTAL (' + currency + '):</td><td class="amount-negative">-' + fmt(Math.round(totalExpenses)) + '</td><td></td></tr>';
                }
            });
        }

        function saveREExpense() {
            var id = document.getElementById('reExpId').value;
            var propertyId = document.getElementById('reExpProperty').value;
            propertyId = propertyId ? parseInt(propertyId) : null;
            var expDate = document.getElementById('reExpDate').value;
            var category = document.getElementById('reExpCategory').value;
            var amount = parseFloat(document.getElementById('reExpAmount').value) || 0;
            var desc = document.getElementById('reExpDesc').value.trim();

            // Validate required fields
            if (!expDate) { 
                showAlert('Please select a date', 'error'); 
                return; 
            }
            if (!amount || amount <= 0) { 
                showAlert('Please enter a valid amount', 'error'); 
                return; 
            }
            if (!desc) { 
                showAlert('Please enter a description', 'error'); 
                return; 
            }

            var data = {
                propertyId: propertyId,
                expenseDate: expDate,
                category: category,
                amount: amount,
                description: desc
            };

            var url = id ? '/re/expenses/' + id : '/re/expenses';
            var method = id ? 'PUT' : 'POST';
            
            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                clearREExpenseForm();
                showAlert(id ? 'Expense updated!' : 'Expense added!');
                loadREExpenses();
                loadRealEstate();
            });
        }

        function clearREExpenseForm() { 
            document.getElementById('reExpId').value = ''; 
            document.getElementById('reExpProperty').value = ''; 
            document.getElementById('reExpAmount').value = ''; 
            document.getElementById('reExpDesc').value = ''; 
        }

        function editREExpense(id) { 
            api('/re/expenses').then(function(reExpenses) {
                var e = reExpenses.find(function(x) { return x.id === id; }); 
                if (e) { 
                    document.getElementById('reExpId').value = e.id; 
                    document.getElementById('reExpProperty').value = e.property_id || ''; 
                    document.getElementById('reExpDate').value = e.expense_date; 
                    document.getElementById('reExpCategory').value = e.category; 
                    document.getElementById('reExpAmount').value = e.amount; 
                    document.getElementById('reExpDesc').value = e.description; 
                } 
            });
        }

        function deleteREExpense(id) { 
            if (!confirm('Delete this expense?')) return; 
            api('/re/expenses/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Expense deleted'); 
                loadREExpenses(); 
                loadRealEstate(); 
            });
        }

        // ========== RE INHERITANCE - ISLAMIC LAW ==========
        
        // Calculate Islamic inheritance portions based on relationship and existing heirs
        function updateIslamicPortions() {
            var rel = document.getElementById('reHeirRel').value;
            var gender = document.getElementById('reHeirGender').value;
            var reHeirs = JSON.parse(localStorage.getItem('reHeirs') || '[]');
            
            // Check existing heirs to determine portions
            var hasChildren = reHeirs.some(function(h) { 
                return h.relationship === 'Son' || h.relationship === 'Daughter'; 
            });
            var hasSons = reHeirs.some(function(h) { return h.relationship === 'Son'; });
            
            var portions = 1; // Default
            
            // Islamic Inheritance Rules (Faraid)
            switch(rel) {
                case 'Wife':
                    // Wife gets 1/8 with children, 1/4 without children
                    portions = hasChildren ? 0.125 : 0.25; // 1/8 or 1/4
                    document.getElementById('reHeirGender').value = 'Female';
                    break;
                case 'Husband':
                    // Husband gets 1/4 with children, 1/2 without children
                    portions = hasChildren ? 0.25 : 0.5; // 1/4 or 1/2
                    document.getElementById('reHeirGender').value = 'Male';
                    break;
                case 'Son':
                    // Sons are residuary heirs (Asaba), get 2x daughter's share
                    portions = 2; // 2 portions (daughters get 1)
                    document.getElementById('reHeirGender').value = 'Male';
                    break;
                case 'Daughter':
                    // Daughters get 1 portion (sons get 2)
                    portions = 1;
                    document.getElementById('reHeirGender').value = 'Female';
                    break;
                case 'Father':
                    // Father gets 1/6 with children + residue if no sons
                    portions = hasChildren ? (1/6) : 1; // Simplified
                    document.getElementById('reHeirGender').value = 'Male';
                    break;
                case 'Mother':
                    // Mother gets 1/6 with children or grandchildren, 1/3 without
                    portions = hasChildren ? (1/6) : (1/3);
                    document.getElementById('reHeirGender').value = 'Female';
                    break;
                case 'Brother':
                    // Brothers are residuary if no sons/father
                    portions = hasSons ? 0 : 2;
                    document.getElementById('reHeirGender').value = 'Male';
                    break;
                case 'Sister':
                    // Sisters get half of brothers
                    portions = hasSons ? 0 : 1;
                    document.getElementById('reHeirGender').value = 'Female';
                    break;
                case 'Grandfather':
                    portions = hasChildren ? (1/6) : 1;
                    document.getElementById('reHeirGender').value = 'Male';
                    break;
                case 'Grandmother':
                    portions = 1/6;
                    document.getElementById('reHeirGender').value = 'Female';
                    break;
                default:
                    portions = 1;
            }
            
            // Round to 3 decimal places for display
            document.getElementById('reHeirPor').value = Math.round(portions * 1000) / 1000;
        }
        
        function loadREInheritance() {
            var currency = getCurrency();
            
            // Use API to calculate inheritance
            api('/re/inheritance/calculate').then(function(data) {
                var beneficiaries = data.heirs || [];
                
                // Load beneficiary selection list with all heirs
                api('/re/heirs').then(function(allHeirs) {
                    loadREBeneficiaryList(allHeirs);
                });

                document.getElementById('reInhPool').textContent = fmt(Math.round(data.inheritancePool)) + ' ' + currency;
                document.getElementById('reInhHeirs').textContent = beneficiaries.length;
                document.getElementById('reInhPortions').textContent = Math.round(data.totalPortions * 1000) / 1000;
                document.getElementById('reInhPerPortion').textContent = fmt(Math.round(data.perPortion)) + ' ' + currency;

                // Store inheritance data for certificate printing
                window.reInheritanceData = {
                    inheritancePool: data.inheritancePool,
                    totalPortions: data.totalPortions,
                    perPortion: data.perPortion,
                    beneficiaries: beneficiaries,
                    currency: currency
                };

                var isAdmin = currentUser && currentUser.role === 'admin';
                var html = beneficiaries.map(function(h) { 
                    var shareAmount = h.shareAmount || (data.perPortion * (parseFloat(h.portions) || 0));
                    var portionDisplay = h.portions;
                    // Show as fraction if possible
                    if (h.portions === 0.125) portionDisplay = '1/8';
                    else if (h.portions === 0.25) portionDisplay = '1/4';
                    else if (h.portions === 0.5) portionDisplay = '1/2';
                    else if (Math.abs(h.portions - 0.167) < 0.01) portionDisplay = '1/6';
                    else if (Math.abs(h.portions - 0.333) < 0.01) portionDisplay = '1/3';
                    
                    // Print certificate button for all users, edit/delete only for admin
                    var actionsHtml = '<td class="no-print">' +
                        '<button class="btn btn-gold btn-sm" onclick="printREHeirCertificate(' + h.id + ')" title="Print Certificate">ğŸ“œ</button> ';
                    
                    if (isAdmin) {
                        actionsHtml += '<button class="btn btn-warning btn-sm" onclick="editREHeir(' + h.id + ')" title="Edit">âœï¸</button> ' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteREHeir(' + h.id + ')" title="Delete">ğŸ—‘ï¸</button>';
                    }
                    actionsHtml += '</td>';
                    
                    return '<tr>' +
                        '<td>' + h.name + '</td>' +
                        '<td>' + h.relationship + '</td>' +
                        '<td>' + (h.gender || '-') + '</td>' +
                        '<td>' + portionDisplay + '</td>' +
                        '<td class="amount-positive">' + fmt(Math.round(shareAmount)) + ' ' + currency + '</td>' +
                        actionsHtml +
                    '</tr>'; 
                }).join('');

                document.getElementById('reHeirsTable').innerHTML = html || '<tr><td colspan="6">No beneficiaries selected. Select heirs above to calculate Islamic inheritance distribution.</td></tr>';
            });
        }
        
        // Load Family RE beneficiary selection list
        function loadREBeneficiaryList(heirs) {
            api('/re/beneficiaries').then(function(selectedIds) {
                var html = heirs.map(function(h) {
                    var isSelected = selectedIds.length === 0 || selectedIds.includes(h.id);
                    return '<div class="beneficiary-item ' + (isSelected ? 'selected' : '') + '">' +
                        '<input type="checkbox" id="re-ben-' + h.id + '" ' + (isSelected ? 'checked' : '') + ' onchange="toggleREBeneficiary(' + h.id + ', this.checked)">' +
                        '<label for="re-ben-' + h.id + '">' + h.name + '</label>' +
                        '<span class="heir-info">' + h.relationship + '</span>' +
                        '<span class="heir-portions">' + h.portions + ' portions</span>' +
                    '</div>';
                }).join('');
                document.getElementById('reBeneficiaryList').innerHTML = html || '<p>No heirs available. Add heirs first.</p>';
            });
        }
        
        // Get selected Family RE beneficiaries from API
        function getREBeneficiaries() {
            // This is now handled by the API
            return [];
        }
        
        // Toggle Family RE beneficiary selection
        function toggleREBeneficiary(id, checked) {
            var el = document.querySelector('#re-ben-' + id).closest('.beneficiary-item');
            if (checked) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
        }
        
        // Select/Deselect all Family RE beneficiaries
        function selectAllREBeneficiaries(selectAll) {
            var checkboxes = document.querySelectorAll('#reBeneficiaryList input[type="checkbox"]');
            checkboxes.forEach(function(cb) {
                cb.checked = selectAll;
                var el = cb.closest('.beneficiary-item');
                if (selectAll) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
        }
        
        // Save Family RE beneficiary selection
        function saveREBeneficiaries() {
            var checkboxes = document.querySelectorAll('#reBeneficiaryList input[type="checkbox"]:checked');
            var selectedIds = Array.from(checkboxes).map(function(cb) {
                return parseInt(cb.id.replace('re-ben-', ''));
            });
            
            api('/re/beneficiaries', {
                method: 'POST',
                body: JSON.stringify({ selectedIds: selectedIds })
            }).then(function() {
                showAlert('Beneficiary selection saved!');
                loadREInheritance();
            });
        }
        
        // Reset Family RE heirs to default family members
        function resetREHeirsToDefaults() {
            if (!confirm('This will delete all current heirs and reset to the default 16 family members. Continue?')) return;
            
            api('/re/heirs/reset-defaults', { method: 'POST' }).then(function(result) {
                if (result.success) {
                    showAlert('Heirs reset to default family members (' + result.count + ' heirs)');
                    loadREInheritance();
                } else {
                    showAlert('Error resetting heirs', 'error');
                }
            });
        }
        
        // Print single RE heir certificate
        function printREHeirCertificate(heirId) {
            var data = window.reInheritanceData;
            if (!data) {
                showAlert('Please wait for inheritance data to load', 'error');
                return;
            }
            
            var h = data.beneficiaries.find(function(x) { return x.id === heirId; });
            if (!h) {
                showAlert('Heir not found', 'error');
                return;
            }
            
            var shareAmount = data.perPortion * (parseFloat(h.portions) || 0);
            var certHtml = generateRECertificateHTML(h, data, shareAmount);
            var w = window.open('', '_blank');
            w.document.write(certHtml);
            w.document.close();
            w.print();
        }
        
        // Print all RE heir certificates
        function printAllREHeirCertificates() {
            var data = window.reInheritanceData;
            if (!data || !data.beneficiaries || data.beneficiaries.length === 0) {
                showAlert('No beneficiaries to print', 'error');
                return;
            }
            
            var allCerts = data.beneficiaries.map(function(h) {
                var shareAmount = data.perPortion * (parseFloat(h.portions) || 0);
                return generateRECertificateHTML(h, data, shareAmount, true);
            }).join('<div style="page-break-after: always;"></div>');
            
            var w = window.open('', '_blank');
            w.document.write('<html><head><title>Family Real Estate - All Heir Certificates</title></head><body>' + allCerts + '</body></html>');
            w.document.close();
            w.print();
        }
        
        // Generate RE certificate HTML
        function generateRECertificateHTML(heir, data, shareAmount, isPartOfBatch) {
            var today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            var currency = data.currency || 'XAF';
            
            return (isPartOfBatch ? '' : '<html><head><title>Heir Certificate - ' + heir.name + '</title></head><body>') +
                '<div style="max-width: 800px; margin: 0 auto; padding: 40px; font-family: Georgia, serif; border: 3px double #d69e2e; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);">' +
                    '<div style="text-align: center; border-bottom: 2px solid #d69e2e; padding-bottom: 20px; margin-bottom: 30px;">' +
                        '<h1 style="color: #92400e; margin: 0; font-size: 28px;">ğŸ  FAMILY REAL ESTATES</h1>' +
                        '<h2 style="color: #78350f; margin: 10px 0; font-size: 20px;">NJIKAM SALIFU REAL ESTATE PROPERTIES</h2>' +
                        '<p style="color: #a16207; font-style: italic; margin: 5px 0;">Islamic Inheritance Distribution Certificate</p>' +
                    '</div>' +
                    
                    '<div style="text-align: center; margin-bottom: 30px;">' +
                        '<h2 style="color: #1e40af; font-size: 24px; margin: 0;">CERTIFICATE OF INHERITANCE</h2>' +
                        '<p style="color: #6b7280; font-size: 14px;">Certificate No: RE-' + new Date().getFullYear() + '-' + String(heir.id).padStart(4, '0') + '</p>' +
                    '</div>' +
                    
                    '<div style="background: white; padding: 25px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #e5e7eb;">' +
                        '<p style="font-size: 16px; line-height: 1.8; text-align: justify;">' +
                            'This is to certify that <strong style="color: #1e40af; font-size: 18px;">' + heir.name + '</strong>, ' +
                            'being a <strong>' + heir.relationship + '</strong> (' + (heir.gender || 'N/A') + ') of the deceased, ' +
                            'is entitled to receive their rightful share of the Family Real Estate inheritance ' +
                            'in accordance with Islamic law (Sharia).' +
                        '</p>' +
                    '</div>' +
                    
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">' +
                        '<div style="background: #dbeafe; padding: 15px; border-radius: 8px; text-align: center;">' +
                            '<p style="margin: 0; color: #6b7280; font-size: 12px;">TOTAL INHERITANCE POOL</p>' +
                            '<p style="margin: 5px 0; font-size: 20px; font-weight: bold; color: #1e40af;">' + fmt(Math.round(data.inheritancePool)) + ' ' + currency + '</p>' +
                        '</div>' +
                        '<div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;">' +
                            '<p style="margin: 0; color: #6b7280; font-size: 12px;">TOTAL PORTIONS</p>' +
                            '<p style="margin: 5px 0; font-size: 20px; font-weight: bold; color: #92400e;">' + data.totalPortions + '</p>' +
                        '</div>' +
                    '</div>' +
                    
                    '<div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); padding: 25px; border-radius: 8px; text-align: center; margin-bottom: 25px; border: 2px solid #22c55e;">' +
                        '<p style="margin: 0; color: #166534; font-size: 14px;">HEIR\'S PORTIONS</p>' +
                        '<p style="margin: 5px 0; font-size: 24px; font-weight: bold; color: #15803d;">' + heir.portions + ' portion(s)</p>' +
                        '<hr style="border: none; border-top: 1px dashed #86efac; margin: 15px 0;">' +
                        '<p style="margin: 0; color: #166534; font-size: 14px;">INHERITANCE SHARE AMOUNT</p>' +
                        '<p style="margin: 5px 0; font-size: 32px; font-weight: bold; color: #15803d;">' + fmt(Math.round(shareAmount)) + ' ' + currency + '</p>' +
                    '</div>' +
                    
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 50px; padding-top: 30px; border-top: 1px solid #e5e7eb;">' +
                        '<div style="text-align: center;">' +
                            '<div style="border-top: 2px solid #1e40af; width: 200px; margin: 0 auto;"></div>' +
                            '<p style="margin: 10px 0 5px; font-weight: bold;">Estate Administrator</p>' +
                            '<p style="margin: 0; color: #6b7280; font-size: 12px;">Date: ' + today + '</p>' +
                        '</div>' +
                        '<div style="text-align: center;">' +
                            '<div style="border-top: 2px solid #1e40af; width: 200px; margin: 0 auto;"></div>' +
                            '<p style="margin: 10px 0 5px; font-weight: bold;">Witness</p>' +
                            '<p style="margin: 0; color: #6b7280; font-size: 12px;">Date: ' + today + '</p>' +
                        '</div>' +
                    '</div>' +
                    
                    '<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #d69e2e;">' +
                        '<p style="color: #92400e; font-size: 11px; margin: 0;">This certificate is issued as part of the Islamic inheritance distribution</p>' +
                        '<p style="color: #92400e; font-size: 11px; margin: 5px 0;">for the Family Real Estate properties of the late NJIKAM SALIFU</p>' +
                        '<p style="color: #6b7280; font-size: 10px; margin-top: 10px;">Generated on: ' + today + '</p>' +
                    '</div>' +
                '</div>' +
                (isPartOfBatch ? '' : '</body></html>');
        }

        function openREHeirModal() { 
            document.getElementById('reHeirId').value = ''; 
            document.getElementById('reHeirName').value = ''; 
            document.getElementById('reHeirRel').value = 'Wife'; 
            document.getElementById('reHeirGender').value = 'Female'; 
            document.getElementById('reHeirPor').value = 0.125; 
            updateIslamicPortions();
            document.getElementById('reHeirModal').classList.add('active'); 
        }
        
        function closeREHeirModal() { 
            document.getElementById('reHeirModal').classList.remove('active'); 
        }

        function editREHeir(id) { 
            api('/re/heirs').then(function(reHeirs) {
                var h = reHeirs.find(function(x) { return x.id === id; }); 
                if (h) { 
                    document.getElementById('reHeirId').value = h.id; 
                    document.getElementById('reHeirName').value = h.name; 
                    document.getElementById('reHeirRel').value = h.relationship; 
                    document.getElementById('reHeirGender').value = h.gender || 'Male'; 
                    document.getElementById('reHeirPor').value = h.portions; 
                    document.getElementById('reHeirModal').classList.add('active'); 
                } 
            });
        }

        function saveREHeir() {
            var id = document.getElementById('reHeirId').value;
            var name = document.getElementById('reHeirName').value.trim();
            var rel = document.getElementById('reHeirRel').value;
            var gender = document.getElementById('reHeirGender').value;
            var por = parseFloat(document.getElementById('reHeirPor').value) || 0;

            if (!name) { 
                showAlert('Please enter heir name', 'error'); 
                return; 
            }

            var data = {
                name: name,
                relationship: rel,
                gender: gender,
                heirGroup: gender === 'Male' ? 'Sons' : (rel === 'Wife' || rel === 'Spouse' ? 'Wives' : 'Daughters'),
                portions: por
            };

            var url = id ? '/re/heirs/' + id : '/re/heirs';
            var method = id ? 'PUT' : 'POST';

            api(url, { method: method, body: JSON.stringify(data) }).then(function() {
                closeREHeirModal();
                showAlert(id ? 'Heir updated!' : 'Heir added!');
                loadREInheritance();
            });
        }

        function deleteREHeir(id) { 
            if (!confirm('Delete this heir?')) return; 
            api('/re/heirs/' + id, { method: 'DELETE' }).then(function() {
                showAlert('Heir deleted'); 
                loadREInheritance(); 
            });
        }

        // ========== RE LEDGER ==========
        function loadRELedgerFull() {
            var currency = getCurrency();

            api('/re/ledger').then(function(ledgerEntries) {
                var runningBalance = 0, totalIncome = 0, totalExpense = 0;

                var html = ledgerEntries.map(function(entry) { 
                    var income = parseFloat(entry.income) || 0;
                    var expense = parseFloat(entry.expense) || 0;
                    runningBalance = parseFloat(entry.balance) || (runningBalance + income - expense);
                    totalIncome += income; 
                    totalExpense += expense;
                    
                    var isIncome = income > 0; 
                    var isInh = entry.type === 'Inheritance Share'; 
                    
                    return '<tr>' +
                        '<td>' + fmtDate(entry.date) + '</td>' +
                        '<td>' + (entry.property || 'N/A') + '</td>' +
                        '<td>' + (entry.description || '') + '</td>' +
                        '<td><span class="badge ' + (isIncome ? 'badge-income' : isInh ? 'badge-inheritance' : 'badge-expense') + '">' + entry.type + '</span></td>' +
                        '<td class="amount-positive">' + (income > 0 ? fmt(Math.round(income)) : '-') + '</td>' +
                        '<td class="' + (isInh ? 'amount-gold' : 'amount-negative') + '">' + (expense > 0 ? fmt(Math.round(expense)) : '-') + '</td>' +
                        '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(Math.round(runningBalance)) + '</td>' +
                    '</tr>'; 
                }).join('');

                document.getElementById('reLedgerTable').innerHTML = html || '<tr><td colspan="7">No transactions</td></tr>';
                document.getElementById('reLedgerTotals').innerHTML = 
                    '<tr style="background: #f7fafc; font-weight: bold;">' +
                    '<td colspan="4" style="text-align: right;">TOTALS (' + currency + '):</td>' +
                    '<td class="amount-positive">' + fmt(Math.round(totalIncome)) + '</td>' +
                    '<td class="amount-negative">' + fmt(Math.round(totalExpense)) + '</td>' +
                    '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(Math.round(runningBalance)) + '</td>' +
                    '</tr>';
            });
        }
                '<td class="amount-positive">' + fmt(Math.round(totalIncome)) + '</td>' +
                '<td class="amount-negative">' + fmt(Math.round(totalExpense)) + '</td>' +
                '<td class="' + (runningBalance >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(Math.round(runningBalance)) + '</td>' +
                '</tr>' +
                '<tr style="background: #fed7d7; font-weight: bold;">' +
                '<td colspan="4" style="text-align: right; color: #c53030;">ğŸ¦ Reserved Funds (' + reservedPercent + '% of Income):</td>' +
                '<td></td>' +
                '<td style="color: #c53030;">-' + fmt(Math.round(reservedFunds)) + '</td>' +
                '<td></td>' +
                '</tr>' +
                '<tr style="background: #fc8181; font-weight: bold;">' +
                '<td colspan="4" style="text-align: right; color: #742a2a;">ğŸ“Š NET BALANCE:</td>' +
                '<td></td>' +
                '<td></td>' +
                '<td style="color: #742a2a;">' + fmt(Math.round(netBalance)) + '</td>' +
                '</tr>';
        }

        // ========== RE SETTINGS & EXPORT ==========
        // ========== RE SETTINGS FUNCTIONS ==========
        function loadRESettings() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var settings = JSON.parse(localStorage.getItem('reSettings') || '{}');
            
            // Load global settings
            if (settings.taxRate) document.getElementById('reSettingTaxRate').value = settings.taxRate;
            if (settings.period) document.getElementById('reSettingPeriod').value = settings.period;
            if (settings.currency) document.getElementById('reSettingCurrency').value = settings.currency;
            if (settings.reservedPercent) document.getElementById('reSettingReservedPercent').value = settings.reservedPercent;
            
            // Populate property dropdown
            document.getElementById('reSettingProperty').innerHTML = '<option value="">-- Select a Property --</option>' +
                properties.map(function(p) {
                    return '<option value="' + p.id + '">' + p.name + ' (' + p.status + ')</option>';
                }).join('');
            
            // Render properties overview table
            renderSettingsPropertiesTable();
        }
        
        function renderSettingsPropertiesTable() {
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var settings = JSON.parse(localStorage.getItem('reSettings') || '{}');
            var currency = settings.currency || 'XAF';
            
            var html = properties.map(function(p) {
                var isRented = p.status === 'Rented';
                return '<tr>' +
                    '<td><strong>' + p.name + '</strong><br><small style="color: #718096;">' + p.location + '</small></td>' +
                    '<td><span class="badge ' + (isRented ? 'badge-paid' : 'badge-unpaid') + '">' + p.status + '</span></td>' +
                    '<td>' + (p.tax_rate || 0) + '%</td>' +
                    '<td>' + (p.rent_period || '-') + '</td>' +
                    '<td>' + (isRented ? fmt(p.rent_amount || 0) + ' ' + currency : '-') + '</td>' +
                '</tr>';
            }).join('');
            
            document.getElementById('reSettingsPropertiesTable').innerHTML = html || '<tr><td colspan="5">No properties added yet</td></tr>';
        }
        
        function loadPropertySettings() {
            var propertyId = parseInt(document.getElementById('reSettingProperty').value);
            if (!propertyId) {
                document.getElementById('reSettingPropTaxRate').value = '15';
                document.getElementById('reSettingPropPeriod').value = 'Monthly';
                document.getElementById('reSettingPropRent').value = '';
                document.getElementById('reSettingPropStatus').value = 'Rented';
                return;
            }
            
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var prop = properties.find(function(p) { return p.id === propertyId; });
            
            if (prop) {
                document.getElementById('reSettingPropTaxRate').value = prop.tax_rate || '15';
                document.getElementById('reSettingPropPeriod').value = prop.rent_period || 'Monthly';
                document.getElementById('reSettingPropRent').value = prop.rent_amount || '';
                document.getElementById('reSettingPropStatus').value = prop.status || 'Rented';
            }
        }
        
        function savePropertySettings() {
            var propertyId = parseInt(document.getElementById('reSettingProperty').value);
            if (!propertyId) {
                showAlert('Please select a property first', 'error');
                return;
            }
            
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var idx = properties.findIndex(function(p) { return p.id === propertyId; });
            
            if (idx !== -1) {
                properties[idx].tax_rate = document.getElementById('reSettingPropTaxRate').value;
                properties[idx].rent_period = document.getElementById('reSettingPropPeriod').value;
                properties[idx].rent_amount = parseFloat(document.getElementById('reSettingPropRent').value) || 0;
                properties[idx].status = document.getElementById('reSettingPropStatus').value;
                
                // If not rented, clear rent values
                if (properties[idx].status !== 'Rented') {
                    properties[idx].rent_amount = 0;
                }
                
                localStorage.setItem('familyProperties', JSON.stringify(properties));
                showAlert('Property settings saved for ' + properties[idx].name + '!');
                renderSettingsPropertiesTable();
                loadRealEstate();
            }
        }
        
        function saveGlobalRESettings() {
            var taxRate = document.getElementById('reSettingTaxRate').value;
            var period = document.getElementById('reSettingPeriod').value;
            var currency = document.getElementById('reSettingCurrency').value;
            var reservedPercent = document.getElementById('reSettingReservedPercent').value;
            
            // Save global settings
            var settings = { 
                taxRate: taxRate, 
                period: period, 
                currency: currency,
                reservedPercent: reservedPercent
            }; 
            localStorage.setItem('reSettings', JSON.stringify(settings));
            
            // Apply to all properties
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            properties = properties.map(function(p) {
                p.tax_rate = taxRate;
                if (p.status === 'Rented') {
                    p.rent_period = period;
                }
                return p;
            });
            localStorage.setItem('familyProperties', JSON.stringify(properties));
            
            showAlert('Global settings saved! Reserved Funds set to ' + reservedPercent + '% of income.');
            renderSettingsPropertiesTable();
            loadRealEstate();
        }
        
        function previewGlobalSettings() {
            // Optional: Show preview of changes
        }

        function resetREData() { 
            if (!confirm('This will delete ALL Real Estate data. Are you sure?')) return; 
            if (!confirm('FINAL WARNING: This cannot be undone!')) return; 
            localStorage.removeItem('familyProperties'); 
            localStorage.removeItem('reBills'); 
            localStorage.removeItem('rePayments'); 
            localStorage.removeItem('reExpenses'); 
            localStorage.removeItem('reHeirs');
            localStorage.removeItem('reSettings');
            showAlert('All RE data reset'); 
            loadRealEstate(); 
        }

        // ========== RE PDF EXPORT FUNCTIONS ==========
        function exportREPropertiesPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('FAMILY REAL ESTATE - PROPERTIES', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | Generated: ' + new Date().toLocaleDateString(), 105, 22, { align: 'center' });
            doc.line(20, 25, 190, 25);
            
            var tableData = properties.map(function(p) {
                var isRented = p.status === 'Rented';
                var rent = isRented ? (parseFloat(p.rent_amount) || 0) : 0;
                var tax = isRented ? (parseFloat(p.tax_rate) || 0) : 0;
                var net = rent - (rent * tax / 100);
                return [p.name, p.location, p.type, p.status, fmt(rent), tax + '%', fmt(Math.round(net)), p.islamic_inheritance || 'NA'];
            });
            
            doc.autoTable({
                startY: 30,
                head: [['Property', 'Location', 'Type', 'Status', 'Rent', 'Tax', 'Net Income', 'Islamic Inh.']],
                body: tableData,
                styles: { fontSize: 7 },
                headStyles: { fillColor: [44, 82, 130] }
            });
            
            doc.save('re_properties_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('Properties PDF exported!');
        }

        function exportREBillsPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('landscape');
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('FAMILY REAL ESTATE - BILLS', 148, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | Generated: ' + new Date().toLocaleDateString(), 148, 22, { align: 'center' });
            doc.text('* All amounts shown are NET after tax deductions', 148, 27, { align: 'center' });
            doc.line(20, 30, 277, 30);
            
            var totalGross = 0, totalTax = 0, totalNet = 0, totalPaid = 0, totalOutstanding = 0;
            
            var tableData = reBills.map(function(b) {
                var prop = properties.find(function(p) { return p.id === b.property_id; });
                var status = b.outstanding === 0 ? 'Paid' : b.paid_amount > 0 ? 'Partial' : 'Unpaid';
                
                var grossAmount = b.gross_amount || b.amount_due || 0;
                var taxRate = b.tax_rate || (prop ? parseFloat(prop.tax_rate) : 0) || 0;
                var taxAmount = b.tax_amount || (grossAmount * taxRate / 100);
                var netAmount = b.amount_due || (grossAmount - taxAmount);
                
                totalGross += grossAmount;
                totalTax += taxAmount;
                totalNet += netAmount;
                totalPaid += b.paid_amount || 0;
                totalOutstanding += b.outstanding || 0;
                
                return [b.bill_number, prop ? prop.name : 'N/A', b.period, b.year, fmt(Math.round(grossAmount)), taxRate + '%', fmt(Math.round(taxAmount)), fmt(Math.round(netAmount)), fmt(b.paid_amount || 0), fmt(b.outstanding || 0), status];
            });
            
            doc.autoTable({
                startY: 35,
                head: [['Bill #', 'Property', 'Period', 'Year', 'Gross', 'Tax %', 'Tax Amt', 'Net Due', 'Paid', 'Outstanding', 'Status']],
                body: tableData,
                styles: { fontSize: 7 },
                headStyles: { fillColor: [56, 161, 105] }
            });
            
            doc.setFontSize(9);
            doc.text('Totals - Gross: ' + fmt(Math.round(totalGross)) + ' | Tax: ' + fmt(Math.round(totalTax)) + ' | Net: ' + fmt(Math.round(totalNet)) + ' | Paid: ' + fmt(Math.round(totalPaid)) + ' | Outstanding: ' + fmt(Math.round(totalOutstanding)) + ' XAF', 20, doc.lastAutoTable.finalY + 10);
            
            doc.save('re_bills_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('Bills PDF exported!');
        }

        function exportREPaymentsPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('FAMILY REAL ESTATE - PAYMENTS', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | Generated: ' + new Date().toLocaleDateString(), 105, 22, { align: 'center' });
            doc.text('* Payment amounts are Net (tax already deducted in Bills)', 105, 27, { align: 'center' });
            doc.line(20, 30, 190, 30);
            
            var totalAmount = 0;
            
            var tableData = rePayments.map(function(p) {
                var bill = reBills.find(function(b) { return b.id === p.bill_id; });
                var prop = bill ? properties.find(function(pr) { return pr.id === bill.property_id; }) : null;
                var amount = parseFloat(p.amount) || 0;
                totalAmount += amount;
                return [fmtDate(p.payment_date), prop ? prop.name : 'N/A', bill ? bill.bill_number : 'N/A', fmt(Math.round(amount)), p.reference || '-'];
            });
            
            doc.autoTable({
                startY: 35,
                head: [['Date', 'Property', 'Bill #', 'Amount', 'Reference']],
                body: tableData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [66, 153, 225] }
            });
            
            doc.setFontSize(10);
            doc.text('Total Payments: ' + fmt(Math.round(totalAmount)) + ' XAF', 20, doc.lastAutoTable.finalY + 10);
            
            doc.save('re_payments_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('Payments PDF exported!');
        }

        function exportREExpensesPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('FAMILY REAL ESTATE - EXPENSES', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | Generated: ' + new Date().toLocaleDateString(), 105, 22, { align: 'center' });
            doc.line(20, 25, 190, 25);
            
            var total = 0;
            var tableData = reExpenses.map(function(e) {
                var prop = properties.find(function(p) { return p.id === e.property_id; });
                total += parseFloat(e.amount) || 0;
                return [fmtDate(e.expense_date), prop ? prop.name : 'General', e.category, e.description, fmt(e.amount)];
            });
            
            doc.autoTable({
                startY: 30,
                head: [['Date', 'Property', 'Category', 'Description', 'Amount']],
                body: tableData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [229, 62, 62] }
            });
            
            doc.setFontSize(10);
            doc.text('Total Expenses: ' + fmt(Math.round(total)) + ' XAF', 20, doc.lastAutoTable.finalY + 10);
            
            doc.save('re_expenses_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('Expenses PDF exported!');
        }

        function exportRELedgerPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('FAMILY REAL ESTATE - LEDGER', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | Generated: ' + new Date().toLocaleDateString(), 105, 22, { align: 'center' });
            doc.text('* Income shown is NET after tax deductions', 105, 27, { align: 'center' });
            doc.line(20, 30, 190, 30);
            
            var ledgerEntries = [];
            
            // Payments as net income
            rePayments.forEach(function(p) {
                var bill = reBills.find(function(b) { return b.id === p.bill_id; });
                var prop = bill ? properties.find(function(pr) { return pr.id === bill.property_id; }) : null;
                var taxRate = prop ? (parseFloat(prop.tax_rate) || 0) : 0;
                var gross = parseFloat(p.amount) || 0;
                var net = gross - (gross * taxRate / 100);
                ledgerEntries.push({ date: p.payment_date, property: prop ? prop.name : 'N/A', desc: 'Payment ' + (bill ? bill.bill_number : ''), type: 'Income', income: net, expense: 0 });
            });
            
            // Expenses
            reExpenses.forEach(function(e) {
                var prop = properties.find(function(p) { return p.id === e.property_id; });
                ledgerEntries.push({ date: e.expense_date, property: prop ? prop.name : 'General', desc: e.description, type: e.category, income: 0, expense: parseFloat(e.amount) || 0 });
            });
            
            ledgerEntries.sort(function(a, b) { return new Date(a.date) - new Date(b.date); });
            
            var balance = 0, totalIn = 0, totalOut = 0;
            var tableData = ledgerEntries.map(function(e) {
                balance += e.income - e.expense;
                totalIn += e.income;
                totalOut += e.expense;
                return [fmtDate(e.date), e.property, e.desc, e.type, e.income > 0 ? fmt(Math.round(e.income)) : '-', e.expense > 0 ? fmt(Math.round(e.expense)) : '-', fmt(Math.round(balance))];
            });
            
            doc.autoTable({
                startY: 35,
                head: [['Date', 'Property', 'Description', 'Type', 'Income (Net)', 'Expense', 'Balance']],
                body: tableData,
                styles: { fontSize: 7 },
                headStyles: { fillColor: [44, 82, 130] }
            });
            
            doc.setFontSize(10);
            doc.text('Total Income (Net): ' + fmt(Math.round(totalIn)) + ' XAF | Total Expenses: ' + fmt(Math.round(totalOut)) + ' XAF | Balance: ' + fmt(Math.round(balance)) + ' XAF', 20, doc.lastAutoTable.finalY + 10);
            
            doc.save('re_ledger_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('Ledger PDF exported!');
        }

        function exportREHeirsPDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');
            var reHeirs = JSON.parse(localStorage.getItem('reHeirs') || '[]');
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            
            // Calculate pool with net income
            var totalIncome = 0;
            rePayments.forEach(function(p) {
                var bill = reBills.find(function(b) { return b.id === p.bill_id; });
                var prop = bill ? properties.find(function(pr) { return pr.id === bill.property_id; }) : null;
                var taxRate = prop ? (parseFloat(prop.tax_rate) || 0) : 0;
                var gross = parseFloat(p.amount) || 0;
                totalIncome += gross - (gross * taxRate / 100);
            });
            
            var totalExpenses = 0;
            reExpenses.forEach(function(e) { totalExpenses += parseFloat(e.amount) || 0; });
            
            var pool = Math.max(0, totalIncome - totalExpenses);
            var totalPortions = reHeirs.reduce(function(sum, h) { return sum + (parseFloat(h.portions) || 0); }, 0);
            var perPortion = totalPortions > 0 ? pool / totalPortions : 0;
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('ISLAMIC INHERITANCE DISTRIBUTION', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | Generated: ' + new Date().toLocaleDateString(), 105, 22, { align: 'center' });
            doc.line(20, 25, 190, 25);
            
            doc.setFontSize(11);
            doc.text('Inheritance Pool: ' + fmt(Math.round(pool)) + ' XAF', 20, 35);
            doc.text('Total Heirs: ' + reHeirs.length, 20, 42);
            doc.text('Total Portions: ' + (Math.round(totalPortions * 1000) / 1000), 100, 35);
            doc.text('Per Portion: ' + fmt(Math.round(perPortion)) + ' XAF', 100, 42);
            
            var tableData = reHeirs.map(function(h) {
                var share = perPortion * (parseFloat(h.portions) || 0);
                var portionDisplay = h.portions;
                if (h.portions === 0.125) portionDisplay = '1/8';
                else if (h.portions === 0.25) portionDisplay = '1/4';
                else if (h.portions === 0.5) portionDisplay = '1/2';
                else if (Math.abs(h.portions - 0.167) < 0.01) portionDisplay = '1/6';
                else if (Math.abs(h.portions - 0.333) < 0.01) portionDisplay = '1/3';
                return [h.name, h.relationship, h.gender || '-', portionDisplay, fmt(Math.round(share)) + ' XAF'];
            });
            
            doc.autoTable({
                startY: 50,
                head: [['Name', 'Relationship', 'Gender', 'Portions', 'Share Amount']],
                body: tableData,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [212, 175, 55] }
            });
            
            doc.save('re_inheritance_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('Inheritance PDF exported!');
        }

        function exportRERentalIncomePDF() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]');
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('RENTAL INCOME REPORT', 105, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | Generated: ' + new Date().toLocaleDateString(), 105, 22, { align: 'center' });
            doc.line(20, 25, 190, 25);
            
            var totalGross = 0, totalTax = 0, totalNet = 0;
            var tableData = properties.map(function(p) {
                var isRented = p.status === 'Rented';
                var rent = isRented ? (parseFloat(p.rent_amount) || 0) : 0;
                var taxRate = isRented ? (parseFloat(p.tax_rate) || 0) : 0;
                var taxAmt = rent * taxRate / 100;
                var net = rent - taxAmt;
                totalGross += rent;
                totalTax += taxAmt;
                totalNet += net;
                return [p.name, p.location, p.status, fmt(rent), taxRate + '%', fmt(Math.round(taxAmt)), fmt(Math.round(net))];
            });
            
            doc.autoTable({
                startY: 30,
                head: [['Property', 'Location', 'Status', 'Gross Rent', 'Tax Rate', 'Tax Amount', 'Net Income']],
                body: tableData,
                styles: { fontSize: 7 },
                headStyles: { fillColor: [212, 175, 55] }
            });
            
            doc.setFontSize(10);
            doc.text('Totals - Gross: ' + fmt(Math.round(totalGross)) + ' | Tax: ' + fmt(Math.round(totalTax)) + ' | Net: ' + fmt(Math.round(totalNet)) + ' XAF', 20, doc.lastAutoTable.finalY + 10);
            
            doc.save('re_rental_income_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('Rental Income PDF exported!');
        }

        function exportAllRECSV() { 
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]'); 
            var reBills = JSON.parse(localStorage.getItem('reBills') || '[]');
            var rePayments = JSON.parse(localStorage.getItem('rePayments') || '[]');
            var reExpenses = JSON.parse(localStorage.getItem('reExpenses') || '[]');
            
            var csv = 'FAMILY REAL ESTATES - GHOUENZEN Soulemanou\nGenerated: ' + new Date().toLocaleDateString() + '\n\n';
            
            csv += 'PROPERTIES\nName,Location,Type,Status,Rent,Period,Tax,Net,Islamic Inh\n'; 
            properties.forEach(function(p) { 
                var isRented = p.status === 'Rented'; 
                var rent = isRented ? (p.rent_amount || 0) : 0; 
                var tax = isRented ? (p.tax_rate || 0) : 0; 
                var net = rent - (rent * tax / 100); 
                csv += '"' + p.name + '","' + p.location + '",' + p.type + ',' + p.status + ',' + rent + ',' + (isRented ? p.rent_period : '-') + ',' + tax + '%,' + Math.round(net) + ',' + (p.islamic_inheritance || 'NA') + '\n'; 
            });
            
            csv += '\nBILLS\nBill #,Property,Period,Year,Amount,Paid,Outstanding,Status\n';
            reBills.forEach(function(b) {
                var prop = properties.find(function(p) { return p.id === b.property_id; });
                var status = b.outstanding === 0 ? 'Paid' : b.paid_amount > 0 ? 'Partial' : 'Unpaid';
                csv += b.bill_number + ',"' + (prop ? prop.name : '') + '",' + b.period + ',' + b.year + ',' + b.amount_due + ',' + (b.paid_amount || 0) + ',' + b.outstanding + ',' + status + '\n';
            });
            
            csv += '\nPAYMENTS\nDate,Property,Bill,Amount,Reference\n';
            rePayments.forEach(function(p) {
                var bill = reBills.find(function(b) { return b.id === p.bill_id; });
                var prop = bill ? properties.find(function(pr) { return pr.id === bill.property_id; }) : null;
                csv += p.payment_date + ',"' + (prop ? prop.name : '') + '",' + (bill ? bill.bill_number : '') + ',' + p.amount + ',"' + (p.reference || '') + '"\n';
            });
            
            csv += '\nEXPENSES\nDate,Property,Category,Description,Amount\n';
            reExpenses.forEach(function(e) {
                var prop = properties.find(function(p) { return p.id === e.property_id; });
                csv += e.expense_date + ',"' + (prop ? prop.name : 'General') + '",' + e.category + ',"' + e.description + '",' + e.amount + '\n';
            });
            
            var blob = new Blob([csv], { type: 'text/csv' }); 
            var a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = 'family_real_estates_all_' + new Date().toISOString().split('T')[0] + '.csv'; 
            a.click(); 
            showAlert('All CSV exported!'); 
        }

        function exportAllREPDF() { 
            var jsPDF = window.jspdf.jsPDF; 
            var doc = new jsPDF(); 
            var properties = JSON.parse(localStorage.getItem('familyProperties') || '[]'); 
            
            doc.setFontSize(18); 
            doc.setFont('helvetica', 'bold');
            doc.text('FAMILY REAL ESTATES - COMPLETE REPORT', 105, 15, { align: 'center' }); 
            doc.setFontSize(10); 
            doc.setFont('helvetica', 'normal');
            doc.text('GHOUENZEN Soulemanou | Generated: ' + new Date().toLocaleDateString(), 105, 22, { align: 'center' }); 
            doc.line(20, 25, 190, 25);
            
            doc.setFontSize(12);
            doc.text('Properties Summary', 20, 35);
            
            doc.autoTable({ 
                startY: 40, 
                head: [['Property', 'Location', 'Status', 'Rent', 'Tax', 'Net']], 
                body: properties.map(function(p) { 
                    var isRented = p.status === 'Rented'; 
                    var rent = isRented ? (p.rent_amount || 0) : 0; 
                    var tax = isRented ? (p.tax_rate || 0) : 0; 
                    var net = rent - (rent * tax / 100); 
                    return [p.name, p.location, p.status, fmt(rent), tax + '%', fmt(Math.round(net))]; 
                }), 
                styles: { fontSize: 7 },
                headStyles: { fillColor: [44, 82, 130] }
            }); 
            
            doc.save('family_real_estates_complete_' + new Date().toISOString().split('T')[0] + '.pdf'); 
            showAlert('Complete PDF exported!'); 
        }

        // Setup property form listeners
        document.addEventListener('DOMContentLoaded', function() {
            var rentInput = document.getElementById('propRentAmount');
            var taxInput = document.getElementById('propTaxRate');
            if (rentInput) rentInput.addEventListener('input', updatePropertyCalc);
            if (taxInput) taxInput.addEventListener('change', updatePropertyCalc);
        });

        // Initialize
        function init() {
            // Check for existing session - this will handle login or show login page
            checkExistingSession();
        }

        init();
    </script>
</body>
</html>
